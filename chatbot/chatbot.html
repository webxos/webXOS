<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXOS Searchbot</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
</head>
<body>
    <canvas id="neuralCanvas"></canvas>
    <div class="container">
        <div id="messages"></div>
        <div class="input-container">
            <input type="text" id="userInput" placeholder="Type /help..." autocomplete="off">
            <div id="loading" style="display: none;">Loading...</div>
            <div id="status"></div>
        </div>
    </div>
    <script src="neurots.js"></script>
    <script>
        const BOT_VERSION = '1.0.0';
        let cachedContent = {};
        const cache = new Map();

        function updateStatus(message, isError = false, details = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'error' : 'success';
            if (details) console.log(details);
        }

        function clearChat() {
            document.getElementById('messages').innerHTML = '';
            showHelpMenu();
            window.setAgentsActive(false);
            updateStatus('Success: Chat cleared.');
        }

        function showHelpMenu() {
            const messages = document.getElementById('messages');
            messages.innerHTML += `
                <p><b>Commands:</b></p>
                <p><b>/help</b> - Show this menu.</p>
                <p><b>/clear</b> - Clear chatbox and reset neural dots.</p>
                <p><b>/stats</b> - Show indexing stats.</p>
                <p><b>/version</b> - Show bot version.</p>
                <p><b>/agent1-4</b> - Activate specific agent and neural pattern (centered).</p>
                <p><b>/agent1-4 random</b> - Start continuous pattern growth for agent from random position.</p>
                <p><b>/agent1-4 stop</b> - Stop continuous pattern growth for agent.</p>
                <p><b>/morphcollab</b> - Activate all agents with random patterns, morphing together.</p>
                <p><b>/galaxy</b> - Start a cosmic micro-universe screensaver effect.</p>
                <p><b>search [term]</b> - Search WebXOS content.</p>`;
            messages.scrollTop = messages.scrollHeight;
        }

        async function loadScript(url) {
            if (cache.has(url)) return cache.get(url);
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Failed to fetch ${url}`);
                const data = await response.json();
                cache.set(url, data);
                return data;
            } catch (error) {
                updateStatus(`Error loading ${url}.`, true, error.stack);
                return null;
            }
        }

        async function displayResults(results) {
            const messages = document.getElementById('messages');
            messages.innerHTML += `<p><b>Search Results (${results.length}):</b></p>`;
            for (const result of results) {
                const { item } = result;
                messages.innerHTML += `<p><a href="${item.url}" target="_blank">${item.text.title}</a>: ${item.text.content.substring(0, 100)}...</p>`;
            }
            messages.scrollTop = messages.scrollHeight;
        }

        async function searchQuery() {
            const query = document.getElementById('userInput').value.trim().toLowerCase();
            const messages = document.getElementById('messages');
            const loading = document.getElementById('loading');
            if (!query) {
                updateStatus('Error: Empty input.', true, 'Please enter a search term or command.');
                return;
            }
            let colorClass = '';
            if (query.startsWith('/agent1')) colorClass = 'agent1-color';
            else if (query.startsWith('/agent2')) colorClass = 'agent2-color';
            else if (query.startsWith('/agent3')) colorClass = 'agent3-color';
            else if (query.startsWith('/agent4')) colorClass = 'agent4-color';
            messages.innerHTML += `<p class="${colorClass}"><b>You:</b> ${query}</p>`;
            loading.style.display = 'block';

            try {
                if (query.startsWith('/')) {
                    const [command, subcommand] = query.split(' ');
                    switch (command) {
                        case '/help':
                            showHelpMenu();
                            updateStatus('Success: Help menu displayed.');
                            break;
                        case '/clear':
                            clearChat();
                            break;
                        case '/stats':
                            const indexedFiles = cachedContent['site_index']?.length || 0;
                            const totalKeywords = cachedContent['site_index']?.reduce((sum, item) => sum + (item.text?.keywords?.length || 0), 0) || 0;
                            messages.innerHTML += `<p><b>Stats:</b> Indexed ${indexedFiles} files with ${totalKeywords} keywords.</p>`;
                            updateStatus('Success: Indexing stats displayed.');
                            break;
                        case '/version':
                            messages.innerHTML += `<p><b>Version:</b> WebXOS Searchbot v${BOT_VERSION}</p>`;
                            updateStatus('Success: Version displayed.');
                            break;
                        case '/morphcollab':
                            window.setAgentsActive(true, ['agent1', 'agent2', 'agent3', 'agent4'], false, true, false);
                            messages.innerHTML += `<p><b>System:</b> Morph collaboration mode activated.</p>`;
                            updateStatus('Success: Morph collaboration mode activated.');
                            break;
                        case '/galaxy':
                            window.setAgentsActive(true, [], false, false, true);
                            messages.innerHTML += `<p><b>System:</b> Galaxy mode activated.</p>`;
                            updateStatus('Success: Galaxy mode activated.');
                            break;
                        case '/agent1':
                        case '/agent2':
                        case '/agent3':
                        case '/agent4':
                            const agentName = command.slice(1).toUpperCase();
                            activeAgents = [agentName.toLowerCase()];
                            console.log(`Activating ${agentName}`);
                            if (subcommand === 'random') {
                                window.setAgentsActive(true, [agentName.toLowerCase()], true, false, false);
                                messages.innerHTML += `<p class="${command.slice(1).toLowerCase()}-color"><b>${agentName}:</b> ${agentName} random pattern growth started.</p>`;
                                updateStatus(`Success: ${agentName} random mode activated.`);
                            } else if (subcommand === 'stop') {
                                window.stopRandomMode();
                                window.setAgentsActive(true, [agentName.toLowerCase()], false, false, false);
                                messages.innerHTML += `<p class="${command.slice(1).toLowerCase()}-color"><b>${agentName}:</b> ${agentName} random pattern growth stopped.</p>`;
                                updateStatus(`Success: ${agentName} random mode stopped.`);
                            } else {
                                window.setAgentsActive(true, [agentName.toLowerCase()], false, false, false);
                                messages.innerHTML += `<p class="${command.slice(1).toLowerCase()}-color"><b>${agentName}:</b> ${agentName} checking in. More features coming soon.</p>`;
                                updateStatus(`Success: ${agentName} activated.`);
                            }
                            break;
                        default:
                            messages.innerHTML += `<p><b>Error:</b> Unknown command "${command}". Type /help for commands.</p>`;
                            updateStatus('Error: Unknown command.', true);
                    }
                } else {
                    const fuse = new Fuse(cachedContent['site_index'] || [], {
                        keys: ['text.content', 'text.keywords'],
                        threshold: 0.4,
                        includeMatches: true
                    });
                    const results = fuse.search(query);
                    if (results.length === 0) {
                        messages.innerHTML += `<p><b>Search Result:</b> No results found for "${query}". Try a different query.</p>`;
                        updateStatus('Success: Search completed. No results found.');
                    } else {
                        displayResults(results);
                        updateStatus(`Success: Search completed. Found ${results.length} results.`);
                    }
                }
            } catch (error) {
                messages.innerHTML += `<p><b>Error:</b> ${error.message}</p>`;
                updateStatus('Error: Search failed.', true, error.stack || error.message);
            } finally {
                loading.style.display = 'none';
                document.getElementById('userInput').value = '';
                messages.scrollTop = messages.scrollHeight;
            }
        }

        window.onload = async () => {
            cachedContent['site_index'] = await loadScript('/data/site_index.json');
            window.initNeurots();
            showHelpMenu();
            updateStatus('Success: WebXOS Searchbot initialized.');
            document.getElementById('userInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchQuery();
            });
        };
    </script>
</body>
</html>
