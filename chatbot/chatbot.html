<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="description" content="WebXOS Searchbot 2025: Search innovative web apps, AI tools, games, and utilities across the WebXOS platform with neural dot visualization and Vial integration.">
    <meta name="keywords" content="webXOS, searchbot, web applications 2025, AI tools, web games, online utilities, digital solutions, webXOS AI, webXOS search, browser-based tools, innovative web apps, digital experience, web development, AI-powered search, online games, modular web tools, sustainable web solutions, carbon footprint tools, webXOS research, exoskeleton AI technology, green energy, web design, front end, sustainable software, AI, machine learning, eco-friendly tech, web interfaces, user experience, UX design, web technology, AI-driven search, browser-based applications, digital innovation, web utilities, sustainable design, green technology, front-end development, AI applications, web accessibility, interactive web, modern web design, eco-conscious software, AI research, digital transformation, web performance, sustainable digital tools, low-carbon tech, web app development, AI-enhanced tools, online platforms, futuristic web solutions, green computing, vial, quantum reasoning, agentic search">
    <meta name="robots" content="index, follow">
    <meta name="author" content="webXOS">
    <meta property="og:title" content="WebXOS Searchbot 2025 - Search Web Apps with Vial">
    <meta property="og:description" content="Explore WebXOS Searchbot 2025 with Vial integration for searching innovative web applications, AI tools, and games with neural dot visualization and quantum reasoning.">
    <meta property="og:url" content="https://webxos.netlify.app/chatbot/chatbot.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="webXOS">
    <meta property="og:locale" content="en_US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@webxos">
    <meta name="twitter:creator" content="@webxos">
    <meta name="twitter:title" content="WebXOS Searchbot 2025 - Search Web Apps with Vial">
    <meta name="twitter:description" content="Discover WebXOS Searchbot 2025 with Vial integration for searching innovative web applications and games with neural dot visualization and quantum reasoning.">
    <link rel="canonical" href="https://webxos.netlify.app/chatbot/chatbot.html">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=OCR-A&display=swap">
    <link rel="stylesheet" href="/chatbot/static/style.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/chatbot/static/icon.png">
    <title>WebXOS Searchbot 2025</title>
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: 'OCR-A', 'Courier New', monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #neuralCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        .title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5em;
            text-align: center;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            margin: 20px 0;
        }
        .input-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #chatbox {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #0f0;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 0 10px #0f0;
        }
        #messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            background: #000;
            border: 1px solid #0f0;
        }
        #messages p {
            margin: 5px 0;
            word-wrap: break-word;
        }
        .input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #userInput {
            flex-grow: 1;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px;
            font-family: 'OCR-A', 'Courier New', monospace;
            font-size: 1em;
        }
        #userInput:focus {
            outline: none;
            box-shadow: 0 0 5px #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #00cc00;
            box-shadow: 0 0 5px #0f0;
        }
        .error-message {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #f00;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .error-message .error {
            color: #f00;
        }
        .error-message .success {
            color: #0f0;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            color: #0f0;
            font-size: 1.2em;
        }
        .loading-spinner::before {
            content: '⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏';
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { content: '⠋'; }
            10% { content: '⠙'; }
            20% { content: '⠹'; }
            30% { content: '⠸'; }
            40% { content: '⠼'; }
            50% { content: '⠴'; }
            60% { content: '⠦'; }
            70% { content: '⠧'; }
            80% { content: '⠇'; }
            90% { content: '⠏'; }
        }
        .vial1-color { color: #ff0; }
        .vial2-color { color: #0ff; }
        .vial3-color { color: #f0f; }
        .vial4-color { color: #f00; }
        footer {
            text-align: center;
            color: #0f0;
            margin-top: 20px;
            font-size: 0.9em;
        }
        @media (max-width: 600px) {
            .title { font-size: 1.5em; }
            .input-container { padding: 10px; }
            #chatbot { padding: 10px; }
            #userInput { font-size: 0.9em; }
            button { padding: 8px 15px; font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <canvas id="neuralCanvas" style="pointer-events: none;"></canvas>
    <h1 class="title">WebXOS Searchbot with Vial</h1>
    <div class="input-container">
        <div id="status" class="error-message"></div>
        <div id="chatbox">
            <div id="messages"></div>
            <div class="input-group">
                <input type="text" id="userInput" placeholder="Search WebXOS or /vial1-4, /dna, /galaxy...">
                <button id="searchButton">Search</button>
                <button id="clearButton">Clear</button>
                <button id="authButton">Authenticate</button>
                <button id="importButton">Import</button>
            </div>
            <div id="loading" class="loading-spinner"></div>
            <input type="file" id="fileInput" accept=".md" style="display: none;">
        </div>
    </div>
    <footer>
        <div class="copyright">Copyright webXOS 2025</div>
    </footer>
    <script src="/chatbot/static/fuse.min.js"></script>
    <script src="/chatbot/static/neurots.js" defer></script>
    <script>
        var CACHE_NAME = 'webxos-searchbot-v16';
        var cachedContent = {};
        var BOT_VERSION = '1.1.8'; // Updated for authentication fixes
        var activeVials = [];
        var isAuthenticated = false;
        var authToken = null;
        var errorLog = [];
        var isInitializing = false;
        var networkId = 'webxos';
        var authRetries = 0;
        var MAX_RETRIES = 3;

        // Log errors to /chatbot/log_error
        function logErrorToFile(message) {
            fetch('/chatbot/log_error', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ timestamp: new Date().toISOString(), message: message })
            }).catch(function(err) {
                console.warn('Failed to log error: ' + err.message);
            });
            errorLog.push('[' + new Date().toISOString() + '] ' + message);
        }

        // Modified setAgentsActive
        function setAgentsActive(isActive, vials, isDNA, isGalaxy) {
            try {
                if (typeof window.setAgentsActive === 'function') {
                    window.setAgentsActive(isActive, vials || [], isDNA || false, isGalaxy || false);
                    return;
                }
            } catch (e) {
                logErrorToFile('setAgentsActive error: ' + e.message);
                console.warn('Error in window.setAgentsActive: ' + e.message);
            }
            console.log('Fallback setAgentsActive: isActive=' + isActive + ', vials=' + (vials || []) + ', isDNA=' + isDNA + ', isGalaxy=' + isGalaxy);
            var canvas = document.getElementById('neuralCanvas');
            var ctx = canvas.getContext('2d');
            if (!isActive) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
            var colorMap = {
                'vial1': '#ff0',
                'vial2': '#0ff',
                'vial3': '#f0f',
                'vial4': '#f00'
            };
            var fillColor = isDNA ? '#0f0' : isGalaxy ? '#f0f' : (vials && vials.length && colorMap[vials[0]]) ? colorMap[vials[0]] : '#0f0';
            ctx.fillStyle = fillColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            logErrorToFile('Using fallback setAgentsActive: ' + fillColor);
        }

        // Load script
        function loadScript(src) {
            return new Promise(function(resolve, reject) {
                var script = document.createElement('script');
                script.src = src;
                script.async = true;
                script.onload = function() {
                    console.log('Script loaded: ' + src);
                    resolve();
                };
                script.onerror = function() {
                    var error = new Error('Failed to load script: ' + src);
                    logErrorToFile(error.message);
                    reject(error);
                };
                document.head.appendChild(script);
            });
        }

        // Authenticate with retry logic
        function authenticate() {
            if (isAuthenticated) {
                updateStatus('Success: Already authenticated.');
                return Promise.resolve(true);
            }
            return new Promise(function(resolve, reject) {
                function attemptAuth() {
                    fetch('/chatbot/authenticate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ network: networkId, session: 'chatbot_session_' + Date.now() })
                    })
                    .then(function(response) {
                        if (!response.ok) throw new Error('Authentication failed: ' + response.statusText);
                        return response.json();
                    })
                    .then(function(data) {
                        authToken = data.token;
                        isAuthenticated = true;
                        authRetries = 0;
                        updateStatus('Success: Authenticated with backend.');
                        resolve(true);
                    })
                    .catch(function(error) {
                        authRetries++;
                        if (authRetries < MAX_RETRIES) {
                            logErrorToFile('Authentication retry ' + authRetries + ': ' + error.message);
                            setTimeout(attemptAuth, 1000 * authRetries);
                        } else {
                            logErrorToFile('Authentication failed after ' + MAX_RETRIES + ' retries: ' + error.message);
                            updateStatus('Error: Authentication failed after retries.', true, error.message);
                            reject(error);
                        }
                    });
                }
                attemptAuth();
            });
        }

        // Import .md file
        function importVialFile() {
            if (!isAuthenticated) {
                updateStatus('Error: Please authenticate first.', true);
                return;
            }
            var fileInput = document.getElementById('fileInput');
            fileInput.click();
        }

        function handleFileImport(event) {
            var file = event.target.files[0];
            if (!file || !file.name.endsWith('.md')) {
                updateStatus('Error: Invalid file. Please upload a .md file.', true);
                logErrorToFile('Invalid file import attempt');
                return;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                if (!content.includes('## Vial Data') || !content.includes('wallet')) {
                    updateStatus('Error: Invalid .md format.', true);
                    logErrorToFile('Invalid .md format for ' + file.name);
                    return;
                }
                fetch('/chatbot/train_vials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    },
                    body: JSON.stringify({ network_id: networkId, content: content, filename: file.name })
                })
                .then(function(response) {
                    if (!response.ok) throw new Error('Import failed: ' + response.statusText);
                    return response.json();
                })
                .then(function(data) {
                    updateStatus('Success: Imported ' + file.name + '. Balance: ' + data.balance_earned);
                    var messages = document.getElementById('messages');
                    messages.innerHTML += '<p><b>System:</b> Imported ' + file.name + ' and trained vials.</p>';
                    messages.scrollTop = messages.scrollHeight;
                    activeVials = ['vial1', 'vial2', 'vial3', 'vial4'];
                    setAgentsActive(true, activeVials, false, false);
                })
                .catch(function(error) {
                    logErrorToFile('Import error: ' + error.message);
                    updateStatus('Error: Import failed.', true, error.message);
                });
            };
            reader.readAsText(file);
        }

        // Show help menu
        function showHelp() {
            var messages = document.getElementById('messages');
            messages.innerHTML = [
                '<p><b>Commands:</b></p>',
                '<p><b>/help</b> - Show this menu.</p>',
                '<p><b>/clear</b> - Clear chatbox and reset neural dots.</p>',
                '<p><b>/stats</b> - Show indexing and vial stats.</p>',
                '<p><b>/version</b> - Show bot version.</p>',
                '<p><b>/vial1</b> - Activate Vial 1 helix pattern.</p>',
                '<p><b>/vial2</b> - Activate Vial 2 cube pattern.</p>',
                '<p><b>/vial3</b> - Activate Vial 3 torus pattern.</p>',
                '<p><b>/vial4</b> - Activate Vial 4 star pattern.</p>',
                '<p><b>/dna</b> - Activate collaborative DNA-like quantum reasoning network.</p>',
                '<p><b>/galaxy</b> - Activate agentic galaxy web crawl search network.</p>',
                '<p><b>search [term]</b> - Search WebXOS content.</p>'
            ].join('');
            messages.scrollTop = messages.scrollHeight;
        }

        // Initialize app
        function initializeApp() {
            if (isInitializing) {
                logErrorToFile('Initialization skipped: Already in progress');
                return;
            }
            isInitializing = true;
            var messages = document.getElementById('messages');
            var indexErrors = [];

            function loadSiteIndex() {
                return caches.open(CACHE_NAME).then(function(cache) {
                    return fetch('/site_index.json', { cache: 'no-cache' })
                        .then(function(response) {
                            if (!response.ok) throw new Error('HTTP ' + response.status + ' ' + response.statusText);
                            if (response.headers.get('content-type').indexOf('json') === -1) {
                                throw new Error('Invalid content-type for site_index.json');
                            }
                            return response.text();
                        })
                        .then(function(text) {
                            var siteIndex;
                            try {
                                siteIndex = JSON.parse(text);
                            } catch (e) {
                                throw new Error('Failed to parse site_index.json: ' + e.message);
                            }
                            if (!siteIndex || !Array.isArray(siteIndex) || siteIndex.length === 0) {
                                throw new Error('site_index.json is empty or invalid.');
                            }
                            cachedContent['site_index'] = siteIndex;
                            return cache.put('/site_index.json', new Response(JSON.stringify(siteIndex)));
                        })
                        .then(function() {
                            cachedContent['site_index'].forEach(function(item) {
                                if (!item.path || !item.source || !item.text || !item.text.keywords || !Array.isArray(item.text.keywords) || item.text.keywords.length === 0) {
                                    indexErrors.push('Invalid content for ' + item.path);
                                }
                            });
                            if (indexErrors.length > 0) {
                                messages.innerHTML += '<p><b>Index Errors:</b> ' + indexErrors.join('; ') + '</p>';
                                updateStatus('Warning: Issues during index initialization.', false, indexErrors.join('; '));
                            } else {
                                updateStatus('Success: Indexed ' + cachedContent['site_index'].length + ' files.');
                            }
                        })
                        .catch(function(error) {
                            logErrorToFile('Index error: ' + error.message);
                            return cache.match('/site_index.json').then(function(cachedIndex) {
                                if (cachedIndex) {
                                    return cachedIndex.json().then(function(data) {
                                        cachedContent['site_index'] = data;
                                        indexErrors.push('Used cached site_index.json due to: ' + error.message);
                                        messages.innerHTML += '<p><b>Index Errors:</b> ' + indexErrors.join('; ') + '</p>';
                                        updateStatus('Warning: Issues during index initialization.', false, indexErrors.join('; '));
                                    }).catch(function(e) {
                                        logErrorToFile('Cached index parse error: ' + e.message);
                                        cachedContent['site_index'] = [];
                                        messages.innerHTML += '<p><b>Index Error:</b> Failed to parse cached site_index.json: ' + e.message + '</p>';
                                        updateStatus('Error: Failed to initialize index.', true, e.message);
                                    });
                                } else {
                                    cachedContent['site_index'] = [];
                                    messages.innerHTML += '<p><b>Index Error:</b> ' + error.message + '</p>';
                                    updateStatus('Error: Failed to initialize index.', true, error.message);
                                }
                            });
                        });
                });
            }

            function loadNeurots() {
                return loadScript('/chatbot/static/neurots.js').then(function() {
                    if (typeof window.initNeurots === 'function') {
                        try {
                            initNeurots();
                            console.log('Neurots initialized successfully');
                        } catch (e) {
                            logErrorToFile('initNeurots error: ' + e.message);
                            throw new Error('initNeurots failed: ' + e.message);
                        }
                    } else {
                        console.warn('initNeurots not defined, attempting CDN fallback');
                        return loadScript('https://cdn.jsdelivr.net/gh/webxos/webxos@latest/chatbot/static/neurots.js').then(function() {
                            if (typeof window.initNeurots === 'function') {
                                initNeurots();
                                console.log('Neurots initialized successfully from CDN');
                            } else {
                                throw new Error('initNeurots function not defined after loading neurots.js from CDN');
                            }
                        });
                    }
                }).catch(function(error) {
                    logErrorToFile('Neurots error: ' + error.message);
                    messages.innerHTML += '<p><b>Error:</b> Failed to initialize neural dots. ' + error.message + '</p>';
                    updateStatus('Error: Neural dots failed to initialize.', true, error.message);
                });
            }

            loadSiteIndex().then(function() {
                showHelp();
                return loadNeurots();
            }).catch(function(error) {
                logErrorToFile('Initialization error: ' + error.message);
                messages.innerHTML += '<p><b>Initialization Error:</b> ' + error.message + '</p>';
                updateStatus('Error: Failed to initialize app.', true, error.message);
                showHelp();
            }).finally(function() {
                isInitializing = false;
            });
        }

        window.addEventListener('load', initializeApp);

        function updateStatus(message, isError, details) {
            var status = document.getElementById('status');
            var timestamp = new Date().toLocaleTimeString();
            status.innerHTML = '<span class="' + (isError ? 'error' : 'success') + '">' + message + (isError || details ? '<br><small>Details: ' + details + ' [' + timestamp + ']</small>' : '') + '</span>';
            status.classList.add('show');
            setTimeout(function() { status.classList.remove('show'); }, 3000);
            if (isError || details) {
                logErrorToFile(message + ': ' + details);
            }
        }

        function clearChat() {
            var messages = document.getElementById('messages');
            messages.innerHTML = '';
            activeVials = [];
            setAgentsActive(false);
            updateStatus('Success: Chatbox cleared.');
            showHelp();
            messages.scrollTop = messages.scrollHeight;
            if (isAuthenticated) {
                fetch('/chatbot/reset_vials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    }
                }).catch(function(error) {
                    logErrorToFile('Reset vials error: ' + error.message);
                    updateStatus('Error: Failed to reset vials.', true, error.message);
                });
            }
        }

        function displayResults(results, isGalaxy) {
            var messages = document.getElementById('messages');
            messages.innerHTML += '<p><b>' + (isGalaxy ? 'Galaxy Search Results' : 'Search Results') + ':</b> Found ' + results.length + ' results' + (isGalaxy ? ' via agentic web crawl.' : '.') + '</p>';
            results.forEach(function(result) {
                result.matches.forEach(function(match) {
                    var snippet = match.value.slice(Math.max(0, match.indices[0][0] - 50), match.indices[0][1] + 50);
                    var url = 'https://webxos.netlify.app' + result.item.path;
                    messages.innerHTML += '<p><b>Result (<a href="' + url + '" target="_blank">' + result.item.source + '</a>):</b> ...' + snippet + '...</p>';
                });
            });
            messages.scrollTop = messages.scrollHeight;
        }

        function galaxySearch(query) {
            if (!isAuthenticated) {
                updateStatus('Error: Please authenticate for galaxy search.', true);
                return Promise.resolve([]);
            }
            return fetch('/chatbot/galaxy_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({ query: query, vials: activeVials })
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Galaxy search failed: ' + response.statusText);
                return response.json();
            })
            .then(function(results) {
                return results;
            })
            .catch(function(error) {
                logErrorToFile('Galaxy search error: ' + error.message);
                updateStatus('Error: Galaxy search failed.', true, error.message);
                return [];
            });
        }

        function dnaReasoning(query) {
            if (!isAuthenticated) {
                updateStatus('Error: Please authenticate for DNA mode.', true);
                return Promise.resolve([]);
            }
            return fetch('/chatbot/dna_reasoning', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({ query: query, vials: activeVials })
            })
            .then(function(response) {
                if (!response.ok) throw new Error('DNA reasoning failed: ' + response.statusText);
                return response.json();
            })
            .then(function(results) {
                return results;
            })
            .catch(function(error) {
                logErrorToFile('DNA reasoning error: ' + error.message);
                updateStatus('Error: DNA reasoning failed.', true, error.message);
                return [];
            });
        }

        function searchQuery() {
            var query = document.getElementById('userInput').value.trim().toLowerCase();
            var messages = document.getElementById('messages');
            var loading = document.getElementById('loading');
            if (!query) {
                updateStatus('Error: Empty input.', true, 'Please enter a search term or /vial1-4, /dna, /galaxy.');
                return;
            }
            var colorClass = '';
            if (query.startsWith('/vial1')) colorClass = 'vial1-color';
            else if (query.startsWith('/vial2')) colorClass = 'vial2-color';
            else if (query.startsWith('/vial3')) colorClass = 'vial3-color';
            else if (query.startsWith('/vial4')) colorClass = 'vial4-color';
            messages.innerHTML += '<p class="' + colorClass + '"><b>You:</b> ' + query + '</p>';
            loading.style.display = 'block';

            try {
                if (query.startsWith('/')) {
                    var command = query.split(' ')[0];
                    switch (command) {
                        case '/help':
                            showHelp();
                            updateStatus('Success: Help menu displayed.');
                            setAgentsActive(false);
                            break;
                        case '/clear':
                            clearChat();
                            break;
                        case '/stats':
                            var indexedFiles = cachedContent['site_index'] ? cachedContent['site_index'].length : 0;
                            var totalKeywords = cachedContent['site_index'] ? cachedContent['site_index'].reduce(function(sum, item) {
                                return sum + (item.text && item.text.keywords ? item.text.keywords.length : 0);
                            }, 0) : 0;
                            messages.innerHTML += '<p><b>Stats:</b> Indexed ' + indexedFiles + ' files with ' + totalKeywords + ' keywords.</p>';
                            if (isAuthenticated) {
                                fetch('/chatbot/get_vials', {
                                    headers: { 'Authorization': 'Bearer ' + authToken }
                                })
                                .then(function(response) {
                                    if (!response.ok) throw new Error('Failed to get vial states');
                                    return response.json();
                                })
                                .then(function(vialStates) {
                                    messages.innerHTML += '<p><b>Vial States:</b> ' + JSON.stringify(vialStates) + '</p>';
                                    messages.scrollTop = messages.scrollHeight;
                                })
                                .catch(function(error) {
                                    logErrorToFile('Get vial states error: ' + error.message);
                                });
                            }
                            updateStatus('Success: Indexing stats displayed.');
                            setAgentsActive(false);
                            break;
                        case '/version':
                            messages.innerHTML += '<p><b>Version:</b> WebXOS Searchbot v' + BOT_VERSION + '</p>';
                            updateStatus('Success: Version displayed.');
                            setAgentsActive(false);
                            break;
                        case '/vial1':
                        case '/vial2':
                        case '/vial3':
                        case '/vial4':
                            if (!isAuthenticated) {
                                updateStatus('Error: Please authenticate to activate vials.', true);
                                break;
                            }
                            var vialName = command.slice(1);
                            activeVials = [vialName];
                            console.log('Activating ' + vialName.toUpperCase());
                            setAgentsActive(true, [vialName], false, false);
                            messages.innerHTML += '<p class="' + vialName + '-color"><b>' + vialName.toUpperCase() + ':</b> ' + vialName.toUpperCase() + ' pattern activated.</p>';
                            updateStatus('Success: ' + vialName.toUpperCase() + ' activated.');
                            break;
                        case '/dna':
                            if (!isAuthenticated) {
                                updateStatus('Error: Please authenticate for DNA mode.', true);
                                break;
                            }
                            activeVials = ['vial1', 'vial2', 'vial3', 'vial4'];
                            setAgentsActive(true, activeVials, true, false);
                            messages.innerHTML += '<p><b>System:</b> Collaborative DNA-like quantum reasoning network activated.</p>';
                            dnaReasoning(query.split(' ').slice(1).join(' ')).then(function(results) {
                                if (results.length > 0) {
                                    messages.innerHTML += '<p><b>DNA Reasoning Results:</b> ' + results.join('<br>') + '</p>';
                                    messages.scrollTop = messages.scrollHeight;
                                }
                            });
                            updateStatus('Success: DNA activated.');
                            break;
                        case '/galaxy':
                            if (!isAuthenticated) {
                                updateStatus('Error: Please authenticate for galaxy mode.', true);
                                break;
                            }
                            activeVials = ['vial1', 'vial2', 'vial3', 'vial4'];
                            setAgentsActive(true, activeVials, false, true);
                            messages.innerHTML += '<p><b>System:</b> Agentic galaxy search network activated.</p>';
                            galaxySearch(query.split(' ').slice(1).join(' ')).then(function(results) {
                                displayResults(results, true);
                            });
                            updateStatus('Success: Galaxy activated.');
                            break;
                        default:
                            messages.innerHTML += '<p><b>Error:</b> Unknown command "' + command + '". Type /help for commands.</p>';
                            updateStatus('Error: Unknown command.', true);
                            setAgentsActive(false);
                    }
                } else {
                    var results;
                    if (activeVials.length > 0 && query && isAuthenticated) {
                        results = galaxySearch(query);
                    } else {
                        var fuse = new Fuse(cachedContent['site_index'] || [], {
                            keys: ['text.content', 'text.keywords'],
                            threshold: 0.4,
                            includeMatches: true
                        });
                        results = Promise.resolve(fuse.search(query));
                    }
                    results.then(function(data) {
                        if (data.length === 0) {
                            messages.innerHTML += '<p><b>Search Result:</b> No results found for "' + query + '". Try a different query.</p>';
                            updateStatus('Success: Search completed. No results found.');
                        } else {
                            displayResults(data, activeVials.length > 0 && isAuthenticated);
                            updateStatus('Success: Search completed. Found ' + data.length + ' results.');
                        }
                        setAgentsActive(false);
                    })
                    .catch(function(error) {
                        logErrorToFile('Search error: ' + error.message);
                        messages.innerHTML += '<p><b>Error:</b> ' + error.message + '</p>';
                        updateStatus('Error: Search failed.', true, error.message);
                        setAgentsActive(false);
                    })
                    .finally(function() {
                        loading.style.display = 'none';
                        document.getElementById('userInput').value = '';
                        messages.scrollTop = messages.scrollHeight;
                    });
                }
            } catch (error) {
                logErrorToFile('Search error: ' + error.message);
                messages.innerHTML += '<p><b>Error:</b> ' + error.message + '</p>';
                updateStatus('Error: Search failed.', true, error.message);
                setAgentsActive(false);
                loading.style.display = 'none';
                document.getElementById('userInput').value = '';
                messages.scrollTop = messages.scrollHeight;
            }
        }

        document.getElementById('userInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchQuery();
            }
        });
        document.getElementById('searchButton').addEventListener('click', function() {
            console.log('Search button clicked');
            searchQuery();
        });
        document.getElementById('clearButton').addEventListener('click', function() {
            console.log('Clear button clicked');
            clearChat();
        });
        document.getElementById('authButton').addEventListener('click', function() {
            console.log('Auth button clicked');
            authenticate();
        });
        document.getElementById('importButton').addEventListener('click', function() {
            console.log('Import button clicked');
            importVialFile();
        });
        document.getElementById('fileInput').addEventListener('change', handleFileImport);
    </script>
</body>
</html>
