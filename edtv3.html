<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>edTV: WEBXR MILITARY MASK TRY-ON</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0f0;overflow:hidden;height:100dvh;touch-action:manipulation;user-select:none}
  #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column}
  .grid,.crt{position:absolute;inset:0;pointer-events:none}
  .grid{background:linear-gradient(rgba(0,255,0,0.06)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.06)1px,transparent 1px);background-size:12px 12px}
  .crt{background:linear-gradient(transparent 50%,rgba(0,30,0,0.15)50%);background-size:100% 4px;animation:s 8s linear infinite}
  @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
  .banner{background:rgba(0,40,0,0.98);border-bottom:2px solid #0f0;padding:12px 8px;font-size:10px;text-align:center;text-shadow:0 0 10px #0f0}
  .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;padding-bottom:max(env(safe-area-inset-bottom),20px)}
  .ar-view{flex:1;position:relative;border:2px solid #0f0;overflow:hidden;background:#000;border-radius:8px;box-shadow:0 0 20px rgba(0,255,0,0.6)}
  #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);display:none}
  #canvas{position:absolute;inset:0;width:100%;height:100%}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;background:rgba(0,30,0,0.9);border:2px solid #0f0}
  .btn,.dropdown{font-size:9px;padding:10px 14px;border:2px solid #0f0;background:#000;color:#0f0;cursor:pointer;transition:.2s;flex:1 1 100px;max-width:220px}
  .btn:hover,.btn:active{background:#0f0;color:#000;box-shadow:0 0 15px #0f0}
  .terminal{height:16dvh;background:rgba(0,0,0,0.9);border:2px solid #0f0;padding:8px;font-size:8px;overflow-y:auto;color:#0f0}
  .status{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:8px;z-index:20;flex-wrap:wrap}
  .ind{padding:4px 8px;font-size:7px;background:rgba(0,60,0,0.9);border:1px solid #0f0;border-radius:4px}
  .locked{background:rgba(0,255,0,0.9);box-shadow:0 0 12px #0f0;animation:p 1.5s infinite}
  @keyframes p{0%,100%{opacity:1}50%{opacity:0.6}}
</style>
</head>
<body>
<div id="app">
  <div class="grid"></div><div class="crt"></div>
  <div class="banner">edTV: WEBXR MILITARY MASK TRY-ON</div>
  <div class="content">
    <div class="controls">
      <button class="btn" id="start">ENTER XR</button>
      <select class="dropdown" id="mask-select">
        <option value="oni">ONI DEMON</option>
        <option value="tactical">TACTICAL</option>
        <option value="gas">GAS MASK</option>
        <option value="respirator">RESPIRATOR</option>
        <option value="cyber">CYBER HELMET</option>
        <option value="skull">SKULL</option>
      </select>
    </div>
    <div class="terminal" id="log">> READY</div>
    <div class="ar-view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="status">
        <div class="ind" id="track">TRACKING: OFF</div>
        <div class="ind" id="mask">MASK: ONI</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
import {ARButton} from 'https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/webxr/ARButton.js';
import {FaceLandmarker, FilesetResolver} from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14';

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');

let renderer, scene, camera, reticle;
let maskGroup = new THREE.Group();
let faceLandmarker;
let currentMask = 'oni';
let hitTestSource = null;

const configs = {
  oni:       {scale:1.6, y:0.02, z:-0.55, color:0x00ff00},
  tactical:  {scale:1.8, y:0.06, z:-0.52, color:0x004400},
  gas:       {scale:2.0, y:0.03, z:-0.60, color:0x00ff44},
  respirator:{scale:1.5, y:0.08, z:-0.48, color:0x0088ff},
  cyber:     {scale:1.7, y:0.05, z:-0.50, color:0x00ffff},
  skull:     {scale:1.6, y:0.00, z:-0.58, color:0xff0088}
};

function log(t){const d=document.createElement('div');d.textContent='> '+t;logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}

function createWireframeMask(type) {
  maskGroup.clear();
  const config = configs[type];
  const material = new THREE.LineBasicMaterial({color: config.color, linewidth:2, transparent:true, opacity:0.9});
  
  // Main helmet shell
  const shell = new THREE.BufferGeometry();
  const verts = [];
  for(let i=0;i<=64;i++){
    const a = i/64*Math.PI*2;
    const r = 0.22 + Math.sin(i/8)*0.02;
    verts.push(Math.cos(a)*r, Math.sin(a)*r + 0.15, 0);
    verts.push(Math.cos(a)*r*0.9, Math.sin(a)*r*0.9 + 0.15, -0.08);
  }
  shell.setAttribute('position', new THREE.Float32BufferAttribute(verts,3));
  const lines = new THREE.LineSegments(shell, material);
  maskGroup.add(lines);
  
  // Visor grid
  const visor = new THREE.BufferGeometry();
  const vverts = [];
  for(let x=-0.15;x<=0.15;x+=0.03)for(let y=-0.05;y<=0.1;y+=0.02){
    vverts.push(x, y, -0.12, x+0.03, y, -0.12);
    vverts.push(x, y, -0.12, x, y+0.02, -0.12);
  }
  visor.setAttribute('position', new THREE.Float32BufferAttribute(vverts,3));
  maskGroup.add(new THREE.LineSegments(visor, material));
  
  // Side panels
  const side = new THREE.RingGeometry(0.08, 0.12, 16);
  const left = new THREE.LineSegments(new THREE.EdgesGeometry(side), material);
  left.position.set(-0.18, 0.08, -0.05);
  const right = left.clone();
  right.position.x = 0.18;
  maskGroup.add(left, right);
  
  // Breathing vents
  for(let i=0;i<5;i++){
    const vent = new THREE.BoxGeometry(0.04, 0.02, 0.02);
    const v = new THREE.LineSegments(new THREE.EdgesGeometry(vent), material);
    v.position.set(-0.02 + i*0.01, -0.08, -0.18);
    maskGroup.add(v);
  }
  
  maskGroup.scale.setScalar(config.scale);
  maskGroup.position.y = config.y;
  maskGroup.position.z = config.z;
  scene.add(maskGroup);
  maskEl.textContent = `MASK: ${type.toUpperCase()}`;
}

async function startXR() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 20);
  renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
  renderer.setPixelRatio(devicePixelRatio);
  renderer.setSize(innerWidth, innerHeight);
  renderer.xr.enabled = true;
  
  const light = new THREE.HemisphereLight(0xffffff, 0x00ff88, 1.6);
  scene.add(light);
  
  document.body.appendChild(ARButton.createButton(renderer, {requiredFeatures: ['local-floor']}));
  
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
  video.srcObject = stream;
  await video.play();
  
  const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
  faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
    baseOptions: {modelAssetPath:'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task'},
    runningMode: 'VIDEO',
    numFaces: 1
  });
  
  trackEl.textContent = 'TRACKING: LOCKED';
  trackEl.classList.add('locked');
  createWireframeMask(currentMask);
  
  renderer.setAnimationLoop(time => {
    if(video.readyState >= 2){
      const results = faceLandmarker.detectForVideo(video, performance.now());
      if(results.faceLandmarks?.[0]){
        const lm = results.faceLandmarks[0].map(p=>({x:1-p.x,y:p.y,z:p.z}));
        const le = lm[33], re = lm[263], nose = lm[1];
        const eyeDist = Math.hypot(re.x-le.x, re.y-le.y);
        const centerX = (le.x + re.x)/2 - 0.5;
        const centerY = (le.y + re.y)/2 - 0.5;
        
        const config = configs[currentMask];
        const scale = eyeDist * 12 * config.scale;
        const yaw = Math.PI + (re.x - le.x)*5;
        
        maskGroup.position.set(centerX*1.2, -centerY*1.2 + 0.15, -0.6);
        maskGroup.scale.setScalar(scale);
        maskGroup.rotation.y = yaw;
      }
    }
    renderer.render(scene, camera);
  });
  
  log('WEBXR MASK TRY-ON ACTIVE');
}

document.getElementById('start').onclick = startXR;
document.getElementById('mask-select').onchange = e => {
  currentMask = e.target.value;
  createWireframeMask(currentMask);
  log(`MASK: ${currentMask.toUpperCase()}`);
};

log('PRESS ENTER XR');
</script>
</body>
</html>
