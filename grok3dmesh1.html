<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3DMESH by webXOS 2025 - Wireframe 3D Modeling IDE</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="data:application/manifest+json,{}">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
        body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
        #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
        .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;z-index:1;opacity:0.3}
        .crt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;z-index:10;pointer-events:none;animation:scanline 8s linear infinite}
        @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
        #visualizationContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2}
        #ideInterface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;pointer-events:none}
        
        /* Control Buttons */
        .ctrl-btn{
            width:48px;height:48px;background:rgba(0,0,0,0.9);border:2px solid #0f0;color:#0f0;
            font-size:7px;display:flex;align-items:center;justify-content:center;cursor:pointer;pointer-events:auto;
            box-shadow:2px 2px 0 #000;z-index:5;transition:all .1s;transform:skew(-2deg);touch-action:none
        }
        .ctrl-btn:hover,.ctrl-btn:active{background:#0f0;color:#000}
        .ctrl-btn.active{background:#0f0;color:#000}
        
        /* Top Controls */
        .top-controls{position:absolute;top:8px;left:50%;transform:translateX(-50%);display:flex;gap:8px;pointer-events:none}
        .top-controls .ctrl-btn{position:relative;transform:skew(-2deg)}
        
        /* Main Controls - Bottom */
        .main-controls{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);display:flex;gap:8px;pointer-events:none}
        .main-controls .ctrl-btn{position:relative;transform:skew(-2deg)}
        
        /* Mode Controls */
        .mode-controls{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);display:flex;gap:8px;pointer-events:none}
        .mode-controls .ctrl-btn{position:relative;transform:skew(-2deg)}
        
        /* View Controls */
        .view-controls{position:absolute;top:8px;left:8px;display:flex;gap:8px;pointer-events:none}
        .view-controls .ctrl-btn{width:36px;height:36px;font-size:6px}
        
        /* Popups */
        .popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,10,0,0.98);border:3px solid #0f0;padding:12px;z-index:100;pointer-events:auto;box-shadow:6px 6px 0 #000,inset 2px 2px 0 #0f0;width:90%;max-width:400px;max-height:85vh;overflow-y:auto;font-size:8px;color:#0f0;touch-action:manipulation}
        .popup-title{font-size:10px;margin-bottom:8px;text-align:center;text-shadow:1px 1px 0 #000;color:#0ff}
        .popup-close{position:absolute;top:6px;right:6px;width:24px;height:24px;background:#000;border:2px solid #f00;color:#f00;font-size:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:none}
        .popup-close:hover,.popup-close:active{background:#f00;color:#000}
        .popup-item{margin:4px 0;display:flex;justify-content:space-between}
        .popup-btn{width:100%;margin-top:8px;padding:6px;background:#000;border:2px solid #0f0;color:#0f0;font-size:7px;cursor:pointer;text-align:center;touch-action:none}
        .popup-btn:hover,.popup-btn:active{background:#0f0;color:#000}
        .help-icon{position:absolute;top:6px;left:6px;width:24px;height:24px;background:#000;border:2px solid #ff0;color:#ff0;font-size:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:none}
        .help-icon:hover,.help-icon:active{background:#ff0;color:#000}
        
        /* Terminal */
        #terminalPopup .terminal-line{font-family:'Courier New',monospace;line-height:1.3}
        #terminalInput{width:100%;background:transparent;border:none;color:#0f0;font-family:'Courier New';font-size:8px;outline:none;margin-top:4px}
        
        /* Status */
        .status-indicator{display:inline-block;width:6px;height:6px;border-radius:0;margin-right:4px;background:#0f0;box-shadow:1px 1px 0 #000}
        .disconnected{background:#f00}
        
        /* Badges */
        .beta-badge{position:absolute;top:45px;left:50%;transform:translateX(-50%);background:rgba(255,0,255,0.9);border:2px solid #f0f;padding:3px 7px;font-size:8px;color:#000;z-index:5;pointer-events:none}
        .copyright{position:absolute;bottom:3px;right:3px;font-size:5px;color:#0f0;opacity:0.7;pointer-events:none;z-index:5}
        
        canvas{display:block}
        #file-input{display:none}
        
        /* Enhanced Wireframe */
        .enhanced-wireframe {position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;}
        
        /* Desktop Override */
        @media (min-width:768px){
            .ctrl-btn{width:50px;height:50px;font-size:8px}
            .view-controls .ctrl-btn{width:40px;height:40px;font-size:7px}
        }
        
        /* Mobile Optimization */
        @media (max-width: 767px) {
            .top-controls, .main-controls, .mode-controls {gap: 4px;}
            .ctrl-btn {width: 44px; height: 44px; font-size: 6px;}
            .view-controls .ctrl-btn {width: 34px; height: 34px; font-size: 5px;}
        }
        
        /* Properties Panel */
        .properties-panel{position:absolute;top:50%;right:8px;transform:translateY(-50%);background:rgba(0,20,0,0.8);border:2px solid #0f0;padding:8px;width:150px;pointer-events:auto;z-index:5}
        .property-item{margin:4px 0;font-size:6px}
        .property-label{color:#0ff;margin-bottom:2px}
        .property-input{width:100%;background:#000;border:1px solid #0f0;color:#0f0;font-size:6px;padding:2px}
        .color-picker{width:100%;height:20px;background:#000;border:1px solid #0f0;cursor:pointer}
        
        /* Templates Dropdown */
        .templates-panel{position:absolute;top:80px;left:8px;background:rgba(0,20,0,0.8);border:2px solid #0f0;padding:8px;width:200px;pointer-events:auto;z-index:5}
        .template-select{width:100%;background:#000;border:1px solid #0f0;color:#0f0;font-size:8px;padding:4px;margin-bottom:8px}
        .template-category{margin-bottom:8px}
        .template-category-title{color:#0ff;font-size:8px;margin-bottom:4px;border-bottom:1px solid #0f0;padding-bottom:2px}
        .template-item{padding:4px;cursor:pointer;font-size:7px;border-left:2px solid #0f0;margin:2px 0}
        .template-item:hover{background:rgba(0,255,0,0.2)}
        
        /* 3D Ruler */
        .ruler-3d{position:absolute;bottom:0;left:0;width:100%;height:30px;background:rgba(0,20,0,0.7);border-top:2px solid #0f0;z-index:4;pointer-events:none}
        .ruler-mark{position:absolute;bottom:0;width:1px;height:10px;background:#0f0}
        .ruler-number{position:absolute;bottom:12px;color:#0f0;font-size:6px;transform:translateX(-50%)}
        
        /* Loading Screen */
        #loadingScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center}
        .glitch-text{font-size:24px;color:#0f0;text-shadow:2px 2px 0 #f0f, -2px -2px 0 #0ff;animation:glitch 0.5s infinite}
        @keyframes glitch{0%{transform:translate(0)}20%{transform:translate(-2px,2px)}40%{transform:translate(-2px,-2px)}60%{transform:translate(2px,2px)}80%{transform:translate(2px,-2px)}100%{transform:translate(0)}}
        .loading-bar{width:300px;height:20px;background:#000;border:2px solid #0f0;margin-top:20px;overflow:hidden}
        .loading-progress{height:100%;background:#0f0;width:0%;transition:width 0.3s}
        .loading-dots{color:#0f0;font-size:24px;margin-top:10px;animation:dots 1.5s infinite}
        @keyframes dots{0%,20%{content:""}40%{content:"."}60%{content:".."}80%,100%{content:"..."}}
    </style>
</head>
<body>
<div id="appContainer">
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="glitch-text">3DMESH by webXOS</div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <div class="loading-dots" id="loadingDots">...</div>
    </div>

    <div class="matrix-grid"></div>
    <div class="crt-overlay"></div>
    
    <!-- Enhanced Wireframe Overlay -->
    <div class="enhanced-wireframe" id="wireframeOverlay"></div>
    
    <!-- 3D Ruler -->
    <div class="ruler-3d" id="ruler3D"></div>
    
    <!-- 3D SCENE -->
    <div id="visualizationContainer"><canvas id="visualizationCanvas"></canvas></div>
    
    <div id="ideInterface">
        <div class="beta-badge">3DMESH v2.0 by webXOS</div>
        
        <!-- VIEW CONTROLS -->
        <div class="view-controls">
            <button id="fullscreenBtn" class="ctrl-btn">FS</button>
            <button id="wireframeBtn" class="ctrl-btn active">WIRE</button>
        </div>
        
        <!-- TOP CONTROLS -->
        <div class="top-controls">
            <button id="guideBtn" class="ctrl-btn">GUIDE</button>
            <button id="termBtn" class="ctrl-btn">TERM</button>
            <button id="statusBtn" class="ctrl-btn">STAT</button>
            <button id="templatesBtn" class="ctrl-btn">TEMPLATES</button>
        </div>
        
        <!-- MODE CONTROLS -->
        <div class="mode-controls">
            <button id="modelBtn" class="ctrl-btn active">MODEL</button>
            <button id="levelBtn" class="ctrl-btn">LEVEL</button>
            <button id="codeBtn" class="ctrl-btn">CODE</button>
        </div>
        
        <!-- MAIN CONTROLS -->
        <div class="main-controls">
            <button id="selectBtn" class="ctrl-btn active">SELECT</button>
            <button id="moveBtn" class="ctrl-btn">MOVE</button>
            <button id="rotateBtn" class="ctrl-btn">ROTATE</button>
            <button id="scaleBtn" class="ctrl-btn">SCALE</button>
            <button id="drawBtn" class="ctrl-btn">DRAW</button>
            <button id="extrudeBtn" class="ctrl-btn">EXTRUDE</button>
            <button id="booleanBtn" class="ctrl-btn">BOOL</button>
            <button id="exportBtn" class="ctrl-btn">EXPORT</button>
            <button id="importBtn" class="ctrl-btn">IMPORT</button>
        </div>
        
        <!-- TEMPLATES PANEL -->
        <div class="templates-panel" id="templatesPanel" style="display:none">
            <select class="template-select" id="templateCategory">
                <option value="shapes">BASIC SHAPES</option>
                <option value="buildings">BUILDINGS</option>
                <option value="rpg">RPG ITEMS</option>
                <option value="fps">FPS TEMPLATES</option>
                <option value="vehicles">VEHICLES</option>
                <option value="characters">CHARACTERS</option>
                <option value="rockets">ROCKETS</option>
                <option value="files">FILES</option>
            </select>
            
            <div class="template-category" id="shapesCategory">
                <div class="template-category-title">BASIC SHAPES</div>
                <div class="template-item" data-template="cube">Cube</div>
                <div class="template-item" data-template="sphere">Sphere</div>
                <div class="template-item" data-template="cylinder">Cylinder</div>
                <div class="template-item" data-template="cone">Cone</div>
                <div class="template-item" data-template="torus">Torus</div>
                <div class="template-item" data-template="plane">Plane</div>
                <div class="template-item" data-template="pyramid">Pyramid</div>
                <div class="template-item" data-template="octahedron">Octahedron</div>
            </div>
            
            <div class="template-category" id="buildingsCategory" style="display:none">
                <div class="template-category-title">BUILDINGS</div>
                <div class="template-item" data-template="house">Simple House</div>
                <div class="template-item" data-template="tower">Watch Tower</div>
                <div class="template-item" data-template="castle">Castle</div>
                <div class="template-item" data-template="bridge">Bridge</div>
                <div class="template-item" data-template="wall">Wall Segment</div>
                <div class="template-item" data-template="dungeon">Dungeon Entrance</div>
            </div>
            
            <div class="template-category" id="rpgCategory" style="display:none">
                <div class="template-category-title">RPG ITEMS</div>
                <div class="template-item" data-template="chest">Treasure Chest</div>
                <div class="template-item" data-template="sword">Sword</div>
                <div class="template-item" data-template="shield">Shield</div>
                <div class="template-item" data-template="potion">Health Potion</div>
                <div class="template-item" data-template="key">Dungeon Key</div>
                <div class="template-item" data-template="portal">Magic Portal</div>
            </div>
            
            <div class="template-category" id="fpsCategory" style="display:none">
                <div class="template-category-title">FPS TEMPLATES</div>
                <div class="template-item" data-template="assault_rifle">Assault Rifle</div>
                <div class="template-item" data-template="pistol">Pistol</div>
                <div class="template-item" data-template="shotgun">Shotgun</div>
                <div class="template-item" data-template="sniper">Sniper Rifle</div>
                <div class="template-item" data-template="hud">FPS HUD</div>
                <div class="template-item" data-template="ammo">Ammo Crate</div>
            </div>

            <div class="template-category" id="rocketsCategory" style="display:none">
                <div class="template-category-title">ROCKET PARTS</div>
                <div class="template-item" data-template="bodyTube">Body Tube</div>
                <div class="template-item" data-template="noseCone">Nose Cone</div>
                <div class="template-item" data-template="fins">Fins</div>
                <div class="template-item" data-template="parachute">Parachute</div>
                <div class="template-item" data-template="payload">Payload</div>
                <div class="template-item" data-template="engine">Engine</div>
                <div class="template-item" data-template="arduino">Arduino</div>
                <div class="template-item" data-template="raspberry">Raspberry Pi</div>
                <div class="template-item" data-template="battery">Battery</div>
                <div class="template-item" data-template="radio">Radio</div>
                <div class="template-item" data-template="gps">GPS</div>
                <div class="template-item" data-template="imu">IMU</div>
                <div class="template-item" data-template="booster">Booster</div>
                <div class="template-item" data-template="fuelTank">Fuel Tank</div>
                <div class="template-item" data-template="oxidizer">Oxidizer</div>
                <div class="template-item" data-template="turbopump">Turbopump</div>
                <div class="template-item" data-template="nozzle">Nozzle</div>
                <div class="template-item" data-template="thermometer">Thermometer</div>
                <div class="template-item" data-template="altimeter">Altimeter</div>
                <div class="template-item" data-template="barometer">Barometer</div>
                <div class="template-item" data-template="camera">Camera</div>
                <div class="template-item" data-template="accelerometer">Accelerometer</div>
            </div>

            <div class="template-category" id="filesCategory" style="display:none">
                <div class="template-category-title">FILES</div>
                <div class="template-item" data-template="import_file">Import File</div>
                <div class="template-item" data-template="import_paste">Import Paste</div>
                <div class="template-item" data-template="export_json">Export JSON</div>
            </div>
        </div>
        
        <!-- PROPERTIES PANEL -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="property-item">
                <div class="property-label">OBJECT:</div>
                <input type="text" class="property-input" id="objectName" value="Object">
            </div>
            <div class="property-item">
                <div class="property-label">POSITION:</div>
                <div style="display:flex;gap:4px">
                    <input type="number" class="property-input" id="posX" value="0" step="0.1">
                    <input type="number" class="property-input" id="posY" value="0" step="0.1">
                    <input type="number" class="property-input" id="posZ" value="0" step="0.1">
                </div>
            </div>
            <div class="property-item">
                <div class="property-label">ROTATION:</div>
                <div style="display:flex;gap:4px">
                    <input type="number" class="property-input" id="rotX" value="0" step="0.1">
                    <input type="number" class="property-input" id="rotY" value="0" step="0.1">
                    <input type="number" class="property-input" id="rotZ" value="0" step="0.1">
                </div>
            </div>
            <div class="property-item">
                <div class="property-label">SCALE:</div>
                <div style="display:flex;gap:4px">
                    <input type="number" class="property-input" id="scaleX" value="1" step="0.1">
                    <input type="number" class="property-input" id="scaleY" value="1" step="0.1">
                    <input type="number" class="property-input" id="scaleZ" value="1" step="0.1">
                </div>
            </div>
            <div class="property-item">
                <div class="property-label">COLOR:</div>
                <input type="color" class="color-picker" id="objectColor" value="#00ff00">
            </div>
            <button class="popup-btn" id="updateProps">UPDATE</button>
            <button class="popup-btn" id="deleteObj">DELETE</button>
        </div>
        
        <div class="copyright">Â© 2025 webXOS - 3DMESH v2.0</div>
    </div>

    <!-- GUIDE POPUP -->
    <div class="popup" id="guidePopup">
        <div class="help-icon" data-help="guide">?</div>
        <div class="popup-close">X</div>
        <div class="popup-title">3DMESH GUIDE</div>
        <div class="popup-item">> CUBE/SPHERE/CYL = ADD SHAPES</div>
        <div class="popup-item">> SELECT/MOVE/ROTATE/SCALE = TOOLS</div>
        <div class="popup-item">> DRAW = CREATE CUSTOM WIREFRAME</div>
        <div class="popup-item">> EXTRUDE = PULL FACES OUTWARD</div>
        <div class="popup-item">> BOOL = UNION/SUBTRACT/INTERSECT</div>
        <div class="popup-item">> CLICK = SELECT OBJECTS</div>
        <div class="popup-item">> RIGHT-CLICK = SHOW CONTEXT MENU</div>
        <div class="popup-item">> EXPORT = GENERATE THREE.JS CODE</div>
        <div class="popup-item">> WIRE = TOGGLE WIREFRAME MODE</div>
        <div class="popup-item">> ORBIT = CAMERA CONTROL MODE</div>
        <div class="popup-item">> PROPERTIES = EDIT OBJECT PARAMS</div>
        <div class="popup-item">> TEMPLATES = PREBUILT MODELS</div>
        <div class="popup-item">> RULER = MEASUREMENT TOOL</div>
    </div>

    <!-- TERMINAL -->
    <div class="popup" id="terminalPopup">
        <div class="help-icon" data-help="terminal">?</div>
        <div class="popup-close">X</div>
        <div class="popup-title">TERMINAL</div>
        <div id="terminalLines">
            <div class="terminal-line terminal-success">INIT OK - 3DMESH ACTIVE</div>
            <div class="terminal-line">> help</div>
        </div>
        <input type="text" id="terminalInput" placeholder="$" autocomplete="off">
    </div>

    <!-- STATUS -->
    <div class="popup" id="statusPopup">
        <div class="help-icon" data-help="status">?</div>
        <div class="popup-close">X</div>
        <div class="popup-title">STATUS</div>
        <div class="popup-item">MODE: <span id="statusMode">MODEL</span></div>
        <div class="popup-item">TOOL: <span id="statusTool">SELECT</span></div>
        <div class="popup-item">OBJECTS: <span id="statusObjs">1</span></div>
        <div class="popup-item">VERTICES: <span id="statusVerts">8</span></div>
        <div class="popup-item">FACES: <span id="statusFaces">6</span></div>
        <div class="popup-item">MEMORY: <span id="statusMem">2.4MB</span></div>
        <div class="popup-item">FPS: <span id="statusFPS">60</span></div>
        <button class="popup-btn" id="exportCode">EXPORT CODE</button>
        <button class="popup-btn" id="exportJSON">EXPORT JSON</button>
    </div>

    <!-- LEVEL EDITOR -->
    <div class="popup" id="levelPopup">
        <div class="help-icon" data-help="level">?</div>
        <div class="popup-close">X</div>
        <div class="popup-title">LEVEL EDITOR</div>
        <div class="popup-item">LEVEL MAPS: <span id="levelMaps">1</span></div>
        <div class="popup-item">WORMHOLES: <span id="wormholes">0</span></div>
        <div class="popup-item">PORTALS: <span id="portals">0</span></div>
        <button class="popup-btn" id="addLevelMap">ADD LEVEL MAP</button>
        <button class="popup-btn" id="addWormhole">ADD WORMHOLE</button>
        <button class="popup-btn" id="addPortal">ADD PORTAL</button>
    </div>

    <!-- CODE GENERATOR -->
    <div class="popup" id="codePopup">
        <div class="help-icon" data-help="code">?</div>
        <div class="popup-close">X</div>
        <div class="popup-title">CODE GENERATOR</div>
        <textarea id="codeOutput" style="width:100%;height:200px;background:#000;color:#0f0;border:1px solid #0f0;font-family:'Courier New';font-size:8px;resize:none;padding:4px" readonly></textarea>
        <button class="popup-btn" id="copyCode">COPY TO CLIPBOARD</button>
    </div>

    <!-- PASTE IMPORT -->
    <div class="popup" id="pasteImportPopup">
        <div class="popup-close">X</div>
        <div class="popup-title">PASTE JSON</div>
        <textarea id="pasteTextarea" style="width:100%;height:200px;background:#000;color:#0f0;border:1px solid #0f0;font-family:'Courier New';font-size:8px;resize:none;padding:4px"></textarea>
        <button class="popup-btn" id="loadPastedJSON">LOAD</button>
    </div>

    <input type="file" id="file-input" accept=".json">
</div>

<script>
    // 3DMESH Application
    let scene, camera, renderer, controls, transformControls;
    let objects = [], selectedObject = null;
    let currentTool = 'select', currentMode = 'model';
    let isDrawing = false, drawPoints = [], currentLine = null;
    let clock = new THREE.Clock();
    let isWireframe = true;
    let ruler3D;
    
    // Initialize the application
    function init() {
        // Show loading screen
        simulateLoading();
        
        // Set up Three.js scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        
        // Set up camera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 5, 5);
        camera.lookAt(0, 0, 0);
        
        // Set up renderer
        renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('visualizationCanvas'),
            antialias: false,
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(1);
        
        // Add lighting
        const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);
        
        // Add grid helper
        const gridHelper = new THREE.GridHelper(20, 20, 0x00ff00, 0x004400);
        scene.add(gridHelper);
        
        // Add axes helper
        const axesHelper = new THREE.AxesHelper(5);
        scene.add(axesHelper);
        
        // Set up orbit controls
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        
        // Set up transform controls
        transformControls = new THREE.TransformControls(camera, renderer.domElement);
        transformControls.addEventListener('dragging-changed', function(event) {
            controls.enabled = !event.value;
        });
        scene.add(transformControls);
        
        // Create 3D ruler
        create3DRuler();
        
        // Create a default cube
        addCube();
        
        // Set up event listeners
        setupEventListeners();
        setupClickHandler();
        
        // Start animation loop
        animate();
        
        // Add initial message
        add("3DMESH INITIALIZED - WIREFRAME MODE ACTIVE", "success");
    }
    
    // Simulate loading screen
    function simulateLoading() {
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
            }
            document.getElementById('loadingProgress').style.width = progress + '%';
        }, 100);
    }
    
    // Create 3D ruler
    function create3DRuler() {
        ruler3D = new THREE.Group();
        
        // Create ruler geometry
        const rulerLength = 20;
        const rulerGeometry = new THREE.BoxGeometry(rulerLength, 0.1, 0.1);
        const rulerMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const rulerMesh = new THREE.Mesh(rulerGeometry, rulerMaterial);
        rulerMesh.position.set(rulerLength/2, 0, 0);
        ruler3D.add(rulerMesh);
        
        // Add ruler marks
        for (let i = 0; i <= rulerLength; i++) {
            const markSize = i % 5 === 0 ? 0.3 : 0.15;
            const markGeometry = new THREE.BoxGeometry(0.02, markSize, 0.02);
            const markMesh = new THREE.Mesh(markGeometry, rulerMaterial);
            markMesh.position.set(i, markSize/2, 0);
            ruler3D.add(markMesh);
            
            // Add numbers at major marks
            if (i % 5 === 0 && i > 0) {
                // In a real implementation, you would use text geometry here
                // For simplicity, we're using a small cube as a placeholder
                const numberGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                const numberMesh = new THREE.Mesh(numberGeometry, rulerMaterial);
                numberMesh.position.set(i, 0.5, 0);
                ruler3D.add(numberMesh);
            }
        }
        
        ruler3D.position.set(-rulerLength/2, 0, 0);
        scene.add(ruler3D);
    }
    
    // Add a cube to the scene
    function addCube() {
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x00ff00, 
            wireframe: true 
        });
        const cube = new THREE.Mesh(geometry, material);
        cube.name = "Cube_" + (objects.length + 1);
        cube.userData = { type: 'cube', originalColor: 0x00ff00 };
        scene.add(cube);
        objects.push(cube);
        selectObject(cube);
        updateStatus();
    }
    
    // Add a sphere to the scene
    function addSphere() {
        const geometry = new THREE.SphereGeometry(0.5, 16, 16);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x00ff00, 
            wireframe: true 
        });
        const sphere = new THREE.Mesh(geometry, material);
        sphere.name = "Sphere_" + (objects.length + 1);
        sphere.userData = { type: 'sphere', originalColor: 0x00ff00 };
        scene.add(sphere);
        objects.push(sphere);
        selectObject(sphere);
        updateStatus();
    }
    
    // Add template objects
    function addTemplate(templateType) {
        let geometry, material, mesh;
        
        switch(templateType) {
            case 'house':
                geometry = new THREE.BoxGeometry(2, 1.5, 2);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "House";
                break;
            case 'tower':
                geometry = new THREE.CylinderGeometry(0.5, 0.3, 3, 8);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Tower";
                break;
            case 'sword':
                const bladeGeometry = new THREE.BoxGeometry(0.1, 2, 0.1);
                const hiltGeometry = new THREE.BoxGeometry(0.3, 0.5, 0.3);
                const blade = new THREE.Mesh(bladeGeometry, new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true }));
                const hilt = new THREE.Mesh(hiltGeometry, new THREE.MeshBasicMaterial({ color: 0x8B4513, wireframe: true }));
                hilt.position.y = -1.25;
                mesh = new THREE.Group();
                mesh.add(blade);
                mesh.add(hilt);
                mesh.name = "Sword";
                break;
            case 'assault_rifle':
                const bodyGeometry = new THREE.BoxGeometry(2, 0.3, 0.5);
                const barrelGeometry = new THREE.CylinderGeometry(0.1, 0.1, 1, 8);
                const body = new THREE.Mesh(bodyGeometry, new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true }));
                const barrel = new THREE.Mesh(barrelGeometry, new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true }));
                barrel.rotation.z = Math.PI / 2;
                barrel.position.x = 1.5;
                mesh = new THREE.Group();
                mesh.add(body);
                mesh.add(barrel);
                mesh.name = "Assault_Rifle";
                break;
            case 'chest':
                geometry = new THREE.BoxGeometry(1, 0.7, 0.8);
                material = new THREE.MeshBasicMaterial({ color: 0x8B4513, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Treasure_Chest";
                break;
            case 'cube':
                geometry = new THREE.BoxGeometry(1, 1, 1);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Cube";
                break;
            case 'sphere':
                geometry = new THREE.SphereGeometry(0.5, 16, 16);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Sphere";
                break;
            case 'cylinder':
                geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 16);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Cylinder";
                break;
            case 'cone':
                geometry = new THREE.ConeGeometry(0.5, 1, 16);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Cone";
                break;
            case 'torus':
                geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 32);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Torus";
                break;
            case 'plane':
                geometry = new THREE.PlaneGeometry(2, 2);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true, side: THREE.DoubleSide });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Plane";
                break;
            case 'pyramid':
                geometry = new THREE.ConeGeometry(1, 1, 4);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Pyramid";
                break;
            case 'octahedron':
                geometry = new THREE.OctahedronGeometry(1);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Octahedron";
                break;
            case 'bodyTube':
                geometry = new THREE.CylinderGeometry(0.183, 0.183, 3.66, 32);
                material = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "BodyTube";
                break;
            case 'noseCone':
                geometry = new THREE.ConeGeometry(0.183, 1.2, 32);
                material = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "NoseCone";
                mesh.position.y = 1.83 + 0.6;
                break;
            case 'fins':
                mesh = new THREE.Group();
                const finGeometry = new THREE.BoxGeometry(0.02, 0.3, 0.5);
                const finMaterial = new THREE.MeshBasicMaterial({ color: 0x666666, wireframe: true });
                for (let i = 0; i < 4; i++) {
                    const fin = new THREE.Mesh(finGeometry, finMaterial);
                    const angle = (i * Math.PI) / 2;
                    fin.position.set(
                        Math.sin(angle) * 0.2,
                        -1.5,
                        Math.cos(angle) * 0.2
                    );
                    fin.rotation.y = angle;
                    mesh.add(fin);
                }
                mesh.name = "Fins";
                break;
            case 'parachute':
                geometry = new THREE.SphereGeometry(0.3, 16, 8);
                material = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Parachute";
                break;
            case 'payload':
                geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Payload";
                break;
            case 'engine':
                geometry = new THREE.CylinderGeometry(0.15, 0.15 * 0.8, 0.4, 32);
                material = new THREE.MeshBasicMaterial({ color: 0x333333, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Engine";
                mesh.position.y = -1.83 - 0.2;
                break;
            case 'arduino':
            case 'raspberry':
            case 'battery':
            case 'radio':
            case 'gps':
            case 'imu':
            case 'thermometer':
            case 'altimeter':
            case 'barometer':
            case 'camera':
            case 'accelerometer':
                geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                material = new THREE.MeshBasicMaterial({ color: 0xffff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = templateType.charAt(0).toUpperCase() + templateType.slice(1);
                break;
            case 'booster':
            case 'fuelTank':
            case 'oxidizer':
            case 'turbopump':
            case 'nozzle':
                geometry = new THREE.CylinderGeometry(0.15, 0.15, 0.5, 32);
                material = new THREE.MeshBasicMaterial({ color: 0x888888, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = templateType.charAt(0).toUpperCase() + templateType.slice(1);
                break;
            default:
                // Default to cube if template not found
                geometry = new THREE.BoxGeometry(1, 1, 1);
                material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
                mesh = new THREE.Mesh(geometry, material);
                mesh.name = "Template_" + templateType;
        }
        
        mesh.userData = { type: templateType, originalColor: 0x00ff00 };
        scene.add(mesh);
        objects.push(mesh);
        selectObject(mesh);
        updateStatus();
        add(`Added template: ${templateType}`, "success");
    }
    
    // Select an object
    function selectObject(object) {
        if (selectedObject) {
            selectedObject.material.color.setHex(selectedObject.userData.originalColor);
        }
        
        selectedObject = object;
        if (selectedObject) {
            selectedObject.userData.originalColor = selectedObject.material.color.getHex();
            selectedObject.material.color.setHex(0x00ffff); // Highlight color
            
            // Attach transform controls
            transformControls.attach(selectedObject);
            
            // Update properties panel
            updatePropertiesPanel();
        } else {
            transformControls.detach();
        }
    }
    
    // Update properties panel with selected object's properties
    function updatePropertiesPanel() {
        if (selectedObject) {
            document.getElementById('objectName').value = selectedObject.name;
            document.getElementById('posX').value = selectedObject.position.x.toFixed(2);
            document.getElementById('posY').value = selectedObject.position.y.toFixed(2);
            document.getElementById('posZ').value = selectedObject.position.z.toFixed(2);
            document.getElementById('rotX').value = (selectedObject.rotation.x * (180 / Math.PI)).toFixed(2);
            document.getElementById('rotY').value = (selectedObject.rotation.y * (180 / Math.PI)).toFixed(2);
            document.getElementById('rotZ').value = (selectedObject.rotation.z * (180 / Math.PI)).toFixed(2);
            document.getElementById('scaleX').value = selectedObject.scale.x.toFixed(2);
            document.getElementById('scaleY').value = selectedObject.scale.y.toFixed(2);
            document.getElementById('scaleZ').value = selectedObject.scale.z.toFixed(2);
            document.getElementById('objectColor').value = '#' + selectedObject.userData.originalColor.toString(16).padStart(6, '0');
        }
    }
    
    // Update properties from panel
    function updatePropertiesFromPanel() {
        if (selectedObject) {
            selectedObject.name = document.getElementById('objectName').value;
            selectedObject.position.set(
                parseFloat(document.getElementById('posX').value) || 0,
                parseFloat(document.getElementById('posY').value) || 0,
                parseFloat(document.getElementById('posZ').value) || 0
            );
            selectedObject.rotation.set(
                (parseFloat(document.getElementById('rotX').value) || 0) * (Math.PI / 180),
                (parseFloat(document.getElementById('rotY').value) || 0) * (Math.PI / 180),
                (parseFloat(document.getElementById('rotZ').value) || 0) * (Math.PI / 180)
            );
            selectedObject.scale.set(
                parseFloat(document.getElementById('scaleX').value) || 1,
                parseFloat(document.getElementById('scaleY').value) || 1,
                parseFloat(document.getElementById('scaleZ').value) || 1
            );
            
            const color = document.getElementById('objectColor').value;
            selectedObject.userData.originalColor = parseInt(color.replace('#', ''), 16);
            selectedObject.material.color.setHex(0x00ffff); // Keep highlight color
            
            add(`Updated properties for ${selectedObject.name}`, "success");
        }
    }
    
    // Delete selected object
    function deleteSelectedObject() {
        if (selectedObject) {
            const name = selectedObject.name;
            scene.remove(selectedObject);
            objects = objects.filter(obj => obj !== selectedObject);
            selectedObject = null;
            transformControls.detach();
            updateStatus();
            add(`Deleted ${name}`, "warning");
        }
    }
    
    // Set current tool
    function setTool(tool) {
        currentTool = tool;
        
        // Update UI
        document.querySelectorAll('.ctrl-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(tool + 'Btn').classList.add('active');
        document.getElementById('statusTool').textContent = tool.toUpperCase();
        
        // Set transform controls mode
        switch(tool) {
            case 'select':
                transformControls.setMode('translate');
                break;
            case 'move':
                transformControls.setMode('translate');
                break;
            case 'rotate':
                transformControls.setMode('rotate');
                break;
            case 'scale':
                transformControls.setMode('scale');
                break;
        }
        
        add(`Tool set to: ${tool}`, "success");
    }
    
    // Set current mode
    function setMode(mode) {
        currentMode = mode;
        
        // Update UI
        document.querySelectorAll('.mode-controls .ctrl-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(mode + 'Btn').classList.add('active');
        document.getElementById('statusMode').textContent = mode.toUpperCase();
        
        add(`Mode set to: ${mode}`, "success");
    }
    
    // Toggle wireframe mode
    function toggleWireframe() {
        isWireframe = !isWireframe;
        document.getElementById('wireframeBtn').classList.toggle('active');
        
        scene.traverse(function(object) {
            if (object.isMesh && object.material) {
                object.material.wireframe = isWireframe;
            }
        });
        
        add(isWireframe ? "Wireframe mode ON" : "Wireframe mode OFF", "success");
    }
    
    // Toggle templates panel
    function toggleTemplates() {
        const panel = document.getElementById('templatesPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
    
    // Handle template category change
    function handleTemplateCategoryChange() {
        const category = document.getElementById('templateCategory').value;
        document.querySelectorAll('.template-category').forEach(cat => {
            cat.style.display = 'none';
        });
        document.getElementById(category + 'Category').style.display = 'block';
    }
    
    // Start drawing mode
    function startDrawing() {
        isDrawing = true;
        drawPoints = [];
        document.getElementById('drawBtn').classList.add('active');
        add("Drawing mode activated - Click to add points", "prompt");
    }
    
    // Stop drawing mode
    function stopDrawing() {
        isDrawing = false;
        document.getElementById('drawBtn').classList.remove('active');
        
        if (drawPoints.length > 1) {
            // Create a line from the drawn points
            const geometry = new THREE.BufferGeometry().setFromPoints(drawPoints);
            const material = new THREE.LineBasicMaterial({ color: 0x00ff00 });
            const line = new THREE.Line(geometry, material);
            line.name = "Line_" + (objects.length + 1);
            line.userData = { type: 'line', originalColor: 0x00ff00 };
            scene.add(line);
            objects.push(line);
            selectObject(line);
            updateStatus();
            add(`Created line with ${drawPoints.length} points`, "success");
        }
        
        drawPoints = [];
        currentLine = null;
    }
    
    // Export scene as Three.js code
    function exportCode() {
        let code = "// 3DMESH Generated Three.js Code\n";
        code += "// Generated by 3DMESH by webXOS 2025\n\n";
        
        code += "// Scene setup\n";
        code += "const scene = new THREE.Scene();\n";
        code += "scene.background = new THREE.Color(0x000000);\n\n";
        
        code += "// Objects\n";
        objects.forEach((obj, index) => {
            const color = '0x' + obj.userData.originalColor.toString(16).padStart(6, '0');
            
            if (obj.userData.type === 'cube') {
                code += `// Cube ${index + 1}\n`;
                code += `const geometry${index} = new THREE.BoxGeometry(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const cube${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `cube${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `cube${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `scene.add(cube${index});\n\n`;
            } else if (obj.userData.type === 'sphere') {
                code += `// Sphere ${index + 1}\n`;
                code += `const geometry${index} = new THREE.SphereGeometry(0.5, 16, 16);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const sphere${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `sphere${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `sphere${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `sphere${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(sphere${index});\n\n`;
            } else if (obj.userData.type === 'line') {
                code += `// Line ${index + 1}\n`;
                code += `const points${index} = [\n`;
                obj.geometry.attributes.position.array.forEach((coord, i) => {
                    if (i % 3 === 0) {
                        code += `  new THREE.Vector3(${coord}, `;
                    } else if (i % 3 === 1) {
                        code += `${coord}, `;
                    } else {
                        code += `${coord}),\n`;
                    }
                });
                code += `];\n`;
                code += `const geometry${index} = new THREE.BufferGeometry().setFromPoints(points${index});\n`;
                code += `const material${index} = new THREE.LineBasicMaterial({ color: ${color} });\n`;
                code += `const line${index} = new THREE.Line(geometry${index}, material${index});\n`;
                code += `scene.add(line${index});\n\n`;
            } else if (obj.userData.type === 'cylinder') {
                code += `// Cylinder ${index + 1}\n`;
                code += `const geometry${index} = new THREE.CylinderGeometry(0.5, 0.5, 1, 16);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const cylinder${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `cylinder${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `cylinder${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `cylinder${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(cylinder${index});\n\n`;
            } else if (obj.userData.type === 'cone') {
                code += `// Cone ${index + 1}\n`;
                code += `const geometry${index} = new THREE.ConeGeometry(0.5, 1, 16);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const cone${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `cone${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `cone${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `cone${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(cone${index});\n\n`;
            } else if (obj.userData.type === 'torus') {
                code += `// Torus ${index + 1}\n`;
                code += `const geometry${index} = new THREE.TorusGeometry(0.5, 0.2, 16, 32);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const torus${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `torus${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `torus${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `torus${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(torus${index});\n\n`;
            } else if (obj.userData.type === 'plane') {
                code += `// Plane ${index + 1}\n`;
                code += `const geometry${index} = new THREE.PlaneGeometry(2, 2);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true, side: THREE.DoubleSide });\n`;
                code += `const plane${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `plane${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `plane${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `plane${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(plane${index});\n\n`;
            } else if (obj.userData.type === 'bodyTube') {
                code += `// BodyTube ${index + 1}\n`;
                code += `const geometry${index} = new THREE.CylinderGeometry(0.183, 0.183, 3.66, 32);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const bodyTube${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `bodyTube${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `bodyTube${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `bodyTube${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(bodyTube${index});\n\n`;
            } else if (obj.userData.type === 'noseCone') {
                code += `// NoseCone ${index + 1}\n`;
                code += `const geometry${index} = new THREE.ConeGeometry(0.183, 1.2, 32);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const noseCone${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `noseCone${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `noseCone${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `noseCone${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(noseCone${index});\n\n`;
            } else if (obj.userData.type === 'fins') {
                code += `// Fins ${index + 1}\n`;
                code += `const fins${index} = new THREE.Group();\n`;
                code += `const finGeometry = new THREE.BoxGeometry(0.02, 0.3, 0.5);\n`;
                code += `const finMaterial = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `for (let i = 0; i < 4; i++) {\n`;
                code += `    const fin = new THREE.Mesh(finGeometry, finMaterial);\n`;
                code += `    const angle = (i * Math.PI) / 2;\n`;
                code += `    fin.position.set(Math.sin(angle) * 0.2, -1.5, Math.cos(angle) * 0.2);\n`;
                code += `    fin.rotation.y = angle;\n`;
                code += `    fins${index}.add(fin);\n`;
                code += `}\n`;
                code += `fins${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `fins${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `fins${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(fins${index});\n\n`;
            } else if (obj.userData.type === 'parachute') {
                code += `// Parachute ${index + 1}\n`;
                code += `const geometry${index} = new THREE.SphereGeometry(0.3, 16, 8);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const parachute${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `parachute${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `parachute${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `parachute${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(parachute${index});\n\n`;
            } else if (obj.userData.type === 'payload') {
                code += `// Payload ${index + 1}\n`;
                code += `const geometry${index} = new THREE.BoxGeometry(0.3, 0.3, 0.3);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const payload${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `payload${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `payload${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `payload${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(payload${index});\n\n`;
            } else if (obj.userData.type === 'engine') {
                code += `// Engine ${index + 1}\n`;
                code += `const geometry${index} = new THREE.CylinderGeometry(0.15, 0.15 * 0.8, 0.4, 32);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const engine${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `engine${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `engine${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `engine${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(engine${index});\n\n`;
            } else if (['arduino', 'raspberry', 'battery', 'radio', 'gps', 'imu', 'thermometer', 'altimeter', 'barometer', 'camera', 'accelerometer'].includes(obj.userData.type)) {
                code += `// ${obj.userData.type} ${index + 1}\n`;
                code += `const geometry${index} = new THREE.BoxGeometry(0.1, 0.1, 0.1);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const part${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `part${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `part${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `part${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(part${index});\n\n`;
            } else if (['booster', 'fuelTank', 'oxidizer', 'turbopump', 'nozzle'].includes(obj.userData.type)) {
                code += `// ${obj.userData.type} ${index + 1}\n`;
                code += `const geometry${index} = new THREE.CylinderGeometry(0.15, 0.15, 0.5, 32);\n`;
                code += `const material${index} = new THREE.MeshBasicMaterial({ color: ${color}, wireframe: true });\n`;
                code += `const part${index} = new THREE.Mesh(geometry${index}, material${index});\n`;
                code += `part${index}.position.set(${obj.position.x}, ${obj.position.y}, ${obj.position.z});\n`;
                code += `part${index}.rotation.set(${obj.rotation.x}, ${obj.rotation.y}, ${obj.rotation.z});\n`;
                code += `part${index}.scale.set(${obj.scale.x}, ${obj.scale.y}, ${obj.scale.z});\n`;
                code += `scene.add(part${index});\n\n`;
            }
            // Add more object types as needed
        });
        
        // Display code in popup
        document.getElementById('codeOutput').value = code;
        openPopup('codePopup');
        add("Generated Three.js code", "success");
    }
    
    // Copy code to clipboard
    function copyCodeToClipboard() {
        const codeTextarea = document.getElementById('codeOutput');
        codeTextarea.select();
        document.execCommand('copy');
        add("Code copied to clipboard", "success");
    }
    
    // Export scene as JSON
    function exportJSON() {
        const sceneData = {
            metadata: {
                version: 1.0,
                generator: "3DMESH by webXOS 2025"
            },
            objects: objects.map(obj => ({
                name: obj.name,
                type: obj.userData.type,
                position: { x: obj.position.x, y: obj.position.y, z: obj.position.z },
                rotation: { x: obj.rotation.x, y: obj.rotation.y, z: obj.rotation.z },
                scale: { x: obj.scale.x, y: obj.scale.y, z: obj.scale.z },
                color: obj.userData.originalColor
            }))
        };
        
        const dataStr = JSON.stringify(sceneData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = '3dmesh_scene.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        add("Exported scene as JSON", "success");
    }
    
    // Import scene from JSON
    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            loadJSONData(e.target.result);
        };
        reader.readAsText(file);
    }

    // Load pasted JSON
    function loadPastedJSON() {
        const jsonText = document.getElementById('pasteTextarea').value;
        loadJSONData(jsonText);
        document.getElementById('pasteImportPopup').style.display = 'none';
    }

    // Common function to load JSON data
    function loadJSONData(jsonText) {
        try {
            const sceneData = JSON.parse(jsonText);
            
            // Clear current scene
            objects.forEach(obj => scene.remove(obj));
            objects = [];
            
            // Import objects
            sceneData.objects.forEach(objData => {
                let geometry, material, mesh;
                
                switch(objData.type) {
                    case 'cube':
                        geometry = new THREE.BoxGeometry(1, 1, 1);
                        break;
                    case 'sphere':
                        geometry = new THREE.SphereGeometry(0.5, 16, 16);
                        break;
                    case 'cylinder':
                        geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 16);
                        break;
                    case 'cone':
                        geometry = new THREE.ConeGeometry(0.5, 1, 16);
                        break;
                    case 'torus':
                        geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 32);
                        break;
                    case 'plane':
                        geometry = new THREE.PlaneGeometry(2, 2);
                        break;
                    case 'bodyTube':
                        geometry = new THREE.CylinderGeometry(0.183, 0.183, 3.66, 32);
                        break;
                    case 'noseCone':
                        geometry = new THREE.ConeGeometry(0.183, 1.2, 32);
                        break;
                    case 'fins':
                        mesh = new THREE.Group();
                        const finGeometry = new THREE.BoxGeometry(0.02, 0.3, 0.5);
                        const finMaterial = new THREE.MeshBasicMaterial({ color: objData.color, wireframe: isWireframe });
                        for (let i = 0; i < 4; i++) {
                            const fin = new THREE.Mesh(finGeometry, finMaterial);
                            const angle = (i * Math.PI) / 2;
                            fin.position.set(
                                Math.sin(angle) * 0.2,
                                -1.5,
                                Math.cos(angle) * 0.2
                            );
                            fin.rotation.y = angle;
                            mesh.add(fin);
                        }
                        break;
                    case 'parachute':
                        geometry = new THREE.SphereGeometry(0.3, 16, 8);
                        break;
                    case 'payload':
                        geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
                        break;
                    case 'engine':
                        geometry = new THREE.CylinderGeometry(0.15, 0.15 * 0.8, 0.4, 32);
                        break;
                    case 'arduino':
                    case 'raspberry':
                    case 'battery':
                    case 'radio':
                    case 'gps':
                    case 'imu':
                    case 'thermometer':
                    case 'altimeter':
                    case 'barometer':
                    case 'camera':
                    case 'accelerometer':
                        geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
                        break;
                    case 'booster':
                    case 'fuelTank':
                    case 'oxidizer':
                    case 'turbopump':
                    case 'nozzle':
                        geometry = new THREE.CylinderGeometry(0.15, 0.15, 0.5, 32);
                        break;
                    default:
                        geometry = new THREE.BoxGeometry(1, 1, 1);
                }
                
                if (!mesh) {
                    material = new THREE.MeshBasicMaterial({ 
                        color: objData.color, 
                        wireframe: isWireframe 
                    });
                    
                    mesh = new THREE.Mesh(geometry, material);
                }
                mesh.name = objData.name;
                mesh.position.set(objData.position.x, objData.position.y, objData.position.z);
                mesh.rotation.set(objData.rotation.x, objData.rotation.y, objData.rotation.z);
                mesh.scale.set(objData.scale.x, objData.scale.y, objData.scale.z);
                mesh.userData = { 
                    type: objData.type, 
                    originalColor: objData.color 
                };
                
                scene.add(mesh);
                objects.push(mesh);
            });
            
            updateStatus();
            add(`Imported ${objects.length} objects from JSON`, "success");
        } catch (error) {
            add("Error importing JSON: " + error.message, "error");
        }
    }
    
    // Update status panel
    function updateStatus() {
        let vertices = 0;
        let faces = 0;
        
        objects.forEach(obj => {
            if (obj.geometry && obj.geometry.attributes && obj.geometry.attributes.position) {
                vertices += obj.geometry.attributes.position.count;
                
                if (obj.geometry.index) {
                    faces += obj.geometry.index.count / 3;
                } else if (obj.geometry.attributes.position) {
                    // Estimate faces for non-indexed geometries
                    faces += obj.geometry.attributes.position.count / 3;
                }
            }
        });
        
        document.getElementById('statusObjs').textContent = objects.length;
        document.getElementById('statusVerts').textContent = vertices;
        document.getElementById('statusFaces').textContent = faces;
        
        // Simulate memory usage
        const memory = (vertices * 4 * 3 + faces * 3 * 4) / (1024 * 1024); // Rough estimate in MB
        document.getElementById('statusMem').textContent = memory.toFixed(1) + 'MB';
    }
    
    // Set up event listeners
    function setupEventListeners() {
        // Button click handlers
        document.getElementById('guideBtn').addEventListener('click', () => openPopup('guidePopup'));
        document.getElementById('termBtn').addEventListener('click', () => openPopup('terminalPopup'));
        document.getElementById('statusBtn').addEventListener('click', () => openPopup('statusPopup'));
        document.getElementById('templatesBtn').addEventListener('click', toggleTemplates);
        document.getElementById('modelBtn').addEventListener('click', () => setMode('model'));
        document.getElementById('levelBtn').addEventListener('click', () => openPopup('levelPopup'));
        document.getElementById('codeBtn').addEventListener('click', () => setMode('code'));
        
        // Tool buttons
        document.getElementById('selectBtn').addEventListener('click', () => setTool('select'));
        document.getElementById('moveBtn').addEventListener('click', () => setTool('move'));
        document.getElementById('rotateBtn').addEventListener('click', () => setTool('rotate'));
        document.getElementById('scaleBtn').addEventListener('click', () => setTool('scale'));
        document.getElementById('drawBtn').addEventListener('click', startDrawing);
        document.getElementById('extrudeBtn').addEventListener('click', () => add("Extrude tool - Not implemented yet", "warning"));
        document.getElementById('booleanBtn').addEventListener('click', () => add("Boolean tool - Not implemented yet", "warning"));
        document.getElementById('exportBtn').addEventListener('click', exportCode);
        document.getElementById('importBtn').addEventListener('click', () => document.getElementById('file-input').click());
        
        // Template handlers
        document.getElementById('templateCategory').addEventListener('change', handleTemplateCategoryChange);
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', () => {
                const template = item.dataset.template;
                if (template === 'import_file') {
                    document.getElementById('file-input').click();
                } else if (template === 'import_paste') {
                    openPopup('pasteImportPopup');
                } else if (template === 'export_json') {
                    exportJSON();
                } else {
                    addTemplate(template);
                }
            });
        });
        
        // Property panel buttons
        document.getElementById('updateProps').addEventListener('click', updatePropertiesFromPanel);
        document.getElementById('deleteObj').addEventListener('click', deleteSelectedObject);
        
        // Other controls
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
        document.getElementById('wireframeBtn').addEventListener('click', toggleWireframe);
        
        // Popup buttons
        document.getElementById('exportCode').addEventListener('click', exportCode);
        document.getElementById('exportJSON').addEventListener('click', exportJSON);
        document.getElementById('copyCode').addEventListener('click', copyCodeToClipboard);
        document.getElementById('loadPastedJSON').addEventListener('click', loadPastedJSON);
        
        // File input
        document.getElementById('file-input').addEventListener('change', importJSON);
        
        // Popup close buttons
        document.querySelectorAll('.popup-close').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.popup').style.display = 'none';
            });
        });
        
        // Help icons
        document.querySelectorAll('.help-icon').forEach(icon => {
            icon.addEventListener('click', (e) => {
                const helpText = {
                    guide: "3DMESH is a wireframe 3D modeling tool. Use shape buttons to add objects, tools to manipulate them, and export to generate Three.js code.",
                    terminal: "Type commands like 'help', 'clear', or 'export' to control the application.",
                    status: "Shows current scene statistics and export options.",
                    level: "Create level maps, wormholes, and portals for game development.",
                    code: "View and copy generated Three.js code for your scene."
                };
                alert(`Help: ${helpText[e.target.dataset.help] || 'No help available.'}`);
            });
        });
        
        // Terminal input
        document.getElementById('terminalInput').addEventListener('keydown', termIn);
        
        // Window resize
        window.addEventListener('resize', onWindowResize);
    }
    
    // Set up click handler for object selection
    function setupClickHandler() {
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        function onMouseClick(event) {
            if (isDrawing) {
                // Handle drawing mode
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
                const point = new THREE.Vector3();
                raycaster.ray.intersectPlane(plane, point);
                
                drawPoints.push(point.clone());
                
                if (drawPoints.length > 1) {
                    if (!currentLine) {
                        const geometry = new THREE.BufferGeometry().setFromPoints(drawPoints);
                        const material = new THREE.LineBasicMaterial({ color: 0x00ff00 });
                        currentLine = new THREE.Line(geometry, material);
                        scene.add(currentLine);
                    } else {
                        currentLine.geometry.setFromPoints(drawPoints);
                    }
                }
                
                return;
            }
            
            // Handle object selection
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects);
            
            if (intersects.length > 0) {
                selectObject(intersects[0].object);
            } else {
                selectObject(null);
            }
        }
        
        renderer.domElement.addEventListener('click', onMouseClick);
        renderer.domElement.addEventListener('contextmenu', (event) => {
            event.preventDefault();
            if (isDrawing) {
                stopDrawing();
            }
        });
    }
    
    // Terminal input handler
    function termIn(e) {
        if(e.key === 'Enter'){
            const input = document.getElementById('terminalInput');
            const cmd = input.value.trim();
            if(cmd){
                add(`$ ${cmd}`, 'prompt');
                processCommand(cmd);
                input.value = '';
            }
        }
    }
    
    // Process terminal commands
    function processCommand(cmd) {
        const parts = cmd.toLowerCase().split(' ');
        const command = parts[0];
        
        switch(command) {
            case 'help':
                add("Available commands: help, clear, export, import, wireframe, add [cube|sphere|cylinder|cone|torus|plane], select, move, rotate, scale", "prompt");
                break;
            case 'clear':
                document.getElementById('terminalLines').innerHTML = '';
                add("Terminal cleared", "success");
                break;
            case 'export':
                exportCode();
                break;
            case 'import':
                document.getElementById('file-input').click();
                break;
            case 'wireframe':
                toggleWireframe();
                break;
            case 'add':
                if (parts.length > 1) {
                    const shape = parts[1];
                    switch(shape) {
                        case 'cube': addCube(); break;
                        case 'sphere': addSphere(); break;
                        case 'cylinder': addTemplate('cylinder'); break;
                        case 'cone': addTemplate('cone'); break;
                        case 'torus': addTemplate('torus'); break;
                        case 'plane': addTemplate('plane'); break;
                        default: add(`Unknown shape: ${shape}`, "error");
                    }
                } else {
                    add("Usage: add [cube|sphere|cylinder|cone|torus|plane]", "error");
                }
                break;
            case 'select': setTool('select'); break;
            case 'move': setTool('move'); break;
            case 'rotate': setTool('rotate'); break;
            case 'scale': setTool('scale'); break;
            default:
                add(`Unknown command: ${command}`, "error");
        }
    }
    
    // Add message to terminal
    function add(msg, type="info"){
        const lines = document.getElementById('terminalLines');
        const line = document.createElement('div');
        line.className = `terminal-line terminal-${type}`;
        line.textContent = `> ${msg}`;
        lines.appendChild(line);
        lines.scrollTop = lines.scrollHeight;
    }
    
    // Open popup
    function openPopup(id){
        document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
        const popup = document.getElementById(id);
        if(popup) popup.style.display = 'block';
    }
    
    // Toggle fullscreen
    function toggleFullscreen(){
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                add(`Fullscreen failed: ${err.message}`, "error");
            });
            add("FULLSCREEN ON","success");
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
                add("FULLSCREEN OFF","success");
            }
        }
    }
    
    // Handle window resize
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    // Animation loop
    function animate() {
        requestAnimationFrame(animate);
        
        controls.update();
        
        // Update FPS counter occasionally
        if (Math.random() < 0.05) {
            document.getElementById('statusFPS').textContent = Math.floor(60 + Math.random() * 10);
        }
        
        renderer.render(scene, camera);
    }
    
    // Initialize the application when the page loads
    window.addEventListener('load', init);
</script>
</body>
</html>
