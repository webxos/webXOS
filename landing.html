<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f0">
    <meta name="description" content="Vial MCP Gateway - Manage and troubleshoot your system">
    <meta name="keywords" content="Vial MCP, system management, troubleshooting, authentication, dashboard">
    <meta name="author" content="WebXOS">
    <meta name="robots" content="index, follow">
    <meta name="application-name" content="Vial MCP Gateway">
    <meta property="og:title" content="Vial MCP Gateway: System Management">
    <meta property="og:description" content="Access and manage your system with Vial MCP Gateway. Troubleshoot, authenticate, and unlock the dashboard.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://vial-mcp.webxos.com">
    <meta property="og:image" content="https://vial-mcp.webxos.com/icon.png">
    <meta property="og:site_name" content="Vial MCP Gateway">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Vial MCP Gateway: System Management">
    <meta name="twitter:description" content="Troubleshoot and authenticate with Vial MCP Gateway. Unlock the dashboard for full control.">
    <meta name="twitter:image" content="https://vial-mcp.webxos.com/icon.png">
    <meta name="twitter:site" content="@WebXOS">
    <title>Vial MCP Gateway</title>
    <link rel="icon" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: monospace, sans-serif; }
        html, body { height: 100vh; overflow: hidden; background: #000; color: #0f0; display: flex; flex-direction: column; align-items: center; transition: background 0.3s, box-shadow 0.3s; }
        body.glow { background: rgba(255, 0, 0, 0.1); box-shadow: 0 0 20px #ff0000; }
        h1 { font-size: 1.6rem; text-align: center; margin: 0.8rem 0; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 5px #0f0; }
        #console { width: 90%; max-width: 900px; background: rgba(0, 255, 0, 0.1); border: 1px solid #0f0; padding: 0.6rem; flex: 1; max-height: calc(100vh - 240px); overflow-y: auto; margin: 0.5rem 0; border-radius: 5px; font-size: 0.8rem; }
        #console.active-byte { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        #console p { margin: 0.2rem 0; }
        #console .command { font-family: 'Orbitron', monospace; font-weight: 700; text-shadow: 0 0 3px #0f0; }
        #console .error { color: #ff0000; text-shadow: 0 0 2px #ff0000; }
        .button-group { display: flex; gap: 0.5rem; margin: 0.5rem 0; padding: 0.5rem; flex-wrap: wrap; justify-content: center; width: 90%; max-width: 900px; }
        button { background: #0f0; color: #000; border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; cursor: pointer; border-radius: 3px; min-width: 90px; text-align: center; transition: background 0.3s; }
        button:hover, button:focus { background: #0c0; outline: 2px solid #0f0; }
        button.active-byte { background: #ff0000; box-shadow: 0 0 10px #ff0000; }
        button:disabled { background: #666; cursor: not-allowed; }
        #error { color: #ff0000; text-shadow: 0 0 2px #ff0000; margin: 0.5rem 0; font-size: 0.8rem; width: 90%; max-width: 900px; text-align: center; }
        #next-steps { color: #0f0; margin: 0.5rem 0; font-size: 0.8rem; width: 90%; max-width: 900px; text-align: center; background: rgba(0, 255, 0, 0.1); padding: 0.5rem; border-radius: 3px; }
        footer { width: 100%; padding: 0.4rem; font-size: 9pt; text-align: center; color: #0f0; background: rgba(0, 0, 0, 0.8); line-height: 1.2; }
        @media (max-width: 600px) { h1 { font-size: 1.1rem; margin: 0.5rem 0; } #console { font-size: 0.75rem; padding: 0.5rem; max-height: calc(100vh - 220px); } button { padding: 0.5rem 1rem; font-size: 0.85rem; min-width: 80px; } footer { padding: 0.3rem; } }
        @media (max-width: 400px) { .button-group { flex-direction: column; align-items: center; } button { width: 100%; max-width: 160px; } #console { max-height: calc(100vh - 200px); } }
    </style>
</head>
<body>
    <h1 role="heading" aria-level="1">VIAL MCP GATEWAY</h1>
    <div id="console" role="log" aria-live="polite">
        <p>Vial MCP User Guide: Troubleshoot: Run troubleshoot | OAuth: Authenticate | Dashboard: Access after authentication</p>
    </div>
    <div id="error"></div>
    <div id="next-steps"></div>
    <div class="button-group">
        <button id="troubleshoot-btn" aria-label="Run troubleshoot">Troubleshoot</button>
        <button id="oauth-btn" aria-label="Authenticate">OAuth</button>
        <button id="dashboard-btn" aria-label="Access dashboard" disabled>Dashboard</button>
    </div>
    <footer>
        Â© 2025 WebXOS - Vial MCP Gateway<br>
        Troubleshoot: Run troubleshoot | OAuth: Authenticate | Dashboard: Access after authentication
    </footer>

    <script>
        const consoleDiv = document.getElementById('console');
        const errorDiv = document.getElementById('error');
        const nextStepsDiv = document.getElementById('next-steps');
        let logQueue = [];
        let isAuthenticated = false;
        const maxRetries = 3;
        const SERVER_URL = 'https://webxos.netlify.app/api';

        function log(message, isCommand = false, isError = false) {
            const formattedMessage = isCommand ? `<span class="command">${message}</span>` : isError ? `<span class="error">${message}</span>` : message;
            logQueue.push(`[${new Date().toLocaleTimeString()}] ${formattedMessage}`);
            if (logQueue.length > 50) logQueue.shift();
            consoleDiv.innerHTML = logQueue.map(msg => `<p>${msg}</p>`).join('');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        async function fetchWithRetry(url, options = {}, retries = maxRetries) {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        method: options.method || 'POST',
                        headers: { 'Content-Type': 'application/json', ...options.headers }
                    });
                    if (!response.ok) {
                        const text = await response.text();
                        if (response.status === 404 && text.includes('<!DOCTYPE html>')) {
                            log(`404 Error: Attempt ${attempt}/${retries} - Redirecting to /api/404`, true);
                            const fallback = await fetch(`${SERVER_URL}/404`, { method: 'GET' });
                            return fallback.ok ? await fallback.json() : { error: '404 handled, but fallback failed' };
                        }
                        throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                    }
                    return await response.json();
                } catch (err) {
                    if (attempt === retries) {
                        errorDiv.textContent = err.message;
                        return { error: err.message };
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        async function troubleshoot() {
            log('Running troubleshoot...', true);
            const btn = document.getElementById('troubleshoot-btn');
            btn.disabled = true;
            try {
                const response = await fetchWithRetry(`${SERVER_URL}/troubleshoot`);
                if (response.error) log(`Troubleshoot Error: ${response.error}`, false, true);
                else log(`Troubleshoot Report: ${JSON.stringify(response)}`);
            } catch (err) {
                log(`Troubleshoot Error: ${err.message}`, false, true);
            }
            btn.disabled = false;
        }

        async function oauthAuthenticate() {
            log('Running authentication...', true);
            const btn = document.getElementById('oauth-btn');
            btn.disabled = true;
            try {
                const response = await fetchWithRetry(`${SERVER_URL}/auth/oauth`, {
                    method: 'POST',
                    body: JSON.stringify({ provider: 'mock', code: 'test_code' })
                });
                if (response.error) log(`Authentication Error: ${response.error}`, false, true);
                else {
                    localStorage.setItem('access_token', response.access_token);
                    log('Authentication successful.');
                    isAuthenticated = true;
                    document.getElementById('dashboard-btn').disabled = false;
                }
            } catch (err) {
                log(`Authentication Error: ${err.message}`, false, true);
            }
            btn.disabled = false;
        }

        function navigateDashboard() {
            if (isAuthenticated) {
                log('Navigating to dashboard...', true);
                window.location.href = '/app/dashboard';
            } else {
                log('Error: Authentication required.', false, true);
            }
        }

        document.getElementById('troubleshoot-btn').addEventListener('click', troubleshoot);
        document.getElementById('oauth-btn').addEventListener('click', oauthAuthenticate);
        document.getElementById('dashboard-btn').addEventListener('click', navigateDashboard);

        async function checkHealth() {
            try {
                const response = await fetchWithRetry(`${SERVER_URL}/health`);
                if (response.status === 'healthy') log('System healthy', true);
                else log('System unhealthy', true, true);
            } catch (err) {
                log(`Health Check Error: ${err.message}`, true, true);
            }
        }
        checkHealth();
    </script>
</body>
</html>
