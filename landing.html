<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f0">
    <meta name="description" content="Vial MCP Gateway for system management and authentication">
    <meta name="keywords" content="system management, authentication, troubleshooting, dashboard, oauth, netlify functions">
    <meta name="author" content="WebXOS">
    <meta name="robots" content="index, follow">
    <meta name="application-name" content="Vial MCP Gateway">
    <meta property="og:title" content="Vial MCP Gateway: System Management">
    <meta property="og:description" content="Manage systems with Vial MCP Gateway. Authenticate via OAuth, troubleshoot, and access the dashboard.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://webxos.netlify.app">
    <meta property="og:image" content="https://webxos.netlify.app/icon.png">
    <meta property="og:site_name" content="Vial MCP Gateway">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Vial MCP Gateway: System Management">
    <meta name="twitter:description" content="Authenticate, troubleshoot, and manage systems with Vial MCP Gateway.">
    <meta name="twitter:image" content="https://webxos.netlify.app/icon.png">
    <meta name="twitter:site" content="@WebXOS">
    <title>Vial MCP Gateway</title>
    <link rel="icon" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: monospace, sans-serif;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
            background: #000;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.3s, box-shadow 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        body.glow {
            background: rgba(255, 0, 0, 0.1);
            box-shadow: 0 0 20px #ff0000, 0 0 40px #ff0000 inset;
        }

        h1 {
            font-size: 1.6rem;
            text-align: center;
            margin: 0.8rem 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px #0f0;
        }

        #console {
            width: 90%;
            max-width: 900px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #0f0;
            padding: 0.6rem;
            flex: 1;
            max-height: calc(100vh - 240px);
            overflow-y: auto;
            margin: 0.5rem 0;
            border-radius: 5px;
            font-size: 0.8rem;
            -webkit-overflow-scrolling: touch;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #console.active-byte {
            border-color: #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }

        #console p {
            margin: 0.2rem 0;
        }

        #console .command {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-shadow: 0 0 3px #0f0;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin: 0.5rem 0;
            padding: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            width: 90%;
            max-width: 900px;
        }

        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 3px;
            min-width: 90px;
            text-align: center;
            touch-action: manipulation;
            transition: background 0.3s, box-shadow 0.3s;
        }

        button:hover, button:focus {
            background: #0c0;
            outline: 2px solid #0f0;
        }

        button.active-byte {
            background: #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        footer {
            width: 100%;
            padding: 0.4rem;
            font-size: 9pt;
            text-align: center;
            color: #0f0;
            background: rgba(0, 0, 0, 0.8);
            line-height: 1.2;
        }

        @media (max-width: 600px) {
            h1 { font-size: 1.1rem; margin: 0.5rem 0; }
            #console { 
                font-size: 0.75rem; 
                padding: 0.5rem; 
                max-height: calc(100vh - 220px); 
            }
            button { 
                padding: 0.5rem 1rem; 
                font-size: 0.85rem; 
                min-width: 80px; 
            }
            footer { padding: 0.3rem; }
        }

        @media (max-width: 400px) {
            .button-group { flex-direction: column; align-items: center; }
            button { width: 100%; max-width: 160px; }
            #console { max-height: calc(100vh - 200px); }
        }
    </style>
</head>
<body>
    <h1 role="heading" aria-level="1">Vial MCP Gateway</h1>
    <div id="console" role="log" aria-live="polite">
        <p>Vial MCP Gateway User Guide: Troubleshoot: Run system diagnostics | OAuth: Authenticate | Dashboard: Access after authentication</p>
    </div>
    <div class="button-group">
        <button id="troubleshoot-btn" aria-label="Run system diagnostics">Troubleshoot</button>
        <button id="oauth-btn" aria-label="Authenticate via OAuth">OAuth</button>
        <button id="dashboard-btn" aria-label="Access dashboard" disabled>Dashboard</button>
    </div>
    <footer>
        &copy; 2025 WebXOS - Vial MCP Gateway<br>
        Troubleshoot: Run system diagnostics | OAuth: Authenticate | Dashboard: Access after authentication
    </footer>

    <script>
        const consoleDiv = document.getElementById('console');
        let logQueue = [];
        let isAuthenticated = false;

        function log(message, isCommand = false) {
            const formattedMessage = isCommand 
                ? `<span class="command">${message}</span>`
                : message;
            logQueue.push(`[${new Date().toLocaleTimeString()}] ${formattedMessage}`);
            if (logQueue.length > 50) logQueue.shift();
            throttleConsoleUpdate();
        }

        const throttleConsoleUpdate = (() => {
            let timeout;
            return () => {
                if (!timeout) {
                    timeout = setTimeout(() => {
                        consoleDiv.innerHTML = logQueue.map(msg => `<p>${msg}</p>`).join('');
                        consoleDiv.scrollTop = consoleDiv.scrollHeight;
                        timeout = null;
                    }, 100);
                }
            };
        })();

        function triggerGlow() {
            document.body.classList.add('glow');
            setTimeout(() => document.body.classList.remove('glow'), 1000);
        }

        function flashRedGlow() {
            consoleDiv.classList.add('active-byte');
            setTimeout(() => consoleDiv.classList.remove('active-byte'), 500);
            setTimeout(() => {
                consoleDiv.classList.add('active-byte');
                setTimeout(() => consoleDiv.classList.remove('active-byte'), 500);
            }, 1000);
        }

        async function fetchWithRetry(url, options, retries = 3) {
            if (!navigator.onLine) {
                log('Offline: Please check your connection', true);
                flashRedGlow();
                return { status: 0, json: () => ({ error: 'Offline mode' }) };
            }

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const text = await response.text();
                        log(`HTTP Error ${response.status} (${url}): ${text}`, true);
                        flashRedGlow();
                        if (response.status === 404) {
                            return { status: 404, json: () => ({ error: 'Endpoint not found', path: url }) };
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const text = await response.text();
                    try {
                        return { status: response.status, json: () => JSON.parse(text) };
                    } catch (e) {
                        log(`JSON Parse Error for ${url}: ${e.message}`, true);
                        flashRedGlow();
                        return { status: response.status, json: () => ({ error: 'Invalid JSON response', details: text }) };
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        log(`Error for ${url}: ${error.message}`, true);
                        flashRedGlow();
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        async function testBackend() {
            const endpoints = [
                '/.netlify/functions/oauth',
                '/.netlify/functions/troubleshoot',
                '/.netlify/functions/health'
            ];
            for (const endpoint of endpoints) {
                try {
                    const response = await fetchWithRetry(endpoint, { 
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });
                    const data = await response.json();
                    if (data.error) {
                        log(`Endpoint ${endpoint} failed: ${data.error}`, true);
                        flashRedGlow();
                    } else {
                        log(`Endpoint ${endpoint}: ${JSON.stringify(data)}`, true);
                    }
                } catch (error) {
                    log(`Endpoint ${endpoint} failed: ${error.message}`, true);
                    flashRedGlow();
                }
            }
        }

        document.getElementById('troubleshoot-btn').addEventListener('click', async () => {
            triggerGlow();
            flashRedGlow();
            try {
                log('Running system diagnostics...', true);
                const response = await fetchWithRetry('/.netlify/functions/troubleshoot', { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.error) {
                    log(`Troubleshoot failed: ${data.error}`, true);
                    flashRedGlow();
                } else {
                    log(data.message || 'Troubleshoot complete', true);
                }
            } catch (error) {
                log(`Troubleshoot error: ${error.message}`, true);
                flashRedGlow();
            }
        });

        document.getElementById('oauth-btn').addEventListener('click', async () => {
            triggerGlow();
            flashRedGlow();
            try {
                log('Initiating OAuth authentication...', true);
                const response = await fetchWithRetry('/.netlify/functions/oauth', { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.error) {
                    log(`OAuth failed: ${data.error}`, true);
                    flashRedGlow();
                } else if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    isAuthenticated = true;
                    document.getElementById('dashboard-btn').disabled = false;
                    log('OAuth authentication successful', true);
                }
            } catch (error) {
                log(`OAuth error: ${error.message}`, true);
                flashRedGlow();
            }
        });

        document.getElementById('dashboard-btn').addEventListener('click', async () => {
            if (!isAuthenticated) {
                log('Please authenticate via OAuth first', true);
                flashRedGlow();
                return;
            }
            triggerGlow();
            flashRedGlow();
            try {
                log('Accessing dashboard...', true);
                const response = await fetchWithRetry('/.netlify/functions/health', { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.error) {
                    log(`Dashboard failed: ${data.error}`, true);
                    flashRedGlow();
                } else {
                    log(data.status || 'Dashboard access granted', true);
                }
            } catch (error) {
                log(`Dashboard error: ${error.message}`, true);
                flashRedGlow();
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    log('Service Worker registered', true);
                }).catch(err => {
                    log(`Service Worker registration failed: ${err.message}`, true);
                    flashRedGlow();
                });
            });
        }

        window.addEventListener('load', () => {
            log('Vial MCP Gateway User Guide: Troubleshoot: Run system diagnostics | OAuth: Authenticate | Dashboard: Access after authentication', true);
            testBackend();
        });
    </script>
</body>
</html>
