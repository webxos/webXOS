<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f0">
    <meta name="description" content="Vial MCP Gateway - Manage and troubleshoot your system">
    <meta name="keywords" content="Vial MCP, system management, troubleshooting, authentication, dashboard">
    <meta name="author" content="WebXOS">
    <meta name="robots" content="index, follow">
    <meta name="application-name" content="Vial MCP Gateway">
    <meta property="og:title" content="Vial MCP Gateway: System Management">
    <meta property="og:description" content="Access and manage your system with Vial MCP Gateway. Troubleshoot, authenticate, and unlock the dashboard.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://vial-mcp.webxos.com">
    <meta property="og:image" content="https://vial-mcp.webxos.com/icon.png">
    <meta property="og:site_name" content="Vial MCP Gateway">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Vial MCP Gateway: System Management">
    <meta name="twitter:description" content="Troubleshoot and authenticate with Vial MCP Gateway. Unlock the dashboard for full control.">
    <meta name="twitter:image" content="https://vial-mcp.webxos.com/icon.png">
    <meta name="twitter:site" content="@WebXOS">
    <title>Vial MCP Gateway</title>
    <link rel="icon" href="icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: monospace, sans-serif; }
        html, body { height: 100vh; overflow: hidden; background: #000; color: #0f0; display: flex; flex-direction: column; align-items: center; transition: background 0.3s, box-shadow 0.3s; -webkit-tap-highlight-color: transparent; }
        body.glow { background: rgba(255, 0, 0, 0.1); box-shadow: 0 0 20px #ff0000, 0 0 40px #ff0000 inset; }
        h1 { font-size: 1.6rem; text-align: center; margin: 0.8rem 0; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 5px #0f0; }
        #console { width: 90%; max-width: 900px; background: rgba(0, 255, 0, 0.1); border: 1px solid #0f0; padding: 0.6rem; flex: 1; max-height: calc(100vh - 240px); overflow-y: auto; margin: 0.5rem 0; border-radius: 5px; font-size: 0.8rem; -webkit-overflow-scrolling: touch; transition: border-color 0.3s, box-shadow 0.3s; }
        #console.active-byte { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        #console p { margin: 0.2rem 0; }
        #console .command { font-family: 'Orbitron', monospace; font-weight: 700; text-shadow: 0 0 3px #0f0; }
        #console .error { color: #ff0000; text-shadow: 0 0 2px #ff0000; }
        .button-group { display: flex; gap: 0.5rem; margin: 0.5rem 0; padding: 0.5rem; flex-wrap: wrap; justify-content: center; width: 90%; max-width: 900px; }
        button { background: #0f0; color: #000; border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; cursor: pointer; border-radius: 3px; min-width: 90px; text-align: center; touch-action: manipulation; transition: background 0.3s, box-shadow 0.3s; }
        button:hover, button:focus { background: #0c0; outline: 2px solid #0f0; }
        button.active-byte { background: #ff0000; box-shadow: 0 0 10px #ff0000; }
        button:disabled { background: #666; cursor: not-allowed; }
        #error { color: #ff0000; text-shadow: 0 0 2px #ff0000; margin: 0.5rem 0; font-size: 0.8rem; width: 90%; max-width: 900px; text-align: center; }
        #next-steps { color: #0f0; margin: 0.5rem 0; font-size: 0.8rem; width: 90%; max-width: 900px; text-align: center; background: rgba(0, 255, 0, 0.1); padding: 0.5rem; border-radius: 3px; }
        footer { width: 100%; padding: 0.4rem; font-size: 9pt; text-align: center; color: #0f0; background: rgba(0, 0, 0, 0.8); line-height: 1.2; }
        @media (max-width: 600px) { h1 { font-size: 1.1rem; margin: 0.5rem 0; } #console { font-size: 0.75rem; padding: 0.5rem; max-height: calc(100vh - 220px); } button { padding: 0.5rem 1rem; font-size: 0.85rem; min-width: 80px; } footer { padding: 0.3rem; } }
        @media (max-width: 400px) { .button-group { flex-direction: column; align-items: center; } button { width: 100%; max-width: 160px; } #console { max-height: calc(100vh - 200px); } }
    </style>
</head>
<body>
    <h1 role="heading" aria-level="1">VIAL MCP GATEWAY</h1>
    <div id="console" role="log" aria-live="polite">
        <p>Vial MCP User Guide: Troubleshoot: Run troubleshoot | OAuth: Authenticate | Dashboard: Access after authentication</p>
    </div>
    <div id="error"></div>
    <div id="next-steps"></div>
    <div class="button-group">
        <button id="troubleshoot-btn" aria-label="Run troubleshoot">Troubleshoot</button>
        <button id="oauth-btn" aria-label="Authenticate">OAuth</button>
        <button id="dashboard-btn" aria-label="Access dashboard" disabled>Dashboard</button>
    </div>
    <footer>
        Â© 2025 WebXOS - Vial MCP Gateway<br>
        Troubleshoot: Run troubleshoot | OAuth: Authenticate | Dashboard: Access after authentication
    </footer>

    <script>
        function debugLog(message) { console.log(`[DEBUG] ${message}`); }

        const consoleDiv = document.getElementById('console');
        const errorDiv = document.getElementById('error');
        const nextStepsDiv = document.getElementById('next-steps');
        let logQueue = [];
        let isAuthenticated = false;
        const maxRetries = 3;

        function log(message, isCommand = false, isError = false) {
            const formattedMessage = isCommand 
                ? `<span class="command">${message}</span>`
                : isError 
                ? `<span class="error">${message}</span>`
                : message;
            logQueue.push(`[${new Date().toLocaleTimeString()}] ${formattedMessage}`);
            if (logQueue.length > 50) logQueue.shift();
            throttleConsoleUpdate();
        }

        const throttleConsoleUpdate = (() => {
            let timeout;
            return () => {
                if (!timeout) {
                    timeout = setTimeout(() => {
                        consoleDiv.innerHTML = logQueue.map(msg => `<p>${msg}</p>`).join('');
                        consoleDiv.scrollTop = consoleDiv.scrollHeight;
                        timeout = null;
                    }, 100);
                }
            };
        })();

        function triggerGlow() {
            document.body.classList.add('glow');
            setTimeout(() => document.body.classList.remove('glow'), 1000);
        }

        function flashRedGlow() {
            consoleDiv.classList.add('active-byte');
            setTimeout(() => consoleDiv.classList.remove('active-byte'), 500);
            setTimeout(() => {
                consoleDiv.classList.add('active-byte');
                setTimeout(() => consoleDiv.classList.remove('active-byte'), 500);
            }, 1000);
        }

        function resetConsole() {
            debugLog('Reset command executed');
            try {
                logQueue = ['Vial MCP User Guide: Troubleshoot: Run troubleshoot | OAuth: Authenticate | Dashboard: Access after authentication'];
                throttleConsoleUpdate();
                log('Console cleared.', true);
            } catch (err) {
                log(`Reset Error: ${err.message}`, true, true);
                debugLog(`Reset Error: ${err.stack}`);
            }
        }

        const SERVER_URL = 'https://webxos.netlify.app/api';
        const fetchWithRetry = async (url, options = {}, retries = maxRetries) => {
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        method: options.method || 'POST',
                        headers: { 'Content-Type': 'application/json', ...options.headers }
                    });
                    if (!response.ok) {
                        const text = await response.text();
                        if (response.status === 404 && text.includes('<!DOCTYPE html>')) {
                            throw new Error(`HTTP 404: Endpoint not found - Response starts with HTML: ${text.substring(0, 50)} (Attempt ${attempt}/${retries})`);
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - Response: ${text.substring(0, 100)}`);
                    }
                    const contentType = response.headers.get('content-type');
                    if (!contentType?.includes('application/json')) {
                        const text = await response.text();
                        throw new Error(`Expected JSON, received: ${text.substring(0, 100)}`);
                    }
                    return await response.json();
                } catch (err) {
                    if (attempt === retries) {
                        errorDiv.textContent = err.message;
                        return { error: { code: -32000, message: err.message, traceback: err.stack } };
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // Exponential backoff
                }
            }
        };

        async function troubleshoot() {
            debugLog('Troubleshoot button clicked');
            triggerGlow();
            flashRedGlow();
            const troubleshootBtn = document.getElementById('troubleshoot-btn');
            troubleshootBtn.disabled = true;
            try {
                log('Running troubleshoot...', true);
                const response = await fetchWithRetry(`${SERVER_URL}/troubleshoot`);
                if (response.error) {
                    log(`Troubleshoot Error: ${response.error.message} Source: ${response.error.traceback}`, false, true);
                    updateNextSteps('Troubleshoot failed. Check routing or redeploy. Prompt: "Fix routing"');
                } else {
                    log(`Troubleshoot Report: ${JSON.stringify(response)}`);
                }
            } catch (err) {
                log(`Troubleshoot Error: ${err.message} Source: ${err.stack}`, false, true);
                updateNextSteps('Troubleshoot failed. Verify server or redeploy. Prompt: "Check server status"');
            }
            troubleshootBtn.disabled = false;
        }

        async function oauthAuthenticate() {
            debugLog('OAuth button clicked');
            triggerGlow();
            flashRedGlow();
            const oauthBtn = document.getElementById('oauth-btn');
            oauthBtn.disabled = true;
            try {
                log('Running authentication...', true);
                const response = await fetchWithRetry(`${SERVER_URL}/auth/oauth`, {
                    method: 'POST',
                    body: JSON.stringify({ provider: 'mock', code: 'test_code' })
                });
                if (response.error) {
                    log(`Authentication Error: ${response.error.message} Traceback: ${response.error.traceback}`, false, true);
                    if (response.error.message.includes('HTTP 404')) {
                        updateNextSteps('OAuth failed. Endpoint not found. Redeploy or fix routing. Prompt: "Fix deployment"');
                    } else {
                        updateNextSteps('OAuth failed. Check credentials or logs. Prompt: "Verify OAuth configuration"');
                    }
                } else {
                    localStorage.setItem('access_token', response.access_token);
                    localStorage.setItem('lastResponse', JSON.stringify(response));
                    log('Authentication successful.');
                    isAuthenticated = true;
                    document.getElementById('dashboard-btn').disabled = false;
                }
            } catch (err) {
                log(`Authentication Error: ${err.message} Traceback: ${err.stack}`, false, true);
                updateNextSteps('OAuth failed. Check routing or redeploy. Prompt: "Fix routing"');
            }
            oauthBtn.disabled = false;
        }

        function navigateDashboard() {
            if (isAuthenticated) {
                log('Navigating to dashboard...', true);
                window.location.href = '/app/dashboard';
            } else {
                log('Error: Authentication required to access dashboard.', false, true);
                updateNextSteps('Dashboard access denied. Authenticate first. Prompt: "Retry OAuth"');
            }
        }

        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        document.getElementById('troubleshoot-btn').addEventListener('click', debounce(troubleshoot, 200));
        document.getElementById('oauth-btn').addEventListener('click', debounce(oauthAuthenticate, 200));
        document.getElementById('dashboard-btn').addEventListener('click', debounce(navigateDashboard, 200));

        document.addEventListener('keydown', e => {
            debugLog(`Key pressed: ${e.key}`);
            if (e.key === 'Enter' || e.key === ' ') troubleshoot();
            else if (e.key === 'o' || e.key === 'O') oauthAuthenticate();
            else if (e.key === 'd' || e.key === 'D') navigateDashboard();
        });

        function handleCommand(command) {
            log(`> ${command}`, true);
            try {
                const [cmd, ...args] = command.split(' ');
                switch (cmd.toLowerCase()) {
                    case '/help':
                        log('Vial MCP Commands:\n- /help: Show this guide\n- /troubleshoot: Run Troubleshoot\n- /auth: Run OAuth (authenticate)\n- /dashboard: Navigate to dashboard\n- /clear: Clear console', true);
                        break;
                    case '/troubleshoot':
                        troubleshoot();
                        break;
                    case '/auth':
                        oauthAuthenticate();
                        break;
                    case '/dashboard':
                        navigateDashboard();
                        break;
                    case '/clear':
                        resetConsole();
                        break;
                    default:
                        throw new Error(`Unknown command: ${cmd}`);
                }
            } catch (err) {
                log(`Command Error: ${err.message} Source: ${err.stack}`, true, true);
                updateNextSteps('Command failed. Check server status. Prompt: "Retry command"');
            }
        }

        const commandInput = document.createElement('input');
        commandInput.type = 'text';
        commandInput.placeholder = 'Enter command (e.g., /help)';
        commandInput.style.width = '90%';
        commandInput.style.maxWidth = '900px';
        commandInput.style.background = '#000';
        commandInput.style.border = '1px solid #0f0';
        commandInput.style.color = '#0f0';
        commandInput.style.padding = '0.3rem';
        commandInput.style.margin = '0.5rem 0';
        commandInput.style.fontSize = '0.9rem';
        document.querySelector('.button-group').parentNode.insertBefore(commandInput, document.querySelector('.button-group'));

        commandInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && commandInput.value.trim()) {
                handleCommand(commandInput.value.trim());
                commandInput.value = '';
            }
        });

        function updateNextSteps(message) {
            nextStepsDiv.textContent = `Next Steps: ${message}`;
        }

        async function checkHealth() {
            try {
                const response = await fetchWithRetry(`${SERVER_URL}/health`);
                if (response.status === 'healthy') {
                    log('System health check: Healthy', true);
                } else {
                    log('System health check: Unhealthy', true, true);
                    updateNextSteps('Health check failed. Redeploy or fix server. Prompt: "Fix deployment"');
                }
            } catch (err) {
                log(`Health Check Error: ${err.message} Source: ${err.stack}`, true, true);
                updateNextSteps('Health check failed. Check server status. Prompt: "Check server status"');
            }
        }
        checkHealth();

        log('Vial MCP User Guide: Troubleshoot: Run troubleshoot | OAuth: Authenticate | Dashboard: Access after authentication', true);
    </script>
</body>
</html>
