<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEGACY OS - by webXOS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêß</text></svg>">
    <style>
        /* Early 90s Linux/X11 Style */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 12px;
        }
        
        body {
            background-color: #000033;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23000033"/><circle cx="50" cy="50" r="40" fill="%23000044"/></svg>');
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            color: #00ff00;
            position: relative;
        }
        
        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 24px;
            padding: 10px;
            overflow: hidden;
        }
        
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            background: #333344;
            border-top: 2px solid #777788;
            display: flex;
            align-items: center;
            padding: 0 4px;
            z-index: 1000;
            color: #aaffaa;
        }
        
        #start-button {
            height: 20px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            padding: 2px 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-right: 4px;
            cursor: pointer;
            color: #ffffff;
        }
        
        #start-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        #taskbar-programs {
            flex: 1;
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 0 4px;
        }
        
        #clock {
            padding: 2px 8px;
            background: #555566;
            border: 2px solid;
            border-color: #222233 #777788 #777788 #222233;
            margin-left: auto;
            white-space: nowrap;
            color: #aaffaa;
        }
        
        /* Start Menu */
        #start-menu {
            position: absolute;
            bottom: 24px;
            left: 4px;
            width: 200px;
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            padding: 2px;
            display: none;
            z-index: 1001;
        }
        
        .start-menu-item {
            padding: 6px 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #aaffaa;
        }
        
        .start-menu-item:hover {
            background-color: #000066;
            color: white;
        }
        
        .start-menu-separator {
            height: 1px;
            background: #777788;
            margin: 4px 0;
        }
        
        /* Desktop Icons */
        .desktop-icon {
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 16px;
            padding: 8px;
            cursor: pointer;
            text-align: center;
            word-break: break-word;
            color: #00ff00;
            border: 1px dashed transparent;
        }
        
        .desktop-icon:hover {
            background-color: rgba(0, 100, 0, 0.2);
            border-color: #00ff00;
        }
        
        .desktop-icon.selected {
            background-color: rgba(0, 100, 0, 0.4);
            border-color: #00ff00;
        }
        
        /* Window Styles - X11/Motif inspired */
        .window {
            position: absolute;
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            min-width: 300px;
            min-height: 200px;
            display: none;
            flex-direction: column;
            z-index: 100;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
            color: #aaffaa;
        }
        
        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100% - 24px) !important;
        }
        
        .window-header {
            background: linear-gradient(to right, #000066, #333377);
            color: #ffffff;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            cursor: move;
            user-select: none;
            border-bottom: 1px solid #777788;
        }
        
        .window-controls {
            display: flex;
        }
        
        .window-control {
            width: 18px;
            height: 16px;
            background: #555566;
            border: 1px solid;
            border-color: #777788 #222233 #222233 #777788;
            margin-left: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            color: #aaffaa;
        }
        
        .window-control:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        .window-content {
            flex: 1;
            padding: 8px;
            overflow: auto;
            background: #222233;
        }
        
        /* Terminal Window */
        .terminal-content {
            background: #000011;
            color: #00ff00;
            padding: 8px;
            height: 100%;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        
        .terminal-input-line {
            display: flex;
            margin-top: 4px;
        }
        
        .terminal-prompt {
            color: #ffff00;
            margin-right: 8px;
            white-space: nowrap;
        }
        
        .terminal-input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 13px;
            flex: 1;
            outline: none;
        }
        
        /* File Manager */
        .file-manager-toolbar {
            display: flex;
            padding: 4px;
            border-bottom: 1px solid #777788;
            background: #333344;
        }
        
        .toolbar-button {
            padding: 2px 8px;
            margin-right: 4px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            cursor: pointer;
            color: #aaffaa;
        }
        
        .toolbar-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        .file-list {
            display: flex;
            flex-wrap: wrap;
            padding: 8px;
        }
        
        .file-item {
            width: 100px;
            padding: 8px;
            margin: 4px;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            color: #aaffaa;
        }
        
        .file-item:hover {
            background-color: rgba(0, 100, 0, 0.2);
            border: 1px dashed #00ff00;
        }
        
        .file-item.selected {
            background-color: rgba(0, 100, 0, 0.4);
            border: 1px solid #00ff00;
        }
        
        /* Text Editor */
        .text-editor {
            width: 100%;
            height: 100%;
            background: #000011;
            color: #00ff00;
            border: 1px solid #555566;
            padding: 8px;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 13px;
            resize: none;
        }
        
        /* System Monitor */
        .system-stats {
            padding: 8px;
        }
        
        .stat-bar {
            height: 16px;
            background: #555566;
            border: 1px solid #777788;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .stat-fill {
            height: 100%;
            background: #006600;
        }
        
        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        /* Modal Dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-dialog {
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            min-width: 300px;
            padding: 0;
            color: #aaffaa;
        }
        
        .modal-header {
            background: linear-gradient(to right, #000066, #333377);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            border-bottom: 1px solid #777788;
        }
        
        .modal-body {
            padding: 16px;
            background: #222233;
        }
        
        .modal-footer {
            padding: 8px;
            text-align: right;
            border-top: 1px solid #777788;
            background: #333344;
        }
        
        .dialog-button {
            padding: 4px 12px;
            margin-left: 4px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            cursor: pointer;
            color: #aaffaa;
        }
        
        .dialog-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        .dialog-button.primary {
            background: #006600;
            font-weight: bold;
        }
        
        /* Context Menu */
        .context-menu {
            position: absolute;
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            padding: 2px;
            display: none;
            z-index: 1500;
        }
        
        .context-menu-item {
            padding: 6px 24px 6px 12px;
            cursor: pointer;
            white-space: nowrap;
            color: #aaffaa;
        }
        
        .context-menu-item:hover {
            background-color: #000066;
            color: white;
        }
        
        /* Taskbar Program Button */
        .taskbar-program {
            padding: 2px 8px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            margin-right: 4px;
            cursor: pointer;
            white-space: nowrap;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #aaffaa;
        }
        
        .taskbar-program.active {
            border-color: #222233 #777788 #777788 #222233;
            background: #000066;
        }
        
        /* Status Bar */
        #status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 18px;
            background: #333344;
            border-top: 1px solid #777788;
            padding: 2px 8px;
            font-size: 10px;
            display: none;
            color: #aaffaa;
        }
        
        /* Welcome Screen */
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 24px;
            background: #000011;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2001;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            text-align: center;
        }
        
        #welcome-screen h1 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }
        
        #welcome-screen .logo {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        #welcome-screen p {
            font-size: 14px;
            margin-bottom: 20px;
            max-width: 600px;
            line-height: 1.5;
        }
        
        .welcome-button {
            padding: 10px 20px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            cursor: pointer;
            font-size: 14px;
            margin: 8px;
            color: #aaffaa;
        }
        
        .welcome-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        /* Help Window */
        .help-content {
            padding: 8px;
            line-height: 1.4;
        }
        
        .help-command {
            color: #ffff00;
            margin: 8px 0 4px 0;
        }
        
        .help-description {
            margin-left: 16px;
            margin-bottom: 12px;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #333344;
            border: 1px solid #555566;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555566;
            border: 1px solid #777788;
        }
        
        /* CLI Output */
        .cli-output {
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .cli-error {
            color: #ff5555;
        }
        
        .cli-success {
            color: #55ff55;
        }
        
        .cli-directory {
            color: #5555ff;
        }
        
        .cli-executable {
            color: #ff55ff;
        }
        
        /* Desktop wallpaper text */
        #desktop-text {
            position: absolute;
            bottom: 30px;
            right: 20px;
            color: #008800;
            font-size: 10px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="logo">üêß</div>
        <h1>LEGACY OS - Linux Clone Edition</h1>
        <p>Early 90s Linux Experience in a Single HTML Page</p>
        <p>A functional operating system interface with CLI, file system, and applications</p>
        <p>Built by webXOS | webxos.netlify.app | 2026</p>
        <div>
            <button class="welcome-button" id="start-demo">Boot System</button>
            <button class="welcome-button" id="view-guide">Quick Start</button>
        </div>
        <p style="margin-top: 30px; font-size: 12px;">Based on early 90s Linux/X11 interfaces</p>
    </div>

    <!-- Desktop -->
    <div id="desktop">
        <!-- Desktop Icons will be dynamically created here -->
        <div id="desktop-text">LEGACY OS Linux v0.1.0 | by webXOS 2026</div>
    </div>
    
    <!-- Taskbar -->
    <div id="taskbar">
        <div id="start-button">
            <span>Applications</span>
        </div>
        <div id="taskbar-programs">
            <!-- Active programs will appear here -->
        </div>
        <div id="clock">00:00</div>
    </div>
    
    <!-- Start Menu -->
    <div id="start-menu">
        <div class="start-menu-item" id="start-terminal">
            <span>Terminal (CLI)</span>
        </div>
        <div class="start-menu-item" id="start-fileman">
            <span>File Manager</span>
        </div>
        <div class="start-menu-item" id="start-editor">
            <span>Text Editor</span>
        </div>
        <div class="start-menu-separator"></div>
        <div class="start-menu-item" id="start-monitor">
            <span>System Monitor</span>
        </div>
        <div class="start-menu-item" id="start-help">
            <span>Help & Commands</span>
        </div>
        <div class="start-menu-separator"></div>
        <div class="start-menu-item" id="start-about">
            <span>About LEGACY OS</span>
        </div>
        <div class="start-menu-item" id="start-shutdown">
            <span>Shutdown</span>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-text">Ready</span>
    </div>
    
    <!-- Terminal Window -->
    <div class="window" id="terminal">
        <div class="window-header">
            <span>Terminal - bash</span>
            <div class="window-controls">
                <div class="window-control" id="terminal-minimize">_</div>
                <div class="window-control" id="terminal-maximize">‚ñ°</div>
                <div class="window-control" id="terminal-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="terminal-content" id="terminal-output">
                <div class="cli-output">LEGACY OS by webXOS Terminal v0.1.0</div>
                <div class="cli-output">Type 'help' for available commands</div>
                <div class="cli-output">Type 'man [command]' for detailed help</div>
                <div id="terminal-history"></div>
                <div class="terminal-input-line">
                    <span class="terminal-prompt">[user@legacyos ~]$</span>
                    <input type="text" class="terminal-input" id="terminal-input" autocomplete="off">
                </div>
            </div>
        </div>
    </div>
    
    <!-- File Manager -->
    <div class="window" id="file-manager">
        <div class="window-header">
            <span>File Manager</span>
            <div class="window-controls">
                <div class="window-control" id="file-manager-minimize">_</div>
                <div class="window-control" id="file-manager-maximize">‚ñ°</div>
                <div class="window-control" id="file-manager-close">√ó</div>
            </div>
        </div>
        <div class="file-manager-toolbar">
            <div class="toolbar-button" id="fm-home">Home</div>
            <div class="toolbar-button" id="fm-up">Up</div>
            <div class="toolbar-button" id="fm-new-folder">New Folder</div>
            <div class="toolbar-button" id="fm-new-file">New File</div>
            <div class="toolbar-button" id="fm-delete">Delete</div>
            <div class="toolbar-button" id="fm-refresh">Refresh</div>
        </div>
        <div class="window-content">
            <div class="file-list" id="file-manager-list">
                <!-- Files and folders will be listed here -->
            </div>
        </div>
    </div>
    
    <!-- Text Editor -->
    <div class="window" id="text-editor">
        <div class="window-header">
            <span>Text Editor - [unnamed]</span>
            <div class="window-controls">
                <div class="window-control" id="text-editor-minimize">_</div>
                <div class="window-control" id="text-editor-maximize">‚ñ°</div>
                <div class="window-control" id="text-editor-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <textarea class="text-editor" id="text-editor-area"></textarea>
        </div>
    </div>
    
    <!-- System Monitor -->
    <div class="window" id="system-monitor">
        <div class="window-header">
            <span>System Monitor</span>
            <div class="window-controls">
                <div class="window-control" id="system-monitor-minimize">_</div>
                <div class="window-control" id="system-monitor-maximize">‚ñ°</div>
                <div class="window-control" id="system-monitor-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="system-stats">
                <h3>System Resources</h3>
                <div>
                    <div class="stat-label">
                        <span>Memory Usage</span>
                        <span id="memory-percent">45%</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="memory-bar" style="width: 45%"></div>
                    </div>
                </div>
                <div>
                    <div class="stat-label">
                        <span>CPU Usage</span>
                        <span id="cpu-percent">30%</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="cpu-bar" style="width: 30%"></div>
                    </div>
                </div>
                <div>
                    <div class="stat-label">
                        <span>Storage Usage</span>
                        <span id="storage-percent">65%</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="storage-bar" style="width: 65%"></div>
                    </div>
                </div>
                <div>
                    <h3>File System Info</h3>
                    <p id="db-info">Loading IndexedDB...</p>
                    <p id="current-path">Path: /home/user</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Window -->
    <div class="window" id="help-window">
        <div class="window-header">
            <span>Help & Commands</span>
            <div class="window-controls">
                <div class="window-control" id="help-minimize">_</div>
                <div class="window-control" id="help-maximize">‚ñ°</div>
                <div class="window-control" id="help-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="help-content">
                <h3>LEGACY OS Linux - Available Commands</h3>
                <p>Type these commands in the terminal:</p>
                
                <div class="help-command">help</div>
                <div class="help-description">Show this help message</div>
                
                <div class="help-command">ls [path]</div>
                <div class="help-description">List directory contents</div>
                
                <div class="help-command">cd [path]</div>
                <div class="help-description">Change directory</div>
                
                <div class="help-command">pwd</div>
                <div class="help-description">Print working directory</div>
                
                <div class="help-command">mkdir [name]</div>
                <div class="help-description">Create new directory</div>
                
                <div class="help-command">touch [name]</div>
                <div class="help-description">Create new file</div>
                
                <div class="help-command">cat [file]</div>
                <div class="help-description">Display file contents</div>
                
                <div class="help-command">rm [file]</div>
                <div class="help-description">Remove file</div>
                
                <div class="help-command">rmdir [directory]</div>
                <div class="help-description">Remove empty directory</div>
                
                <div class="help-command">clear</div>
                <div class="help-description">Clear terminal screen</div>
                
                <div class="help-command">echo [text]</div>
                <div class="help-description">Display text</div>
                
                <div class="help-command">date</div>
                <div class="help-description">Show current date and time</div>
                
                <div class="help-command">whoami</div>
                <div class="help-description">Show current user</div>
                
                <div class="help-command">man [command]</div>
                <div class="help-description">Show manual for command</div>
                
                <h3>File System</h3>
                <p>All files are stored in browser's IndexedDB. Paths use Unix-style syntax.</p>
                <p>Example: /home/user/documents/file.txt</p>
            </div>
        </div>
    </div>
    
    <!-- About Window -->
    <div class="window" id="about-window">
        <div class="window-header">
            <span>About LEGACY OS</span>
            <div class="window-controls">
                <div class="window-control" id="about-minimize">_</div>
                <div class="window-control" id="about-maximize">‚ñ°</div>
                <div class="window-control" id="about-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="help-content">
                <h2>LEGACY OS - by webXOS</h2>
                <p><strong>Version:</strong> 0.1.0</p>
                <p><strong>Architecture:</strong> Single HTML File with IndexedDB</p>
                <p><strong>Inspired by:</strong> Early 90s Linux/X11 interfaces</p>
                
                <h3>Features:</h3>
                <ul>
                    <li>Functional CLI with Linux-like commands</li>
                    <li>Complete file system in IndexedDB</li>
                    <li>Text editor with save functionality</li>
                    <li>File manager with GUI</li>
                    <li>System resource monitor</li>
                    <li>All data persists in browser</li>
                    <li>No external dependencies</li>
                </ul>
                
                <h3>For Developers:</h3>
                <p>This is a template for creating retro-style web applications.</p>
                <p>To extend:</p>
                <ol>
                    <li>Add new commands to the CLI command registry</li>
                    <li>Create new window templates</li>
                    <li>Add new file types and handlers</li>
                    <li>Modify the IndexedDB schema for new features</li>
                </ol>
                
                <p><strong>License:</strong> MIT - webXOS 2026</p>
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="desktop-context-menu">
        <div class="context-menu-item" id="context-terminal">Open Terminal</div>
        <div class="context-menu-item" id="context-refresh">Refresh Desktop</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="context-new-folder">New Folder</div>
        <div class="context-menu-item" id="context-new-file">New Text File</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="context-about">About LEGACY OS</div>
    </div>
    
    <!-- Modal Dialogs -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-dialog" id="modal-dialog">
            <div class="modal-header" id="modal-header">Dialog</div>
            <div class="modal-body" id="modal-body">
                Dialog content goes here
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="dialog-button" id="modal-cancel">Cancel</button>
                <button class="dialog-button primary" id="modal-ok">OK</button>
            </div>
        </div>
    </div>

    <script>
        // LEGACY OS - Linux Edition
        document.addEventListener('DOMContentLoaded', function() {
            initLegacyOS();
        });
        
        // Global variables
        let db;
        let currentPath = '/home/user';
        let currentFolderId = 'home';
        let activeWindows = [];
        let zIndexCounter = 100;
        let selectedDesktopIcon = null;
        let selectedFileItem = null;
        let commandHistory = [];
        let historyIndex = -1;
        
        // CLI Command Registry
        const COMMANDS = {
            'help': {
                description: 'Show available commands',
                execute: cmdHelp,
                usage: 'help'
            },
            'ls': {
                description: 'List directory contents',
                execute: cmdLs,
                usage: 'ls [path]'
            },
            'cd': {
                description: 'Change directory',
                execute: cmdCd,
                usage: 'cd [path]'
            },
            'pwd': {
                description: 'Print working directory',
                execute: cmdPwd,
                usage: 'pwd'
            },
            'mkdir': {
                description: 'Create new directory',
                execute: cmdMkdir,
                usage: 'mkdir [name]'
            },
            'touch': {
                description: 'Create new file',
                execute: cmdTouch,
                usage: 'touch [filename]'
            },
            'cat': {
                description: 'Display file contents',
                execute: cmdCat,
                usage: 'cat [filename]'
            },
            'rm': {
                description: 'Remove file',
                execute: cmdRm,
                usage: 'rm [filename]'
            },
            'rmdir': {
                description: 'Remove empty directory',
                execute: cmdRmdir,
                usage: 'rmdir [dirname]'
            },
            'clear': {
                description: 'Clear terminal screen',
                execute: cmdClear,
                usage: 'clear'
            },
            'echo': {
                description: 'Display text',
                execute: cmdEcho,
                usage: 'echo [text]'
            },
            'date': {
                description: 'Show current date and time',
                execute: cmdDate,
                usage: 'date'
            },
            'whoami': {
                description: 'Show current user',
                execute: cmdWhoami,
                usage: 'whoami'
            },
            'man': {
                description: 'Show manual for command',
                execute: cmdMan,
                usage: 'man [command]'
            }
        };
        
        // Application registry
        const APP_REGISTRY = {
            'terminal': {
                name: 'Terminal',
                icon: 'üíª',
                windowId: 'terminal',
                open: openTerminal
            },
            'file-manager': {
                name: 'File Manager',
                icon: 'üìÅ',
                windowId: 'file-manager',
                open: openFileManager
            },
            'text-editor': {
                name: 'Text Editor',
                icon: 'üìù',
                windowId: 'text-editor',
                open: openTextEditor
            },
            'system-monitor': {
                name: 'System Monitor',
                icon: 'üìä',
                windowId: 'system-monitor',
                open: openSystemMonitor
            },
            'help': {
                name: 'Help',
                icon: '‚ùì',
                windowId: 'help-window',
                open: openHelp
            },
            'about': {
                name: 'About',
                icon: '‚ÑπÔ∏è',
                windowId: 'about-window',
                open: openAbout
            }
        };
        
        // Initialize the OS
        function initLegacyOS() {
            // Hide welcome screen after a delay or on button click
            document.getElementById('start-demo').addEventListener('click', function() {
                document.getElementById('welcome-screen').style.display = 'none';
                initDesktop();
                initEventListeners();
                initDatabase();
                updateClock();
                setInterval(updateClock, 1000);
                setInterval(updateSystemStats, 2000);
                updateStatus('System ready. Double-click Terminal to begin.');
            });
            
            document.getElementById('view-guide').addEventListener('click', function() {
                document.getElementById('welcome-screen').style.display = 'none';
                initDesktop();
                initEventListeners();
                initDatabase();
                updateClock();
                setInterval(updateClock, 1000);
                openHelp();
            });
            
            // Auto-start after 3 seconds
            setTimeout(function() {
                if (document.getElementById('welcome-screen').style.display !== 'none') {
                    document.getElementById('welcome-screen').style.display = 'none';
                    initDesktop();
                    initEventListeners();
                    initDatabase();
                    updateClock();
                    setInterval(updateClock, 1000);
                    setInterval(updateSystemStats, 2000);
                    updateStatus('System ready. Double-click Terminal to begin.');
                }
            }, 3000);
        }
        
        // Initialize desktop icons
        function initDesktop() {
            const desktop = document.getElementById('desktop');
            
            // Create desktop icons for each app
            for (const appId in APP_REGISTRY) {
                const app = APP_REGISTRY[appId];
                const icon = document.createElement('div');
                icon.className = 'desktop-icon';
                icon.id = `desktop-icon-${appId}`;
                icon.innerHTML = `
                    <div style="font-size: 32px;">${app.icon}</div>
                    <span>${app.name}</span>
                `;
                icon.addEventListener('dblclick', function() {
                    app.open();
                });
                icon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectDesktopIcon(appId);
                });
                desktop.appendChild(icon);
            }
            
            // Add "Home" icon
            const homeIcon = document.createElement('div');
            homeIcon.className = 'desktop-icon';
            homeIcon.id = 'desktop-icon-home';
            homeIcon.innerHTML = `
                <div style="font-size: 32px;">üè†</div>
                <span>Home</span>
            `;
            homeIcon.addEventListener('dblclick', function() {
                openFileManager();
            });
            homeIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                selectDesktopIcon('home');
            });
            desktop.appendChild(homeIcon);
            
            // Add "Trash" icon
            const trashIcon = document.createElement('div');
            trashIcon.className = 'desktop-icon';
            trashIcon.id = 'desktop-icon-trash';
            trashIcon.innerHTML = `
                <div style="font-size: 32px;">üóëÔ∏è</div>
                <span>Trash</span>
            `;
            trashIcon.addEventListener('dblclick', function() {
                showDialog('Trash', 'The trash is empty.');
            });
            trashIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                selectDesktopIcon('trash');
            });
            desktop.appendChild(trashIcon);
            
            // Desktop click listener to clear selection
            desktop.addEventListener('click', function(e) {
                if (e.target === desktop || e.target.id === 'desktop') {
                    clearDesktopSelection();
                }
            });
            
            // Desktop context menu
            desktop.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, 'desktop');
            });
        }
        
        // Initialize event listeners
        function initEventListeners() {
            // Start button
            document.getElementById('start-button').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleStartMenu();
            });
            
            // Start menu items
            document.getElementById('start-terminal').addEventListener('click', function() {
                toggleStartMenu();
                openTerminal();
            });
            
            document.getElementById('start-fileman').addEventListener('click', function() {
                toggleStartMenu();
                openFileManager();
            });
            
            document.getElementById('start-editor').addEventListener('click', function() {
                toggleStartMenu();
                openTextEditor();
            });
            
            document.getElementById('start-monitor').addEventListener('click', function() {
                toggleStartMenu();
                openSystemMonitor();
            });
            
            document.getElementById('start-help').addEventListener('click', function() {
                toggleStartMenu();
                openHelp();
            });
            
            document.getElementById('start-about').addEventListener('click', function() {
                toggleStartMenu();
                openAbout();
            });
            
            document.getElementById('start-shutdown').addEventListener('click', function() {
                toggleStartMenu();
                showDialog('Shutdown', 'Are you sure you want to shut down LEGACY OS?', true, 'shutdown');
            });
            
            // Close start menu when clicking elsewhere
            document.addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
            });
            
            // Context menu items
            document.getElementById('context-terminal').addEventListener('click', function() {
                hideContextMenu();
                openTerminal();
            });
            
            document.getElementById('context-refresh').addEventListener('click', function() {
                hideContextMenu();
                updateStatus('Desktop refreshed');
            });
            
            document.getElementById('context-new-folder').addEventListener('click', function() {
                hideContextMenu();
                showDialog('Create Folder', 'Enter folder name:', true, 'new-folder');
            });
            
            document.getElementById('context-new-file').addEventListener('click', function() {
                hideContextMenu();
                showDialog('Create File', 'Enter file name:', true, 'new-file');
            });
            
            document.getElementById('context-about').addEventListener('click', function() {
                hideContextMenu();
                openAbout();
            });
            
            // File manager toolbar buttons
            document.getElementById('fm-home').addEventListener('click', function() {
                navigateToFolder('home');
            });
            
            document.getElementById('fm-up').addEventListener('click', function() {
                navigateUp();
            });
            
            document.getElementById('fm-new-folder').addEventListener('click', function() {
                showDialog('Create Folder', 'Enter folder name:', true, 'new-folder');
            });
            
            document.getElementById('fm-new-file').addEventListener('click', function() {
                showDialog('Create File', 'Enter file name:', true, 'new-file');
            });
            
            document.getElementById('fm-delete').addEventListener('click', function() {
                if (selectedFileItem) {
                    showDialog('Delete', `Are you sure you want to delete "${selectedFileItem.name}"?`, true, 'delete-file');
                } else {
                    showDialog('Delete', 'Please select a file or folder first.');
                }
            });
            
            document.getElementById('fm-refresh').addEventListener('click', function() {
                refreshFileManager();
            });
            
            // Modal buttons
            document.getElementById('modal-cancel').addEventListener('click', function() {
                hideModal();
            });
            
            document.getElementById('modal-ok').addEventListener('click', function() {
                const dialogType = document.getElementById('modal-dialog').getAttribute('data-type');
                handleDialogOk(dialogType);
            });
            
            // Terminal input handler
            document.getElementById('terminal-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateCommandHistory('up');
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateCommandHistory('down');
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    autoCompleteCommand(this.value);
                }
            });
            
            // Initialize window dragging
            initWindowDragging();
            
            // Initialize all window controls
            initAllWindowControls();
        }
        
        // Toggle start menu
        function toggleStartMenu() {
            const startMenu = document.getElementById('start-menu');
            startMenu.style.display = startMenu.style.display === 'block' ? 'none' : 'block';
        }
        
        // Select desktop icon
        function selectDesktopIcon(iconId) {
            clearDesktopSelection();
            
            selectedDesktopIcon = iconId;
            const iconElement = document.getElementById(`desktop-icon-${iconId}`);
            if (iconElement) {
                iconElement.classList.add('selected');
            }
        }
        
        // Clear desktop selection
        function clearDesktopSelection() {
            if (selectedDesktopIcon) {
                const iconElement = document.getElementById(`desktop-icon-${selectedDesktopIcon}`);
                if (iconElement) {
                    iconElement.classList.remove('selected');
                }
                selectedDesktopIcon = null;
            }
        }
        
        // Show context menu
        function showContextMenu(x, y, context) {
            const contextMenu = document.getElementById('desktop-context-menu');
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.display = 'block';
            
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu);
            }, 10);
        }
        
        // Hide context menu
        function hideContextMenu() {
            document.getElementById('desktop-context-menu').style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
        }
        
        // Update clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('clock').textContent = timeString;
        }
        
        // Initialize IndexedDB database
        function initDatabase() {
            const request = indexedDB.open('LegacyOSLinuxDB', 1);
            
            request.onerror = function(event) {
                console.error('Database error:', event.target.error);
                showDialog('Database Error', 'Unable to initialize database. Some features may not work properly.');
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // Create object store for files
                const fileStore = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                fileStore.createIndex('parentId', 'parentId', { unique: false });
                fileStore.createIndex('path', 'path', { unique: false });
                fileStore.createIndex('type', 'type', { unique: false });
                
                // Create object store for settings
                db.createObjectStore('settings', { keyPath: 'key' });
                
                // Add initial files
                const transaction = event.target.transaction;
                const files = transaction.objectStore('files');
                
                // Create root directory
                files.add({
                    id: 'root',
                    name: '/',
                    path: '/',
                    type: 'folder',
                    parentId: null,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                // Create home directory
                files.add({
                    id: 'home',
                    name: 'home',
                    path: '/home',
                    type: 'folder',
                    parentId: 'root',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                // Create user directory
                files.add({
                    id: 'user',
                    name: 'user',
                    path: '/home/user',
                    type: 'folder',
                    parentId: 'home',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                // Create documents folder
                files.add({
                    name: 'documents',
                    path: '/home/user/documents',
                    type: 'folder',
                    parentId: 'user',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                // Create a sample text file
                files.add({
                    name: 'readme.txt',
                    path: '/home/user/readme.txt',
                    type: 'file',
                    content: 'Welcome to LEGACY OS Linux Edition!\n\nThis is a sample text file.\nYou can edit this file using the text editor or CLI.\n\nType "help" in the terminal for available commands.',
                    parentId: 'user',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                // Create another sample file
                files.add({
                    name: 'todo.txt',
                    path: '/home/user/todo.txt',
                    type: 'file',
                    content: 'TODO List:\n1. Explore LEGACY OS\n2. Try CLI commands\n3. Create new files\n4. Learn about IndexedDB storage',
                    parentId: 'user',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                updateStatus('Database initialized');
                refreshFileManager();
                updateDBInfo();
            };
        }
        
        // Open terminal
        function openTerminal() {
            const termWindow = openWindow('terminal');
            document.getElementById('terminal-input').focus();
            
            // Add welcome message if terminal is empty
            const history = document.getElementById('terminal-history');
            if (history.children.length === 0) {
                addTerminalOutput('LEGACY OS Linux Terminal v0.1.0');
                addTerminalOutput('Type "help" for available commands');
                addTerminalOutput('');
            }
        }
        
        // Process CLI command
        function processCommand(command) {
            if (!command.trim()) {
                addTerminalOutput('');
                return;
            }
            
            // Add command to history
            commandHistory.push(command);
            historyIndex = commandHistory.length;
            
            // Show command in terminal
            addTerminalOutput(`[user@legacyos ~]$ ${command}`);
            
            // Parse command
            const parts = command.trim().split(/\s+/);
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            // Execute command
            if (COMMANDS[cmd]) {
                COMMANDS[cmd].execute(args);
            } else {
                addTerminalOutput(`bash: ${cmd}: command not found`, 'error');
                addTerminalOutput(`Type 'help' for available commands`);
            }
            
            // Scroll to bottom
            const terminalOutput = document.getElementById('terminal-output');
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }
        
        // Add output to terminal
        function addTerminalOutput(text, type = 'normal') {
            const history = document.getElementById('terminal-history');
            const output = document.createElement('div');
            output.className = 'cli-output';
            
            if (type === 'error') {
                output.classList.add('cli-error');
            } else if (type === 'success') {
                output.classList.add('cli-success');
            }
            
            output.textContent = text;
            history.appendChild(output);
            
            // Keep only last 100 lines
            if (history.children.length > 100) {
                history.removeChild(history.children[0]);
            }
        }
        
        // Navigate command history
        function navigateCommandHistory(direction) {
            const input = document.getElementById('terminal-input');
            
            if (commandHistory.length === 0) return;
            
            if (direction === 'up') {
                if (historyIndex > 0) {
                    historyIndex--;
                }
            } else if (direction === 'down') {
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                } else {
                    historyIndex = commandHistory.length;
                    input.value = '';
                    return;
                }
            }
            
            if (historyIndex >= 0 && historyIndex < commandHistory.length) {
                input.value = commandHistory[historyIndex];
            }
        }
        
        // Auto-complete command
        function autoCompleteCommand(partial) {
            if (!partial) return;
            
            const matches = Object.keys(COMMANDS).filter(cmd => 
                cmd.startsWith(partial.toLowerCase())
            );
            
            if (matches.length === 1) {
                document.getElementById('terminal-input').value = matches[0];
            } else if (matches.length > 1) {
                addTerminalOutput('');
                matches.forEach(cmd => {
                    addTerminalOutput(`${cmd} - ${COMMANDS[cmd].description}`);
                });
                addTerminalOutput('');
            }
        }
        
        // CLI Command Implementations
        
        function cmdHelp(args) {
            addTerminalOutput('Available commands:');
            addTerminalOutput('');
            
            for (const cmd in COMMANDS) {
                addTerminalOutput(`${cmd.padEnd(12)} - ${COMMANDS[cmd].description}`);
            }
            
            addTerminalOutput('');
            addTerminalOutput('Type "man [command]" for detailed help');
        }
        
        function cmdLs(args) {
            const path = args[0] || currentPath;
            
            // Convert path to folder ID
            getFolderByPath(path).then(folder => {
                if (!folder) {
                    addTerminalOutput(`ls: cannot access '${path}': No such file or directory`, 'error');
                    return;
                }
                
                // Get files in folder
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const parentIndex = fileStore.index('parentId');
                const request = parentIndex.getAll(folder.id);
                
                request.onsuccess = function(event) {
                    const files = event.target.result;
                    
                    if (files.length === 0) {
                        addTerminalOutput('(empty directory)');
                        return;
                    }
                    
                    // Group by type
                    const folders = files.filter(f => f.type === 'folder');
                    const fileList = files.filter(f => f.type === 'file');
                    
                    // Display
                    folders.forEach(folder => {
                        addTerminalOutput(`${folder.name}/`, 'directory');
                    });
                    
                    fileList.forEach(file => {
                        addTerminalOutput(file.name);
                    });
                    
                    addTerminalOutput(`Total: ${files.length} items`);
                };
            }).catch(error => {
                addTerminalOutput(`ls: cannot access '${path}': ${error}`, 'error');
            });
        }
        
        function cmdCd(args) {
            const path = args[0] || '/home/user';
            
            getFolderByPath(path).then(folder => {
                if (!folder) {
                    addTerminalOutput(`cd: ${path}: No such file or directory`, 'error');
                    return;
                }
                
                if (folder.type !== 'folder') {
                    addTerminalOutput(`cd: ${path}: Not a directory`, 'error');
                    return;
                }
                
                currentPath = folder.path;
                currentFolderId = folder.id;
                document.getElementById('current-path').textContent = `Path: ${currentPath}`;
                updateStatus(`Changed directory to ${currentPath}`);
            }).catch(error => {
                addTerminalOutput(`cd: ${path}: ${error}`, 'error');
            });
        }
        
        function cmdPwd(args) {
            addTerminalOutput(currentPath);
        }
        
        function cmdMkdir(args) {
            if (args.length === 0) {
                addTerminalOutput('mkdir: missing operand', 'error');
                addTerminalOutput('Try: mkdir [dirname]');
                return;
            }
            
            const dirName = args[0];
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + dirName;
            
            // Check if already exists
            getFileByPath(newPath).then(existing => {
                if (existing) {
                    addTerminalOutput(`mkdir: cannot create directory '${dirName}': File exists`, 'error');
                    return;
                }
                
                // Create new folder
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                
                fileStore.add({
                    name: dirName,
                    path: newPath,
                    type: 'folder',
                    parentId: currentFolderId,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                transaction.oncomplete = function() {
                    addTerminalOutput(`Directory '${dirName}' created`, 'success');
                    refreshFileManager();
                };
            });
        }
        
        function cmdTouch(args) {
            if (args.length === 0) {
                addTerminalOutput('touch: missing file operand', 'error');
                addTerminalOutput('Try: touch [filename]');
                return;
            }
            
            const fileName = args[0];
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            // Check if already exists
            getFileByPath(newPath).then(existing => {
                if (existing) {
                    addTerminalOutput(`File '${fileName}' already exists`, 'error');
                    return;
                }
                
                // Create new file
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                
                fileStore.add({
                    name: fileName,
                    path: newPath,
                    type: 'file',
                    content: '',
                    parentId: currentFolderId,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString()
                });
                
                transaction.oncomplete = function() {
                    addTerminalOutput(`File '${fileName}' created`, 'success');
                    refreshFileManager();
                };
            });
        }
        
        function cmdCat(args) {
            if (args.length === 0) {
                addTerminalOutput('cat: missing file operand', 'error');
                addTerminalOutput('Try: cat [filename]');
                return;
            }
            
            const fileName = args[0];
            const filePath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            getFileByPath(filePath).then(file => {
                if (!file) {
                    addTerminalOutput(`cat: ${fileName}: No such file or directory`, 'error');
                    return;
                }
                
                if (file.type !== 'file') {
                    addTerminalOutput(`cat: ${fileName}: Is a directory`, 'error');
                    return;
                }
                
                if (file.content) {
                    addTerminalOutput(file.content);
                } else {
                    addTerminalOutput('(empty file)');
                }
            });
        }
        
        function cmdRm(args) {
            if (args.length === 0) {
                addTerminalOutput('rm: missing operand', 'error');
                addTerminalOutput('Try: rm [filename]');
                return;
            }
            
            const fileName = args[0];
            const filePath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            getFileByPath(filePath).then(file => {
                if (!file) {
                    addTerminalOutput(`rm: cannot remove '${fileName}': No such file or directory`, 'error');
                    return;
                }
                
                if (file.type === 'folder') {
                    addTerminalOutput(`rm: cannot remove '${fileName}': Is a directory`, 'error');
                    addTerminalOutput('Use "rmdir" to remove directories');
                    return;
                }
                
                // Delete file
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                fileStore.delete(file.id);
                
                transaction.oncomplete = function() {
                    addTerminalOutput(`File '${fileName}' removed`, 'success');
                    refreshFileManager();
                };
            });
        }
        
        function cmdRmdir(args) {
            if (args.length === 0) {
                addTerminalOutput('rmdir: missing operand', 'error');
                addTerminalOutput('Try: rmdir [dirname]');
                return;
            }
            
            const dirName = args[0];
            const dirPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + dirName;
            
            getFileByPath(dirPath).then(folder => {
                if (!folder) {
                    addTerminalOutput(`rmdir: failed to remove '${dirName}': No such file or directory`, 'error');
                    return;
                }
                
                if (folder.type !== 'folder') {
                    addTerminalOutput(`rmdir: failed to remove '${dirName}': Not a directory`, 'error');
                    return;
                }
                
                // Check if directory is empty
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const parentIndex = fileStore.index('parentId');
                const request = parentIndex.getAll(folder.id);
                
                request.onsuccess = function(event) {
                    const children = event.target.result;
                    
                    if (children.length > 0) {
                        addTerminalOutput(`rmdir: failed to remove '${dirName}': Directory not empty`, 'error');
                        return;
                    }
                    
                    // Delete empty directory
                    const deleteTransaction = db.transaction(['files'], 'readwrite');
                    const deleteStore = deleteTransaction.objectStore('files');
                    deleteStore.delete(folder.id);
                    
                    deleteTransaction.oncomplete = function() {
                        addTerminalOutput(`Directory '${dirName}' removed`, 'success');
                        refreshFileManager();
                    };
                };
            });
        }
        
        function cmdClear(args) {
            document.getElementById('terminal-history').innerHTML = '';
        }
        
        function cmdEcho(args) {
            addTerminalOutput(args.join(' '));
        }
        
        function cmdDate(args) {
            const now = new Date();
            addTerminalOutput(now.toString());
        }
        
        function cmdWhoami(args) {
            addTerminalOutput('user');
        }
        
        function cmdMan(args) {
            if (args.length === 0) {
                addTerminalOutput('man: missing command name', 'error');
                addTerminalOutput('Try: man [command]');
                return;
            }
            
            const cmd = args[0].toLowerCase();
            
            if (COMMANDS[cmd]) {
                addTerminalOutput(`NAME: ${cmd} - ${COMMANDS[cmd].description}`);
                addTerminalOutput(`USAGE: ${COMMANDS[cmd].usage}`);
                addTerminalOutput('');
                
                // Add command-specific help
                if (cmd === 'ls') {
                    addTerminalOutput('DESCRIPTION:');
                    addTerminalOutput('  List information about files and directories');
                    addTerminalOutput('');
                    addTerminalOutput('EXAMPLES:');
                    addTerminalOutput('  ls           List current directory');
                    addTerminalOutput('  ls /home     List /home directory');
                } else if (cmd === 'cd') {
                    addTerminalOutput('DESCRIPTION:');
                    addTerminalOutput('  Change the current working directory');
                    addTerminalOutput('');
                    addTerminalOutput('EXAMPLES:');
                    addTerminalOutput('  cd /home/user    Change to /home/user');
                    addTerminalOutput('  cd ..            Move up one directory');
                }
            } else {
                addTerminalOutput(`No manual entry for ${cmd}`, 'error');
            }
        }
        
        // Utility function to get folder by path
        function getFolderByPath(path) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                // Normalize path
                if (path === '~') path = '/home/user';
                if (path === '.') path = currentPath;
                if (path === '..') {
                    // Get parent path
                    const parts = currentPath.split('/').filter(p => p);
                    parts.pop();
                    path = '/' + parts.join('/');
                    if (path === '') path = '/';
                }
                
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const pathIndex = fileStore.index('path');
                const request = pathIndex.get(path);
                
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };
                
                request.onerror = function(event) {
                    reject('Path not found');
                };
            });
        }
        
        // Utility function to get file by path
        function getFileByPath(path) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const pathIndex = fileStore.index('path');
                const request = pathIndex.get(path);
                
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };
                
                request.onerror = function(event) {
                    reject('File not found');
                };
            });
        }
        
        // Open file manager
        function openFileManager() {
            openWindow('file-manager');
            refreshFileManager();
        }
        
        // Refresh file manager
        function refreshFileManager() {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const parentIndex = fileStore.index('parentId');
            const request = parentIndex.getAll(currentFolderId);
            
            request.onsuccess = function(event) {
                const files = event.target.result;
                const fileList = document.getElementById('file-manager-list');
                fileList.innerHTML = '';
                
                // Display files and folders
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.id = file.id;
                    fileItem.dataset.name = file.name;
                    fileItem.dataset.type = file.type;
                    
                    const icon = file.type === 'folder' ? 'üìÅ' : 'üìÑ';
                    fileItem.innerHTML = `
                        <div style="font-size: 32px;">${icon}</div>
                        <span>${file.name}</span>
                    `;
                    
                    fileItem.addEventListener('dblclick', function() {
                        if (file.type === 'folder') {
                            navigateToFolder(file.id);
                        } else {
                            openFile(file);
                        }
                    });
                    
                    fileItem.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectFileItem(file);
                    });
                    
                    fileList.appendChild(fileItem);
                });
                
                // Update window title
                document.querySelector('#file-manager .window-header span').textContent = 
                    `File Manager - ${currentPath}`;
            };
        }
        
        // Navigate to a folder
        function navigateToFolder(folderId) {
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.get(folderId);
            
            request.onsuccess = function(event) {
                const folder = event.target.result;
                if (folder) {
                    currentFolderId = folder.id;
                    currentPath = folder.path;
                    document.getElementById('current-path').textContent = `Path: ${currentPath}`;
                    refreshFileManager();
                }
            };
        }
        
        // Navigate up one folder
        function navigateUp() {
            if (currentFolderId === 'root') return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.get(currentFolderId);
            
            request.onsuccess = function(event) {
                const file = event.target.result;
                if (file && file.parentId) {
                    const parentRequest = fileStore.get(file.parentId);
                    
                    parentRequest.onsuccess = function(event) {
                        const parent = event.target.result;
                        if (parent) {
                            currentFolderId = parent.id;
                            currentPath = parent.path;
                            document.getElementById('current-path').textContent = `Path: ${currentPath}`;
                            refreshFileManager();
                        }
                    };
                }
            };
        }
        
        // Select a file item
        function selectFileItem(file) {
            if (selectedFileItem) {
                const prevItem = document.querySelector(`.file-item[data-id="${selectedFileItem.id}"]`);
                if (prevItem) prevItem.classList.remove('selected');
            }
            
            selectedFileItem = file;
            const item = document.querySelector(`.file-item[data-id="${file.id}"]`);
            if (item) item.classList.add('selected');
        }
        
        // Open a file
        function openFile(file) {
            if (file.type === 'file') {
                openTextEditor(file);
            }
        }
        
        // Open text editor
        function openTextEditor(file) {
            const editorWindow = openWindow('text-editor');
            const textarea = document.getElementById('text-editor-area');
            
            if (file) {
                textarea.value = file.content || '';
                document.querySelector('#text-editor .window-header span').textContent = 
                    `Text Editor - ${file.name}`;
                editorWindow.dataset.fileId = file.id;
            } else {
                textarea.value = '';
                document.querySelector('#text-editor .window-header span').textContent = 'Text Editor - [unnamed]';
                delete editorWindow.dataset.fileId;
            }
            
            // Auto-save functionality
            textarea.addEventListener('input', function() {
                if (editorWindow.dataset.fileId) {
                    saveTextFile(editorWindow.dataset.fileId, textarea.value);
                }
            });
            
            textarea.focus();
        }
        
        // Save text file
        function saveTextFile(fileId, content) {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.get(fileId);
            
            request.onsuccess = function(event) {
                const file = event.target.result;
                if (file) {
                    file.content = content;
                    file.modified = new Date().toISOString();
                    fileStore.put(file);
                    
                    // Update status
                    updateStatus(`Saved ${file.name}`);
                }
            };
        }
        
        // Open system monitor
        function openSystemMonitor() {
            openWindow('system-monitor');
            updateSystemStats();
        }
        
        // Update system stats
        function updateSystemStats() {
            // Simulate system stats
            const memoryPercent = Math.floor(Math.random() * 20) + 40;
            const cpuPercent = Math.floor(Math.random() * 30) + 20;
            const storagePercent = Math.floor(Math.random() * 15) + 50;
            
            document.getElementById('memory-bar').style.width = `${memoryPercent}%`;
            document.getElementById('cpu-bar').style.width = `${cpuPercent}%`;
            document.getElementById('storage-bar').style.width = `${storagePercent}%`;
            
            document.getElementById('memory-percent').textContent = `${memoryPercent}%`;
            document.getElementById('cpu-percent').textContent = `${cpuPercent}%`;
            document.getElementById('storage-percent').textContent = `${storagePercent}%`;
            
            updateDBInfo();
        }
        
        // Update database info
        function updateDBInfo() {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const countRequest = fileStore.count();
            
            countRequest.onsuccess = function(event) {
                const fileCount = event.target.result;
                document.getElementById('db-info').textContent = 
                    `Files in database: ${fileCount}`;
            };
        }
        
        // Open help
        function openHelp() {
            openWindow('help-window');
        }
        
        // Open about
        function openAbout() {
            openWindow('about-window');
        }
        
        // Open a window
        function openWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            
            // Bring to front if already open
            if (windowElement.style.display === 'flex') {
                windowElement.style.zIndex = ++zIndexCounter;
                return windowElement;
            }
            
            // Show window
            windowElement.style.display = 'flex';
            windowElement.style.zIndex = ++zIndexCounter;
            
            // Position window
            const offset = activeWindows.length * 20;
            windowElement.style.top = `${50 + offset}px`;
            windowElement.style.left = `${50 + offset}px`;
            
            // Add to active windows
            activeWindows.push(windowId);
            
            // Add to taskbar
            addToTaskbar(windowId);
            
            return windowElement;
        }
        
        // Initialize all window controls
        function initAllWindowControls() {
            // Terminal controls
            document.getElementById('terminal-minimize').addEventListener('click', () => minimizeWindow('terminal'));
            document.getElementById('terminal-maximize').addEventListener('click', () => toggleMaximizeWindow('terminal'));
            document.getElementById('terminal-close').addEventListener('click', () => closeWindow('terminal'));
            
            // File manager controls
            document.getElementById('file-manager-minimize').addEventListener('click', () => minimizeWindow('file-manager'));
            document.getElementById('file-manager-maximize').addEventListener('click', () => toggleMaximizeWindow('file-manager'));
            document.getElementById('file-manager-close').addEventListener('click', () => closeWindow('file-manager'));
            
            // Text editor controls
            document.getElementById('text-editor-minimize').addEventListener('click', () => minimizeWindow('text-editor'));
            document.getElementById('text-editor-maximize').addEventListener('click', () => toggleMaximizeWindow('text-editor'));
            document.getElementById('text-editor-close').addEventListener('click', () => closeWindow('text-editor'));
            
            // System monitor controls
            document.getElementById('system-monitor-minimize').addEventListener('click', () => minimizeWindow('system-monitor'));
            document.getElementById('system-monitor-maximize').addEventListener('click', () => toggleMaximizeWindow('system-monitor'));
            document.getElementById('system-monitor-close').addEventListener('click', () => closeWindow('system-monitor'));
            
            // Help window controls
            document.getElementById('help-minimize').addEventListener('click', () => minimizeWindow('help-window'));
            document.getElementById('help-maximize').addEventListener('click', () => toggleMaximizeWindow('help-window'));
            document.getElementById('help-close').addEventListener('click', () => closeWindow('help-window'));
            
            // About window controls
            document.getElementById('about-minimize').addEventListener('click', () => minimizeWindow('about-window'));
            document.getElementById('about-maximize').addEventListener('click', () => toggleMaximizeWindow('about-window'));
            document.getElementById('about-close').addEventListener('click', () => closeWindow('about-window'));
        }
        
        // Initialize window dragging
        function initWindowDragging() {
            const windowHeaders = document.querySelectorAll('.window-header');
            
            windowHeaders.forEach(header => {
                header.addEventListener('mousedown', function(e) {
                    const windowElement = this.parentElement;
                    const isMaximized = windowElement.classList.contains('maximized');
                    
                    if (isMaximized) return;
                    
                    // Bring window to front
                    windowElement.style.zIndex = ++zIndexCounter;
                    
                    // Calculate initial positions
                    const rect = windowElement.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    const offsetY = e.clientY - rect.top;
                    
                    // Move window on mouse move
                    function onMouseMove(e) {
                        windowElement.style.left = `${e.clientX - offsetX}px`;
                        windowElement.style.top = `${e.clientY - offsetY}px`;
                    }
                    
                    // Remove event listeners on mouse up
                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        }
        
        // Minimize window
        function minimizeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            windowElement.style.display = 'none';
            updateTaskbarButton(windowId, false);
        }
        
        // Toggle maximize window
        function toggleMaximizeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            const isMaximized = windowElement.classList.contains('maximized');
            
            if (isMaximized) {
                windowElement.classList.remove('maximized');
                windowElement.style.width = '';
                windowElement.style.height = '';
                windowElement.style.top = '50px';
                windowElement.style.left = '50px';
            } else {
                windowElement.classList.add('maximized');
            }
        }
        
        // Close window
        function closeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            windowElement.style.display = 'none';
            
            // Remove from active windows
            const index = activeWindows.indexOf(windowId);
            if (index > -1) {
                activeWindows.splice(index, 1);
            }
            
            // Remove from taskbar
            removeFromTaskbar(windowId);
        }
        
        // Add window to taskbar
        function addToTaskbar(windowId) {
            const taskbarPrograms = document.getElementById('taskbar-programs');
            const windowElement = document.getElementById(windowId);
            const windowTitle = windowElement.querySelector('.window-header span').textContent;
            
            // Check if already in taskbar
            if (document.getElementById(`taskbar-${windowId}`)) return;
            
            const taskbarButton = document.createElement('div');
            taskbarButton.className = 'taskbar-program';
            taskbarButton.id = `taskbar-${windowId}`;
            taskbarButton.textContent = windowTitle;
            
            taskbarButton.addEventListener('click', function() {
                const windowElement = document.getElementById(windowId);
                const isVisible = windowElement.style.display === 'flex';
                
                if (isVisible) {
                    minimizeWindow(windowId);
                } else {
                    windowElement.style.display = 'flex';
                    windowElement.style.zIndex = ++zIndexCounter;
                    updateTaskbarButton(windowId, true);
                }
            });
            
            taskbarPrograms.appendChild(taskbarButton);
            updateTaskbarButton(windowId, true);
        }
        
        // Update taskbar button state
        function updateTaskbarButton(windowId, isActive) {
            const button = document.getElementById(`taskbar-${windowId}`);
            if (button) {
                button.classList.toggle('active', isActive);
            }
        }
        
        // Remove window from taskbar
        function removeFromTaskbar(windowId) {
            const button = document.getElementById(`taskbar-${windowId}`);
            if (button) {
                button.remove();
            }
        }
        
        // Show dialog
        function showDialog(title, message, showInput = false, dialogType = 'info') {
            const modal = document.getElementById('modal-overlay');
            const modalDialog = document.getElementById('modal-dialog');
            
            document.getElementById('modal-header').textContent = title;
            document.getElementById('modal-body').innerHTML = showInput 
                ? `<p>${message}</p><input type="text" id="dialog-input" class="text-editor" style="width: 100%; margin-top: 8px;" autofocus>`
                : `<p>${message}</p>`;
            
            modalDialog.setAttribute('data-type', dialogType);
            modal.style.display = 'flex';
            
            // Focus input if present
            if (showInput) {
                setTimeout(() => {
                    document.getElementById('dialog-input').focus();
                }, 10);
            }
        }
        
        // Hide modal
        function hideModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }
        
        // Handle dialog OK button
        function handleDialogOk(dialogType) {
            const input = document.getElementById('dialog-input');
            
            switch(dialogType) {
                case 'new-folder':
                    if (input && input.value.trim()) {
                        createFolderInDB(input.value.trim());
                    }
                    break;
                    
                case 'new-file':
                    if (input && input.value.trim()) {
                        createFileInDB(input.value.trim(), '');
                    }
                    break;
                    
                case 'delete-file':
                    if (selectedFileItem) {
                        deleteFileFromDB(selectedFileItem.id);
                    }
                    break;
                    
                case 'shutdown':
                    // Show welcome screen again
                    document.getElementById('welcome-screen').style.display = 'flex';
                    // Close all windows
                    activeWindows.forEach(windowId => {
                        document.getElementById(windowId).style.display = 'none';
                        removeFromTaskbar(windowId);
                    });
                    activeWindows = [];
                    updateStatus('System shut down');
                    break;
            }
            
            hideModal();
        }
        
        // Create folder in database
        function createFolderInDB(folderName) {
            if (!db) return;
            
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + folderName;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            
            fileStore.add({
                name: folderName,
                path: newPath,
                type: 'folder',
                parentId: currentFolderId,
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            });
            
            transaction.oncomplete = function() {
                refreshFileManager();
                updateStatus(`Folder "${folderName}" created`);
                addTerminalOutput(`Directory '${folderName}' created`, 'success');
            };
        }
        
        // Create file in database
        function createFileInDB(fileName, content) {
            if (!db) return;
            
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            
            fileStore.add({
                name: fileName,
                path: newPath,
                type: 'file',
                content: content,
                parentId: currentFolderId,
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            });
            
            transaction.oncomplete = function() {
                refreshFileManager();
                updateStatus(`File "${fileName}" created`);
                addTerminalOutput(`File '${fileName}' created`, 'success');
            };
        }
        
        // Delete file from database
        function deleteFileFromDB(fileId) {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            fileStore.delete(fileId);
            
            transaction.oncomplete = function() {
                refreshFileManager();
                selectedFileItem = null;
                updateStatus('File deleted');
            };
        }
        
        // Update status bar
        function updateStatus(message) {
            const statusBar = document.getElementById('status-bar');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            statusBar.style.display = 'block';
            
            setTimeout(() => {
                statusBar.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
