<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GalaxyCraft - Mining & Exploration</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Orbitron', 'Arial', sans-serif;
    }
    body {
      background: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #cosmicCanvas {
      flex: 1;
      width: 100%;
      touch-action: none;
      position: relative;
    }
    .controls {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(20, 20, 50, 0.9);
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      backdrop-filter: blur(5px);
      z-index: 10;
    }
    .control-item {
      flex: 1;
      min-width: 80px;
      text-align: center;
    }
    button {
      background: #4a90e2;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s, background 0.2s;
    }
    button:hover {
      background: #357abd;
    }
    button.active {
      background: #ff4444;
    }
    button:active {
      transform: scale(0.95);
    }
    .prompt {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
      max-width: 90%;
      text-align: center;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 5;
    }
    .prompt.active {
      opacity: 1;
    }
    .hud {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.4;
      z-index: 1;
    }
    .hud::before {
      content: '';
      position: absolute;
      top: 10%;
      left: 10%;
      right: 10%;
      bottom: 10%;
      border: 2px solid rgba(74, 144, 226, 0);
      border-radius: 20px;
      box-shadow: none;
    }
    .hud::after {
      content: '+';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #4a90e2;
      font-size: 24px;
    }
    .throttle-indicator {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      color: #4a90e2;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 5;
    }
    .throttle-indicator.active {
      opacity: 1;
    }
    .status-overlay {
      position: absolute;
      top: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      padding: 5px 10px;
      font-size: 12px;
      text-align: left;
      color: #fff;
      text-shadow: 0 0 2px #000;
      z-index: 5;
      pointer-events: none;
    }
    .console {
      position: absolute;
      bottom: 60px;
      width: 100%;
      height: 25%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      z-index: 5;
      padding: 5px;
    }
    .console-log {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
      color: #fff;
      text-shadow: 0 0 2px #000;
      padding: 5px;
    }
    .console-log p {
      margin: 2px 0;
    }
    .console-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #4a90e2;
      color: #fff;
      padding: 5px;
      font-size: 12px;
      outline: none;
    }
    .console-input::placeholder {
      color: #aaa;
    }
    .console::-webkit-scrollbar {
      width: 8px;
    }
    .console::-webkit-scrollbar-thumb {
      background: #4a90e2;
      border-radius: 4px;
    }
    .camera-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 10px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .camera-controls button {
      padding: 8px 12px;
      font-size: 14px;
    }
    .resource-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 10px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 14px;
    }
    .resource-item {
      display: flex;
      justify-content: space-between;
      width: 200px;
    }
    .testing-banner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 0, 0, 0.7);
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 24px;
      font-weight: bold;
      z-index: 100;
      pointer-events: none;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
    .crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid #0f0;
      border-radius: 50%;
      pointer-events: none;
      z-index: 5;
    }
    .light-speed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(74, 144, 226, 0.2) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      z-index: 90;
      transition: opacity 1s;
    }
    .light-speed.active {
      opacity: 0.8;
    }
    .tour-info {
      position: absolute;
      bottom: 150px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      text-align: center;
      z-index: 10;
    }
    /* New UI Elements */
    .draggable-window {
      position: absolute;
      background: rgba(10, 20, 40, 0.9);
      border: 1px solid #4a90e2;
      border-radius: 8px;
      backdrop-filter: blur(5px);
      overflow: hidden;
      min-width: 300px;
      min-height: 200px;
      z-index: 20;
      box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
    }
    .window-header {
      background: rgba(20, 40, 80, 0.9);
      padding: 8px 12px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #4a90e2;
    }
    .window-title {
      font-weight: bold;
      font-size: 14px;
    }
    .window-controls {
      display: flex;
      gap: 5px;
    }
    .window-control {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      padding: 0 5px;
    }
    .window-content {
      padding: 10px;
      height: calc(100% - 36px);
      overflow: auto;
    }
    .chat-tabs {
      display: flex;
      border-bottom: 1px solid #4a90e2;
      margin-bottom: 10px;
    }
    .chat-tab {
      padding: 5px 10px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .chat-tab.active {
      border-bottom: 2px solid #4a90e2;
      background: rgba(74, 144, 226, 0.2);
    }
    .chat-messages {
      height: calc(100% - 60px);
      overflow-y: auto;
      margin-bottom: 10px;
      font-size: 12px;
    }
    .chat-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #4a90e2;
      color: #fff;
      padding: 5px;
      font-size: 12px;
    }
    .ship-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      font-size: 12px;
    }
    .stat-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
      margin-top: 2px;
    }
    .stat-fill {
      height: 100%;
      background: #4a90e2;
      border-radius: 5px;
    }
    .minimap {
      position: absolute;
      bottom: 150px;
      right: 10px;
      width: 200px;
      height: 200px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #4a90e2;
      border-radius: 8px;
      z-index: 10;
      overflow: hidden;
    }
    .minimap-content {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .minimap-point {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    .minimap-player {
      background: #4a90e2;
      width: 6px;
      height: 6px;
      box-shadow: 0 0 5px #4a90e2;
    }
    .minimap-resource {
      background: #00ff00;
    }
    .minimap-planet {
      background: #44aaff;
      width: 8px;
      height: 8px;
    }
    .minimap-home {
      background: #00ff00;
      width: 10px;
      height: 10px;
      box-shadow: 0 0 8px #00ff00;
    }
    .ui-button {
      position: absolute;
      background: rgba(20, 40, 80, 0.9);
      border: 1px solid #4a90e2;
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 15;
      font-size: 12px;
    }
    .ui-button:hover {
      background: rgba(30, 60, 120, 0.9);
    }
    #chatButton {
      bottom: 300px;
      right: 10px;
    }
    #inventoryButton {
      bottom: 270px;
      right: 10px;
    }
    #shipButton {
      bottom: 240px;
      right: 10px;
    }
    #mapButton {
      bottom: 210px;
      right: 10px;
    }
    .mining-laser {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 0;
      background: linear-gradient(to right, #00ff00, #ffff00, #00ff00);
      transform-origin: top center;
      opacity: 0;
      z-index: 5;
    }
    .mining-laser.active {
      animation: miningBeam 0.5s;
    }
    @keyframes miningBeam {
      0% { height: 0; opacity: 1; }
      50% { height: 100px; opacity: 1; }
      100% { height: 0; opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="cosmicCanvas">
    <div class="hud"></div>
    <div class="crosshair"></div>
    <div class="mining-laser"></div>
    <div id="statusOverlay" class="status-overlay"></div>
    <div id="throttleIndicator" class="throttle-indicator"></div>
    <div id="lightSpeedEffect" class="light-speed"></div>
    <div id="console" class="console">
      <div id="consoleLog" class="console-log"></div>
      <input id="consoleInput" class="console-input" type="text" placeholder="Type /help for commands..." autocomplete="off">
    </div>
    <div class="testing-banner">GALAXYCRAFT MINING PROTOTYPE</div>
    <div id="tourInfo" class="tour-info"></div>
    <div class="camera-controls">
      <button id="cameraLockBtn">Lock Camera</button>
      <button id="resetViewBtn">Reset View</button>
      <button id="freeLookBtn">Free Look</button>
    </div>
    <div class="resource-panel">
      <div class="resource-item"><span>Credits:</span> <span id="creditsValue">0</span></div>
      <div class="resource-item"><span>Ores:</span> <span id="oresValue">0</span></div>
      <div class="resource-item"><span>Crystals:</span> <span id="crystalsValue">0</span></div>
      <div class="resource-item"><span>Fuel:</span> <span id="fuelValue">100</span></div>
      <div class="resource-item"><span>Energy:</span> <span id="energyValue">100</span></div>
      <div class="resource-item"><span>Ship Level:</span> <span id="shipLevel">1</span></div>
      <div class="resource-item"><span>Cargo:</span> <span id="cargoValue">0/50</span></div>
    </div>
    <div class="minimap">
      <div class="minimap-content" id="minimapContent"></div>
    </div>
    
    <!-- UI Buttons -->
    <button class="ui-button" id="chatButton">Chat</button>
    <button class="ui-button" id="inventoryButton">Inventory</button>
    <button class="ui-button" id="shipButton">Ship</button>
    <button class="ui-button" id="mapButton">Map</button>
    
    <!-- Draggable Windows -->
    <div class="draggable-window" id="chatWindow" style="left: 50px; top: 50px; display: none;">
      <div class="window-header">
        <div class="window-title">Chat</div>
        <div class="window-controls">
          <button class="window-control">-</button>
          <button class="window-control" onclick="document.getElementById('chatWindow').style.display = 'none'">×</button>
        </div>
      </div>
      <div class="window-content">
        <div class="chat-tabs">
          <div class="chat-tab active" data-tab="sector">Sector</div>
          <div class="chat-tab" data-tab="universal">Universal</div>
          <div class="chat-tab" data-tab="auction">Auction</div>
        </div>
        <div class="chat-messages" id="chatMessages">
          <p>System: Welcome to GalaxyCraft Mining Prototype!</p>
          <p>System: Type /help for commands</p>
        </div>
        <input type="text" class="chat-input" placeholder="Type message...">
      </div>
    </div>
    
    <div class="draggable-window" id="inventoryWindow" style="left: 100px; top: 200px; display: none;">
      <div class="window-header">
        <div class="window-title">Inventory</div>
        <div class="window-controls">
          <button class="window-control">-</button>
          <button class="window-control" onclick="document.getElementById('inventoryWindow').style.display = 'none'">×</button>
        </div>
      </div>
      <div class="window-content">
        <h3>Resources</h3>
        <div class="resource-item"><span>Iron Ore:</span> <span id="invIron">0</span></div>
        <div class="resource-item"><span>Copper Ore:</span> <span id="invCopper">0</span></div>
        <div class="resource-item"><span>Silver Ore:</span> <span id="invSilver">0</span></div>
        <div class="resource-item"><span>Gold Ore:</span> <span id="invGold">0</span></div>
        <div class="resource-item"><span>Crystals:</span> <span id="invCrystals">0</span></div>
        <div class="resource-item"><span>Rare Parts:</span> <span id="invRare">0</span></div>
        <h3>Equipment</h3>
        <p>Mining Laser: Level 1</p>
        <p>Cargo Bay: 50 units</p>
      </div>
    </div>
    
    <div class="draggable-window" id="shipWindow" style="left: 150px; top: 350px; display: none;">
      <div class="window-header">
        <div class="window-title">Ship Status</div>
        <div class="window-controls">
          <button class="window-control">-</button>
          <button class="window-control" onclick="document.getElementById('shipWindow').style.display = 'none'">×</button>
        </div>
      </div>
      <div class="window-content">
        <div class="ship-stats">
          <div>Hull Integrity:</div>
          <div>100%</div>
          <div class="stat-bar"><div class="stat-fill" style="width: 100%"></div></div>
          
          <div>Fuel:</div>
          <div id="shipFuel">100%</div>
          <div class="stat-bar"><div class="stat-fill" style="width: 100%"></div></div>
          
          <div>Energy:</div>
          <div id="shipEnergy">100%</div>
          <div class="stat-bar"><div class="stat-fill" style="width: 100%"></div></div>
          
          <div>Mining Power:</div>
          <div>Level 1</div>
          <div class="stat-bar"><div class="stat-fill" style="width: 20%"></div></div>
        </div>
        <button style="width: 100%; margin-top: 10px;" onclick="upgradeShip()">Upgrade Ship (500 Credits)</button>
      </div>
    </div>
  </div>
  <div class="controls">
    <div class="control-item">
      <button id="throttleBtn">Full Throttle</button>
    </div>
    <div class="control-item">
      <button id="mineBtn">Mine (F)</button>
    </div>
    <div class="control-item">
      <button id="scanBtn">Scan</button>
    </div>
    <div class="control-item">
      <button id="addNode">Add Node</button>
    </div>
    <div class="control-item">
      <button id="autopilotBtn">Auto Pilot</button>
    </div>
    <div class="control-item">
      <button id="cameraBtn">Camera</button>
    </div>
    <div class="control-item">
      <button id="teleportBtn">Teleport</button>
    </div>
    <div class="control-item">
      <button id="resetBtn">Reset</button>
    </div>
    <div class="control-item">
      <button id="homeBtn">HOME</button>
    </div>
  </div>
  <div id="prompt" class="prompt"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script>
    window.onload = () => {
      try {
        // Scene setup
        if (!window.THREE) throw new Error('Three.js not loaded');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: 'high-performance' });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 1);
        const canvas = document.getElementById('cosmicCanvas');
        if (!canvas) throw new Error('Canvas element not found');
        canvas.appendChild(renderer.domElement);

        camera.position.set(0, 0, 0);
        
        // Add some stars to the background
        const starGeometry = new THREE.BufferGeometry();
        const starVertices = [];
        for (let i = 0; i < 15000; i++) {
          const x = (Math.random() - 0.5) * 3000;
          const y = (Math.random() - 0.5) * 3000;
          const z = (Math.random() - 0.5) * 3000;
          starVertices.push(x, y, z);
        }
        starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
        const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 1.2 });
        const stars = new THREE.Points(starGeometry, starMaterial);
        scene.add(stars);

        // Nebula effects
        function createNebula() {
          const nebulaGeometry = new THREE.BufferGeometry();
          const nebulaVertices = [];
          const nebulaColors = [];
          const nebulaSize = 500;
          
          for (let i = 0; i < 5000; i++) {
            const x = (Math.random() - 0.5) * nebulaSize;
            const y = (Math.random() - 0.5) * nebulaSize;
            const z = (Math.random() - 0.5) * nebulaSize;
            nebulaVertices.push(x, y, z);
            
            // Color based on position for gradient effect
            const r = 0.2 + Math.abs(x) / nebulaSize * 0.8;
            const g = 0.2 + Math.abs(y) / nebulaSize * 0.8;
            const b = 0.5 + Math.abs(z) / nebulaSize * 0.5;
            nebulaColors.push(r, g, b);
          }
          
          nebulaGeometry.setAttribute('position', new THREE.Float32BufferAttribute(nebulaVertices, 3));
          nebulaGeometry.setAttribute('color', new THREE.Float32BufferAttribute(nebulaColors, 3));
          
          const nebulaMaterial = new THREE.PointsMaterial({ 
            size: 3, 
            vertexColors: true,
            transparent: true,
            opacity: 0.7
          });
          
          const nebula = new THREE.Points(nebulaGeometry, nebulaMaterial);
          nebula.position.set(
            (Math.random() - 0.5) * 2000,
            (Math.random() - 0.5) * 2000,
            (Math.random() - 0.5) * 2000
          );
          
          nebula.userData = {
            rotationSpeed: new THREE.Vector3(
              (Math.random() - 0.5) * 0.001,
              (Math.random() - 0.5) * 0.001,
              (Math.random() - 0.5) * 0.001
            )
          };
          
          scene.add(nebula);
          return nebula;
        }
        
        // Create multiple nebulae
        const nebulae = [];
        for (let i = 0; i < 8; i++) {
          nebulae.push(createNebula());
        }

        // Shared resources
        const sharedMaterials = {
          resource: new THREE.MeshBasicMaterial({ color: 0x00ff00 }),
          ore: new THREE.MeshBasicMaterial({ color: 0xcccccc }),
          crystal: new THREE.MeshBasicMaterial({ color: 0x8844ff }),
          node: new THREE.MeshBasicMaterial({ color: 0xff33cc }),
          line: new THREE.LineBasicMaterial({ color: 0x00ff00 }),
          planet: new THREE.MeshBasicMaterial({ color: 0x44aaff }),
          homePlanet: new THREE.MeshBasicMaterial({ 
            color: 0x00ff00,
            emissive: 0x00ff00,
            emissiveIntensity: 0.5
          })
        };
        const sharedGeometries = {
          resource: new THREE.SphereGeometry(10, 12, 12),
          node: new THREE.BoxGeometry(15, 15, 15),
          planet: new THREE.SphereGeometry(40, 32, 32),
          ship: new THREE.ConeGeometry(10, 30, 8)
        };

        // Game state
        let resources = [];
        let planets = [];
        let nodes = [];
        let nodeLines = [];
        let throttle = 0;
        let rotation = { x: 0, y: 0 };
        let velocity = new THREE.Vector3(0, 0, 0);
        let lastTime = performance.now();
        let entityCount = 0;
        let autopilotActive = false;
        let currentNodeIndex = 0;
        let cameraLocked = false;
        let freeLookActive = false;
        let isMouseDown = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let homePlanet = null;
        let playerShip = null;
        
        // Player state
        const playerState = {
          credits: 0,
          ores: 0,
          crystals: 0,
          fuel: 100,
          energy: 100,
          shipLevel: 1,
          cargoCapacity: 50,
          currentCargo: 0,
          inventory: {
            iron: 0,
            copper: 0,
            silver: 0,
            gold: 0,
            crystals: 0,
            rareParts: 0
          },
          autopilotTarget: null,
          returningHome: false
        };

        // Console and status
        const statusOverlay = document.getElementById('statusOverlay');
        const consoleLog = document.getElementById('consoleLog');
        const consoleInput = document.getElementById('consoleInput');
        const tourInfo = document.getElementById('tourInfo');
        const lightSpeedEffect = document.getElementById('lightSpeedEffect');
        const maxLogMessages = 50;
        let logMessages = [];

        function addConsoleMessage(message) {
          const timestamp = new Date().toLocaleTimeString();
          logMessages.push(`[${timestamp}] ${message}`);
          if (logMessages.length > maxLogMessages) {
            logMessages.shift();
          }
          consoleLog.innerHTML = logMessages.map(msg => `<p>${msg}</p>`).join('');
          consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function updateStatusOverlay() {
          statusOverlay.textContent = `Autopilot: ${autopilotActive ? 'ON' : 'OFF'} | Cargo: ${playerState.currentCargo}/${playerState.cargoCapacity} | Entities: ${entityCount}`;
        }

        function updateResourceDisplay() {
          document.getElementById('creditsValue').textContent = playerState.credits;
          document.getElementById('oresValue').textContent = playerState.ores;
          document.getElementById('crystalsValue').textContent = playerState.crystals;
          document.getElementById('fuelValue').textContent = Math.floor(playerState.fuel);
          document.getElementById('energyValue').textContent = Math.floor(playerState.energy);
          document.getElementById('shipLevel').textContent = playerState.shipLevel;
          document.getElementById('cargoValue').textContent = `${playerState.currentCargo}/${playerState.cargoCapacity}`;
          
          // Update inventory window if open
          document.getElementById('invIron').textContent = playerState.inventory.iron;
          document.getElementById('invCopper').textContent = playerState.inventory.copper;
          document.getElementById('invSilver').textContent = playerState.inventory.silver;
          document.getElementById('invGold').textContent = playerState.inventory.gold;
          document.getElementById('invCrystals').textContent = playerState.inventory.crystals;
          document.getElementById('invRare').textContent = playerState.inventory.rareParts;
          
          // Update ship window if open
          document.getElementById('shipFuel').textContent = `${Math.floor(playerState.fuel)}%`;
          document.querySelectorAll('.stat-fill')[1].style.width = `${playerState.fuel}%`;
          document.getElementById('shipEnergy').textContent = `${Math.floor(playerState.energy)}%`;
          document.querySelectorAll('.stat-fill')[2].style.width = `${playerState.energy}%`;
        }

        function showPrompt(message) {
          const prompt = document.getElementById('prompt');
          prompt.textContent = message;
          prompt.classList.add('active');
          setTimeout(() => prompt.classList.remove('active'), 2000);
        }

        // Initialize resources and environment
        function initializeGameEnvironment() {
          // Create home planet (neon green glowing)
          homePlanet = new THREE.Mesh(sharedGeometries.planet, sharedMaterials.homePlanet);
          homePlanet.position.set(0, 0, 0);
          homePlanet.userData = {
            type: 'home',
            name: 'Home Planet',
            size: 60
          };
          scene.add(homePlanet);
          planets.push(homePlanet);
          entityCount++;

          // Create player ship
          playerShip = new THREE.Mesh(sharedGeometries.ship, new THREE.MeshBasicMaterial({ color: 0x4a90e2 }));
          playerShip.position.set(0, 0, 100);
          scene.add(playerShip);
          entityCount++;

          // Create test resources
          for (let i = 0; i < 100; i++) {
            const resourceType = Math.random() > 0.8 ? 'crystal' : 
                                Math.random() > 0.6 ? 'gold' :
                                Math.random() > 0.4 ? 'silver' :
                                Math.random() > 0.2 ? 'copper' : 'iron';
            
            let material, color;
            switch(resourceType) {
              case 'crystal':
                material = sharedMaterials.crystal;
                color = 0x8844ff;
                break;
              case 'gold':
                material = new THREE.MeshBasicMaterial({ color: 0xffcc00 });
                color = 0xffcc00;
                break;
              case 'silver':
                material = new THREE.MeshBasicMaterial({ color: 0xeeeeee });
                color = 0xeeeeee;
                break;
              case 'copper':
                material = new THREE.MeshBasicMaterial({ color: 0xff8800 });
                color = 0xff8800;
                break;
              default: // iron
                material = sharedMaterials.ore;
                color = 0xcccccc;
            }
            
            const resource = new THREE.Mesh(sharedGeometries.resource, material);
            
            const distance = 200 + Math.random() * 800;
            const angle = Math.random() * Math.PI * 2;
            
            resource.position.set(
              Math.cos(angle) * distance,
              (Math.random() - 0.5) * 500,
              Math.sin(angle) * distance
            );
            
            resource.userData = {
              type: resourceType,
              value: Math.floor(Math.random() * 10) + 5,
              originalPosition: resource.position.clone(),
              collected: false
            };
            
            scene.add(resource);
            resources.push(resource);
            entityCount++;
          }
          
          // Create regular planets
          for (let i = 0; i < 8; i++) {
            const planet = new THREE.Mesh(sharedGeometries.planet, sharedMaterials.planet);
            
            const distance = 600 + Math.random() * 1000;
            const angle = Math.random() * Math.PI * 2;
            
            planet.position.set(
              Math.cos(angle) * distance,
              (Math.random() - 0.5) * 600,
              Math.sin(angle) * distance
            );
            
            planet.userData = {
              name: `Planet ${i+1}`,
              type: 'planet',
              size: 30 + Math.random() * 30
            };
            
            scene.add(planet);
            planets.push(planet);
            entityCount++;
          }
          
          addConsoleMessage("GalaxyCraft Mining Prototype initialized");
          addConsoleMessage("Use WASD to navigate, F to mine, R to scan");
          addConsoleMessage("Press H to return to home planet");
          updateStatusOverlay();
          updateResourceDisplay();
          updateMinimap();
        }

        // Update minimap with all entities
        function updateMinimap() {
          const minimapContent = document.getElementById('minimapContent');
          minimapContent.innerHTML = '';
          
          // Add player to minimap
          const playerPoint = document.createElement('div');
          playerPoint.className = 'minimap-point minimap-player';
          playerPoint.style.left = '50%';
          playerPoint.style.top = '50%';
          minimapContent.appendChild(playerPoint);
          
          // Add home planet to minimap
          const homePoint = document.createElement('div');
          homePoint.className = 'minimap-point minimap-home';
          
          // Calculate relative position to player
          const homePos = new THREE.Vector3().subVectors(homePlanet.position, playerShip.position);
          homePos.multiplyScalar(0.05); // Scale down for minimap
          
          homePoint.style.left = `${50 + homePos.x}%`;
          homePoint.style.top = `${50 + homePos.z}%`;
          minimapContent.appendChild(homePoint);
          
          // Add resources to minimap
          resources.forEach(resource => {
            if (!resource.userData.collected) {
              const resourcePoint = document.createElement('div');
              resourcePoint.className = 'minimap-point minimap-resource';
              
              // Calculate relative position to player
              const resPos = new THREE.Vector3().subVectors(resource.position, playerShip.position);
              resPos.multiplyScalar(0.05); // Scale down for minimap
              
              resourcePoint.style.left = `${50 + resPos.x}%`;
              resourcePoint.style.top = `${50 + resPos.z}%`;
              minimapContent.appendChild(resourcePoint);
            }
          });
          
          // Add planets to minimap
          planets.forEach(planet => {
            if (planet !== homePlanet) {
              const planetPoint = document.createElement('div');
              planetPoint.className = 'minimap-point minimap-planet';
              
              // Calculate relative position to player
              const planetPos = new THREE.Vector3().subVectors(planet.position, playerShip.position);
              planetPos.multiplyScalar(0.05); // Scale down for minimap
              
              planetPoint.style.left = `${50 + planetPos.x}%`;
              planetPoint.style.top = `${50 + planetPos.z}%`;
              minimapContent.appendChild(planetPoint);
            }
          });
        }

        // Mining function
        function mineResource() {
          if (playerState.energy < 5) {
            addConsoleMessage("Not enough energy to mine");
            return;
          }
          
          if (playerState.currentCargo >= playerState.cargoCapacity) {
            addConsoleMessage("Cargo full! Return to home planet to unload");
            return;
          }
          
          // Find nearest resource
          let nearestResource = null;
          let minDistance = Infinity;
          
          resources.forEach(resource => {
            if (!resource.userData.collected) {
              const distance = resource.position.distanceTo(playerShip.position);
              if (distance < 100 && distance < minDistance) {
                minDistance = distance;
                nearestResource = resource;
              }
            }
          });
          
          if (nearestResource) {
            // Animate mining laser
            const laser = document.querySelector('.mining-laser');
            laser.classList.add('active');
            setTimeout(() => laser.classList.remove('active'), 500);
            
            // Consume energy
            playerState.energy -= 5;
            
            // Collect resource
            nearestResource.userData.collected = true;
            nearestResource.visible = false;
            
            // Add to inventory
            const resourceType = nearestResource.userData.type;
            const value = nearestResource.userData.value;
            
            switch(resourceType) {
              case 'crystal':
                playerState.crystals += value;
                playerState.inventory.crystals += value;
                break;
              case 'gold':
                playerState.ores += value;
                playerState.inventory.gold += value;
                break;
              case 'silver':
                playerState.ores += value;
                playerState.inventory.silver += value;
                break;
              case 'copper':
                playerState.ores += value;
                playerState.inventory.copper += value;
                break;
              default: // iron
                playerState.ores += value;
                playerState.inventory.iron += value;
            }
            
            playerState.currentCargo += value;
            playerState.credits += value * 2;
            
            addConsoleMessage(`Mined ${value} units of ${resourceType}`);
            updateResourceDisplay();
            
            // Check if cargo is full
            if (playerState.currentCargo >= playerState.cargoCapacity) {
              addConsoleMessage("Cargo full! Enable autopilot to return home automatically");
            }
          } else {
            addConsoleMessage("No mineable resources nearby");
          }
        }

        // Autopilot function
        function toggleAutopilot() {
          if (autopilotActive) {
            autopilotActive = false;
            addConsoleMessage("Autopilot disabled");
          } else {
            // If cargo is full, return to home planet
            if (playerState.currentCargo >= playerState.cargoCapacity) {
              playerState.returningHome = true;
              playerState.autopilotTarget = homePlanet;
              addConsoleMessage("Autopilot engaged: Returning to home planet");
            } else {
              // Find nearest resource
              let nearestResource = null;
              let minDistance = Infinity;
              
              resources.forEach(resource => {
                if (!resource.userData.collected) {
                  const distance = resource.position.distanceTo(playerShip.position);
                  if (distance < minDistance) {
                    minDistance = distance;
                    nearestResource = resource;
                  }
                }
              });
              
              if (nearestResource) {
                playerState.returningHome = false;
                playerState.autopilotTarget = nearestResource;
                addConsoleMessage("Autopilot engaged: Navigating to nearest resource");
              } else {
                addConsoleMessage("No resources available for autopilot");
                return;
              }
            }
            
            autopilotActive = true;
          }
          
          updateStatusOverlay();
        }

        // Update autopilot navigation
        function updateAutopilot(deltaTime) {
          if (!autopilotActive || !playerState.autopilotTarget) return;
          
          const target = playerState.autopilotTarget;
          const direction = new THREE.Vector3().subVectors(target.position, playerShip.position);
          const distance = direction.length();
          
          // Normalize direction
          direction.normalize();
          
          // Apply velocity toward target
          velocity.x = direction.x * 100 * deltaTime;
          velocity.y = direction.y * 100 * deltaTime;
          velocity.z = direction.z * 100 * deltaTime;
          
          // Rotate ship toward target
          playerShip.lookAt(target.position);
          
          // If close to target
          if (distance < 50) {
            if (playerState.returningHome) {
              // Unload cargo at home planet
              playerState.currentCargo = 0;
              addConsoleMessage("Cargo unloaded at home planet");
              updateResourceDisplay();
              
              // Find next resource
              playerState.returningHome = false;
              let nearestResource = null;
              let minDistance = Infinity;
              
              resources.forEach(resource => {
                if (!resource.userData.collected) {
                  const dist = resource.position.distanceTo(playerShip.position);
                  if (dist < minDistance) {
                    minDistance = dist;
                    nearestResource = resource;
                  }
                }
              });
              
              if (nearestResource) {
                playerState.autopilotTarget = nearestResource;
                addConsoleMessage("Now navigating to nearest resource");
              } else {
                autopilotActive = false;
                addConsoleMessage("Autopilot disabled: No resources available");
                updateStatusOverlay();
              }
            } else {
              // Mine the resource
              mineResource();
              
              // If cargo is now full, return to home
              if (playerState.currentCargo >= playerState.cargoCapacity) {
                playerState.returningHome = true;
                playerState.autopilotTarget = homePlanet;
                addConsoleMessage("Cargo full! Returning to home planet");
              } else {
                // Find next resource
                let nearestResource = null;
                let minDistance = Infinity;
                
                resources.forEach(resource => {
                  if (!resource.userData.collected) {
                    const dist = resource.position.distanceTo(playerShip.position);
                    if (dist < minDistance) {
                      minDistance = dist;
                      nearestResource = resource;
                    }
                  }
                });
                
                if (nearestResource) {
                  playerState.autopilotTarget = nearestResource;
                } else {
                  autopilotActive = false;
                  addConsoleMessage("Autopilot disabled: No resources available");
                  updateStatusOverlay();
                }
              }
            }
          }
        }

        // Ship upgrade function
        function upgradeShip() {
          if (playerState.credits >= 500) {
            playerState.credits -= 500;
            playerState.shipLevel++;
            playerState.cargoCapacity += 50;
            
            addConsoleMessage(`Ship upgraded to level ${playerState.shipLevel}! Cargo capacity increased.`);
            updateResourceDisplay();
          } else {
            addConsoleMessage("Not enough credits for upgrade (500 required)");
          }
        }

        // Event listeners
        function setupEventListeners() {
          // Throttle control
          document.getElementById('throttleBtn').addEventListener('click', () => {
            throttle = throttle === 1 ? 0 : 1;
            document.getElementById('throttleBtn').textContent = throttle === 1 ? 'Stop' : 'Full Throttle';
            document.getElementById('throttleBtn').classList.toggle('active', throttle === 1);
            document.getElementById('throttleIndicator').textContent = throttle === 1 ? 'FULL THROTTLE' : '';
            document.getElementById('throttleIndicator').classList.toggle('active', throttle === 1);
          });

          // Mine button
          document.getElementById('mineBtn').addEventListener('click', mineResource);

          // Autopilot button
          document.getElementById('autopilotBtn').addEventListener('click', toggleAutopilot);

          // Home button
          document.getElementById('homeBtn').addEventListener('click', () => {
            playerState.returningHome = true;
            playerState.autopilotTarget = homePlanet;
            autopilotActive = true;
            addConsoleMessage("Returning to home planet");
            updateStatusOverlay();
          });

          // Reset button
          document.getElementById('resetBtn').addEventListener('click', () => {
            playerShip.position.set(0, 0, 100);
            velocity.set(0, 0, 0);
            rotation.x = 0;
            rotation.y = 0;
            addConsoleMessage("Position reset");
          });

          // Camera lock button
          document.getElementById('cameraLockBtn').addEventListener('click', () => {
            cameraLocked = !cameraLocked;
            document.getElementById('cameraLockBtn').textContent = cameraLocked ? 'Unlock Camera' : 'Lock Camera';
            addConsoleMessage(`Camera ${cameraLocked ? 'locked' : 'unlocked'}`);
          });

          // Free look button
          document.getElementById('freeLookBtn').addEventListener('click', () => {
            freeLookActive = !freeLookActive;
            document.getElementById('freeLookBtn').textContent = freeLookActive ? 'Exit Free Look' : 'Free Look';
            addConsoleMessage(`Free look ${freeLookActive ? 'enabled' : 'disabled'}`);
          });

          // Reset view button
          document.getElementById('resetViewBtn').addEventListener('click', () => {
            camera.position.set(0, 0, 0);
            camera.rotation.set(0, 0, 0);
            addConsoleMessage("View reset");
          });

          // Console input
          consoleInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              const command = consoleInput.value.trim();
              if (command) {
                addConsoleMessage(`> ${command}`);
                
                // Process commands
                if (command === '/help') {
                  addConsoleMessage("Available commands:");
                  addConsoleMessage("/help - Show this help");
                  addConsoleMessage("/credits - Add 100 credits");
                  addConsoleMessage("/fuel - Refuel to 100%");
                  addConsoleMessage("/energy - Recharge to 100%");
                  addConsoleMessage("/upgrade - Upgrade ship (if enough credits)");
                } else if (command === '/credits') {
                  playerState.credits += 100;
                  addConsoleMessage("Added 100 credits");
                  updateResourceDisplay();
                } else if (command === '/fuel') {
                  playerState.fuel = 100;
                  addConsoleMessage("Fuel refilled");
                  updateResourceDisplay();
                } else if (command === '/energy') {
                  playerState.energy = 100;
                  addConsoleMessage("Energy recharged");
                  updateResourceDisplay();
                } else if (command === '/upgrade') {
                  upgradeShip();
                } else {
                  addConsoleMessage("Unknown command. Type /help for available commands.");
                }
                
                consoleInput.value = '';
              }
            }
          });

          // Keyboard controls
          document.addEventListener('keydown', (e) => {
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp') {
              throttle = 1;
              document.getElementById('throttleBtn').textContent = 'Stop';
              document.getElementById('throttleBtn').classList.add('active');
              document.getElementById('throttleIndicator').textContent = 'FULL THROTTLE';
              document.getElementById('throttleIndicator').classList.add('active');
            } else if (e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') {
              throttle = -0.5;
              document.getElementById('throttleIndicator').textContent = 'REVERSE';
              document.getElementById('throttleIndicator').classList.add('active');
            } else if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft') {
              rotation.y = 0.02;
            } else if (e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') {
              rotation.y = -0.02;
            } else if (e.key === 'q' || e.key === 'Q') {
              rotation.x = 0.02;
            } else if (e.key === 'e' || e.key === 'E') {
              rotation.x = -0.02;
            } else if (e.key === 'f' || e.key === 'F') {
              mineResource();
            } else if (e.key === 'r' || e.key === 'R') {
              addConsoleMessage("Scanning... Resources in range:");
              let count = 0;
              resources.forEach(resource => {
                if (!resource.userData.collected) {
                  const distance = resource.position.distanceTo(playerShip.position);
                  if (distance < 300) {
                    count++;
                  }
                }
              });
              addConsoleMessage(`Found ${count} resources within 300 units`);
            } else if (e.key === 'h' || e.key === 'H') {
              playerState.returningHome = true;
              playerState.autopilotTarget = homePlanet;
              autopilotActive = true;
              addConsoleMessage("Returning to home planet");
              updateStatusOverlay();
            } else if (e.key === ' ') {
              // Space bar for brake
              throttle = 0;
              velocity.multiplyScalar(0.9);
              document.getElementById('throttleBtn').textContent = 'Full Throttle';
              document.getElementById('throttleBtn').classList.remove('active');
              document.getElementById('throttleIndicator').classList.remove('active');
            }
          });

          document.addEventListener('keyup', (e) => {
            if (e.key === 'w' || e.key === 'W' || e.key === 'ArrowUp' || 
                e.key === 's' || e.key === 'S' || e.key === 'ArrowDown') {
              throttle = 0;
              document.getElementById('throttleBtn').textContent = 'Full Throttle';
              document.getElementById('throttleBtn').classList.remove('active');
              document.getElementById('throttleIndicator').classList.remove('active');
            } else if (e.key === 'a' || e.key === 'A' || e.key === 'ArrowLeft' || 
                       e.key === 'd' || e.key === 'D' || e.key === 'ArrowRight') {
              rotation.y = 0;
            } else if (e.key === 'q' || e.key === 'Q' || e.key === 'e' || e.key === 'E') {
              rotation.x = 0;
            }
          });

          // Mouse controls for free look
          document.addEventListener('mousedown', (e) => {
            if (freeLookActive) {
              isMouseDown = true;
              lastMouseX = e.clientX;
              lastMouseY = e.clientY;
            }
          });

          document.addEventListener('mouseup', () => {
            isMouseDown = false;
          });

          document.addEventListener('mousemove', (e) => {
            if (isMouseDown && freeLookActive) {
              const deltaX = e.clientX - lastMouseX;
              const deltaY = e.clientY - lastMouseY;
              
              camera.rotation.y -= deltaX * 0.002;
              camera.rotation.x -= deltaY * 0.002;
              
              // Limit vertical rotation
              camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
              
              lastMouseX = e.clientX;
              lastMouseY = e.clientY;
            }
          });

          // UI buttons
          document.getElementById('chatButton').addEventListener('click', () => {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
          });

          document.getElementById('inventoryButton').addEventListener('click', () => {
            const invWindow = document.getElementById('inventoryWindow');
            invWindow.style.display = invWindow.style.display === 'none' ? 'block' : 'none';
          });

          document.getElementById('shipButton').addEventListener('click', () => {
            const shipWindow = document.getElementById('shipWindow');
            shipWindow.style.display = shipWindow.style.display === 'none' ? 'block' : 'none';
          });

          // Window dragging
          const draggableWindows = document.querySelectorAll('.draggable-window');
          draggableWindows.forEach(window => {
            const header = window.querySelector('.window-header');
            let isDragging = false;
            let offsetX, offsetY;
            
            header.addEventListener('mousedown', (e) => {
              isDragging = true;
              offsetX = e.clientX - window.getBoundingClientRect().left;
              offsetY = e.clientY - window.getBoundingClientRect().top;
            });
            
            document.addEventListener('mousemove', (e) => {
              if (isDragging) {
                window.style.left = `${e.clientX - offsetX}px`;
                window.style.top = `${e.clientY - offsetY}px`;
              }
            });
            
            document.addEventListener('mouseup', () => {
              isDragging = false;
            });
          });

          // Chat tabs
          const chatTabs = document.querySelectorAll('.chat-tab');
          chatTabs.forEach(tab => {
            tab.addEventListener('click', () => {
              chatTabs.forEach(t => t.classList.remove('active'));
              tab.classList.add('active');
            });
          });
        }

        // Animation loop
        function animate() {
          requestAnimationFrame(animate);
          
          const currentTime = performance.now();
          const deltaTime = (currentTime - lastTime) / 1000;
          lastTime = currentTime;
          
          // Update player position based on velocity
          if (!autopilotActive) {
            // Apply rotation
            playerShip.rotation.x += rotation.x;
            playerShip.rotation.y += rotation.y;
            
            // Apply velocity in the direction the ship is facing
            const forward = new THREE.Vector3(0, 0, -1);
            forward.applyQuaternion(playerShip.quaternion);
            
            velocity.x += forward.x * throttle * deltaTime * 50;
            velocity.y += forward.y * throttle * deltaTime * 50;
            velocity.z += forward.z * throttle * deltaTime * 50;
            
            // Apply friction/drag
            velocity.multiplyScalar(0.98);
          }
          
          // Update autopilot if active
          if (autopilotActive) {
            updateAutopilot(deltaTime);
          }
          
          // Update player ship position
          playerShip.position.x += velocity.x;
          playerShip.position.y += velocity.y;
          playerShip.position.z += velocity.z;
          
          // Update camera position relative to ship
          if (!cameraLocked) {
            const cameraOffset = new THREE.Vector3(0, 30, 70);
            cameraOffset.applyQuaternion(playerShip.quaternion);
            camera.position.copy(playerShip.position).add(cameraOffset);
            camera.lookAt(playerShip.position);
          }
          
          // Update nebula rotations
          nebulae.forEach(nebula => {
            nebula.rotation.x += nebula.userData.rotationSpeed.x;
            nebula.rotation.y += nebula.userData.rotationSpeed.y;
            nebula.rotation.z += nebula.userData.rotationSpeed.z;
          });
          
          // Update resource display
          updateResourceDisplay();
          
          // Update minimap
          updateMinimap();
          
          // Consume fuel
          if (throttle !== 0 || autopilotActive) {
            playerState.fuel -= 0.05;
            if (playerState.fuel <= 0) {
              playerState.fuel = 0;
              throttle = 0;
              autopilotActive = false;
              addConsoleMessage("Out of fuel! Drifting...");
              updateStatusOverlay();
            }
          }
          
          // Regen energy
          playerState.energy = Math.min(100, playerState.energy + 0.1);
          
          renderer.render(scene, camera);
        }

        // Initialize the game
        initializeGameEnvironment();
        setupEventListeners();
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

      } catch (error) {
        console.error('Error initializing GalaxyCraft:', error);
        alert('Failed to initialize GalaxyCraft: ' + error.message);
      }
    };
  </script>
</body>
</html>