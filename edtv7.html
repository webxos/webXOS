<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>edTV: CHANNEL 7</title>
    <meta name="theme-color" content="#000000">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <!-- Three.js for 3D Hero Scene -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

    <!-- TensorFlow.js + face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
        body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
        #app{position:relative;width:100%;height:100vh;overflow:hidden;display:flex;flex-direction:column}
        .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3;pointer-events:none}
        .crt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;pointer-events:none;animation:scanline 8s linear infinite}
        @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
        .infrared{position:absolute;top:0;left:0;width:100%;height:4px;background:rgba(255,0,0,0.8);box-shadow:0 0 20px 5px rgba(255,0,0,0.8);animation:scanner 4s linear infinite}
        @keyframes scanner{0%{top:0}50%{top:100%}100%{top:0}}

        /* TOP: 3D HERO SCENE + PIP */
        #heroContainer{
            flex:1;position:relative;overflow:hidden;
            background:#000;z-index:1;
        }
        #heroCanvas{width:100%;height:100%}
        #pipCam{
            position:absolute;top:10px;right:10px;width:180px;height:180px;
            border:3px solid #f00;background:#000;z-index:10;
            overflow:hidden;cursor:pointer;transition:transform .3s;
            box-shadow:0 0 15px rgba(255,0,0,0.6);
        }
        #pipCam.enlarged{
            width:100%;height:100%;top:0;right:0;z-index:30;
            box-shadow:0 0 40px rgba(255,0,0,0.9);
        }
        #pipVideo{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
        #pipOverlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}

        /* BOTTOM: CONSOLE + BUTTONS */
        #consolePanel{
            height:220px;background:rgba(0,0,0,0.95);border-top:3px solid #f00;
            display:flex;flex-direction:column;z-index:20;
        }
        .console-header{
            height:30px;background:#300;border-bottom:2px solid #f00;
            display:flex;align-items:center;padding:0 10px;color:#f00;font-size:9px;
        }
        .console-title{flex:1}
        .console-body{
            flex:1;overflow-y:auto;padding:8px;
            color:#ff5555;font-size:6.5px;line-height:1.4;
            background:repeating-linear-gradient(0deg,#000,#000 1px,#0a0a0a 1px,#0a0a0a 2px);
        }
        .log-line{margin-bottom:3px}
        .log-error{color:#ff3333}
        .log-success{color:#33ff33}
        .log-data{color:#ffff55;word-break:break-all}
        .log-hash{color:#ff55ff;font-weight:bold}
        .log-badge{color:#0ff;font-weight:bold}

        .control-panel{
            height:50px;display:flex;gap:8px;padding:0 10px;align-items:center;
        }
        .btn{
            flex:1;height:40px;background:#000;border:2px solid #0ff;color:#0ff;
            font-size:9px;display:flex;align-items:center;justify-content:center;
            cursor:pointer;transition:background .1s,color .1s;
        }
        .btn:hover,.btn:active{background:#0ff;color:#000}
        .btn.export{border-color:#0f0;color:#0f0}
        .btn.export:hover,.btn.export:active{background:#0f0;color:#000}
        .btn.disabled{opacity:0.5;pointer-events:none}

        /* BADGE OVERLAY (FOR SCREENSHOT) */
        #badgeOverlay{
            position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            width:320px;padding:15px;background:rgba(0,0,0,0.9);border:3px solid #0ff;
            color:#0ff;font-size:8px;line-height:1.5;text-align:center;z-index:40;
            display:none;pointer-events:none;
        }
        .badge-title{font-size:10px;color:#0ff;margin-bottom:8px}
        .badge-id{font-size:12px;color:#ff0;margin:5px 0}
        .badge-serial{font-size:9px;color:#f0f;word-break:break-all;margin:5px 0}
        .badge-hash{font-size:7px;color:#0f0;word-break:break-all}

        @media (max-width:767px){
            #pipCam{width:140px;height:140px}
            #consolePanel{height:260px}
            .console-body{font-size:6px}
            .btn{height:36px;font-size:8px}
            #badgeOverlay{width:90%;font-size:7px}
        }
    </style>
</head>
<body>
<div id="app">
    <div class="matrix-grid"></div>
    <div class="crt-overlay"></div>
    <div class="infrared"></div>

    <!-- TOP: 3D HERO + PIP -->
    <div id="heroContainer">
        <canvas id="heroCanvas"></canvas>
        <div id="pipCam">
            <video id="pipVideo" autoplay playsinline muted></video>
            <canvas id="pipOverlay"></canvas>
        </div>
    </div>

    <!-- BOTTOM: CONSOLE + BUTTONS -->
    <div id="consolePanel">
        <div class="console-header">
            <div class="console-title">edTV: CHANNEL 7</div>
        </div>
        <div class="console-body" id="terminalLog">
            <div class="log-line log-success">> SYSTEM ONLINE</div>
            <div class="log-line">> DOUBLE-CLICK PIP TO CENTER FACE</div>
        </div>
        <div class="control-panel">
            <button id="startBtn" class="btn">START SCAN</button>
            <button id="exportBtn" class="btn export disabled">EXPORT BADGE</button>
        </div>
    </div>

    <!-- BADGE OVERLAY (SCREENSHOT READY) -->
    <div id="badgeOverlay">
        <div class="badge-title">BADGE</div>
        <div class="badge-id" id="badgeId">ID: BADGE_XXXXXX</div>
        <div class="badge-serial" id="badgeSerial">SERIAL: XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</div>
        <div class="badge-hash" id="badgeHash">HASH: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</div>
    </div>

    <!-- Hidden JSON -->
    <pre id="badgeData"></pre>
</div>

<script>
    // DOM
    const $ = s => document.querySelector(s);
    const heroCanvas = $('#heroCanvas');
    const pipCam = $('#pipCam');
    const pipVideo = $('#pipVideo');
    const pipOverlay = $('#pipOverlay');
    const pipCtx = pipOverlay.getContext('2d');
    const logEl = $('#terminalLog');
    const startBtn = $('#startBtn');
    const exportBtn = $('#exportBtn');
    const badgeOverlay = $('#badgeOverlay');
    const badgeId = $('#badgeId');
    const badgeSerial = $('#badgeSerial');
    const badgeHash = $('#badgeHash');
    const badgeDataEl = $('#badgeData');

    // 3D Scene
    let scene, camera, renderer, controls, faceMesh;
    let stream = null, isRunning = false, isScanning = false, detector = null;
    let currentFaceData = null, hash = '', serial = '';

    // Init 3D Scene
    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);

        camera = new THREE.PerspectiveCamera(45, heroCanvas.clientWidth / heroCanvas.clientHeight, 0.1, 100);
        camera.position.set(0, 0, 3);

        renderer = new THREE.WebGLRenderer({ canvas: heroCanvas, antialias: false });
        renderer.setSize(heroCanvas.clientWidth, heroCanvas.clientHeight);
        renderer.setPixelRatio(1);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.enableZoom = false;
        controls.enablePan = false;

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 5, 5);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        animate3D();
    }

    function animate3D() {
        requestAnimationFrame(animate3D);
        controls.update();
        renderer.render(scene, camera);
    }

    // Log
    function log(msg, type = '') {
        const line = document.createElement('div');
        line.className = `log-line ${type}`;
        line.textContent = '> ' + msg;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
    }

    // Generate Serial (Base32)
    function generateSerial() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        let result = '';
        for (let i = 0; i < 32; i++) {
            result += chars[Math.floor(Math.random() * chars.length)];
        }
        return result.match(/.{1,8}/g).join('-');
    }

    // SHA-256 Hash
    async function generateHash(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Extract 3D Data
    function extract3DFaceData(landmarks) {
        const points = landmarks.map(p => ({
            x: parseFloat((p[0] / pipVideo.videoWidth).toFixed(6)),
            y: parseFloat((p[1] / pipVideo.videoHeight).toFixed(6)),
            z: parseFloat(p[2]?.toFixed(6) || '0.000000')
        }));

        const keyIndices = [1, 33, 263, 61, 291, 199, 10, 152];
        const keyPoints = keyIndices.filter(i => points[i]).map(i => points[i]);

        return { keyLandmarks: keyPoints, fullLandmarks: points, totalLandmarks: landmarks.length };
    }

    // Build 3D Face Mesh
    function build3DMesh(faceData) {
        if (faceMesh) scene.remove(faceMesh);
        const geometry = new THREE.BufferGeometry();
        const positions = [];

        faceData.fullLandmarks.forEach(p => {
            positions.push((p.x - 0.5) * 2, (0.5 - p.y) * 2, p.z * 0.5);
        });

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));

        const material = new THREE.PointsMaterial({ color: 0x00ffff, size: 0.03 });
        faceMesh = new THREE.Points(geometry, material);
        scene.add(faceMesh);

        log('3D HERO MESH RENDERED', 'log-success');
    }

    // Draw PIP Wireframe
    function drawWireframe(landmarks) {
        pipCtx.strokeStyle = '#f00';
        pipCtx.lineWidth = 1.5;
        const connections = [[33,133],[133,144],[144,145],[145,153],[153,154],[154,155],[155,133],[263,362],[362,385],[385,386],[386,387],[387,388],[388,466],[466,263]];
        connections.forEach(([i,j]) => {
            const p1 = landmarks[i], p2 = landmarks[j];
            if (p1 && p2) {
                const x1 = pipVideo.videoWidth - p1[0], y1 = p1[1];
                const x2 = pipVideo.videoWidth - p2[0], y2 = p2[1];
                pipCtx.beginPath(); pipCtx.moveTo(x1,y1); pipCtx.lineTo(x2,y2); pipCtx.stroke();
            }
        });
    }

    // Start Scan
    async function startScan() {
        if (isScanning) return;
        isScanning = true;
        startBtn.classList.add('disabled');
        startBtn.textContent = 'SCANNING...';
        exportBtn.classList.add('disabled');

        log('SCAN ACTIVE – HOLD CENTER', 'log-success');
        let progress = 0;
        const timer = setInterval(async () => {
            progress += 20;
            if (progress >= 100) {
                clearInterval(timer);
                await finalizeBadge();
            }
        }, 1000);
    }

    // Finalize Badge
    async function finalizeBadge() {
        try {
            const faces = await faceapi.detectAllFaces(pipVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            if (faces.length === 0) throw new Error('NO FACE');

            const faceData = extract3DFaceData(faces[0].landmarks);
            hash = await generateHash(JSON.stringify(faceData.keyLandmarks));
            serial = generateSerial();

            const badge = {
                badgeId: `BADGE_${hash.slice(0,8).toUpperCase()}`,
                serial: serial,
                hash: hash,
                timestamp: new Date().toISOString(),
                ...faceData
            };

            badgeDataEl.textContent = JSON.stringify(badge, null, 2);
            badgeId.textContent = badge.badgeId;
            badgeSerial.textContent = `SERIAL: ${serial}`;
            badgeHash.textContent = `HASH: ${hash}`;
            badgeOverlay.style.display = 'block';

            build3DMesh(faceData);

            log(`BADGE CREATED: ${badge.badgeId}`, 'log-badge');
            log(`SERIAL: ${serial}`, 'log-data');
            log(`HASH: ${hash}`, 'log-hash');
            log(`SCREENSHOT READY`, 'log-success');

            startBtn.textContent = 'START SCAN';
            startBtn.classList.remove('disabled');
            exportBtn.classList.remove('disabled');
            isScanning = false;
        } catch (err) {
            log(`BADGE FAILED: ${err.message}`, 'log-error');
            resetScan();
        }
    }

    function resetScan() {
        isScanning = false;
        startBtn.textContent = 'START SCAN';
        startBtn.classList.remove('disabled');
        exportBtn.classList.add('disabled');
        badgeOverlay.style.display = 'none';
    }

    // Export
    exportBtn.onclick = async () => {
        const data = `BADGE DATA\nID: ${badgeId.textContent}\nSERIAL: ${badgeSerial.textContent.replace('SERIAL: ','')}\nHASH: ${badgeHash.textContent.replace('HASH: ','')}\n\nJSON:\n${badgeDataEl.textContent}`;
        try {
            await navigator.clipboard.writeText(data);
            log('BADGE + SERIAL + JSON COPIED', 'log-success');
        } catch {
            log('COPY FAILED', 'log-error');
        }
    };

    // PIP Toggle
    pipCam.ondblclick = () => {
        pipCam.classList.toggle('enlarged');
        log(pipCam.classList.contains('enlarged') ? 'PIP ENLARGED – CENTER FACE' : 'PIP RESTORED', 'log-success');
    };

    // Resize
    function resize() {
        renderer.setSize(heroCanvas.clientWidth, heroCanvas.clientHeight);
        camera.aspect = heroCanvas.clientWidth / heroCanvas.clientHeight;
        camera.updateProjectionMatrix();
        if (pipVideo.videoWidth) {
            pipOverlay.width = pipVideo.videoWidth;
            pipOverlay.height = pipVideo.videoHeight;
        }
    }
    window.addEventListener('resize', resize);

    // Start Webcam
    async function startWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            pipVideo.srcObject = stream;
            await new Promise(r => pipVideo.onloadedmetadata = r);
            pipOverlay.width = pipVideo.videoWidth;
            pipOverlay.height = pipVideo.videoHeight;

            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/');

            isRunning = true;
            detectLoop();
            log('WEBCAM + MODELS READY', 'log-success');
        } catch (err) {
            log(`WEBCAM ERROR: ${err.message}`, 'log-error');
        }
    }

    // Detection Loop
    async function detectLoop() {
        if (!isRunning) return;
        try {
            const faces = await faceapi.detectAllFaces(pipVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
            pipCtx.clearRect(0,0,pipOverlay.width,pipOverlay.height);
            if (faces.length > 0) drawWireframe(faces[0].landmarks);
        } catch (err) { log(`DETECT ERROR: ${err.message}`, 'log-error'); }
        requestAnimationFrame(detectLoop);
    }

    // Init
    window.onload = () => {
        init3D();
        startWebcam();
        startBtn.onclick = () => isRunning && !isScanning && startScan();
        log('CORPORATE BADGE SYSTEM READY', 'log-success');
        log('> DOUBLE-CLICK PIP TO CENTER', '');
    };
</script>
</body>
</html>
