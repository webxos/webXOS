<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DA3 MASK: CLOUD POINT FACE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0f0;overflow:hidden;height:100dvh;user-select:none}
  canvas{display:block}
  #video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;opacity:0.0;z-index:1}
  .banner{position:absolute;top:0;left:0;right:0;background:rgba(0,20,0,0.95);border-bottom:2px solid #0f0;padding:8px;font-size:11px;text-align:center;z-index:10;text-shadow:0 0 10px #0f0}
  .status{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:8px;z-index:10}
  .ind{padding:4px 8px;font-size:8px;background:rgba(0,50,0,0.9);border:1px solid #0f0;border-radius:4px}
  .locked{background:rgba(0,255,0,0.9);box-shadow:0 0 12px #0f0;animation:p 1.5s infinite}
  @keyframes p{0%,100%{opacity:1}50%{opacity:0.6}}
</style>
</head>
<body>
<div class="banner">DA3 MASK: REAL-TIME CLOUD POINT FACE</div>
<video id="video" autoplay playsinline muted></video>
<canvas id="c"></canvas>
<div class="status">
  <div class="ind" id="status">DA3: OFFLINE</div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
import {OrbitControls} from 'https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/controls/OrbitControls.js';
import '@tensorflow/tfjs-backend-webgl';
import * as faceLandmarksDetection from 'https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.3';

const video = document.getElementById('video');
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
renderer.setPixelRatio(devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 10);
camera.position.set(0, 0, 0.8);

const controls = new OrbitControls(camera, canvas);
controls.enableDamping = true;
controls.target.set(0, 0.1, 0);

const light = new THREE.HemisphereLight(0x00ff88, 0x0088ff, 2);
scene.add(light);

const pointsMat = new THREE.PointsMaterial({
  color: 0x00ff88,
  size: 0.006,
  sizeAttenuation: true
});
const pointsGeo = new THREE.BufferGeometry();
const points = new THREE.Points(pointsGeo, pointsMat);
scene.add(points);

let detector;

async function start() {
  document.getElementById('status').textContent = 'DA3: STARTING CAMERA';
  const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}});
  video.srcObject = stream;
  video.play();

  document.getElementById('status').textContent = 'DA3: LOADING MODEL';
  detector = await faceLandmarksDetection.createDetector(
    faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
    {runtime: 'tfjs', refineLandmarks: true}
  );

  document.getElementById('status').textContent = 'DA3: LOCKED';
  document.getElementById('status').classList.add('locked');
  requestAnimationFrame(loop);
}

function loop() {
  controls.update();

  if (detector && video.readyState === 4) {
    detector.estimateFaces(video, {flipHorizontal: true}).then(faces => {
      if (faces.length > 0) {
        const landmarks = faces[0].keypoints;
        const pos = new Float32Array(468 * 3);
        for (let i = 0; i < 468; i++) {
          const p = landmarks[i];
          pos[i*3]   = (p.x / video.videoWidth - 0.5) * 1.2;
          pos[i*3+1] = -(p.y / video.videoHeight - 0.5) * 1.2;
          pos[i*3+2] = (p.z || 0) / 4000;
        }
        pointsGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
      }
    });
  }

  renderer.render(scene, camera);
  requestAnimationFrame(loop);
}

window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

start();
</script>
</body>
</html>
