<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>MACROSLOW AGENT IDE | Simplified Link System</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICAgIm5hbWUiOiAiTUFDUk9TTE9XIEFHRU5UIElERSIsCiAgICAic2hvcnRfbmFtZSI6ICJNQUNST1NMT1ciLAogICAgImRlc2NyaXB0aW9uIjogIlJlYWwtVGltZSBBZ2VudCBPcmNoZXN0cmF0b3IiLAogICAgInN0YXJ0X3VybCI6ICIuLyIsCiAgICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAgICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICAgImljb25zIjogW10KfQ==">
    
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/gpu.js@2.15.1/dist/gpu-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        /* ========== RESPONSIVE SCALING ========== */
        :root {
            font-size: 16px;
            --scale-factor: 1;
            --base-padding: 10px;
            --base-margin: 8px;
            --base-gap: 8px;
            --border-thickness: 2px;
        }
        
        @media (min-width: 1920px) {
            :root {
                font-size: 18px;
                --scale-factor: 1.1;
                --base-padding: 12px;
                --base-margin: 10px;
                --base-gap: 10px;
            }
        }
        
        @media (max-width: 1366px) {
            :root {
                font-size: 15px;
                --scale-factor: 0.95;
                --base-padding: 9px;
                --base-margin: 7px;
                --base-gap: 7px;
            }
        }
        
        @media (max-width: 1024px) {
            :root {
                font-size: 14px;
                --scale-factor: 0.9;
                --base-padding: 8px;
                --base-margin: 6px;
                --base-gap: 6px;
            }
        }
        
        @media (max-width: 768px) {
            :root {
                font-size: 13px;
                --scale-factor: 0.85;
                --base-padding: 7px;
                --base-margin: 5px;
                --base-gap: 5px;
            }
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            image-rendering: pixelated;
            font-family: 'VT323', monospace;
            font-smooth: never;
            -webkit-font-smoothing: none;
        }
        
        html, body { 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            background: #000; 
            color: #c0c0c0; 
            display: flex;
            flex-direction: column;
            font-size: calc(1rem * var(--scale-factor));
            letter-spacing: 0.3px;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)),
                repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(80, 80, 80, 0.05) 1px, rgba(80, 80, 80, 0.05) 2px);
            touch-action: pan-x pan-y;
        }
        
        /* CRT Scanlines */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15) 0px,
                rgba(0, 0, 0, 0.15) 0.5px,
                transparent 0.5px,
                transparent 1px
            );
            pointer-events: none;
            z-index: 9999;
        }
        
        /* ========== COMPACT HEADER ========== */
        header {
            padding: calc(8px * var(--scale-factor)) calc(16px * var(--scale-factor));
            border-bottom: calc(var(--border-thickness) * var(--scale-factor)) dashed #404040;
            background: rgba(10, 10, 10, 0.95);
            z-index: 10;
            flex-shrink: 0;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: calc(8px * var(--scale-factor));
        }
        
        h1 {
            font-family: 'Press Start 2P', monospace;
            font-size: calc(1rem * var(--scale-factor));
            text-shadow: calc(2px * var(--scale-factor)) calc(2px * var(--scale-factor)) 0 #000;
            color: #ffffff;
            letter-spacing: 0.6px;
        }
        
        .realtime-badge {
            display: inline-block;
            background: linear-gradient(45deg, #00ff00, #008800);
            color: white;
            padding: calc(2px * var(--scale-factor)) calc(8px * var(--scale-factor));
            border-radius: calc(3px * var(--scale-factor));
            font-size: calc(9px * var(--scale-factor));
            font-weight: bold;
            margin-left: calc(6px * var(--scale-factor));
            animation: realtimePulse 2s infinite;
        }
        
        .network-status {
            display: flex;
            align-items: center;
            gap: calc(8px * var(--scale-factor));
            font-size: calc(0.8rem * var(--scale-factor));
        }
        
        .ws-status {
            display: inline-block;
            width: calc(8px * var(--scale-factor));
            height: calc(8px * var(--scale-factor));
            border-radius: 50%;
            background: #ff0000;
            margin-right: calc(4px * var(--scale-factor));
        }
        
        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: calc(0.7rem * var(--scale-factor));
            flex-wrap: wrap;
            gap: calc(8px * var(--scale-factor));
            padding: calc(4px * var(--scale-factor)) 0;
            border-top: calc(1px * var(--scale-factor)) dashed #404040;
        }
        
        /* ========== COMPACT MAIN LAYOUT ========== */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: calc(var(--base-padding) * var(--scale-factor));
            gap: calc(var(--base-gap) * var(--scale-factor));
            min-height: 0;
        }
        
        /* ========== COMPACT SIDEBAR ========== */
        .sidebar {
            width: calc(280px * var(--scale-factor));
            min-width: calc(280px * var(--scale-factor));
            background: rgba(10, 10, 10, 0.9);
            border: calc(3px * var(--scale-factor)) solid #404040;
            padding: calc(12px * var(--scale-factor));
            display: flex;
            flex-direction: column;
            gap: calc(12px * var(--scale-factor));
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .sidebar-title {
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.85rem * var(--scale-factor));
            color: #ffffff;
            text-align: center;
            margin-bottom: calc(8px * var(--scale-factor));
            padding-bottom: calc(6px * var(--scale-factor));
            border-bottom: calc(1px * var(--scale-factor)) dashed #404040;
        }
        
        /* Agent Form */
        .agent-form {
            background: rgba(0, 0, 0, 0.7);
            padding: calc(12px * var(--scale-factor));
            border: calc(2px * var(--scale-factor)) solid #404040;
            flex-shrink: 0;
        }
        
        .form-input, .form-select {
            width: 100%;
            background: #000;
            border: calc(2px * var(--scale-factor)) solid #404040;
            color: #c0c0c0;
            padding: calc(8px * var(--scale-factor));
            font-family: 'VT323', monospace;
            font-size: calc(0.9rem * var(--scale-factor));
            margin-bottom: calc(8px * var(--scale-factor));
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #00ff00;
        }
        
        .create-agent-btn {
            width: 100%;
            background: #000;
            border: calc(3px * var(--scale-factor)) solid #404040;
            color: #ffffff;
            padding: calc(12px * var(--scale-factor));
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.8rem * var(--scale-factor));
            cursor: pointer;
            margin-top: calc(8px * var(--scale-factor));
            box-shadow: calc(2px * var(--scale-factor)) calc(2px * var(--scale-factor)) 0 #000;
            transition: all 0.2s;
        }
        
        .create-agent-btn:hover {
            background: #111;
            border-color: #00ff00;
        }
        
        /* ========== COMPACT TERMINAL ========== */
        .terminal-orchestrator {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: calc(var(--base-gap) * var(--scale-factor));
            min-height: 0;
            overflow: hidden;
        }
        
        .terminal-container {
            flex: 1;
            min-height: calc(300px * var(--scale-factor));
            background: rgba(0, 0, 0, 0.95);
            border: calc(4px * var(--scale-factor)) solid #404040;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .terminal-header {
            background: #000;
            padding: calc(8px * var(--scale-factor)) calc(12px * var(--scale-factor));
            border-bottom: calc(2px * var(--scale-factor)) dashed #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .terminal-title {
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.9rem * var(--scale-factor));
            color: #ffffff;
        }
        
        .terminal-body {
            flex: 1;
            padding: calc(12px * var(--scale-factor));
            overflow-y: auto;
            font-size: calc(0.9rem * var(--scale-factor));
            line-height: 1.3;
        }
        
        .terminal-input {
            display: flex;
            padding: calc(8px * var(--scale-factor)) calc(12px * var(--scale-factor));
            border-top: calc(2px * var(--scale-factor)) dashed #404040;
            background: #000;
        }
        
        .prompt {
            color: #00ff00;
            padding: calc(6px * var(--scale-factor)) calc(8px * var(--scale-factor));
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.8rem * var(--scale-factor));
            white-space: nowrap;
        }
        
        .terminal-input input {
            flex: 1;
            background: transparent;
            border: none;
            color: #00ff00;
            font-size: calc(1rem * var(--scale-factor));
            padding: calc(6px * var(--scale-factor));
        }
        
        .terminal-input input:focus {
            outline: none;
        }
        
        /* ========== COMPACT QUICK ACTIONS ========== */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(120px * var(--scale-factor)), 1fr));
            gap: calc(8px * var(--scale-factor));
            padding: calc(12px * var(--scale-factor));
            background: rgba(10, 10, 10, 0.9);
            border: calc(3px * var(--scale-factor)) solid #404040;
        }
        
        .action-btn {
            padding: calc(12px * var(--scale-factor)) calc(8px * var(--scale-factor));
            background: #000;
            border: calc(3px * var(--scale-factor)) solid #404040;
            color: #c0c0c0;
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.7rem * var(--scale-factor));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: calc(8px * var(--scale-factor));
            min-height: calc(40px * var(--scale-factor));
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #111;
            border-color: #00ff00;
            color: #00ff00;
        }
        
        /* ========== COMPACT AGENT GRID ========== */
        .agent-grid-container {
            flex: 1;
            min-height: calc(200px * var(--scale-factor));
            background: rgba(10, 10, 10, 0.8);
            border: calc(3px * var(--scale-factor)) solid #404040;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .agent-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(calc(180px * var(--scale-factor)), 1fr));
            gap: calc(8px * var(--scale-factor));
            padding: calc(12px * var(--scale-factor));
            overflow-y: auto;
        }
        
        .agent-card {
            background: rgba(0, 0, 0, 0.9);
            border: calc(3px * var(--scale-factor)) solid #404040;
            padding: calc(12px * var(--scale-factor));
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: calc(120px * var(--scale-factor));
            transition: all 0.2s;
        }
        
        .agent-card:hover {
            border-color: #00ff00;
            background: rgba(20, 20, 20, 0.9);
        }
        
        .agent-delete-btn {
            position: absolute;
            top: calc(6px * var(--scale-factor));
            right: calc(6px * var(--scale-factor));
            width: calc(20px * var(--scale-factor));
            height: calc(20px * var(--scale-factor));
            background: #ff0000;
            border: calc(2px * var(--scale-factor)) solid #800000;
            color: white;
            font-family: 'Press Start 2P', monospace;
            font-size: calc(10px * var(--scale-factor));
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .agent-delete-btn:hover {
            background: #cc0000;
            transform: scale(1.1);
        }
        
        .agent-name {
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.8rem * var(--scale-factor));
            color: #ffffff;
            margin-bottom: calc(6px * var(--scale-factor));
            padding-bottom: calc(4px * var(--scale-factor));
            border-bottom: calc(1px * var(--scale-factor)) dashed #404040;
        }
        
        .agent-status {
            width: calc(10px * var(--scale-factor));
            height: calc(10px * var(--scale-factor));
            border-radius: 50%;
            margin-right: calc(6px * var(--scale-factor));
        }
        
        .agent-status.mining {
            background: #00ff00;
            box-shadow: 0 0 calc(4px * var(--scale-factor)) #00ff00;
        }
        
        .agent-status.inactive {
            background: #404040;
        }
        
        .agent-metrics {
            flex: 1;
            font-size: calc(0.7rem * var(--scale-factor));
            color: #a0a0a0;
        }
        
        /* ========== SIMPLIFIED LINK MODAL ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: calc(20px * var(--scale-factor));
        }
        
        .modal-content {
            background: rgba(15, 15, 15, 0.98);
            border: calc(5px * var(--scale-factor)) solid #404040;
            padding: calc(20px * var(--scale-factor));
            max-width: calc(800px * var(--scale-factor));
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 calc(30px * var(--scale-factor)) rgba(0, 255, 0, 0.2);
        }
        
        .modal-title {
            font-family: 'Press Start 2P', monospace;
            color: #ffffff;
            font-size: calc(1.2rem * var(--scale-factor));
            text-align: center;
            margin-bottom: calc(20px * var(--scale-factor));
            padding-bottom: calc(10px * var(--scale-factor));
            border-bottom: calc(3px * var(--scale-factor)) dashed #404040;
        }
        
        /* Simplified Link Hub */
        .link-simple {
            display: flex;
            flex-direction: column;
            gap: calc(15px * var(--scale-factor));
        }
        
        .link-explanation {
            color: #a0a0a0;
            font-size: calc(0.9rem * var(--scale-factor));
            text-align: center;
            margin-bottom: calc(10px * var(--scale-factor));
        }
        
        .link-explanation strong {
            color: #00ff00;
        }
        
        /* Agent Selection Area */
        .agents-selection {
            background: rgba(0, 0, 0, 0.7);
            border: calc(2px * var(--scale-factor)) solid #404040;
            padding: calc(15px * var(--scale-factor));
            margin-bottom: calc(15px * var(--scale-factor));
        }
        
        .agents-selection-header {
            font-family: 'Press Start 2P', monospace;
            color: #00ff00;
            font-size: calc(0.9rem * var(--scale-factor));
            margin-bottom: calc(10px * var(--scale-factor));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agents-list-simple {
            max-height: calc(250px * var(--scale-factor));
            overflow-y: auto;
            border: calc(1px * var(--scale-factor)) solid #404040;
            background: #000;
        }
        
        .agent-item-simple {
            display: flex;
            align-items: center;
            padding: calc(10px * var(--scale-factor)) calc(12px * var(--scale-factor));
            border-bottom: calc(1px * var(--scale-factor)) solid #303030;
            transition: all 0.2s;
        }
        
        .agent-item-simple:hover {
            background: rgba(0, 255, 0, 0.05);
        }
        
        .agent-item-simple.selected {
            background: rgba(0, 255, 0, 0.1);
            border-left: calc(4px * var(--scale-factor)) solid #00ff00;
        }
        
        .agent-checkbox-simple {
            margin-right: calc(12px * var(--scale-factor));
            width: calc(18px * var(--scale-factor));
            height: calc(18px * var(--scale-factor));
            accent-color: #00ff00;
            cursor: pointer;
        }
        
        .agent-info-simple {
            flex: 1;
        }
        
        .agent-name-simple {
            color: #ffffff;
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.8rem * var(--scale-factor));
            margin-bottom: calc(3px * var(--scale-factor));
        }
        
        .agent-details-simple {
            color: #a0a0a0;
            font-size: calc(0.7rem * var(--scale-factor));
            display: flex;
            gap: calc(10px * var(--scale-factor));
        }
        
        .agent-network-badge {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            padding: calc(2px * var(--scale-factor)) calc(6px * var(--scale-factor));
            border-radius: calc(3px * var(--scale-factor));
            font-size: calc(0.6rem * var(--scale-factor));
        }
        
        /* Network Creation Area */
        .network-creation {
            background: rgba(0, 20, 0, 0.3);
            border: calc(2px * var(--scale-factor)) solid #404040;
            padding: calc(15px * var(--scale-factor));
            margin-bottom: calc(15px * var(--scale-factor));
        }
        
        .network-creation-header {
            font-family: 'Press Start 2P', monospace;
            color: #ffff00;
            font-size: calc(0.9rem * var(--scale-factor));
            margin-bottom: calc(15px * var(--scale-factor));
            text-align: center;
        }
        
        .selected-agents-list {
            display: flex;
            flex-wrap: wrap;
            gap: calc(8px * var(--scale-factor));
            margin-bottom: calc(15px * var(--scale-factor));
            min-height: calc(40px * var(--scale-factor));
        }
        
        .selected-agent-tag {
            background: rgba(0, 255, 0, 0.2);
            border: calc(1px * var(--scale-factor)) solid #00ff00;
            color: #ffffff;
            padding: calc(6px * var(--scale-factor)) calc(10px * var(--scale-factor));
            font-size: calc(0.8rem * var(--scale-factor));
            border-radius: calc(3px * var(--scale-factor));
            display: flex;
            align-items: center;
            gap: calc(6px * var(--scale-factor));
        }
        
        .remove-agent-tag {
            background: none;
            border: none;
            color: #ff0000;
            cursor: pointer;
            font-size: calc(0.9rem * var(--scale-factor));
            padding: 0;
            margin: 0;
        }
        
        .network-strength-display {
            background: rgba(0, 0, 0, 0.5);
            border: calc(1px * var(--scale-factor)) solid #404040;
            padding: calc(10px * var(--scale-factor));
            margin-bottom: calc(15px * var(--scale-factor));
            text-align: center;
        }
        
        .strength-value {
            color: #00ff00;
            font-family: 'Press Start 2P', monospace;
            font-size: calc(1.2rem * var(--scale-factor));
            margin: calc(5px * var(--scale-factor)) 0;
        }
        
        .strength-info {
            color: #a0a0a0;
            font-size: calc(0.7rem * var(--scale-factor));
        }
        
        /* Network Management */
        .networks-management {
            background: rgba(20, 0, 20, 0.3);
            border: calc(2px * var(--scale-factor)) solid #404040;
            padding: calc(15px * var(--scale-factor));
        }
        
        .networks-management-header {
            font-family: 'Press Start 2P', monospace;
            color: #8b5cf6;
            font-size: calc(0.9rem * var(--scale-factor));
            margin-bottom: calc(15px * var(--scale-factor));
            text-align: center;
        }
        
        .networks-list {
            max-height: calc(200px * var(--scale-factor));
            overflow-y: auto;
            border: calc(1px * var(--scale-factor)) solid #404040;
            background: #000;
        }
        
        .network-item {
            padding: calc(12px * var(--scale-factor));
            border-bottom: calc(1px * var(--scale-factor)) solid #303030;
        }
        
        .network-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(8px * var(--scale-factor));
        }
        
        .network-name {
            color: #ffffff;
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.8rem * var(--scale-factor));
        }
        
        .network-strength {
            color: #ffff00;
            font-size: calc(0.8rem * var(--scale-factor));
        }
        
        .network-agents {
            display: flex;
            flex-wrap: wrap;
            gap: calc(6px * var(--scale-factor));
            margin-bottom: calc(10px * var(--scale-factor));
        }
        
        .network-agent {
            background: rgba(139, 92, 246, 0.2);
            border: calc(1px * var(--scale-factor)) solid #8b5cf6;
            color: #c0c0c0;
            padding: calc(4px * var(--scale-factor)) calc(8px * var(--scale-factor));
            font-size: calc(0.7rem * var(--scale-factor));
            border-radius: calc(3px * var(--scale-factor));
        }
        
        .network-actions {
            display: flex;
            gap: calc(8px * var(--scale-factor));
        }
        
        .network-action-btn {
            flex: 1;
            padding: calc(6px * var(--scale-factor));
            background: #000;
            border: calc(2px * var(--scale-factor)) solid #404040;
            color: #c0c0c0;
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.6rem * var(--scale-factor));
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .network-action-btn:hover {
            border-color: #ff0000;
            color: #ff0000;
        }
        
        .network-action-btn.break {
            border-color: #ff8000;
            color: #ff8000;
        }
        
        .network-action-btn.break:hover {
            border-color: #ff0000;
            color: #ff0000;
        }
        
        /* Link Actions */
        .link-actions-simple {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(150px * var(--scale-factor)), 1fr));
            gap: calc(10px * var(--scale-factor));
            margin-top: calc(20px * var(--scale-factor));
        }
        
        .link-action-simple {
            padding: calc(12px * var(--scale-factor));
            font-family: 'Press Start 2P', monospace;
            font-size: calc(0.8rem * var(--scale-factor));
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .link-action-simple.primary {
            background: #000;
            border: calc(3px * var(--scale-factor)) solid #00ff00;
            color: #00ff00;
        }
        
        .link-action-simple.secondary {
            background: #000;
            border: calc(3px * var(--scale-factor)) solid #404040;
            color: #c0c0c0;
        }
        
        .link-action-simple:hover {
            transform: translateY(calc(-2px * var(--scale-factor)));
            box-shadow: 0 calc(4px * var(--scale-factor)) calc(8px * var(--scale-factor)) rgba(0, 0, 0, 0.3);
        }
        
        /* Empty States */
        .empty-state {
            color: #606060;
            text-align: center;
            padding: calc(40px * var(--scale-factor));
            font-size: calc(0.9rem * var(--scale-factor));
        }
        
        /* ========== ERROR/WARNING STYLES ========== */
        .warning-box {
            background: rgba(255, 128, 0, 0.1);
            border: calc(2px * var(--scale-factor)) solid #ff8000;
            padding: calc(12px * var(--scale-factor));
            margin: calc(10px * var(--scale-factor)) 0;
            font-size: calc(0.9rem * var(--scale-factor));
            color: #ff8000;
        }
        
        .error-trace {
            background: rgba(255, 0, 0, 0.05);
            border-left: calc(4px * var(--scale-factor)) solid #ff0000;
            padding: calc(10px * var(--scale-factor));
            margin: calc(8px * var(--scale-factor)) 0;
            font-family: monospace;
            font-size: calc(0.8rem * var(--scale-factor));
            color: #ff6666;
            max-height: calc(150px * var(--scale-factor));
            overflow-y: auto;
        }
        
        .resource-warning {
            background: rgba(255, 255, 0, 0.1);
            border: calc(2px * var(--scale-factor)) solid #ffff00;
            padding: calc(10px * var(--scale-factor));
            margin: calc(8px * var(--scale-factor)) 0;
            font-size: calc(0.8rem * var(--scale-factor));
            color: #ffff00;
        }
        
        /* ========== PERFORMANCE METER ========== */
        .performance-meter {
            position: fixed;
            bottom: calc(10px * var(--scale-factor));
            right: calc(10px * var(--scale-factor));
            background: rgba(0, 0, 0, 0.9);
            border: calc(2px * var(--scale-factor)) solid #404040;
            padding: calc(8px * var(--scale-factor));
            font-size: calc(0.7rem * var(--scale-factor));
            z-index: 9998;
            display: none;
            min-width: calc(180px * var(--scale-factor));
        }
        
        .perf-bar {
            width: calc(80px * var(--scale-factor));
            height: calc(10px * var(--scale-factor));
            background: #303030;
            margin: calc(4px * var(--scale-factor)) 0;
            overflow: hidden;
            border: calc(1px * var(--scale-factor)) solid #202020;
        }
        
        .perf-fill {
            height: 100%;
            background: #00ff00;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* ========== LOADING SCREEN ========== */
        .qwik-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        
        .qwik-spinner {
            width: calc(50px * var(--scale-factor));
            height: calc(50px * var(--scale-factor));
            border: calc(3px * var(--scale-factor)) solid #404040;
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* ========== SCROLLBARS ========== */
        .agent-grid::-webkit-scrollbar,
        .terminal-body::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar,
        .agents-list-simple::-webkit-scrollbar,
        .networks-list::-webkit-scrollbar {
            width: calc(8px * var(--scale-factor));
        }
        
        .agent-grid::-webkit-scrollbar-thumb,
        .terminal-body::-webkit-scrollbar-thumb,
        .sidebar::-webkit-scrollbar-thumb,
        .agents-list-simple::-webkit-scrollbar-thumb,
        .networks-list::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: calc(4px * var(--scale-factor));
        }
        
        .agent-grid::-webkit-scrollbar-thumb:hover,
        .terminal-body::-webkit-scrollbar-thumb:hover,
        .sidebar::-webkit-scrollbar-thumb:hover,
        .agents-list-simple::-webkit-scrollbar-thumb:hover,
        .networks-list::-webkit-scrollbar-thumb:hover {
            background: #505050;
        }
        
        /* ========== ANIMATIONS ========== */
        @keyframes realtimePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* ========== RESPONSIVE ADJUSTMENTS ========== */
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                min-width: 100%;
                max-height: 40vh;
            }
            
            .agent-grid {
                grid-template-columns: repeat(auto-fill, minmax(calc(150px * var(--scale-factor)), 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: calc(8px * var(--scale-factor));
            }
            
            .network-status {
                align-self: stretch;
                justify-content: space-between;
            }
            
            .quick-actions {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .modal-content {
                width: 98%;
                padding: calc(15px * var(--scale-factor));
            }
            
            .link-actions-simple {
                grid-template-columns: 1fr;
            }
            
            .network-actions {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .agent-grid {
                grid-template-columns: 1fr;
            }
            
            .terminal-title {
                font-size: calc(0.8rem * var(--scale-factor));
            }
            
            .agent-details-simple {
                flex-direction: column;
                gap: calc(3px * var(--scale-factor));
            }
        }
        
        @media (max-height: 700px) {
            .terminal-body {
                max-height: calc(200px * var(--scale-factor));
            }
            
            .agent-grid {
                max-height: calc(150px * var(--scale-factor));
            }
            
            .agents-list-simple {
                max-height: calc(150px * var(--scale-factor));
            }
        }
    </style>
</head>
<body>
    <!-- Performance Monitor -->
    <div class="performance-meter" id="performance-meter">
        <div>CPU: <span id="cpu-meter">0%</span></div>
        <div class="perf-bar"><div class="perf-fill" id="cpu-bar"></div></div>
        <div>GPU: <span id="gpu-meter">0%</span></div>
        <div class="perf-bar"><div class="perf-fill" id="gpu-bar"></div></div>
        <div>MEM: <span id="mem-meter">0%</span></div>
        <div class="perf-bar"><div class="perf-fill" id="mem-bar"></div></div>
    </div>
    
    <!-- Loading Screen -->
    <div class="qwik-loading" id="qwik-loading">
        <div class="qwik-spinner"></div>
        <div style="color: #ffffff; font-family: 'Press Start 2P'; font-size: calc(1.2rem * var(--scale-factor)); margin: calc(12px * var(--scale-factor)) 0;">
            MACROSLOW AGENT IDE
        </div>
        <div style="color: #a0a0a0; text-align: center; font-size: calc(0.9rem * var(--scale-factor));" id="loading-status">
            Initializing Real-Time System...
        </div>
    </div>
    
    <!-- Header -->
    <header id="app-header" style="display: none;">
        <div class="header-top">
            <div style="display: flex; align-items: center; gap: calc(10px * var(--scale-factor));">
                <h1>MACROSLOW AGENT IDE</h1>
                <span class="realtime-badge">REAL-TIME</span>
            </div>
            <div class="network-status">
                <span>ORCH: <span id="network-status" style="color: #00ff00;">$macroslow</span></span>
                <span>WS: <span class="ws-status" id="ws-status"></span><span id="ws-status-text">OFF</span></span>
                <span>AGENTS: <span id="agent-count">0</span></span>
            </div>
        </div>
        <div class="header-info">
            <span>HASH/S: <span id="hash-rate">0</span></span>
            <span>NETWORKS: <span id="network-count">0</span></span>
            <span>ENC: <span style="color: #00ff00;">256-bit</span></span>
            <span>SCALE: <span id="network-scale">1x</span></span>
            <span>PERF: <span id="performance-status">OK</span></span>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container" id="main-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-title">CREATE AGENT</div>
            
            <div class="agent-form">
                <div style="margin-bottom: calc(10px * var(--scale-factor));">
                    <label style="display: block; color: #a0a0a0; font-size: calc(0.8rem * var(--scale-factor)); margin-bottom: calc(5px * var(--scale-factor));">
                        AGENT NAME (AUTO):
                    </label>
                    <input type="text" id="agent-name" class="form-input" placeholder="Agent 1, Agent 2, ..." readonly>
                </div>
                
                <div style="margin-bottom: calc(10px * var(--scale-factor));">
                    <label style="display: block; color: #a0a0a0; font-size: calc(0.8rem * var(--scale-factor)); margin-bottom: calc(5px * var(--scale-factor));">
                        AGENT TYPE:
                    </label>
                    <select id="agent-type" class="form-select">
                        <option value="miner">Hash Miner</option>
                        <option value="validator">Validator</option>
                        <option value="bridge">Network Bridge</option>
                    </select>
                </div>
                
                <div style="margin-bottom: calc(10px * var(--scale-factor));">
                    <label style="display: block; color: #a0a0a0; font-size: calc(0.8rem * var(--scale-factor)); margin-bottom: calc(5px * var(--scale-factor));">
                        ENCRYPTION (256-BIT ONLY):
                    </label>
                    <input type="text" class="form-input" value="SHA-256 AES" readonly style="color: #00ff00;">
                </div>
                
                <button id="create-agent-btn" class="create-agent-btn">DEPLOY AGENT</button>
            </div>
            
            <div class="sidebar-title">ACTIVE AGENTS</div>
            <div class="agent-grid" id="agents-sidebar">
                <div style="color: #606060; text-align: center; padding: calc(20px * var(--scale-factor)); font-size: calc(0.9rem * var(--scale-factor));">
                    No agents deployed
                </div>
            </div>
        </div>
        
        <!-- Main Area -->
        <div class="terminal-orchestrator">
            <!-- Terminal -->
            <div class="terminal-container">
                <div class="terminal-header">
                    <div class="terminal-title">
                        <span>$macroslow TERMINAL v4.1</span>
                    </div>
                    <div style="color: #a0a0a0; font-size: calc(0.7rem * var(--scale-factor));">SIMPLIFIED LINK EDITION</div>
                </div>
                <div class="terminal-body" id="terminal-log"></div>
                <div class="terminal-input">
                    <div class="prompt">$macroslow></div>
                    <input type="text" id="terminal-input" placeholder="Type /help for commands..." autofocus>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="action-btn" id="start-all-btn">
                    <span>‚ñ∂</span><span>START ALL</span>
                </button>
                <button class="action-btn" id="stop-all-btn">
                    <span>‚è∏</span><span>STOP ALL</span>
                </button>
                <button class="action-btn" id="link-agents-btn">
                    <span>üîó</span><span>LINK</span>
                </button>
                <button class="action-btn" id="import-export-btn">
                    <span>üìÇ</span><span>IMPORT/EXPORT</span>
                </button>
                <button class="action-btn" id="stats-btn">
                    <span>üìä</span><span>STATS</span>
                </button>
                <button class="action-btn" id="clear-btn">
                    <span>üóëÔ∏è</span><span>CLEAR</span>
                </button>
            </div>
            
            <!-- Agent Grid -->
            <div class="agent-grid-container">
                <div style="padding: calc(10px * var(--scale-factor)) calc(15px * var(--scale-factor)); background: #000; border-bottom: calc(2px * var(--scale-factor)) dashed #404040; display: flex; justify-content: space-between;">
                    <div class="sidebar-title" style="margin: 0;">ACTIVE AGENTS</div>
                    <div style="color: #a0a0a0; font-size: calc(0.7rem * var(--scale-factor));" id="grid-stats">0 agents</div>
                </div>
                <div class="agent-grid" id="agent-grid"></div>
            </div>
        </div>
    </div>
    
    <!-- Simplified Link Modal -->
    <div class="modal" id="link-modal">
        <div class="modal-content">
            <button style="position: absolute; top: calc(12px * var(--scale-factor)); right: calc(12px * var(--scale-factor)); background: none; border: none; color: #ff0000; font-size: calc(24px * var(--scale-factor)); cursor: pointer; width: calc(30px * var(--scale-factor)); height: calc(30px * var(--scale-factor)); display: flex; align-items: center; justify-content: center;" 
                    id="close-link-modal">√ó</button>
            <div class="modal-title">AGENT LINKING SIMPLIFIED</div>
            
            <div class="link-simple">
                <div class="link-explanation">
                    Select 2-4 agents to link into networks.<br>
                    <strong>2 agents = 512-bit | 3 agents = 768-bit | 4 agents = 1024-bit</strong>
                </div>
                
                <!-- Agent Selection -->
                <div class="agents-selection">
                    <div class="agents-selection-header">
                        <span>SELECT AGENTS</span>
                        <button class="action-btn" id="select-all-btn" style="padding: calc(6px * var(--scale-factor)) calc(10px * var(--scale-factor)); font-size: calc(0.6rem * var(--scale-factor));">SELECT ALL</button>
                    </div>
                    
                    <div class="agents-list-simple" id="agents-list-simple">
                        <div class="empty-state" id="no-agents-message">
                            No agents available. Create agents first.
                        </div>
                    </div>
                </div>
                
                <!-- Network Creation -->
                <div class="network-creation">
                    <div class="network-creation-header">CREATE NETWORK</div>
                    
                    <div class="selected-agents-list" id="selected-agents-list">
                        <div class="empty-state" style="padding: 10px; font-size: 0.8rem; width: 100%;">
                            No agents selected. Click agents above to select.
                        </div>
                    </div>
                    
                    <div class="network-strength-display" id="network-strength-display" style="display: none;">
                        <div>VIRTUAL ENCRYPTION STRENGTH</div>
                        <div class="strength-value" id="strength-value">0-bit</div>
                        <div class="strength-info" id="strength-info">
                            Select 2-4 agents to create a network
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: calc(10px * var(--scale-factor));">
                        <button class="action-btn" style="flex: 1; padding: calc(10px * var(--scale-factor));" id="clear-selection-btn">
                            CLEAR SELECTION
                        </button>
                        <button class="action-btn" style="flex: 1; padding: calc(10px * var(--scale-factor)); background: #000; border-color: #00ff00; color: #00ff00;" id="create-network-btn">
                            CREATE NETWORK
                        </button>
                    </div>
                </div>
                
                <!-- Existing Networks -->
                <div class="networks-management">
                    <div class="networks-management-header">EXISTING NETWORKS</div>
                    
                    <div class="networks-list" id="networks-list">
                        <div class="empty-state">
                            No networks created yet
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: calc(10px * var(--scale-factor)); margin-top: calc(15px * var(--scale-factor));">
                        <button class="action-btn" style="flex: 1; padding: calc(10px * var(--scale-factor));" id="unlink-all-btn">
                            UNLINK ALL
                        </button>
                        <button class="action-btn" style="flex: 1; padding: calc(10px * var(--scale-factor)); background: #000; border-color: #ffff00; color: #ffff00;" id="auto-link-btn">
                            AUTO-LINK
                        </button>
                    </div>
                </div>
                
                <!-- Modal Actions -->
                <div class="link-actions-simple">
                    <button class="link-action-simple secondary" id="cancel-link-btn">CLOSE</button>
                    <button class="link-action-simple primary" id="apply-links-btn">APPLY & CLOSE</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import/Export Modal (simplified version) -->
    <div class="modal" id="import-export-modal">
        <div class="modal-content">
            <button style="position: absolute; top: calc(12px * var(--scale-factor)); right: calc(12px * var(--scale-factor)); background: none; border: none; color: #ff0000; font-size: calc(24px * var(--scale-factor)); cursor: pointer; width: calc(30px * var(--scale-factor)); height: calc(30px * var(--scale-factor)); display: flex; align-items: center; justify-content: center;" 
                    id="close-import-export-modal">√ó</button>
            <div class="modal-title">IMPORT/EXPORT</div>
            
            <div style="color: #a0a0a0; font-size: calc(0.9rem * var(--scale-factor)); margin-bottom: calc(20px * var(--scale-factor)); text-align: center;">
                Save or load your network configuration
            </div>
            
            <!-- Export Section -->
            <div style="background: rgba(0, 20, 0, 0.3); border: calc(2px * var(--scale-factor)) solid #404040; padding: calc(15px * var(--scale-factor)); margin-bottom: calc(15px * var(--scale-factor));">
                <div style="font-family: 'Press Start 2P'; color: #00ff00; font-size: calc(0.9rem * var(--scale-factor)); margin-bottom: calc(10px * var(--scale-factor)); text-align: center;">
                    EXPORT NETWORK
                </div>
                <input type="text" id="export-name" class="form-input" placeholder="Network name..." style="margin-bottom: calc(10px * var(--scale-factor));">
                <div style="display: flex; gap: calc(10px * var(--scale-factor));">
                    <button class="action-btn" style="flex: 1;" id="cancel-export-btn">CANCEL</button>
                    <button class="action-btn" style="flex: 1; background: #000; border-color: #00ff00; color: #00ff00;" id="confirm-export-btn">EXPORT</button>
                </div>
            </div>
            
            <!-- Import Section -->
            <div style="background: rgba(20, 0, 20, 0.3); border: calc(2px * var(--scale-factor)) solid #404040; padding: calc(15px * var(--scale-factor));">
                <div style="font-family: 'Press Start 2P'; color: #8b5cf6; font-size: calc(0.9rem * var(--scale-factor)); margin-bottom: calc(10px * var(--scale-factor)); text-align: center;">
                    IMPORT NETWORK
                </div>
                <div style="text-align: center; margin-bottom: calc(15px * var(--scale-factor));">
                    <button class="action-btn" style="width: 100%; margin-bottom: calc(10px * var(--scale-factor));" id="import-file-btn">
                        SELECT FILE
                    </button>
                    <input type="file" id="file-input" style="display: none;" accept=".json,.zip">
                    <div style="color: #a0a0a0; font-size: calc(0.8rem * var(--scale-factor));">
                        Supports .json and .zip files
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// ============================================
// SIMPLIFIED MACROSLOW AGENT SYSTEM v4.1
// With Clean Link Interface
// ============================================

class SimplifiedAgentSystem {
    constructor() {
        this.agents = [];
        this.linkedNetworks = new Map();
        this.agentCounter = 1;
        this.systemMetrics = {
            totalHashes: 0,
            hashRate: 0,
            activeAgents: 0,
            networkScale: 1,
            cpuUsage: 0,
            gpuUsage: 0,
            memoryUsage: 0,
            performanceWarning: false
        };
        
        // GPU.js integration
        this.gpu = null;
        this.gpuAvailable = false;
        
        // Error tracking
        this.errorLog = [];
        this.aiErrorHandler = new AIErrorHandler();
        
        // Auto-link configuration
        this.autoLinkConfig = {
            maxAgentsPerNetwork: 4,
            baseHashRate: 100,
            scaleReductionFactor: 0.7
        };
        
        // Simplified link modal state
        this.linkModalState = {
            selectedAgentIds: new Set(),
            networkIdCounter: 1
        };
        
        // Initialize
        this.initialize();
    }
    
    async initialize() {
        console.log('üöÄ Initializing Simplified MACROSLOW System...');
        
        // Check GPU availability
        await this.checkGPUAvailability();
        
        // Initialize WebGL/WASM if available
        await this.initWebGL();
        
        // Start performance monitoring
        this.startPerformanceMonitor();
        
        // Load any saved state
        this.loadState();
        
        console.log('‚úÖ System Initialized');
    }
    
    async checkGPUAvailability() {
        try {
            if (window.GPU) {
                this.gpu = new GPU();
                this.gpuAvailable = true;
                this.logTrace('GPU.js detected and initialized', 'info');
            }
        } catch (error) {
            this.logTrace('GPU.js not available: ' + error.message, 'warning');
            this.gpuAvailable = false;
        }
    }
    
    async initWebGL() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (gl) {
                this.logTrace('WebGL available', 'info');
            }
        } catch (error) {
            this.logTrace('WebGL not available', 'warning');
        }
    }
    
    startPerformanceMonitor() {
        setInterval(() => {
            this.updatePerformanceMetrics();
            this.checkResourceLimits();
        }, 2000);
    }
    
    updatePerformanceMetrics() {
        const agentLoad = this.agents.length * 0.5;
        const hashLoad = this.systemMetrics.hashRate / 1000;
        
        this.systemMetrics.cpuUsage = Math.min(100, Math.round(agentLoad + hashLoad * 0.3));
        this.systemMetrics.gpuUsage = Math.min(100, Math.round(this.gpuAvailable ? hashLoad * 0.4 : 0));
        this.systemMetrics.memoryUsage = Math.min(100, Math.round(agentLoad * 1.5));
        
        this.updatePerformanceUI();
    }
    
    updatePerformanceUI() {
        const cpuMeter = document.getElementById('cpu-meter');
        const gpuMeter = document.getElementById('gpu-meter');
        const memMeter = document.getElementById('mem-meter');
        const cpuBar = document.getElementById('cpu-bar');
        const gpuBar = document.getElementById('gpu-bar');
        const memBar = document.getElementById('mem-bar');
        const perfStatus = document.getElementById('performance-status');
        
        if (cpuMeter) cpuMeter.textContent = this.systemMetrics.cpuUsage + '%';
        if (gpuMeter) gpuMeter.textContent = this.systemMetrics.gpuUsage + '%';
        if (memMeter) memMeter.textContent = this.systemMetrics.memoryUsage + '%';
        if (cpuBar) cpuBar.style.width = this.systemMetrics.cpuUsage + '%';
        if (gpuBar) gpuBar.style.width = this.systemMetrics.gpuUsage + '%';
        if (memBar) memBar.style.width = this.systemMetrics.memoryUsage + '%';
        
        if (cpuBar) cpuBar.style.background = this.getUsageColor(this.systemMetrics.cpuUsage);
        if (gpuBar) gpuBar.style.background = this.getUsageColor(this.systemMetrics.gpuUsage);
        if (memBar) memBar.style.background = this.getUsageColor(this.systemMetrics.memoryUsage);
        
        if (perfStatus) {
            if (this.systemMetrics.performanceWarning) {
                perfStatus.textContent = 'WARN';
                perfStatus.style.color = '#ff8000';
            } else if (this.systemMetrics.cpuUsage > 80 || this.systemMetrics.memoryUsage > 80) {
                perfStatus.textContent = 'HIGH';
                perfStatus.style.color = '#ffff00';
            } else {
                perfStatus.textContent = 'OK';
                perfStatus.style.color = '#00ff00';
            }
        }
    }
    
    getUsageColor(usage) {
        if (usage < 50) return '#00ff00';
        if (usage < 75) return '#ffff00';
        if (usage < 90) return '#ff8000';
        return '#ff0000';
    }
    
    checkResourceLimits() {
        const warnings = [];
        
        if (this.systemMetrics.cpuUsage > 85) {
            warnings.push('CPU usage high: ' + this.systemMetrics.cpuUsage + '%');
        }
        
        if (this.systemMetrics.memoryUsage > 85) {
            warnings.push('Memory usage high: ' + this.systemMetrics.memoryUsage + '%');
        }
        
        if (this.agents.length > 8) {
            warnings.push('Many active agents may impact performance');
        }
        
        this.systemMetrics.performanceWarning = warnings.length > 0;
        
        if (warnings.length > 0 && window.macroslow) {
            window.macroslow.speak('‚ö†Ô∏è System warning: ' + warnings.join(' | '), 'warning');
        }
    }
    
    async createAgent() {
        const agentName = `Agent ${this.agentCounter++}`;
        
        const agent = {
            id: 'agent_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8),
            name: agentName,
            type: document.getElementById('agent-type')?.value || 'miner',
            encryptionBits: 256,
            hashAlgorithm: 'sha256',
            status: 'inactive',
            hashRate: this.autoLinkConfig.baseHashRate,
            totalHashes: 0,
            currentHash: '',
            networkId: null,
            networkNumber: null,
            created: Date.now(),
            miningActive: false,
            adaptiveNetwork: this.generateAdaptiveNetwork()
        };
        
        agent.currentHash = await this.generateSHA256Hash(agent, 'INIT');
        
        this.agents.push(agent);
        this.updateSystemStats();
        this.saveState();
        
        this.logTrace(`Agent created: ${agentName}`, 'info');
        
        return agent;
    }
    
    generateAdaptiveNetwork() {
        return {
            id: 'net_' + Math.random().toString(36).substr(2, 8),
            bandwidth: Math.floor(Math.random() * 100) + 50,
            latency: Math.floor(Math.random() * 20) + 10,
            stability: Math.random() * 0.5 + 0.5
        };
    }
    
    async generateSHA256Hash(agent, data) {
        const input = data + agent.id + Date.now() + Math.random();
        
        try {
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        } catch (error) {
            this.logTrace('Web Crypto failed, using CryptoJS fallback', 'warning');
            return CryptoJS.SHA256(input).toString();
        }
    }
    
    async startAgentMining(agentId) {
        const agent = this.agents.find(a => a.id === agentId);
        if (!agent || agent.status === 'mining') return;
        
        agent.status = 'mining';
        agent.miningActive = true;
        agent.lastHashTime = Date.now();
        
        const network = this.getAgentNetwork(agentId);
        if (network && network.agents.length > 1) {
            agent.hashRate = Math.round(
                this.autoLinkConfig.baseHashRate * 
                Math.pow(this.autoLinkConfig.scaleReductionFactor, network.agents.length - 1)
            );
        }
        
        this.startMiningLoop(agentId);
    }
    
    async startMiningLoop(agentId) {
        const agent = this.agents.find(a => a.id === agentId);
        if (!agent || !agent.miningActive) return;
        
        try {
            const hash = await this.generateSHA256Hash(agent, `MINING-${Date.now()}`);
            this.updateAgentHash(agent.id, hash);
            
            const speed = 1000 / Math.max(agent.hashRate / 10, 1);
            
            setTimeout(() => this.startMiningLoop(agentId), speed);
        } catch (error) {
            this.handleError(error, 'Mining loop');
            this.stopAgentMining(agentId);
        }
    }
    
    updateAgentHash(agentId, hash) {
        const agent = this.agents.find(a => a.id === agentId);
        if (!agent) return;
        
        agent.totalHashes++;
        agent.currentHash = hash;
        
        const now = Date.now();
        const elapsed = now - agent.lastHashTime;
        if (elapsed >= 1000) {
            agent.hashRate = Math.round((agent.totalHashes * 1000) / elapsed);
            agent.lastHashTime = now;
        }
        
        this.updateUI();
    }
    
    stopAgentMining(agentId) {
        const agent = this.agents.find(a => a.id === agentId);
        if (agent) {
            agent.status = 'inactive';
            agent.miningActive = false;
        }
    }
    
    deleteAgent(agentId) {
        if (!confirm('Delete this agent?')) return;
        
        const agent = this.agents.find(a => a.id === agentId);
        if (agent) {
            this.stopAgentMining(agentId);
            this.agents = this.agents.filter(a => a.id !== agentId);
            
            // Remove from networks
            this.linkedNetworks.forEach((network, key) => {
                network.agents = network.agents.filter(id => id !== agentId);
                if (network.agents.length < 2) {
                    this.linkedNetworks.delete(key);
                }
            });
            
            this.updateSystemStats();
            this.saveState();
            this.logTrace(`Agent deleted: ${agent.name}`, 'warning');
        }
    }
    
    linkAgents(agentIds) {
        if (agentIds.length < 2) {
            throw new Error('Need at least 2 agents to link');
        }
        
        if (agentIds.length > this.autoLinkConfig.maxAgentsPerNetwork) {
            throw new Error(`Maximum ${this.autoLinkConfig.maxAgentsPerNetwork} agents per network`);
        }
        
        // Check if any agent is already in a network
        const alreadyLinkedAgents = [];
        agentIds.forEach(agentId => {
            if (this.getAgentNetwork(agentId)) {
                const agent = this.agents.find(a => a.id === agentId);
                alreadyLinkedAgents.push(agent?.name || agentId);
            }
        });
        
        if (alreadyLinkedAgents.length > 0) {
            throw new Error(`Some agents are already linked: ${alreadyLinkedAgents.join(', ')}`);
        }
        
        // Generate network number
        let networkNumber = 1;
        while (this.linkedNetworks.has(`network_${networkNumber}`)) {
            networkNumber++;
        }
        
        const encryptionStrength = 256 * agentIds.length;
        
        const network = {
            id: `network_${networkNumber}_${Date.now()}`,
            number: networkNumber,
            agents: agentIds,
            encryptionStrength: encryptionStrength,
            virtualBits: encryptionStrength,
            status: 'active',
            totalHashRate: 0,
            created: Date.now(),
            name: `Network ${networkNumber}`
        };
        
        network.totalHashRate = Math.round(
            this.autoLinkConfig.baseHashRate * 
            agentIds.length * 
            Math.pow(this.autoLinkConfig.scaleReductionFactor, agentIds.length - 1)
        );
        
        agentIds.forEach(agentId => {
            const agent = this.agents.find(a => a.id === agentId);
            if (agent) {
                agent.networkId = network.id;
                agent.networkNumber = networkNumber;
                agent.hashRate = Math.round(network.totalHashRate / agentIds.length);
            }
        });
        
        const key = `network_${networkNumber}`;
        this.linkedNetworks.set(key, network);
        
        this.systemMetrics.networkScale = Math.max(this.systemMetrics.networkScale, agentIds.length);
        document.getElementById('network-scale').textContent = this.systemMetrics.networkScale + 'x';
        
        this.logTrace(`Linked ${agentIds.length} agents into network ${networkNumber} (${encryptionStrength}-bit virtual)`, 'info');
        
        return network;
    }
    
    autoLinkAgents() {
        if (this.agents.length < 2) {
            throw new Error('Need at least 2 agents to auto-link');
        }
        
        // Get unlinked agents
        const availableAgents = [...this.agents].filter(a => !a.networkId);
        
        if (availableAgents.length < 2) {
            throw new Error('Not enough unlinked agents to auto-link');
        }
        
        const networks = [];
        let networkNumber = 1;
        
        // Create networks of 2-4 agents
        while (availableAgents.length >= 2) {
            const networkSize = Math.min(4, availableAgents.length);
            const networkAgents = availableAgents.splice(0, networkSize);
            const agentIds = networkAgents.map(a => a.id);
            
            try {
                const network = this.linkAgents(agentIds);
                networks.push(network);
                networkNumber++;
            } catch (error) {
                this.handleError(error, 'Auto-link');
            }
        }
        
        return networks;
    }
    
    getAgentNetwork(agentId) {
        for (const [key, network] of this.linkedNetworks) {
            if (network.agents.includes(agentId)) {
                return network;
            }
        }
        return null;
    }
    
    unlinkNetwork(networkNumber) {
        const key = `network_${networkNumber}`;
        const network = this.linkedNetworks.get(key);
        
        if (!network) {
            throw new Error(`Network ${networkNumber} not found`);
        }
        
        network.agents.forEach(agentId => {
            const agent = this.agents.find(a => a.id === agentId);
            if (agent) {
                agent.networkId = null;
                agent.networkNumber = null;
                agent.hashRate = this.autoLinkConfig.baseHashRate;
            }
        });
        
        this.linkedNetworks.delete(key);
        
        this.updateSystemStats();
        this.logTrace(`Unlinked network ${networkNumber}`, 'warning');
        
        return true;
    }
    
    unlinkAllNetworks() {
        this.agents.forEach(agent => {
            agent.networkId = null;
            agent.networkNumber = null;
            agent.hashRate = this.autoLinkConfig.baseHashRate;
        });
        
        this.linkedNetworks.clear();
        this.systemMetrics.networkScale = 1;
        document.getElementById('network-scale').textContent = '1x';
        
        this.logTrace('All networks unlinked', 'warning');
        
        return true;
    }
    
    updateSystemStats() {
        this.systemMetrics.totalHashes = this.agents.reduce((sum, agent) => sum + agent.totalHashes, 0);
        this.systemMetrics.hashRate = this.agents.reduce((sum, agent) => sum + agent.hashRate, 0);
        this.systemMetrics.activeAgents = this.agents.filter(a => a.status === 'mining').length;
        
        document.getElementById('agent-count').textContent = this.agents.length;
        document.getElementById('hash-rate').textContent = this.systemMetrics.hashRate;
        document.getElementById('network-count').textContent = this.linkedNetworks.size;
        
        const gridStats = document.getElementById('grid-stats');
        if (gridStats) {
            const mining = this.agents.filter(a => a.status === 'mining').length;
            gridStats.textContent = `${this.agents.length} agents (${mining} active)`;
        }
    }
    
    updateUI() {
        this.updateAgentGrid();
        this.updateSidebar();
    }
    
    updateAgentGrid() {
        const grid = document.getElementById('agent-grid');
        const sidebar = document.getElementById('agents-sidebar');
        
        if (!grid) return;
        
        if (this.agents.length === 0) {
            grid.innerHTML = `
                <div style="color: #606060; text-align: center; padding: 30px; grid-column: 1 / -1; font-size: 0.9rem;">
                    No agents deployed<br>
                    <span style="font-size: 0.8rem;">Create agents using the sidebar</span>
                </div>
            `;
            
            if (sidebar) {
                sidebar.innerHTML = `
                    <div style="color: #606060; text-align: center; padding: 20px; font-size: 0.9rem;">
                        No agents deployed
                    </div>
                `;
            }
            return;
        }
        
        grid.innerHTML = '';
        this.agents.forEach(agent => {
            const networkInfo = agent.networkNumber ? 
                `Net ${agent.networkNumber} (${this.getNetworkStrength(agent.networkId)}-bit)` : 
                'Standalone';
            
            const card = document.createElement('div');
            card.className = 'agent-card';
            card.innerHTML = `
                <button class="agent-delete-btn" data-agent="${agent.id}">X</button>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px dashed #404040;">
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-status ${agent.status}"></div>
                </div>
                <div class="agent-metrics">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="color: #808080;">HASH/S:</span>
                        <span style="color: #ffffff;">${agent.hashRate}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="color: #808080;">TOTAL:</span>
                        <span style="color: #ffffff;">${this.formatNumber(agent.totalHashes)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="color: #808080;">NETWORK:</span>
                        <span style="color: #00ff00;">${networkInfo}</span>
                    </div>
                    <div style="font-size: 0.6rem; color: #606060; margin-top: 8px; word-break: break-all; max-height: 25px; overflow: hidden;" title="${agent.currentHash}">
                        ${agent.currentHash?.substring(0, 24) || 'Generating...'}
                    </div>
                </div>
            `;
            
            card.addEventListener('click', (e) => {
                if (!e.target.classList.contains('agent-delete-btn')) {
                    this.selectAgent(agent.id);
                }
            });
            
            card.querySelector('.agent-delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                this.deleteAgent(agent.id);
            });
            
            grid.appendChild(card);
        });
        
        if (sidebar) {
            sidebar.innerHTML = '';
            this.agents.forEach(agent => {
                const item = document.createElement('div');
                item.style.cssText = `
                    padding: 8px;
                    margin-bottom: 6px;
                    background: rgba(0,0,0,0.5);
                    border: 1px solid #404040;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 0.8rem;
                `;
                
                item.innerHTML = `
                    <div>
                        <div style="color: #ffffff;">${agent.name}</div>
                        <div style="color: #a0a0a0; font-size: 0.7rem;">${agent.type} | ${agent.hashRate}/s</div>
                    </div>
                    <button style="background: ${agent.status === 'mining' ? '#00ff00' : '#404040'}; border: none; color: ${agent.status === 'mining' ? '#000' : '#c0c0c0'}; padding: 5px 8px; font-size: 0.7rem; cursor: pointer; border-radius: 3px;" 
                            data-action="toggle" data-agent="${agent.id}">${agent.status === 'mining' ? '‚è∏' : '‚ñ∂'}</button>
                `;
                
                sidebar.appendChild(item);
                
                item.querySelector('button[data-action="toggle"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (agent.status === 'mining') {
                        this.stopAgentMining(agent.id);
                    } else {
                        this.startAgentMining(agent.id);
                    }
                });
            });
        }
    }
    
    updateSidebar() {
        const agentNameField = document.getElementById('agent-name');
        if (agentNameField) {
            agentNameField.value = `Agent ${this.agentCounter}`;
        }
    }
    
    // ============================================
    // SIMPLIFIED LINK MODAL FUNCTIONS
    // ============================================
    
    updateLinkModal() {
        this.updateAgentsList();
        this.updateSelectedAgentsDisplay();
        this.updateNetworksList();
        this.updateStrengthDisplay();
    }
    
    updateAgentsList() {
        const agentsList = document.getElementById('agents-list-simple');
        const noAgentsMessage = document.getElementById('no-agents-message');
        
        if (!agentsList) return;
        
        if (this.agents.length === 0) {
            agentsList.innerHTML = '';
            agentsList.appendChild(noAgentsMessage);
            return;
        }
        
        agentsList.innerHTML = '';
        
        this.agents.forEach(agent => {
            const isSelected = this.linkModalState.selectedAgentIds.has(agent.id);
            const networkInfo = agent.networkNumber ? `Net ${agent.networkNumber}` : 'Standalone';
            
            const item = document.createElement('div');
            item.className = `agent-item-simple ${isSelected ? 'selected' : ''}`;
            item.dataset.agentId = agent.id;
            
            item.innerHTML = `
                <input type="checkbox" class="agent-checkbox-simple" ${isSelected ? 'checked' : ''}>
                <div class="agent-info-simple">
                    <div class="agent-name-simple">${agent.name}</div>
                    <div class="agent-details-simple">
                        <span>${agent.type}</span>
                        <span>${agent.hashRate}/s</span>
                        <span>${agent.status}</span>
                        ${agent.networkNumber ? `<span class="agent-network-badge">${networkInfo}</span>` : ''}
                    </div>
                </div>
            `;
            
            const checkbox = item.querySelector('.agent-checkbox-simple');
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                this.toggleAgentSelection(agent.id);
            });
            
            item.addEventListener('click', (e) => {
                if (e.target !== checkbox) {
                    this.toggleAgentSelection(agent.id);
                }
            });
            
            agentsList.appendChild(item);
        });
    }
    
    toggleAgentSelection(agentId) {
        if (this.linkModalState.selectedAgentIds.has(agentId)) {
            this.linkModalState.selectedAgentIds.delete(agentId);
        } else {
            // Check if agent is already in a network
            const agent = this.agents.find(a => a.id === agentId);
            if (agent && agent.networkId) {
                window.macroslow?.speak(`Agent ${agent.name} is already in Network ${agent.networkNumber}. Unlink it first.`, 'warning');
                return;
            }
            
            this.linkModalState.selectedAgentIds.add(agentId);
        }
        
        this.updateLinkModal();
    }
    
    selectAllAgents() {
        this.agents.forEach(agent => {
            if (!agent.networkId) { // Only select unlinked agents
                this.linkModalState.selectedAgentIds.add(agent.id);
            }
        });
        this.updateLinkModal();
    }
    
    clearSelection() {
        this.linkModalState.selectedAgentIds.clear();
        this.updateLinkModal();
    }
    
    updateSelectedAgentsDisplay() {
        const selectedList = document.getElementById('selected-agents-list');
        const strengthDisplay = document.getElementById('network-strength-display');
        
        if (!selectedList) return;
        
        selectedList.innerHTML = '';
        
        if (this.linkModalState.selectedAgentIds.size === 0) {
            selectedList.innerHTML = `
                <div class="empty-state" style="padding: 10px; font-size: 0.8rem; width: 100%;">
                    No agents selected. Click agents above to select.
                </div>
            `;
            strengthDisplay.style.display = 'none';
            return;
        }
        
        // Show selected agents as tags
        Array.from(this.linkModalState.selectedAgentIds).forEach(agentId => {
            const agent = this.agents.find(a => a.id === agentId);
            if (!agent) return;
            
            const tag = document.createElement('div');
            tag.className = 'selected-agent-tag';
            tag.innerHTML = `
                ${agent.name}
                <button class="remove-agent-tag" data-agent="${agent.id}">√ó</button>
            `;
            
            tag.querySelector('.remove-agent-tag').addEventListener('click', (e) => {
                e.stopPropagation();
                this.linkModalState.selectedAgentIds.delete(agent.id);
                this.updateLinkModal();
            });
            
            selectedList.appendChild(tag);
        });
        
        // Show strength display
        strengthDisplay.style.display = 'block';
    }
    
    updateStrengthDisplay() {
        const selectedCount = this.linkModalState.selectedAgentIds.size;
        const strengthValue = document.getElementById('strength-value');
        const strengthInfo = document.getElementById('strength-info');
        
        if (selectedCount === 0) {
            strengthValue.textContent = '0-bit';
            strengthInfo.textContent = 'Select 2-4 agents to create a network';
            strengthInfo.style.color = '#a0a0a0';
        } else if (selectedCount === 1) {
            strengthValue.textContent = '256-bit';
            strengthInfo.textContent = 'Need 1 more agent to create network';
            strengthInfo.style.color = '#ff8000';
        } else if (selectedCount >= 2 && selectedCount <= 4) {
            const strength = 256 * selectedCount;
            strengthValue.textContent = `${strength}-bit`;
            strengthInfo.textContent = `${selectedCount} agents = ${strength}-bit virtual encryption`;
            strengthInfo.style.color = '#00ff00';
        } else {
            strengthValue.textContent = '1024+ bit';
            strengthInfo.textContent = 'Too many agents selected (max 4 per network)';
            strengthInfo.style.color = '#ff0000';
        }
    }
    
    createNetworkFromSelection() {
        const selectedCount = this.linkModalState.selectedAgentIds.size;
        
        if (selectedCount < 2) {
            window.macroslow?.speak('Need at least 2 agents to create a network', 'warning');
            return;
        }
        
        if (selectedCount > 4) {
            window.macroslow?.speak('Maximum 4 agents per network', 'warning');
            return;
        }
        
        try {
            const agentIds = Array.from(this.linkModalState.selectedAgentIds);
            const network = this.linkAgents(agentIds);
            
            // Clear selection after creating network
            this.linkModalState.selectedAgentIds.clear();
            
            // Update UI
            this.updateLinkModal();
            this.updateSystemStats();
            this.updateUI();
            
            window.macroslow?.speak(`Created Network ${network.number} with ${agentIds.length} agents`, 'success');
            
        } catch (error) {
            window.macroslow?.speak(`Failed to create network: ${error.message}`, 'error');
        }
    }
    
    updateNetworksList() {
        const networksList = document.getElementById('networks-list');
        
        if (!networksList) return;
        
        if (this.linkedNetworks.size === 0) {
            networksList.innerHTML = `
                <div class="empty-state">
                    No networks created yet
                </div>
            `;
            return;
        }
        
        networksList.innerHTML = '';
        
        Array.from(this.linkedNetworks.values()).forEach(network => {
            const networkAgents = network.agents.map(agentId => {
                const agent = this.agents.find(a => a.id === agentId);
                return agent ? agent.name : 'Unknown';
            });
            
            const item = document.createElement('div');
            item.className = 'network-item';
            
            item.innerHTML = `
                <div class="network-item-header">
                    <div class="network-name">Network ${network.number}</div>
                    <div class="network-strength">${network.encryptionStrength}-bit</div>
                </div>
                <div class="network-agents">
                    ${networkAgents.map(name => `
                        <div class="network-agent">${name}</div>
                    `).join('')}
                </div>
                <div class="network-actions">
                    <button class="network-action-btn break" data-network="${network.number}">BREAK NETWORK</button>
                </div>
            `;
            
            item.querySelector('.network-action-btn').addEventListener('click', (e) => {
                const networkNumber = parseInt(e.target.getAttribute('data-network'));
                if (confirm(`Break Network ${networkNumber}? All agents will become standalone.`)) {
                    this.unlinkNetwork(networkNumber);
                    this.updateLinkModal();
                    this.updateSystemStats();
                    this.updateUI();
                    window.macroslow?.speak(`Network ${networkNumber} broken`, 'warning');
                }
            });
            
            networksList.appendChild(item);
        });
    }
    
    // ============================================
    // IMPORT/EXPORT FUNCTIONS (simplified)
    // ============================================
    
    async exportNetwork(name = 'macroslow_network') {
        try {
            const exportData = {
                agents: this.agents,
                networks: Array.from(this.linkedNetworks.values()),
                system: {
                    exportDate: new Date().toISOString(),
                    version: '4.1',
                    totalAgents: this.agents.length,
                    totalHashes: this.systemMetrics.totalHashes,
                    agentCounter: this.agentCounter
                }
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            this.logTrace(`Network exported: ${name}.json`, 'info');
            return true;
            
        } catch (error) {
            this.handleError(error, 'Export network');
            return false;
        }
    }
    
    async importNetwork(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Validate import data
                    if (!data.agents || !Array.isArray(data.agents)) {
                        throw new Error('Invalid import file format');
                    }
                    
                    // Clear current state
                    this.agents.forEach(agent => this.stopAgentMining(agent.id));
                    this.agents = [];
                    this.linkedNetworks.clear();
                    
                    // Import agents
                    this.agents = data.agents.map(agent => ({
                        ...agent,
                        miningActive: false,
                        status: 'inactive'
                    }));
                    
                    // Import networks
                    if (data.networks && Array.isArray(data.networks)) {
                        data.networks.forEach(network => {
                            const key = `network_${network.number}`;
                            this.linkedNetworks.set(key, network);
                        });
                    }
                    
                    // Update counters
                    this.agentCounter = data.system?.agentCounter || this.agents.length + 1;
                    
                    // Update UI
                    this.updateSystemStats();
                    this.updateUI();
                    this.saveState();
                    
                    resolve(true);
                    
                } catch (error) {
                    reject(error);
                }
            };
            
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsText(file);
        });
    }
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    getNetworkStrength(networkId) {
        if (!networkId) return 256;
        const network = Array.from(this.linkedNetworks.values()).find(n => n.id === networkId);
        return network ? network.encryptionStrength : 256;
    }
    
    formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }
    
    saveState() {
        try {
            const state = {
                agents: this.agents,
                networks: Array.from(this.linkedNetworks.values()),
                agentCounter: this.agentCounter,
                systemMetrics: this.systemMetrics,
                timestamp: Date.now()
            };
            localStorage.setItem('macroslow_simple_state', JSON.stringify(state));
        } catch (error) {
            this.handleError(error, 'Save state');
        }
    }
    
    loadState() {
        try {
            const saved = localStorage.getItem('macroslow_simple_state');
            if (saved) {
                const state = JSON.parse(saved);
                this.agents = state.agents || [];
                this.agentCounter = state.agentCounter || this.agents.length + 1;
                this.systemMetrics = state.systemMetrics || this.systemMetrics;
                
                if (state.networks) {
                    this.linkedNetworks.clear();
                    state.networks.forEach(network => {
                        const key = `network_${network.number}`;
                        this.linkedNetworks.set(key, network);
                    });
                }
                
                this.logTrace(`Loaded ${this.agents.length} agents from saved state`, 'info');
                return true;
            }
        } catch (error) {
            this.handleError(error, 'Load state');
        }
        return false;
    }
    
    clearAllAgents() {
        if (this.agents.length === 0) return;
        
        if (confirm(`Clear all ${this.agents.length} agents?`)) {
            this.agents.forEach(agent => this.stopAgentMining(agent.id));
            this.agents = [];
            this.linkedNetworks.clear();
            this.agentCounter = 1;
            this.systemMetrics.networkScale = 1;
            
            this.updateSystemStats();
            this.updateUI();
            this.saveState();
            
            this.logTrace('All agents cleared', 'warning');
        }
    }
    
    handleError(error, context) {
        const errorId = 'ERR_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
        const trace = this.getStackTrace(error);
        
        const errorData = {
            id: errorId,
            timestamp: new Date().toISOString(),
            context: context,
            message: error.message,
            stack: trace,
            agentCount: this.agents.length,
            gpuAvailable: this.gpuAvailable
        };
        
        this.errorLog.push(errorData);
        
        const aiSuggestion = this.aiErrorHandler.analyzeError(errorData);
        
        console.error(`[${errorId}] ${context}:`, error.message);
        console.error('Stack trace:', trace);
        console.error('AI Suggestion:', aiSuggestion);
        
        if (window.macroslow) {
            window.macroslow.speak(`Error ${errorId}: ${error.message}`, 'error');
            
            if (aiSuggestion) {
                setTimeout(() => {
                    window.macroslow.speak(`AI Suggestion: ${aiSuggestion}`, 'info');
                }, 1000);
            }
        }
        
        return errorId;
    }
    
    getStackTrace(error) {
        if (error.stack) {
            return error.stack.split('\n').slice(0, 5).join('\n');
        }
        
        try {
            throw new Error('Generated stack trace');
        } catch (e) {
            return e.stack ? e.stack.split('\n').slice(2, 7).join('\n') : 'No stack trace available';
        }
    }
    
    logTrace(message, type = 'info') {
        const trace = this.getStackTrace(new Error());
        const logEntry = {
            timestamp: new Date().toISOString(),
            message: message,
            type: type,
            trace: trace
        };
        
        console.log(`[${type.toUpperCase()}] ${message}`);
        if (trace && type === 'error') {
            console.log('Trace:', trace);
        }
    }
    
    selectAgent(agentId) {
        const agent = this.agents.find(a => a.id === agentId);
        if (agent && window.macroslow) {
            window.macroslow.speak(`Selected: ${agent.name}`, 'agent');
            window.macroslow.speak(`Hash Rate: ${agent.hashRate}/s | Network: ${agent.networkNumber || 'None'}`, 'info');
        }
    }
}

// ============================================
// AI ERROR HANDLER
// ============================================

class AIErrorHandler {
    analyzeError(errorData) {
        const { context, message, agentCount, gpuAvailable } = errorData;
        
        const patterns = [
            {
                pattern: /memory|out of memory|heap/i,
                suggestion: 'Reduce number of agents or clear some agents. Memory limit reached.'
            },
            {
                pattern: /GPU|WebGL|shader/i,
                suggestion: gpuAvailable ? 
                    'GPU acceleration issue. Try disabling GPU.js in console.' :
                    'GPU not available. Using CPU fallback.'
            },
            {
                pattern: /network|connection|websocket/i,
                suggestion: 'Network issue. Check if too many agents are trying to connect.'
            },
            {
                pattern: /hash|mining|rate/i,
                suggestion: agentCount > 5 ? 
                    'Too many agents mining. Stop some agents to improve performance.' :
                    'Hash rate issue. Try restarting the mining process.'
            },
            {
                pattern: /link|network.*full/i,
                suggestion: 'Network linking issue. Try linking fewer agents together.'
            }
        ];
        
        for (const pattern of patterns) {
            if (pattern.pattern.test(message) || pattern.pattern.test(context)) {
                return pattern.suggestion;
            }
        }
        
        if (agentCount > 8) {
            return 'High agent count detected. Consider reducing agents for better performance.';
        }
        
        if (context.includes('GPU') && !gpuAvailable) {
            return 'GPU.js not available. The system is using CPU-based hashing which is slower.';
        }
        
        return 'Check console for detailed error trace. Try reloading the application.';
    }
}

// ============================================
// SIMPLIFIED ORCHESTRATOR
// ============================================

class SimplifiedOrchestrator {
    constructor(system) {
        this.system = system;
        this.name = "$macroslow";
    }
    
    speak(message, type = "agent") {
        const terminalLog = document.getElementById("terminal-log");
        if (!terminalLog) return;
        
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
            margin-bottom: 10px;
            padding-left: 8px;
            border-left: 3px solid ${this.getTypeColor(type)};
        `;
        
        messageDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <span style="font-family: 'Press Start 2P'; font-size: 0.8rem; color: #8b5cf6;">${this.name}</span>
                <span style="color: #606060; font-size: 0.7rem;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
            <div style="color: ${this.getTypeColor(type)}; font-size: 0.9rem;">${message}</div>
        `;
        
        terminalLog.appendChild(messageDiv);
        terminalLog.scrollTop = terminalLog.scrollHeight;
    }
    
    getTypeColor(type) {
        switch(type) {
            case 'error': return '#ff0000';
            case 'warning': return '#ff8000';
            case 'success': return '#00ff00';
            case 'info': return '#a0a0a0';
            case 'agent': return '#8b5cf6';
            default: return '#c0c0c0';
        }
    }
    
    userMessage(message) {
        const terminalLog = document.getElementById("terminal-log");
        if (!terminalLog) return;
        
        const messageDiv = document.createElement("div");
        messageDiv.style.cssText = `
            margin-bottom: 8px;
            padding: 6px 8px;
            background: rgba(64, 64, 64, 0.2);
            border: 1px solid #404040;
            color: #00a0ff;
            font-size: 0.9rem;
        `;
        messageDiv.innerHTML = `<span>></span> ${message}`;
        terminalLog.appendChild(messageDiv);
        terminalLog.scrollTop = terminalLog.scrollHeight;
    }
    
    async processCommand(command) {
        this.userMessage(command);
        
        const parts = command.trim().split(/\s+/);
        const action = parts[0].toLowerCase();
        const args = parts.slice(1);
        
        switch(action) {
            case '/help':
                this.showHelp();
                break;
                
            case '/create':
            case '/c':
                await this.system.createAgent();
                const newAgent = this.system.agents[this.system.agents.length - 1];
                this.speak(`‚úÖ Created ${newAgent.name}`, 'success');
                break;
                
            case '/start':
            case '/s':
                if (args[0]) {
                    const agent = this.system.agents.find(a => 
                        a.name.toLowerCase().includes(args[0].toLowerCase())
                    );
                    if (agent) {
                        this.system.startAgentMining(agent.id);
                        this.speak(`Started ${agent.name}`, 'success');
                    }
                } else {
                    this.system.agents.forEach(agent => {
                        this.system.startAgentMining(agent.id);
                    });
                    this.speak('Started all agents', 'success');
                }
                break;
                
            case '/stop':
            case '/x':
                if (args[0]) {
                    const agent = this.system.agents.find(a => 
                        a.name.toLowerCase().includes(args[0].toLowerCase())
                    );
                    if (agent) {
                        this.system.stopAgentMining(agent.id);
                        this.speak(`Stopped ${agent.name}`, 'warning');
                    }
                } else {
                    this.system.agents.forEach(agent => {
                        this.system.stopAgentMining(agent.id);
                    });
                    this.speak('Stopped all agents', 'warning');
                }
                break;
                
            case '/delete':
            case '/d':
                if (args[0]) {
                    const agent = this.system.agents.find(a => 
                        a.name.toLowerCase().includes(args[0].toLowerCase())
                    );
                    if (agent) {
                        this.system.deleteAgent(agent.id);
                        this.speak(`Deleted ${agent.name}`, 'warning');
                    }
                }
                break;
                
            case '/list':
            case '/l':
                this.listAgents();
                break;
                
            case '/link':
                this.openLinkModal();
                break;
                
            case '/unlink':
                if (args[0] === 'all') {
                    const success = this.system.unlinkAllNetworks();
                    if (success) {
                        this.speak('All networks unlinked', 'warning');
                    }
                } else if (args[0]) {
                    const networkNum = parseInt(args[0]);
                    if (!isNaN(networkNum)) {
                        try {
                            this.system.unlinkNetwork(networkNum);
                            this.speak(`Network ${networkNum} unlinked`, 'warning');
                        } catch (error) {
                            this.speak(`Failed to unlink: ${error.message}`, 'error');
                        }
                    }
                }
                break;
                
            case '/export':
                const name = args[0] || `export_${Date.now()}`;
                try {
                    await this.system.exportNetwork(name);
                    this.speak(`Exported to ${name}.json`, 'success');
                } catch (error) {
                    this.speak(`Export failed: ${error.message}`, 'error');
                }
                break;
                
            case '/import':
                this.openImportModal();
                break;
                
            case '/clear':
                this.system.clearAllAgents();
                this.speak('All agents cleared', 'warning');
                break;
                
            case '/stats':
                this.showStats();
                break;
                
            case '/perf':
                const meter = document.getElementById('performance-meter');
                meter.style.display = meter.style.display === 'none' ? 'block' : 'none';
                break;
                
            case '/trace':
                this.showErrorTrace();
                break;
                
            default:
                this.speak(`
                    <div style="background: rgba(0,0,0,0.7); padding: 12px; border: 1px solid #404040;">
                        <span style="color: #00ff00;">Simplified MACROSLOW v4.1</span><br>
                        <span style="color: #a0a0a0; font-size: 0.8rem;">Easy-to-use linking interface</span><br><br>
                        
                        <span style="color: #ffff00;">Quick Commands:</span><br>
                        ‚Ä¢ <span style="color: #8b5cf6;">/create</span> - Create new agent (auto-named)<br>
                        ‚Ä¢ <span style="color: #8b5cf6;">/start</span> - Start all agents<br>
                        ‚Ä¢ <span style="color: #8b5cf6;">/stop</span> - Stop all agents<br>
                        ‚Ä¢ <span style="color: #8b5cf6;">/link</span> - Simple agent linking hub<br>
                        ‚Ä¢ <span style="color: #8b5cf6;">/export</span> - Export network<br>
                        ‚Ä¢ <span style="color: #8b5cf6;">/import</span> - Import network<br>
                        ‚Ä¢ <span style="color: #8b5cf6;">/help</span> - Full command list<br>
                    </div>
                `, 'info');
        }
    }
    
    showHelp() {
        this.speak(`
            <div style="background: rgba(0,0,0,0.7); padding: 15px; border: 1px solid #404040;">
                <div style="color: #00ff00; font-size: 0.9rem; margin-bottom: 10px;">SIMPLIFIED COMMAND REFERENCE</div>
                
                <div style="color: #ffff00; margin: 8px 0;">AGENT COMMANDS:</div>
                <div style="margin-left: 15px; font-size: 0.8rem; color: #a0a0a0;">
                    /create, /c - Create new agent (auto-named)<br>
                    /start [name], /s - Start agent(s)<br>
                    /stop [name], /x - Stop agent(s)<br>
                    /delete [name], /d - Delete agent<br>
                    /list, /l - List all agents<br>
                    /clear - Clear all agents<br>
                </div>
                
                <div style="color: #ffff00; margin: 8px 0;">NETWORK COMMANDS:</div>
                <div style="margin-left: 15px; font-size: 0.8rem; color: #a0a0a0;">
                    /link - Open simplified linking hub<br>
                    /unlink [number] - Unlink specific network<br>
                    /unlink all - Unlink all networks<br>
                </div>
                
                <div style="color: #ffff00; margin: 8px 0;">IMPORT/EXPORT COMMANDS:</div>
                <div style="margin-left: 15px; font-size: 0.8rem; color: #a0a0a0;">
                    /export [name] - Export network to .json<br>
                    /import - Import network from file<br>
                </div>
                
                <div style="color: #ffff00; margin: 8px 0;">SYSTEM COMMANDS:</div>
                <div style="margin-left: 15px; font-size: 0.8rem; color: #a0a0a0;">
                    /stats - System statistics<br>
                    /perf - Toggle performance monitor<br>
                    /trace - Show error trace<br>
                    /help - This help<br>
                </div>
                
                <div style="margin-top: 10px; color: #00ff00; font-size: 0.8rem;">
                    ‚ö° Simple Linking: Select 2-4 agents, click "Create Network"
                </div>
            </div>
        `, 'help');
    }
    
    listAgents() {
        if (this.system.agents.length === 0) {
            this.speak('No agents deployed.', 'info');
            return;
        }
        
        let list = '<span style="color: #00ff00;">ACTIVE AGENTS:</span><br>';
        
        this.system.agents.forEach((agent, index) => {
            const networkInfo = agent.networkNumber ? 
                `Net ${agent.networkNumber} (${this.system.getNetworkStrength(agent.networkId)}-bit)` : 
                'Standalone';
            
            list += `
                <div style="margin-left: 15px; margin-bottom: 6px;">
                    <span style="color: #ffffff;">${index + 1}. ${agent.name}</span><br>
                    <span style="font-size: 0.8rem; color: #a0a0a0;">
                        ${agent.type} | ${agent.hashRate}/s | ${networkInfo} | ${agent.status}
                    </span>
                </div>
            `;
        });
        
        this.speak(list, 'info');
    }
    
    showStats() {
        const stats = this.system.systemMetrics;
        
        this.speak(`
            <div style="background: rgba(0,0,0,0.7); padding: 15px; border: 1px solid #404040;">
                <div style="color: #00ff00; font-size: 0.9rem; margin-bottom: 10px;">SYSTEM STATISTICS</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.8rem;">
                    <div style="color: #a0a0a0;">Total Agents:</div>
                    <div style="color: #ffffff;">${this.system.agents.length}</div>
                    
                    <div style="color: #a0a0a0;">Active Mining:</div>
                    <div style="color: #ffffff;">${stats.activeAgents}</div>
                    
                    <div style="color: #a0a0a0;">Total Hashes:</div>
                    <div style="color: #ffffff;">${this.system.formatNumber(stats.totalHashes)}</div>
                    
                    <div style="color: #a0a0a0;">Hash Rate:</div>
                    <div style="color: #ffffff;">${stats.hashRate}/s</div>
                    
                    <div style="color: #a0a0a0;">Networks:</div>
                    <div style="color: #ffffff;">${this.system.linkedNetworks.size}</div>
                    
                    <div style="color: #a0a0a0;">Network Scale:</div>
                    <div style="color: #ffffff;">${stats.networkScale}x</div>
                    
                    <div style="color: #a0a0a0;">CPU Usage:</div>
                    <div style="color: ${this.system.getUsageColor(stats.cpuUsage)}">${stats.cpuUsage}%</div>
                    
                    <div style="color: #a0a0a0;">Memory Usage:</div>
                    <div style="color: ${this.system.getUsageColor(stats.memoryUsage)}">${stats.memoryUsage}%</div>
                    
                    <div style="color: #a0a0a0;">GPU Available:</div>
                    <div style="color: ${this.system.gpuAvailable ? '#00ff00' : '#ff0000'}">${this.system.gpuAvailable ? 'Yes' : 'No'}</div>
                </div>
                
                <div style="margin-top: 10px; color: #ffff00; font-size: 0.8rem;">
                    Performance: ${stats.performanceWarning ? '‚ö†Ô∏è WARNING' : '‚úÖ OK'}
                </div>
            </div>
        `, 'info');
    }
    
    showErrorTrace() {
        if (this.system.errorLog.length === 0) {
            this.speak('No errors logged.', 'info');
            return;
        }
        
        const lastError = this.system.errorLog[this.system.errorLog.length - 1];
        
        this.speak(`
            <div style="background: rgba(0,0,0,0.7); padding: 15px; border: 1px solid #404040;">
                <div style="color: #ff0000; font-size: 0.9rem; margin-bottom: 8px;">LAST ERROR TRACE</div>
                <div style="color: #a0a0a0; font-size: 0.8rem; margin-bottom: 6px;">ID: ${lastError.id}</div>
                <div style="color: #ffffff; font-size: 0.8rem; margin-bottom: 6px;">Context: ${lastError.context}</div>
                <div style="color: #ff6666; font-size: 0.8rem; margin-bottom: 6px;">${lastError.message}</div>
                <div class="error-trace">${lastError.stack}</div>
            </div>
        `, 'error');
    }
    
    openLinkModal() {
        if (this.system.agents.length < 2) {
            this.speak('Need at least 2 agents to link.', 'warning');
            return;
        }
        
        document.getElementById('link-modal').style.display = 'flex';
        this.system.updateLinkModal();
    }
    
    openImportModal() {
        document.getElementById('import-export-modal').style.display = 'flex';
    }
}

// ============================================
// INITIALIZATION
// ============================================

async function initializeSimplifiedApp() {
    console.log('üöÄ Starting Simplified MACROSLOW System...');
    
    const loadingStatus = document.getElementById('loading-status');
    
    loadingStatus.textContent = 'Initializing GPU.js...';
    
    const system = new SimplifiedAgentSystem();
    window.system = system;
    
    loadingStatus.textContent = 'Loading saved state...';
    system.loadState();
    
    loadingStatus.textContent = 'Initializing orchestrator...';
    window.macroslow = new SimplifiedOrchestrator(system);
    
    loadingStatus.textContent = 'Starting UI...';
    
    setTimeout(() => {
        document.getElementById('qwik-loading').style.display = 'none';
        document.getElementById('app-header').style.display = 'flex';
        document.getElementById('main-container').style.display = 'flex';
        
        if (window.innerWidth > 768) {
            document.getElementById('performance-meter').style.display = 'block';
        }
        
        const terminalInput = document.getElementById('terminal-input');
        if (terminalInput) terminalInput.focus();
        
        window.macroslow.speak(`
            <span style="color: #00ff00;">‚úÖ SIMPLIFIED MACROSLOW v4.1 READY</span><br><br>
            
            <span style="color: #8b5cf6;">Easy-to-Use Linking System</span><br>
            <span style="color: #a0a0a0; font-size: 0.8rem;">Simple checkboxes | Clear network management | One-click linking</span><br><br>
            
            <span style="color: #ffff00;">System Status:</span><br>
            ‚Ä¢ GPU.js: <span style="color: ${system.gpuAvailable ? '#00ff00' : '#ff0000'}">${system.gpuAvailable ? 'Available' : 'Not available'}</span><br>
            ‚Ä¢ Agents loaded: ${system.agents.length}<br>
            ‚Ä¢ Networks: ${system.linkedNetworks.size}<br><br>
            
            Type <span style="color: #8b5cf6;">/help</span> for commands
        `, 'system');
        
        system.updateUI();
        system.updateSystemStats();
        
    }, 500);
    
    setupSimplifiedEventListeners(system);
}

function setupSimplifiedEventListeners(system) {
    // Create agent button
    document.getElementById('create-agent-btn').addEventListener('click', async () => {
        const agent = await system.createAgent();
        window.macroslow.speak(`‚úÖ Created ${agent.name}`, 'success');
        system.updateUI();
    });
    
    // Terminal input
    document.getElementById('terminal-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const input = document.getElementById('terminal-input');
            const command = input.value.trim();
            if (command) {
                window.macroslow.processCommand(command);
                input.value = '';
            }
        }
    });
    
    // Quick action buttons
    document.getElementById('start-all-btn').addEventListener('click', () => {
        system.agents.forEach(agent => system.startAgentMining(agent.id));
        window.macroslow.speak('Started all agents', 'success');
    });
    
    document.getElementById('stop-all-btn').addEventListener('click', () => {
        system.agents.forEach(agent => system.stopAgentMining(agent.id));
        window.macroslow.speak('Stopped all agents', 'warning');
    });
    
    document.getElementById('link-agents-btn').addEventListener('click', () => {
        window.macroslow.openLinkModal();
    });
    
    document.getElementById('import-export-btn').addEventListener('click', () => {
        window.macroslow.openImportModal();
    });
    
    document.getElementById('stats-btn').addEventListener('click', () => {
        window.macroslow.showStats();
    });
    
    document.getElementById('clear-btn').addEventListener('click', () => {
        system.clearAllAgents();
        window.macroslow.speak('All agents cleared', 'warning');
    });
    
    // Simplified Link Modal
    const linkModal = document.getElementById('link-modal');
    
    document.getElementById('close-link-modal').addEventListener('click', () => {
        linkModal.style.display = 'none';
    });
    
    document.getElementById('cancel-link-btn').addEventListener('click', () => {
        linkModal.style.display = 'none';
    });
    
    document.getElementById('apply-links-btn').addEventListener('click', () => {
        linkModal.style.display = 'none';
        window.macroslow?.speak('Links applied', 'success');
    });
    
    // Link modal actions
    document.getElementById('select-all-btn').addEventListener('click', () => {
        system.selectAllAgents();
    });
    
    document.getElementById('clear-selection-btn').addEventListener('click', () => {
        system.clearSelection();
    });
    
    document.getElementById('create-network-btn').addEventListener('click', () => {
        system.createNetworkFromSelection();
    });
    
    document.getElementById('unlink-all-btn').addEventListener('click', () => {
        if (confirm('Unlink all networks? All agents will become standalone.')) {
            system.unlinkAllNetworks();
            system.updateLinkModal();
            system.updateSystemStats();
            system.updateUI();
            window.macroslow?.speak('All networks unlinked', 'warning');
        }
    });
    
    document.getElementById('auto-link-btn').addEventListener('click', () => {
        try {
            const networks = system.autoLinkAgents();
            system.updateLinkModal();
            system.updateSystemStats();
            system.updateUI();
            window.macroslow?.speak(`Auto-linked ${networks.length} networks`, 'success');
        } catch (error) {
            window.macroslow?.speak(`Auto-link failed: ${error.message}`, 'error');
        }
    });
    
    // Import/Export Modal
    const importExportModal = document.getElementById('import-export-modal');
    
    document.getElementById('close-import-export-modal').addEventListener('click', () => {
        importExportModal.style.display = 'none';
    });
    
    document.getElementById('cancel-export-btn').addEventListener('click', () => {
        importExportModal.style.display = 'none';
    });
    
    document.getElementById('import-file-btn').addEventListener('click', () => {
        document.getElementById('file-input').click();
    });
    
    // Export functionality
    document.getElementById('confirm-export-btn').addEventListener('click', async () => {
        const exportName = document.getElementById('export-name').value || `macroslow_${Date.now()}`;
        
        importExportModal.style.display = 'none';
        
        try {
            const success = await system.exportNetwork(exportName);
            if (success) {
                window.macroslow.speak(`Exported to ${exportName}.json`, 'success');
            }
        } catch (error) {
            window.macroslow.speak(`Export failed: ${error.message}`, 'error');
        }
    });
    
    // Import functionality
    document.getElementById('file-input').addEventListener('change', async (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            
            try {
                await system.importNetwork(file);
                importExportModal.style.display = 'none';
                window.macroslow.speak(`Imported network from ${file.name}`, 'success');
            } catch (error) {
                window.macroslow.speak(`Import failed: ${error.message}`, 'error');
            }
        }
    });
    
    // Auto-focus on modals
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // Escape key to close modals
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });
    
    // Resize handling
    window.addEventListener('resize', () => {
        const perfMeter = document.getElementById('performance-meter');
        if (window.innerWidth > 768) {
            perfMeter.style.display = 'block';
        } else {
            perfMeter.style.display = 'none';
        }
    });
}

// Start the application
document.addEventListener('DOMContentLoaded', initializeSimplifiedApp);
</script>
</body>
</html>