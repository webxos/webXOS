<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D STUDIO - webXOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <style>
        :root {
            --primary: #00c8ff;
            --secondary: #0080ff;
            --accent: #00ffcc;
            --bg-dark: rgba(10, 15, 25, 0.95);
            --bg-panel: rgba(20, 30, 40, 0.85);
            --text-primary: #00ffcc;
            --text-secondary: #0099ff;
            --border-glow: 0 0 10px var(--primary);
            --danger: #ff3366;
            --warning: #ffaa00;
            --success: #00ff99;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: #000;
            overflow: hidden;
            color: var(--text-primary);
            height: 100vh;
        }

        #three-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* Header Bar */
        #header-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 20, 40, 0.8);
            border-bottom: 1px solid var(--primary);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: all;
        }

        .logo {
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 0 5px var(--primary);
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        /* UI Windows */
        .ui-window {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--primary);
            box-shadow: var(--border-glow), inset 0 0 20px rgba(0, 200, 255, 0.1);
            border-radius: 4px;
            pointer-events: all;
            min-width: 300px;
            min-height: 200px;
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        .title-bar {
            background: linear-gradient(90deg, rgba(0, 100, 255, 0.3), rgba(0, 200, 255, 0.1));
            padding: 8px 12px;
            border-bottom: 1px solid var(--primary);
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            text-shadow: 0 0 5px var(--primary);
            user-select: none;
        }

        .window-controls button {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--text-primary);
            width: 20px;
            height: 20px;
            margin-left: 5px;
            cursor: pointer;
            border-radius: 2px;
            font-size: 14px;
            line-height: 1;
        }

        .window-controls button:hover {
            background: rgba(0, 200, 255, 0.2);
        }

        .window-content {
            padding: 15px;
            height: calc(100% - 40px);
            overflow-y: auto;
        }

        /* Toolbar */
        .toolbar {
            position: absolute;
            top: 50px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(0, 20, 40, 0.8);
            border-radius: 5px;
            padding: 5px;
            border: 1px solid var(--primary);
            pointer-events: all;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn.active {
            background: var(--primary);
            color: #000;
        }

        /* Mode Switcher */
        #mode-switcher {
            position: absolute;
            top: 50px;
            right: 20px;
            z-index: 1000;
            display: flex;
            background: rgba(0, 20, 40, 0.8);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid var(--primary);
            pointer-events: all;
        }

        .mode-btn {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 0.9em;
        }

        .mode-btn.active {
            background: var(--primary);
            color: #000;
        }

        /* Properties Panel */
        .properties-panel {
            background: rgba(0, 30, 60, 0.8);
            border: 1px solid var(--primary);
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .properties-panel h3 {
            background: rgba(0, 100, 200, 0.3);
            padding: 8px 12px;
            margin: 0;
            font-size: 0.9em;
            border-bottom: 1px solid var(--primary);
        }

        .properties-content {
            padding: 10px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .control-input {
            width: 100%;
            background: rgba(0, 40, 80, 0.5);
            border: 1px solid var(--primary);
            color: var(--text-primary);
            padding: 5px 8px;
            border-radius: 3px;
            font-family: 'Share Tech Mono', monospace;
        }

        .control-input:focus {
            outline: none;
            box-shadow: 0 0 5px var(--primary);
        }

        /* Buttons */
        .btn {
            background: rgba(0, 100, 200, 0.3);
            border: 1px solid var(--primary);
            color: var(--text-primary);
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Share Tech Mono', monospace;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .btn:hover {
            background: rgba(0, 150, 255, 0.5);
            box-shadow: 0 0 10px var(--primary);
        }

        .btn-primary {
            background: rgba(0, 150, 255, 0.5);
        }

        .btn-danger {
            background: rgba(255, 50, 100, 0.3);
            border-color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(255, 50, 100, 0.5);
            box-shadow: 0 0 10px var(--danger);
        }

        /* Template Categories */
        .template-category {
            margin-bottom: 15px;
        }

        .category-title {
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(0, 200, 255, 0.3);
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .template-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }

        .template-item {
            padding: 8px;
            background: rgba(0, 40, 80, 0.3);
            border: 1px solid var(--primary);
            cursor: pointer;
            text-align: center;
            border-radius: 3px;
            transition: all 0.2s;
            font-size: 0.8em;
        }

        .template-item:hover {
            background: rgba(0, 100, 200, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 0 8px var(--primary);
        }

        /* Status Bar */
        #status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 20, 40, 0.8);
            border-top: 1px solid var(--primary);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            pointer-events: all;
        }

        .status-item {
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ok {
            background: var(--success);
            box-shadow: 0 0 5px var(--success);
        }

        .status-warning {
            background: var(--warning);
            box-shadow: 0 0 5px var(--warning);
        }

        /* JSON Editor */
        .json-editor {
            width: 100%;
            height: 300px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid var(--primary);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            resize: vertical;
            border-radius: 3px;
        }

        /* Object List */
        .object-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .object-item {
            padding: 8px;
            margin-bottom: 6px;
            background: rgba(0, 40, 80, 0.3);
            border: 1px solid rgba(0, 200, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .object-item:hover {
            background: rgba(0, 60, 120, 0.3);
        }

        .object-item.selected {
            background: rgba(0, 100, 200, 0.5);
            border-color: var(--primary);
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .ui-window {
                min-width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Header Bar -->
    <div id="header-bar">
        <div class="logo">3D STUDIO - webXOS</div>
        <div class="header-controls">
            <button class="btn" id="new-project">NEW</button>
            <button class="btn" id="save-project">SAVE</button>
            <button class="btn" id="load-project">LOAD</button>
            <button class="btn" id="export-json">EXPORT JSON</button>
            <button class="btn" id="import-json">IMPORT JSON</button>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-btn active" id="select-tool" title="Select">üîç</button>
        <button class="tool-btn" id="move-tool" title="Move">‚ÜîÔ∏è</button>
        <button class="tool-btn" id="rotate-tool" title="Rotate">üîÑ</button>
        <button class="tool-btn" id="scale-tool" title="Scale">üìè</button>
        <div style="height: 10px;"></div>
        <button class="tool-btn" id="add-cube" title="Add Cube">‚¨õ</button>
        <button class="tool-btn" id="add-sphere" title="Add Sphere">üî¥</button>
        <button class="tool-btn" id="add-cylinder" title="Add Cylinder">üü¶</button>
        <button class="tool-btn" id="add-plane" title="Add Plane">‚¨ú</button>
        <button class="tool-btn" id="add-light" title="Add Light">üí°</button>
    </div>

    <!-- Mode Switcher -->
    <div id="mode-switcher">
        <div class="mode-btn active" id="model-mode-btn">MODEL</div>
        <div class="mode-btn" id="level-mode-btn">LEVEL</div>
        <div class="mode-btn" id="json-mode-btn">JSON</div>
    </div>

    <!-- Three.js Canvas Container -->
    <div id="three-container"></div>
    
    <!-- UI Overlay Container -->
    <div id="ui-container">
        <!-- Model Mode Windows -->
        <div class="ui-window model-mode" id="model-templates" style="top: 100px; left: 5%; width: 350px; height: 500px;">
            <div class="title-bar">
                <span>üì¶ TEMPLATES LIBRARY</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="template-category">
                    <div class="category-title">BASIC SHAPES</div>
                    <div class="template-list">
                        <div class="template-item" data-template="cube">Cube</div>
                        <div class="template-item" data-template="sphere">Sphere</div>
                        <div class="template-item" data-template="cylinder">Cylinder</div>
                        <div class="template-item" data-template="cone">Cone</div>
                        <div class="template-item" data-template="torus">Torus</div>
                        <div class="template-item" data-template="plane">Plane</div>
                    </div>
                </div>
                
                <div class="template-category">
                    <div class="category-title">RPG FANTASY</div>
                    <div class="template-list">
                        <div class="template-item" data-template="sword">Sword</div>
                        <div class="template-item" data-template="shield">Shield</div>
                        <div class="template-item" data-template="chest">Treasure Chest</div>
                        <div class="template-item" data-template="potion">Health Potion</div>
                        <div class="template-item" data-template="dragon">Dragon</div>
                        <div class="template-item" data-template="castle">Castle</div>
                    </div>
                </div>
                
                <div class="template-category">
                    <div class="category-title">FPS GAME</div>
                    <div class="template-list">
                        <div class="template-item" data-template="assault_rifle">Assault Rifle</div>
                        <div class="template-item" data-template="pistol">Pistol</div>
                        <div class="template-item" data-template="shotgun">Shotgun</div>
                        <div class="template-item" data-template="sniper">Sniper Rifle</div>
                        <div class="template-item" data-template="ammo">Ammo Crate</div>
                        <div class="template-item" data-template="barrel">Explosive Barrel</div>
                    </div>
                </div>
                
                <div class="template-category">
                    <div class="category-title">VEHICLES</div>
                    <div class="template-list">
                        <div class="template-item" data-template="car">Car</div>
                        <div class="template-item" data-template="tank">Tank</div>
                        <div class="template-item" data-template="spaceship">Spaceship</div>
                        <div class="template-item" data-template="helicopter">Helicopter</div>
                    </div>
                </div>
                
                <div class="template-category">
                    <div class="category-title">ENVIRONMENT</div>
                    <div class="template-list">
                        <div class="template-item" data-template="tree">Tree</div>
                        <div class="template-item" data-template="rock">Rock</div>
                        <div class="template-item" data-template="house">House</div>
                        <div class="template-item" data-template="bridge">Bridge</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ui-window model-mode" id="scene-hierarchy" style="top: 100px; left: 25%; width: 300px; height: 400px;">
            <div class="title-bar">
                <span>üìÅ SCENE HIERARCHY</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <ul class="object-list" id="hierarchy-list">
                    <!-- Objects will be listed here -->
                </ul>
            </div>
        </div>

        <div class="ui-window model-mode" id="model-properties" style="top: 100px; right: 5%; width: 350px; height: 400px;">
            <div class="title-bar">
                <span>‚öôÔ∏è OBJECT PROPERTIES</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="properties-panel">
                    <h3>TRANSFORM</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">POSITION</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" class="control-input" id="pos-x" placeholder="X" value="0" step="0.1">
                                <input type="number" class="control-input" id="pos-y" placeholder="Y" value="0" step="0.1">
                                <input type="number" class="control-input" id="pos-z" placeholder="Z" value="0" step="0.1">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">ROTATION</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" class="control-input" id="rot-x" placeholder="X" value="0" step="1">
                                <input type="number" class="control-input" id="rot-y" placeholder="Y" value="0" step="1">
                                <input type="number" class="control-input" id="rot-z" placeholder="Z" value="0" step="1">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">SCALE</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" class="control-input" id="scale-x" placeholder="X" value="1" step="0.1">
                                <input type="number" class="control-input" id="scale-y" placeholder="Y" value="1" step="0.1">
                                <input type="number" class="control-input" id="scale-z" placeholder="Z" value="1" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="properties-panel">
                    <h3>MATERIAL</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">COLOR</label>
                            <input type="color" class="control-input" id="object-color" value="#00ff00">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">METALLIC</label>
                            <input type="range" id="metallic-slider" min="0" max="1" step="0.1" value="0">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">ROUGHNESS</label>
                            <input type="range" id="roughness-slider" min="0" max="1" step="0.1" value="0.5">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">WIREFRAME</label>
                            <input type="checkbox" id="wireframe-toggle">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" style="flex: 1;" id="apply-properties">APPLY</button>
                    <button class="btn btn-danger" style="flex: 1;" id="delete-object">DELETE</button>
                </div>
            </div>
        </div>

        <!-- Level Mode Windows -->
        <div class="ui-window level-mode" style="display: none; top: 100px; left: 5%; width: 350px; height: 500px;">
            <div class="title-bar">
                <span>üó∫Ô∏è LEVEL EDITOR</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="properties-panel">
                    <h3>LEVEL SETTINGS</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">LEVEL NAME</label>
                            <input type="text" class="control-input" id="level-name" value="Level_1">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">LEVEL SIZE</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" class="control-input" id="level-width" placeholder="Width" value="100" step="1">
                                <input type="number" class="control-input" id="level-height" placeholder="Height" value="100" step="1">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">BACKGROUND</label>
                            <select class="control-input" id="level-background">
                                <option>Space</option>
                                <option>Forest</option>
                                <option>Desert</option>
                                <option>City</option>
                                <option>Underwater</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="properties-panel">
                    <h3>LEVEL OBJECTS</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">SPAWN POINT</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" class="control-input" id="spawn-x" placeholder="X" value="0" step="1">
                                <input type="number" class="control-input" id="spawn-y" placeholder="Y" value="0" step="1">
                                <input type="number" class="control-input" id="spawn-z" placeholder="Z" value="0" step="1">
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">ENEMY COUNT</label>
                            <input type="number" class="control-input" id="enemy-count" value="10" min="0" max="100">
                        </div>
                        
                        <div class="control-group">
                            <label class="control-label">ITEMS COUNT</label>
                            <input type="number" class="control-input" id="item-count" value="5" min="0" max="50">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" style="flex: 1;" id="generate-level">GENERATE</button>
                    <button class="btn" style="flex: 1;" id="clear-level">CLEAR</button>
                </div>
            </div>
        </div>

        <!-- JSON Mode Window -->
        <div class="ui-window json-mode" style="display: none; top: 100px; left: 50%; transform: translateX(-50%); width: 600px; height: 500px;">
            <div class="title-bar">
                <span>üìÑ JSON EDITOR</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="control-group">
                    <label class="control-label">SCENE DATA (JSON)</label>
                    <textarea class="json-editor" id="json-editor"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" style="flex: 1;" id="update-from-json">UPDATE SCENE</button>
                    <button class="btn" style="flex: 1;" id="copy-json">COPY TO CLIPBOARD</button>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <div class="status-item">
                <div class="status-indicator status-ok"></div>
                <span id="mode-status">MODEL MODE: ACTIVE</span>
            </div>
            <div class="status-item">
                <span>OBJECTS: <span id="object-count">1</span></span>
            </div>
            <div class="status-item">
                <span>TOOL: <span id="tool-status">SELECT</span></span>
            </div>
            <div class="status-item">
                <span>FPS: <span id="fps-counter">60</span></span>
            </div>
        </div>
    </div>

    <script>
        // 3D Studio Application
        class Studio3D {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.transformControls = null;
                
                this.objects = [];
                this.selectedObject = null;
                this.currentMode = 'model'; // 'model', 'level', 'json'
                this.currentTool = 'select'; // 'select', 'move', 'rotate', 'scale'
                
                this.init();
            }

            init() {
                this.setupThreeJS();
                this.setupUI();
                this.setupEventListeners();
                this.addDefaultObject();
                this.animate();
            }

            setupThreeJS() {
                // Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000010);
                
                // Camera
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(5, 5, 5);
                this.camera.lookAt(0, 0, 0);
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.getElementById('three-container').appendChild(this.renderer.domElement);
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                this.scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);

                // Controls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                
                // Transform controls
                this.transformControls = new THREE.TransformControls(this.camera, this.renderer.domElement);
                this.transformControls.addEventListener('dragging-changed', (event) => {
                    this.controls.enabled = !event.value;
                });
                this.transformControls.addEventListener('change', () => {
                    if (this.selectedObject) {
                        this.updatePropertiesPanel();
                    }
                });
                this.scene.add(this.transformControls);
                
                // Grid
                const gridHelper = new THREE.GridHelper(20, 20, 0x333333, 0x222222);
                this.scene.add(gridHelper);
                
                // Axes helper
                const axesHelper = new THREE.AxesHelper(5);
                this.scene.add(axesHelper);
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            setupUI() {
                // Make windows draggable
                this.makeWindowsDraggable();
                
                // Set initial mode
                this.switchMode('model');
            }

            setupEventListeners() {
                // Mode switcher
                document.getElementById('model-mode-btn').addEventListener('click', () => {
                    this.switchMode('model');
                });
                
                document.getElementById('level-mode-btn').addEventListener('click', () => {
                    this.switchMode('level');
                });
                
                document.getElementById('json-mode-btn').addEventListener('click', () => {
                    this.switchMode('json');
                    this.updateJSONEditor();
                });
                
                // Tool buttons
                document.getElementById('select-tool').addEventListener('click', () => {
                    this.switchTool('select');
                });
                
                document.getElementById('move-tool').addEventListener('click', () => {
                    this.switchTool('move');
                });
                
                document.getElementById('rotate-tool').addEventListener('click', () => {
                    this.switchTool('rotate');
                });
                
                document.getElementById('scale-tool').addEventListener('click', () => {
                    this.switchTool('scale');
                });
                
                // Add shape buttons
                document.getElementById('add-cube').addEventListener('click', () => {
                    this.addCube();
                });
                
                document.getElementById('add-sphere').addEventListener('click', () => {
                    this.addSphere();
                });
                
                document.getElementById('add-cylinder').addEventListener('click', () => {
                    this.addCylinder();
                });
                
                document.getElementById('add-plane').addEventListener('click', () => {
                    this.addPlane();
                });
                
                document.getElementById('add-light').addEventListener('click', () => {
                    this.addLight();
                });
                
                // Template items
                document.querySelectorAll('.template-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const template = item.dataset.template;
                        this.addTemplate(template);
                    });
                });
                
                // Properties panel
                document.getElementById('apply-properties').addEventListener('click', () => {
                    this.applyProperties();
                });
                
                document.getElementById('delete-object').addEventListener('click', () => {
                    this.deleteSelectedObject();
                });
                
                // JSON editor
                document.getElementById('update-from-json').addEventListener('click', () => {
                    this.updateSceneFromJSON();
                });
                
                document.getElementById('copy-json').addEventListener('click', () => {
                    this.copyJSONToClipboard();
                });
                
                // File operations
                document.getElementById('new-project').addEventListener('click', () => {
                    this.newProject();
                });
                
                document.getElementById('save-project').addEventListener('click', () => {
                    this.saveProject();
                });
                
                document.getElementById('load-project').addEventListener('click', () => {
                    this.loadProject();
                });
                
                document.getElementById('export-json').addEventListener('click', () => {
                    this.exportJSON();
                });
                
                document.getElementById('import-json').addEventListener('click', () => {
                    this.importJSON();
                });
                
                // Level editor
                document.getElementById('generate-level').addEventListener('click', () => {
                    this.generateLevel();
                });
                
                document.getElementById('clear-level').addEventListener('click', () => {
                    this.clearLevel();
                });
                
                // Object selection
                this.renderer.domElement.addEventListener('click', (event) => {
                    this.handleObjectSelection(event);
                });
            }

            addDefaultObject() {
                this.addCube();
            }

            addCube() {
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x4a8cff,
                    metalness: 0.2,
                    roughness: 0.5,
                    wireframe: false
                });
                const cube = new THREE.Mesh(geometry, material);
                cube.name = "Cube_" + (this.objects.length + 1);
                cube.userData = { type: 'cube' };
                cube.castShadow = true;
                cube.receiveShadow = true;
                this.scene.add(cube);
                this.objects.push(cube);
                this.selectObject(cube);
                this.updateObjectCount();
                this.updateHierarchy();
            }

            addSphere() {
                const geometry = new THREE.SphereGeometry(0.5, 32, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xff6b6b,
                    metalness: 0.3,
                    roughness: 0.4,
                    wireframe: false
                });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.name = "Sphere_" + (this.objects.length + 1);
                sphere.userData = { type: 'sphere' };
                sphere.castShadow = true;
                sphere.receiveShadow = true;
                this.scene.add(sphere);
                this.objects.push(sphere);
                this.selectObject(sphere);
                this.updateObjectCount();
                this.updateHierarchy();
            }

            addCylinder() {
                const geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x6bff6b,
                    metalness: 0.2,
                    roughness: 0.6,
                    wireframe: false
                });
                const cylinder = new THREE.Mesh(geometry, material);
                cylinder.name = "Cylinder_" + (this.objects.length + 1);
                cylinder.userData = { type: 'cylinder' };
                cylinder.castShadow = true;
                cylinder.receiveShadow = true;
                this.scene.add(cylinder);
                this.objects.push(cylinder);
                this.selectObject(cylinder);
                this.updateObjectCount();
                this.updateHierarchy();
            }

            addPlane() {
                const geometry = new THREE.PlaneGeometry(2, 2);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x8a8a8a,
                    metalness: 0.1,
                    roughness: 0.8,
                    wireframe: false,
                    side: THREE.DoubleSide
                });
                const plane = new THREE.Mesh(geometry, material);
                plane.name = "Plane_" + (this.objects.length + 1);
                plane.userData = { type: 'plane' };
                plane.receiveShadow = true;
                this.scene.add(plane);
                this.objects.push(plane);
                this.selectObject(plane);
                this.updateObjectCount();
                this.updateHierarchy();
            }

            addLight() {
                const light = new THREE.PointLight(0xffffff, 1, 100);
                light.position.set(0, 5, 0);
                light.name = "PointLight_" + (this.objects.length + 1);
                light.userData = { type: 'light' };
                this.scene.add(light);
                this.objects.push(light);
                this.selectObject(light);
                this.updateObjectCount();
                this.updateHierarchy();
            }

            addTemplate(templateType) {
                let mesh;
                
                switch(templateType) {
                    case 'cube':
                        mesh = this.createCube();
                        break;
                    case 'sphere':
                        mesh = this.createSphere();
                        break;
                    case 'cylinder':
                        mesh = this.createCylinder();
                        break;
                    case 'cone':
                        mesh = this.createCone();
                        break;
                    case 'torus':
                        mesh = this.createTorus();
                        break;
                    case 'plane':
                        mesh = this.createPlane();
                        break;
                    case 'sword':
                        mesh = this.createSword();
                        break;
                    case 'shield':
                        mesh = this.createShield();
                        break;
                    case 'chest':
                        mesh = this.createTreasureChest();
                        break;
                    case 'potion':
                        mesh = this.createHealthPotion();
                        break;
                    case 'dragon':
                        mesh = this.createDragon();
                        break;
                    case 'castle':
                        mesh = this.createCastle();
                        break;
                    case 'assault_rifle':
                        mesh = this.createAssaultRifle();
                        break;
                    case 'pistol':
                        mesh = this.createPistol();
                        break;
                    case 'shotgun':
                        mesh = this.createShotgun();
                        break;
                    case 'sniper':
                        mesh = this.createSniperRifle();
                        break;
                    case 'ammo':
                        mesh = this.createAmmoCrate();
                        break;
                    case 'barrel':
                        mesh = this.createExplosiveBarrel();
                        break;
                    case 'car':
                        mesh = this.createCar();
                        break;
                    case 'tank':
                        mesh = this.createTank();
                        break;
                    case 'spaceship':
                        mesh = this.createSpaceship();
                        break;
                    case 'helicopter':
                        mesh = this.createHelicopter();
                        break;
                    case 'tree':
                        mesh = this.createTree();
                        break;
                    case 'rock':
                        mesh = this.createRock();
                        break;
                    case 'house':
                        mesh = this.createHouse();
                        break;
                    case 'bridge':
                        mesh = this.createBridge();
                        break;
                    default:
                        mesh = this.createCube();
                }
                
                mesh.userData = { type: templateType };
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                this.scene.add(mesh);
                this.objects.push(mesh);
                this.selectObject(mesh);
                this.updateObjectCount();
                this.updateHierarchy();
            }

            // RPG FANTASY MODELS
            createSword() {
                const group = new THREE.Group();
                
                // Blade
                const bladeGeometry = new THREE.BoxGeometry(0.1, 1.5, 0.05);
                const bladeMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xcccccc,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const blade = new THREE.Mesh(bladeGeometry, bladeMaterial);
                blade.position.y = 0.75;
                
                // Hilt
                const hiltGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.3, 8);
                const hiltMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.8
                });
                const hilt = new THREE.Mesh(hiltGeometry, hiltMaterial);
                hilt.position.y = 0.15;
                
                // Guard
                const guardGeometry = new THREE.BoxGeometry(0.3, 0.05, 0.1);
                const guardMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xc0c0c0,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const guard = new THREE.Mesh(guardGeometry, guardMaterial);
                guard.position.y = 0.3;
                
                // Pommel
                const pommelGeometry = new THREE.SphereGeometry(0.06, 8, 8);
                const pommelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffd700,
                    metalness: 0.9,
                    roughness: 0.1
                });
                const pommel = new THREE.Mesh(pommelGeometry, pommelMaterial);
                pommel.position.y = -0.02;
                
                group.add(blade);
                group.add(hilt);
                group.add(guard);
                group.add(pommel);
                group.name = "Sword";
                
                return group;
            }

            createShield() {
                const group = new THREE.Group();
                
                // Shield body
                const shieldGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.1, 16, 1, false, 0, Math.PI);
                const shieldMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.2,
                    roughness: 0.7
                });
                const shield = new THREE.Mesh(shieldGeometry, shieldMaterial);
                shield.rotation.x = Math.PI / 2;
                
                // Shield boss
                const bossGeometry = new THREE.SphereGeometry(0.15, 8, 8);
                const bossMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xc0c0c0,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const boss = new THREE.Mesh(bossGeometry, bossMaterial);
                boss.position.z = 0.05;
                
                // Handle
                const handleGeometry = new THREE.CylinderGeometry(0.03, 0.03, 0.2, 8);
                const handleMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.8
                });
                const handle = new THREE.Mesh(handleGeometry, handleMaterial);
                handle.position.z = 0.05;
                handle.rotation.x = Math.PI / 2;
                
                group.add(shield);
                group.add(boss);
                group.add(handle);
                group.name = "Shield";
                
                return group;
            }

            createTreasureChest() {
                const group = new THREE.Group();
                
                // Chest body
                const chestGeometry = new THREE.BoxGeometry(1, 0.7, 0.8);
                const chestMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.8
                });
                const chest = new THREE.Mesh(chestGeometry, chestMaterial);
                chest.position.y = 0.35;
                
                // Chest lid
                const lidGeometry = new THREE.BoxGeometry(1, 0.1, 0.8);
                const lidMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xa0522d,
                    metalness: 0.1,
                    roughness: 0.8
                });
                const lid = new THREE.Mesh(lidGeometry, lidMaterial);
                lid.position.y = 0.75;
                lid.rotation.x = Math.PI / 6;
                lid.position.z = -0.3;
                
                // Lock
                const lockGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.1, 8);
                const lockMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffd700,
                    metalness: 0.9,
                    roughness: 0.1
                });
                const lock = new THREE.Mesh(lockGeometry, lockMaterial);
                lock.position.y = 0.7;
                lock.position.z = 0.35;
                
                group.add(chest);
                group.add(lid);
                group.add(lock);
                group.name = "Treasure_Chest";
                
                return group;
            }

            createHealthPotion() {
                const group = new THREE.Group();
                
                // Bottle
                const bottleGeometry = new THREE.CylinderGeometry(0.2, 0.15, 0.5, 16);
                const bottleMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xff0000,
                    metalness: 0.1,
                    roughness: 0.3,
                    transparent: true,
                    opacity: 0.7
                });
                const bottle = new THREE.Mesh(bottleGeometry, bottleMaterial);
                
                // Cork
                const corkGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.1, 8);
                const corkMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.8
                });
                const cork = new THREE.Mesh(corkGeometry, corkMaterial);
                cork.position.y = 0.3;
                
                group.add(bottle);
                group.add(cork);
                group.name = "Health_Potion";
                
                return group;
            }

            createDragon() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.SphereGeometry(0.5, 16, 16);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x228B22,
                    metalness: 0.3,
                    roughness: 0.7
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                
                // Head
                const headGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                const headMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x32CD32,
                    metalness: 0.3,
                    roughness: 0.7
                });
                const head = new THREE.Mesh(headGeometry, headMaterial);
                head.position.y = 0.5;
                head.position.z = 0.5;
                
                // Wings
                const wingGeometry = new THREE.PlaneGeometry(1, 0.5);
                const wingMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x2E8B57,
                    metalness: 0.2,
                    roughness: 0.8,
                    side: THREE.DoubleSide
                });
                const leftWing = new THREE.Mesh(wingGeometry, wingMaterial);
                leftWing.position.x = -0.5;
                leftWing.position.y = 0.3;
                leftWing.rotation.z = Math.PI / 4;
                
                const rightWing = new THREE.Mesh(wingGeometry, wingMaterial);
                rightWing.position.x = 0.5;
                rightWing.position.y = 0.3;
                rightWing.rotation.z = -Math.PI / 4;
                
                // Tail
                const tailGeometry = new THREE.CylinderGeometry(0.05, 0.2, 1, 8);
                const tailMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x228B22,
                    metalness: 0.3,
                    roughness: 0.7
                });
                const tail = new THREE.Mesh(tailGeometry, tailMaterial);
                tail.position.y = 0.2;
                tail.position.z = -0.7;
                tail.rotation.x = Math.PI / 2;
                
                group.add(body);
                group.add(head);
                group.add(leftWing);
                group.add(rightWing);
                group.add(tail);
                group.name = "Dragon";
                
                return group;
            }

            createCastle() {
                const group = new THREE.Group();
                
                // Main tower
                const towerGeometry = new THREE.CylinderGeometry(0.5, 0.7, 2, 8);
                const towerMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x808080,
                    metalness: 0.2,
                    roughness: 0.8
                });
                const tower = new THREE.Mesh(towerGeometry, towerMaterial);
                tower.position.y = 1;
                
                // Tower roof
                const roofGeometry = new THREE.ConeGeometry(0.7, 0.8, 8);
                const roofMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B0000,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const roof = new THREE.Mesh(roofGeometry, roofMaterial);
                roof.position.y = 2.4;
                
                // Walls
                const wallGeometry = new THREE.BoxGeometry(3, 1, 3);
                const wallMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x696969,
                    metalness: 0.2,
                    roughness: 0.8
                });
                const walls = new THREE.Mesh(wallGeometry, wallMaterial);
                walls.position.y = 0.5;
                
                // Gate
                const gateGeometry = new THREE.BoxGeometry(0.8, 1, 0.1);
                const gateMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const gate = new THREE.Mesh(gateGeometry, gateMaterial);
                gate.position.z = 1.5;
                gate.position.y = 0.5;
                
                group.add(tower);
                group.add(roof);
                group.add(walls);
                group.add(gate);
                group.name = "Castle";
                
                return group;
            }

            // FPS GAME MODELS
            createAssaultRifle() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.BoxGeometry(1.5, 0.2, 0.3);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                
                // Barrel
                const barrelGeometry = new THREE.CylinderGeometry(0.05, 0.05, 1, 16);
                const barrelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x666666,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const barrel = new THREE.Mesh(barrelGeometry, barrelMaterial);
                barrel.rotation.z = Math.PI / 2;
                barrel.position.x = 1.25;
                
                // Stock
                const stockGeometry = new THREE.BoxGeometry(0.4, 0.2, 0.3);
                const stockMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const stock = new THREE.Mesh(stockGeometry, stockMaterial);
                stock.position.x = -0.8;
                
                // Magazine
                const magazineGeometry = new THREE.BoxGeometry(0.2, 0.4, 0.2);
                const magazineMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x222222,
                    metalness: 0.6,
                    roughness: 0.4
                });
                const magazine = new THREE.Mesh(magazineGeometry, magazineMaterial);
                magazine.position.y = -0.2;
                magazine.position.x = 0.2;
                
                group.add(body);
                group.add(barrel);
                group.add(stock);
                group.add(magazine);
                group.name = "Assault_Rifle";
                
                return group;
            }

            createPistol() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.BoxGeometry(0.8, 0.15, 0.2);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                
                // Barrel
                const barrelGeometry = new THREE.CylinderGeometry(0.04, 0.04, 0.5, 16);
                const barrelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x666666,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const barrel = new THREE.Mesh(barrelGeometry, barrelMaterial);
                barrel.rotation.z = Math.PI / 2;
                barrel.position.x = 0.65;
                
                // Grip
                const gripGeometry = new THREE.BoxGeometry(0.2, 0.3, 0.15);
                const gripMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const grip = new THREE.Mesh(gripGeometry, gripMaterial);
                grip.position.y = -0.2;
                grip.position.x = -0.2;
                
                group.add(body);
                group.add(barrel);
                group.add(grip);
                group.name = "Pistol";
                
                return group;
            }

            createShotgun() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.BoxGeometry(1.2, 0.25, 0.4);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                
                // Barrel
                const barrelGeometry = new THREE.CylinderGeometry(0.08, 0.08, 1, 16);
                const barrelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x666666,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const barrel = new THREE.Mesh(barrelGeometry, barrelMaterial);
                barrel.rotation.z = Math.PI / 2;
                barrel.position.x = 1.1;
                
                // Stock
                const stockGeometry = new THREE.BoxGeometry(0.5, 0.2, 0.3);
                const stockMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const stock = new THREE.Mesh(stockGeometry, stockMaterial);
                stock.position.x = -0.85;
                
                // Pump
                const pumpGeometry = new THREE.BoxGeometry(0.6, 0.1, 0.2);
                const pumpMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x222222,
                    metalness: 0.6,
                    roughness: 0.4
                });
                const pump = new THREE.Mesh(pumpGeometry, pumpMaterial);
                pump.position.y = -0.1;
                pump.position.x = 0.3;
                
                group.add(body);
                group.add(barrel);
                group.add(stock);
                group.add(pump);
                group.name = "Shotgun";
                
                return group;
            }

            createSniperRifle() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.BoxGeometry(1.8, 0.15, 0.3);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                
                // Barrel
                const barrelGeometry = new THREE.CylinderGeometry(0.04, 0.04, 1.5, 16);
                const barrelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x666666,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const barrel = new THREE.Mesh(barrelGeometry, barrelMaterial);
                barrel.rotation.z = Math.PI / 2;
                barrel.position.x = 1.6;
                
                // Scope
                const scopeGeometry = new THREE.CylinderGeometry(0.08, 0.08, 0.3, 16);
                const scopeMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x111111,
                    metalness: 0.9,
                    roughness: 0.1
                });
                const scope = new THREE.Mesh(scopeGeometry, scopeMaterial);
                scope.position.y = 0.2;
                scope.position.x = 0.5;
                scope.rotation.z = Math.PI / 2;
                
                // Bipod
                const bipodGeometry = new THREE.BoxGeometry(0.4, 0.02, 0.02);
                const bipodMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x222222,
                    metalness: 0.6,
                    roughness: 0.4
                });
                const bipod = new THREE.Mesh(bipodGeometry, bipodMaterial);
                bipod.position.y = -0.1;
                bipod.position.x = 1.3;
                
                group.add(body);
                group.add(barrel);
                group.add(scope);
                group.add(bipod);
                group.name = "Sniper_Rifle";
                
                return group;
            }

            createAmmoCrate() {
                const group = new THREE.Group();
                
                // Crate
                const crateGeometry = new THREE.BoxGeometry(1, 0.8, 0.6);
                const crateMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const crate = new THREE.Mesh(crateGeometry, crateMaterial);
                crate.position.y = 0.4;
                
                // Ammo belts
                const ammoGeometry = new THREE.BoxGeometry(0.8, 0.1, 0.4);
                const ammoMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xc0c0c0,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const ammo1 = new THREE.Mesh(ammoGeometry, ammoMaterial);
                ammo1.position.y = 0.7;
                
                const ammo2 = new THREE.Mesh(ammoGeometry, ammoMaterial);
                ammo2.position.y = 0.5;
                
                const ammo3 = new THREE.Mesh(ammoGeometry, ammoMaterial);
                ammo3.position.y = 0.3;
                
                group.add(crate);
                group.add(ammo1);
                group.add(ammo2);
                group.add(ammo3);
                group.name = "Ammo_Crate";
                
                return group;
            }

            createExplosiveBarrel() {
                const group = new THREE.Group();
                
                // Barrel body
                const barrelGeometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 16);
                const barrelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xff0000,
                    metalness: 0.3,
                    roughness: 0.7
                });
                const barrel = new THREE.Mesh(barrelGeometry, barrelMaterial);
                
                // Bands
                const bandGeometry = new THREE.TorusGeometry(0.5, 0.03, 8, 16);
                const bandMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const band1 = new THREE.Mesh(bandGeometry, bandMaterial);
                band1.position.y = 0.3;
                band1.rotation.x = Math.PI / 2;
                
                const band2 = new THREE.Mesh(bandGeometry, bandMaterial);
                band2.position.y = -0.3;
                band2.rotation.x = Math.PI / 2;
                
                // Warning symbol
                const symbolGeometry = new THREE.PlaneGeometry(0.3, 0.3);
                const symbolMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffff00,
                    metalness: 0.1,
                    roughness: 0.9,
                    side: THREE.DoubleSide
                });
                const symbol = new THREE.Mesh(symbolGeometry, symbolMaterial);
                symbol.position.z = 0.51;
                
                group.add(barrel);
                group.add(band1);
                group.add(band2);
                group.add(symbol);
                group.name = "Explosive_Barrel";
                
                return group;
            }

            // VEHICLE MODELS
            createCar() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.BoxGeometry(2, 0.5, 1);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xff0000,
                    metalness: 0.4,
                    roughness: 0.6
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.position.y = 0.25;
                
                // Roof
                const roofGeometry = new THREE.BoxGeometry(1.2, 0.3, 0.9);
                const roofMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xff0000,
                    metalness: 0.4,
                    roughness: 0.6
                });
                const roof = new THREE.Mesh(roofGeometry, roofMaterial);
                roof.position.y = 0.65;
                roof.position.z = -0.1;
                
                // Windows
                const windowGeometry = new THREE.BoxGeometry(1.1, 0.25, 0.8);
                const windowMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x87CEEB,
                    metalness: 0.1,
                    roughness: 0.1,
                    transparent: true,
                    opacity: 0.7
                });
                const window = new THREE.Mesh(windowGeometry, windowMaterial);
                window.position.y = 0.65;
                window.position.z = -0.1;
                
                // Wheels
                const wheelGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
                const wheelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.2,
                    roughness: 0.8
                });
                
                const positions = [
                    [-0.7, -0.2, 0.6],
                    [0.7, -0.2, 0.6],
                    [-0.7, -0.2, -0.6],
                    [0.7, -0.2, -0.6]
                ];
                
                positions.forEach(pos => {
                    const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                    wheel.position.set(pos[0], pos[1], pos[2]);
                    wheel.rotation.z = Math.PI / 2;
                    group.add(wheel);
                });
                
                // Headlights
                const headlightGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                const headlightMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffffcc,
                    metalness: 0.1,
                    roughness: 0.1,
                    emissive: 0x444400
                });
                
                const headlight1 = new THREE.Mesh(headlightGeometry, headlightMaterial);
                headlight1.position.set(1, 0.3, 0.3);
                
                const headlight2 = new THREE.Mesh(headlightGeometry, headlightMaterial);
                headlight2.position.set(1, 0.3, -0.3);
                
                group.add(body);
                group.add(roof);
                group.add(window);
                group.add(headlight1);
                group.add(headlight2);
                group.name = "Car";
                
                return group;
            }

            createTank() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.BoxGeometry(2, 0.8, 1.2);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x556B2F,
                    metalness: 0.5,
                    roughness: 0.7
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.position.y = 0.4;
                
                // Turret
                const turretGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.4, 8);
                const turretMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x556B2F,
                    metalness: 0.5,
                    roughness: 0.7
                });
                const turret = new THREE.Mesh(turretGeometry, turretMaterial);
                turret.position.y = 1;
                
                // Gun
                const gunGeometry = new THREE.CylinderGeometry(0.1, 0.1, 1.5, 8);
                const gunMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const gun = new THREE.Mesh(gunGeometry, gunMaterial);
                gun.position.y = 1;
                gun.position.z = 0.9;
                gun.rotation.x = Math.PI / 2;
                
                // Tracks
                const trackGeometry = new THREE.BoxGeometry(2.2, 0.3, 1.4);
                const trackMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x222222,
                    metalness: 0.3,
                    roughness: 0.8
                });
                const leftTrack = new THREE.Mesh(trackGeometry, trackMaterial);
                leftTrack.position.y = 0.15;
                leftTrack.position.z = 0.7;
                
                const rightTrack = new THREE.Mesh(trackGeometry, trackMaterial);
                rightTrack.position.y = 0.15;
                rightTrack.position.z = -0.7;
                
                group.add(body);
                group.add(turret);
                group.add(gun);
                group.add(leftTrack);
                group.add(rightTrack);
                group.name = "Tank";
                
                return group;
            }

            createSpaceship() {
                const group = new THREE.Group();
                
                // Fuselage
                const fuselageGeometry = new THREE.CylinderGeometry(0.3, 0.1, 2, 8);
                const fuselageMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x87CEEB,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const fuselage = new THREE.Mesh(fuselageGeometry, fuselageMaterial);
                fuselage.rotation.z = Math.PI / 2;
                
                // Cockpit
                const cockpitGeometry = new THREE.SphereGeometry(0.4, 8, 8);
                const cockpitMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x87CEEB,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
                cockpit.position.x = -0.8;
                
                // Wings
                const wingGeometry = new THREE.BoxGeometry(1.5, 0.1, 0.8);
                const wingMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1E90FF,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const wing = new THREE.Mesh(wingGeometry, wingMaterial);
                wing.position.y = -0.1;
                
                // Engines
                const engineGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.6, 8);
                const engineMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.9,
                    roughness: 0.1
                });
                const engine1 = new THREE.Mesh(engineGeometry, engineMaterial);
                engine1.position.x = 0.8;
                engine1.position.y = 0.1;
                engine1.position.z = 0.3;
                
                const engine2 = new THREE.Mesh(engineGeometry, engineMaterial);
                engine2.position.x = 0.8;
                engine2.position.y = 0.1;
                engine2.position.z = -0.3;
                
                group.add(fuselage);
                group.add(cockpit);
                group.add(wing);
                group.add(engine1);
                group.add(engine2);
                group.name = "Spaceship";
                
                return group;
            }

            createHelicopter() {
                const group = new THREE.Group();
                
                // Body
                const bodyGeometry = new THREE.CylinderGeometry(0.4, 0.4, 1.5, 8);
                const bodyMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x228B22,
                    metalness: 0.4,
                    roughness: 0.6
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.rotation.z = Math.PI / 2;
                
                // Cockpit
                const cockpitGeometry = new THREE.SphereGeometry(0.3, 8, 8);
                const cockpitMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x87CEEB,
                    metalness: 0.1,
                    roughness: 0.1,
                    transparent: true,
                    opacity: 0.7
                });
                const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
                cockpit.position.x = -0.5;
                
                // Main rotor
                const rotorGeometry = new THREE.BoxGeometry(3, 0.05, 0.2);
                const rotorMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const rotor = new THREE.Mesh(rotorGeometry, rotorMaterial);
                rotor.position.y = 0.8;
                
                // Tail
                const tailGeometry = new THREE.BoxGeometry(1, 0.2, 0.2);
                const tailMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x228B22,
                    metalness: 0.4,
                    roughness: 0.6
                });
                const tail = new THREE.Mesh(tailGeometry, tailMaterial);
                tail.position.x = 1.2;
                tail.position.y = 0.4;
                
                // Tail rotor
                const tailRotorGeometry = new THREE.BoxGeometry(0.4, 0.2, 0.05);
                const tailRotorMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const tailRotor = new THREE.Mesh(tailRotorGeometry, tailRotorMaterial);
                tailRotor.position.x = 1.8;
                tailRotor.position.y = 0.4;
                
                // Landing skids
                const skidGeometry = new THREE.BoxGeometry(1, 0.1, 0.1);
                const skidMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x333333,
                    metalness: 0.5,
                    roughness: 0.5
                });
                const leftSkid = new THREE.Mesh(skidGeometry, skidMaterial);
                leftSkid.position.y = -0.3;
                leftSkid.position.z = 0.4;
                
                const rightSkid = new THREE.Mesh(skidGeometry, skidMaterial);
                rightSkid.position.y = -0.3;
                rightSkid.position.z = -0.4;
                
                group.add(body);
                group.add(cockpit);
                group.add(rotor);
                group.add(tail);
                group.add(tailRotor);
                group.add(leftSkid);
                group.add(rightSkid);
                group.name = "Helicopter";
                
                return group;
            }

            // ENVIRONMENT MODELS
            createTree() {
                const group = new THREE.Group();
                
                // Trunk
                const trunkGeometry = new THREE.CylinderGeometry(0.1, 0.15, 2, 8);
                const trunkMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
                trunk.position.y = 1;
                
                // Leaves
                const leavesGeometry = new THREE.SphereGeometry(1, 8, 8);
                const leavesMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x228B22,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
                leaves.position.y = 2.5;
                
                group.add(trunk);
                group.add(leaves);
                group.name = "Tree";
                
                return group;
            }

            createRock() {
                const group = new THREE.Group();
                
                // Main rock
                const rockGeometry = new THREE.SphereGeometry(0.5, 6, 6);
                const rockMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x696969,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const rock = new THREE.Mesh(rockGeometry, rockMaterial);
                
                // Smaller rocks
                const smallRock1Geometry = new THREE.SphereGeometry(0.2, 4, 4);
                const smallRock1 = new THREE.Mesh(smallRock1Geometry, rockMaterial);
                smallRock1.position.set(0.3, 0.1, 0.3);
                
                const smallRock2Geometry = new THREE.SphereGeometry(0.15, 4, 4);
                const smallRock2 = new THREE.Mesh(smallRock2Geometry, rockMaterial);
                smallRock2.position.set(-0.2, -0.1, -0.2);
                
                group.add(rock);
                group.add(smallRock1);
                group.add(smallRock2);
                group.name = "Rock";
                
                return group;
            }

            createHouse() {
                const group = new THREE.Group();
                
                // Base
                const baseGeometry = new THREE.BoxGeometry(2, 1, 2);
                const baseMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xf5f5dc,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const base = new THREE.Mesh(baseGeometry, baseMaterial);
                base.position.y = 0.5;
                
                // Roof
                const roofGeometry = new THREE.ConeGeometry(1.5, 1, 4);
                const roofMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B0000,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const roof = new THREE.Mesh(roofGeometry, roofMaterial);
                roof.position.y = 1.5;
                roof.rotation.y = Math.PI / 4;
                
                // Door
                const doorGeometry = new THREE.BoxGeometry(0.5, 0.8, 0.1);
                const doorMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x8B4513,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const door = new THREE.Mesh(doorGeometry, doorMaterial);
                door.position.z = 1.01;
                door.position.y = 0.4;
                
                // Windows
                const windowGeometry = new THREE.PlaneGeometry(0.4, 0.4);
                const windowMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x87CEEB,
                    metalness: 0.1,
                    roughness: 0.1,
                    side: THREE.DoubleSide
                });
                const window1 = new THREE.Mesh(windowGeometry, windowMaterial);
                window1.position.set(0.6, 0.8, 1.01);
                
                const window2 = new THREE.Mesh(windowGeometry, windowMaterial);
                window2.position.set(-0.6, 0.8, 1.01);
                
                group.add(base);
                group.add(roof);
                group.add(door);
                group.add(window1);
                group.add(window2);
                group.name = "House";
                
                return group;
            }

            createBridge() {
                const group = new THREE.Group();
                
                // Road
                const roadGeometry = new THREE.BoxGeometry(4, 0.2, 1);
                const roadMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x696969,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const road = new THREE.Mesh(roadGeometry, roadMaterial);
                road.position.y = 1.1;
                
                // Pillars
                const pillarGeometry = new THREE.CylinderGeometry(0.2, 0.2, 2, 8);
                const pillarMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x808080,
                    metalness: 0.3,
                    roughness: 0.7
                });
                
                const pillar1 = new THREE.Mesh(pillarGeometry, pillarMaterial);
                pillar1.position.set(-1.5, 0, 0);
                
                const pillar2 = new THREE.Mesh(pillarGeometry, pillarMaterial);
                pillar2.position.set(0, 0, 0);
                
                const pillar3 = new THREE.Mesh(pillarGeometry, pillarMaterial);
                pillar3.position.set(1.5, 0, 0);
                
                // Cables
                const cableGeometry = new THREE.CylinderGeometry(0.03, 0.03, 3, 8);
                const cableMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xc0c0c0,
                    metalness: 0.7,
                    roughness: 0.3
                });
                
                const cable1 = new THREE.Mesh(cableGeometry, cableMaterial);
                cable1.position.set(-2, 1.5, 0);
                cable1.rotation.z = Math.PI / 6;
                
                const cable2 = new THREE.Mesh(cableGeometry, cableMaterial);
                cable2.position.set(2, 1.5, 0);
                cable2.rotation.z = -Math.PI / 6;
                
                group.add(road);
                group.add(pillar1);
                group.add(pillar2);
                group.add(pillar3);
                group.add(cable1);
                group.add(cable2);
                group.name = "Bridge";
                
                return group;
            }

            // BASIC SHAPES
            createCube() {
                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x4a8cff,
                    metalness: 0.2,
                    roughness: 0.5
                });
                const cube = new THREE.Mesh(geometry, material);
                cube.name = "Cube";
                return cube;
            }

            createSphere() {
                const geometry = new THREE.SphereGeometry(0.5, 32, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xff6b6b,
                    metalness: 0.3,
                    roughness: 0.4
                });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.name = "Sphere";
                return sphere;
            }

            createCylinder() {
                const geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x6bff6b,
                    metalness: 0.2,
                    roughness: 0.6
                });
                const cylinder = new THREE.Mesh(geometry, material);
                cylinder.name = "Cylinder";
                return cylinder;
            }

            createCone() {
                const geometry = new THREE.ConeGeometry(0.5, 1, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xffcc00,
                    metalness: 0.2,
                    roughness: 0.6
                });
                const cone = new THREE.Mesh(geometry, material);
                cone.name = "Cone";
                return cone;
            }

            createTorus() {
                const geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 32);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xcc66ff,
                    metalness: 0.4,
                    roughness: 0.5
                });
                const torus = new THREE.Mesh(geometry, material);
                torus.name = "Torus";
                return torus;
            }

            createPlane() {
                const geometry = new THREE.PlaneGeometry(2, 2);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x8a8a8a,
                    metalness: 0.1,
                    roughness: 0.8,
                    side: THREE.DoubleSide
                });
                const plane = new THREE.Mesh(geometry, material);
                plane.name = "Plane";
                return plane;
            }

            handleObjectSelection(event) {
                if (this.currentMode !== 'model') return;
                
                const mouse = new THREE.Vector2();
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
                
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, this.camera);
                
                const intersects = raycaster.intersectObjects(this.objects);
                
                if (intersects.length > 0) {
                    this.selectObject(intersects[0].object);
                } else {
                    this.selectObject(null);
                }
            }

            selectObject(object) {
                if (this.selectedObject) {
                    // Reset previous selection appearance if needed
                }
                
                this.selectedObject = object;
                
                if (this.selectedObject) {
                    this.transformControls.attach(this.selectedObject);
                    this.updatePropertiesPanel();
                } else {
                    this.transformControls.detach();
                }
                
                this.updateHierarchy();
            }

            updatePropertiesPanel() {
                if (this.selectedObject) {
                    document.getElementById('pos-x').value = this.selectedObject.position.x.toFixed(2);
                    document.getElementById('pos-y').value = this.selectedObject.position.y.toFixed(2);
                    document.getElementById('pos-z').value = this.selectedObject.position.z.toFixed(2);
                    
                    document.getElementById('rot-x').value = (this.selectedObject.rotation.x * (180 / Math.PI)).toFixed(2);
                    document.getElementById('rot-y').value = (this.selectedObject.rotation.y * (180 / Math.PI)).toFixed(2);
                    document.getElementById('rot-z').value = (this.selectedObject.rotation.z * (180 / Math.PI)).toFixed(2);
                    
                    document.getElementById('scale-x').value = this.selectedObject.scale.x.toFixed(2);
                    document.getElementById('scale-y').value = this.selectedObject.scale.y.toFixed(2);
                    document.getElementById('scale-z').value = this.selectedObject.scale.z.toFixed(2);
                    
                    if (this.selectedObject.material && this.selectedObject.material.color) {
                        document.getElementById('object-color').value = '#' + this.selectedObject.material.color.getHexString();
                        document.getElementById('metallic-slider').value = this.selectedObject.material.metalness || 0;
                        document.getElementById('roughness-slider').value = this.selectedObject.material.roughness || 0.5;
                        document.getElementById('wireframe-toggle').checked = 
                            this.selectedObject.material ? this.selectedObject.material.wireframe : false;
                    }
                }
            }

            applyProperties() {
                if (this.selectedObject) {
                    this.selectedObject.position.set(
                        parseFloat(document.getElementById('pos-x').value) || 0,
                        parseFloat(document.getElementById('pos-y').value) || 0,
                        parseFloat(document.getElementById('pos-z').value) || 0
                    );
                    
                    this.selectedObject.rotation.set(
                        (parseFloat(document.getElementById('rot-x').value) || 0) * (Math.PI / 180),
                        (parseFloat(document.getElementById('rot-y').value) || 0) * (Math.PI / 180),
                        (parseFloat(document.getElementById('rot-z').value) || 0) * (Math.PI / 180)
                    );
                    
                    this.selectedObject.scale.set(
                        parseFloat(document.getElementById('scale-x').value) || 1,
                        parseFloat(document.getElementById('scale-y').value) || 1,
                        parseFloat(document.getElementById('scale-z').value) || 1
                    );
                    
                    if (this.selectedObject.material) {
                        const color = document.getElementById('object-color').value;
                        this.selectedObject.material.color.setStyle(color);
                        this.selectedObject.material.metalness = parseFloat(document.getElementById('metallic-slider').value) || 0;
                        this.selectedObject.material.roughness = parseFloat(document.getElementById('roughness-slider').value) || 0.5;
                        this.selectedObject.material.wireframe = document.getElementById('wireframe-toggle').checked;
                    }
                    
                    // Update transform controls
                    this.transformControls.update();
                    this.updateHierarchy();
                }
            }

            deleteSelectedObject() {
                if (this.selectedObject) {
                    this.scene.remove(this.selectedObject);
                    this.objects = this.objects.filter(obj => obj !== this.selectedObject);
                    this.selectedObject = null;
                    this.transformControls.detach();
                    this.updateObjectCount();
                    this.updateHierarchy();
                }
            }

            updateHierarchy() {
                const hierarchyList = document.getElementById('hierarchy-list');
                hierarchyList.innerHTML = '';
                
                this.objects.forEach(obj => {
                    const li = document.createElement('li');
                    li.className = `object-item ${obj === this.selectedObject ? 'selected' : ''}`;
                    li.textContent = obj.name;
                    li.addEventListener('click', () => {
                        this.selectObject(obj);
                    });
                    hierarchyList.appendChild(li);
                });
            }

            switchMode(mode) {
                this.currentMode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(mode + '-mode-btn').classList.add('active');
                document.getElementById('mode-status').textContent = mode.toUpperCase() + ' MODE: ACTIVE';
                
                // Show/hide mode-specific windows
                document.querySelectorAll('.ui-window').forEach(window => {
                    window.style.display = 'none';
                });
                
                if (mode === 'model') {
                    document.getElementById('model-templates').style.display = 'block';
                    document.getElementById('scene-hierarchy').style.display = 'block';
                    document.getElementById('model-properties').style.display = 'block';
                    this.transformControls.enabled = true;
                } else if (mode === 'level') {
                    document.querySelector('.level-mode').style.display = 'block';
                    this.transformControls.enabled = false;
                } else if (mode === 'json') {
                    document.querySelector('.json-mode').style.display = 'block';
                    this.transformControls.enabled = false;
                }
            }

            switchTool(tool) {
                this.currentTool = tool;
                
                // Update UI
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById(tool + '-tool').classList.add('active');
                document.getElementById('tool-status').textContent = tool.toUpperCase();
                
                // Update transform controls mode
                switch(tool) {
                    case 'select':
                        this.transformControls.setMode('translate');
                        break;
                    case 'move':
                        this.transformControls.setMode('translate');
                        break;
                    case 'rotate':
                        this.transformControls.setMode('rotate');
                        break;
                    case 'scale':
                        this.transformControls.setMode('scale');
                        break;
                }
            }

            updateObjectCount() {
                document.getElementById('object-count').textContent = this.objects.length;
            }

            updateJSONEditor() {
                const sceneData = {
                    metadata: {
                        version: "1.0",
                        generator: "3D STUDIO - webXOS"
                    },
                    objects: this.objects.map(obj => ({
                        name: obj.name,
                        type: obj.userData.type,
                        position: {
                            x: obj.position.x,
                            y: obj.position.y,
                            z: obj.position.z
                        },
                        rotation: {
                            x: obj.rotation.x,
                            y: obj.rotation.y,
                            z: obj.rotation.z
                        },
                        scale: {
                            x: obj.scale.x,
                            y: obj.scale.y,
                            z: obj.scale.z
                        },
                        material: {
                            color: obj.material ? '#' + obj.material.color.getHexString() : '#00ff00',
                            metalness: obj.material ? obj.material.metalness : 0,
                            roughness: obj.material ? obj.material.roughness : 0.5,
                            wireframe: obj.material ? obj.material.wireframe : false
                        }
                    }))
                };
                
                document.getElementById('json-editor').value = JSON.stringify(sceneData, null, 2);
            }

            updateSceneFromJSON() {
                try {
                    const jsonText = document.getElementById('json-editor').value;
                    const sceneData = JSON.parse(jsonText);
                    
                    // Clear current scene
                    this.objects.forEach(obj => this.scene.remove(obj));
                    this.objects = [];
                    this.selectedObject = null;
                    this.transformControls.detach();
                    
                    // Add objects from JSON
                    if (sceneData.objects) {
                        sceneData.objects.forEach(objData => {
                            this.addTemplate(objData.type);
                            const newObj = this.objects[this.objects.length - 1];
                            
                            newObj.name = objData.name;
                            newObj.position.set(
                                objData.position.x,
                                objData.position.y,
                                objData.position.z
                            );
                            newObj.rotation.set(
                                objData.rotation.x,
                                objData.rotation.y,
                                objData.rotation.z
                            );
                            newObj.scale.set(
                                objData.scale.x,
                                objData.scale.y,
                                objData.scale.z
                            );
                            
                            if (newObj.material && objData.material) {
                                newObj.material.color.setStyle(objData.material.color);
                                newObj.material.metalness = objData.material.metalness || 0;
                                newObj.material.roughness = objData.material.roughness || 0.5;
                                newObj.material.wireframe = objData.material.wireframe || false;
                            }
                        });
                    }
                    
                    this.updateObjectCount();
                    this.updateHierarchy();
                    alert('Scene updated from JSON!');
                } catch (error) {
                    alert('Error parsing JSON: ' + error.message);
                }
            }

            copyJSONToClipboard() {
                const jsonText = document.getElementById('json-editor');
                jsonText.select();
                document.execCommand('copy');
                alert('JSON copied to clipboard!');
            }

            newProject() {
                if (confirm('Are you sure you want to create a new project? All unsaved changes will be lost.')) {
                    this.objects.forEach(obj => this.scene.remove(obj));
                    this.objects = [];
                    this.selectedObject = null;
                    this.transformControls.detach();
                    this.addDefaultObject();
                    this.updateObjectCount();
                    this.updateHierarchy();
                }
            }

            saveProject() {
                this.updateJSONEditor();
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(document.getElementById('json-editor').value);
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "3dstudio_project.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            loadProject() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = event => {
                        document.getElementById('json-editor').value = event.target.result;
                        this.updateSceneFromJSON();
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            exportJSON() {
                this.updateJSONEditor();
                this.switchMode('json');
            }

            importJSON() {
                this.loadProject();
            }

            generateLevel() {
                // Clear existing objects
                this.objects.forEach(obj => this.scene.remove(obj));
                this.objects = [];
                
                // Add ground plane
                const groundGeometry = new THREE.PlaneGeometry(
                    parseInt(document.getElementById('level-width').value) || 100,
                    parseInt(document.getElementById('level-height').value) || 100
                );
                const groundMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x3a7d3a,
                    side: THREE.DoubleSide
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = Math.PI / 2;
                ground.name = "Ground";
                ground.userData = { type: 'ground' };
                ground.receiveShadow = true;
                this.scene.add(ground);
                this.objects.push(ground);
                
                // Add some random objects based on level settings
                const enemyCount = parseInt(document.getElementById('enemy-count').value) || 10;
                const itemCount = parseInt(document.getElementById('item-count').value) || 5;
                
                for (let i = 0; i < enemyCount; i++) {
                    this.addTemplate('rock');
                    const enemy = this.objects[this.objects.length - 1];
                    enemy.position.set(
                        (Math.random() - 0.5) * (parseInt(document.getElementById('level-width').value) || 100) * 0.8,
                        0.5,
                        (Math.random() - 0.5) * (parseInt(document.getElementById('level-height').value) || 100) * 0.8
                    );
                    enemy.name = "Enemy_" + (i + 1);
                    enemy.userData = { type: 'enemy' };
                    enemy.material.color.setStyle('#ff0000');
                }
                
                for (let i = 0; i < itemCount; i++) {
                    this.addTemplate('potion');
                    const item = this.objects[this.objects.length - 1];
                    item.position.set(
                        (Math.random() - 0.5) * (parseInt(document.getElementById('level-width').value) || 100) * 0.8,
                        0.3,
                        (Math.random() - 0.5) * (parseInt(document.getElementById('level-height').value) || 100) * 0.8
                    );
                    item.name = "Item_" + (i + 1);
                    item.userData = { type: 'item' };
                }
                
                // Add spawn point
                const spawnX = parseFloat(document.getElementById('spawn-x').value) || 0;
                const spawnY = parseFloat(document.getElementById('spawn-y').value) || 0;
                const spawnZ = parseFloat(document.getElementById('spawn-z').value) || 0;
                
                this.addTemplate('chest');
                const spawn = this.objects[this.objects.length - 1];
                spawn.position.set(spawnX, 0.05, spawnZ);
                spawn.name = "Spawn_Point";
                spawn.userData = { type: 'spawn' };
                spawn.material.color.setStyle('#00ff00');
                
                this.updateObjectCount();
                this.updateHierarchy();
                alert('Level generated with ' + enemyCount + ' enemies and ' + itemCount + ' items!');
            }

            clearLevel() {
                if (confirm('Are you sure you want to clear the level?')) {
                    this.objects.forEach(obj => this.scene.remove(obj));
                    this.objects = [];
                    this.selectedObject = null;
                    this.transformControls.detach();
                    this.updateObjectCount();
                    this.updateHierarchy();
                }
            }

            makeWindowsDraggable() {
                const windows = document.querySelectorAll('.ui-window');
                
                windows.forEach(window => {
                    const titleBar = window.querySelector('.title-bar');
                    let isDragging = false;
                    let offsetX, offsetY;

                    titleBar.addEventListener('mousedown', (e) => {
                        isDragging = true;
                        offsetX = e.clientX - window.offsetLeft;
                        offsetY = e.clientY - window.offsetTop;
                        window.style.zIndex = 1000;
                        
                        // Bring other windows to a lower z-index
                        windows.forEach(w => {
                            if (w !== window) w.style.zIndex = 1;
                        });
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isDragging) return;
                        
                        window.style.left = (e.clientX - offsetX) + 'px';
                        window.style.top = (e.clientY - offsetY) + 'px';
                    });

                    document.addEventListener('mouseup', () => {
                        isDragging = false;
                    });
                });
                
                // Window controls
                document.querySelectorAll('.btn-close').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.target.closest('.ui-window').style.display = 'none';
                    });
                });
                
                document.querySelectorAll('.btn-minimize').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const window = e.target.closest('.ui-window');
                        const content = window.querySelector('.window-content');
                        content.style.display = content.style.display === 'none' ? 'block' : 'none';
                    });
                });
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Update controls
                this.controls.update();
                
                // Render scene
                this.renderer.render(this.scene, this.camera);
                
                // Update FPS counter occasionally
                if (Math.random() < 0.1) {
                    document.getElementById('fps-counter').textContent = 
                        Math.floor(60 + Math.random() * 10); // Simulated FPS
                }
            }
        }

        // Initialize the application when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            new Studio3D();
        });
    </script>
</body>
</html>