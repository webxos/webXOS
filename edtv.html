<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>edTV</title>
    <meta name="theme-color" content="#000000">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
        body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
        #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
        .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3}
        .crt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;z-index:5;pointer-events:none;animation:scanline 8s linear infinite}
        @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
        #visualizationContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2}
        #ideInterface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10}
        
        /* Top Banner */
        .top-banner {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(255, 0, 255, 0.9);
            border-bottom: 2px solid #f0f;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 12;
            overflow: hidden;
            animation: glitch 3s infinite;
        }
        @keyframes glitch {
            0%, 100% { transform: translateX(0); }
            5% { transform: translateX(-2px); }
            10% { transform: translateX(2px); }
            15% { transform: translateX(-1px); }
            20% { transform: translateX(1px); }
            25% { transform: translateX(0); }
            50% { transform: translateX(0); }
            55% { transform: translateX(-1px) skewX(-2deg); }
            60% { transform: translateX(1px) skewX(2deg); }
            65% { transform: translateX(-1px) skewX(-1deg); }
            70% { transform: translateX(1px) skewX(1deg); }
            75% { transform: translateX(0); }
        }
        .top-banner-text{font-size:12px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}

        /* Left Side Controls */
        .left-controls {
            position: absolute;
            top: 60px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 11;
        }
        .live-btn{width:180px;height:52px;background:#000;border:3px solid #0ff;color:#0ff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transform:skew(-2deg);transition:background 0.1s,color 0.1s;touch-action:none}
        .live-btn:hover,.live-btn:active{background:#0ff;color:#000}
        .live-btn.active{background:#0ff;color:#000}
        .export-btn{width:180px;height:52px;background:#000;border:3px solid #ff0;color:#ff0;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transform:skew(-2deg);transition:background 0.1s,color 0.1s;touch-action:none}
        .export-btn:hover,.export-btn:active{background:#ff0;color:#000}

        /* Right Side Controls */
        .right-controls {
            position: absolute;
            top: 60px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 11;
        }
        .zoom-in-btn{width:120px;height:40px;background:#000;border:3px solid #0f0;color:#0f0;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:none}
        .zoom-out-btn{width:120px;height:40px;background:#000;border:3px solid #f00;color:#f00;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:none}
        .reset-btn{width:120px;height:40px;background:#000;border:3px solid #ff0;color:#ff0;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:none}
        .zoom-in-btn:hover,.zoom-in-btn:active{background:#0f0;color:#000}
        .zoom-out-btn:hover,.zoom-out-btn:active{background:#f00;color:#000}
        .reset-btn:hover,.reset-btn:active{background:#ff0;color:#000}

        /* PIP Face View */
        .ppv-face-view {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 140px;
            height: 105px;
            background: #000;
            border: 2px solid #0ff;
            z-index: 15;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ppv-face-view.expanded{width:300px;height:225px;z-index:20}
        .ppv-canvas{width:100%;height:100%}

        /* Status & Timer */
        .neurots-status{position:absolute;top:50px;left:10px;font-size:8px;color:#0ff;z-index:11;background:rgba(0,0,0,0.7);padding:5px;border:1px solid #0ff}
        .timer-panel{position:absolute;top:120px;left:20px;font-size:10px;color:#ff0;z-index:11;background:rgba(0,0,0,0.7);padding:8px;border:1px solid #ff0}

        /* JSON Export Panel */
        .json-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            border: 3px solid #0ff;
            padding: 15px;
            z-index: 30;
            width: 80%;
            max-width: 500px;
            display: none;
        }
        .json-title{font-size:12px;color:#0ff;margin-bottom:10px;text-align:center}
        .json-content{width:100%;height:200px;background:#000;border:2px solid #0f0;color:#0f0;font-size:8px;padding:10px;margin-bottom:10px;overflow:auto;font-family:monospace;white-space:pre-wrap}
        .json-btn{width:120px;height:40px;background:#000;border:2px solid #0f0;color:#0f0;font-size:10px;cursor:pointer;margin:0 auto;display:flex;align-items:center;justify-content:center}
        .json-btn:hover,.json-btn:active{background:#0f0;color:#000}

        /* Scene Click Area */
        #sceneClickArea{position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;cursor:pointer}

        /* Mobile Optimization */
        @media (max-width:767px){
            .ppv-face-view{width:100px;height:75px}
            .ppv-face-view.expanded{width:280px;height:210px}
            .live-btn,.export-btn{width:160px;height:48px;font-size:9px}
            .left-controls{left:10px}
            .right-controls{right:10px}
            .zoom-in-btn,.zoom-out-btn,.reset-btn{width:100px;height:36px;font-size:9px}
            .timer-panel{top:110px;left:10px;font-size:9px}
        }
    </style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt-overlay"></div>
    
    <!-- Top Banner -->
    <div class="top-banner">
        <div class="top-banner-text">edTV v1.0</div>
    </div>
    
    <!-- PIP Face View -->
    <div class="ppv-face-view" id="ppvFaceView">
        <canvas class="ppv-canvas" id="ppvCanvas"></canvas>
    </div>
    
    <!-- Status & Timer -->
    <div class="neurots-status" id="neurotsStatus">edTV: READY</div>
    <div class="timer-panel" id="timerPanel">
        PROCESSING: <span id="timerDisplay">400s</span><br>
        PROGRESS: <span id="progressDisplay">0%</span>
    </div>
    
    <!-- JSON Export Panel -->
    <div class="json-panel" id="jsonPanel">
        <div class="json-title">edTV 3D SCENE JSON:</div>
        <div class="json-content" id="jsonContent"></div>
        <button class="json-btn" id="copyJsonBtn">COPY JSON</button>
    </div>
    
    <!-- 3D Scene -->
    <div id="visualizationContainer">
        <canvas id="visualizationCanvas"></canvas>
        <div id="sceneClickArea"></div>
    </div>
    
    <div id="ideInterface">
        <!-- Left Side -->
        <div class="left-controls">
            <button id="liveBtn" class="live-btn">LIVE</button>
            <button id="exportBtn" class="export-btn">EXPORT</button>
        </div>
        
        <!-- Right Side -->
        <div class="right-controls">
            <button id="zoomInBtn" class="zoom-in-btn">ZOOM IN</button>
            <button id="zoomOutBtn" class="zoom-out-btn">ZOOM OUT</button>
            <button id="resetViewBtn" class="reset-btn">RESET VIEW</button>
        </div>
    </div>
</div>

<script>
    // Core Variables
    let scene, cam, ren, clock;
    let userObj, compassArrow;
    let faceDirection = 0, userDetected = false;
    let stream, faceMesh, camera;
    let isProcessing = false;
    let processingTimer = 400;
    let timerInterval = null;
    let animationId = null;
    let cameraDistance = 5;
    let cameraAngleX = 0, cameraAngleY = 0;
    let isDragging = false;
    let lastMouseX = 0, lastMouseY = 0;
    let lastTouchX = 0, lastTouchY = 0;
    let constellationPoints = [];
    let constellationLines = [];
    let pointCount = 0;
    const MAX_POINTS = 400;

    // Scene Data
    let sceneData = { userPosition: {x:0,y:0,z:0}, points: [], lines: [], timestamp: null };

    // DOM
    const $ = s => document.querySelector(s);

    function init() {
        init3D();
        setupFaceDetection();
        setupEventListeners();
        animate();
    }

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        
        cam = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        updateCameraPosition();
        
        const canvas = $('#visualizationCanvas');
        ren = new THREE.WebGLRenderer({ canvas, antialias: false, powerPreference: "high-performance" });
        ren.setSize(window.innerWidth, window.innerHeight);
        ren.setPixelRatio(1);
        
        clock = new THREE.Clock();

        // Lighting
        scene.add(new THREE.AmbientLight(0x003300));
        const dir = new THREE.DirectionalLight(0x00ff00, 0.3);
        dir.position.set(5, 10, 5);
        scene.add(dir);

        // Grid
        const grid = new THREE.GridHelper(20, 20, 0x004400, 0x002200);
        scene.add(grid);

        // User (locked at origin)
        userObj = createUserMesh();
        userObj.position.set(0, 0, 0);
        scene.add(userObj);

        // Compass Arrow
        compassArrow = createCompassArrow();
        compassArrow.position.set(0, 0.3, 0);
        scene.add(compassArrow);

        cam.lookAt(0, 0, 0);
    }

    function createUserMesh() {
        const group = new THREE.Group();
        const head = new THREE.Mesh(
            new THREE.SphereGeometry(0.2, 8, 6),
            new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true })
        );
        head.position.y = 0.2;
        group.add(head);
        return group;
    }

    function createCompassArrow() {
        const group = new THREE.Group();
        const body = new THREE.Mesh(
            new THREE.CylinderGeometry(0.02, 0.02, 0.4, 8),
            new THREE.MeshBasicMaterial({ color: 0xff0000 })
        );
        body.position.y = 0.2;
        group.add(body);
        const head = new THREE.Mesh(
            new THREE.ConeGeometry(0.05, 0.1, 8),
            new THREE.MeshBasicMaterial({ color: 0xff0000 })
        );
        head.position.y = 0.45;
        group.add(head);
        return group;
    }

    function updateCameraPosition() {
        const x = cameraDistance * Math.sin(cameraAngleY) * Math.cos(cameraAngleX);
        const y = cameraDistance * Math.sin(cameraAngleX) + 2;
        const z = cameraDistance * Math.cos(cameraAngleY) * Math.cos(cameraAngleX);
        cam.position.set(x, y, z);
        cam.lookAt(0, 0, 0);
    }

    function setupFaceDetection() {
        faceMesh = new FaceMesh({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        faceMesh.onResults(onFaceMeshResults);
    }

    function onFaceMeshResults(results) {
        userDetected = results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0;
        
        const ppvCanvas = $('#ppvCanvas');
        const ctx = ppvCanvas.getContext('2d');
        ctx.clearRect(0, 0, ppvCanvas.width, ppvCanvas.height);
        
        if (results.image) {
            ctx.drawImage(results.image, 0, 0, ppvCanvas.width, ppvCanvas.height);
        }

        if (userDetected && isProcessing) {
            const landmarks = results.multiFaceLandmarks[0];
            
            // Draw face mesh in PIP
            drawConnectors(ctx, landmarks, FACEMESH_TESSELATION, { color: '#00ffff', lineWidth: 1 });
            drawConnectors(ctx, landmarks, FACEMESH_FACE_OVAL, { color: '#00ff00', lineWidth: 2 });

            // Calculate face direction
            const left = landmarks[234], right = landmarks[454];
            const yaw = Math.atan2(right.x - left.x, right.z - left.z) * 180 / Math.PI;
            faceDirection = yaw;

            // Update compass
            compassArrow.rotation.y = -yaw * Math.PI / 180;
            userObj.rotation.y = -yaw * Math.PI / 180;

            // Sample 400 points around face
            if (pointCount < MAX_POINTS) {
                sampleConstellationPoint(landmarks);
            }

            $('#neurotsStatus').textContent = `edTV: ${pointCount}/400 PTS`;
        } else {
            $('#neurotsStatus').textContent = userDetected ? 'edTV: TRACKING' : 'EDTVIDE: NO FACE';
        }
    }

    function sampleConstellationPoint(landmarks) {
        if (pointCount >= MAX_POINTS) return;

        // Sample random landmark
        const idx = Math.floor(Math.random() * landmarks.length);
        const lm = landmarks[idx];
        
        // Convert to 3D world space (simplified)
        const x = (lm.x - 0.5) * 4;
        const y = (0.5 - lm.y) * 4;
        const z = lm.z * 5 - 2;

        // Add point
        const geom = new THREE.SphereGeometry(0.02, 4, 4);
        const mat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const point = new THREE.Mesh(geom, mat);
        point.position.set(x, y, z);
        scene.add(point);
        constellationPoints.push(point);

        // Connect to nearest existing point
        if (constellationPoints.length > 1) {
            const last = constellationPoints[constellationPoints.length - 2];
            const lineGeom = new THREE.BufferGeometry().setFromPoints([last.position, point.position]);
            const line = new THREE.Line(lineGeom, new THREE.LineBasicMaterial({ color: 0x00ff00 }));
            scene.add(line);
            constellationLines.push(line);
        }

        // Store in scene data
        sceneData.points.push({ x, y, z, index: pointCount });
        if (constellationPoints.length > 1) {
            const prev = constellationPoints.length - 2;
            sceneData.lines.push({ from: prev, to: pointCount });
        }

        pointCount++;
    }

    function startWebcam() {
        if (stream) return;
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
        }).then(s => {
            stream = s;
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.style.display = 'none';
            document.body.appendChild(video);

            camera = new Camera(video, {
                onFrame: async () => await faceMesh.send({ image: video }),
                width: 640, height: 480
            });
            camera.start();

            const ppv = $('#ppvCanvas');
            ppv.width = $('#ppvFaceView').clientWidth;
            ppv.height = $('#ppvFaceView').clientHeight;

            startProcessing();
        }).catch(err => {
            $('#neurotsStatus').textContent = 'CAMERA DENIED';
            console.error(err);
        });
    }

    function startProcessing() {
        isProcessing = true;
        pointCount = 0;
        processingTimer = 400;
        $('#liveBtn').classList.add('active');
        $('#liveBtn').textContent = 'LIVE ACTIVE';
        $('#timerDisplay').textContent = '400s';
        $('#progressDisplay').textContent = '0%';

        timerInterval = setInterval(() => {
            processingTimer--;
            $('#timerDisplay').textContent = `${processingTimer}s`;
            const progress = ((400 - processingTimer) / 400 * 100).toFixed(0);
            $('#progressDisplay').textContent = `${progress}%`;

            if (processingTimer <= 0) {
                finishProcessing();
            }
        }, 1000);
    }

    function finishProcessing() {
        isProcessing = false;
        clearInterval(timerInterval);
        $('#liveBtn').classList.remove('active');
        $('#liveBtn').textContent = 'LIVE';
        $('#neurotsStatus').textContent = 'eDTV: READY';
        sceneData.timestamp = new Date().toISOString();
    }

    function exportScene() {
        const json = JSON.stringify(sceneData, null, 2);
        $('#jsonContent').textContent = json;
        $('#jsonPanel').style.display = 'block';
    }

    function copyJSON() {
        navigator.clipboard.writeText($('#jsonContent').textContent).then(() => {
            alert('edTV scene copied to clipboard!');
        });
    }

    function setupEventListeners() {
        $('#liveBtn').addEventListener('click', () => {
            if (!isProcessing) startWebcam();
        });

        $('#exportBtn').addEventListener('click', exportScene);
        $('#copyJsonBtn').addEventListener('click', copyJSON);

        $('#zoomInBtn').addEventListener('click', () => { cameraDistance = Math.max(1.5, cameraDistance * 0.8); updateCameraPosition(); });
        $('#zoomOutBtn').addEventListener('click', () => { cameraDistance = Math.min(15, cameraDistance * 1.2); updateCameraPosition(); });
        $('#resetViewBtn').addEventListener('click', () => { cameraDistance = 5; cameraAngleX = cameraAngleY = 0; updateCameraPosition(); });

        $('#ppvFaceView').addEventListener('click', () => {
            $('#ppvFaceView').classList.toggle('expanded');
            const c = $('#ppvCanvas');
            c.width = $('#ppvFaceView').clientWidth;
            c.height = $('#ppvFaceView').clientHeight;
        });

        const area = $('#sceneClickArea');
        area.addEventListener('mousedown', e => { isDragging = true; lastMouseX = e.clientX; lastMouseY = e.clientY; });
        document.addEventListener('mousemove', e => {
            if (!isDragging) return;
            cameraAngleY += (e.clientX - lastMouseX) * 0.01;
            cameraAngleX = Math.max(-Math.PI/2, Math.min(Math.PI/2, cameraAngleX - (e.clientY - lastMouseY) * 0.01));
            lastMouseX = e.clientX; lastMouseY = e.clientY;
            updateCameraPosition();
        });
        document.addEventListener('mouseup', () => isDragging = false);

        area.addEventListener('touchstart', e => { if (e.touches.length === 1) { isDragging = true; lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; e.preventDefault(); } });
        area.addEventListener('touchmove', e => {
            if (isDragging && e.touches.length === 1) {
                cameraAngleY += (e.touches[0].clientX - lastTouchX) * 0.01;
                cameraAngleX = Math.max(-Math.PI/2, Math.min(Math.PI/2, cameraAngleX - (e.touches[0].clientY - lastTouchY) * 0.01));
                lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY;
                updateCameraPosition();
                e.preventDefault();
            }
        });
        area.addEventListener('touchend', () => isDragging = false);

        window.addEventListener('resize', () => {
            cam.aspect = window.innerWidth / window.innerHeight;
            cam.updateProjectionMatrix();
            ren.setSize(window.innerWidth, window.innerHeight);
            const c = $('#ppvCanvas');
            c.width = $('#ppvFaceView').clientWidth;
            c.height = $('#ppvFaceView').clientHeight;
        });
    }

    function animate() {
        animationId = requestAnimationFrame(animate);
        ren.render(scene, cam);
    }

    window.addEventListener('load', init);
</script>
</body>
</html>
