<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Galaxycraft - BETA</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: #0a0e17;
      color: #e0f7ff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* WebXOS Header Styles */
    header {
      padding: 15px 20px;
      background: rgba(5, 8, 17, 0.8);
      border-bottom: 1px solid #1e3a5f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #4fc3f7;
      text-shadow: 0 0 10px rgba(79, 195, 247, 0.7);
    }
    
    .game-stats {
      display: flex;
      gap: 20px;
    }
    
    .stat {
      background: rgba(30, 58, 95, 0.6);
      padding: 8px 15px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stat i {
      color: #4fc3f7;
    }
    
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .game-canvas-container {
      flex: 1;
      position: relative;
    }
    
    #cosmicCanvas {
      position: absolute;
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    
    .sidebar {
      width: 300px;
      background: rgba(5, 8, 17, 0.8);
      border-left: 1px solid #1e3a5f;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    
    .sidebar-section {
      margin-bottom: 25px;
    }
    
    .sidebar-title {
      font-size: 16px;
      color: #4fc3f7;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #1e3a5f;
    }
    
    .weapon {
      background: rgba(30, 58, 95, 0.6);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .weapon:hover {
      background: rgba(40, 78, 120, 0.6);
    }
    
    .weapon.active {
      background: rgba(33, 150, 243, 0.3);
      border: 1px solid #2196f3;
    }
    
    .weapon-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .weapon-stats {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #90caf9;
    }
    
    .btn {
      background: #1565c0;
      color: white;
      border: none;
      padding: 12px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
      text-align: center;
    }
    
    .btn:hover {
      background: #1976d2;
      transform: translateY(-2px);
    }
    
    .btn-primary {
      background: #0277bd;
    }
    
    .btn-danger {
      background: #c62828;
    }
    
    .btn-success {
      background: #2e7d32;
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }
    
    .chat-messages {
      flex: 1;
      background: rgba(14, 22, 37, 0.8);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      overflow-y: auto;
    }
    
    .chat-input {
      display: flex;
      gap: 10px;
    }
    
    .chat-input input {
      flex: 1;
      background: rgba(30, 58, 95, 0.6);
      border: 1px solid #1e3a5f;
      border-radius: 8px;
      padding: 10px;
      color: white;
    }
    
    .chat-input button {
      background: #1565c0;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0 15px;
      cursor: pointer;
    }
    
    footer {
      padding: 15px 20px;
      background: rgba(5, 8, 17, 0.8);
      border-top: 1px solid #1e3a5f;
      text-align: center;
      font-size: 12px;
      color: #5d7a9c;
      z-index: 10;
    }
    
    /* Galaxycraft UI Elements */
    .controls {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(20, 20, 50, 0.9);
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      backdrop-filter: blur(5px);
      z-index: 10;
    }
    
    .control-item {
      flex: 1;
      min-width: 80px;
      text-align: center;
    }
    
    .galaxycraft-btn {
      background: #4a90e2;
      border: none;
      padding: 10px 20px;
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s, background 0.2s;
    }
    
    .galaxycraft-btn:hover {
      background: #357abd;
    }
    
    .galaxycraft-btn.active {
      background: #ff4444;
    }
    
    .galaxycraft-btn:active {
      transform: scale(0.95);
    }
    
    .prompt {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 10px;
      font-size: 14px;
      max-width: 90%;
      text-align: center;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 5;
    }
    
    .prompt.active {
      opacity: 1;
    }
    
    .hud {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.4;
      z-index: 1;
    }
    
    .hud::before {
      content: '';
      position: absolute;
      top: 10%;
      left: 10%;
      right: 10%;
      bottom: 10%;
      border: 2px solid rgba(74, 144, 226, 0);
      border-radius: 20px;
      box-shadow: none;
    }
    
    .hud::after {
      content: '+';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #4a90e2;
      font-size: 24px;
    }
    
    .throttle-indicator {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      color: #4a90e2;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 5;
    }
    
    .throttle-indicator.active {
      opacity: 1;
    }
    
    .status-overlay {
      position: absolute;
      top: 60px;
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      padding: 5px 10px;
      font-size: 12px;
      text-align: left;
      color: #fff;
      text-shadow: 0 0 2px #000;
      z-index: 5;
      pointer-events: none;
    }
    
    .console {
      position: absolute;
      bottom: 60px;
      width: 100%;
      height: 25%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      z-index: 5;
      padding: 5px;
    }
    
    .console-log {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
      color: #fff;
      text-shadow: 0 0 2px #000;
      padding: 5px;
    }
    
    .console-log p {
      margin: 2px 0;
    }
    
    .console-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid #4a90e2;
      color: #fff;
      padding: 5px;
      font-size: 12px;
      outline: none;
    }
    
    .console-input::placeholder {
      color: #aaa;
    }
    
    .console::-webkit-scrollbar {
      width: 8px;
    }
    
    .console::-webkit-scrollbar-thumb {
      background: #4a90e2;
      border-radius: 4px;
    }
    
    /* WebXOS Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(5, 8, 17, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .modal-content {
      background: #0f1724;
      border: 1px solid #1e3a5f;
      border-radius: 15px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 30px rgba(0, 150, 255, 0.2);
    }
    
    .modal-title {
      font-size: 24px;
      color: #4fc3f7;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .modal-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .modal-option {
      background: rgba(30, 58, 95, 0.6);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-option:hover {
      background: rgba(40, 78, 120, 0.6);
      transform: translateY(-5px);
    }
    
    .modal-option i {
      font-size: 40px;
      color: #4fc3f7;
      margin-bottom: 10px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
    }
    
    .modal-actions .btn {
      flex: 1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1000px) {
      .main-content {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: 300px;
        border-left: none;
        border-top: 1px solid #1e3a5f;
      }
    }
    
    @media (max-width: 600px) {
      .game-stats {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .stat {
        margin-bottom: 5px;
      }
      
      header {
        flex-direction: column;
        gap: 10px;
      }
      
      .controls {
        padding: 5px;
      }
      
      .galaxycraft-btn {
        padding: 8px 12px;
        font-size: 14px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- WebXOS Header -->
  <header>
    <div class="logo">GALAXYCRAFT MMO</div>
    <div class="game-stats">
      <div class="stat">
        <i class="fas fa-shield-alt"></i>
        <span>Shield: 100%</span>
      </div>
      <div class="stat">
        <i class="fas fa-bolt"></i>
        <span>Energy: 87%</span>
      </div>
      <div class="stat">
        <i class="fas fa-rocket"></i>
        <span>Credits: 5,250</span>
      </div>
      <div class="stat">
        <i class="fas fa-users"></i>
        <span>Players: 12</span>
      </div>
    </div>
  </header>
  
  <div class="main-content">
    <div class="game-canvas-container">
      <div id="cosmicCanvas">
        <div class="hud"></div>
        <div id="statusOverlay" class="status-overlay"></div>
        <div id="throttleIndicator" class="throttle-indicator"></div>
        <div id="console" class="console">
          <div id="consoleLog" class="console-log"></div>
          <input id="consoleInput" class="console-input" type="text" placeholder="Type /help for commands..." autocomplete="off">
        </div>
      </div>
    </div>
    
    <!-- WebXOS Sidebar -->
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">WEAPONS SYSTEMS</div>
        <div class="weapon active">
          <div class="weapon-name">Phaser Cannons</div>
          <div class="weapon-stats">
            <span>Damage: 25</span>
            <span>Range: 350m</span>
          </div>
        </div>
        <div class="weapon">
          <div class="weapon-name">Quantum Torpedoes</div>
          <div class="weapon-stats">
            <span>Damage: 80</span>
            <span>Range: 600m</span>
          </div>
        </div>
        <div class="weapon">
          <div class="weapon-name">Ion Disruptors</div>
          <div class="weapon-stats">
            <span>Damage: 40</span>
            <span>Range: 450m</span>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">SHIP CONTROLS</div>
        <button class="btn" style="margin-bottom: 10px;">
          <i class="fas fa-compress-arrows-alt"></i> Engage Warp Drive
        </button>
        <button class="btn btn-primary" style="margin-bottom: 10px;">
          <i class="fas fa-sync"></i> Auto Repair
        </button>
        <button class="btn btn-danger">
          <i class="fas fa-radiation"></i> Emergency Cloak
        </button>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">FLEET COMMUNICATIONS</div>
        <div class="chat-container">
          <div class="chat-messages">
            <div class="message">[System] Connected to Galaxycraft MMO server</div>
            <div class="message">[NovaStar] Anyone for asteroid mining in sector 7?</div>
            <div class="message">[Phantom] Hostiles detected near jumpgate 3!</div>
            <div class="message">[GalacticCmd] New mission available: Rescue stranded freighter</div>
          </div>
          <div class="chat-input">
            <input type="text" placeholder="Type message...">
            <button><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Galaxycraft Controls -->
  <div class="controls">
    <div class="control-item">
      <button id="throttleBtn" class="galaxycraft-btn">Full Throttle</button>
    </div>
    <div class="control-item">
      <button id="addComet" class="galaxycraft-btn">Add Comet</button>
    </div>
    <div class="control-item">
      <button id="addSystem" class="galaxycraft-btn">Add System</button>
    </div>
    <div class="control-item">
      <button id="addGalaxy" class="galaxycraft-btn">Add Galaxy</button>
    </div>
    <div class="control-item">
      <button id="addNode" class="galaxycraft-btn">Add Node</button>
    </div>
    <div class="control-item">
      <button id="autopilotBtn" class="galaxycraft-btn">Autopilot</button>
    </div>
    <div class="control-item">
      <button id="shootBtn" class="galaxycraft-btn">Shoot</button>
    </div>
    <div class="control-item">
      <button id="resetBtn" class="galaxycraft-btn">Reset</button>
    </div>
  </div>
  
  <footer>
    &copy; 2025 WebXOS Technologies | Server: us-east-12 | Ping: 42ms
  </footer>
  
  <!-- Game Start Modal -->
  <div class="modal" id="startModal">
    <div class="modal-content">
      <div class="modal-title">GALAXYCRAFT MMO</div>
      <div class="modal-options">
        <div class="modal-option">
          <i class="fas fa-user"></i>
          <div>Single Player</div>
        </div>
        <div class="modal-option">
          <i class="fas fa-users"></i>
          <div>Multiplayer</div>
        </div>
        <div class="modal-option">
          <i class="fas fa-cog"></i>
          <div>Settings</div>
        </div>
        <div class="modal-option">
          <i class="fas fa-graduation-cap"></i>
          <div>Tutorial</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-success" id="startGameBtn">Start Game</button>
        <button class="btn btn-danger" id="exitGameBtn">Exit</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script>
    window.onload = () => {
      try {
        // Scene setup
        if (!window.THREE) throw new Error('Three.js not loaded');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: 'high-performance' });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x000000, 1);
        const canvas = document.getElementById('cosmicCanvas');
        if (!canvas) throw new Error('Canvas element not found');
        canvas.appendChild(renderer.domElement);

        camera.position.set(0, 0, 0);
        const frustum = new THREE.Frustum();
        const cameraMatrix = new THREE.Matrix4();

        // Shared resources
        const sharedMaterials = {
          glow: new THREE.MeshBasicMaterial({ color: 0xffffff }),
          star: new THREE.MeshBasicMaterial({ color: 0xffff99 }),
          planet: new THREE.MeshBasicMaterial({ color: 0x3399ff }),
          node: new THREE.MeshBasicMaterial({ color: 0xff33cc }),
          line: new THREE.LineBasicMaterial({ color: 0x00ff00 })
        };
        const sharedGeometries = {
          comet: new THREE.SphereGeometry(5, 8, 8),
          star: new THREE.SphereGeometry(100, 16, 16),
          planet: new THREE.SphereGeometry(20, 12, 12),
          galaxyStar: new THREE.SphereGeometry(10, 8, 8),
          projectile: new THREE.SphereGeometry(5, 8, 8),
          node: new THREE.BoxGeometry(10, 10, 10)
        };

        // Entities
        let comets = [];
        let systems = [];
        let galaxies = [];
        let projectiles = [];
        let nodes = [];
        let nodeLines = [];
        let cometInstances = null;
        let projectileInstances = null;
        let cometCount = 0;
        let projectileCount = 0;
        let throttle = 0;
        let rotation = { pitch: 0, yaw: 0 };
        let rotationVelocity = { pitch: 0, yaw: 0 };
        let velocity = new THREE.Vector3(0, 0, 0);
        let lastTime = performance.now();
        let entityCount = 0;
        let autopilotActive = false;
        let currentNodeIndex = 0;

        // Gravity parameters
        const G = 100; // Scaled gravitational constant
        const softening = 10; // Prevent singularities
        const maxGravityDistance = 2000; // Optimize by ignoring far objects

        // Console and status
        const statusOverlay = document.getElementById('statusOverlay');
        const consoleLog = document.getElementById('consoleLog');
        const consoleInput = document.getElementById('consoleInput');
        const maxLogMessages = 50;
        let logMessages = [];

        function addConsoleMessage(message) {
          const timestamp = new Date().toLocaleTimeString();
          logMessages.push(`[${timestamp}] ${message}`);
          if (logMessages.length > maxLogMessages) {
            logMessages.shift();
          }
          consoleLog.innerHTML = logMessages.map(msg => `<p>${msg}</p>`).join('');
          consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function updateStatusOverlay() {
          statusOverlay.textContent = `Entities: ${entityCount} | Throttle: ${throttle} | Autopilot: ${autopilotActive ? 'On' : 'Off'} | Nodes: ${nodes.length}`;
        }

        // Keyboard controls
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
        window.addEventListener('keydown', e => {
          if (e.key in keys) {
            keys[e.key] = true;
            e.preventDefault();
          }
        });
        window.addEventListener('keyup', e => {
          if (e.key in keys) keys[e.key] = false;
        });

        // Console commands
        function handleCommand(input) {
          const cmd = input.trim().toLowerCase();
          if (!cmd.startsWith('/')) {
            addConsoleMessage('Commands must start with "/". Type /help for commands.');
            return;
          }
          const parts = cmd.slice(1).split(' ');
          const command = parts[0];
          const args = parts.slice(1);

          switch (command) {
            case 'help':
              addConsoleMessage('Commands: /add comet, /add system, /add galaxy, /add node, /shoot, /reset, /throttle, /autopilot');
              break;
            case 'add':
              if (args[0] === 'comet') {
                addComet();
              } else if (args[0] === 'system') {
                addPlanetarySystem();
              } else if (args[0] === 'galaxy') {
                addGalaxy();
              } else if (args[0] === 'node') {
                addNode();
              } else {
                addConsoleMessage('Invalid add command. Use: comet, system, galaxy, node');
              }
              break;
            case 'shoot':
              shoot();
              break;
            case 'reset':
              reset();
              break;
            case 'throttle':
              if (autopilotActive) {
                addConsoleMessage('Cannot toggle throttle during autopilot.');
              } else {
                toggleThrottle();
              }
              break;
            case 'autopilot':
              toggleAutopilot();
              break;
            default:
              addConsoleMessage('Unknown command. Type /help for commands.');
          }
        }

        consoleInput.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            const input = consoleInput.value;
            if (input) {
              addConsoleMessage(`> ${input}`);
              handleCommand(input);
              consoleInput.value = '';
            }
          }
        });

        // Object pools
        const cometPool = [];
        const projectilePool = [];
        const nodePool = [];
        function getCometFromPool() {
          if (cometPool.length > 0) {
            const comet = cometPool.pop();
            comet.visible = true;
            return comet;
          }
          return new THREE.Mesh(sharedGeometries.comet, sharedMaterials.glow);
        }
        function getProjectileFromPool() {
          if (projectilePool.length > 0) {
            const projectile = projectilePool.pop();
            projectile.visible = true;
            return projectile;
          }
          return new THREE.Mesh(sharedGeometries.projectile, sharedMaterials.glow);
        }
        function getNodeFromPool() {
          if (nodePool.length > 0) {
            const node = nodePool.pop();
            node.visible = true;
            return node;
          }
          return new THREE.Mesh(sharedGeometries.node, sharedMaterials.node);
        }

        // Simulated data
        const trainingData = {
          comets: Array(100).fill().map(() => ({
            semiMajorAxis: Math.random() * 50 + 20,
            eccentricity: Math.random() * 0.8,
            velocity: Math.random() * 3 + 1
          })),
          systems: Array(50).fill().map(() => ({
            planets: Math.floor(Math.random() * 3) + 1,
            orbitalRadius: Math.random() * 100 + 50
          })),
          galaxies: Array(20).fill().map(() => ({
            radius: Math.random() * 300 + 150,
            type: ['spiral', 'elliptical'][Math.floor(Math.random() * 2)]
          }))
        };

        // Add entities
        function addComet() {
          const params = trainingData.comets[Math.floor(Math.random() * trainingData.comets.length)];
          const comet = getCometFromPool();
          const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
          const offset = new THREE.Vector3(
            (Math.random() - 0.5) * 50,
            (Math.random() - 0.5) * 50,
            (Math.random() - 0.5) * 50
          );
          comet.position.copy(camera.position).add(forward.multiplyScalar(500)).add(offset);
          comet.userData = {
            type: 'comet',
            mass: 1,
            velocity: new THREE.Vector3((Math.random() - 0.5) * 5, (Math.random() - 0.5) * 5, (Math.random() - 0.5) * 5),
            created: Date.now(),
            instanceId: cometCount
          };
          scene.add(comet);
          comets.push(comet);
          cometCount++;
          entityCount++;
          updateCometInstances();
          if (entityCount > 500) showPrompt(8);
          showPrompt(1);
          addConsoleMessage('Comet added to your galaxy.');
          updateStatusOverlay();
        }

        function updateCometInstances() {
          if (cometInstances) scene.remove(cometInstances);
          cometInstances = new THREE.InstancedMesh(sharedGeometries.comet, sharedMaterials.glow, cometCount);
          const matrix = new THREE.Matrix4();
          comets.forEach((comet, i) => {
            matrix.setPosition(comet.position);
            cometInstances.setMatrixAt(i, matrix);
          });
          scene.add(cometInstances);
        }

        function addPlanetarySystem() {
          const params = trainingData.systems[Math.floor(Math.random() * trainingData.systems.length)];
          const systemGroup = new THREE.Group();
          const star = new THREE.Mesh(sharedGeometries.star, sharedMaterials.star);
          star.userData = { type: 'star', mass: 1000, velocity: new THREE.Vector3(0, 0, 0) };
          systemGroup.add(star);
          for (let i = 0; i < params.planets; i++) {
            const planet = new THREE.Mesh(sharedGeometries.planet, sharedMaterials.planet);
            const orbitalRadius = (i + 1) * params.orbitalRadius / params.planets;
            planet.position.set(orbitalRadius, 0, 0);
            // Set initial tangential velocity for stable orbit
            const v = Math.sqrt(G * star.userData.mass / orbitalRadius);
            planet.userData = {
              type: 'planet',
              mass: 10,
              velocity: new THREE.Vector3(0, 0, v),
              orbitalRadius
            };
            systemGroup.add(planet);
          }
          const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
          const offset = new THREE.Vector3(
            (Math.random() - 0.5) * 100,
            (Math.random() - 0.5) * 100,
            (Math.random() - 0.5) * 100
          );
          systemGroup.position.copy(camera.position).add(forward.multiplyScalar(1000)).add(offset);
          systemGroup.userData = { created: Date.now() };
          scene.add(systemGroup);
          systems.push(systemGroup);
          entityCount += 1 + params.planets;
          if (entityCount > 500) showPrompt(8);
          showPrompt(2);
          addConsoleMessage('Planetary system created ahead.');
          updateStatusOverlay();
        }

        function addGalaxy() {
          const params = trainingData.galaxies[Math.floor(Math.random() * trainingData.galaxies.length)];
          const galaxyGroup = new THREE.Group();
          const starCount = params.type === 'spiral' ? 10 : 5;
          for (let i = 0; i < starCount; i++) {
            const star = new THREE.Mesh(sharedGeometries.galaxyStar, sharedMaterials.glow);
            const r = Math.random() * params.radius;
            const theta = Math.random() * Math.PI * 2;
            const phi = params.type === 'spiral' ? Math.random() * 0.2 : Math.random() * Math.PI;
            star.position.set(
              r * Math.sin(phi) * Math.cos(theta),
              r * Math.sin(phi) * Math.sin(theta),
              r * Math.cos(phi)
            );
            // Set initial circular velocity
            const v = Math.sqrt(G * 50 / r); // Assume central mass equivalent
            const pos = star.position.clone();
            const tangent = new THREE.Vector3(-pos.y, pos.x, 0).normalize();
            star.userData = {
              type: 'star',
              mass: 50,
              velocity: tangent.multiplyScalar(v),
              angle: theta
            };
            galaxyGroup.add(star);
          }
          const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
          const offset = new THREE.Vector3(
            (Math.random() - 0.5) * 200,
            (Math.random() - 0.5) * 200,
            (Math.random() - 0.5) * 200
          );
          galaxyGroup.position.copy(camera.position).add(forward.multiplyScalar(2000)).add(offset);
          galaxyGroup.userData = { radius: params.radius, created: Date.now() };
          scene.add(galaxyGroup);
          galaxies.push(galaxyGroup);
          entityCount += starCount;
          if (entityCount > 500) showPrompt(8);
          showPrompt(3);
          addConsoleMessage('Galaxy spawned with stars.');
          updateStatusOverlay();
        }

        function addNode() {
          const node = getNodeFromPool();
          const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
          const offset = new THREE.Vector3(
            (Math.random() - 0.5) * 100,
            (Math.random() - 0.5) * 100,
            (Math.random() - 0.5) * 100
          );
          node.position.copy(camera.position).add(forward.multiplyScalar(300)).add(offset);
          node.userData = { type: 'node', created: Date.now() };
          scene.add(node);
          nodes.push(node);
          entityCount++;

          if (nodes.length > 1) {
            const prevNode = nodes[nodes.length - 2];
            const geometry = new THREE.BufferGeometry().setFromPoints([
              prevNode.position,
              node.position
            ]);
            const line = new THREE.Line(geometry, sharedMaterials.line);
            scene.add(line);
            nodeLines.push(line);
          }

          if (entityCount > 500) showPrompt(8);
          showPrompt(4);
          addConsoleMessage('Satellite node deployed.');
          updateStatusOverlay();
        }

        function shoot() {
          const projectile = getProjectileFromPool();
          const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
          projectile.position.copy(camera.position).add(forward.multiplyScalar(10));
          projectile.userData = {
            type: 'projectile',
            velocity: forward.multiplyScalar(20),
            remove: false,
            instanceId: projectileCount
          };
          scene.add(projectile);
          projectiles.push(projectile);
          projectileCount++;
          updateProjectileInstances();
          showPrompt(5);
          addConsoleMessage('Projectile fired!');
          updateStatusOverlay();
        }

        function updateProjectileInstances() {
          if (projectileInstances) scene.remove(projectileInstances);
          projectileInstances = new THREE.InstancedMesh(sharedGeometries.projectile, sharedMaterials.glow, projectileCount);
          const matrix = new THREE.Matrix4();
          projectiles.forEach((projectile, i) => {
            matrix.setPosition(projectile.position);
            projectileInstances.setMatrixAt(i, matrix);
          });
          scene.add(projectileInstances);
        }

        function reset() {
          comets.forEach(comet => {
            comet.visible = false;
            cometPool.push(comet);
            scene.remove(comet);
          });
          comets = [];
          systems.forEach(system => scene.remove(system));
          systems = [];
          galaxies.forEach(galaxy => scene.remove(galaxy));
          galaxies = [];
          projectiles.forEach(projectile => {
            projectile.visible = false;
            projectilePool.push(projectile);
            scene.remove(projectile);
          });
          projectiles = [];
          nodes.forEach(node => {
            node.visible = false;
            nodePool.push(node);
            scene.remove(node);
          });
          nodes = [];
          nodeLines.forEach(line => scene.remove(line));
          nodeLines = [];
          entityCount = 0;
          cometCount = 0;
          projectileCount = 0;
          if (cometInstances) scene.remove(cometInstances);
          if (projectileInstances) scene.remove(projectileInstances);
          cometInstances = null;
          projectileInstances = null;
          showPrompt(6);
          addConsoleMessage('All entities removed.');
          updateStatusOverlay();
        }

        function toggleThrottle() {
          throttle = throttle === 0 ? 10 : 0;
          document.getElementById('throttleBtn').textContent = throttle === 0 ? 'Full Throttle' : 'Stop';
          document.getElementById('throttleBtn').classList.toggle('active', throttle !== 0);
          const indicator = document.getElementById('throttleIndicator');
          indicator.textContent = `Throttle: ${throttle}`;
          indicator.classList.toggle('active', throttle !== 0);
          showPrompt(7);
          addConsoleMessage(`Throttle ${throttle === 0 ? 'stopped' : 'engaged'}.`);
        }

        function toggleAutopilot() {
          autopilotActive = !autopilotActive;
          document.getElementById('autopilotBtn').classList.toggle('active', autopilotActive);
          if (autopilotActive && nodes.length > 0) {
            currentNodeIndex = 0;
            addConsoleMessage('Autopilot engaged. Navigating to next node.');
          } else {
            addConsoleMessage('Autopilot disengaged.');
          }
        }

        // UI prompts
        const prompts = [
          'Comet added',
          'Planetary system created',
          'Galaxy spawned',
          'Satellite node deployed',
          'Projectile fired',
          'All entities removed',
          'Throttle toggled',
          'Warning: High entity count may affect performance'
        ];
        function showPrompt(index) {
          const prompt = document.createElement('div');
          prompt.className = 'prompt active';
          prompt.textContent = prompts[index];
          document.getElementById('cosmicCanvas').appendChild(prompt);
          setTimeout(() => {
            prompt.classList.remove('active');
            setTimeout(() => prompt.remove(), 500);
          }, 2000);
        }

        // Button event listeners
        document.getElementById('throttleBtn').addEventListener('click', toggleThrottle);
        document.getElementById('addComet').addEventListener('click', addComet);
        document.getElementById('addSystem').addEventListener('click', addPlanetarySystem);
        document.getElementById('addGalaxy').addEventListener('click', addGalaxy);
        document.getElementById('addNode').addEventListener('click', addNode);
        document.getElementById('shootBtn').addEventListener('click', shoot);
        document.getElementById('resetBtn').addEventListener('click', reset);
        document.getElementById('autopilotBtn').addEventListener('click', toggleAutopilot);
        document.getElementById('startGameBtn').addEventListener('click', () => {
          document.getElementById('startModal').style.display = 'none';
          addConsoleMessage('Welcome to Galaxycraft MMO. Type /help for commands.');
        });
        document.getElementById('exitGameBtn').addEventListener('click', () => {
          alert('Thanks for playing Galaxycraft!');
        });

        // Physics update
        function updatePhysics(deltaTime) {
          // Update camera rotation based on keys
          if (keys.ArrowUp) rotationVelocity.pitch += 0.5 * deltaTime;
          if (keys.ArrowDown) rotationVelocity.pitch -= 0.5 * deltaTime;
          if (keys.ArrowLeft) rotationVelocity.yaw += 0.5 * deltaTime;
          if (keys.ArrowRight) rotationVelocity.yaw -= 0.5 * deltaTime;
          
          // Apply damping to rotation
          rotationVelocity.pitch *= 0.95;
          rotationVelocity.yaw *= 0.95;
          
          // Update rotation
          rotation.pitch += rotationVelocity.pitch;
          rotation.yaw += rotationVelocity.yaw;
          
          // Apply rotation to camera
          camera.rotation.set(rotation.pitch, rotation.yaw, 0, 'YXZ');
          
          // Update velocity based on throttle
          const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
          velocity.add(forward.multiplyScalar(throttle * deltaTime));
          
          // Apply damping to velocity
          velocity.multiplyScalar(0.99);
          
          // Update camera position
          camera.position.add(velocity.clone().multiplyScalar(deltaTime));
          
          // Autopilot navigation
          if (autopilotActive && nodes.length > 0) {
            const targetNode = nodes[currentNodeIndex];
            const direction = new THREE.Vector3().subVectors(targetNode.position, camera.position);
            const distance = direction.length();
            
            if (distance < 50) {
              // Move to next node
              currentNodeIndex = (currentNodeIndex + 1) % nodes.length;
              addConsoleMessage(`Navigating to node ${currentNodeIndex + 1}/${nodes.length}`);
            } else {
              // Move toward current node
              direction.normalize();
              const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
              const dot = forward.dot(direction);
              
              // Adjust rotation to face the node
              if (dot < 0.99) {
                const cross = new THREE.Vector3().crossVectors(forward, direction);
                rotationVelocity.pitch += cross.y * 0.5 * deltaTime;
                rotationVelocity.yaw += -cross.x * 0.5 * deltaTime;
              }
              
              // Adjust throttle based on distance
              throttle = Math.min(10, distance / 10);
            }
          }
          
          // Update comets with simple physics
          comets.forEach(comet => {
            comet.position.add(comet.userData.velocity.clone().multiplyScalar(deltaTime));
          });
          
          // Update projectiles
          projectiles.forEach(projectile => {
            projectile.position.add(projectile.userData.velocity.clone().multiplyScalar(deltaTime));
            
            // Check if projectile should be removed
            if (projectile.position.distanceTo(camera.position) > 2000) {
              projectile.userData.remove = true;
            }
          });
          
          // Remove projectiles marked for removal
          for (let i = projectiles.length - 1; i >= 0; i--) {
            if (projectiles[i].userData.remove) {
              const projectile = projectiles.splice(i, 1)[0];
              projectile.visible = false;
              projectilePool.push(projectile);
              scene.remove(projectile);
              projectileCount--;
            }
          }
          
          // Update systems (planetary orbits)
          systems.forEach(system => {
            system.children.forEach((body, i) => {
              if (i === 0) return; // Skip the star
              const star = system.children[0];
              const dir = new THREE.Vector3().subVectors(star.position, body.position);
              const dist = dir.length();
              if (dist > 0) {
                const force = G * star.userData.mass * body.userData.mass / (dist * dist + softening);
                dir.normalize().multiplyScalar(force * deltaTime);
                body.userData.velocity.add(dir);
              }
              body.position.add(body.userData.velocity.clone().multiplyScalar(deltaTime));
            });
          });
          
          // Update galaxies
          galaxies.forEach(galaxy => {
            galaxy.children.forEach(star => {
              const center = new THREE.Vector3();
              const dir = new THREE.Vector3().subVectors(center, star.position);
              const dist = dir.length();
              if (dist > 0) {
                const force = G * 1000 / (dist * dist + softening); // Central mass
                dir.normalize().multiplyScalar(force * deltaTime);
                star.userData.velocity.add(dir);
              }
              star.position.add(star.userData.velocity.clone().multiplyScalar(deltaTime));
            });
          });
          
          // Cull distant entities to maintain performance
          cullDistantEntities();
        }
        
        function cullDistantEntities() {
          const maxDistance = 3000;
          
          // Cull comets
          for (let i = comets.length - 1; i >= 0; i--) {
            if (comets[i].position.distanceTo(camera.position) > maxDistance) {
              const comet = comets.splice(i, 1)[0];
              comet.visible = false;
              cometPool.push(comet);
              scene.remove(comet);
              cometCount--;
              entityCount--;
            }
          }
          
          // Cull systems
          for (let i = systems.length - 1; i >= 0; i--) {
            if (systems[i].position.distanceTo(camera.position) > maxDistance) {
              const system = systems.splice(i, 1)[0];
              scene.remove(system);
              entityCount -= system.children.length;
            }
          }
          
          // Cull galaxies
          for (let i = galaxies.length - 1; i >= 0; i--) {
            if (galaxies[i].position.distanceTo(camera.position) > maxDistance) {
              const galaxy = galaxies.splice(i, 1)[0];
              scene.remove(galaxy);
              entityCount -= galaxy.children.length;
            }
          }
          
          updateStatusOverlay();
        }

        // Animation loop
        function animate() {
          requestAnimationFrame(animate);
          const currentTime = performance.now();
          const deltaTime = (currentTime - lastTime) / 1000;
          lastTime = currentTime;
          
          updatePhysics(deltaTime);
          renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Start animation
        animate();
        addConsoleMessage('Galaxycraft MMO initialized. Ready for commands.');
        updateStatusOverlay();
        
      } catch (error) {
        console.error('Error initializing Galaxycraft:', error);
        alert('Failed to initialize Galaxycraft: ' + error.message);
      }
    };
  </script>
</body>
</html>