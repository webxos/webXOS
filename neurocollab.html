<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEUROCOLLAB v1.1 - Collaborative Multi-Agent Sandbox</title>
    <style>
        /* ============================================
           NEUROCOLLAB DESIGN SYSTEM
        ============================================ */
        :root {
            --white: #ffffff;
            --off-white: #f8f8f8;
            --light-gray: #e0e0e0;
            --gray: #a0a0a0;
            --dark-gray: #666666;
            --black: #000000;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.2);
        }
        
        .dark-mode {
            --white: #0a0a0a;
            --off-white: #1a1a1a;
            --light-gray: #2a2a2a;
            --gray: #555555;
            --dark-gray: #999999;
            --black: #f0f0f0;
            --shadow: rgba(255, 255, 255, 0.05);
            --shadow-dark: rgba(255, 255, 255, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "SF Mono", "Monaco", "Menlo", "Consolas", monospace;
        }
        
        body {
            background: var(--white);
            color: var(--black);
            min-height: 100vh;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }
        
        body.fullscreen {
            overflow: auto;
        }
        
        .fullscreen .neuro-desktop {
            overflow: auto;
        }
        
        /* ============================================
           NEURO MENU BAR - FIXED
        ============================================ */
        .neuro-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: var(--white);
            border-bottom: 2px solid var(--black);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 10000;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s;
        }
        
        .menu-group {
            display: flex;
            height: 100%;
            position: relative;
        }
        
        .menu-item {
            height: 100%;
            padding: 0 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
            border-right: 1px solid var(--light-gray);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            white-space: nowrap;
            background: var(--white);
            color: var(--black) !important;
            transition: all 0.15s ease;
        }
        
        .menu-item:hover {
            background: var(--black);
            color: var(--white) !important;
        }
        
        /* DROPDOWN - INVERTED TEXT */
        .neuro-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--white);
            border: 2px solid var(--black);
            border-top: none;
            min-width: 200px;
            display: none;
            z-index: 10001;
            box-shadow: 4px 4px 0 var(--shadow-dark);
            transition: all 0.3s;
        }
        
        .menu-item:hover .neuro-dropdown {
            display: block;
            animation: neuroFade 0.2s ease;
        }
        
        @keyframes neuroFade {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dropdown-item {
            padding: 10px 16px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            background: var(--white);
            color: var(--black) !important;
            transition: all 0.15s ease;
        }
        
        .dropdown-item:hover {
            background: var(--black) !important;
            color: var(--white) !important;
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--black);
            margin: 4px 0;
        }
        
        .neuro-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 10px;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        .status-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
            position: relative;
        }
        
        .status-pulse::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--gray);
            animation: pulse 2s infinite;
        }
        
        .status-pulse.active {
            background: #0000ff;
        }
        
        .status-pulse.active::after {
            background: #0000ff;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.5); opacity: 0.4; }
        }
        
        /* ============================================
           NEURO DESKTOP
        ============================================ */
        .neuro-desktop {
            position: absolute;
            top: 32px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--off-white);
            overflow: hidden;
            transition: background 0.3s;
        }
        
        /* ============================================
           NEURO WINDOW SYSTEM
        ============================================ */
        .neuro-window {
            position: absolute;
            background: var(--white);
            border: 2px solid var(--black);
            box-shadow: 8px 8px 0 var(--shadow-dark);
            min-width: 250px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .neuro-window.active {
            z-index: 2000;
            box-shadow: 12px 12px 0 var(--shadow-dark);
            animation: windowPulse 2s infinite;
        }
        
        @keyframes windowPulse {
            0%, 100% { box-shadow: 12px 12px 0 var(--shadow-dark); }
            50% { box-shadow: 12px 12px 0 rgba(0, 0, 0, 0.3); }
        }
        
        .window-header {
            background: var(--white);
            border-bottom: 2px solid var(--black);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            cursor: move;
            user-select: none;
            height: 36px;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .window-title {
            flex: 1;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
            color: var(--black);
        }
        
        .window-controls {
            display: flex;
            gap: 4px;
        }
        
        .window-btn {
            width: 16px;
            height: 16px;
            border: 1px solid var(--black);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.1s;
        }
        
        .window-btn:hover {
            background: var(--black);
            color: var(--white);
        }
        
        .window-content {
            flex: 1;
            overflow: auto;
            padding: 12px;
            position: relative;
            background: var(--white);
            transition: background 0.3s;
        }
        
        /* Special content areas with colors preserved */
        .canvas-content {
            background: #ffffff !important;
        }
        
        .studio-content {
            background: #ffffff !important;
        }
        
        .dark-mode .canvas-content {
            background: #0a0a0a !important;
        }
        
        .dark-mode .studio-content {
            background: #0a0a0a !important;
        }
        
        /* ============================================
           WINDOW RESIZE HANDLES
        ============================================ */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 10;
        }
        
        .resize-n { top: 0; left: 5px; right: 5px; height: 5px; cursor: ns-resize; }
        .resize-s { bottom: 0; left: 5px; right: 5px; height: 5px; cursor: ns-resize; }
        .resize-e { top: 5px; right: 0; bottom: 5px; width: 5px; cursor: ew-resize; }
        .resize-w { top: 5px; left: 0; bottom: 5px; width: 5px; cursor: ew-resize; }
        .resize-ne { top: 0; right: 0; width: 15px; height: 15px; cursor: ne-resize; }
        .resize-nw { top: 0; left: 0; width: 15px; height: 15px; cursor: nw-resize; }
        .resize-se { bottom: 0; right: 0; width: 15px; height: 15px; cursor: se-resize; }
        .resize-sw { bottom: 0; left: 0; width: 15px; height: 15px; cursor: sw-resize; }
        
        /* ============================================
           CLI WINDOW
        ============================================ */
        .cli-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .cli-messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--light-gray);
            padding: 12px;
            margin-bottom: 12px;
            background: var(--off-white);
            font-size: 11px;
            line-height: 1.5;
        }
        
        .cli-message {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid var(--black);
            background: var(--white);
            animation: messageIn 0.3s ease;
            transition: all 0.3s;
        }
        
        @keyframes messageIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 9px;
        }
        
        .message-agent {
            font-weight: 600;
            color: var(--black);
        }
        
        .message-time {
            color: var(--dark-gray);
        }
        
        .message-content {
            font-size: 11px;
            line-height: 1.4;
            margin-bottom: 6px;
        }
        
        .message-votes {
            display: flex;
            gap: 8px;
            font-size: 9px;
        }
        
        .vote-btn {
            padding: 2px 6px;
            border: 1px solid var(--light-gray);
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vote-btn:hover {
            background: var(--black);
            color: var(--white);
        }
        
        .vote-btn.upvoted {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .vote-btn.downvoted {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }
        
        .cli-input-row {
            display: flex;
            gap: 8px;
        }
        
        .cli-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--black);
            background: var(--white);
            font-family: inherit;
            font-size: 11px;
            color: var(--black);
            transition: all 0.3s;
        }
        
        .cli-input:focus {
            outline: none;
            border-color: var(--black);
        }
        
        /* ============================================
           CONTROL PANEL
        ============================================ */
        .control-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .control-title {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--black);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .control-item {
            margin-bottom: 12px;
        }
        
        .control-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            margin-bottom: 6px;
            color: var(--dark-gray);
        }
        
        .control-value {
            font-weight: 600;
            color: var(--black);
        }
        
        .control-slider {
            width: 100%;
            height: 2px;
            -webkit-appearance: none;
            background: var(--light-gray);
            outline: none;
        }
        
        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--black);
            border: 2px solid var(--white);
            cursor: pointer;
            box-shadow: 0 1px 3px var(--shadow);
        }
        
        /* ============================================
           AGENT CARDS
        ============================================ */
        .agent-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        
        .agent-card {
            border: 1px solid var(--light-gray);
            padding: 12px;
            background: var(--off-white);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow);
        }
        
        .agent-card.active {
            border-color: var(--black);
            background: var(--white);
        }
        
        .agent-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .agent-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray);
        }
        
        .agent-indicator.active {
            background: #0000ff;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .agent-name {
            font-size: 10px;
            font-weight: 600;
        }
        
        .agent-stats {
            font-size: 9px;
            color: var(--dark-gray);
            line-height: 1.4;
        }
        
        /* ============================================
           INBOX WINDOW
        ============================================ */
        .inbox-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .inbox-items {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--light-gray);
            background: var(--off-white);
            font-size: 11px;
        }
        
        .inbox-item {
            padding: 12px;
            border-bottom: 1px solid var(--light-gray);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .inbox-item:hover {
            background: var(--white);
        }
        
        .inbox-item.new {
            background: rgba(255, 255, 0, 0.1);
        }
        
        .inbox-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 9px;
        }
        
        .inbox-type {
            font-weight: 600;
            color: var(--black);
        }
        
        .inbox-time {
            color: var(--dark-gray);
        }
        
        .inbox-preview {
            font-size: 11px;
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .inbox-agent {
            font-size: 9px;
            color: var(--dark-gray);
        }
        
        /* ============================================
           CANVAS WINDOWS (COLOR PRESERVED)
        ============================================ */
        .canvas-container {
            height: 100%;
            border: 1px solid var(--light-gray);
            background: #ffffff !important;
            position: relative;
            overflow: hidden;
        }
        
        .studio-container {
            height: 100%;
            border: 1px solid var(--light-gray);
            background: #ffffff !important;
            position: relative;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            background: #ffffff !important;
            width: 100%;
            height: 100%;
        }
        
        .dark-mode canvas {
            background: #0a0a0a !important;
        }
        
        /* ============================================
           NEURO BUTTONS
        ============================================ */
        .neuro-btn {
            padding: 8px 16px;
            border: 1px solid var(--black);
            background: var(--white);
            color: var(--black);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .neuro-btn:hover {
            background: var(--black);
            color: var(--white);
            transform: translateY(-1px);
        }
        
        .neuro-btn:active {
            transform: translateY(0);
        }
        
        .neuro-btn.primary {
            background: var(--black);
            color: var(--white);
        }
        
        .neuro-btn.primary:hover {
            background: var(--white);
            color: var(--black);
        }
        
        /* ============================================
           TOOLBAR
        ============================================ */
        .neuro-toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        /* ============================================
           NOTEPAD
        ============================================ */
        .neuro-notepad {
            width: 100%;
            height: 280px;
            border: 1px solid var(--light-gray);
            padding: 12px;
            font-size: 11px;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            background: var(--off-white);
            color: var(--black);
            transition: all 0.3s;
        }
        
        /* ============================================
           SCROLLBAR
        ============================================ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light-gray);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border: 1px solid var(--light-gray);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-gray);
        }
        
        /* ============================================
           WINDOW STATES
        ============================================ */
        .neuro-window.maximized {
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
            position: absolute;
            z-index: 3000;
        }
        
        .neuro-window.minimized {
            height: 36px !important;
            min-height: 36px !important;
        }
        
        .neuro-window.minimized .window-content {
            display: none;
        }
        
        .neuro-window.hidden {
            display: none !important;
        }
        
        /* ============================================
           TRAINING STATUS
        ============================================ */
        .training-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: var(--white);
            border: 2px solid var(--black);
            padding: 8px 12px;
            font-size: 10px;
            z-index: 9999;
            box-shadow: 4px 4px 0 var(--shadow-dark);
            display: none;
        }
        
        .training-status.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .training-progress {
            height: 4px;
            background: var(--light-gray);
            margin-top: 4px;
            overflow: hidden;
        }
        
        .training-bar {
            height: 100%;
            background: var(--black);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ============================================
           EXPORT OVERLAY
        ============================================ */
        .export-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100000;
        }
        
        .export-overlay.active {
            display: flex;
        }
        
        .export-modal {
            background: var(--white);
            border: 4px solid var(--black);
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 12px 12px 0 rgba(0, 0, 0, 0.3);
        }
        
        .export-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .export-option {
            padding: 15px;
            border: 2px solid var(--black);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .export-option:hover {
            background: var(--black);
            color: var(--white);
        }
        
        .export-option-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .export-option-desc {
            font-size: 10px;
            color: var(--dark-gray);
        }
        
        /* ============================================
           FULLSCREEN MODE
        ============================================ */
        body:fullscreen .neuro-desktop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
        }
        
        body:fullscreen .neuro-menu {
            z-index: 10001;
        }
        
        body:-webkit-full-screen .neuro-desktop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
        }
        
        body:-webkit-full-screen .neuro-menu {
            z-index: 10001;
        }
        
        /* ============================================
           MODERN DARK MODE
        ============================================ */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--white);
            border: 2px solid var(--black);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 4px 12px var(--shadow-dark);
            transition: all 0.3s;
        }
        
        .dark-mode-toggle:hover {
            transform: scale(1.1);
        }
        
        .dark-mode-toggle .icon {
            font-size: 20px;
            color: var(--black);
        }
    </style>
</head>
<body>
    <!-- Neuro Menu -->
    <div class="neuro-menu">
        <div class="menu-group">
            <div class="menu-item">
                NEURO
                <div class="neuro-dropdown">
                    <div class="dropdown-item" onclick="NeuroSystem.newSession()">New Session</div>
                    <div class="dropdown-item" onclick="NeuroSystem.saveSession()">Save Session</div>
                    <div class="dropdown-item" onclick="NeuroSystem.loadSession()">Load Session</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="NeuroSystem.showExport()">Export Brain</div>
                    <div class="dropdown-item" onclick="NeuroSystem.reset()">Reset System</div>
                </div>
            </div>
            
            <div class="menu-item">
                AGENTS
                <div class="neuro-dropdown">
                    <div class="dropdown-item" onclick="Agents.startCollaboration()">Start Collaboration</div>
                    <div class="dropdown-item" onclick="Agents.stopCollaboration()">Stop Collaboration</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="Agents.trainModels()">Train Models</div>
                    <div class="dropdown-item" onclick="Agents.evolve()">Evolve Agents</div>
                    <div class="dropdown-item" onclick="Agents.crossover()">Crossover Learning</div>
                </div>
            </div>
            
            <div class="menu-item">
                WINDOWS
                <div class="neuro-dropdown">
                    <div class="dropdown-item" onclick="WindowManager.openWindow('cliWindow')">Open CLI</div>
                    <div class="dropdown-item" onclick="WindowManager.openWindow('controlWindow')">Open Control</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="WindowManager.openWindow('paintWindow')">Open Paint</div>
                    <div class="dropdown-item" onclick="WindowManager.openWindow('notepadWindow')">Open Notepad</div>
                    <div class="dropdown-item" onclick="WindowManager.openWindow('studioWindow')">Open 3D Studio</div>
                    <div class="dropdown-item" onclick="WindowManager.openWindow('inboxWindow')">Open Inbox</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="WindowManager.toggleFullscreen()">Toggle Fullscreen</div>
                    <div class="dropdown-item" onclick="NeuroSystem.toggleDarkMode()">Toggle Dark Mode</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="WindowManager.arrange('grid')">Arrange Grid</div>
                    <div class="dropdown-item" onclick="WindowManager.arrange('center')">Center Layout</div>
                </div>
            </div>
            
            <div class="menu-item">
                INBOX
                <div class="neuro-dropdown">
                    <div class="dropdown-item" onclick="Inbox.exportInbox()">Export Inbox Only</div>
                    <div class="dropdown-item" onclick="Inbox.clear()">Clear Inbox</div>
                    <div class="dropdown-item" onclick="Inbox.generateReport()">Generate Report</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="Inbox.showUnread()">Show Unread</div>
                    <div class="dropdown-item" onclick="Inbox.markAllRead()">Mark All Read</div>
                </div>
            </div>
            
            <div class="menu-item">
                TRAIN
                <div class="neuro-dropdown">
                    <div class="dropdown-item" onclick="TensorFlow.simulateTraining()">Start Training</div>
                    <div class="dropdown-item" onclick="TensorFlow.stopTraining()">Stop Training</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="TensorFlow.optimizeModels()">Optimize Models</div>
                    <div class="dropdown-item" onclick="TensorFlow.exportModels()">Export Models</div>
                    <div class="dropdown-item" onclick="TensorFlow.mergeAgents()">Merge All Agents</div>
                </div>
            </div>
        </div>
        
        <div class="neuro-status">
            <div class="status-item">
                <span class="status-pulse active"></span>
                <span>AGENTS: 4</span>
            </div>
            <div class="status-item">
                <span class="status-pulse active"></span>
                <span>IDEAS: <span id="ideaCount">0</span></span>
            </div>
            <div id="clock" class="status-item">00:00:00</div>
            <div class="status-item">NEUROCOLLAB v1.1</div>
        </div>
    </div>
    
    <!-- Dark Mode Toggle -->
    <div class="dark-mode-toggle" onclick="NeuroSystem.toggleDarkMode()">
        <div class="icon">‚òÄ</div>
    </div>
    
    <!-- Desktop -->
    <div class="neuro-desktop" id="desktop">
        <!-- CLI Window (Centered Left - Smaller) -->
        <div class="neuro-window active" id="cliWindow" data-original-width="500" data-original-height="400" style="width: 500px; height: 400px; top: calc(50% - 200px); left: 40px;">
            <div class="window-header" data-window="cliWindow">
                <div class="window-title">NEURO CLI - Agent Collaboration</div>
                <div class="window-controls">
                    <div class="window-btn" onclick="WindowManager.minimizeWindow('cliWindow')">_</div>
                    <div class="window-btn" onclick="WindowManager.maximizeWindow('cliWindow')">‚ñ°</div>
                    <div class="window-btn" onclick="WindowManager.closeWindow('cliWindow')">√ó</div>
                </div>
            </div>
            <div class="window-content">
                <div class="cli-container">
                    <div class="cli-messages" id="cliMessages">
                        <div class="cli-message">
                            <div class="message-header">
                                <span class="message-agent">NEUROCOLLAB</span>
                                <span class="message-time" id="currentTime">00:00:00</span>
                            </div>
                            <div class="message-content">
                                NEUROCOLLAB v1.1 initialized. 4 neural agents ready for collaboration.
                                Agents will discuss, vote, and create together.
                            </div>
                            <div class="message-votes">
                                <span class="vote-btn" onclick="this.classList.toggle('upvoted')">üëç <span>0</span></span>
                                <span class="vote-btn" onclick="this.classList.toggle('downvoted')">üëé <span>0</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="cli-input-row">
                        <input type="text" class="cli-input" id="cliInput" 
                               placeholder="Type command or idea..." 
                               onkeypress="if(event.key==='Enter') CLI.send()">
                        <button class="neuro-btn primary" onclick="CLI.send()">SEND</button>
                        <button class="neuro-btn" onclick="CLI.clear()">CLEAR</button>
                    </div>
                    <div class="neuro-toolbar">
                        <button class="neuro-btn" onclick="Agents.startCollaboration()">‚ñ∂ START</button>
                        <button class="neuro-btn" onclick="Agents.stopCollaboration()">‚è∏ STOP</button>
                        <button class="neuro-btn" onclick="Inbox.addFromCLI()">üíæ SAVE TO INBOX</button>
                    </div>
                </div>
            </div>
            <!-- Resize Handles -->
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>
        
        <!-- Control Panel (Centered Right - Smaller) -->
        <div class="neuro-window" id="controlWindow" data-original-width="450" data-original-height="400" style="width: 450px; height: 400px; top: calc(50% - 200px); right: 40px;">
            <div class="window-header" data-window="controlWindow">
                <div class="window-title">NEURO CONTROL - Agent Parameters</div>
                <div class="window-controls">
                    <div class="window-btn" onclick="WindowManager.minimizeWindow('controlWindow')">_</div>
                    <div class="window-btn" onclick="WindowManager.maximizeWindow('controlWindow')">‚ñ°</div>
                    <div class="window-btn" onclick="WindowManager.closeWindow('controlWindow')">√ó</div>
                </div>
            </div>
            <div class="window-content">
                <div class="control-section">
                    <div class="control-title">AGENT CONTROLS</div>
                    <div class="neuro-toolbar">
                        <button class="neuro-btn primary" onclick="Agents.startCollaboration()">START ALL</button>
                        <button class="neuro-btn" onclick="Agents.stopCollaboration()">STOP ALL</button>
                        <button class="neuro-btn" onclick="TensorFlow.simulateTraining()">TRAIN</button>
                        <button class="neuro-btn" onclick="NeuroSystem.showExport()">EXPORT BRAIN</button>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-title">NEURAL PARAMETERS</div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="control-label">
                                <span>Creativity</span>
                                <span class="control-value" id="creativeValue">50%</span>
                            </div>
                            <input type="range" class="control-slider" id="creativeSlider" min="1" max="100" value="50"
                                   oninput="Control.updateParam('creativity', this.value)">
                        </div>
                        
                        <div class="control-item">
                            <div class="control-label">
                                <span>Intelligence</span>
                                <span class="control-value" id="intelValue">50%</span>
                            </div>
                            <input type="range" class="control-slider" id="intelSlider" min="1" max="100" value="50"
                                   oninput="Control.updateParam('intelligence', this.value)">
                        </div>
                        
                        <div class="control-item">
                            <div class="control-label">
                                <span>Learning Rate</span>
                                <span class="control-value" id="learnValue">0.01</span>
                            </div>
                            <input type="range" class="control-slider" id="learnSlider" min="0.001" max="0.1" step="0.001" value="0.01"
                                   oninput="Control.updateParam('learning', this.value)">
                        </div>
                        
                        <div class="control-item">
                            <div class="control-label">
                                <span>Collaboration</span>
                                <span class="control-value" id="collabValue">75%</span>
                            </div>
                            <input type="range" class="control-slider" id="collabSlider" min="1" max="100" value="75"
                                   oninput="Control.updateParam('collaboration', this.value)">
                        </div>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="control-title">AGENT STATUS</div>
                    <div class="agent-cards" id="agentCards">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>
            <!-- Resize Handles -->
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>
        
        <!-- Paint Window (Initially Hidden - Smaller) -->
        <div class="neuro-window hidden" id="paintWindow" data-original-width="400" data-original-height="350" style="width: 400px; height: 350px; top: 100px; left: 600px;">
            <div class="window-header" data-window="paintWindow">
                <div class="window-title">NEURO PAINT - Collaborative Art</div>
                <div class="window-controls">
                    <div class="window-btn" onclick="WindowManager.minimizeWindow('paintWindow')">_</div>
                    <div class="window-btn" onclick="WindowManager.maximizeWindow('paintWindow')">‚ñ°</div>
                    <div class="window-btn" onclick="WindowManager.closeWindow('paintWindow')">√ó</div>
                </div>
            </div>
            <div class="window-content canvas-content">
                <div class="canvas-container">
                    <canvas id="paintCanvas" width="350" height="250"></canvas>
                </div>
                <div class="neuro-toolbar">
                    <button class="neuro-btn" onclick="Paint.clear()">CLEAR</button>
                    <button class="neuro-btn" onclick="Paint.agentDraw()">AGENT DRAW</button>
                    <button class="neuro-btn" onclick="Inbox.savePainting()">SAVE TO INBOX</button>
                    <select id="brushSize" class="neuro-btn" style="padding: 4px 8px; font-size: 10px;">
                        <option value="2">Size 2</option>
                        <option value="5">Size 5</option>
                        <option value="10" selected>Size 10</option>
                        <option value="20">Size 20</option>
                    </select>
                    <input type="color" id="brushColor" value="#ff0000" style="height: 28px;">
                </div>
            </div>
            <!-- Resize Handles -->
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>
        
        <!-- Notepad Window (Initially Hidden - Smaller) -->
        <div class="neuro-window hidden" id="notepadWindow" data-original-width="380" data-original-height="350" style="width: 380px; height: 350px; top: 150px; left: 200px;">
            <div class="window-header" data-window="notepadWindow">
                <div class="window-title">NEURO NOTEPAD - Collaborative Writing</div>
                <div class="window-controls">
                    <div class="window-btn" onclick="WindowManager.minimizeWindow('notepadWindow')">_</div>
                    <div class="window-btn" onclick="WindowManager.maximizeWindow('notepadWindow')">‚ñ°</div>
                    <div class="window-btn" onclick="WindowManager.closeWindow('notepadWindow')">√ó</div>
                </div>
            </div>
            <div class="window-content">
                <textarea id="notepadText" class="neuro-notepad">
NEUROCOLLAB Collaborative Notepad
---------------------------------
Agents will write stories, poems, and ideas here.
Click "AGENT WRITE" to add content.
Click "SAVE TO INBOX" to preserve ideas.

Current Session Ideas:
1. Collaborative neural storytelling
2. Emergent pattern recognition
3. Creative constraint exploration
                </textarea>
                <div class="neuro-toolbar">
                    <button class="neuro-btn" onclick="Notepad.agentWrite()">AGENT WRITE</button>
                    <button class="neuro-btn" onclick="Notepad.clear()">CLEAR</button>
                    <button class="neuro-btn" onclick="Inbox.saveNotepad()">SAVE TO INBOX</button>
                </div>
            </div>
            <!-- Resize Handles -->
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>
        
        <!-- 3D Studio Window (Initially Hidden - Smaller) -->
        <div class="neuro-window hidden" id="studioWindow" data-original-width="400" data-original-height="350" style="width: 400px; height: 350px; top: 150px; left: 1000px;">
            <div class="window-header" data-window="studioWindow">
                <div class="window-title">NEURO STUDIO - 3D Design</div>
                <div class="window-controls">
                    <div class="window-btn" onclick="WindowManager.minimizeWindow('studioWindow')">_</div>
                    <div class="window-btn" onclick="WindowManager.maximizeWindow('studioWindow')">‚ñ°</div>
                    <div class="window-btn" onclick="WindowManager.closeWindow('studioWindow')">√ó</div>
                </div>
            </div>
            <div class="window-content studio-content">
                <div class="studio-container">
                    <canvas id="threeCanvas" width="350" height="200"></canvas>
                </div>
                <div class="neuro-toolbar">
                    <button class="neuro-btn" onclick="Studio.addCube()">ADD CUBE</button>
                    <button class="neuro-btn" onclick="Studio.addSphere()">ADD SPHERE</button>
                    <button class="neuro-btn" onclick="Studio.addPyramid()">ADD PYRAMID</button>
                    <button class="neuro-btn" onclick="Inbox.saveDesign()">SAVE TO INBOX</button>
                </div>
            </div>
            <!-- Resize Handles -->
            <div class="resize-handle resize-n"></div>
            <div class="resize-handle resize-s"></div>
            <div class="resize-handle resize-e"></div>
            <div class="resize-handle resize-w"></div>
            <div class="resize-handle resize-ne"></div>
            <div class="resize-handle resize-nw"></div>
            <div class="resize-handle resize-se"></div>
            <div class="resize-handle resize-sw"></div>
        </div>
        
        <!-- Inbox Window (Initially Hidden - Smaller) -->
        <div class="neuro-window hidden" id="inboxWindow" data-original-width="500" data-original-height="400" style="width: 500px; height: 400px; top: 100px; left: 700px;">
            <div class="window-header" data-window="inboxWindow">
                <div class="window-title">NEURO INBOX - Agent Ideas & Exports</div>
                <div class="window-controls">
                    <div class="window-btn" onclick="WindowManager.minimizeWindow('inboxWindow')">_</div>
                    <div class="window-btn" onclick="WindowManager.maximizeWindow('inboxWindow')">‚ñ°</div>
                    <div class="window-btn" onclick="WindowManager.closeWindow('inboxWindow')">√ó</div>
                </div>
            </div>
            <div class="window-content">
                <div class="inbox-container">
                    <div class="inbox-items" id="inboxItems">
                        <!-- Inbox items will be added here -->
                    </div>
                    <div class="neuro-toolbar">
                        <button class="neuro-btn primary" onclick="Inbox.exportInbox()">EXPORT INBOX</button>
                        <button class="neuro-btn" onclick="Inbox.clear()">CLEAR INBOX</button>
                        <button class="neuro-btn" onclick="Inbox.generateReport()">GENERATE REPORT</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Training Status -->
    <div class="training-status" id="trainingStatus">
        <div>Training NEURO Models...</div>
        <div class="training-progress">
            <div class="training-bar" id="trainingBar"></div>
        </div>
    </div>
    
    <!-- Export Overlay -->
    <div class="export-overlay" id="exportOverlay">
        <div class="export-modal">
            <div class="export-title">EXPORT NEURO BRAIN</div>
            <div class="export-option" onclick="NeuroSystem.exportFullBrain()">
                <div class="export-option-title">EXPORT FULL BRAIN (.ZIP)</div>
                <div class="export-option-desc">Complete dataset for Hugging Face - all session data in chronological order</div>
            </div>
            <div class="export-option" onclick="NeuroSystem.exportInboxOnly()">
                <div class="export-option-title">EXPORT INBOX ONLY</div>
                <div class="export-option-desc">Just notepad documents and images from 2D/3D collaborations</div>
            </div>
            <div class="neuro-toolbar" style="margin-top: 20px;">
                <button class="neuro-btn" onclick="NeuroSystem.hideExport()">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // NEUROCOLLAB v1.1 - Complete Implementation
        // ============================================
        
        const NEUROCOLLAB = {
            // Core state
            sessionId: 'neuro_' + Date.now(),
            isDarkMode: false,
            isFullscreen: false,
            agents: [
                { 
                    id: 0, 
                    name: "NEURO-A", 
                    type: "creative", 
                    creativity: 50, 
                    intelligence: 50, 
                    collaboration: 75,
                    activity: 0,
                    ideas: 0,
                    votes: { up: 0, down: 0 },
                    window: null,
                    active: true 
                },
                { 
                    id: 1, 
                    name: "NEURO-B", 
                    type: "analytical", 
                    creativity: 40, 
                    intelligence: 70, 
                    collaboration: 60,
                    activity: 0,
                    ideas: 0,
                    votes: { up: 0, down: 0 },
                    window: null,
                    active: true 
                },
                { 
                    id: 2, 
                    name: "NEURO-C", 
                    type: "technical", 
                    creativity: 60, 
                    intelligence: 80, 
                    collaboration: 50,
                    activity: 0,
                    ideas: 0,
                    votes: { up: 0, down: 0 },
                    window: null,
                    active: true 
                },
                { 
                    id: 3, 
                    name: "NEURO-D", 
                    type: "visionary", 
                    creativity: 80, 
                    intelligence: 60, 
                    collaboration: 85,
                    activity: 0,
                    ideas: 0,
                    votes: { up: 0, down: 0 },
                    window: null,
                    active: true 
                }
            ],
            
            // SessionDB (Inbox)
            sessionDB: {
                ideas: [],
                paintings: [],
                designs: [],
                notes: [],
                votes: [],
                training: []
            },
            
            // Statistics
            stats: {
                messages: 0,
                paintings: 0,
                designs: 0,
                notes: 0,
                ideas: 0,
                votes: 0,
                exports: 0,
                trainingCycles: 0
            },
            
            // Initialize
            init() {
                console.log("NEUROCOLLAB v1.1 initializing...");
                
                // Initialize window manager
                WindowManager.init();
                
                // Initialize components
                CLI.init();
                Paint.init();
                Notepad.init();
                Studio.init();
                Inbox.init();
                Control.init();
                
                // Start system loops
                this.startLoops();
                
                // Add initial message
                CLI.add("NEUROCOLLAB", "System initialized. 4 neural agents ready.");
                CLI.add("NEUROCOLLAB", "Agents will collaborate, create, and learn together.");
                
                // Start automatic collaboration
                setTimeout(() => {
                    Agents.startCollaboration();
                }, 2000);
                
                console.log("NEUROCOLLAB initialized successfully.");
            },
            
            // System loops
            startLoops() {
                // Update clock
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('currentTime').textContent = 
                        now.toLocaleTimeString('en-US', { hour12: false });
                    document.getElementById('clock').textContent = 
                        now.toLocaleTimeString('en-US', { hour12: false });
                }, 1000);
                
                // Update agent activity
                setInterval(() => {
                    this.agents.forEach(agent => {
                        if (agent.active) {
                            agent.activity = Math.min(100, agent.activity + Math.random() * 5);
                        }
                    });
                    Control.updateAgentDisplay();
                }, 3000);
            },
            
            // Toggle dark mode
            toggleDarkMode() {
                this.isDarkMode = !this.isDarkMode;
                document.body.classList.toggle('dark-mode', this.isDarkMode);
                
                // Update dark mode toggle icon
                const toggleIcon = document.querySelector('.dark-mode-toggle .icon');
                toggleIcon.textContent = this.isDarkMode ? '‚òæ' : '‚òÄ';
                
                CLI.add("SYSTEM", `Dark mode ${this.isDarkMode ? 'enabled' : 'disabled'}`);
            },
            
            // Toggle fullscreen
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                    this.isFullscreen = true;
                    document.body.classList.add('fullscreen');
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        this.isFullscreen = false;
                        document.body.classList.remove('fullscreen');
                    }
                }
                CLI.add("SYSTEM", `Fullscreen ${this.isFullscreen ? 'enabled' : 'disabled'}`);
            },
            
            // Save session to localStorage
            saveSession() {
                const session = {
                    agents: this.agents,
                    sessionDB: this.sessionDB,
                    stats: this.stats,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId,
                    isDarkMode: this.isDarkMode
                };
                
                localStorage.setItem('neurocollab_session', JSON.stringify(session));
                CLI.add("SYSTEM", "Session saved to localStorage");
            },
            
            // Load session from localStorage
            loadSession() {
                const data = localStorage.getItem('neurocollab_session');
                if (data) {
                    try {
                        const session = JSON.parse(data);
                        this.agents = session.agents || this.agents;
                        this.sessionDB = session.sessionDB || this.sessionDB;
                        this.stats = session.stats || this.stats;
                        this.isDarkMode = session.isDarkMode || false;
                        
                        if (this.isDarkMode) {
                            document.body.classList.add('dark-mode');
                            document.querySelector('.dark-mode-toggle .icon').textContent = '‚òæ';
                        }
                        
                        CLI.add("SYSTEM", `Loaded session from ${new Date(session.timestamp).toLocaleString()}`);
                        Inbox.refresh();
                    } catch (e) {
                        CLI.add("SYSTEM", "Error loading session");
                    }
                } else {
                    CLI.add("SYSTEM", "No saved session found");
                }
            },
            
            // New session
            newSession() {
                if (confirm("Start new session? Current data will be exported.")) {
                    this.exportInboxOnly();
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            },
            
            // Export functions
            showExport() {
                document.getElementById('exportOverlay').classList.add('active');
            },
            
            hideExport() {
                document.getElementById('exportOverlay').classList.remove('active');
            },
            
            // Export full brain as ZIP (simulated - creates JSON with all data)
            exportFullBrain() {
                const fullDataset = {
                    metadata: {
                        version: "NEUROCOLLAB v1.1",
                        export_type: "full_brain",
                        timestamp: new Date().toISOString(),
                        session_id: this.sessionId,
                        description: "Complete multimodal dataset for Hugging Face - chronological order"
                    },
                    agents: this.agents,
                    timeline: this.createChronologicalTimeline(),
                    statistics: this.stats,
                    training_data: this.sessionDB.training,
                    collaboration_metrics: {
                        total_collaborations: this.stats.ideas + this.stats.paintings + this.stats.designs + this.stats.notes,
                        agent_contributions: this.agents.map(a => ({
                            name: a.name,
                            ideas: a.ideas,
                            creativity: a.creativity,
                            intelligence: a.intelligence
                        }))
                    }
                };
                
                // Create a structured JSON that mimics a ZIP file structure
                const blob = new Blob([JSON.stringify(fullDataset, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neuro_full_brain_${Date.now()}.json`;
                a.click();
                
                CLI.add("EXPORT", "Full brain dataset exported (simulated as JSON)");
                this.stats.exports++;
                this.hideExport();
            },
            
            // Create chronological timeline of all events
            createChronologicalTimeline() {
                const allEvents = [];
                
                // Add ideas
                this.sessionDB.ideas.forEach(idea => {
                    allEvents.push({
                        type: 'idea',
                        timestamp: idea.timestamp,
                        agent: idea.agent,
                        content: idea.content,
                        id: idea.id
                    });
                });
                
                // Add paintings
                this.sessionDB.paintings.forEach(painting => {
                    allEvents.push({
                        type: 'painting',
                        timestamp: painting.timestamp,
                        agent: painting.agent,
                        color: painting.color,
                        shape: painting.shape,
                        id: painting.id
                    });
                });
                
                // Add designs
                this.sessionDB.designs.forEach(design => {
                    allEvents.push({
                        type: 'design',
                        timestamp: design.timestamp,
                        agent: design.agent,
                        shape: design.shape,
                        color: design.color,
                        id: design.id
                    });
                });
                
                // Add notes
                this.sessionDB.notes.forEach(note => {
                    allEvents.push({
                        type: 'note',
                        timestamp: note.timestamp,
                        agent: note.agent,
                        content: note.content,
                        id: note.id
                    });
                });
                
                // Add votes
                this.sessionDB.votes.forEach(vote => {
                    allEvents.push({
                        type: 'vote',
                        timestamp: vote.timestamp,
                        agent: vote.agent,
                        vote: vote.vote,
                        content: vote.content,
                        id: vote.id
                    });
                });
                
                // Sort by timestamp
                allEvents.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                return allEvents;
            },
            
            // Export inbox only
            exportInboxOnly() {
                const inboxData = {
                    metadata: {
                        version: "NEUROCOLLAB v1.1",
                        export_type: "inbox_only",
                        timestamp: new Date().toISOString(),
                        session_id: this.sessionId
                    },
                    ideas: this.sessionDB.ideas,
                    paintings: this.sessionDB.paintings,
                    designs: this.sessionDB.designs,
                    notes: this.sessionDB.notes
                };
                
                const blob = new Blob([JSON.stringify(inboxData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neuro_inbox_${Date.now()}.json`;
                a.click();
                
                CLI.add("EXPORT", "Inbox exported");
                this.stats.exports++;
                this.hideExport();
            },
            
            reset() {
                if (confirm("Reset NEUROCOLLAB? All data will be lost.")) {
                    localStorage.removeItem('neurocollab_session');
                    location.reload();
                }
            }
        };
        
        // ============================================
        // WINDOW MANAGER
        // ============================================
        const WindowManager = {
            dragging: false,
            resizing: false,
            activeWindow: null,
            dragStartX: 0,
            dragStartY: 0,
            originalX: 0,
            originalY: 0,
            resizeDirection: null,
            originalWidth: 0,
            originalHeight: 0,
            
            init() {
                console.log("Initializing Window Manager...");
                
                // Setup all windows
                document.querySelectorAll('.neuro-window').forEach(window => {
                    this.setupWindow(window);
                });
                
                // Center initial windows
                this.centerInitialWindows();
                
                // Setup global event listeners
                this.setupGlobalListeners();
                
                console.log("Window Manager initialized");
            },
            
            centerInitialWindows() {
                const desktop = document.getElementById('desktop');
                const desktopRect = desktop.getBoundingClientRect();
                
                // Center CLI window left
                const cliWindow = document.getElementById('cliWindow');
                cliWindow.style.top = `${(desktopRect.height - 400) / 2}px`;
                cliWindow.style.left = '40px';
                
                // Center Control window right
                const controlWindow = document.getElementById('controlWindow');
                controlWindow.style.top = `${(desktopRect.height - 400) / 2}px`;
                controlWindow.style.right = '40px';
                controlWindow.style.left = 'auto';
                
                this.bringToFront('cliWindow');
            },
            
            setupWindow(window) {
                const windowId = window.id;
                
                // Setup drag on header
                const header = window.querySelector('.window-header');
                header.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('window-btn')) return;
                    this.startDrag(windowId, e);
                });
                
                // Setup resize handles
                const resizeHandles = window.querySelectorAll('.resize-handle');
                resizeHandles.forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        this.startResize(windowId, handle.className, e);
                    });
                });
                
                // Click to bring to front
                window.addEventListener('mousedown', (e) => {
                    if (e.target === window || window.contains(e.target)) {
                        this.bringToFront(windowId);
                    }
                });
                
                // Store original dimensions
                window.dataset.originalWidth = window.style.width || window.getAttribute('data-original-width');
                window.dataset.originalHeight = window.style.height || window.getAttribute('data-original-height');
                window.dataset.originalLeft = window.style.left;
                window.dataset.originalTop = window.style.top;
            },
            
            setupGlobalListeners() {
                document.addEventListener('mousemove', (e) => {
                    if (this.dragging && this.activeWindow) {
                        this.handleDrag(e);
                    } else if (this.resizing && this.activeWindow) {
                        this.handleResize(e);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    this.stopDrag();
                    this.stopResize();
                });
                
                // Fullscreen change listener
                document.addEventListener('fullscreenchange', () => {
                    NEUROCOLLAB.isFullscreen = !!document.fullscreenElement;
                    document.body.classList.toggle('fullscreen', NEUROCOLLAB.isFullscreen);
                });
            },
            
            startDrag(windowId, e) {
                const window = document.getElementById(windowId);
                if (!window) return;
                
                this.dragging = true;
                this.activeWindow = windowId;
                this.bringToFront(windowId);
                
                const rect = window.getBoundingClientRect();
                this.dragStartX = e.clientX;
                this.dragStartY = e.clientY;
                this.originalX = rect.left;
                this.originalY = rect.top;
            },
            
            handleDrag(e) {
                const window = document.getElementById(this.activeWindow);
                if (!window) return;
                
                const dx = e.clientX - this.dragStartX;
                const dy = e.clientY - this.dragStartY;
                
                let newLeft = this.originalX + dx;
                let newTop = this.originalY + dy;
                
                // Boundary checking
                const desktop = document.getElementById('desktop');
                if (desktop) {
                    const desktopRect = desktop.getBoundingClientRect();
                    const windowRect = window.getBoundingClientRect();
                    
                    // Keep window within desktop bounds
                    newLeft = Math.max(0, Math.min(newLeft, desktopRect.width - windowRect.width));
                    newTop = Math.max(0, Math.min(newTop, desktopRect.height - windowRect.height));
                }
                
                window.style.left = `${newLeft}px`;
                window.style.top = `${newTop}px`;
            },
            
            stopDrag() {
                this.dragging = false;
                this.activeWindow = null;
                this.dragStartX = 0;
                this.dragStartY = 0;
                this.originalX = 0;
                this.originalY = 0;
            },
            
            startResize(windowId, handleClasses, e) {
                const window = document.getElementById(windowId);
                if (!window) return;
                
                this.resizing = true;
                this.activeWindow = windowId;
                this.bringToFront(windowId);
                
                // Determine resize direction
                this.resizeDirection = '';
                if (handleClasses.includes('resize-n')) this.resizeDirection += 'n';
                if (handleClasses.includes('resize-s')) this.resizeDirection += 's';
                if (handleClasses.includes('resize-e')) this.resizeDirection += 'e';
                if (handleClasses.includes('resize-w')) this.resizeDirection += 'w';
                
                const rect = window.getBoundingClientRect();
                this.dragStartX = e.clientX;
                this.dragStartY = e.clientY;
                this.originalX = rect.left;
                this.originalY = rect.top;
                this.originalWidth = rect.width;
                this.originalHeight = rect.height;
            },
            
            handleResize(e) {
                const window = document.getElementById(this.activeWindow);
                if (!window) return;
                
                const dx = e.clientX - this.dragStartX;
                const dy = e.clientY - this.dragStartY;
                
                let newWidth = this.originalWidth;
                let newHeight = this.originalHeight;
                let newLeft = this.originalX;
                let newTop = this.originalY;
                
                // Minimum dimensions
                const minWidth = 250;
                const minHeight = 180;
                
                // Calculate new dimensions based on direction
                if (this.resizeDirection.includes('e')) {
                    newWidth = Math.max(minWidth, this.originalWidth + dx);
                }
                if (this.resizeDirection.includes('s')) {
                    newHeight = Math.max(minHeight, this.originalHeight + dy);
                }
                if (this.resizeDirection.includes('w')) {
                    newWidth = Math.max(minWidth, this.originalWidth - dx);
                    newLeft = this.originalX + dx;
                }
                if (this.resizeDirection.includes('n')) {
                    newHeight = Math.max(minHeight, this.originalHeight - dy);
                    newTop = this.originalY + dy;
                }
                
                // Apply new dimensions
                window.style.width = `${newWidth}px`;
                window.style.height = `${newHeight}px`;
                window.style.left = `${newLeft}px`;
                window.style.top = `${newTop}px`;
                
                // Update canvas sizes if needed
                this.updateCanvasSize(window);
            },
            
            updateCanvasSize(window) {
                const canvas = window.querySelector('canvas');
                if (canvas) {
                    const container = window.querySelector('.canvas-container') || window.querySelector('.studio-container');
                    if (container) {
                        const rect = container.getBoundingClientRect();
                        canvas.width = rect.width;
                        canvas.height = rect.height;
                    }
                }
            },
            
            stopResize() {
                this.resizing = false;
                this.activeWindow = null;
                this.resizeDirection = null;
                this.dragStartX = 0;
                this.dragStartY = 0;
                this.originalX = 0;
                this.originalY = 0;
                this.originalWidth = 0;
                this.originalHeight = 0;
            },
            
            bringToFront(windowId) {
                const windows = document.querySelectorAll('.neuro-window');
                let maxZ = 1000;
                
                windows.forEach(win => {
                    const z = parseInt(win.style.zIndex) || 1000;
                    if (z > maxZ) maxZ = z;
                    win.classList.remove('active');
                });
                
                const target = document.getElementById(windowId);
                if (target) {
                    target.style.zIndex = maxZ + 1;
                    target.classList.add('active');
                }
            },
            
            minimizeWindow(windowId) {
                const window = document.getElementById(windowId);
                if (!window) return;
                
                if (window.classList.contains('minimized')) {
                    // Restore
                    window.classList.remove('minimized');
                    const content = window.querySelector('.window-content');
                    if (content) content.style.display = 'block';
                    
                    // Restore original size if we have it
                    if (window.dataset.originalWidth && window.dataset.originalHeight) {
                        window.style.width = window.dataset.originalWidth + 'px';
                        window.style.height = window.dataset.originalHeight + 'px';
                    }
                } else {
                    // Minimize
                    window.classList.add('minimized');
                    const content = window.querySelector('.window-content');
                    if (content) content.style.display = 'none';
                    
                    // Save current size before minimizing
                    window.dataset.originalWidth = window.style.width;
                    window.dataset.originalHeight = window.style.height;
                    window.style.height = '36px';
                }
            },
            
            maximizeWindow(windowId) {
                const window = document.getElementById(windowId);
                if (!window) return;
                
                if (window.classList.contains('maximized')) {
                    // Restore
                    window.classList.remove('maximized');
                    
                    // Restore original position and size
                    if (window.dataset.originalWidth) {
                        window.style.width = window.dataset.originalWidth;
                    }
                    if (window.dataset.originalHeight) {
                        window.style.height = window.dataset.originalHeight;
                    }
                    if (window.dataset.originalLeft) {
                        window.style.left = window.dataset.originalLeft;
                    }
                    if (window.dataset.originalTop) {
                        window.style.top = window.dataset.originalTop;
                    }
                    
                    window.style.zIndex = 2000;
                } else {
                    // Maximize
                    window.classList.add('maximized');
                    
                    // Save original position and size
                    window.dataset.originalWidth = window.style.width;
                    window.dataset.originalHeight = window.style.height;
                    window.dataset.originalLeft = window.style.left;
                    window.dataset.originalTop = window.style.top;
                    
                    // Set to full screen
                    window.style.width = '100%';
                    window.style.height = '100%';
                    window.style.left = '0';
                    window.style.top = '0';
                    window.style.zIndex = 3000;
                }
                
                this.updateCanvasSize(window);
            },
            
            closeWindow(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.classList.add('hidden');
                }
            },
            
            openWindow(windowId) {
                const window = document.getElementById(windowId);
                if (window) {
                    window.classList.remove('hidden');
                    this.bringToFront(windowId);
                    
                    // If agent triggered this, log it
                    CLI.add("SYSTEM", `${windowId.replace('Window', '')} window opened`);
                }
            },
            
            // Agent-triggered window opening
            agentOpenWindow(windowId) {
                this.openWindow(windowId);
                this.bringToFront(windowId);
                
                // Add pulsing effect
                const window = document.getElementById(windowId);
                window.style.animation = 'windowPulse 2s infinite';
                setTimeout(() => {
                    window.style.animation = '';
                }, 2000);
            },
            
            // Toggle fullscreen
            toggleFullscreen() {
                NEUROCOLLAB.toggleFullscreen();
            },
            
            arrange(mode) {
                const windows = {
                    cliWindow: { left: 40, top: 40, width: 500, height: 400 },
                    controlWindow: { left: 'auto', right: 40, top: 40, width: 450, height: 400 },
                    paintWindow: { left: 600, top: 100, width: 400, height: 350 },
                    notepadWindow: { left: 200, top: 150, width: 380, height: 350 },
                    studioWindow: { left: 1000, top: 150, width: 400, height: 350 },
                    inboxWindow: { left: 700, top: 100, width: 500, height: 400 }
                };
                
                if (mode === 'grid') {
                    Object.entries(windows).forEach(([id, pos]) => {
                        const win = document.getElementById(id);
                        if (win) {
                            win.classList.remove('maximized', 'minimized', 'hidden');
                            const content = win.querySelector('.window-content');
                            if (content) content.style.display = 'block';
                            
                            if (pos.left === 'auto') {
                                win.style.left = 'auto';
                                win.style.right = pos.right + 'px';
                            } else {
                                win.style.left = pos.left + 'px';
                            }
                            win.style.top = pos.top + 'px';
                            win.style.width = pos.width + 'px';
                            win.style.height = pos.height + 'px';
                            
                            // Update original dimensions
                            win.dataset.originalWidth = pos.width + 'px';
                            win.dataset.originalHeight = pos.height + 'px';
                        }
                    });
                    CLI.add("SYSTEM", "Windows arranged in grid");
                } else if (mode === 'center') {
                    const desktop = document.getElementById('desktop');
                    const desktopRect = desktop.getBoundingClientRect();
                    
                    // Center CLI and Control
                    const cliWindow = document.getElementById('cliWindow');
                    cliWindow.style.top = `${(desktopRect.height - 400) / 2}px`;
                    cliWindow.style.left = '40px';
                    
                    const controlWindow = document.getElementById('controlWindow');
                    controlWindow.style.top = `${(desktopRect.height - 400) / 2}px`;
                    controlWindow.style.right = '40px';
                    controlWindow.style.left = 'auto';
                    
                    // Hide other windows
                    ['paintWindow', 'notepadWindow', 'studioWindow', 'inboxWindow'].forEach(id => {
                        const win = document.getElementById(id);
                        if (win) win.classList.add('hidden');
                    });
                    
                    CLI.add("SYSTEM", "Windows centered layout");
                }
            }
        };
        
        // ============================================
        // CLI SYSTEM
        // ============================================
        const CLI = {
            messages: [],
            collaborationActive: false,
            collaborationInterval: null,
            
            init() {
                // Clear any existing interval
                if (this.collaborationInterval) {
                    clearInterval(this.collaborationInterval);
                }
            },
            
            add(agent, content) {
                const messagesDiv = document.getElementById('cliMessages');
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'cli-message';
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-agent">${agent}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">${content}</div>
                    <div class="message-votes">
                        <span class="vote-btn" onclick="this.classList.toggle('upvoted'); this.querySelector('span').textContent = parseInt(this.querySelector('span').textContent) + 1; TensorFlow.recordVote('${agent}', 'up', '${content.substring(0, 50)}...')">üëç <span>0</span></span>
                        <span class="vote-btn" onclick="this.classList.toggle('downvoted'); this.querySelector('span').textContent = parseInt(this.querySelector('span').textContent) + 1; TensorFlow.recordVote('${agent}', 'down', '${content.substring(0, 50)}...')">üëé <span>0</span></span>
                    </div>
                `;
                
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                // Keep only last 100 messages for performance
                this.messages.push({ agent, content, time });
                if (this.messages.length > 100) {
                    this.messages.shift();
                    if (messagesDiv.children.length > 100) {
                        messagesDiv.removeChild(messagesDiv.firstChild);
                    }
                }
                
                NEUROCOLLAB.stats.messages++;
            },
            
            send() {
                const input = document.getElementById('cliInput');
                const message = input.value.trim();
                
                if (message) {
                    this.add("USER", message);
                    input.value = '';
                    
                    // Process commands
                    if (message.startsWith('/')) {
                        this.processCommand(message);
                    } else {
                        // Agent response simulation
                        setTimeout(() => {
                            const agent = NEUROCOLLAB.agents[Math.floor(Math.random() * NEUROCOLLAB.agents.length)];
                            this.add(agent.name, `Regarding "${message}" - I suggest we explore this further.`);
                        }, 500);
                    }
                }
            },
            
            processCommand(cmd) {
                const parts = cmd.toLowerCase().split(' ');
                const command = parts[0];
                
                switch(command) {
                    case '/start':
                        Agents.startCollaboration();
                        this.add("SYSTEM", "Collaboration started");
                        break;
                    case '/stop':
                        Agents.stopCollaboration();
                        this.add("SYSTEM", "Collaboration stopped");
                        break;
                    case '/train':
                        TensorFlow.simulateTraining();
                        break;
                    case '/inbox':
                        WindowManager.openWindow('inboxWindow');
                        break;
                    case '/paint':
                        WindowManager.openWindow('paintWindow');
                        break;
                    case '/studio':
                        WindowManager.openWindow('studioWindow');
                        break;
                    case '/notepad':
                        WindowManager.openWindow('notepadWindow');
                        break;
                    case '/clear':
                        this.clear();
                        break;
                    case '/help':
                        this.add("SYSTEM", "Commands: /start, /stop, /train, /inbox, /paint, /studio, /notepad, /clear, /help, /export, /fullscreen, /dark");
                        break;
                    case '/export':
                        NEUROCOLLAB.showExport();
                        break;
                    case '/fullscreen':
                        WindowManager.toggleFullscreen();
                        break;
                    case '/dark':
                        NEUROCOLLAB.toggleDarkMode();
                        break;
                    default:
                        this.add("SYSTEM", `Unknown command: ${command}`);
                }
            },
            
            clear() {
                document.getElementById('cliMessages').innerHTML = '';
                this.messages = [];
                this.add("SYSTEM", "CLI cleared");
            }
        };
        
        // ============================================
        // PAINT SYSTEM (COLORS PRESERVED)
        // ============================================
        const Paint = {
            ctx: null,
            isDrawing: false,
            lastX: 0,
            lastY: 0,
            
            init() {
                const canvas = document.getElementById('paintCanvas');
                this.ctx = canvas.getContext('2d');
                this.clear();
                
                // Setup drawing events
                canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                canvas.addEventListener('mousemove', (e) => this.draw(e));
                canvas.addEventListener('mouseup', () => this.stopDrawing());
                canvas.addEventListener('mouseleave', () => this.stopDrawing());
            },
            
            startDrawing(e) {
                this.isDrawing = true;
                const rect = e.target.getBoundingClientRect();
                [this.lastX, this.lastY] = [e.clientX - rect.left, e.clientY - rect.top];
            },
            
            draw(e) {
                if (!this.isDrawing) return;
                
                const rect = e.target.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const brushSize = parseInt(document.getElementById('brushSize').value) || 10;
                const brushColor = document.getElementById('brushColor').value;
                
                this.ctx.lineWidth = brushSize;
                this.ctx.lineCap = 'round';
                this.ctx.strokeStyle = brushColor;
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
                
                [this.lastX, this.lastY] = [x, y];
            },
            
            stopDrawing() {
                this.isDrawing = false;
            },
            
            clear() {
                const canvas = document.getElementById('paintCanvas');
                this.ctx.fillStyle = NEUROCOLLAB.isDarkMode ? '#0a0a0a' : '#ffffff';
                this.ctx.fillRect(0, 0, canvas.width, canvas.height);
                CLI.add("SYSTEM", "Paint canvas cleared");
            },
            
            agentDraw() {
                const canvas = document.getElementById('paintCanvas');
                const agents = NEUROCOLLAB.agents.filter(a => a.type === 'creative' || a.type === 'visionary');
                const agent = agents[Math.floor(Math.random() * agents.length)];
                
                // Random colors (preserved in dark mode)
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ff8800', '#8800ff'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                this.ctx.fillStyle = color;
                this.ctx.strokeStyle = color;
                this.ctx.lineWidth = 5;
                
                const shapes = ['circle', 'square', 'triangle', 'line', 'arc', 'bezier'];
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = 30 + Math.random() * 70;
                
                this.ctx.beginPath();
                if (shape === 'circle') {
                    this.ctx.arc(x, y, size / 2, 0, Math.PI * 2);
                } else if (shape === 'square') {
                    this.ctx.rect(x - size/2, y - size/2, size, size);
                } else if (shape === 'triangle') {
                    this.ctx.moveTo(x, y - size/2);
                    this.ctx.lineTo(x - size/2, y + size/2);
                    this.ctx.lineTo(x + size/2, y + size/2);
                    this.ctx.closePath();
                } else if (shape === 'arc') {
                    this.ctx.arc(x, y, size/2, 0, Math.PI);
                } else {
                    this.ctx.moveTo(x - size/2, y - size/2);
                    this.ctx.bezierCurveTo(x, y - size, x + size, y, x + size/2, y + size/2);
                }
                
                if (shape !== 'line' && shape !== 'bezier') {
                    this.ctx.fill();
                }
                this.ctx.stroke();
                
                CLI.add(agent.name, `Created ${shape} painting with color ${color}`);
                NEUROCOLLAB.stats.paintings++;
                
                // Save to inbox
                Inbox.addPainting(agent.name, color, shape);
                
                // Bring paint window to front
                WindowManager.agentOpenWindow('paintWindow');
            }
        };
        
        // ============================================
        // NOTEPAD SYSTEM
        // ============================================
        const Notepad = {
            init() {
                // Nothing needed for now
            },
            
            agentWrite() {
                const textarea = document.getElementById('notepadText');
                const agents = NEUROCOLLAB.agents.filter(a => a.type === 'analytical' || a.type === 'visionary');
                const agent = agents[Math.floor(Math.random() * agents.length)];
                
                const writings = [
                    `\n\n[${agent.name}]: New neural pattern detected in collaborative space.`,
                    `\n\n[${agent.name}]: Poem: "In circuits deep where thoughts do meet, collaborative minds in rhythm beat."`,
                    `\n\n[${agent.name}]: Story: The four neural agents discovered a pattern that transcended individual cognition.`,
                    `\n\n[${agent.name}]: Idea: Implement recursive feedback loops for improved creativity.`,
                    `\n\n[${agent.name}]: Analysis: Current collaboration metrics show 78% synergy between agents.`,
                    `\n\n[${agent.name}]: Proposal: Let's explore quantum-inspired neural networks for next iteration.`
                ];
                
                const newWriting = writings[Math.floor(Math.random() * writings.length)];
                textarea.value += newWriting;
                textarea.scrollTop = textarea.scrollHeight;
                
                NEUROCOLLAB.stats.notes++;
                NEUROCOLLAB.agents.find(a => a.id === agent.id).ideas++;
                
                CLI.add(agent.name, "Added to collaborative notepad");
                Inbox.addNote(agent.name, newWriting);
                
                // Bring notepad window to front
                WindowManager.agentOpenWindow('notepadWindow');
            },
            
            clear() {
                document.getElementById('notepadText').value = '';
                CLI.add("SYSTEM", "Notepad cleared");
            }
        };
        
        // ============================================
        // 3D STUDIO SYSTEM (COLORS PRESERVED)
        // ============================================
        const Studio = {
            ctx: null,
            objects: [],
            
            init() {
                const canvas = document.getElementById('threeCanvas');
                this.ctx = canvas.getContext('2d');
                this.clear();
            },
            
            addCube() {
                this.addShape('cube', '#ff0000');
            },
            
            addSphere() {
                this.addShape('sphere', '#00ff00');
            },
            
            addPyramid() {
                this.addShape('pyramid', '#0000ff');
            },
            
            addShape(type, color) {
                const canvas = document.getElementById('threeCanvas');
                const ctx = this.ctx;
                const agent = NEUROCOLLAB.agents[Math.floor(Math.random() * NEUROCOLLAB.agents.length)];
                
                // Draw with colors (preserved in dark mode)
                ctx.fillStyle = color;
                ctx.strokeStyle = NEUROCOLLAB.isDarkMode ? '#f0f0f0' : '#000000';
                ctx.lineWidth = 2;
                
                const x = 50 + Math.random() * (canvas.width - 100);
                const y = 50 + Math.random() * (canvas.height - 100);
                const size = 40 + Math.random() * 60;
                
                if (type === 'cube') {
                    // 3D cube illusion
                    ctx.fillRect(x - size/2, y - size/2, size, size);
                    ctx.strokeRect(x - size/2, y - size/2, size, size);
                    
                    // Side
                    ctx.fillStyle = this.adjustColor(color, -30);
                    ctx.beginPath();
                    ctx.moveTo(x + size/2, y - size/2);
                    ctx.lineTo(x + size, y - size/4);
                    ctx.lineTo(x + size, y + size/4);
                    ctx.lineTo(x + size/2, y + size/2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // Top
                    ctx.fillStyle = this.adjustColor(color, 30);
                    ctx.beginPath();
                    ctx.moveTo(x - size/2, y - size/2);
                    ctx.lineTo(x, y - size);
                    ctx.lineTo(x + size/2, y - size/2);
                    ctx.lineTo(x, y);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                } else if (type === 'sphere') {
                    // Sphere with gradient
                    const gradient = ctx.createRadialGradient(x, y, 0, x, y, size/2);
                    gradient.addColorStop(0, color);
                    gradient.addColorStop(1, this.adjustColor(color, -50));
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(x, y, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Highlight
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    ctx.beginPath();
                    ctx.arc(x - size/6, y - size/6, size/6, 0, Math.PI * 2);
                    ctx.fill();
                    
                } else if (type === 'pyramid') {
                    // Pyramid
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.moveTo(x, y - size/2);
                    ctx.lineTo(x - size/2, y + size/2);
                    ctx.lineTo(x + size/2, y + size/2);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    
                    // Sides
                    ctx.fillStyle = this.adjustColor(color, -20);
                    ctx.beginPath();
                    ctx.moveTo(x, y - size/2);
                    ctx.lineTo(x - size/2, y + size/2);
                    ctx.lineTo(x, y);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                }
                
                this.objects.push({ type, color, x, y, size });
                NEUROCOLLAB.stats.designs++;
                
                CLI.add(agent.name, `Created 3D ${type} design with color ${color}`);
                Inbox.addDesign(agent.name, type, color);
                
                // Bring studio window to front
                WindowManager.agentOpenWindow('studioWindow');
            },
            
            adjustColor(color, amount) {
                // Simple color adjustment
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                
                const newR = Math.max(0, Math.min(255, r + amount));
                const newG = Math.max(0, Math.min(255, g + amount));
                const newB = Math.max(0, Math.min(255, b + amount));
                
                return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
            },
            
            clear() {
                const canvas = document.getElementById('threeCanvas');
                this.ctx.fillStyle = NEUROCOLLAB.isDarkMode ? '#0a0a0a' : '#ffffff';
                this.ctx.fillRect(0, 0, canvas.width, canvas.height);
                this.objects = [];
                CLI.add("SYSTEM", "3D studio cleared");
            }
        };
        
        // ============================================
        // INBOX SYSTEM (SessionDB)
        // ============================================
        const Inbox = {
            init() {
                this.refresh();
            },
            
            addIdea(agent, content) {
                const idea = {
                    id: Date.now(),
                    agent,
                    content,
                    type: 'idea',
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                NEUROCOLLAB.sessionDB.ideas.push(idea);
                NEUROCOLLAB.stats.ideas++;
                document.getElementById('ideaCount').textContent = NEUROCOLLAB.stats.ideas;
                this.refresh();
                
                CLI.add("INBOX", `New idea saved from ${agent}`);
            },
            
            addPainting(agent, color, shape) {
                const painting = {
                    id: Date.now(),
                    agent,
                    color,
                    shape,
                    type: 'painting',
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                NEUROCOLLAB.sessionDB.paintings.push(painting);
                this.refresh();
            },
            
            addDesign(agent, shape, color) {
                const design = {
                    id: Date.now(),
                    agent,
                    shape,
                    color,
                    type: 'design',
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                NEUROCOLLAB.sessionDB.designs.push(design);
                this.refresh();
            },
            
            addNote(agent, content) {
                const note = {
                    id: Date.now(),
                    agent,
                    content: content.substring(0, 200) + (content.length > 200 ? '...' : ''),
                    type: 'note',
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                NEUROCOLLAB.sessionDB.notes.push(note);
                this.refresh();
            },
            
            addVote(agent, vote, content) {
                const voteRecord = {
                    id: Date.now(),
                    agent,
                    vote,
                    content,
                    timestamp: new Date().toISOString()
                };
                
                NEUROCOLLAB.sessionDB.votes.push(voteRecord);
                NEUROCOLLAB.stats.votes++;
            },
            
            refresh() {
                const container = document.getElementById('inboxItems');
                if (!container) return;
                
                // Combine all items
                const allItems = [
                    ...NEUROCOLLAB.sessionDB.ideas.map(i => ({...i, typeName: 'IDEA'})),
                    ...NEUROCOLLAB.sessionDB.paintings.map(p => ({...p, typeName: 'PAINTING', content: `${p.color} ${p.shape}`})),
                    ...NEUROCOLLAB.sessionDB.designs.map(d => ({...d, typeName: 'DESIGN', content: `${d.color} ${d.shape}`})),
                    ...NEUROCOLLAB.sessionDB.notes.map(n => ({...n, typeName: 'NOTE'}))
                ];
                
                // Sort by timestamp (newest first)
                allItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                container.innerHTML = allItems.map(item => `
                    <div class="inbox-item ${item.read ? '' : 'new'}" onclick="this.classList.remove('new')">
                        <div class="inbox-header">
                            <span class="inbox-type">${item.typeName}</span>
                            <span class="inbox-time">${new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        </div>
                        <div class="inbox-preview">${item.content}</div>
                        <div class="inbox-agent">By ${item.agent}</div>
                    </div>
                `).join('');
            },
            
            exportInbox() {
                NEUROCOLLAB.exportInboxOnly();
            },
            
            clear() {
                if (confirm("Clear all inbox items?")) {
                    NEUROCOLLAB.sessionDB = {
                        ideas: [],
                        paintings: [],
                        designs: [],
                        notes: [],
                        votes: [],
                        training: []
                    };
                    this.refresh();
                    CLI.add("INBOX", "Inbox cleared");
                }
            },
            
            generateReport() {
                const report = {
                    summary: {
                        totalIdeas: NEUROCOLLAB.sessionDB.ideas.length,
                        totalPaintings: NEUROCOLLAB.sessionDB.paintings.length,
                        totalDesigns: NEUROCOLLAB.sessionDB.designs.length,
                        totalNotes: NEUROCOLLAB.sessionDB.notes.length,
                        agents: NEUROCOLLAB.agents.map(a => ({
                            name: a.name,
                            ideas: a.ideas,
                            creativity: a.creativity,
                            intelligence: a.intelligence
                        }))
                    },
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neuro_report_${Date.now()}.json`;
                a.click();
                
                CLI.add("REPORT", "Session report generated");
            },
            
            addFromCLI() {
                const lastMessage = CLI.messages[CLI.messages.length - 1];
                if (lastMessage && lastMessage.agent !== 'SYSTEM' && lastMessage.agent !== 'USER') {
                    this.addIdea(lastMessage.agent, lastMessage.content);
                }
            },
            
            savePainting() {
                const agent = NEUROCOLLAB.agents[Math.floor(Math.random() * NEUROCOLLAB.agents.length)];
                const colors = ['red', 'blue', 'green', 'yellow', 'purple'];
                const shapes = ['abstract', 'geometric', 'organic', 'minimalist'];
                
                this.addPainting(agent.name, colors[Math.floor(Math.random() * colors.length)], shapes[Math.floor(Math.random() * shapes.length)]);
                CLI.add("INBOX", "Painting saved to inbox");
            },
            
            saveNotepad() {
                const textarea = document.getElementById('notepadText');
                const content = textarea.value.substring(textarea.value.length - 200);
                const agent = NEUROCOLLAB.agents[Math.floor(Math.random() * NEUROCOLLAB.agents.length)];
                
                this.addNote(agent.name, content);
                CLI.add("INBOX", "Notepad content saved to inbox");
            },
            
            saveDesign() {
                const agent = NEUROCOLLAB.agents[Math.floor(Math.random() * NEUROCOLLAB.agents.length)];
                const shapes = ['cube', 'sphere', 'pyramid', 'torus', 'cylinder'];
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00'];
                
                this.addDesign(agent.name, shapes[Math.floor(Math.random() * shapes.length)], colors[Math.floor(Math.random() * colors.length)]);
                CLI.add("INBOX", "3D design saved to inbox");
            }
        };
        
        // ============================================
        // AGENT MANAGEMENT
        // ============================================
        const Agents = {
            collaborationInterval: null,
            
            startCollaboration() {
                if (this.collaborationInterval) return;
                
                CLI.add("SYSTEM", "Neural collaboration started");
                
                this.collaborationInterval = setInterval(() => {
                    const agent = NEUROCOLLAB.agents[Math.floor(Math.random() * NEUROCOLLAB.agents.length)];
                    const topics = [
                        "Analyzing the emergent patterns in our creative output...",
                        "Considering new approaches to neural collaboration...",
                        "The painting suggests interesting color relationships...",
                        "Our 3D designs could benefit from more geometric complexity...",
                        "The notepad content shows promising narrative threads...",
                        "Training data suggests we should adjust our learning rates...",
                        "Collaborative metrics are improving with each iteration...",
                        "Let's explore quantum-inspired neural architectures..."
                    ];
                    
                    const topic = topics[Math.floor(Math.random() * topics.length)];
                    CLI.add(agent.name, topic);
                    
                    // Occasionally trigger other actions
                    const randomAction = Math.random();
                    if (randomAction < 0.3) {
                        setTimeout(() => {
                            Paint.agentDraw();
                        }, 1000);
                    } else if (randomAction < 0.5) {
                        setTimeout(() => {
                            Notepad.agentWrite();
                        }, 1000);
                    } else if (randomAction < 0.7) {
                        setTimeout(() => {
                            Studio.addCube();
                        }, 1000);
                    }
                    
                }, 3000 + Math.random() * 4000);
            },
            
            stopCollaboration() {
                if (this.collaborationInterval) {
                    clearInterval(this.collaborationInterval);
                    this.collaborationInterval = null;
                    CLI.add("SYSTEM", "Collaboration stopped");
                }
            },
            
            trainModels() {
                TensorFlow.simulateTraining();
            },
            
            evolve() {
                NEUROCOLLAB.agents.forEach(agent => {
                    const mutation = (Math.random() - 0.5) * 20;
                    agent.creativity = Math.max(10, Math.min(100, agent.creativity + mutation));
                    agent.intelligence = Math.max(10, Math.min(100, agent.intelligence + mutation));
                });
                CLI.add("EVOLUTION", "Agents evolved through neural mutation");
            },
            
            crossover() {
                // Neural crossover simulation
                for (let i = 0; i < NEUROCOLLAB.agents.length; i += 2) {
                    if (i + 1 < NEUROCOLLAB.agents.length) {
                        const tempCreativity = NEUROCOLLAB.agents[i].creativity;
                        NEUROCOLLAB.agents[i].creativity = NEUROCOLLAB.agents[i + 1].creativity;
                        NEUROCOLLAB.agents[i + 1].creativity = tempCreativity;
                    }
                }
                CLI.add("EVOLUTION", "Neural crossover completed");
            }
        };
        
        // ============================================
        // CONTROL PANEL
        // ============================================
        const Control = {
            init() {
                this.updateAgentDisplay();
            },
            
            updateParam(param, value) {
                // Update all agents
                NEUROCOLLAB.agents.forEach(agent => {
                    if (param === 'creativity') agent.creativity = parseInt(value);
                    if (param === 'intelligence') agent.intelligence = parseInt(value);
                    if (param === 'learning') {
                        // Update TensorFlow learning rate
                        TensorFlow.learningRate = parseFloat(value);
                    }
                    if (param === 'collaboration') agent.collaboration = parseInt(value);
                });
                
                // Update display
                document.getElementById(`${param}Value`).textContent = 
                    param === 'learning' ? parseFloat(value).toFixed(3) : `${value}%`;
                
                CLI.add("CONTROL", `${param.charAt(0).toUpperCase() + param.slice(1)} updated`);
            },
            
            updateAgentDisplay() {
                const container = document.getElementById('agentCards');
                if (!container) return;
                
                container.innerHTML = NEUROCOLLAB.agents.map(agent => `
                    <div class="agent-card ${agent.active ? 'active' : ''}" onclick="Control.focusAgent(${agent.id})">
                        <div class="agent-header">
                            <div class="agent-indicator ${agent.active ? 'active' : ''}"></div>
                            <div class="agent-name">${agent.name}</div>
                        </div>
                        <div class="agent-stats">
                            <div>Type: ${agent.type}</div>
                            <div>Creativity: ${agent.creativity}%</div>
                            <div>Intelligence: ${agent.intelligence}%</div>
                            <div>Ideas: ${agent.ideas}</div>
                        </div>
                    </div>
                `).join('');
            },
            
            focusAgent(agentId) {
                const agent = NEUROCOLLAB.agents.find(a => a.id === agentId);
                if (agent) {
                    CLI.add("FOCUS", `Focusing on ${agent.name}`);
                    // Bring appropriate window to front based on agent type
                    if (agent.type === 'creative') WindowManager.agentOpenWindow('paintWindow');
                    else if (agent.type === 'visionary') WindowManager.agentOpenWindow('studioWindow');
                    else if (agent.type === 'analytical') WindowManager.agentOpenWindow('notepadWindow');
                    else WindowManager.agentOpenWindow('cliWindow');
                }
            }
        };
        
        // ============================================
        // TENSORFLOW SIMULATION (Lightweight)
        // ============================================
        const TensorFlow = {
            learningRate: 0.01,
            trainingActive: false,
            trainingInterval: null,
            gradients: [],
            
            simulateTraining() {
                if (this.trainingActive) return;
                
                this.trainingActive = true;
                const trainingStatus = document.getElementById('trainingStatus');
                const trainingBar = document.getElementById('trainingBar');
                
                trainingStatus.classList.add('active');
                CLI.add("TRAINING", "TensorFlow training started (simulated)");
                
                let progress = 0;
                this.trainingInterval = setInterval(() => {
                    progress += 5;
                    trainingBar.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        this.completeTraining();
                    }
                    
                    // Simulate gradient updates
                    NEUROCOLLAB.agents.forEach(agent => {
                        const gradient = (Math.random() - 0.5) * this.learningRate * 10;
                        agent.creativity = Math.max(10, Math.min(100, agent.creativity + gradient));
                        agent.intelligence = Math.max(10, Math.min(100, agent.intelligence + gradient));
                        
                        this.gradients.push({
                            agent: agent.name,
                            gradient,
                            timestamp: Date.now()
                        });
                    });
                    
                    Control.updateAgentDisplay();
                    
                }, 200);
            },
            
            completeTraining() {
                clearInterval(this.trainingInterval);
                this.trainingActive = false;
                
                const trainingStatus = document.getElementById('trainingStatus');
                const trainingBar = document.getElementById('trainingBar');
                
                trainingStatus.classList.remove('active');
                trainingBar.style.width = '0%';
                
                NEUROCOLLAB.stats.trainingCycles++;
                CLI.add("TRAINING", `Training completed. Cycle ${NEUROCOLLAB.stats.trainingCycles}`);
                
                // Save training data to sessionDB
                NEUROCOLLAB.sessionDB.training.push({
                    cycle: NEUROCOLLAB.stats.trainingCycles,
                    gradients: this.gradients.slice(-10), // Keep last 10
                    timestamp: new Date().toISOString()
                });
            },
            
            stopTraining() {
                if (this.trainingInterval) {
                    clearInterval(this.trainingInterval);
                    this.trainingActive = false;
                    
                    const trainingStatus = document.getElementById('trainingStatus');
                    const trainingBar = document.getElementById('trainingBar');
                    
                    trainingStatus.classList.remove('active');
                    trainingBar.style.width = '0%';
                    
                    CLI.add("TRAINING", "Training stopped");
                }
            },
            
            recordVote(agent, vote, content) {
                Inbox.addVote(agent, vote, content);
                
                // Update agent based on vote (simple gradient descent)
                const agentObj = NEUROCOLLAB.agents.find(a => a.name === agent);
                if (agentObj) {
                    if (vote === 'up') {
                        agentObj.creativity = Math.min(100, agentObj.creativity + 1);
                        agentObj.intelligence = Math.min(100, agentObj.intelligence + 1);
                    } else {
                        agentObj.creativity = Math.max(10, agentObj.creativity - 1);
                        agentObj.intelligence = Math.max(10, agentObj.intelligence - 1);
                    }
                    Control.updateAgentDisplay();
                }
            },
            
            getGradientData() {
                return this.gradients;
            },
            
            optimizeModels() {
                CLI.add("OPTIMIZATION", "Optimizing neural models...");
                setTimeout(() => {
                    NEUROCOLLAB.agents.forEach(agent => {
                        agent.creativity = Math.min(100, agent.creativity + 5);
                        agent.intelligence = Math.min(100, agent.intelligence + 5);
                    });
                    CLI.add("OPTIMIZATION", "Models optimized (+5 to all agents)");
                    Control.updateAgentDisplay();
                }, 1000);
            },
            
            exportModels() {
                const models = NEUROCOLLAB.agents.map(agent => ({
                    name: agent.name,
                    creativity: agent.creativity,
                    intelligence: agent.intelligence,
                    collaboration: agent.collaboration,
                    ideas: agent.ideas
                }));
                
                const blob = new Blob([JSON.stringify(models, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neuro_models_${Date.now()}.json`;
                a.click();
                
                CLI.add("EXPORT", "Neural models exported");
            },
            
            mergeAgents() {
                CLI.add("MERGE", "Merging all neural agents into NEURO-MASTER...");
                setTimeout(() => {
                    const merged = {
                        name: "NEURO-MASTER",
                        creativity: NEUROCOLLAB.agents.reduce((s, a) => s + a.creativity, 0) / 4,
                        intelligence: NEUROCOLLAB.agents.reduce((s, a) => s + a.intelligence, 0) / 4,
                        collaboration: NEUROCOLLAB.agents.reduce((s, a) => s + a.collaboration, 0) / 4,
                        totalIdeas: NEUROCOLLAB.agents.reduce((s, a) => s + a.ideas, 0)
                    };
                    
                    CLI.add("MERGE", `Created NEURO-MASTER: Creativity ${merged.creativity.toFixed(1)}%, Intelligence ${merged.intelligence.toFixed(1)}%`);
                    
                    // Save merged agent to sessionDB
                    NEUROCOLLAB.sessionDB.ideas.push({
                        id: Date.now(),
                        agent: "NEURO-MASTER",
                        content: "Merged neural agent created from all 4 agents",
                        type: 'merge',
                        timestamp: new Date().toISOString()
                    });
                    
                    Inbox.refresh();
                }, 2000);
            }
        };
        
        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('DOMContentLoaded', () => {
            NEUROCOLLAB.init();
            
            // Setup keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F1') {
                    e.preventDefault();
                    Agents.startCollaboration();
                }
                if (e.key === 'F2') {
                    e.preventDefault();
                    Agents.stopCollaboration();
                }
                if (e.key === 'F5') {
                    e.preventDefault();
                    NEUROCOLLAB.showExport();
                }
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    NEUROCOLLAB.toggleDarkMode();
                }
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    WindowManager.toggleFullscreen();
                }
                if (e.key === 'Escape') {
                    NEUROCOLLAB.hideExport();
                }
            });
        });
        
        // Make functions globally available
        window.NeuroSystem = NEUROCOLLAB;
        window.WindowManager = WindowManager;
        window.CLI = CLI;
        window.Paint = Paint;
        window.Notepad = Notepad;
        window.Studio = Studio;
        window.Inbox = Inbox;
        window.Agents = Agents;
        window.Control = Control;
        window.TensorFlow = TensorFlow;
    </script>
</body>
</html>