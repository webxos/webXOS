<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXOS CHATBOT</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --neon: #00cc00;
            --jet-black: #000000;
            --dark-panel: #0a0a0a;
            --neural-purple: #8A2BE2;
            --border-color: #1a1a1a;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: var(--jet-black);
            color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow-y: auto;
            height: 100vh;
        }
        
        .cyber-border {
            border: 1px solid var(--border-color);
        }
        
        .cyber-text {
            color: var(--neon);
        }
        
        .neural-text {
            color: var(--neural-purple);
        }
        
        .cyber-bg {
            background: var(--dark-panel);
        }
        
        .terminal-bg {
            background: var(--jet-black);
        }
        
        .neon-btn {
            background: transparent;
            border: 1px solid var(--neon);
            color: var(--neon);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .neon-btn:hover {
            background: var(--neon);
            color: var(--jet-black);
        }
        
        .nav-item {
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .nav-item:hover {
            background: rgba(0, 255, 0, 0.05);
            color: var(--neon);
        }
        
        .nav-item.active {
            background: rgba(0, 255, 0, 0.1);
            color: var(--neon);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 120px;
        }
        
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .user-msg {
            align-self: flex-end;
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        
        .bot-msg {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .suggestion-chip {
            display: inline-block;
            background: rgba(0, 255, 0, 0.05);
            color: var(--neon);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 16px;
            padding: 4px 10px;
            margin: 3px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        
        .suggestion-chip:hover {
            background: rgba(0, 255, 0, 0.1);
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--neon);
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-5px); opacity: 1; }
        }
        
        .progress-bar {
            height: 4px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--neon);
            transition: width 0.3s;
        }
        
        .script-badge {
            display: inline-block;
            background: rgba(138, 43, 226, 0.1);
            color: var(--neural-purple);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .chat-message {
                max-width: 90%;
            }
            
            .chat-container {
                padding-bottom: 140px;
            }
        }
        
        /* Cross-browser scrollbar styling */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #111;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        
        .chat-container {
            scrollbar-width: thin;
            scrollbar-color: #333 #111;
        }
        
        .input-anchor {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--dark-panel);
            border-top: 1px solid var(--border-color);
            z-index: 10;
            padding: 12px;
        }
        
        .bot-suggestions {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .main-content {
            position: relative;
            height: 100%;
            overflow-y: auto;
        }
        
        #chat-section {
            position: relative;
            height: 100%;
            overflow-y: auto;
        }
        
        .script-card {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            background: rgba(20, 20, 20, 0.7);
        }
        
        .copy-btn {
            background: transparent;
            border: 1px solid var(--neural-purple);
            color: var(--neural-purple);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .copy-btn:hover {
            background: var(--neural-purple);
            color: white;
        }
        
        .script-code {
            background: #111;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .script-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .tool-category {
            margin-bottom: 20px;
        }
        
        .context-file {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            background: rgba(20, 20, 20, 0.7);
        }
        
        .context-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .popup-content {
            background: var(--dark-panel);
            border: 1px solid var(--neural-purple);
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .popup-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .popup-body {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }
        
        .popup-close {
            background: transparent;
            border: none;
            color: var(--neural-purple);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .editor-container {
            display: flex;
            height: 500px;
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .editor-sidebar {
            width: 200px;
            background: #1e1e1e;
            border-right: 1px solid #333;
            overflow-y: auto;
        }
        
        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .editor-tabs {
            display: flex;
            background: #2d2d2d;
            border-bottom: 1px solid #333;
        }
        
        .editor-tab {
            padding: 8px 16px;
            background: #2d2d2d;
            border-right: 1px solid #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .editor-tab.active {
            background: #1e1e1e;
        }
        
        .editor-content {
            flex: 1;
            background: #1e1e1e;
            overflow: auto;
        }
        
        .editor-textarea {
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }
        
        .file-tree {
            padding: 8px 0;
        }
        
        .file-item {
            padding: 4px 8px 4px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .file-item.active {
            background: rgba(0, 122, 204, 0.3);
        }
        
        .folder {
            padding-left: 8px;
        }
        
        .folder-header {
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
        }
        
        .folder-content {
            padding-left: 16px;
        }
        
        .hidden {
            display: none;
        }
        
        .link-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 12px 0;
        }
        
        .link-item {
            padding: 8px 12px;
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .link-item:hover {
            background: rgba(0, 255, 0, 0.1);
            border-color: var(--neon);
        }
        
        .link-title {
            font-weight: bold;
            color: var(--neon);
            margin-bottom: 4px;
        }
        
        .link-description {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .tab-close {
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 2px;
            border-radius: 2px;
        }
        
        .tab-close:hover {
            background: rgba(255, 0, 0, 0.2);
            color: #fff;
        }
        
        .minimal-response {
            line-height: 1.5;
        }
        
        .minimal-response ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .minimal-response li {
            margin: 4px 0;
        }
        
        .search-result {
            border-left: 3px solid var(--neural-purple);
            padding-left: 12px;
            margin: 8px 0;
        }
        
        .context-viewer {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px;
            background: rgba(20, 20, 20, 0.8);
        }
        
        .temp-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 6px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .context-suggestion {
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            color: var(--neural-purple);
        }
        
        .context-suggestion:hover {
            background: rgba(138, 43, 226, 0.2);
        }
        
        .script-suggestion {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            color: #ffa500;
        }
        
        .script-suggestion:hover {
            background: rgba(255, 165, 0, 0.2);
        }
    </style>
</head>
<body class="terminal-bg flex flex-col h-screen">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center terminal-bg">
        <div class="cyber-text text-3xl font-bold mb-4">WebXOS CHATBOT</div>
        <div class="neural-text text-lg mb-6" id="loading-text">Initializing Chatbot Interface</div>
        <div class="w-64 h-1 cyber-border rounded-full overflow-hidden">
            <div id="loading-bar" class="h-full bg-green-500" style="width: 0%"></div>
        </div>
        <div class="mt-4 text-gray-400 text-sm" id="loading-subtext">Loading AI Core...</div>
        <button id="loading-dismiss" class="neon-btn mt-6 hidden">Continue Anyway</button>
    </div>

    <!-- Script Library Popup -->
    <div id="script-library-popup" class="popup-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="script-library-title">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="neural-text text-lg font-bold" id="script-library-title">Script Library</h3>
                <button class="popup-close" id="close-script-library" aria-label="Close script library">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <div class="editor-container">
                    <div class="editor-sidebar">
                        <div class="file-tree">
                            <div class="folder-header" id="js-folder-header">
                                <i class="fas fa-folder"></i>
                                <span>JavaScript</span>
                            </div>
                            <div id="js-folder" class="folder-content">
                                <!-- JavaScript files will be populated here -->
                            </div>
                            
                            <div class="folder-header" id="py-folder-header">
                                <i class="fas fa-folder"></i>
                                <span>Python</span>
                            </div>
                            <div id="py-folder" class="folder-content">
                                <!-- Python files will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="editor-main">
                        <div class="editor-tabs" id="script-tabs">
                            <!-- Tabs will be dynamically added here -->
                        </div>
                        <div class="editor-content">
                            <textarea id="script-editor" class="editor-textarea" placeholder="// Write your script here..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-4">
                    <div>
                        <button class="neon-btn" id="new-script-btn">
                            <i class="fas fa-plus mr-1"></i>New Script
                        </button>
                        <button class="neon-btn ml-2" id="save-script-btn">
                            <i class="fas fa-save mr-1"></i>Save Script
                        </button>
                    </div>
                    <div>
                        <button class="neon-btn" id="run-script-btn">
                            <i class="fas fa-play mr-1"></i>Run Script
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Markdown Editor Popup -->
    <div id="markdown-editor-popup" class="popup-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="markdown-editor-title">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="cyber-text text-lg font-bold" id="markdown-editor-title">Edit Markdown File</h3>
                <button class="popup-close" id="close-markdown-editor" aria-label="Close markdown editor">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <div class="mb-4">
                    <input type="text" id="markdown-filename" class="w-full terminal-bg cyber-border text-white p-2 rounded text-sm" placeholder="File name...">
                </div>
                <div class="editor-container">
                    <div class="editor-main">
                        <div class="editor-tabs">
                            <div class="editor-tab active">Markdown Content</div>
                        </div>
                        <div class="editor-content">
                            <textarea id="markdown-editor" class="editor-textarea" placeholder="# Enter your markdown content here..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-4">
                    <div>
                        <button class="neon-btn" id="preview-markdown">
                            <i class="fas fa-eye mr-1"></i>Preview
                        </button>
                    </div>
                    <div>
                        <button class="neon-btn" id="save-markdown">
                            <i class="fas fa-save mr-1"></i>Save File
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Viewer Popup -->
    <div id="context-viewer-popup" class="popup-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="context-viewer-title">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="cyber-text text-lg font-bold" id="context-viewer-title">Context Viewer</h3>
                <button class="popup-close" id="close-context-viewer" aria-label="Close context viewer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="popup-body">
                <div id="context-viewer-content" class="context-viewer">
                    <!-- Context content will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="cyber-bg w-60 cyber-border flex flex-col">
            <div class="p-4 border-b cyber-border">
                <h1 class="cyber-text text-xl font-bold">WebXOS</h1>
                <div class="neural-text text-xs">chatbot v2.0</div>
            </div>
            
            <nav class="flex-1 p-3">
                <div class="nav-item active" data-view="chat">
                    <i class="fas fa-comments w-4"></i>
                    <span>Chatbot</span>
                </div>
                <div class="nav-item" data-view="training">
                    <i class="fas fa-brain w-4"></i>
                    <span>Context Window</span>
                </div>
                <div class="nav-item" data-view="script-library">
                    <i class="fas fa-code w-4"></i>
                    <span>Script Library</span>
                </div>
                <div class="nav-item" data-view="guide">
                    <i class="fas fa-book w-4"></i>
                    <span>System Guide</span>
                </div>
            </nav>
            
            <div class="p-3 border-t cyber-border">
                <div class="text-xs text-gray-400 mb-1">System Status</div>
                <div class="progress-bar mb-1">
                    <div id="system-progress" class="progress-fill" style="width: 75%"></div>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="cyber-text" id="system-status">Ready</span>
                    <span class="neural-text" id="system-percent">75%</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col main-content">
            <!-- Chat Section -->
            <section id="chat-section" class="flex-1 flex flex-col">
                <!-- Chat Header -->
                <div class="cyber-bg p-3 cyber-border flex justify-between items-center">
                    <div>
                        <h2 class="cyber-text text-lg font-bold">Chatbot</h2>
                        <div class="text-xs text-gray-400">Direct Chatbot connection established</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="neon-btn text-sm" id="clear-chat">
                            <i class="fas fa-eraser mr-1"></i>Clear
                        </button>
                        <button class="neon-btn text-sm" id="export-data">
                            <i class="fas fa-download mr-1"></i>Export
                        </button>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div id="chat-container" class="chat-container">
                    <div class="chat-message bot-msg">
                        <div class="cyber-text font-bold mb-2">webXOS Chatbot</div>
                        <div class="mb-3">Connection established. I am your WebXOS assistant with advanced knowledge processing capabilities.</div>
                        <div class="text-gray-400 text-xs">
                            Use command suggestions or type <span class="cyber-text">/help</span> for available commands.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Context Window Section -->
            <section id="training-section" class="hidden flex-1 flex flex-col p-4 overflow-y-auto">
                <h2 class="cyber-text text-xl font-bold mb-3">Context Window</h2>
                <p class="text-gray-400 text-sm mb-4">Upload markdown files to build your context window. All content will be parsed and organized for optimal neural processing.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Status Panel -->
                    <div class="cyber-bg cyber-border p-3 rounded">
                        <h3 class="cyber-text font-bold mb-3">Context Status</h3>
                        <div class="progress-bar mb-3">
                            <div id="training-progress" class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="text-center cyber-text text-2xl font-bold mb-1" id="training-percent">0%</div>
                        <div class="text-center text-gray-400 text-xs mb-3" id="training-status">No context loaded</div>
                        
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="p-2 cyber-border rounded">
                                <div class="text-xs text-gray-400">Files</div>
                                <div class="cyber-text text-lg font-bold" id="stat-packs">0</div>
                            </div>
                            <div class="p-2 cyber-border rounded">
                                <div class="text-xs text-gray-400">Chunks</div>
                                <div class="cyber-text text-lg font-bold" id="stat-chunks">0</div>
                            </div>
                            <div class="p-2 cyber-border rounded">
                                <div class="text-xs text-gray-400">Scripts</div>
                                <div class="cyber-text text-lg font-bold" id="stat-scripts">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upload Panel -->
                    <div class="cyber-bg cyber-border p-3 rounded">
                        <h3 class="cyber-text font-bold mb-3">Upload Context</h3>
                        <div id="drop-zone" class="border border-dashed cyber-border rounded p-4 text-center cursor-pointer transition-all hover:bg-green-900/5">
                            <i class="fas fa-cloud-upload-alt cyber-text text-2xl mb-2"></i>
                            <p class="cyber-text text-sm">Drop .md files or click to browse</p>
                            <p class="text-gray-400 text-xs mt-1">.md, .markdown, .mdx files supported</p>
                            <input type="file" id="file-input" class="hidden" multiple accept=".md,.markdown,.mdx">
                        </div>
                        
                        <div class="mt-3 flex gap-2">
                            <button id="train-btn" class="neon-btn flex-1 text-sm" disabled>
                                <i class="fas fa-cogs mr-1"></i>Process Files
                            </button>
                            <button id="clear-files" class="neon-btn text-sm">
                                <i class="fas fa-times mr-1"></i>Clear
                            </button>
                            <button id="new-markdown" class="neon-btn text-sm">
                                <i class="fas fa-plus mr-1"></i>New
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="cyber-text text-sm font-bold mb-2">Context Files</h4>
                            <div id="pack-list" class="max-h-32 overflow-y-auto space-y-1">
                                <div class="text-gray-500 text-xs p-1 text-center">No files loaded</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scripts Panel -->
                    <div class="cyber-bg cyber-border p-3 rounded">
                        <h3 class="cyber-text font-bold mb-3">Extracted Scripts</h3>
                        <div id="script-list" class="max-h-64 overflow-y-auto space-y-1">
                            <div class="text-gray-500 text-xs p-1 text-center">No scripts extracted</div>
                        </div>
                    </div>
                </div>
                
                <!-- Context Files List -->
                <div class="mt-6">
                    <h3 class="cyber-text text-lg font-bold mb-3">Context Window Files</h3>
                    <div id="context-files-list" class="space-y-3">
                        <!-- Context files will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Script Library Section -->
            <section id="script-library-section" class="hidden flex-1 flex flex-col p-4 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="cyber-text text-xl font-bold">Script Library</h2>
                        <p class="text-gray-400 text-sm">Manage and execute JavaScript and Python scripts in a secure environment.</p>
                    </div>
                    <button class="neon-btn" id="open-script-library">
                        <i class="fas fa-external-link-alt mr-1"></i>Open Library
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="cyber-bg cyber-border p-3 rounded">
                        <h3 class="neural-text font-bold mb-3">Active Script</h3>
                        <div id="active-script-container">
                            <div class="text-gray-500 text-sm p-4 text-center">No active script selected</div>
                        </div>
                    </div>
                    
                    <div class="cyber-bg cyber-border p-3 rounded">
                        <h3 class="neural-text font-bold mb-3">Script Output</h3>
                        <div id="script-output" class="h-64 overflow-y-auto p-3 cyber-border rounded text-sm font-mono">
                            <div class="text-gray-500 text-center">Script output will appear here</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h3 class="neural-text text-lg font-bold mb-3">Available Scripts</h3>
                    <div id="script-library-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        <!-- Scripts will be populated here -->
                    </div>
                </div>
            </section>

            <!-- Guide Section -->
            <section id="guide-section" class="hidden flex-1 flex flex-col p-4 overflow-y-auto">
                <h2 class="cyber-text text-xl font-bold mb-3">WebXOS System Guide</h2>
                
                <div class="cyber-bg cyber-border p-4 rounded mb-4">
                    <h3 class="cyber-text font-bold mb-3">System Overview</h3>
                    <p class="mb-3 text-sm">WebXOS CHATBOT is an advanced neural interface with four main components: Neural Chat, Context Window, Script Library, and this System Guide.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div class="p-3 cyber-border rounded">
                            <h4 class="cyber-text font-bold mb-2 text-sm">Core Components</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs">
                                <li><span class="cyber-text">Chatbott</span> - Interactive interface with the AI</li>
                                <li><span class="cyber-text">Context Window</span> - Knowledge base from markdown files</li>
                                <li><span class="neural-text">Script Library</span> - VS Code-like script editor and executor</li>
                                <li><span class="cyber-text">System Guide</span> - Comprehensive documentation</li>
                            </ul>
                        </div>
                        
                        <div class="p-3 cyber-border rounded">
                            <h4 class="neural-text font-bold mb-2 text-sm">Chatbot Commands</h4>
                            <ul class="list-disc pl-4 space-y-1 text-xs">
                                <li><code>/help</code> - Display system commands</li>
                                <li><code>/context</code> - List context window files</li>
                                <li><code>/scripts</code> - Show available scripts</li>
                                <li><code>/clear</code> - Reset conversation</li>
                                <li><code>/status</code> - System diagnostics</li>
                            </ul>
                        </div>
                    </div>
                    
                    <h4 class="cyber-text font-bold mb-2 text-sm">Getting Started</h4>
                    <ol class="list-decimal pl-4 space-y-1 text-sm">
                        <li>Use the <span class="cyber-text">Context Window</span> tab to upload markdown files</li>
                        <li>Ask questions about your uploaded content in the <span class="cyber-text">Chatbot</span></li>
                        <li>Create and execute scripts in the <span class="neural-text">Script Library</span></li>
                        <li>Use command suggestions to explore system capabilities</li>
                    </ol>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="cyber-bg cyber-border p-4 rounded">
                        <h4 class="cyber-text font-bold mb-3">Context Window</h4>
                        <p class="text-xs mb-3">The Context Window is your knowledge base where all markdown files are parsed and organized.</p>
                        <ul class="list-disc pl-4 space-y-1 text-xs">
                            <li>Upload markdown files with your content</li>
                            <li>Files are automatically parsed and enhanced</li>
                            <li>Content is organized using ** and ## headings</li>
                            <li>Edit individual files for better organization</li>
                            <li>Export your context window for backup</li>
                        </ul>
                    </div>
                    
                    <div class="cyber-bg cyber-border p-4 rounded">
                        <h4 class="neural-text font-bold mb-3">Script Library</h4>
                        <p class="text-xs mb-3">The Script Library provides a VS Code-like environment for creating and executing scripts.</p>
                        <ul class="list-disc pl-4 space-y-1 text-xs">
                            <li>Create JavaScript and Python scripts</li>
                            <li>File system organization for scripts</li>
                            <li>One active script at a time for execution</li>
                            <li>Popup window for complex scripts</li>
                            <li>Direct integration with chat suggestions</li>
                        </ul>
                    </div>
                    
                    <div class="cyber-bg cyber-border p-4 rounded">
                        <h4 class="cyber-text font-bold mb-3">Chatbot Processing</h4>
                        <p class="text-xs mb-3">The chatbot uses advanced processing to understand and respond to your queries.</p>
                        <ul class="list-disc pl-4 space-y-1 text-xs">
                            <li>Context Window provides knowledge base</li>
                            <li>Script Library offers execution capabilities</li>
                            <li>Chatbot suggests relevant topics and scripts</li>
                            <li>All processing happens locally in your browser</li>
                            <li>No data is sent to external servers</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="cyber-bg cyber-border p-3 rounded text-center">
                        <i class="fas fa-shield-alt cyber-text text-xl mb-1"></i>
                        <h4 class="cyber-text font-bold text-sm">100% Local</h4>
                        <p class="text-xs text-gray-400 mt-1">No data leaves your browser</p>
                    </div>
                    
                    <div class="cyber-bg cyber-border p-3 rounded text-center">
                        <i class="fas fa-bolt neural-text text-xl mb-1"></i>
                        <h4 class="neural-text font-bold text-sm">Fast Response</h4>
                        <p class="text-xs text-gray-400 mt-1">Neural-speed processing</p>
                    </div>
                    
                    <div class="cyber-bg cyber-border p-3 rounded text-center">
                        <i class="fas fa-infinity cyber-text text-xl mb-1"></i>
                        <h4 class="cyber-text font-bold text-sm">Expandable</h4>
                        <p class="text-xs text-gray-400 mt-1">Unlimited knowledge capacity</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Fixed Input Area -->
    <div class="input-anchor">
        <div class="flex gap-2">
            <input 
                type="text" 
                id="user-input" 
                class="flex-1 terminal-bg cyber-border text-white p-2 rounded text-sm focus:outline-none focus:border-green-500" 
                placeholder="Enter neural command or query..."
            />
            <button id="send-btn" class="neon-btn text-sm">
                <i class="fas fa-paper-plane mr-1"></i>Send
            </button>
        </div>
    </div>

    <script>
        // Core System Objects
        const WebXOS = {
            // System State
            state: {
                view: 'chat',
                contextFiles: [],
                chunks: [],
                scripts: [],
                activeScript: null,
                conversations: [],
                trainingProgress: 0,
                pyodide: null,
                pyodideLoaded: false,
                builtinScripts: [],
                scriptFiles: {
                    javascript: [],
                    python: []
                },
                openTabs: new Map(),
                currentTab: null,
                searchIndex: new Map(),
                contextSuggestions: []
            },
            
            // Initialize the system
            async init() {
                try {
                    console.log('Starting WebXOS initialization...');
                    // Show loading screen
                    this.showLoadingScreen();
                    
                    // Load saved data
                    this.loadData();
                    
                    // Initialize Pyodide (non-blocking)
                    this.initPyodideAsync();
                    
                    // Set up UI
                    this.setupUI();
                    
                    // Initialize built-in scripts
                    this.initBuiltinScripts();
                    
                    // Build search index
                    this.buildSearchIndex();
                    
                    // Hide loading screen after a brief delay
                    setTimeout(() => {
                        console.log('WebXOS initialization complete');
                        document.getElementById('loading-screen').style.display = 'none';
                        this.updateSystemStatus('Ready', 100);
                        this.showWelcomeMessage();
                    }, 2000);
                } catch (error) {
                    console.error('Initialization error:', error);
                    document.getElementById('loading-text').textContent = 'Initialization Error';
                    document.getElementById('loading-subtext').textContent = 'Check console for details';
                    document.getElementById('loading-dismiss').classList.remove('hidden');
                }
            },
            
            // Initialize built-in scripts
            initBuiltinScripts() {
                // Clear existing scripts to avoid duplicates
                this.state.scripts = this.state.scripts.filter(s => !s.builtin);
                this.state.scriptFiles.javascript = [];
                this.state.scriptFiles.python = [];
                
                this.state.builtinScripts = [
                    {
                        id: 'calc-basic',
                        title: 'Basic Calculator',
                        description: 'Perform basic arithmetic operations',
                        capabilities: ['calculate', 'math', 'arithmetic', 'calculator'],
                        language: 'javascript',
                        code: `// Basic Calculator\nfunction calculate(expression) {\n    try {\n        return eval(expression);\n    } catch (error) {\n        return "Error: " + error.message;\n    }\n}`,
                        builtin: true
                    },
                    {
                        id: 'calc-scientific',
                        title: 'Scientific Calculator',
                        description: 'Advanced math functions including trigonometry and logarithms',
                        capabilities: ['scientific', 'trigonometry', 'logarithms', 'math', 'calculate'],
                        language: 'python',
                        code: `import math\n\ndef scientific_calc(operation, *args):\n    try:\n        if operation == 'sin': return math.sin(args[0])\n        elif operation == 'cos': return math.cos(args[0])\n        elif operation == 'tan': return math.tan(args[0])\n        elif operation == 'log': return math.log(args[0])\n        elif operation == 'sqrt': return math.sqrt(args[0])\n        else: return "Unknown operation"\n    except Exception as e: return f"Error: {str(e)}"`,
                        builtin: true
                    },
                    {
                        id: 'ds-statistics',
                        title: 'Basic Statistics',
                        description: 'Calculate mean, median, mode, standard deviation',
                        capabilities: ['statistics', 'data analysis', 'mean', 'median', 'standard deviation'],
                        language: 'python',
                        code: `def calculate_statistics(data):\n    import statistics\n    return {\n        'mean': statistics.mean(data),\n        'median': statistics.median(data),\n        'mode': statistics.mode(data),\n        'stdev': statistics.stdev(data)\n    }`,
                        builtin: true
                    },
                    {
                        id: 'util-unit-converter',
                        title: 'Unit Converter',
                        description: 'Convert between different units of measurement',
                        capabilities: ['conversion', 'units', 'measurement', 'calculator'],
                        language: 'javascript',
                        code: `function convertUnits(value, fromUnit, toUnit) {\n    const conversions = {\n        'meter-kilometer': 0.001,\n        'kilometer-meter': 1000,\n        'celsius-fahrenheit': (c) => c * 9/5 + 32,\n        'fahrenheit-celsius': (f) => (f - 32) * 5/9\n    };\n    const key = fromUnit + '-' + toUnit;\n    return conversions[key] ? \n        (typeof conversions[key] === 'function' ? conversions[key](value) : value * conversions[key]) : \n        'Unsupported conversion';\n}`,
                        builtin: true
                    }
                ];
                
                // Add built-in scripts to the main scripts list
                this.state.builtinScripts.forEach(script => {
                    if (!this.state.scripts.find(s => s.id === script.id)) {
                        this.state.scripts.push(script);
                    }
                });
                
                // Add built-in scripts to script files
                this.state.builtinScripts.forEach(script => {
                    this.state.scriptFiles[script.language === 'python' ? 'python' : 'javascript'].push({
                        id: script.id,
                        name: script.title + (script.language === 'python' ? '.py' : '.js'),
                        content: script.code,
                        builtin: true
                    });
                });
                
                this.saveData();
                this.renderScriptLibraryPage();
            },
            
            // Build search index for context and scripts
            buildSearchIndex() {
                this.state.searchIndex.clear();
                this.state.contextSuggestions = [];
                
                // Index context files
                this.state.contextFiles.forEach(file => {
                    const words = this.extractKeywords(file.content + ' ' + file.name);
                    words.forEach(word => {
                        if (!this.state.searchIndex.has(word)) {
                            this.state.searchIndex.set(word, []);
                        }
                        this.state.searchIndex.get(word).push({
                            type: 'context',
                            id: file.id,
                            name: file.name,
                            content: file.content,
                            relevance: 1
                        });
                    });
                    
                    // Extract headers and key phrases for suggestions
                    this.extractContextSuggestions(file);
                });
                
                // Index scripts
                this.state.scripts.forEach(script => {
                    const words = this.extractKeywords(script.title + ' ' + script.description + ' ' + script.capabilities.join(' '));
                    words.forEach(word => {
                        if (!this.state.searchIndex.has(word)) {
                            this.state.searchIndex.set(word, []);
                        }
                        this.state.searchIndex.get(word).push({
                            type: 'script',
                            id: script.id,
                            name: script.title,
                            description: script.description,
                            capabilities: script.capabilities,
                            relevance: 1
                        });
                    });
                });
                
                // Index guide content
                const guideKeywords = ['help', 'guide', 'tutorial', 'documentation', 'context', 'script', 'library', 'chat', 'training', 'system', 'webxos', 'neural', 'interface'];
                guideKeywords.forEach(word => {
                    if (!this.state.searchIndex.has(word)) {
                        this.state.searchIndex.set(word, []);
                    }
                    this.state.searchIndex.get(word).push({
                        type: 'guide',
                        name: 'System Guide',
                        description: 'Complete documentation for WebXOS',
                        relevance: 0.8
                    });
                });
            },
            
            // Extract headers and key phrases from context files for suggestions
            extractContextSuggestions(file) {
                const content = file.content;
                
                // Extract headers (## and ** patterns)
                const headerRegex = /(#{2,}\s+.+)|(\*\*.+\*\*)/g;
                let match;
                
                while ((match = headerRegex.exec(content)) !== null) {
                    const header = match[0].trim();
                    if (header.length > 5 && header.length < 100) {
                        this.state.contextSuggestions.push({
                            text: `Tell me about: ${header.replace(/#{2,}\s+|\*\*/g, '')}`,
                            action: 'message',
                            content: `Tell me about ${header.replace(/#{2,}\s+|\*\*/g, '')} from the context`,
                            type: 'context',
                            fileId: file.id
                        });
                    }
                }
                
                // Extract key phrases (sentences with important terms)
                const sentences = content.split(/[.!?]+/);
                sentences.forEach(sentence => {
                    const trimmed = sentence.trim();
                    if (trimmed.length > 20 && trimmed.length < 150) {
                        // Check if sentence contains important terms
                        const importantTerms = ['important', 'key', 'essential', 'critical', 'main', 'primary', 'fundamental'];
                        const hasImportantTerm = importantTerms.some(term => 
                            trimmed.toLowerCase().includes(term)
                        );
                        
                        if (hasImportantTerm || trimmed.includes('**')) {
                            const question = `What does the context say about: ${trimmed.substring(0, 50)}...`;
                            this.state.contextSuggestions.push({
                                text: question,
                                action: 'message',
                                content: question,
                                type: 'context',
                                fileId: file.id
                            });
                        }
                    }
                });
                
                // Remove duplicates
                this.state.contextSuggestions = this.state.contextSuggestions.filter((s, i, arr) => 
                    i === arr.findIndex(t => t.text === s.text)
                );
            },
            
            // Extract keywords from text
            extractKeywords(text) {
                return text.toLowerCase()
                    .replace(/[^\w\s]/g, '')
                    .split(/\s+/)
                    .filter(word => word.length > 2)
                    .filter((word, index, arr) => arr.indexOf(word) === index); // Remove duplicates
            },
            
            // Search across all content
            searchContent(query) {
                const keywords = this.extractKeywords(query);
                const results = new Map();
                
                keywords.forEach(keyword => {
                    if (this.state.searchIndex.has(keyword)) {
                        this.state.searchIndex.get(keyword).forEach(item => {
                            const key = `${item.type}-${item.id || item.name}`;
                            if (!results.has(key)) {
                                results.set(key, { ...item, score: 0 });
                            }
                            results.get(key).score += item.relevance;
                        });
                    }
                });
                
                return Array.from(results.values())
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10); // Return top 10 results
            },
            
            // Show loading screen with progress
            showLoadingScreen() {
                const steps = [
                    'Initializing Neural Core...',
                    'Loading Memory Matrix...',
                    'Establishing Secure Connection...',
                    'Calibrating Response Systems...',
                    'WebXOS Ready'
                ];
                
                let step = 0;
                const interval = setInterval(() => {
                    if (step < steps.length) {
                        document.getElementById('loading-text').textContent = steps[step];
                        const progress = (step + 1) * 20;
                        document.getElementById('loading-bar').style.width = `${progress}%`;
                        this.updateSystemStatus(steps[step], progress);
                        step++;
                    } else {
                        clearInterval(interval);
                    }
                }, 300);
            },
            
            // Initialize Pyodide asynchronously
            async initPyodideAsync() {
                try {
                    this.updateSystemStatus('Loading Python Runtime', 30);
                    // Note: Pyodide loading is commented out for now to avoid external dependencies
                    // this.state.pyodide = await loadPyodide({
                    //     indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.1/full/"
                    // });
                    // await this.state.pyodide.loadPackage("micropip");
                    // this.state.pyodideLoaded = true;
                    this.state.pyodideLoaded = false; // Set to false since we're not loading Pyodide
                    this.updateSystemStatus('Python Runtime Ready', 80);
                    console.log('Pyodide initialization simulated');
                } catch (error) {
                    console.error('Pyodide initialization failed:', error);
                    this.updateSystemStatus('Python Runtime Failed', 80);
                }
            },
            
            // Load data from localStorage
            loadData() {
                try {
                    const data = JSON.parse(localStorage.getItem('webxos-data') || '{}');
                    this.state.contextFiles = data.contextFiles || [];
                    this.state.chunks = data.chunks || [];
                    this.state.scripts = data.scripts || [];
                    this.state.activeScript = data.activeScript || null;
                    this.state.conversations = data.conversations || [];
                    this.state.scriptFiles = data.scriptFiles || {
                        javascript: [],
                        python: []
                    };
                    console.log('Loaded data:', this.state);
                } catch (e) {
                    console.error('Error loading data:', e);
                }
                
                this.updateStats();
            },
            
            // Save data to localStorage
            saveData() {
                try {
                    localStorage.setItem('webxos-data', JSON.stringify({
                        contextFiles: this.state.contextFiles,
                        chunks: this.state.chunks,
                        scripts: this.state.scripts,
                        activeScript: this.state.activeScript,
                        conversations: this.state.conversations,
                        scriptFiles: this.state.scriptFiles
                    }));
                } catch (e) {
                    console.error('Error saving data:', e);
                }
            },
            
            // Update system status display
            updateSystemStatus(status, percent) {
                const statusEl = document.getElementById('system-status');
                const percentEl = document.getElementById('system-percent');
                const progressEl = document.getElementById('system-progress');
                
                if (statusEl) statusEl.textContent = status;
                if (percentEl) percentEl.textContent = `${percent}%`;
                if (progressEl) progressEl.style.width = `${percent}%`;
            },
            
            // Set up UI event listeners
            setupUI() {
                console.log('Setting up UI event listeners...');
                
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.navigate(item.dataset.view);
                    });
                });
                
                // Chat input
                document.getElementById('send-btn').addEventListener('click', () => {
                    this.sendMessage();
                });
                
                document.getElementById('user-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
                
                // Clear chat
                document.getElementById('clear-chat').addEventListener('click', () => {
                    document.getElementById('chat-container').innerHTML = '';
                    this.showWelcomeMessage();
                });
                
                // Export data
                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportContextWindow();
                });
                
                // File upload
                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');
                
                if (dropZone) {
                    dropZone.addEventListener('click', () => {
                        fileInput.click();
                    });
                    
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.style.background = 'rgba(0, 255, 0, 0.05)';
                    });
                    
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.style.background = '';
                    });
                    
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.style.background = '';
                        this.handleFiles(e.dataTransfer.files);
                    });
                }
                
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        this.handleFiles(e.target.files);
                    });
                }
                
                // Train button
                const trainBtn = document.getElementById('train-btn');
                if (trainBtn) {
                    trainBtn.addEventListener('click', () => {
                        this.processFiles();
                    });
                }
                
                // Clear files
                const clearFilesBtn = document.getElementById('clear-files');
                if (clearFilesBtn) {
                    clearFilesBtn.addEventListener('click', () => {
                        if (fileInput) fileInput.value = '';
                        if (trainBtn) trainBtn.disabled = true;
                    });
                }
                
                // New markdown button
                document.getElementById('new-markdown').addEventListener('click', () => {
                    this.openMarkdownEditor();
                });
                
                // Script Library popup
                document.getElementById('open-script-library').addEventListener('click', () => {
                    this.openScriptLibrary();
                });
                
                document.getElementById('close-script-library').addEventListener('click', () => {
                    this.closeScriptLibrary();
                });
                
                document.getElementById('new-script-btn').addEventListener('click', () => {
                    this.newScript();
                });
                
                document.getElementById('save-script-btn').addEventListener('click', () => {
                    this.saveScript();
                });
                
                document.getElementById('run-script-btn').addEventListener('click', () => {
                    this.runScriptFromEditor();
                });
                
                // Markdown editor popup
                document.getElementById('close-markdown-editor').addEventListener('click', () => {
                    this.closeMarkdownEditor();
                });
                
                document.getElementById('save-markdown').addEventListener('click', () => {
                    this.saveMarkdownFile();
                });
                
                document.getElementById('preview-markdown').addEventListener('click', () => {
                    this.previewMarkdown();
                });
                
                // Context viewer popup
                document.getElementById('close-context-viewer').addEventListener('click', () => {
                    this.closeContextViewer();
                });
                
                // Folder toggles
                document.getElementById('js-folder-header').addEventListener('click', () => {
                    this.toggleFolder('js-folder');
                });
                
                document.getElementById('py-folder-header').addEventListener('click', () => {
                    this.toggleFolder('py-folder');
                });
                
                // Loading screen dismiss
                document.getElementById('loading-dismiss').addEventListener('click', () => {
                    document.getElementById('loading-screen').style.display = 'none';
                    this.updateSystemStatus('Ready', 100);
                    this.showWelcomeMessage();
                });
                
                // Initial UI updates
                this.updateStats();
                this.renderContextFiles();
                this.renderScriptLibraryPage();
                
                console.log('UI setup complete');
            },
            
            // Navigate between sections
            navigate(view) {
                console.log('Navigating to:', view);
                // Hide all sections
                const sections = ['chat', 'training', 'script-library', 'guide'];
                sections.forEach(section => {
                    const el = document.getElementById(`${section}-section`);
                    if (el) el.classList.add('hidden');
                });
                
                // Show selected section
                const targetSection = document.getElementById(`${view}-section`);
                if (targetSection) targetSection.classList.remove('hidden');
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeNav = document.querySelector(`.nav-item[data-view="${view}"]`);
                if (activeNav) activeNav.classList.add('active');
                
                // Update state
                this.state.view = view;
                
                // Special handling for script library section
                if (view === 'script-library') {
                    this.renderScriptLibraryPage();
                }
            },
            
            // Show welcome message
            showWelcomeMessage() {
                console.log('Showing welcome message');
                const welcomeMsg = `
                    <div class="chat-message bot-msg">
                        <div class="cyber-text font-bold mb-2">WebXOS Neural Interface Active</div>
                        <div class="mb-3">Neural connection established. I am your WebXOS assistant with advanced knowledge processing capabilities.</div>
                        
                        <div class="mb-3">
                            <div class="text-gray-400 text-xs mb-1">SYSTEM STATUS:</div>
                            <div class="grid grid-cols-2 gap-1 text-xs">
                                <div>Context Window: <span class="cyber-text">${this.state.contextFiles.length > 0 ? 'LOADED' : 'EMPTY'}</span></div>
                                <div>Script Engine: <span class="neural-text">${this.state.pyodideLoaded ? 'ONLINE' : 'OFFLINE'}</span></div>
                                <div>Memory Units: <span class="cyber-text">${this.state.chunks.length}</span></div>
                                <div>Available Scripts: <span class="neural-text">${this.state.scripts.length}</span></div>
                            </div>
                        </div>
                        
                        ${this.state.contextFiles.length === 0 ? `
                            <div class="p-2 cyber-border rounded mb-2">
                                <div class="cyber-text font-bold mb-1 text-sm">CONTEXT WINDOW EMPTY</div>
                                <div class="text-xs">Use the <span class="cyber-text">Context Window</span> tab to upload markdown files and build your neural knowledge base.</div>
                            </div>
                        ` : ''}
                        
                        <div class="text-gray-400 text-xs">
                            Use command suggestions or type <span class="cyber-text">/help</span> for available commands.
                        </div>
                    </div>
                `;
                
                const chatContainer = document.getElementById('chat-container');
                if (chatContainer) {
                    // Clear existing messages and add welcome message
                    chatContainer.innerHTML = welcomeMsg;
                    this.addSuggestionsToMessage(this.getWelcomeSuggestions());
                }
            },
            
            // Get welcome suggestions based on current state
            getWelcomeSuggestions() {
                const baseSuggestions = [
                    { text: 'Upload context files', action: 'navigate', target: 'training' },
                    { text: 'How does this work?', action: 'message', content: 'Can you explain how WebXOS works?' },
                    { text: 'Show available commands', action: 'message', content: '/help' },
                    { text: 'View script library', action: 'navigate', target: 'script-library' },
                    { text: 'Check system status', action: 'message', content: '/status' },
                    { text: 'View system guide', action: 'navigate', target: 'guide' }
                ];
                
                if (this.state.contextFiles.length > 0) {
                    baseSuggestions.unshift(
                        { text: 'Ask about my context', action: 'message', content: 'What can you tell me about your context window?' }
                    );
                    
                    // Add context-specific suggestions
                    const contextSuggestions = this.state.contextSuggestions.slice(0, 3);
                    baseSuggestions.push(...contextSuggestions);
                }
                
                // Add script suggestions
                if (this.state.scripts.length > 0) {
                    // Add "View Script Library" if not already there
                    if (!baseSuggestions.some(s => s.text === 'View script library')) {
                        baseSuggestions.push({ text: 'View script library', action: 'navigate', target: 'script-library' });
                    }
                    
                    // Add script run suggestions
                    const scriptSuggestions = this.getScriptSuggestions().slice(0, 3);
                    baseSuggestions.push(...scriptSuggestions);
                }
                
                return baseSuggestions;
            },
            
            // Get script suggestions for the chat
            getScriptSuggestions() {
                return this.state.scripts.map(script => ({
                    text: `Run: ${script.title}`,
                    action: 'runScript',
                    target: script.id,
                    type: 'script'
                }));
            },
            
            // Add suggestions to the last bot message
            addSuggestionsToMessage(suggestions) {
                const chatContainer = document.getElementById('chat-container');
                if (!chatContainer || !suggestions) return;
                
                const lastMessage = chatContainer.lastElementChild;
                if (!lastMessage) return;
                
                const suggestionsHtml = `
                    <div class="bot-suggestions">
                        <div class="text-gray-400 text-xs mb-1">QUICK ACTIONS:</div>
                        <div class="flex flex-wrap">
                            ${suggestions.map(s => `
                                <div class="suggestion-chip ${s.type === 'context' ? 'context-suggestion' : s.type === 'script' ? 'script-suggestion' : ''}" data-action="${s.action}" data-target="${s.target || s.content || ''}">
                                    ${s.text}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                lastMessage.innerHTML += suggestionsHtml;
                
                // Add event listeners to suggestion chips
                lastMessage.querySelectorAll('.suggestion-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        const target = e.target.dataset.target;
                        this.handleSuggestion(action, target);
                    });
                });
            },
            
            // Handle suggestion clicks
            handleSuggestion(action, value) {
                console.log('Handling suggestion:', action, value);
                switch(action) {
                    case 'navigate':
                        this.navigate(value);
                        break;
                    case 'message':
                        document.getElementById('user-input').value = value;
                        this.sendMessage();
                        break;
                    case 'runScript':
                        this.runScript(value);
                        break;
                    case 'viewContext':
                        this.viewContextFile(value);
                        break;
                }
            },
            
            // Add a message to the chat
            addMessage(text, sender = 'user') {
                const container = document.getElementById('chat-container');
                if (!container) return;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender === 'user' ? 'user-msg' : 'bot-msg'}`;
                messageDiv.innerHTML = text;
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            },
            
            // Send a message
            async sendMessage() {
                const input = document.getElementById('user-input');
                if (!input) return;
                
                const message = input.value.trim();
                if (!message) return;
                
                // Add user message
                this.addMessage(message, 'user');
                input.value = '';
                
                // Show typing indicator
                this.showTypingIndicator();
                
                // Process the message
                setTimeout(async () => {
                    // Remove typing indicator
                    this.hideTypingIndicator();
                    
                    let response;
                    
                    // Check if it's a command
                    if (message.startsWith('/')) {
                        response = this.processCommand(message);
                    } else {
                        response = await this.processQuery(message);
                    }
                    
                    // Add bot response
                    this.addMessage(response.message, 'bot');
                    
                    // Add suggestions to the response
                    if (response.suggestions) {
                        this.addSuggestionsToMessage(response.suggestions);
                    }
                    
                    // Save conversation
                    this.state.conversations.push({
                        user: message,
                        bot: response.message,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.saveData();
                }, 800 + Math.random() * 800);
            },
            
            // Show typing indicator
            showTypingIndicator() {
                const container = document.getElementById('chat-container');
                if (!container) return;
                
                const indicator = document.createElement('div');
                indicator.className = 'chat-message bot-msg';
                indicator.id = 'typing-indicator';
                indicator.innerHTML = `
                    <div class="typing-indicator">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="ml-2 cyber-text text-sm">Processing neural input...</span>
                    </div>
                `;
                container.appendChild(indicator);
                container.scrollTop = container.scrollHeight;
            },
            
            // Hide typing indicator
            hideTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            },
            
            // Process a command
            processCommand(command) {
                const cmd = command.toLowerCase().trim();
                
                if (cmd === '/help') {
                    return {
                        message: this.createMinimalResponse(`
                            <div class="cyber-text font-bold mb-2">Available Commands</div>
                            <ul>
                                <li><strong>/help</strong> - Show this command list</li>
                                <li><strong>/context</strong> - List context window files</li>
                                <li><strong>/scripts</strong> - Show available scripts</li>
                                <li><strong>/status</strong> - System diagnostics</li>
                                <li><strong>/clear</strong> - Reset system</li>
                                <li><strong>/run [script-id]</strong> - Run a specific script</li>
                            </ul>
                        `),
                        suggestions: [
                            { text: 'List context files', action: 'message', content: '/context' },
                            { text: 'Show scripts', action: 'message', content: '/scripts' },
                            { text: 'System status', action: 'message', content: '/status' },
                            { text: 'View script library', action: 'navigate', target: 'script-library' }
                        ]
                    };
                } else if (cmd === '/context') {
                    if (this.state.contextFiles.length === 0) {
                        return {
                            message: this.createMinimalResponse('No context files loaded. Use the Context Window tab to upload markdown files.'),
                            suggestions: [
                                { text: 'Go to Context Window', action: 'navigate', target: 'training' },
                                { text: 'How to add context?', action: 'message', content: 'What kind of files can I upload?' }
                            ]
                        };
                    }
                    
                    const contextLinks = this.state.contextFiles.map(file => ({
                        title: file.name,
                        description: `${file.content.length} characters`,
                        action: 'viewContext',
                        target: file.id
                    }));
                    
                    return {
                        message: this.createLinkList('Context Window Files', contextLinks),
                        suggestions: [
                            { text: 'Upload more files', action: 'navigate', target: 'training' },
                            { text: 'Ask about context', action: 'message', content: 'Tell me about your knowledge' }
                        ]
                    };
                } else if (cmd === '/scripts') {
                    if (this.state.scripts.length === 0) {
                        return {
                            message: this.createMinimalResponse('No scripts available. Add code blocks to markdown files or create scripts in the Script Library.'),
                            suggestions: [
                                { text: 'Go to Script Library', action: 'navigate', target: 'script-library' },
                                { text: 'How to add scripts?', action: 'message', content: 'How do I add executable scripts?' }
                            ]
                        };
                    }
                    
                    const scriptLinks = this.state.scripts.map(script => ({
                        title: script.title,
                        description: `${script.language}  ${script.capabilities.join(', ')}`,
                        action: 'runScript',
                        target: script.id
                    }));
                    
                    return {
                        message: this.createLinkList('Available Scripts', scriptLinks),
                        suggestions: [
                            { text: 'Open Script Library', action: 'navigate', target: 'script-library' },
                            { text: 'Back to chat', action: 'message', content: 'Hello' }
                        ]
                    };
                } else if (cmd === '/status' || cmd === '/metrics') {
                    return {
                        message: this.createMinimalResponse(`
                            <div class="cyber-text font-bold mb-2">System Diagnostics</div>
                            <ul>
                                <li><strong>Context Files:</strong> ${this.state.contextFiles.length}</li>
                                <li><strong>Memory Chunks:</strong> ${this.state.chunks.length}</li>
                                <li><strong>Available Scripts:</strong> ${this.state.scripts.length}</li>
                                <li><strong>Python Runtime:</strong> ${this.state.pyodideLoaded ? 'ONLINE' : 'OFFLINE'}</li>
                                <li><strong>Active Script:</strong> ${this.state.activeScript ? this.state.activeScript.title : 'None'}</li>
                            </ul>
                        `),
                        suggestions: [
                            { text: 'Upload context', action: 'navigate', target: 'training' },
                            { text: 'View scripts', action: 'message', content: '/scripts' }
                        ]
                    };
                } else if (cmd === '/clear') {
                    this.clearSystem();
                    return {
                        message: this.createMinimalResponse('System cleared. Context window and script library reset to defaults.'),
                        suggestions: this.getWelcomeSuggestions()
                    };
                } else if (cmd.startsWith('/run')) {
                    const scriptId = command.split(' ')[1];
                    if (scriptId) {
                        const script = this.state.scripts.find(s => s.id === scriptId);
                        if (script) {
                            this.runScript(scriptId);
                            return {
                                message: this.createMinimalResponse(`Running script: <span class="neural-text">${script.title}</span>`),
                                suggestions: [
                                    { text: 'Run another script', action: 'message', content: '/scripts' },
                                    { text: 'View script library', action: 'navigate', target: 'script-library' }
                                ]
                            };
                        } else {
                            return {
                                message: this.createMinimalResponse(`Script with ID "${scriptId}" not found. Use /scripts to see available scripts.`),
                                suggestions: [
                                    { text: 'Show scripts', action: 'message', content: '/scripts' },
                                    { text: 'View script library', action: 'navigate', target: 'script-library' }
                                ]
                            };
                        }
                    } else {
                        return {
                            message: this.createMinimalResponse('Please specify a script ID. Use /scripts to list available scripts.'),
                            suggestions: [
                                { text: 'Show scripts', action: 'message', content: '/scripts' },
                                { text: 'View script library', action: 'navigate', target: 'script-library' }
                            ]
                        };
                    }
                } else {
                    return {
                        message: this.createMinimalResponse(`Unknown command: ${command}. Type <span class="cyber-text">/help</span> for available commands.`),
                        suggestions: [
                            { text: 'Show commands', action: 'message', content: '/help' },
                            { text: 'Go to Context Window', action: 'navigate', target: 'training' }
                        ]
                    };
                }
            },
            
            // Process a query using enhanced search
            async processQuery(query) {
                // If no context is loaded, provide a helpful response
                if (this.state.contextFiles.length === 0) {
                    return {
                        message: this.createMinimalResponse(`
                            <div class="cyber-text font-bold mb-2">Context Window Empty</div>
                            <p>I don't have any context loaded yet. To use my RAG capabilities:</p>
                            <ol>
                                <li>Go to the <strong>Context Window</strong> tab</li>
                                <li>Upload markdown files with your content</li>
                                <li>Process the files to build the context window</li>
                                <li>Return here and ask questions about your content</li>
                            </ol>
                            <p class="mt-2">In the meantime, I can execute scripts or answer general questions.</p>
                        `),
                        suggestions: [
                            { text: 'Upload context files', action: 'navigate', target: 'training' },
                            { text: 'Show available scripts', action: 'message', content: '/scripts' }
                        ]
                    };
                }
                
                // Enhanced search across all content
                const searchResults = this.searchContent(query);
                
                let response = '';
                
                if (searchResults.length > 0) {
                    // Group results by type
                    const contextResults = searchResults.filter(r => r.type === 'context');
                    const scriptResults = searchResults.filter(r => r.type === 'script');
                    const guideResults = searchResults.filter(r => r.type === 'guide');
                    
                    if (contextResults.length > 0) {
                        const contextLinks = contextResults.map(result => ({
                            title: result.name,
                            description: `Context file (relevance: ${result.score.toFixed(2)})`,
                            action: 'viewContext',
                            target: result.id
                        }));
                        response += this.createLinkList('Relevant Context Files', contextLinks);
                    }
                    
                    if (scriptResults.length > 0) {
                        const scriptLinks = scriptResults.map(result => ({
                            title: result.name,
                            description: `${result.capabilities.join(', ')} (relevance: ${result.score.toFixed(2)})`,
                            action: 'runScript',
                            target: result.id
                        }));
                        response += this.createLinkList('Matching Scripts', scriptLinks);
                    }
                    
                    if (guideResults.length > 0) {
                        response += this.createMinimalResponse(`
                            <div class="cyber-text font-bold mb-2">System Guide</div>
                            <p>I found relevant information in the system guide. Check the Guide tab for complete documentation.</p>
                        `);
                    }
                }
                
                // Add general response
                response += this.createMinimalResponse(`
                    <div class="cyber-text font-bold mb-2">Neural Response</div>
                    <p>Based on my context window, I found ${searchResults.length} relevant items about "${this.escapeHtml(query)}".</p>
                    <p class="text-xs text-gray-400 mt-1">Click any link above to view details or run scripts.</p>
                `);
                
                const scriptSuggestions = searchResults
                    .filter(r => r.type === 'script')
                    .slice(0, 3)
                    .map(result => ({
                        text: `Run ${result.name}`,
                        action: 'runScript',
                        target: result.id,
                        type: 'script'
                    }));
                
                const contextSuggestions = searchResults
                    .filter(r => r.type === 'context')
                    .slice(0, 2)
                    .map(result => ({
                        text: `View ${result.name}`,
                        action: 'viewContext',
                        target: result.id
                    }));
                
                // Get context-based suggestions for the query
                const querySuggestions = this.getContextSuggestionsForQuery(query);
                
                // Always include script library suggestion
                const scriptLibrarySuggestion = { 
                    text: 'View Script Library', 
                    action: 'navigate', 
                    target: 'script-library' 
                };
                
                const generalSuggestions = [
                    { text: 'Ask another question', action: 'message', content: 'What else can you tell me?' },
                    { text: 'List all context', action: 'message', content: '/context' },
                    { text: 'Upload more files', action: 'navigate', target: 'training' }
                ];
                
                return {
                    message: response,
                    suggestions: [...scriptSuggestions, ...contextSuggestions, ...querySuggestions, scriptLibrarySuggestion, ...generalSuggestions]
                };
            },
            
            // Get context-based suggestions for a query
            getContextSuggestionsForQuery(query) {
                const keywords = this.extractKeywords(query);
                const suggestions = [];
                
                // Find context suggestions that match the query keywords
                this.state.contextSuggestions.forEach(suggestion => {
                    const suggestionKeywords = this.extractKeywords(suggestion.text);
                    const hasMatch = keywords.some(keyword => 
                        suggestionKeywords.includes(keyword)
                    );
                    
                    if (hasMatch) {
                        suggestions.push(suggestion);
                    }
                });
                
                // If no direct matches, return some random context suggestions
                if (suggestions.length === 0 && this.state.contextSuggestions.length > 0) {
                    const randomIndices = new Set();
                    while (randomIndices.size < 3 && randomIndices.size < this.state.contextSuggestions.length) {
                        randomIndices.add(Math.floor(Math.random() * this.state.contextSuggestions.length));
                    }
                    
                    randomIndices.forEach(index => {
                        suggestions.push(this.state.contextSuggestions[index]);
                    });
                }
                
                return suggestions.slice(0, 3);
            },
            
            // Create minimal response format
            createMinimalResponse(content) {
                return `<div class="minimal-response">${content}</div>`;
            },
            
            // Create link list for minimal responses
            createLinkList(title, items) {
                const linksHtml = items.map(item => `
                    <div class="link-item" data-action="${item.action}" data-target="${item.target}">
                        <div class="link-title">${this.escapeHtml(item.title)}</div>
                        <div class="link-description">${this.escapeHtml(item.description)}</div>
                    </div>
                `).join('');
                
                const html = `
                    <div class="minimal-response">
                        <div class="cyber-text font-bold mb-2">${title}</div>
                        <div class="link-list">
                            ${linksHtml}
                        </div>
                    </div>
                `;
                
                // Add event listeners after inserting
                setTimeout(() => {
                    document.querySelectorAll('.link-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            const action = e.currentTarget.dataset.action;
                            const target = e.currentTarget.dataset.target;
                            this.handleSuggestion(action, target);
                        });
                    });
                }, 100);
                
                return html;
            },
            
            // Handle file uploads
            handleFiles(files) {
                let hasMarkdown = false;
                
                for (let i = 0; i < files.length; i++) {
                    if (files[i].name.match(/\.(md|markdown|mdx)$/i)) {
                        hasMarkdown = true;
                        break;
                    }
                }
                
                const trainBtn = document.getElementById('train-btn');
                if (trainBtn && hasMarkdown) {
                    trainBtn.disabled = false;
                }
            },
            
            // Process uploaded files
            async processFiles() {
                const fileInput = document.getElementById('file-input');
                if (!fileInput) return;
                
                const files = fileInput.files;
                if (files.length === 0) return;
                
                const trainBtn = document.getElementById('train-btn');
                if (trainBtn) {
                    trainBtn.disabled = true;
                    trainBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Processing...';
                }
                
                let processed = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if (!file.name.match(/\.(md|markdown|mdx)$/i)) continue;
                    
                    try {
                        const content = await this.readFile(file);
                        const contextFile = {
                            id: this.generateId(),
                            name: file.name,
                            content: content,
                            enhancedContent: this.enhanceMarkdown(content)
                        };
                        
                        // Process the context file
                        await this.processContextFile(contextFile);
                        processed++;
                        
                        // Update progress
                        const progress = (i + 1) / files.length * 100;
                        this.updateTrainingProgress(progress, `Processed ${i + 1}/${files.length} files`);
                    } catch (error) {
                        console.error(`Error processing file ${file.name}:`, error);
                    }
                }
                
                if (trainBtn) {
                    trainBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Complete';
                }
                
                // Update UI
                this.updateStats();
                this.renderContextFiles();
                this.renderScriptLibraryPage();
                
                // Rebuild search index
                this.buildSearchIndex();
                
                // Show completion message
                setTimeout(() => {
                    if (trainBtn) {
                        trainBtn.innerHTML = '<i class="fas fa-cogs mr-1"></i>Process Files';
                    }
                    this.addMessage(this.createMinimalResponse(`Successfully processed ${processed} context file(s). Context window updated.`), 'bot');
                    this.addSuggestionsToMessage([
                        { text: 'Ask about new content', action: 'message', content: 'What can you tell me about the new context?' },
                        { text: 'View context files', action: 'message', content: '/context' },
                        { text: 'View Script Library', action: 'navigate', target: 'script-library' }
                    ]);
                }, 1000);
            },
            
            // Read a file as text
            readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(e);
                    reader.readAsText(file);
                });
            },
            
            // Enhance markdown content with proper formatting
            enhanceMarkdown(content) {
                // Add headings for sections that don't have them
                let enhanced = content;
                
                // Ensure proper use of ** for emphasis
                enhanced = enhanced.replace(/\*\*(.*?)\*\*/g, '**$1**');
                
                // Ensure proper use of ## for headings
                const lines = enhanced.split('\n');
                let inParagraph = false;
                let paragraphLines = [];
                const processedLines = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line.startsWith('#') || line === '') {
                        // If we were building a paragraph, add it as a section
                        if (inParagraph && paragraphLines.length > 0) {
                            processedLines.push('## ' + paragraphLines[0].substring(0, 50) + '...');
                            processedLines.push(...paragraphLines);
                            processedLines.push('');
                            inParagraph = false;
                            paragraphLines = [];
                        }
                        
                        processedLines.push(line);
                    } else if (line.length > 0) {
                        // Start or continue a paragraph
                        if (!inParagraph) {
                            inParagraph = true;
                        }
                        paragraphLines.push(line);
                    }
                }
                
                // Add any remaining paragraph as a section
                if (inParagraph && paragraphLines.length > 0) {
                    processedLines.push('## ' + paragraphLines[0].substring(0, 50) + '...');
                    processedLines.push(...paragraphLines);
                }
                
                return processedLines.join('\n');
            },
            
            // Process a context file
            async processContextFile(contextFile) {
                // Add to context files
                this.state.contextFiles.push(contextFile);
                
                // Extract scripts
                this.extractScripts(contextFile);
                
                // Create chunks (simplified for demo)
                const chunks = this.createChunks(contextFile.enhancedContent, contextFile.id);
                this.state.chunks = this.state.chunks.concat(chunks);
                
                // Save data
                this.saveData();
            },
            
            // Extract scripts from markdown content
            extractScripts(contextFile) {
                const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
                let match;
                
                while ((match = codeBlockRegex.exec(contextFile.content)) !== null) {
                    const language = match[1] || 'javascript';
                    const code = match[2].trim();
                    
                    // Extract metadata from comments
                    const titleMatch = code.match(/(?:\/\/|#)\s*title:\s*(.+)/i);
                    const descMatch = code.match(/(?:\/\/|#)\s*description:\s*(.+)/i);
                    const capsMatch = code.match(/(?:\/\/|#)\s*capabilities:\s*(.+)/i);
                    
                    const title = titleMatch ? titleMatch[1].trim() : `Script from ${contextFile.name}`;
                    const description = descMatch ? descMatch[1].trim() : '';
                    const capabilities = capsMatch ? 
                        capsMatch[1].split(',').map(c => c.trim()).filter(c => c) : 
                        [];
                    
                    const script = {
                        id: this.generateId(),
                        title: title,
                        description: description,
                        capabilities: capabilities,
                        language: language.toLowerCase(),
                        code: code,
                        contextFileId: contextFile.id
                    };
                    
                    this.state.scripts.push(script);
                    
                    // Add to script files
                    const fileExtension = script.language === 'python' ? '.py' : '.js';
                    this.state.scriptFiles[script.language].push({
                        id: script.id,
                        name: script.title + fileExtension,
                        content: script.code
                    });
                }
            },
            
            // Create text chunks from content
            createChunks(content, contextFileId) {
                const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 0);
                const chunks = [];
                
                // Simple chunking by sentences
                for (let i = 0; i < sentences.length; i += 3) {
                    const chunkSentences = sentences.slice(i, i + 3);
                    if (chunkSentences.length > 0) {
                        chunks.push({
                            id: this.generateId(),
                            text: chunkSentences.join('. ') + '.',
                            contextFileId: contextFileId
                        });
                    }
                }
                
                return chunks;
            },
            
            // Run a script
            async runScript(scriptId) {
                const script = this.state.scripts.find(s => s.id === scriptId);
                if (!script) return;
                
                this.addMessage(`Executing: <span class="cyber-text">${this.escapeHtml(script.title)}</span>`, 'user');
                this.showTypingIndicator();
                
                setTimeout(async () => {
                    this.hideTypingIndicator();
                    
                    let result;
                    if (script.language.includes('python')) {
                        result = await this.runPythonScript(script.code);
                    } else {
                        result = this.runJavaScriptScript(script.code);
                    }
                    
                    const outputHtml = `
                        <div class="minimal-response">
                            <div class="cyber-text font-bold mb-1">${this.escapeHtml(script.title)}</div>
                            <div class="text-xs text-gray-400 mb-1">Language: ${script.language}</div>
                            <pre class="p-2 cyber-border rounded overflow-x-auto text-xs ${result.success ? 'text-green-400' : 'text-red-400'}">${this.escapeHtml(result.output)}</pre>
                        </div>
                    `;
                    
                    this.addMessage(outputHtml, 'bot');
                    
                    // Add suggestions after script execution
                    this.addSuggestionsToMessage([
                        { text: 'Run another script', action: 'message', content: '/scripts' },
                        { text: 'View Script Library', action: 'navigate', target: 'script-library' },
                        { text: 'Ask a question', action: 'message', content: 'What can you help me with?' }
                    ]);
                }, 1000);
            },
            
            // Run a Python script
            async runPythonScript(code) {
                if (!this.state.pyodideLoaded || !this.state.pyodide) {
                    return { success: false, output: 'Python runtime not available' };
                }
                
                try {
                    // In a real implementation, this would use Pyodide
                    // For now, return a simulated response
                    return { success: true, output: 'Script execution simulated (Python runtime not loaded)' };
                } catch (error) {
                    return { success: false, output: error.message };
                }
            },
            
            // Run a JavaScript script
            runJavaScriptScript(code) {
                try {
                    // Safe execution with restricted access
                    const unsafePatterns = /(alert|prompt|confirm|document|window|fetch|XMLHttpRequest|eval|Function|import|require|localStorage|indexedDB)/;
                    if (unsafePatterns.test(code)) {
                        return { success: false, output: 'Script contains potentially unsafe operations' };
                    }
                    
                    let output = '';
                    const originalLog = console.log;
                    console.log = (...args) => {
                        output += args.map(arg => 
                            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                        ).join(' ') + '\n';
                    };
                    
                    let result;
                    try {
                        const fn = new Function(code);
                        result = fn();
                        if (result !== undefined) {
                            output += String(result);
                        }
                    } catch (error) {
                        result = `Error: ${error.message}`;
                    }
                    
                    console.log = originalLog;
                    
                    return { 
                        success: true, 
                        output: output || 'Script executed successfully (no output)' 
                    };
                } catch (error) {
                    return { success: false, output: `JavaScript Error: ${error.message}` };
                }
            },
            
            // Update training progress
            updateTrainingProgress(percent, status) {
                const progressEl = document.getElementById('training-progress');
                const percentEl = document.getElementById('training-percent');
                const statusEl = document.getElementById('training-status');
                
                if (progressEl) progressEl.style.width = `${percent}%`;
                if (percentEl) percentEl.textContent = `${Math.round(percent)}%`;
                if (statusEl) statusEl.textContent = status;
            },
            
            // Update statistics
            updateStats() {
                const packsEl = document.getElementById('stat-packs');
                const chunksEl = document.getElementById('stat-chunks');
                const scriptsEl = document.getElementById('stat-scripts');
                
                if (packsEl) packsEl.textContent = this.state.contextFiles.length;
                if (chunksEl) chunksEl.textContent = this.state.chunks.length;
                if (scriptsEl) scriptsEl.textContent = this.state.scripts.length;
                
                // Calculate overall progress
                const progress = Math.min(
                    this.state.contextFiles.length * 20 + 
                    this.state.chunks.length / 10 + 
                    this.state.scripts.length * 5, 
                    100
                );
                
                this.updateTrainingProgress(progress, 
                    this.state.contextFiles.length === 0 ? 'No context loaded' : 
                    progress < 30 ? 'Basic context' :
                    progress < 70 ? 'Moderate context' :
                    'Comprehensive context'
                );
            },
            
            // Render context files list
            renderContextFiles() {
                const container = document.getElementById('context-files-list');
                if (!container) return;
                
                if (this.state.contextFiles.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm p-4 text-center">No context files loaded</div>';
                    return;
                }
                
                container.innerHTML = this.state.contextFiles.map(file => {
                    const safeId = this.escapeHtml(file.id);
                    const safeName = this.escapeHtml(file.name);
                    const safePreview = this.escapeHtml(file.enhancedContent.substring(0, 100));
                    
                    return `
                    <div class="context-file">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold cyber-text text-sm">${safeName}</div>
                                <div class="text-xs text-gray-400 mb-1">${file.content.length} characters</div>
                            </div>
                            <span class="script-badge">Enhanced</span>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-2">
                            Preview: ${safePreview}...
                        </div>
                        
                        <div class="context-actions">
                            <button class="neon-btn text-xs" data-action="view" data-id="${safeId}">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                            <button class="neon-btn text-xs" data-action="edit" data-id="${safeId}">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button class="neon-btn text-xs" data-action="delete" data-id="${safeId}">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `}).join('');
                
                // Add event listeners for context actions
                container.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fileId = e.target.closest('button').dataset.id;
                        this.viewContextFile(fileId);
                    });
                });
                
                container.querySelectorAll('[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fileId = e.target.closest('button').dataset.id;
                        this.editContextFile(fileId);
                    });
                });
                
                container.querySelectorAll('[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const fileId = e.target.closest('button').dataset.id;
                        this.deleteContextFile(fileId);
                    });
                });
            },
            
            // Toggle folder visibility
            toggleFolder(folderId) {
                const folder = document.getElementById(folderId);
                if (folder) {
                    folder.classList.toggle('hidden');
                }
            },
            
            // Close a tab
            closeTab(fileId) {
                const tab = document.querySelector(`.editor-tab[data-file="${fileId}"]`);
                if (tab) {
                    tab.remove();
                }
                this.state.openTabs.delete(fileId);
                
                // If we closed the current tab, switch to another one
                if (this.state.currentTab === fileId) {
                    const remainingTabs = Array.from(this.state.openTabs.keys());
                    if (remainingTabs.length > 0) {
                        this.switchToTab(remainingTabs[0]);
                    } else {
                        this.newScript();
                    }
                }
            },
            
            // Switch to a tab
            switchToTab(fileId) {
                const tab = document.querySelector(`.editor-tab[data-file="${fileId}"]`);
                if (tab) {
                    document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    this.state.currentTab = fileId;
                    
                    const file = this.state.scriptFiles.javascript.find(f => f.id === fileId) || 
                                 this.state.scriptFiles.python.find(f => f.id === fileId);
                    if (file) {
                        document.getElementById('script-editor').value = file.content;
                    }
                }
            },
            
            // Open context viewer
            openContextViewer(fileId) {
                const file = this.state.contextFiles.find(f => f.id === fileId);
                if (!file) return;
                
                document.getElementById('context-viewer-title').textContent = file.name;
                document.getElementById('context-viewer-content').innerHTML = `
                    <pre class="text-sm">${this.escapeHtml(file.enhancedContent)}</pre>
                `;
                document.getElementById('context-viewer-popup').classList.remove('hidden');
            },
            
            // Close context viewer
            closeContextViewer() {
                document.getElementById('context-viewer-popup').classList.add('hidden');
            },
            
            // View context file
            viewContextFile(fileId) {
                this.openContextViewer(fileId);
            },
            
            // Edit context file
            editContextFile(fileId) {
                this.openMarkdownEditor(fileId);
            },
            
            // Delete context file
            deleteContextFile(fileId) {
                const file = this.state.contextFiles.find(f => f.id === fileId);
                if (!file) return;
                
                if (confirm(`Are you sure you want to delete "${file.name}"?`)) {
                    this.state.contextFiles = this.state.contextFiles.filter(f => f.id !== fileId);
                    this.state.chunks = this.state.chunks.filter(c => c.contextFileId !== fileId);
                    this.state.scripts = this.state.scripts.filter(s => s.contextFileId !== fileId);
                    this.saveData();
                    this.updateStats();
                    this.renderContextFiles();
                    this.renderScriptLibraryPage();
                    this.buildSearchIndex();
                    this.addMessage(this.createMinimalResponse(`Context file "${file.name}" deleted successfully.`), 'bot');
                }
            },
            
            // Export context window
            exportContextWindow() {
                const data = {
                    contextFiles: this.state.contextFiles,
                    exportDate: new Date().toISOString(),
                    version: 'WebXOS v2.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'webxos-context-window.json';
                a.click();
                URL.revokeObjectURL(url);
                
                this.addMessage(this.createMinimalResponse('Context window exported successfully.'), 'bot');
            },
            
            // Clear system
            clearSystem() {
                if (confirm('Are you sure you want to clear the entire system? This will reset the context window and script library.')) {
                    this.state.contextFiles = [];
                    this.state.chunks = [];
                    this.state.scripts = [];
                    this.state.activeScript = null;
                    this.state.conversations = [];
                    this.state.scriptFiles = {
                        javascript: [],
                        python: []
                    };
                    
                    // Reinitialize with built-in scripts only
                    this.initBuiltinScripts();
                    this.buildSearchIndex();
                    
                    this.saveData();
                    this.updateStats();
                    this.renderContextFiles();
                    this.renderScriptLibraryPage();
                }
            },
            
            // Open markdown editor
            openMarkdownEditor(fileId = null) {
                const popup = document.getElementById('markdown-editor-popup');
                const filenameInput = document.getElementById('markdown-filename');
                const editor = document.getElementById('markdown-editor');
                
                if (fileId) {
                    const file = this.state.contextFiles.find(f => f.id === fileId);
                    if (file) {
                        filenameInput.value = file.name;
                        editor.value = file.content;
                    }
                } else {
                    filenameInput.value = '';
                    editor.value = '';
                }
                
                popup.classList.remove('hidden');
            },
            
            // Close markdown editor
            closeMarkdownEditor() {
                document.getElementById('markdown-editor-popup').classList.add('hidden');
            },
            
            // Save markdown file
            saveMarkdownFile() {
                const filename = document.getElementById('markdown-filename').value.trim();
                const content = document.getElementById('markdown-editor').value;
                
                if (!filename) {
                    alert('Please enter a filename');
                    return;
                }
                
                const fileId = this.generateId();
                const contextFile = {
                    id: fileId,
                    name: filename,
                    content: content,
                    enhancedContent: this.enhanceMarkdown(content)
                };
                
                this.state.contextFiles.push(contextFile);
                this.processContextFile(contextFile);
                
                this.saveData();
                this.updateStats();
                this.renderContextFiles();
                this.buildSearchIndex();
                
                this.closeMarkdownEditor();
                this.addMessage(this.createMinimalResponse(`Markdown file "${filename}" saved successfully.`), 'bot');
            },
            
            // Preview markdown
            previewMarkdown() {
                const content = document.getElementById('markdown-editor').value;
                alert('Markdown preview would show here. Content length: ' + content.length + ' characters');
            },
            
            // Open script library
            openScriptLibrary() {
                document.getElementById('script-library-popup').classList.remove('hidden');
                this.renderScriptLibrary();
            },
            
            // Close script library
            closeScriptLibrary() {
                document.getElementById('script-library-popup').classList.add('hidden');
            },
            
            // New script
            newScript() {
                const fileId = this.generateId();
                const newFile = {
                    id: fileId,
                    name: 'new-script.js',
                    content: '// Write your script here',
                    language: 'javascript'
                };
                
                this.state.scriptFiles.javascript.push(newFile);
                this.renderScriptLibrary();
                this.switchToTab(fileId);
            },
            
            // Save script
            saveScript() {
                const editor = document.getElementById('script-editor');
                const content = editor.value;
                
                if (this.state.currentTab) {
                    let file = this.state.scriptFiles.javascript.find(f => f.id === this.state.currentTab);
                    if (!file) {
                        file = this.state.scriptFiles.python.find(f => f.id === this.state.currentTab);
                    }
                    
                    if (file) {
                        file.content = content;
                        this.saveData();
                        this.showTempMessage('Script saved successfully', 'success');
                    }
                }
            },
            
            // Run script from editor
            runScriptFromEditor() {
                const editor = document.getElementById('script-editor');
                const content = editor.value;
                
                // Create a temporary script object
                const tempScript = {
                    id: 'temp',
                    title: 'Editor Script',
                    language: 'javascript',
                    code: content
                };
                
                this.addMessage(`Executing: <span class="cyber-text">Editor Script</span>`, 'user');
                this.showTypingIndicator();
                
                setTimeout(() => {
                    this.hideTypingIndicator();
                    
                    const result = this.runJavaScriptScript(content);
                    
                    const outputHtml = `
                        <div class="minimal-response">
                            <div class="cyber-text font-bold mb-1">Editor Script</div>
                            <div class="text-xs text-gray-400 mb-1">Language: JavaScript</div>
                            <pre class="p-2 cyber-border rounded overflow-x-auto text-xs ${result.success ? 'text-green-400' : 'text-red-400'}">${this.escapeHtml(result.output)}</pre>
                        </div>
                    `;
                    
                    this.addMessage(outputHtml, 'bot');
                }, 1000);
            },
            
            // Render script library
            renderScriptLibrary() {
                const jsFolder = document.getElementById('js-folder');
                const pyFolder = document.getElementById('py-folder');
                
                // Clear existing content
                jsFolder.innerHTML = '';
                pyFolder.innerHTML = '';
                
                // Add JavaScript files
                this.state.scriptFiles.javascript.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.fileId = file.id;
                    fileItem.innerHTML = `
                        <i class="fas fa-file-code"></i>
                        <span>${file.name}</span>
                    `;
                    
                    fileItem.addEventListener('click', () => {
                        this.switchToTab(file.id);
                    });
                    
                    jsFolder.appendChild(fileItem);
                });
                
                // Add Python files
                this.state.scriptFiles.python.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.fileId = file.id;
                    fileItem.innerHTML = `
                        <i class="fas fa-file-code"></i>
                        <span>${file.name}</span>
                    `;
                    
                    fileItem.addEventListener('click', () => {
                        this.switchToTab(file.id);
                    });
                    
                    pyFolder.appendChild(fileItem);
                });
            },
            
            // Render script library page
            renderScriptLibraryPage() {
                const container = document.getElementById('script-library-list');
                if (!container) return;
                
                if (this.state.scripts.length === 0) {
                    container.innerHTML = '<div class="text-gray-500 text-sm p-4 text-center">No scripts available</div>';
                    return;
                }
                
                container.innerHTML = this.state.scripts.map(script => {
                    const safeId = this.escapeHtml(script.id);
                    const safeTitle = this.escapeHtml(script.title);
                    const safeDescription = this.escapeHtml(script.description);
                    const safeCapabilities = this.escapeHtml(script.capabilities.join(', '));
                    
                    return `
                    <div class="script-card">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold neural-text text-sm">${safeTitle}</div>
                                <div class="text-xs text-gray-400 mb-1">${safeDescription}</div>
                            </div>
                            <span class="script-badge">${script.language}</span>
                        </div>
                        
                        <div class="text-xs text-gray-400 mb-2">
                            Capabilities: ${safeCapabilities}
                        </div>
                        
                        <div class="script-actions">
                            <button class="neon-btn text-xs" data-action="run" data-id="${safeId}">
                                <i class="fas fa-play mr-1"></i>Run
                            </button>
                            <button class="neon-btn text-xs" data-action="view" data-id="${safeId}">
                                <i class="fas fa-code mr-1"></i>View Code
                            </button>
                        </div>
                    </div>
                `}).join('');
                
                // Add event listeners for script actions
                container.querySelectorAll('[data-action="run"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const scriptId = e.target.closest('button').dataset.id;
                        this.runScript(scriptId);
                    });
                });
                
                container.querySelectorAll('[data-action="view"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const scriptId = e.target.closest('button').dataset.id;
                        const script = this.state.scripts.find(s => s.id === scriptId);
                        if (script) {
                            alert(`Code for ${script.title}:\n\n${script.code}`);
                        }
                    });
                });
            },
            
            // Show temporary message
            showTempMessage(message, type = 'info') {
                const tempMsg = document.createElement('div');
                tempMsg.className = `temp-message ${type === 'success' ? 'bg-green-900 text-green-100' : 'bg-blue-900 text-blue-100'}`;
                tempMsg.textContent = message;
                
                document.body.appendChild(tempMsg);
                
                setTimeout(() => {
                    tempMsg.remove();
                }, 3000);
            },
            
            // Utility functions
            generateId() {
                return 'id-' + Math.random().toString(36).substr(2, 9);
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Initialize the system when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing WebXOS...');
            WebXOS.init();
        });

        // Auto-hide loading screen after timeout as fallback
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen && loadingScreen.style.display !== 'none') {
                loadingScreen.style.display = 'none';
                WebXOS.updateSystemStatus('Ready', 100);
                WebXOS.showWelcomeMessage();
            }
        }, 10000);
    </script>
</body>
</html>
