<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WEBXOS CHATBOT â€” Full Knowledge Reader</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
  <style>
    :root{
      --neon:#39FF14; --g0:#0a2e0a; --g1:#051905; --blk:#000; --d0:#111; --d1:#1a1a1a; --d2:#333;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%}
    body{background:var(--blk);color:#ddd;font-family:Inter,system-ui,Segoe UI,Tahoma,Arial,sans-serif;margin:0;overflow:hidden}
    .logo{color:var(--neon);font-weight:700;letter-spacing:.5px;text-shadow:0 0 6px var(--neon)}
    .sidebar{width:260px;background:var(--d0);border-right:1px solid var(--d2);position:fixed;height:100vh;z-index:10}
    .nav-item{padding:12px;border-radius:6px;margin-bottom:6px;cursor:pointer;transition:.2s;display:flex;align-items:center}
    .nav-item:hover{background:var(--d1);color:var(--neon)}
    .nav-item.active{background:var(--g0);color:var(--neon);box-shadow:0 0 8px var(--neon)}
    .main{flex:1;background:var(--blk);position:relative;margin-left:260px;height:100vh;display:flex;flex-direction:column}
    .chat-message{margin:6px 10px;padding:10px 12px;border-radius:8px;max-width:85%;border:1px solid var(--d2);line-height:1.45;word-wrap:break-word}
    .user{margin-left:auto;background:var(--g0);color:var(--neon);border-color:var(--neon)}
    .bot{background:var(--d0)}
    .btn{border:1px solid var(--d2);border-radius:6px;padding:8px 12px;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;justify-content:center;font-size:0.875rem}
    .btn-primary{background:var(--g0);color:var(--neon);border-color:var(--neon)}
    .btn-primary:hover{background:var(--neon);color:var(--blk);box-shadow:0 0 8px var(--neon)}
    .btn-secondary:hover{border-color:var(--neon);color:var(--neon)}
    .panel{background:var(--d0);border:1px solid var(--d2);border-radius:10px}
    .progress{height:10px;background:var(--d0);border-radius:7px;overflow:hidden}
    .bar{height:100%;background:var(--neon);width:0;transition:width .3s}
    .chip{display:inline-flex;align-items:center;background:var(--g0);color:var(--neon);border:1px solid var(--neon);border-radius:20px;padding:4px 10px;font-size:.78rem;margin:2px;cursor:pointer;transition:all 0.2s}
    .chip:hover{background:var(--neon);color:var(--blk)}
    .neon{color:var(--neon);text-shadow:0 0 6px var(--neon)}
    .upload{border:2px dashed var(--neon);border-radius:10px;padding:18px;text-align:center;cursor:pointer;transition:all 0.3s}
    .upload:hover{background:var(--g0)}
    .compact{line-height:1.32}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:.84rem}
    .kbd{background:#000;border:1px solid var(--d2);border-radius:4px;padding:2px 5px;font-family:monospace}
    
    /* Chat header */
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--d2);
      background: var(--d0);
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .header-left {
      flex: 1;
      min-width: 200px;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    /* Modal styles */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:60;padding:16px}
    .modal{width:min(1000px,92vw);max-height:82vh;overflow:hidden;background:var(--d0);border:1px solid var(--d2);border-radius:12px;box-shadow:0 0 14px rgba(57,255,20,.25);display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--d2)}
    .modal-body{display:flex;gap:12px;padding:12px;flex:1;overflow:hidden}
    .modal-footer{display:flex;justify-content:flex-end;gap:8px;padding:10px;border-top:1px solid var(--d2)}
    .list{width:260px;overflow:auto;border-right:1px solid var(--d2)}
    .list-item{padding:8px;border-radius:6px;margin:4px;cursor:pointer}
    .list-item:hover{background:var(--d1)}
    .list-item.active{background:var(--g0);color:var(--neon)}
    .editor{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .editor-toolbar{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
    .editor-textarea{flex:1;resize:none;background:var(--blk);color:#e5e5e5;border:1px solid var(--d2);border-radius:8px;padding:10px;min-height:200px}
    .script-editor{flex:1;min-height:300px;resize:none;background:var(--blk);color:#e5e5e5;border:1px solid var(--d2);border-radius:8px;padding:10px;font-family:monospace}
    .pill{display:inline-flex;align-items:center;padding:3px 8px;border:1px solid var(--d2);border-radius:14px;font-size:.72rem;color:#aaa}
    .help{color:#999}
    .loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--blk);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column}
    .loading-screen.hidden{display:none}
    .dropdown{position:relative;display:inline-block}
    .dropdown-content{display:none;position:absolute;background:var(--d0);min-width:160px;box-shadow:0 8px 16px rgba(0,0,0,.2);z-index:100;border:1px solid var(--neon);border-radius:5px;max-height:200px;overflow-y:auto;padding:4px 0;right:0}
    .dropdown-content a{color:var(--neon);padding:8px 12px;text-decoration:none;display:block;cursor:pointer;font-size:.85rem;line-height:1.2}
    .dropdown-content a:hover{background:var(--d1)}
    .show{display:block}
    .typing-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--neon);margin:0 2px;animation:typing 1.4s infinite ease-in-out}
    .typing-dot:nth-child(1){animation-delay:0s}
    .typing-dot:nth-child(2){animation-delay:.2s}
    .typing-dot:nth-child(3){animation-delay:.4s}
    @keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-10px)}}
    .terminal-command{color:var(--neon);font-weight:bold}
    .hidden{display:none!important}
    .script-output{background:var(--blk);border:1px solid var(--d2);border-radius:5px;padding:10px;margin-top:10px;font-family:monospace;white-space:pre-wrap;max-height:200px;overflow-y:auto}
    .script-output.success{border-color:var(--neon)}
    .script-output.error{border-color:#ff4444}
    .script-template{background:var(--d1);border:1px solid var(--d2);border-radius:8px;padding:12px;margin:8px 0;cursor:pointer;transition:all .3s}
    .script-template:hover{background:var(--g0);border-color:var(--neon)}
    .script-template pre{background:var(--blk);padding:8px;border-radius:4px;overflow-x:auto;margin:8px 0;font-family:monospace}
    .script-category{margin:20px 0}
    .script-category h4{border-bottom:1px solid var(--d2);padding-bottom:8px;margin-bottom:12px}
    
    /* Script List Styles */
    .script-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border: 1px solid var(--d2);
      border-radius: 6px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .script-list-item:hover {
      background: var(--d1);
      border-color: var(--neon);
    }
    
    .script-actions {
      display: flex;
      gap: 6px;
    }
    
    .script-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--d2);
    }
    
    .script-badge.js {
      background: #f7df1e;
      color: #000;
    }
    
    .script-badge.python {
      background: #3776ab;
      color: #fff;
    }
    
    /* Chat container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    
    /* Enhanced Chat Input Container */
    .chat-input-container {
      display: flex;
      padding: 16px;
      border-top: 1px solid var(--d2);
      background: var(--d0);
      align-items: center;
      gap: 8px;
    }
    
    .terminal-input {
      flex-grow: 1;
      background: transparent;
      border: none;
      color: var(--neon);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 12px 16px;
      outline: none;
      border-radius: 8px;
      border: 1px solid var(--d2);
      transition: all 0.2s;
    }
    
    .terminal-input:focus {
      border-color: var(--neon);
      box-shadow: 0 0 0 2px rgba(57, 255, 20, 0.2);
    }
    
    .terminal-input::placeholder {
      color: #666;
    }
    
    .send-button {
      background: var(--g0);
      color: var(--neon);
      border: 1px solid var(--neon);
      border-radius: 8px;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    .send-button:hover {
      background: var(--neon);
      color: var(--blk);
      box-shadow: 0 0 8px var(--neon);
    }
    
    /* Train section */
    .train-section {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }
    
    /* Guide section */
    .guide-section {
      padding: 16px;
      overflow-y: auto;
      flex: 1;
    }
    
    /* Capability indicator */
    .capability-indicator {
      display: inline-flex;
      align-items: center;
      background: var(--g0);
      color: var(--neon);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      margin-left: 8px;
      border: 1px solid var(--neon);
    }
    
    /* Training indicator */
    .training-indicator {
      display: inline-flex;
      align-items: center;
      background: var(--g0);
      color: var(--neon);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      margin-left: 8px;
      border: 1px solid var(--neon);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Enhanced message formatting */
    .section-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: var(--neon);
      margin-bottom: 8px;
      border-bottom: 1px solid var(--d2);
      padding-bottom: 4px;
    }
    
    .content-paragraph {
      margin-bottom: 12px;
      line-height: 1.5;
    }
    
    .content-list {
      margin-left: 20px;
      margin-bottom: 12px;
    }
    
    .content-list li {
      margin-bottom: 4px;
    }
    
    .script-option {
      display: inline-block;
      background: var(--g0);
      color: var(--neon);
      border: 1px solid var(--neon);
      border-radius: 6px;
      padding: 6px 12px;
      margin: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.8rem;
    }
    
    .script-option:hover {
      background: var(--neon);
      color: var(--blk);
    }
    
    .knowledge-suggestion {
      display: inline-block;
      background: var(--d1);
      color: var(--neon);
      border: 1px solid var(--d2);
      border-radius: 6px;
      padding: 6px 12px;
      margin: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.8rem;
    }
    
    .knowledge-suggestion:hover {
      background: var(--g0);
      border-color: var(--neon);
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .header-controls {
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
      }
    }
    
    @media (max-width: 1024px) {
      .sidebar {
        width: 220px;
      }
      .main {
        margin-left: 220px;
      }
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .main {
        margin-left: 0;
        height: calc(100vh - 200px);
      }
      .chat-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .header-controls {
        width: 100%;
        justify-content: space-between;
      }
      .header-buttons {
        width: 100%;
        justify-content: flex-end;
      }
      .modal-body {
        flex-direction: column;
      }
      .list {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--d2);
        max-height: 200px;
      }
      .chat-message {
        max-width: 95%;
      }
      .terminal-input {
        font-size: 16px; /* Better for mobile */
      }
    }
    
    @media (max-width: 480px) {
      .btn {
        padding: 6px 8px;
        font-size: 0.75rem;
      }
      .header-buttons {
        gap: 4px;
      }
      .modal {
        width: 95vw;
        max-height: 90vh;
      }
      .send-button {
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loading-screen">
    <div class="logo mb-4">WEBXOS CHATBOT</div>
    <div class="neon text-xl mb-2" id="loading-text">Loading AI Training Environment</div>
    <div class="help" id="loading-subtext">Initializing Python Runtime...</div>
    <div class="w-64 h-2 bg-gray-800 rounded-full mt-4 overflow-hidden">
      <div class="h-full rounded-full bar" id="loading-bar" style="width:0%"></div>
    </div>
  </div>

  <div class="flex flex-col md:flex-row h-screen">
    <!-- Sidebar -->
    <aside class="sidebar p-4 flex flex-col">
      <div class="logo mb-8">WEBXOS CHATBOT</div>
      <ul class="flex-grow">
        <li class="nav-item active" data-nav="chat"><i class="fas fa-comments mr-2"></i>Chat</li>
        <li class="nav-item" data-nav="train"><i class="fas fa-brain mr-2"></i>Train</li>
        <li class="nav-item" data-nav="guide"><i class="fas fa-book mr-2"></i>Guide</li>
      </ul>
      <div class="mt-auto text-xs text-gray-400 text-center">Full Knowledge Reader</div>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- CHAT -->
      <section id="chat" class="h-full flex flex-col">
        <!-- Fixed header with no overlapping -->
        <div class="chat-header">
          <div class="header-left">
            <h2 class="text-2xl font-bold neon">Assistant
              <span class="training-indicator" id="training-indicator">ACTIVE TRAINING</span>
            </h2>
          </div>
          
          <div class="header-controls">
            <div class="text-sm">
              <span class="neon">Training: </span><span id="training-val">0%</span>
            </div>
            
            <div class="header-buttons">
              <button id="btn-import" class="btn btn-secondary"><i class="fas fa-file-import mr-2"></i>Add Files</button>
              
              <button class="btn btn-secondary" id="btn-export"><i class="fas fa-download mr-2"></i>Export</button>
              
              <div class="dropdown">
                <button class="btn btn-secondary" id="dropdown-packs-btn"><i class="fas fa-box mr-2"></i>Packs</button>
                <div class="dropdown-content" id="dropdown-packs">
                  <!-- Will be populated with packs -->
                </div>
              </div>
              
              <div class="dropdown">
                <button class="btn btn-secondary" id="dropdown-scripts-btn"><i class="fas fa-code mr-2"></i>Scripts</button>
                <div class="dropdown-content" id="dropdown-scripts">
                  <!-- Will be populated with scripts -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="progress mx-4 mt-2"><div id="training-bar" class="bar"></div></div>

        <div id="chat-container" class="chat-container">
          <!-- System intro -->
          <div class="chat-message bot">
            <div class="compact">
              Welcome to WEBXOS CHATBOT with full knowledge pack reading. I can read entire knowledge packs, execute scripts, and provide detailed information piece by piece.
              Use <span class="kbd">/HELP</span> for commands or the buttons below to get started.
            </div>
            <div class="mt-2">
              <span class="chip" onclick="App.openTrain()">Train</span>
              <span class="chip" onclick="App.openPacksPopup()">Knowledge Packs</span>
              <span class="chip" onclick="App.openScriptsPopup()">Scripts</span>
              <span class="chip" onclick="App.sendCommand('/HELP')">/HELP</span>
              <span class="chip" onclick="App.sendCommand('/SCRIPTCATALOG')">Script Catalog</span>
            </div>
          </div>
        </div>

        <!-- Enhanced Terminal-style Input -->
        <div class="chat-input-container">
          <input id="chat-input" class="terminal-input" placeholder="Type your message or command..."/>
          <button class="send-button" id="send-btn"><i class="fas fa-paper-plane mr-2"></i>Send</button>
        </div>
      </section>

      <!-- TRAIN -->
      <section id="train" class="train-section hidden">
        <h2 class="text-2xl font-bold mb-3 neon">Training</h2>
        <p class="help mb-4">Drop multiple .md files. Each file becomes its own Knowledge Pack. Edit packs live; scripts in triple backticks are auto-collected.</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Progress -->
          <div class="panel p-4">
            <h3 class="text-xl font-semibold mb-3 neon">Progress</h3>
            <div class="progress mb-3"><div id="train-bar" class="bar"></div></div>
            <div class="text-center mb-4">
              <div class="text-3xl font-bold neon" id="train-val">0%</div>
              <div class="text-sm text-gray-400" id="train-status">No packs yet</div>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div class="text-center border border-gray-700 rounded p-2">
                <div class="text-xs text-gray-400">Packs</div><div class="text-xl neon" id="stat-packs">0</div>
              </div>
              <div class="text-center border border-gray-700 rounded p-2">
                <div class="text-xs text-gray-400">Sections</div><div class="text-xl neon" id="stat-sections">0</div>
              </div>
              <div class="text-center border border-gray-700 rounded p-2">
                <div class="text-xs text-gray-400">Scripts</div><div class="text-xl neon" id="stat-scripts">0</div>
              </div>
            </div>
          </div>

          <!-- Upload -->
          <div class="panel p-4">
            <h3 class="text-xl font-semibold mb-3 neon">Add markdown files</h3>
            <div id="upload-area" class="upload">
              <i class="fas fa-file-upload text-3xl mb-2 neon"></i>
              <p class="neon">Drag & drop files or click</p>
              <p class="text-xs text-gray-400 mt-1">.md / .markdown / .mdx</p>
              <input id="file-input" type="file" class="hidden" multiple accept=".md,.markdown,.mdx,text/markdown"/>
            </div>
            <div id="file-info" class="mt-3 text-sm hidden">
              <div class="flex justify-between"><span id="file-name">â€”</span><span id="file-size">â€”</span></div>
            </div>
            <div class="flex gap-2 mt-3">
              <button id="btn-train" class="btn btn-primary flex-1" disabled><i class="fas fa-cogs mr-2"></i>Auto-train</button>
              <button id="btn-clear" class="btn btn-secondary flex-1"><i class="fas fa-times mr-2"></i>Clear selection</button>
            </div>

            <div class="mt-4">
              <h4 class="text-lg font-semibold neon mb-2">Knowledge packs</h4>
              <div id="pack-list" class="border border-gray-700 rounded p-2 max-h-64 overflow-y-auto text-sm">
                <div class="help">No packs yet. Import files to populate.</div>
              </div>
              <div class="mt-2 text-xs text-gray-400">Click a pack to edit its content, define scripts, and format for best answers.</div>
            </div>
          </div>

          <!-- Scripts List -->
          <div class="panel p-4">
            <h3 class="text-xl font-semibold mb-3 neon">Scripts</h3>
            <div id="script-list" class="border border-gray-700 rounded p-2 max-h-64 overflow-y-auto text-sm">
              <div class="help">No scripts yet. Add code blocks in packs to populate.</div>
            </div>
            <div class="mt-2 text-xs text-gray-400">Click a script to edit or run it.</div>
          </div>
        </div>
      </section>

      <!-- GUIDE -->
      <section id="guide" class="guide-section hidden">
        <h2 class="text-2xl font-bold mb-3 neon">Full Knowledge Reader Guide</h2>
        
        <div class="mb-6">
          <h3 class="text-xl font-semibold mb-2 neon">Enhanced Reading Features</h3>
          <ul class="list-disc pl-5 space-y-2">
            <li><span class="neon">Full Knowledge Pack Reading</span> - Reads entire markdown files with all information</li>
            <li><span class="neon">Piece-by-Piece Presentation</span> - Presents content in organized sections and paragraphs</li>
            <li><span class="neon">Script Integration</span> - Provides script options as suggestions for execution</li>
            <li><span class="neon">Contextual Navigation</span> - Allows users to ask for more details on specific subjects</li>
            <li><span class="neon">Enhanced Formatting</span> - Better structure with headings, lists, and code blocks</li>
            <li><span class="neon">Progressive Disclosure</span> - Reveals information gradually for better understanding</li>
          </ul>
        </div>

        <div class="mb-6">
          <h3 class="text-xl font-semibold mb-2 neon">Available Commands</h3>
          <div class="code border border-gray-700 rounded p-3">
            <span class="terminal-command">/HELP</span> - Show this help message<br>
            <span class="terminal-command">/KNOWLEDGE</span> - List all knowledge packs<br>
            <span class="terminal-command">/SCRIPTS</span> - List all available scripts<br>
            <span class="terminal-command">/STATS</span> - Show training statistics<br>
            <span class="terminal-command">/CLEAR</span> - Clear chat history<br>
            <span class="terminal-command">/SCRIPTCATALOG</span> - Show script templates
          </div>
        </div>

        <div class="script-catalog" id="script-catalog">
          <h3 class="text-xl font-semibold mb-3 neon">Script Template Catalog</h3>
          <p class="mb-4">Click any template to export it as a markdown file, then import it into your Knowledge Base.</p>
          
          <div class="flex gap-2 mb-4">
            <button class="btn btn-primary" onclick="App.exportAllTemplates()">
              <i class="fas fa-download mr-2"></i>Export All Templates
            </button>
          </div>
          
          <div class="script-category">
            <h4 class="text-lg font-semibold neon">JavaScript Templates</h4>
            
            <div class="script-template" onclick="App.exportTemplate('js-calculator')">
              <div class="flex justify-between items-center">
                <span class="font-semibold">Calculator Functions <span class="capability-indicator">Auto-execute</span></span>
                <span class="chip">JavaScript</span>
              </div>
              <p class="text-sm my-2">Basic math operations and utilities - automatically executes when user asks math questions</p>
              <pre id="js-calculator">// title: calculator
// description: Basic calculator functions for mathematical operations
// capabilities: calculate, math, add, subtract, multiply, divide

const add = (a, b) => a + b;
const subtract = (a, b) => a - b;
const multiply = (a, b) => a * b;
const divide = (a, b) => b !== 0 ? a / b : 'Error: Division by zero';
const power = (a, b) => Math.pow(a, b);
const sqrt = (a) => Math.sqrt(a);

// Helper function to parse math expressions
function calculateExpression(expression) {
  try {
    // Remove any non-math characters for safety
    const cleanExpr = expression.replace(/[^0-9+\-*/().]/g, '');
    return eval(cleanExpr);
  } catch (e) {
    return `Error: ${e.message}`;
  }
}

// Example usage:
console.log("Calculator loaded. Use functions: add, subtract, multiply, divide, power, sqrt");
console.log("Or use calculateExpression('2+2') for direct expressions");</pre>
            </div>
            
            <div class="script-template" onclick="App.exportTemplate('js-data')">
              <div class="flex justify-between items-center">
                <span class="font-semibold">Data Processing <span class="capability-indicator">Auto-execute</span></span>
                <span class="chip">JavaScript</span>
              </div>
              <p class="text-sm my-2">Array manipulation and data analysis - automatically executes for data questions</p>
              <pre id="js-data">// title: data-processor
// description: Data processing utilities for analysis
// capabilities: data, analyze, statistics, average, median

const average = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
const median = arr => {
  const sorted = [...arr].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
};
const mode = arr => {
  const frequency = {};
  arr.forEach(num => frequency[num] = (frequency[num] || 0) + 1);
  const maxFreq = Math.max(...Object.values(frequency));
  return Object.keys(frequency).filter(num => frequency[num] === maxFreq);
};
const range = arr => Math.max(...arr) - Math.min(...arr);

// Example with sample data
const numbers = [1, 2, 3, 4, 5, 6, 7];
console.log("Data processor loaded. Available functions: average, median, mode, range");
console.log("Sample analysis:", {
  average: average(numbers),
  median: median(numbers),
  mode: mode([1,2,2,3,4]),
  range: range(numbers)
});</pre>
            </div>
          </div>
          
          <div class="script-category">
            <h4 class="text-lg font-semibold neon">Python Templates</h4>
            
            <div class="script-template" onclick="App.exportTemplate('py-calculator')">
              <div class="flex justify-between items-center">
                <span class="font-semibold">Advanced Calculator <span class="capability-indicator">Auto-execute</span></span>
                <span class="chip">Python</span>
              </div>
              <p class="text-sm my-2">Math operations with error handling - automatically executes for complex math</p>
              <pre id="py-calculator"># title: py-calculator
# description: Python calculator with advanced features
# capabilities: calculate, math, advanced, finance

import math

def calculate_compound_interest(principal, rate, time):
    """Calculate compound interest"""
    return principal * (1 + rate/100) ** time

def fibonacci_sequence(n):
    """Generate Fibonacci sequence up to n terms"""
    sequence = [0, 1]
    for i in range(2, n):
        sequence.append(sequence[i-1] + sequence[i-2])
    return sequence[:n]

def quadratic_formula(a, b, c):
    """Solve quadratic equation ax^2 + bx + c = 0"""
    discriminant = b**2 - 4*a*c
    if discriminant < 0:
        return "No real solutions"
    elif discriminant == 0:
        return [-b/(2*a)]
    else:
        root1 = (-b + math.sqrt(discriminant))/(2*a)
        root2 = (-b - math.sqrt(discriminant))/(2*a)
        return [root1, root2]

# Example usage
print("Advanced Python calculator loaded")
print("Compound interest on $1000 at 5% for 10 years:", calculate_compound_interest(1000, 5, 10))
print("First 10 Fibonacci numbers:", fibonacci_sequence(10))
print("Solutions to x^2 - 5x + 6 = 0:", quadratic_formula(1, -5, 6))</pre>
            </div>
            
            <div class="script-template" onclick="App.exportTemplate('py-data')">
              <div class="flex justify-between items-center">
                <span class="font-semibold">Data Analysis <span class="capability-indicator">Auto-execute</span></span>
                <span class="chip">Python</span>
              </div>
              <p class="text-sm my-2">Statistical analysis with Python - automatically executes for data analysis requests</p>
              <pre id="py-data"># title: data-analyzer
# description: Data analysis with statistics
# capabilities: data, analyze, statistics, correlation

import statistics

def analyze_dataset(data):
    """Comprehensive data analysis"""
    analysis = {
        'mean': statistics.mean(data),
        'median': statistics.median(data),
        'stdev': statistics.stdev(data) if len(data) > 1 else 0,
        'min': min(data),
        'max': max(data),
        'count': len(data)
    }
    return analysis

def find_correlations(x, y):
    """Calculate correlation between two datasets"""
    if len(x) != len(y):
        return "Error: Datasets must have same length"
    
    correlation = statistics.correlation(x, y)
    return f"Correlation: {correlation:.3f}"

def linear_regression(x, y):
    """Perform simple linear regression"""
    if len(x) != len(y):
        return "Error: Datasets must have same length"
    
    n = len(x)
    sum_x = sum(x)
    sum_y = sum(y)
    sum_xy = sum(xi*yi for xi, yi in zip(x, y))
    sum_x2 = sum(xi**2 for xi in x)
    
    slope = (n * sum_xy - sum_x * sum_y) / (n * sum_x2 - sum_x**2)
    intercept = (sum_y - slope * sum_x) / n
    
    return {
        'slope': slope,
        'intercept': intercept,
        'equation': f"y = {slope:.2f}x + {intercept:.2f}"
    }

# Example usage
sample_data = [23, 45, 67, 89, 12, 45, 78]
print("Data analyzer loaded")
print("Data Analysis:")
analysis = analyze_dataset(sample_data)
for key, value in analysis.items():
    print(f"{key}: {value}")</pre>
            </div>
            
            <div class="script-template" onclick="App.exportTemplate('py-text')">
              <div class="flex justify-between items-center">
                <span class="font-semibold">Text Processing <span class="capability-indicator">Auto-execute</span></span>
                <span class="chip">Python</span>
              </div>
              <p class="text-sm my-2">Text analysis and manipulation - automatically executes for text processing requests</p>
              <pre id="py-text"># title: text-processor
# description: Text analysis utilities
# capabilities: text, analyze, words, count

def analyze_text(text):
    """Analyze text for basic statistics"""
    words = text.split()
    characters = len(text)
    word_count = len(words)
    avg_word_length = sum(len(word) for word in words) / word_count if word_count > 0 else 0
    
    return {
        'characters': characters,
        'words': word_count,
        'average_word_length': round(avg_word_length, 2),
        'unique_words': len(set(words))
    }

def find_most_common_words(text, n=5):
    """Find the n most common words"""
    from collections import Counter
    words = text.lower().split()
    word_counts = Counter(words)
    return word_counts.most_common(n)

def sentiment_analysis(text):
    """Basic sentiment analysis"""
    positive_words = ['good', 'great', 'excellent', 'amazing', 'wonderful', 'fantastic']
    negative_words = ['bad', 'terrible', 'awful', 'horrible', 'disappointing']
    
    words = text.lower().split()
    positive_count = sum(1 for word in words if word in positive_words)
    negative_count = sum(1 for word in words if word in negative_words)
    
    if positive_count > negative_count:
        return "Positive"
    elif negative_count > positive_count:
        return "Negative"
    else:
        return "Neutral"

# Example usage
sample_text = "This is a sample text for analysis. This text contains multiple words."
print("Text processor loaded")
print("Text Analysis:")
analysis = analyze_text(sample_text)
for key, value in analysis.items():
    print(f"{key}: {value}")

print("Most common words:")
print(find_most_common_words(sample_text))</pre>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Packs modal -->
  <div id="modal-packs" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="flex items-center gap-3">
          <span class="neon"><i class="fas fa-box mr-2"></i>Knowledge packs</span>
          <span class="pill" id="packs-count-pill">0 packs</span>
        </div>
        <button class="btn btn-secondary" onclick="Modal.close('modal-packs')"><i class="fas fa-times mr-1"></i>Close</button>
      </div>
      <div class="modal-body">
        <div class="list" id="modal-pack-list"></div>
        <div class="editor">
          <div class="editor-toolbar">
            <button class="btn btn-secondary" id="btn-pack-rename"><i class="fas fa-pen mr-2"></i>Rename</button>
            <button class="btn btn-secondary" id="btn-pack-duplicate"><i class="fas fa-clone mr-2"></i>Duplicate</button>
            <button class="btn btn-secondary" id="btn-pack-delete"><i class="fas fa-trash mr-2"></i>Delete</button>
            <span class="help ml-auto">Edits are live and affect answers immediately.</span>
          </div>
          <textarea id="pack-editor" class="editor-textarea" placeholder="Edit markdownâ€¦"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="btn-pack-save"><i class="fas fa-save mr-2"></i>Save changes</button>
      </div>
    </div>
  </div>

  <!-- Scripts modal -->
  <div id="modal-scripts" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="flex items-center gap-3">
          <span class="neon"><i class="fas fa-code mr-2"></i>Scripts</span>
          <span class="pill" id="scripts-count-pill">0 scripts</span>
        </div>
        <button class="btn btn-secondary" onclick="Modal.close('modal-scripts')"><i class="fas fa-times mr-1"></i>Close</button>
      </div>
      <div class="modal-body">
        <div class="list" id="modal-script-list"></div>
        <div class="editor">
          <div class="editor-toolbar">
            <select id="script-language" class="btn btn-secondary">
              <option value="javascript">javascript</option>
              <option value="js">js</option>
              <option value="python">python</option>
              <option value="py">py</option>
            </select>
            <input id="script-title" class="btn btn-secondary" placeholder="Script title"/>
            <button class="btn btn-secondary" id="btn-script-new"><i class="fas fa-plus mr-2"></i>New script</button>
            <button class="btn btn-secondary" id="btn-script-delete"><i class="fas fa-trash mr-2"></i>Delete</button>
            <span class="help ml-auto">JS/Python execute in sandboxed environment</span>
          </div>
          <textarea id="script-editor" class="script-editor code" placeholder="```javascript\n// your code\n```"></textarea>
          <div id="script-output" class="script-output hidden"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btn-script-run"><i class="fas fa-play mr-2"></i>Run Script</button>
        <button class="btn btn-primary" id="btn-script-save"><i class="fas fa-save mr-2"></i>Save script</button>
      </div>
    </div>
  </div>

  <script>
    // Pyodide instance
    let pyodide = null;
    let pyodideLoaded = false;

    // Enhanced Store with Full Knowledge Reading
    const Store = {
      packs: [],            // [{id, name, content}]
      sections: [],         // derived for answering
      scripts: [],          // [{id, title, language, content, sourcePackId, capabilities}]
      conversations: [],    // Store conversation history for training
      iter: 0,
      load(){
        try{
          const data = JSON.parse(localStorage.getItem('webxos-enhanced-scripts')||'{}');
          this.packs = data.packs||[];
          this.scripts = data.scripts||[];
          this.sections = data.sections||[];
          this.conversations = data.conversations || [];
          this.iter = data.iter||0;
        }catch(e){
          console.error("Error loading data from localStorage:", e);
          // Reset to defaults if loading fails
          this.packs = [];
          this.scripts = [];
          this.sections = [];
          this.conversations = [];
          this.iter = 0;
        }
      },
      save(){
        try {
          localStorage.setItem('webxos-enhanced-scripts', JSON.stringify({
            packs:this.packs, scripts:this.scripts, sections:this.sections, 
            conversations: this.conversations, iter:this.iter
          }));
        } catch(e) {
          console.error("Error saving data to localStorage:", e);
        }
      },
      
      // Add conversation for training
      addConversation(userInput, botResponse, usedScript = null) {
        this.conversations.push({
          userInput,
          botResponse,
          usedScript,
          timestamp: new Date().toISOString()
        });
        
        // Keep only last 100 conversations to prevent memory issues
        if (this.conversations.length > 100) {
          this.conversations = this.conversations.slice(-100);
        }
        
        this.save();
      },
      
      // Find relevant scripts based on conversation context
      findScriptsByContext(userInput, conversationHistory = []) {
        const inputLower = userInput.toLowerCase();
        const relevantScripts = [];
        
        // First, check for direct capability matches
        for (const script of this.scripts) {
          if (script.capabilities && script.capabilities.some(cap => 
            inputLower.includes(cap.toLowerCase())
          )) {
            relevantScripts.push({script, matchType: 'capability', score: 1.0});
          }
        }
        
        // Then check for keyword matches in script titles and descriptions
        for (const script of this.scripts) {
          const titleMatch = script.title.toLowerCase().includes(inputLower);
          const descMatch = script.description && script.description.toLowerCase().includes(inputLower);
          
          if (titleMatch || descMatch) {
            relevantScripts.push({script, matchType: 'keyword', score: 0.8});
          }
        }
        
        // Sort by relevance score
        return relevantScripts.sort((a, b) => b.score - a.score);
      },
      
      // Find knowledge pack by name or content
      findKnowledgePack(query) {
        const queryLower = query.toLowerCase();
        
        // First try to match by exact pack name
        let pack = this.packs.find(p => p.name.toLowerCase() === queryLower);
        if (pack) return { pack, matchType: 'exact' };
        
        // Then try partial pack name match
        pack = this.packs.find(p => p.name.toLowerCase().includes(queryLower));
        if (pack) return { pack, matchType: 'partial' };
        
        // Then try to match by content in sections
        const matchingSections = this.sections.filter(s => 
          s.title.toLowerCase().includes(queryLower) || 
          s.content.toLowerCase().includes(queryLower)
        );
        
        if (matchingSections.length > 0) {
          const packIds = [...new Set(matchingSections.map(s => s.packId))];
          if (packIds.length > 0) {
            const pack = this.packs.find(p => p.id === packIds[0]);
            if (pack) return { pack, matchType: 'content', sections: matchingSections };
          }
        }
        
        return null;
      }
    };

    // Enhanced Parser with Full Knowledge Reading
    const Parser = {
      parseMarkdown(md, packName, packId){
        const sections = [];
        const scripts = [];
        
        try {
          // Clean and normalize markdown content
          md = md.replace(/\r\n/g, '\n').replace(/\t/g, '  ');
          
          // Split into logical sections based on headings
          const headingRegex = /^(#{1,6})\s+(.+)$/gm;
          let lastIndex = 0;
          let match;
          let lastHeading = '';
          
          // Extract code blocks first to avoid interference with section parsing
          const codeBlockRegex = /```([a-z]*)\n([\s\S]*?)```/g;
          let codeMatch;
          
          while ((codeMatch = codeBlockRegex.exec(md)) !== null) {
            const [fullMatch, language, content] = codeMatch;
            
            // Extract metadata from code block comments
            let titleMatch = content.match(/^\s*(?:\/\/|#)\s*title:\s*(.+)$/m);
            let descMatch = content.match(/^\s*(?:\/\/|#)\s*description:\s*(.+)$/m);
            let capabilitiesMatch = content.match(/^\s*(?:\/\/|#)\s*capabilities:\s*(.+)$/m);
            
            const title = titleMatch ? titleMatch[1].trim() : (lastHeading || `Script from ${packName}`);
            const description = descMatch ? descMatch[1].trim() : '';
            const capabilities = capabilitiesMatch ? capabilitiesMatch[1].trim().split(/,\s*/) : [];
            
            const script = {
              id: `scr-${Date.now()}-${Math.random().toString(16).slice(2)}`,
              title, 
              description,
              capabilities,
              language: language.toLowerCase() || 'unknown',
              content, 
              sourcePackId: packId
            };
            
            scripts.push(script);
          }
          
          // Process sections based on headings
          while ((match = headingRegex.exec(md)) !== null) {
            const [fullMatch, hashes, title] = match;
            const level = hashes.length;
            const startIndex = match.index;
            
            // If we have content between the last heading and this one, create a section
            if (startIndex > lastIndex) {
              const content = md.substring(lastIndex, startIndex).trim();
              if (content) {
                sections.push({
                  title: lastHeading || 'Introduction',
                  content: this.cleanSectionContent(content),
                  level: lastHeading ? 2 : 1,
                  packId
                });
              }
            }
            
            lastHeading = title.trim();
            lastIndex = headingRegex.lastIndex;
          }
          
          // Add the final section after the last heading
          if (lastIndex < md.length) {
            const content = md.substring(lastIndex).trim();
            if (content) {
              sections.push({
                title: lastHeading || 'Content',
                content: this.cleanSectionContent(content),
                level: lastHeading ? 2 : 1,
                packId
              });
            }
          }
          
          // If no sections were created (no headings), create a single section
          if (sections.length === 0 && md.trim()) {
            sections.push({
              title: packName,
              content: this.cleanSectionContent(md),
              level: 1,
              packId
            });
          }
        } catch(e) {
          console.error("Error parsing markdown:", e);
          // Create a basic section if parsing fails
          sections.push({
            title: packName,
            content: md.substring(0, 500) + (md.length > 500 ? '...' : ''),
            level: 1,
            packId: packId
          });
        }

        return {sections, scripts};
      },
      
      cleanSectionContent(content) {
        // Remove excessive whitespace and normalize line breaks
        return content
          .replace(/\n\s*\n\s*\n/g, '\n\n') // Replace multiple blank lines with double
          .replace(/^\s+|\s+$/g, '') // Trim each line
          .replace(/\n{3,}/g, '\n\n') // Limit consecutive line breaks
          .split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .join('\n');
      },
      
      // Enhanced content parsing for full knowledge reading
      parseContentIntoSentences(content) {
        // Split content into sentences while preserving structure
        const sentences = [];
        const lines = content.split('\n');
        
        for (const line of lines) {
          if (line.trim() === '') continue;
          
          // Check if line is a list item
          if (line.match(/^[-*â€¢]\s+/)) {
            sentences.push(line);
            continue;
          }
          
          // Check if line is a numbered list item
          if (line.match(/^\d+\.\s+/)) {
            sentences.push(line);
            continue;
          }
          
          // Split regular text into sentences
          const lineSentences = line.split(/(?<=[.!?])\s+/);
          sentences.push(...lineSentences.filter(s => s.trim().length > 0));
        }
        
        return sentences;
      },
      
      // Format content for enhanced reading
      formatContentForReading(content, title = '') {
        let formatted = '';
        
        if (title) {
          formatted += `<div class="section-title">${title}</div>`;
        }
        
        const sentences = this.parseContentIntoSentences(content);
        
        // Group sentences into paragraphs (3-5 sentences per paragraph)
        let currentParagraph = [];
        for (const sentence of sentences) {
          currentParagraph.push(sentence);
          
          // Start a new paragraph after 3-5 sentences, or if we hit a list item
          if (currentParagraph.length >= 3 || 
              sentence.match(/^[-*â€¢]\s+/) || 
              sentence.match(/^\d+\.\s+/)) {
            formatted += `<div class="content-paragraph">${currentParagraph.join(' ')}</div>`;
            currentParagraph = [];
          }
        }
        
        // Add any remaining sentences
        if (currentParagraph.length > 0) {
          formatted += `<div class="content-paragraph">${currentParagraph.join(' ')}</div>`;
        }
        
        return formatted;
      }
    };

    // Enhanced Answer with Full Knowledge Reading
    const Answer = {
      sim(a,b){
        try {
          const tok = t=> new Set(String(t).toLowerCase().split(/\W+/).filter(x=>x.length>2));
          const A=tok(a), B=tok(b);
          if(!A.size||!B.size) return 0;
          const inter = new Set([...A].filter(x=>B.has(x)));
          const union = new Set([...A,...B]);
          return inter.size/union.size;
        } catch(e) {
          console.error("Error in similarity calculation:", e);
          return 0;
        }
      },
      
      best(query, sections){
        let best=null, score=0;
        try {
          for(const s of sections){
            let sc= this.sim(query, s.title);
            if(sc<0.5) sc=Math.max(sc, this.sim(query, s.content.slice(0,300))*0.8);
            if(sc>score){ score=sc; best=s; }
          }
        } catch(e) {
          console.error("Error finding best section:", e);
        }
        return best && score>0.3 ? {section:best, score} : null;
      },
      
      // Enhanced script matching with context awareness
      findRelevantScripts(query, conversationContext = []) {
        return Store.findScriptsByContext(query, conversationContext);
      },
      
      // Format full knowledge pack for reading
      formatFullKnowledgePack(pack, sections) {
        let response = `<div class="section-title">ðŸ“š Knowledge Pack: ${pack.name}</div>`;
        
        // Add all sections with enhanced formatting
        sections.forEach((section, index) => {
          response += Parser.formatContentForReading(section.content, section.title);
          
          // Add a separator between sections (except the last one)
          if (index < sections.length - 1) {
            response += `<div style="height: 1px; background: var(--d2); margin: 16px 0;"></div>`;
          }
        });
        
        return response;
      },
      
      // Format content for better readability
      formatResponse(content, title = '') {
        let response = '';
        
        if (title) {
          response += `<div class="section-title">${title}</div>`;
        }
        
        // Use enhanced formatting for content
        response += Parser.formatContentForReading(content);
        
        return response;
      },
      
      // Handle commands
      handleCommand(input) {
        const command = input.split(' ')[0].toUpperCase();
        
        switch (command) {
          case '/HELP':
            return {
              text: `WEBXOS CHATBOT with Full Knowledge Reading - Available Commands:

<span class="terminal-command">/HELP</span> - Show this help message
<span class="terminal-command">/KNOWLEDGE</span> - List all knowledge packs
<span class="terminal-command">/SCRIPTS</span> - List all available scripts
<span class="terminal-command">/STATS</span> - Show training statistics
<span class="terminal-command">/CLEAR</span> - Clear chat history
<span class="terminal-command">/SCRIPTCATALOG</span> - Show script templates

<span class="neon">Full Knowledge Reading:</span>
- Reads entire knowledge packs with all information
- Presents content in organized sections and paragraphs
- Provides script options as interactive suggestions
- Allows asking for more details on specific subjects

<span class="neon">Try asking:</span>
- "Tell me about [knowledge pack name]"
- "Read the full [pack name] knowledge pack"
- "What scripts are available for [topic]?"
- "Tell me more about [specific subject]"`,
              suggestions: App.generateCommandSuggestions()
            };
          
          case '/KNOWLEDGE':
            return {
              text: App.listKnowledgePacks(),
              suggestions: App.generateKnowledgeSuggestions()
            };
          
          case '/SCRIPTS':
            return {
              text: App.listScripts(),
              suggestions: App.generateScriptListSuggestions()
            };
          
          case '/STATS':
            return {
              text: App.generateStats(),
              suggestions: App.generateCommandSuggestions()
            };
          
          case '/CLEAR':
            return {
              text: "Chat history cleared.",
              suggestions: App.generateSuggestions(''),
              clearChat: true
            };
          
          case '/SCRIPTCATALOG':
            return {
              text: App.showScriptCatalog(),
              suggestions: App.generateCommandSuggestions()
            };
          
          default:
            return {
              text: `Unknown command: ${command}. Type /HELP for available commands.`,
              suggestions: App.generateCommandSuggestions(),
              isError: true
            };
        }
      }
    };

    // Modal Management
    const Modal = {
      open(id){ 
        try {
          document.getElementById(id).style.display='flex'; 
          // Update content when opening
          if (id === 'modal-packs') {
            UI.openPacks();
          } else if (id === 'modal-scripts') {
            UI.openScripts();
          }
        } catch(e) {
          console.error("Error opening modal:", e);
        }
      },
      close(id){ 
        try {
          document.getElementById(id).style.display='none'; 
        } catch(e) {
          console.error("Error closing modal:", e);
        }
      }
    };

    // Enhanced UI with Full Knowledge Reading
    const UI = {
      updateStats(){
        try {
          const packs = Store.packs.length;
          const sections = Store.sections.length;
          const scripts = Store.scripts.length;
          
          document.getElementById('stat-packs').textContent = packs;
          document.getElementById('stat-sections').textContent = sections;
          document.getElementById('stat-scripts').textContent = scripts;

          // Enhanced progress scoring
          const chars = Store.sections.reduce((a,s)=>a+s.content.length,0);
          const charScore = Math.min(chars/25000*50, 50);
          const secScore = Math.min(sections*1.5, 30);
          const scrScore = Math.min(scripts*2, 20);
          const p = Math.min(100, Math.round(charScore+secScore+scrScore));
          
          document.getElementById('training-val').textContent = p+'%';
          document.getElementById('training-bar').style.width = p+'%';
          document.getElementById('train-val').textContent = p+'%';
          document.getElementById('train-bar').style.width = p+'%';
          document.getElementById('train-status').textContent = packs===0 ? 'No packs yet' : (p<40?'Basic':p<70?'Moderate':'Comprehensive');
          
          // Update dropdowns and script list
          this.updateDropdowns();
          this.renderScriptList();
        } catch(e) {
          console.error("Error updating stats:", e);
        }
      },
      
      renderPackList(){
        const cont = document.getElementById('pack-list');
        try {
          if(!Store.packs.length){ cont.innerHTML = '<div class="help">No packs yet. Import files to populate.</div>'; return; }
          cont.innerHTML = Store.packs.map(p=>(
            `<div class="flex items-center justify-between border border-gray-700 rounded px-2 py-1 mb-2">
               <div class="text-sm">${p.name}</div>
               <div>
                 <button class="chip" onclick="App.editPack('${p.id}')">Edit</button>
               </div>
             </div>`
          )).join('');
        } catch(e) {
          console.error("Error rendering pack list:", e);
          cont.innerHTML = '<div class="help">Error loading packs</div>';
        }
      },
      
      renderScriptList(){
        const cont = document.getElementById('script-list');
        try {
          if(!Store.scripts.length){ 
            cont.innerHTML = '<div class="help">No scripts yet. Add code blocks in packs to populate.</div>'; 
            return; 
          }
          cont.innerHTML = Store.scripts.map(s=>(
            `<div class="script-list-item" onclick="App.editScript('${s.id}')">
               <div>
                 <div class="text-sm font-medium">${s.title}</div>
                 <div class="text-xs text-gray-400">${s.language} â€¢ from ${Store.packs.find(p=>p.id===s.sourcePackId)?.name||'unknown'}</div>
                 ${s.capabilities && s.capabilities.length > 0 ? 
                   `<div class="text-xs text-green-400 mt-1">Capabilities: ${s.capabilities.join(', ')}</div>` : ''}
               </div>
               <div class="script-actions">
                 <span class="script-badge ${s.language}">${s.language}</span>
                 <button class="chip" onclick="event.stopPropagation(); App.runScriptInTrain('${s.id}')">Run</button>
               </div>
             </div>`
          )).join('');
        } catch(e) {
          console.error("Error rendering script list:", e);
          cont.innerHTML = '<div class="help">Error loading scripts</div>';
        }
      },
      
      // Packs modal population
      openPacks(){
        const list = document.getElementById('modal-pack-list');
        const pill = document.getElementById('packs-count-pill');
        try {
          pill.textContent = `${Store.packs.length} packs`;
          list.innerHTML = Store.packs.map(p=>(
            `<div class="list-item ${App.state.selectedPackId===p.id?'active':''}" onclick="App.selectPack('${p.id}')">
               <div class="font-semibold">${p.name}</div>
               <div class="text-xs text-gray-400">${(p.content||'').length} chars</div>
             </div>`
          )).join('') || '<div class="help p-2">No packs.</div>';
          
          // Select first pack if none selected
          if (Store.packs.length > 0 && !App.state.selectedPackId) {
            App.selectPack(Store.packs[0].id);
          }
        } catch(e) {
          console.error("Error opening packs:", e);
          list.innerHTML = '<div class="help p-2">Error loading packs</div>';
        }
      },
      
      openScripts(){
        const list = document.getElementById('modal-script-list');
        const pill = document.getElementById('scripts-count-pill');
        try {
          pill.textContent = `${Store.scripts.length} scripts`;
          list.innerHTML = Store.scripts.map(s=>(
            `<div class="list-item ${App.state.selectedScriptId===s.id?'active':''}" onclick="App.selectScript('${s.id}')">
               <div class="font-semibold">${s.title}</div>
               <div class="text-xs text-gray-400">${s.language} â€¢ from ${Store.packs.find(p=>p.id===s.sourcePackId)?.name||'unknown'}</div>
             </div>`
          )).join('') || '<div class="help p-2">No scripts yet. Add ``` blocks in packs.</div>';
          
          // Select first script if none selected
          if (Store.scripts.length > 0 && !App.state.selectedScriptId) {
            App.selectScript(Store.scripts[0].id);
          }
        } catch(e) {
          console.error("Error opening scripts:", e);
          list.innerHTML = '<div class="help p-2">Error loading scripts</div>';
        }
      },
      
      updateDropdowns() {
        try {
          // Update packs dropdown
          const packsDropdown = document.getElementById('dropdown-packs');
          if (Store.packs.length === 0) {
            packsDropdown.innerHTML = '<a>No packs loaded</a>';
          } else {
            packsDropdown.innerHTML = Store.packs.map(p => 
              `<a onclick="App.readFullKnowledgePack('${p.name}')">Read ${p.name}</a>`
            ).join('');
          }
          
          // Update scripts dropdown
          const scriptsDropdown = document.getElementById('dropdown-scripts');
          if (Store.scripts.length === 0) {
            scriptsDropdown.innerHTML = '<a>No scripts available</a>';
          } else {
            scriptsDropdown.innerHTML = Store.scripts.map(s => 
              `<a onclick="App.previewScript('${s.id}')">${s.title} (${s.language})</a>`
            ).join('');
          }
        } catch(e) {
          console.error("Error updating dropdowns:", e);
        }
      }
    };

    // Main Application with Full Knowledge Reading
    const App = {
      state:{ view:'chat', selectedPackId:null, selectedScriptId:null, pendingFiles:[] },
      
      async init(){
        try {
          // Initialize loading sequence
          this.showLoadingScreen();
          
          // Initialize Pyodide
          await this.initPyodide();
          
          // Load & derive
          Store.load();
          
          // Load default capabilities if no scripts exist
          if (Store.scripts.length === 0) {
            this.loadDefaultCapabilities();
          }
          
          this.rederive();
          UI.updateStats();
          UI.renderPackList();
          UI.renderScriptList();

          // Setup navigation
          this.setupNavigation();

          // Chat
          document.getElementById('send-btn').addEventListener('click', ()=>this.sendChat());
          document.getElementById('chat-input').addEventListener('keypress', e=>{ if(e.key==='Enter') this.sendChat(); });

          // Train upload
          const area = document.getElementById('upload-area');
          const input = document.getElementById('file-input');
          area.addEventListener('click', ()=>input.click());
          area.addEventListener('dragover', e=>{ e.preventDefault(); area.style.background= 'rgba(10,46,10,.6)'; });
          ['dragleave','dragend'].forEach(ev=> area.addEventListener(ev, ()=> area.style.background=''));
          area.addEventListener('drop', e=>{
            e.preventDefault(); area.style.background='';
            const files = Array.from(e.dataTransfer.files||[]);
            this.handleFileSelect(files);
          });
          input.addEventListener('change', e=> this.handleFileSelect(Array.from(e.target.files||[])));
          document.getElementById('btn-train').addEventListener('click', ()=> this.processFiles());
          document.getElementById('btn-clear').addEventListener('click', ()=> this.clearSelection());

          // Header buttons
          document.getElementById('btn-export').addEventListener('click', ()=> this.exportAll());
          document.getElementById('btn-import').addEventListener('click', ()=> this.openTrain());

          // Dropdown buttons
          document.getElementById('dropdown-packs-btn').addEventListener('click', ()=> this.toggleDropdown('dropdown-packs'));
          document.getElementById('dropdown-scripts-btn').addEventListener('click', ()=> this.toggleDropdown('dropdown-scripts'));

          // Packs modal actions
          document.getElementById('btn-pack-save').addEventListener('click', ()=> this.savePackEdit());
          document.getElementById('btn-pack-rename').addEventListener('click', ()=> this.renamePack());
          document.getElementById('btn-pack-duplicate').addEventListener('click', ()=> this.duplicatePack());
          document.getElementById('btn-pack-delete').addEventListener('click', ()=> this.deletePack());

          // Scripts modal actions
          document.getElementById('btn-script-save').addEventListener('click', ()=> this.saveScriptEdit());
          document.getElementById('btn-script-run').addEventListener('click', ()=> this.runScript());
          document.getElementById('btn-script-new').addEventListener('click', ()=> this.newScript());
          document.getElementById('btn-script-delete').addEventListener('click', ()=> this.deleteScript());
          
          // Close dropdowns when clicking outside
          document.addEventListener('click', (e) => {
            if (!e.target.matches('.dropdown button')) {
              document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
              });
            }
          });
        } catch(e) {
          console.error("Error initializing app:", e);
          document.getElementById('loading-screen').classList.add('hidden');
        }
      },
      
      // Load default capabilities
      loadDefaultCapabilities() {
        try {
          const defaultPack = {
            id: 'default-capabilities',
            name: 'Default Capabilities',
            content: `# Default Capabilities

This pack contains default script capabilities for the chatbot.

## Calculator

Basic calculator functions for mathematical operations.

\`\`\`javascript
// title: calculator
// description: Basic calculator functions for mathematical operations
// capabilities: calculate, math, add, subtract, multiply, divide

const add = (a, b) => a + b;
const subtract = (a, b) => a - b;
const multiply = (a, b) => a * b;
const divide = (a, b) => b !== 0 ? a / b : 'Error: Division by zero';
const power = (a, b) => Math.pow(a, b);
const sqrt = (a) => Math.sqrt(a);

// Helper function to parse math expressions
function calculateExpression(expression) {
  try {
    // Remove any non-math characters for safety
    const cleanExpr = expression.replace(/[^0-9+\-*/().]/g, '');
    return eval(cleanExpr);
  } catch (e) {
    return \`Error: \${e.message}\`;
  }
}

// Example usage:
console.log("Calculator loaded. Use functions: add, subtract, multiply, divide, power, sqrt");
console.log("Or use calculateExpression('2+2') for direct expressions");
\`\`\`

## Data Processor

Data analysis and processing utilities.

\`\`\`javascript
// title: data-processor
// description: Data processing utilities for analysis
// capabilities: data, analyze, statistics, average, median

const average = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
const median = arr => {
  const sorted = [...arr].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
};
const mode = arr => {
  const frequency = {};
  arr.forEach(num => frequency[num] = (frequency[num] || 0) + 1);
  const maxFreq = Math.max(...Object.values(frequency));
  return Object.keys(frequency).filter(num => frequency[num] === maxFreq);
};
const range = arr => Math.max(...arr) - Math.min(...arr);

// Example with sample data
const numbers = [1, 2, 3, 4, 5, 6, 7];
console.log("Data processor loaded. Available functions: average, median, mode, range");
console.log("Sample analysis:", {
  average: average(numbers),
  median: median(numbers),
  mode: mode([1,2,2,3,4]),
  range: range(numbers)
});
\`\`\`
`
          };
          
          Store.packs.push(defaultPack);
          const {sections, scripts} = Parser.parseMarkdown(defaultPack.content, defaultPack.name, defaultPack.id);
          Store.sections.push(...sections);
          Store.scripts.push(...scripts);
          Store.save();
        } catch(e) {
          console.error("Error loading default capabilities:", e);
        }
      },
      
      // Setup navigation
      setupNavigation() {
        try {
          document.querySelectorAll('.nav-item').forEach(el => {
            el.addEventListener('click', (e) => {
              e.preventDefault();
              const view = el.getAttribute('data-nav');
              this.navigate(view);
            });
          });
        } catch(e) {
          console.error("Error setting up navigation:", e);
        }
      },
      
      async initPyodide() {
        try {
          const loadingText = document.getElementById('loading-subtext');
          loadingText.textContent = "Loading Pyodide (Python runtime)...";
          
          pyodide = await loadPyodide({
            indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
          });
          
          // Load additional packages
          await pyodide.loadPackage(["micropip"]);
          console.log("Pyodide initialized successfully");
          pyodideLoaded = true;
        } catch (error) {
          console.error("Failed to initialize Pyodide:", error);
          pyodideLoaded = false;
        }
      },
      
      showLoadingScreen() {
        try {
          const loadingBar = document.getElementById('loading-bar');
          const loadingText = document.getElementById('loading-text');
          const loadingSubtext = document.getElementById('loading-subtext');
          
          let width = 0;
          const interval = setInterval(() => {
            width += 2;
            loadingBar.style.width = `${width}%`;
            
            // Update loading text based on progress
            if (width < 30) {
              loadingText.textContent = "Loading AI Training Environment";
              loadingSubtext.textContent = "Initializing components...";
            } else if (width < 60) {
              loadingText.textContent = "Loading Neural Network";
              loadingSubtext.textContent = "Setting up knowledge models...";
            } else if (width < 90) {
              loadingText.textContent = "Loading Knowledge Base";
              loadingSubtext.textContent = "Loading saved data and configurations...";
            } else {
              loadingText.textContent = "Almost Ready";
              loadingSubtext.textContent = "Finalizing setup...";
            }
            
            if (width >= 100) {
              clearInterval(interval);
              setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
              }, 500);
            }
          }, 50);
        } catch(e) {
          console.error("Error in loading screen:", e);
          document.getElementById('loading-screen').classList.add('hidden');
        }
      },
      
      navigate(view){
        try {
          this.state.view = view;
          
          // Hide all sections
          ['chat','train','guide'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              el.classList.toggle('hidden', id !== view);
            }
          });
          
          // Update nav items
          document.querySelectorAll('.nav-item').forEach(el => {
            const navView = el.getAttribute('data-nav');
            el.classList.toggle('active', navView === view);
          });
        } catch(e) {
          console.error("Error navigating:", e);
        }
      },
      
      openTrain(){ this.navigate('train'); },
      openPacksPopup(){ Modal.open('modal-packs'); },
      openScriptsPopup(){ Modal.open('modal-scripts'); },
      
      toggleDropdown(dropdownId) {
        try {
          const dropdown = document.getElementById(dropdownId);
          dropdown.classList.toggle('show');
          
          // Close other dropdowns
          document.querySelectorAll('.dropdown-content').forEach(d => {
            if (d.id !== dropdownId && d.classList.contains('show')) {
              d.classList.remove('show');
            }
          });
        } catch(e) {
          console.error("Error toggling dropdown:", e);
        }
      },
      
      // File selection
      handleFileSelect(files){
        try {
          const mdFiles = files.filter(f=> /\.mdx?$|\.markdown$/i.test(f.name) || f.type==='text/markdown' );
          this.state.pendingFiles = mdFiles;
          const total = mdFiles.reduce((a,f)=>a+f.size,0);
          document.getElementById('file-info').classList.remove('hidden');
          document.getElementById('file-name').textContent = mdFiles.length===1? mdFiles[0].name : `${mdFiles.length} files selected`;
          document.getElementById('file-size').textContent = total<1024? `${total} bytes` : (total<1048576? `${(total/1024).toFixed(1)} KB` : `${(total/1048576).toFixed(1)} MB`);
          document.getElementById('btn-train').disabled = mdFiles.length===0;
        } catch(e) {
          console.error("Error handling file selection:", e);
        }
      },
      
      clearSelection(){
        try {
          this.state.pendingFiles=[];
          const input = document.getElementById('file-input'); if(input) input.value='';
          document.getElementById('file-info').classList.add('hidden');
          document.getElementById('btn-train').disabled = true;
        } catch(e) {
          console.error("Error clearing selection:", e);
        }
      },
      
      async processFiles(){
        if(!this.state.pendingFiles.length) return;
        const btn = document.getElementById('btn-train');
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Trainingâ€¦';
        try {
          for(const file of this.state.pendingFiles){
            const content = await file.text();
            const packId = `pack-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            Store.packs.push({id:packId, name:file.name, content});
            const {sections, scripts} = Parser.parseMarkdown(content, file.name, packId);
            Store.sections.push(...sections);
            Store.scripts.push(...scripts);
          }
          Store.iter++;
          Store.save();
          this.clearSelection();
          UI.renderPackList();
          UI.updateStats();
          btn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete';
          setTimeout(()=>{ btn.innerHTML = '<i class="fas fa-cogs mr-2"></i>Auto-train'; btn.disabled=false; }, 1200);
        } catch(e) {
          console.error("Error processing files:", e);
          btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
          setTimeout(()=>{ btn.innerHTML = '<i class="fas fa-cogs mr-2"></i>Auto-train'; btn.disabled=false; }, 1200);
        }
      },
      
      // Re-derive sections/scripts from all packs
      rederive(){
        try {
          Store.sections=[]; Store.scripts=[];
          for(const p of Store.packs){
            const {sections, scripts} = Parser.parseMarkdown(p.content||'', p.name, p.id);
            Store.sections.push(...sections);
            Store.scripts.push(...scripts);
          }
          Store.save();
        } catch(e) {
          console.error("Error rederiving sections:", e);
        }
      },
      
      // Packs modal selection/edit
      selectPack(id){
        try {
          this.state.selectedPackId = id;
          const pack = Store.packs.find(p=>p.id===id);
          document.getElementById('pack-editor').value = pack?.content || '';
          
          // Update active state in list
          document.querySelectorAll('#modal-pack-list .list-item').forEach(item => {
            item.classList.remove('active');
          });
          const selectedItem = document.querySelector(`#modal-pack-list .list-item[onclick*="${id}"]`);
          if (selectedItem) {
            selectedItem.classList.add('active');
          }
        } catch(e) {
          console.error("Error selecting pack:", e);
        }
      },
      
      editPack(id){
        this.openPacksPopup();
        setTimeout(()=> this.selectPack(id), 50);
      },
      
      savePackEdit(){
        const id = this.state.selectedPackId; if(!id) return;
        const pack = Store.packs.find(p=>p.id===id); if(!pack) return;
        try {
          pack.content = document.getElementById('pack-editor').value;
          this.rederive();
          UI.updateStats();
          UI.renderPackList();
        } catch(e) {
          console.error("Error saving pack edit:", e);
          alert("Error saving pack: " + e.message);
        }
      },
      
      renamePack(){
        const id = this.state.selectedPackId; if(!id) return;
        const pack = Store.packs.find(p=>p.id===id); if(!pack) return;
        try {
          const name = prompt('Rename pack:', pack.name);
          if(name && name.trim()){ pack.name = name.trim(); Store.save(); UI.openPacks(); }
        } catch(e) {
          console.error("Error renaming pack:", e);
        }
      },
      
      duplicatePack(){
        const id = this.state.selectedPackId; if(!id) return;
        const pack = Store.packs.find(p=>p.id===id); if(!pack) return;
        try {
          const newId = `pack-${Date.now()}-${Math.random().toString(16).slice(2)}`;
          const copy = {id:newId, name: pack.name+' (copy)', content: pack.content};
          Store.packs.push(copy);
          this.rederive();
          UI.updateStats();
          UI.openPacks();
          this.selectPack(newId);
        } catch(e) {
          console.error("Error duplicating pack:", e);
        }
      },
      
      deletePack(){
        const id = this.state.selectedPackId; if(!id) return;
        if(!confirm('Delete this pack?')) return;
        try {
          Store.packs = Store.packs.filter(p=>p.id!==id);
          this.state.selectedPackId=null;
          this.rederive();
          UI.updateStats();
          UI.openPacks();
        } catch(e) {
          console.error("Error deleting pack:", e);
        }
      },
      
      // Scripts modal selection/edit/run
      selectScript(id){
        try {
          this.state.selectedScriptId = id;
          const s = Store.scripts.find(x=>x.id===id);
          document.getElementById('script-title').value = s?.title||'';
          document.getElementById('script-language').value = s?.language||'javascript';
          document.getElementById('script-editor').value = s?.content||'';
          
          // Update active state in list
          document.querySelectorAll('#modal-script-list .list-item').forEach(item => {
            item.classList.remove('active');
          });
          const selectedItem = document.querySelector(`#modal-script-list .list-item[onclick*="${id}"]`);
          if (selectedItem) {
            selectedItem.classList.add('active');
          }
          
          // Clear output
          const output = document.getElementById('script-output');
          output.classList.add('hidden');
          output.innerHTML = '';
        } catch(e) {
          console.error("Error selecting script:", e);
        }
      },
      
      editScript(id){
        this.openScriptsPopup();
        setTimeout(()=> this.selectScript(id), 50);
      },
      
      newScript(){
        try {
          const sourcePackId = Store.packs[0]?.id || null;
          const s = {
            id:`scr-${Date.now()}-${Math.random().toString(16).slice(2)}`,
            title:'untitled',
            language: document.getElementById('script-language').value || 'javascript',
            content: document.getElementById('script-editor').value || '',
            sourcePackId
          };
          Store.scripts.push(s); Store.save();
          UI.openScripts();
          this.selectScript(s.id);
          UI.renderScriptList();
        } catch(e) {
          console.error("Error creating new script:", e);
        }
      },
      
      saveScriptEdit(){
        const id = this.state.selectedScriptId; if(!id) return;
        const s = Store.scripts.find(x=>x.id===id); if(!s) return;
        try {
          s.title = document.getElementById('script-title').value || s.title;
          s.language = document.getElementById('script-language').value || s.language;
          s.content = document.getElementById('script-editor').value || s.content;
          Store.save();
          UI.openScripts();
          this.selectScript(id);
          UI.renderScriptList();
        } catch(e) {
          console.error("Error saving script edit:", e);
        }
      },
      
      deleteScript(){
        const id = this.state.selectedScriptId; if(!id) return;
        if(!confirm('Delete this script?')) return;
        
        try {
          Store.scripts = Store.scripts.filter(s => s.id !== id);
          this.state.selectedScriptId = null;
          Store.save();
          UI.openScripts();
          UI.updateStats();
        } catch(e) {
          console.error("Error deleting script:", e);
        }
      },
      
      async runScript(){
        const id = this.state.selectedScriptId; if(!id) return;
        const s = Store.scripts.find(x=>x.id===id); if(!s) return;
        
        const output = document.getElementById('script-output');
        output.classList.remove('hidden');
        output.innerHTML = '<div class="text-gray-400">Running script...</div>';
        
        try {
          const result = await this.executeScript(s.content, s.language);
          
          output.innerHTML = result.output;
          output.className = `script-output ${result.success ? 'success' : 'error'}`;
        } catch(e) {
          console.error("Error running script:", e);
          output.innerHTML = `Error running script: ${e.message}`;
          output.className = 'script-output error';
        }
      },
      
      async runScriptInTrain(id){
        const s = Store.scripts.find(x=>x.id===id); if(!s) return;
        
        try {
          const result = await this.executeScript(s.content, s.language);
          
          // Show result in alert for now
          alert(`Script "${s.title}" (${s.language})\n\nOutput:\n${result.output}`);
        } catch(e) {
          console.error("Error running script in train:", e);
          alert(`Error running script: ${e.message}`);
        }
      },
      
      async executeScript(src, lang, input = ''){
        try{
          // Normalize language names
          const normalizedLang = lang.toLowerCase();
          
          if(/^(javascript|js)$/.test(normalizedLang)){
            return this.executeJavaScript(src, input);
          }else if(/^(python|py)$/.test(normalizedLang)){
            return await this.executePython(src, input);
          }else{
            return {success:false, output:`Language "${lang}" not supported. Use JavaScript or Python.`};
          }
        }catch(e){ 
          return {success:false, output:`Execution error: ${e.message}`};
        }
      },
      
      executeJavaScript(src, input = ''){
        try{
          // Safe execution with restricted access
          if(/alert|document|window|fetch|XMLHttpRequest|eval|Function|import|require/.test(src)){
            return {success:false, output:`Blocked: Script contains potentially unsafe operations`};
          }
          
          // Capture console.log output
          let output = '';
          const originalLog = console.log;
          console.log = (...args) => {
            output += args.map(arg => 
              typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ') + '\n';
          };
          
          let result;
          try{ 
            // Create a context with input available
            const context = `
              const input = ${JSON.stringify(input)};
              ${src}
            `;
            result = eval(context); 
          }catch(e){ 
            result = `Error: ${e.message}`; 
          }
          
          console.log = originalLog;
          
          // Add result if not undefined
          if(result !== undefined && result !== null){
            output += String(result);
          }
          
          return {success:true, output: output || 'Script executed (no output)'};
        }catch(e){ 
          return {success:false, output:`JavaScript Error: ${e.message}`};
        }
      },
      
      async executePython(src, input = ''){
        try{
          if(!pyodide || !pyodideLoaded){
            return {success:false, output:`Python runtime not available. Please refresh the page.`};
          }
          
          // Set input variable in Python environment
          pyodide.runPython(`input = ${JSON.stringify(input)}`);
          
          // Capture Python output
          let output = '';
          pyodide.runPython(`
            import sys
            from io import StringIO
            sys.stdout = StringIO()
          `);
          
          try{
            await pyodide.runPythonAsync(src);
            output = pyodide.runPython("sys.stdout.getvalue()");
          }catch(e){
            output = `Python Error: ${e.message}`;
            return {success:false, output};
          }
          
          return {success:true, output: output || 'Python script executed (no output)'};
        }catch(e){ 
          return {success:false, output:`Python Runtime Error: ${e.message}`};
        }
      },
      
      // Enhanced chat with full knowledge reading
      sendChat(){
        const input = document.getElementById('chat-input');
        const q = input.value.trim();
        if(!q) return;
        
        try {
          const chat = document.getElementById('chat-container');
          chat.innerHTML += `<div class="chat-message user"><div class="font-bold">You</div><div>${q.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c]))}</div></div>`;
          input.value='';
          
          // Show typing indicator
          chat.innerHTML += `<div class="chat-message bot">
            <div class="font-bold neon">Assistant</div>
            <div class="typing-indicator"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div>
          </div>`;
          chat.scrollTop = chat.scrollHeight;
          
          setTimeout(async () => {
            // Remove typing indicator
            const messages = chat.querySelectorAll('.chat-message');
            if (messages.length > 0) {
              messages[messages.length - 1].remove();
            }
            
            let response;
            try {
              if(q.startsWith('/')){
                response = Answer.handleCommand(q);
              }else{
                response = await this.generateResponse(q);
              }
            } catch(e) {
              console.error("Error generating response:", e);
              response = {
                text: `I encountered an error while processing your request: ${e.message}`,
                suggestions: this.generateCommandSuggestions(),
                isError: true
              };
            }
            
            // Clear chat if requested
            if (response.clearChat) {
              chat.innerHTML = '';
            }
            
            let responseHTML = `<div class="chat-message bot"><div class="font-bold neon">Assistant</div><div class="compact">${response.text}</div>`;
            
            if (response.suggestions) {
              responseHTML += `<div class="mt-2">${response.suggestions}</div>`;
            }
            
            responseHTML += `</div>`;
            
            chat.innerHTML += responseHTML;
            chat.scrollTop = chat.scrollHeight;
            
            // Store conversation for training
            Store.addConversation(q, response.text, response.usedScript);
          }, 800 + Math.random() * 800);
        } catch(e) {
          console.error("Error in sendChat:", e);
        }
      },
      
      async generateResponse(q){
        // First, check if user wants to read a full knowledge pack
        const packMatch = this.checkForKnowledgePackRequest(q);
        if (packMatch) {
          return await this.handleKnowledgePackRequest(packMatch);
        }
        
        // Check if any script can handle this query
        const relevantScripts = Answer.findRelevantScripts(q, Store.conversations.slice(-5));
        
        if (relevantScripts.length > 0) {
          // Execute the most relevant script
          const {script} = relevantScripts[0];
          const result = await this.executeScript(script.content, script.language, q);
          
          let responseText = '';
          if (result.success) {
            responseText = `I used the <span class="neon">${script.title}</span> capability:\n\n`;
            responseText += `<div class="code border border-gray-700 rounded p-2 mt-2">${result.output}</div>`;
            
            // Add capability indicator
            responseText += `\n\n<span class="capability-indicator">Auto-executed: ${script.title}</span>`;
            
            return {
              text: responseText,
              suggestions: this.generateScriptSuggestions(q),
              usedScript: script.id
            };
          } else {
            responseText = `I tried to use the <span class="neon">${script.title}</span> capability but encountered an error:\n\n`;
            responseText += `<div class="code border border-red-700 rounded p-2 mt-2">${result.output}</div>`;
            
            return {
              text: responseText,
              suggestions: this.generateScriptSuggestions(q),
              usedScript: script.id
            };
          }
        }
        
        // Fall back to knowledge base search
        let text='';
        if(!Store.packs.length){
          text = `I don't have any knowledge packs yet. Use the <span class="chip" onclick="App.openTrain()">Train</span> button to add some.`;
        }else{
          const hit = Answer.best(q, Store.sections);
          if(hit){
            text = Answer.formatResponse(hit.section.content, hit.section.title);
          }else{
            text = `I don't have specific information about "${q}" in my knowledge base. Try asking about a different topic or add more training data.`;
          }
        }
        
        return {
          text: text,
          suggestions: this.generateKnowledgeSuggestions(q)
        };
      },
      
      // Check if user is requesting a knowledge pack
      checkForKnowledgePackRequest(query) {
        const lowerQuery = query.toLowerCase();
        
        // Check for patterns like "tell me about X", "read X", "show me X knowledge pack"
        const patterns = [
          /tell me about (.+)/i,
          /read (?:the )?(.+)/i,
          /show me (?:the )?(.+)/i,
          /what is (?:the )?(.+)/i,
          /explain (?:the )?(.+)/i,
          /knowledge pack (.+)/i,
          /pack (.+)/i
        ];
        
        for (const pattern of patterns) {
          const match = query.match(pattern);
          if (match) {
            const packName = match[1].trim();
            const result = Store.findKnowledgePack(packName);
            if (result) return result;
          }
        }
        
        return null;
      },
      
      // Handle knowledge pack request
      async handleKnowledgePackRequest(packMatch) {
        const { pack, matchType, sections } = packMatch;
        const packSections = sections || Store.sections.filter(s => s.packId === pack.id);
        
        if (packSections.length === 0) {
          return {
            text: `The knowledge pack "${pack.name}" doesn't contain any readable sections.`,
            suggestions: this.generateKnowledgeSuggestions('')
          };
        }
        
        // Format the full knowledge pack
        const formattedContent = Answer.formatFullKnowledgePack(pack, packSections);
        
        return {
          text: formattedContent,
          suggestions: this.generateKnowledgePackSuggestions(pack, packSections)
        };
      },
      
      // Read full knowledge pack (for direct calls)
      readFullKnowledgePack(packName) {
        const result = Store.findKnowledgePack(packName);
        if (result) {
          document.getElementById('chat-input').value = `Read ${packName}`;
          this.sendChat();
        } else {
          alert(`Knowledge pack "${packName}" not found.`);
        }
      },
      
      sendCommand(command){
        document.getElementById('chat-input').value = command;
        this.sendChat();
      },
      
      useSuggestion(suggestion){
        document.getElementById('chat-input').value = suggestion;
        this.sendChat();
      },
      
      previewScript(scriptId){
        const script = Store.scripts.find(s => s.id === scriptId);
        if (!script) return;
        
        const chatContainer = document.getElementById('chat-container');
        const previewHTML = `<div class="chat-message bot">
          <div class="font-bold neon">Script Preview: ${script.title}</div>
          <div class="code border border-gray-700 rounded p-2 mt-2">${script.language}\n${script.content}</div>
          <div class="mt-2">
            <span class="chip" onclick="App.runScriptInChat('${script.id}')">Run Script</span>
            <span class="chip" onclick="App.openScriptsPopup()">Edit Script</span>
          </div>
        </div>`;
        
        chatContainer.innerHTML += previewHTML;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      },
      
      async runScriptInChat(scriptId){
        const script = Store.scripts.find(s => s.id === scriptId);
        if (!script) return;
        
        const chatContainer = document.getElementById('chat-container');
        const result = await this.executeScript(script.content, script.language);
        
        const resultHTML = `<div class="chat-message bot">
          <div class="font-bold neon">Script Execution: ${script.title}</div>
          <div>Language: ${script.language}</div>
          <div class="${result.success?'text-green-400':'text-red-400'} mt-1">${result.success?'Success':'Failed'}</div>
          <div class="code border border-gray-700 rounded p-2 mt-2">${result.output.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c]))}</div>
        </div>`;
        
        chatContainer.innerHTML += resultHTML;
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Store this interaction for training
        Store.addConversation(`Run script: ${script.title}`, result.output, script.id);
      },
      
      generateSuggestions(currentQuery){
        const suggestions = [];
        
        // Command suggestions
        suggestions.push('<span class="chip" onclick="App.sendCommand(\'/HELP\')">/HELP</span>');
        suggestions.push('<span class="chip" onclick="App.sendCommand(\'/STATS\')">/STATS</span>');
        
        // Navigation suggestions
        if (Store.packs.length > 0) {
          suggestions.push('<span class="chip" onclick="App.openPacksPopup()">Knowledge Packs</span>');
        }
        
        if (Store.scripts.length > 0) {
          suggestions.push('<span class="chip" onclick="App.openScriptsPopup()">Scripts</span>');
        }
        
        // Training suggestion if no data
        if (Store.packs.length === 0) {
          suggestions.push('<span class="chip" onclick="App.openTrain()">Add Training Data</span>');
        }
        
        return suggestions.join('');
      },
      
      generateCommandSuggestions(){
        return [
          '<span class="chip" onclick="App.sendCommand(\'/KNOWLEDGE\')">/KNOWLEDGE</span>',
          '<span class="chip" onclick="App.sendCommand(\'/SCRIPTS\')">/SCRIPTS</span>',
          '<span class="chip" onclick="App.sendCommand(\'/STATS\')">/STATS</span>',
          '<span class="chip" onclick="App.sendCommand(\'/CLEAR\')">/CLEAR</span>',
          '<span class="chip" onclick="App.sendCommand(\'/SCRIPTCATALOG\')">Script Catalog</span>'
        ].join('');
      },
      
      generateKnowledgeSuggestions(query = ''){
        const uniqueFiles = [...new Set(Store.sections.map(k => k.source))];
        return uniqueFiles.map(file => 
          `<span class="knowledge-suggestion" onclick="App.readFullKnowledgePack('${file}')">Read ${file}</span>`
        ).join('');
      },
      
      generateScriptSuggestions(query = ''){
        const relevantScripts = Answer.findRelevantScripts(query);
        return relevantScripts.slice(0, 5).map(({script}) => 
          `<span class="script-option" onclick="App.runScriptInChat('${script.id}')">Run ${script.title}</span>`
        ).join('');
      },
      
      generateScriptListSuggestions(){
        return Store.scripts.map(script => 
          `<span class="chip" onclick="App.previewScript('${script.id}')">${script.title} (${script.language})</span>`
        ).join('');
      },
      
      generateKnowledgePackSuggestions(pack, sections){
        const suggestions = [];
        
        // Add script suggestions related to this pack
        const packScripts = Store.scripts.filter(s => s.sourcePackId === pack.id);
        if (packScripts.length > 0) {
          suggestions.push(...packScripts.map(script => 
            `<span class="script-option" onclick="App.runScriptInChat('${script.id}')">Run ${script.title}</span>`
          ));
        }
        
        // Add navigation suggestions
        suggestions.push('<span class="chip" onclick="App.sendCommand(\'/KNOWLEDGE\')">More Packs</span>');
        suggestions.push('<span class="chip" onclick="App.sendCommand(\'/SCRIPTS\')">All Scripts</span>');
        
        return suggestions.join('');
      },
      
      listKnowledgePacks(){
        const files = {};
        Store.sections.forEach(section => {
          if (!files[section.source]) {
            files[section.source] = [];
          }
          files[section.source].push(section);
        });
        
        let response = "Available Knowledge Packs:\n\n";
        for (const [filename, sections] of Object.entries(files)) {
          response += `<span class="neon">${filename}</span> (${sections.length} sections)\n`;
          sections.forEach(section => {
            response += `  - ${section.title}\n`;
          });
          response += "\n";
        }
        
        return response;
      },
      
      listScripts(){
        if (Store.scripts.length === 0) {
          return "No scripts available. Add Markdown files with code blocks to make scripts available.";
        }
        
        let response = "Available Scripts:\n\n";
        Store.scripts.forEach(script => {
          response += `<span class="neon">${script.title}</span> (${script.language})\n`;
          response += `  Source: ${Store.packs.find(p=>p.id===script.sourcePackId)?.name || 'unknown'}\n`;
          if (script.capabilities && script.capabilities.length > 0) {
            response += `  Capabilities: ${script.capabilities.join(', ')}\n`;
          }
          response += `  ID: ${script.id}\n\n`;
        });
        
        return response;
      },
      
      generateStats(){
        const sectionCount = Store.sections.length;
        const scriptCount = Store.scripts.length;
        const fileCount = new Set(Store.sections.map(k => k.source)).size;
        const conversationCount = Store.conversations.length;
        
        let response = "WEBXOS Training Statistics:\n\n";
        response += `<span class="neon">Knowledge Base:</span>\n`;
        response += `  - Files: ${fileCount}\n`;
        response += `  - Sections: ${sectionCount}\n`;
        response += `  - Scripts: ${scriptCount}\n`;
        response += `  - Conversations: ${conversationCount}\n\n`;
        
        response += `<span class="neon">System Status:</span>\n`;
        response += `  - Iteration: ${Store.iter}\n`;
        response += `  - Python Runtime: ${pyodideLoaded ? 'READY' : 'NOT LOADED'}\n`;
        response += `  - Training: ACTIVE\n`;
        
        return response;
      },
      
      showScriptCatalog(){
        this.navigate('guide');
        return "Check the Guide tab for the Script Catalog with ready-to-use templates!";
      },
      
      exportTemplate(templateId){
        const template = document.getElementById(templateId);
        if (template) {
          const content = template.textContent;
          const title = templateId.replace('js-', '').replace('py-', '');
          
          const markdownContent = `# ${title}\n\nThis is a script template for the WEBXOS chatbot.\n\n\`\`\`${templateId.startsWith('js-') ? 'javascript' : 'python'}\n${content}\n\`\`\``;
          
          const blob = new Blob([markdownContent], {type:'text/markdown'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${title}.md`;
          a.click();
          URL.revokeObjectURL(a.href);
        }
      },
      
      exportAllTemplates(){
        const templates = [
          'js-calculator', 'js-data', 'py-calculator', 'py-data', 'py-text'
        ];
        
        let allContent = '# WEBXOS Script Templates\n\nAll available script templates for the WEBXOS chatbot.\n\n';
        
        templates.forEach(templateId => {
          const template = document.getElementById(templateId);
          if (template) {
            const content = template.textContent;
            const title = templateId.replace('js-', '').replace('py-', '');
            const language = templateId.startsWith('js-') ? 'javascript' : 'python';
            
            allContent += `## ${title}\n\n\`\`\`${language}\n${content}\n\`\`\`\n\n`;
          }
        });
        
        const blob = new Blob([allContent], {type:'text/markdown'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'webxos-templates.md';
        a.click();
        URL.revokeObjectURL(a.href);
      },
      
      // Export combined packs & scripts
      exportAll(){
        const header = [
          '---',
          `exported: ${new Date().toISOString()}`,
          `packs: ${Store.packs.length}`,
          `scripts: ${Store.scripts.length}`,
          `conversations: ${Store.conversations.length}`,
          'format: webxos-enhanced-scripts',
          '---',
          ''
        ].join('\n');

        const packsMD = Store.packs.map(p=>{
          return [
            `# Pack: ${p.name}`,
            `id: ${p.id}`,
            '',
            (p.content||'').trim(),
            ''
          ].join('\n');
        }).join('\n');

        const scriptsMD = [
          '# Scripts',
          '',
          ...Store.scripts.map(s=>{
            return [
              `## ${s.title}`,
              `language: ${s.language}`,
              `sourcePackId: ${s.sourcePackId}`,
              '',
              '```' + (s.language||'javascript'),
              s.content||'',
              '```',
              ''
            ].join('\n');
          })
        ].join('\n');

        const blob = new Blob([header + packsMD + '\n' + scriptsMD], {type:'text/markdown'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'webxos-export.md';
        a.click();
        URL.revokeObjectURL(a.href);
      }
    };

    // Global helpers
    window.App = App;
    window.Modal = Modal;

    // Initialize
    document.addEventListener('DOMContentLoaded', ()=> App.init());
  </script>
</body>
</html>