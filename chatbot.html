<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WEBXOS — CHATBOT version 2</title>
  <style>
    :root{--bg:#0b0b0b;--panel:#111;--muted:#9aa;--accent:#39FF14;--accent-dark:#0a2e0a}
    html,body{height:100%;margin:0;background:var(--bg);color:#e7e7e7;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif}
    .app{display:flex;height:100%}
    .sidebar{width:220px;background:var(--panel);padding:18px;box-sizing:border-box;border-right:1px solid rgba(255,255,255,0.03)}
    .brand{color:var(--accent);font-weight:700;margin-bottom:12px}
    .nav{margin:12px 0}
    .nav button{display:block;width:100%;margin:6px 0;padding:8px;border:0;background:transparent;color:#ddd;text-align:left;cursor:pointer;border-radius:6px}
    .nav button.active{background:linear-gradient(90deg,rgba(57,255,20,0.06),transparent);color:var(--accent)}
    .main{flex:1;display:flex;flex-direction:column;padding:18px;box-sizing:border-box}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent-dark);color:var(--accent);border:1px solid var(--accent);padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#111;border:1px solid rgba(255,255,255,0.06);color:#ddd}
    .progress{height:10px;background:#0f0f0f;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7afc7a);width:0%}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:12px;flex:1;min-height:0}
    .panel{background:var(--panel);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);overflow:auto}
    .file-drop{border:2px dashed rgba(57,255,20,0.12);padding:16px;border-radius:8px;text-align:center;cursor:pointer}
    .file-drop.drag{background:rgba(57,255,20,0.02);border-color:rgba(57,255,20,0.28)}
    .kbd{background:#0a0a0a;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}
    .chat{display:flex;flex-direction:column;height:100%}
    .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:85%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .msg.user{margin-left:auto;background:linear-gradient(180deg,var(--accent-dark),#053009);color:var(--accent);border:1px solid rgba(57,255,20,0.12)}
    .msg.bot{background:#0e0e0e;color:#ddd}
    .composer{display:flex;gap:8px;margin-top:8px}
    input[type="text"]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#0b0b0b;color:#eee}
    pre.md-preview{white-space:pre-wrap;background:#070707;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);color:#e6ffe6;max-height:400px;overflow:auto}
    .meta{font-size:13px;color:var(--muted);margin-top:6px}
    .topic-badge{display:inline-block;background:transparent;border:1px solid rgba(57,255,20,0.12);color:var(--accent);padding:4px 8px;border-radius:999px;margin:2px;font-size:12px}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">WEBXOS — CHATBOT</div>
      <div class="nav">
        <button id="nav-chat" class="active">Chat</button>
        <button id="nav-train">Train</button>
        <button id="nav-knowledge">Knowledge Pack</button>
      </div>
      <div style="margin-top:18px">
        <div class="small">Mode</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div class="kbd">Markdown only</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="top">
        <div>
          <strong class="small neon">Training</strong>
          <div class="meta">Progress: <span id="progress-label">0%</span></div>
          <div style="width:220px;margin-top:6px" class="progress"><i id="progress-bar"></i></div>
        </div>
        <div class="controls">
          <button id="btn-preview" class="btn secondary">Preview Pack</button>
          <button id="btn-download" class="btn secondary">Download .md</button>
          <label for="file-input" class="btn">Add .md</label>
          <input id="file-input" type="file" accept=".md" style="display:none" multiple />
        </div>
      </div>

      <div class="grid">
        <section class="panel" id="left-panel">
          <!-- dynamic content: chat or train -->
          <div id="view-chat" class="chat">
            <div class="messages" id="messages">
              <div class="msg bot"><strong>Assistant</strong>
                <div class="small">Upload Markdown files to train me. Ask concise questions after training.</div>
                <div style="margin-top:8px">
                  <span class="topic-badge">How to add data</span>
                  <span class="topic-badge">Supported files</span>
                </div>
              </div>
            </div>

            <div class="composer">
              <input id="chat-input" type="text" placeholder="Ask about a topic from your uploaded markdown..." />
              <button id="send-btn" class="btn">Send</button>
            </div>
          </div>

          <div id="view-train" style="display:none">
            <div style="display:flex;flex-direction:column;gap:12px">
              <div id="drop-area" class="file-drop">Drag & drop Markdown files here, or click 'Add .md'</div>
              <div id="file-list" class="small meta"></div>
              <div style="display:flex;gap:8px">
                <button id="process-btn" class="btn" disabled>Parse & Build Pack</button>
                <button id="clear-btn" class="btn secondary">Clear</button>
              </div>
              <div id="topics" class="meta"></div>
              <pre id="pack-preview" class="md-preview" style="display:none"></pre>
            </div>
          </div>

          <div id="view-knowledge" style="display:none">
            <h3 style="margin-top:0">Knowledge Pack (Markdown)</h3>
            <pre id="knowledge-output" class="md-preview"></pre>
          </div>
        </section>

        <aside class="panel" id="right-panel">
          <h4 style="margin-top:0">Training Summary</h4>
          <div class="meta">Files parsed: <span id="meta-files">0</span></div>
          <div class="meta">Sections: <span id="meta-sections">0</span></div>
          <div class="meta">Topics: <span id="meta-topics">0</span></div>
          <div style="margin-top:12px">
            <strong class="small">Learned topics</strong>
            <div id="learned" style="margin-top:8px"></div>
          </div>

          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />
          <div class="small">Design: Markdown-only pipeline. Hybrid agent reorganizes headings → topics → Q&A blocks. Chatbot references the consolidated Knowledge Pack for concise answers.</div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    // Lightweight Markdown-only trainer + simple hybrid agent
    (function(){
      const navChat = document.getElementById('nav-chat');
      const navTrain = document.getElementById('nav-train');
      const navKnowledge = document.getElementById('nav-knowledge');
      const viewChat = document.getElementById('view-chat');
      const viewTrain = document.getElementById('view-train');
      const viewKnowledge = document.getElementById('view-knowledge');
      const messages = document.getElementById('messages');
      const sendBtn = document.getElementById('send-btn');
      const chatInput = document.getElementById('chat-input');
      const fileInput = document.getElementById('file-input');
      const dropArea = document.getElementById('drop-area');
      const fileList = document.getElementById('file-list');
      const processBtn = document.getElementById('process-btn');
      const clearBtn = document.getElementById('clear-btn');
      const packPreview = document.getElementById('pack-preview');
      const knowledgeOutput = document.getElementById('knowledge-output');
      const progressBar = document.getElementById('progress-bar');
      const progressLabel = document.getElementById('progress-label');
      const metaFiles = document.getElementById('meta-files');
      const metaSections = document.getElementById('meta-sections');
      const metaTopics = document.getElementById('meta-topics');
      const learnedNode = document.getElementById('learned');
      const btnPreview = document.getElementById('btn-preview');
      const btnDownload = document.getElementById('btn-download');

      let files = [];
      let trainingData = []; // {title, body, qapairs: [{q,a}], source}
      let knowledgePack = '';
      let topics = new Set();

      // Navigation
      function setView(view){
        [navChat,navTrain,navKnowledge].forEach(n=>n.classList.remove('active'));
        [viewChat,viewTrain,viewKnowledge].forEach(v=>v.style.display='none');
        if(view==='chat'){navChat.classList.add('active');viewChat.style.display='flex'}
        if(view==='train'){navTrain.classList.add('active');viewTrain.style.display='block'}
        if(view==='knowledge'){navKnowledge.classList.add('active');viewKnowledge.style.display='block'}
      }
      navChat.onclick = ()=>setView('chat');
      navTrain.onclick = ()=>setView('train');
      navKnowledge.onclick = ()=>{ buildKnowledgePack(); setView('knowledge') };

      // File handling (Markdown only)
      fileInput.addEventListener('change', e=>{
        handleFiles(Array.from(e.target.files));
      });

      dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('drag'); });
      dropArea.addEventListener('dragleave', e=>{ dropArea.classList.remove('drag'); });
      dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.classList.remove('drag'); handleFiles(Array.from(e.dataTransfer.files)); });

      function handleFiles(list){
        // accept only .md
        files = files.concat(list.filter(f=>f.name.toLowerCase().endsWith('.md')));
        fileList.textContent = files.length ? files.map(f=>f.name).join(', ') : 'No files';
        processBtn.disabled = files.length===0;
      }

      clearBtn.onclick = ()=>{ files = []; fileList.textContent=''; processBtn.disabled=true; resetTraining(); }

      // Parsing: headings -> sections, flush at end
      async function parseMarkdownFile(content, name){
        const lines = content.split(/\r?\n/);
        let currentTitle = null;
        let currentBody = [];
        const sections = [];
        const push = ()=>{
          if(currentTitle && currentBody.join(' ').trim().length>4){
            const body = currentBody.join(' ').trim();
            sections.push({ title: currentTitle.trim(), body, source: name });
          }
          currentBody = [];
        };
        for(const raw of lines){
          const line = raw.replace(/\t/g,' ').trim();
          if(/^#{1,6}\s+/.test(line)){
            // heading
            push();
            currentTitle = line.replace(/^#{1,6}\s+/,'');
          } else {
            if(line.length && !line.startsWith('```')) currentBody.push(line);
          }
        }
        // flush last
        push();
        return sections;
      }

      async function processFiles(){
        // reset
        trainingData = []; topics = new Set();
        updateMeta();
        let processed = 0;
        for(const file of files){
          try{
            const text = await readFileAsText(file);
            const sections = await parseMarkdownFile(text, file.name);
            for(const s of sections){
              // create simple QA pair: question = tell me about <title>
              const q = `tell me about ${s.title}`;
              trainingData.push({ title: s.title, body: s.body, qapairs:[{q,a:s.body}], source:file.name });
              topics.add(s.title);
            }
            processed++;
            updateProgress(Math.round(processed/files.length*100));
          }catch(err){
            appendSystem('Error parsing ' + file.name + ': ' + err.message, 'error');
          }
        }
        // finalize
        updateMeta();
        buildKnowledgePack();
        packPreview.style.display = 'block';
        packPreview.textContent = knowledgePack;
        appendSystem(`Parsed ${files.length} markdown file(s). Knowledge pack built.`, 'ok');
      }

      processBtn.onclick = processFiles;

      // Helpers
      function readFileAsText(file){
        return new Promise((res,rej)=>{
          const r=new FileReader();
          r.onload=()=>res(r.result);
          r.onerror=()=>rej(r.error);
          r.readAsText(file);
        });
      }

      function updateProgress(p){
        progressBar.style.width = p + '%';
        progressLabel.textContent = p + '%';
      }
      function updateMeta(){
        metaFiles.textContent = files.length;
        metaSections.textContent = trainingData.length;
        metaTopics.textContent = topics.size;
        // learned topics display
        learnedNode.innerHTML = '';
        Array.from(topics).slice(0,40).forEach(t=>{
          const el = document.createElement('div'); el.className='topic-badge'; el.textContent=t; learnedNode.appendChild(el);
        });
      }
      function appendSystem(text, type='info'){
        const el = document.createElement('div'); el.className='msg bot';
        el.innerHTML = `<strong>${type==='error'?'Error':'Training'}</strong><div class="small" style="margin-top:6px">${text}</div>`;
        messages.appendChild(el); messages.scrollTop = messages.scrollHeight;
      }

      // Build Knowledge Pack (Markdown)
      function buildKnowledgePack(){
        const header = [
          '---',
          'title: WebXOS Knowledge Pack',
          `generated: ${new Date().toISOString()}`,
          `topicsCount: ${topics.size}`,
          `entries: ${trainingData.length}`,
          '---',
          '',
          '# Table of Contents',
          ...Array.from(topics).map(t=>`- ${t}`),
          ''
        ].join('\n');

        const body = trainingData.map((d,i)=>{
          const title = d.title || `Entry ${i+1}`;
          const q = d.qapairs && d.qapairs[0] ? d.qapairs[0].q : `tell me about ${title}`;
          const a = d.qapairs && d.qapairs[0] ? d.qapairs[0].a : d.body || '';
          return [
            `## ${escapeMarkdownTitle(title)}`,
            '',
            a,
            '',
            '### Q&A',
            `- Question: ${q}`,
            `- Answer: ${a.length>240 ? a.slice(0,240) + '...' : a}`,
            ''
          ].join('\n');
        }).join('\n');

        knowledgePack = header + '\n' + body;
        knowledgeOutput.textContent = knowledgePack;
        updateProgress( Math.min(100, 50 + Math.round(trainingData.length*2)) );
      }

      function escapeMarkdownTitle(s){ return s.replace(/\|/g,'\\|'); }

      // Simple chat: match by exact q or token overlap
      function simpleSimilarity(a,b){
        const tok = s=> new Set(s.toLowerCase().split(/[^a-z0-9]+/).filter(Boolean));
        const A=tok(a), B=tok(b);
        const inter = Array.from(A).filter(x=>B.has(x)).length;
        const uni = new Set([...A,...B]).size || 1;
        return inter/uni;
      }

      function answerQuery(q){
        if(trainingData.length===0) return {text:"No training data. Please upload Markdown files in Train view."};
        const LQ = q.toLowerCase();
        // exact match on qapairs
        for(const entry of trainingData){
          for(const qa of entry.qapairs||[]){
            if(LQ.includes(qa.q.toLowerCase()) || qa.q.toLowerCase().includes(LQ)) return {text:qa.a, source:entry.source};
          }
        }
        // title overlap scoring
        const scored = trainingData.map(e=>{
          return {e,score:simpleSimilarity(LQ, e.title || '')};
        }).sort((a,b)=>b.score-a.score);
        if(scored.length && scored[0].score > 0.2) return {text:scored[0].e.body, source:scored[0].e.source};
        // fallback: show short guidance + top topics
        const top = Array.from(topics).slice(0,6).join(', ');
        return {text:`I couldn't find an exact answer. Try asking about a section title like: ${top}`};
      }

      // Chat UI
      function pushMessage(text, cls='bot'){
        const el = document.createElement('div'); el.className='msg ' + (cls==='user'?'user':'bot');
        el.innerHTML = `<div>${text}</div>`;
        messages.appendChild(el); messages.scrollTop = messages.scrollHeight;
      }

      sendBtn.onclick = ()=>{
        const v = chatInput.value.trim(); if(!v) return;
        pushMessage(v,'user');
        chatInput.value='';
        // simulate small delay
        setTimeout(()=>{
          const ans = answerQuery(v);
          pushMessage(ans.text,'bot');
        }, 250);
      };
      chatInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ sendBtn.click(); } });

      // Preview & Download
      btnPreview.onclick = ()=>{ buildKnowledgePack(); setView('knowledge'); };
      btnDownload.onclick = ()=>{
        buildKnowledgePack();
        const blob = new Blob([knowledgePack], {type:'text/markdown;charset=utf-8'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'webxos-knowledge-pack.md'; document.body.appendChild(a); a.click(); a.remove();
      };

      // Reset training
      function resetTraining(){
        trainingData = []; knowledgePack=''; topics = new Set();
        packPreview.style.display='none';
        knowledgeOutput.textContent='';
        metaFiles.textContent=0; metaSections.textContent=0; metaTopics.textContent=0; learnedNode.innerHTML='';
        updateProgress(0);
      }

      // Init
      setView('chat');
      updateProgress(0);
    })();
  </script>
</body>
</html>

