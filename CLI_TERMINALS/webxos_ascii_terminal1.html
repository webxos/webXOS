<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBXOS Terminal v3.0</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon: #00ff00;
            --dark: #000000;
            --dim: #003300;
            --script-yellow: #ffff00;
            --neon-glow: 0 0 10px #00ff00, 0 0 20px #00ff00, 0 0 30px #00ff00;
            --neon-glow-bright: 0 0 15px #00ff00, 0 0 25px #00ff00, 0 0 35px #00ff00;
            --yellow-glow: 0 0 10px #ffff00, 0 0 20px #ffff00;
            --neon-bright: #00ff00;
            --neon-brighter: #00ff88;
        }

        body {
            background: var(--dark);
            color: var(--neon);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.2;
            height: 100vh;
            overflow: hidden;
        }

        /* Enhanced Loading Screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-logo {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: var(--neon);
            white-space: pre;
            line-height: 1;
            margin-bottom: 20px;
            text-align: center;
        }

        .loading-progress-container {
            width: 300px;
            height: 8px;
            background: var(--dim);
            border: 1px solid var(--neon);
            margin: 10px 0;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--neon);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-status {
            color: var(--neon);
            font-size: 11px;
            margin-top: 10px;
            text-align: center;
            min-height: 16px;
        }

        /* Terminal Container */
        #terminal-container {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: var(--dark);
        }

        /* Output Area */
        #output {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            scroll-behavior: smooth;
        }

        .line {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .cmd {
            color: var(--neon);
        }

        .response {
            color: var(--neon);
        }

        .error {
            color: #ff0000;
        }

        .info {
            color: var(--neon);
        }

        .ai-response {
            color: var(--neon);
            margin-left: 10px;
        }

        /* Script output in yellow */
        .script-output {
            color: var(--script-yellow);
        }

        /* Calculator specific */
        .calculator {
            color: var(--script-yellow);
            background: rgba(255, 255, 0, 0.05);
            border-left: 2px solid var(--script-yellow);
            padding: 8px;
            margin: 8px 0;
        }

        .calc-input {
            background: rgba(255, 255, 0, 0.1);
            border: 1px solid var(--script-yellow);
            color: var(--script-yellow);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 4px;
            margin-top: 8px;
            width: 100%;
        }

        /* File Content Display */
        .file-content {
            color: var(--neon);
            background: rgba(0, 51, 0, 0.1);
            border-left: 2px solid var(--neon);
            padding: 8px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .file-header {
            color: var(--dim);
            font-size: 11px;
            margin-bottom: 4px;
            padding-bottom: 2px;
            border-bottom: 1px solid var(--dim);
        }

        /* Input Container */
        #input-container {
            height: 30px;
            background: var(--dark);
            display: flex;
            align-items: center;
            padding: 0 8px;
            flex-shrink: 0;
            gap: 8px;
            border-top: 1px solid var(--dim);
        }

        .prompt-indicator {
            color: var(--neon);
            font-weight: bold;
        }

        #input-display {
            flex: 1;
            position: relative;
            height: 20px;
        }

        .input-text {
            position: absolute;
            top: 0;
            left: 0;
            color: var(--neon);
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre;
            line-height: 20px;
            height: 20px;
        }

        .cursor {
            position: absolute;
            top: 2px;
            left: 0;
            width: 6px;
            height: 14px;
            background: var(--neon);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        #hidden-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        /* Buttons */
        .btn {
            background: transparent;
            border: none;
            color: var(--neon);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 2px 4px;
            text-transform: uppercase;
        }

        .btn:hover {
            text-decoration: underline;
        }

        /* Scrollbar */
        #output::-webkit-scrollbar {
            width: 4px;
        }

        #output::-webkit-scrollbar-track {
            background: transparent;
        }

        #output::-webkit-scrollbar-thumb {
            background: var(--dim);
        }

        /* Compact Modals */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark);
            color: var(--neon);
            z-index: 2000;
            padding: 12px;
            width: 85vw;
            height: 85vh;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            border: 1px solid var(--neon);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--neon);
        }

        .modal-title {
            color: var(--neon);
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--neon);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .modal-content {
            height: calc(100% - 40px);
            overflow-y: auto;
            font-size: 12px;
        }

        /* Lightweight Script Editor */
        .script-item {
            padding: 3px 4px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid var(--dim);
        }

        .script-item:hover {
            background: rgba(0, 255, 0, 0.05);
        }

        .script-title {
            color: var(--neon);
            font-weight: bold;
        }

        .script-desc {
            color: var(--dim);
            font-size: 9px;
            margin-left: 8px;
        }

        .editor-container {
            height: 300px;
            margin: 8px 0;
        }

        .editor {
            width: 100%;
            height: 250px;
            background: var(--dark);
            color: var(--neon);
            border: 1px solid var(--neon);
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 6px;
            outline: none;
            resize: none;
        }

        .output-area {
            width: 100%;
            height: 80px;
            background: var(--dark);
            color: var(--neon);
            border: 1px solid var(--dim);
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 4px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 4px;
        }

        /* Two-panel layout for scripts */
        .script-layout {
            display: flex;
            height: calc(100% - 30px);
            gap: 8px;
        }

        .script-list {
            width: 200px;
            overflow-y: auto;
            border-right: 1px solid var(--dim);
            padding-right: 4px;
        }

        .script-editor-panel {
            flex: 1;
            overflow-y: auto;
        }

        /* Compact Controls */
        .controls {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .control-btn {
            background: transparent;
            border: 1px solid var(--neon);
            color: var(--neon);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 2px 6px;
        }

        .control-btn:hover {
            background: rgba(0, 255, 0, 0.1);
        }

        .control-btn.mount {
            background: rgba(255, 255, 0, 0.1);
            border-color: var(--script-yellow);
            color: var(--script-yellow);
        }

        .control-btn.mount:hover {
            background: rgba(255, 255, 0, 0.2);
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }

        /* Status */
        .status {
            position: fixed;
            bottom: 4px;
            right: 8px;
            font-size: 9px;
            color: var(--dim);
            z-index: 100;
        }

        /* Suggestions with NEON GLOW */
        .suggestions {
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid var(--dim);
            font-size: 10px;
            color: var(--dim);
        }

        .suggestion {
            display: inline-block;
            margin-right: 8px;
            cursor: pointer;
            color: var(--neon-bright);
            font-size: 10px;
            text-decoration: none;
            padding: 2px 6px;
            border-radius: 2px;
            transition: all 0.3s ease;
            text-shadow: var(--neon-glow);
            background: rgba(0, 255, 0, 0.05);
        }

        .suggestion.yellow {
            color: var(--script-yellow);
            text-shadow: var(--yellow-glow);
            background: rgba(255, 255, 0, 0.1);
        }

        .suggestion:hover {
            color: var(--neon-brighter);
            text-shadow: var(--neon-glow-bright);
            background: rgba(0, 255, 0, 0.1);
            transform: translateY(-1px);
        }

        .suggestion.yellow:hover {
            color: #ffff88;
            text-shadow: 0 0 15px #ffff00, 0 0 25px #ffff00;
            background: rgba(255, 255, 0, 0.2);
        }

        .suggestion:active {
            transform: translateY(0);
        }

        /* Mounted badge */
        .mounted-badge {
            display: inline-block;
            background: rgba(255, 255, 0, 0.2);
            color: var(--script-yellow);
            font-size: 8px;
            padding: 1px 3px;
            margin-left: 4px;
            border-radius: 2px;
            border: 1px solid var(--script-yellow);
            text-transform: uppercase;
        }

        /* ASCII Art */
        .ascii {
            font-family: 'Courier New', monospace;
            font-size: 8px;
            line-height: 0.9;
            white-space: pre;
            margin-bottom: 8px;
            color: var(--script-yellow);
        }

        /* Context Library */
        .context-item {
            padding: 3px 4px;
            cursor: pointer;
            font-size: 11px;
            border-bottom: 1px solid var(--dim);
        }

        .context-item:hover {
            background: rgba(0, 255, 0, 0.05);
        }

        .context-name {
            color: var(--neon);
            font-weight: bold;
        }

        .context-preview {
            color: var(--dim);
            font-size: 9px;
            margin-left: 8px;
        }

        /* Upload Area */
        .upload-area {
            text-align: center;
            padding: 20px;
            border: 1px dashed var(--neon);
            margin-bottom: 8px;
            cursor: pointer;
        }

        .upload-area:hover {
            background: rgba(0, 255, 0, 0.03);
        }

        /* File Info */
        .file-info {
            font-size: 9px;
            color: var(--dim);
            margin-top: 4px;
        }

        /* Export Modal Specific */
        .export-section {
            margin-bottom: 16px;
            border: 1px solid var(--dim);
            padding: 8px;
        }

        .export-section-title {
            color: var(--neon);
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--dim);
        }

        .export-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .export-option {
            background: transparent;
            border: 1px solid var(--neon);
            color: var(--neon);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 4px 8px;
            text-transform: uppercase;
        }

        .export-option.active {
            background: rgba(0, 255, 0, 0.1);
        }

        .export-option:hover {
            background: rgba(0, 255, 0, 0.1);
        }

        .export-files-container {
            display: flex;
            gap: 16px;
            height: 300px;
            margin-bottom: 12px;
        }

        .export-files-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--dim);
            padding: 4px;
        }

        .export-files-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .export-file-item {
            padding: 3px 4px;
            font-size: 11px;
            border-bottom: 1px solid var(--dim);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-file-item:hover {
            background: rgba(0, 255, 0, 0.05);
        }

        .export-checkbox {
            accent-color: var(--neon);
        }

        .export-file-name {
            color: var(--neon);
            flex: 1;
        }

        .export-file-type {
            color: var(--dim);
            font-size: 9px;
            text-transform: uppercase;
        }

        .export-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }

        .export-action-btn {
            background: transparent;
            border: 1px solid var(--neon);
            color: var(--neon);
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 6px 12px;
            text-transform: uppercase;
            min-width: 100px;
        }

        .export-action-btn:hover {
            background: rgba(0, 255, 0, 0.1);
        }

        .export-action-btn.primary {
            background: rgba(0, 255, 0, 0.05);
            border-width: 2px;
        }

        /* Interactive Lists */
        .interactive-list {
            margin: 8px 0;
            padding-left: 15px;
        }

        .list-item {
            margin: 4px 0;
            padding: 2px 4px;
            cursor: pointer;
            color: var(--neon);
            border-left: 2px solid transparent;
        }

        .list-item:hover {
            border-left: 2px solid var(--neon);
            background: rgba(0, 255, 0, 0.05);
        }

        .list-item-link {
            color: var(--neon);
            text-decoration: underline;
            cursor: pointer;
        }

        .list-item-link.yellow {
            color: var(--script-yellow);
            text-shadow: var(--yellow-glow);
        }

        .list-item-link:hover {
            color: var(--neon-brighter);
            text-shadow: var(--neon-glow);
        }

        .list-item-link.yellow:hover {
            color: #ffff88;
            text-shadow: 0 0 15px #ffff00, 0 0 25px #ffff00;
        }

        .list-item-meta {
            color: var(--dim);
            font-size: 10px;
            margin-left: 8px;
        }

        /* Yellow script text */
        .yellow-text {
            color: var(--script-yellow);
        }

        .yellow-border {
            border-left: 2px solid var(--script-yellow);
        }

        /* Mount indicator */
        .mount-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--script-yellow);
            border-radius: 50%;
            margin-left: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Calculator input area */
        .calc-prompt {
            color: var(--script-yellow);
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <!-- Enhanced Loading Screen -->
    <div id="loading">
        <div class="loading-logo">
    :::       ::: :::::::::: :::::::::  :::    :::  ::::::::   :::::::: 
   :+:       :+: :+:        :+:    :+: :+:    :+: :+:    :+: :+:    :+: 
  +:+       +:+ +:+        +:+    +:+  +:+  +:+  +:+    +:+ +:+         
 +#+  +:+  +#+ +#++:++#   +#++:++#+    +#++:+   +#+    +:+ +#++:++#++   
+#+ +#+#+ +#+ +#+        +#+    +#+  +#+  +#+  +#+    +#+        +#+    
#+#+# #+#+#  #+#        #+#    #+# #+#    #+# #+#    #+# #+#    #+#     
###   ###   ########## #########  ###    ###  ########   ########       
        </div>
        <div style="color:var(--neon); margin-bottom:10px; font-size:12px;">WEBXOS v3.0</div>
        
        <div class="loading-progress-container">
            <div class="loading-progress-bar" id="loading-progress"></div>
        </div>
        
        <div class="loading-status" id="loading-status">Initializing...</div>
    </div>

    <!-- Terminal Container -->
    <div id="terminal-container">
        <div id="output"></div>
        <div id="input-container">
            <span class="prompt-indicator">$</span>
            <div id="input-display">
                <div id="input-text" class="input-text"></div>
                <div id="cursor" class="cursor"></div>
            </div>
            <button class="btn" onclick="importCommand()">IMPORT</button>
            <button class="btn" onclick="openExportModal()">EXPORT</button>
            <button class="btn" onclick="sendCommand()">SEND</button>
            <input type="text" id="hidden-input" autocomplete="off" spellcheck="false">
        </div>
    </div>

    <!-- Status -->
    <div class="status" id="status"></div>

    <!-- Overlay for modals -->
    <div class="overlay" id="overlay"></div>

    <!-- Script Library Modal - Compact -->
    <div class="modal" id="script-modal">
        <div class="modal-header">
            <div class="modal-title">SCRIPTS</div>
            <button class="modal-close" onclick="closeModal('script-modal')">×</button>
        </div>
        <div class="modal-content">
            <div class="script-layout">
                <div class="script-list" id="script-list">
                    <!-- Scripts will be listed here -->
                </div>
                <div class="script-editor-panel">
                    <div class="editor-container">
                        <textarea id="script-editor" class="editor" placeholder="// write javascript here...
// use console.log() for output"></textarea>
                        <div class="output-area" id="script-output"></div>
                    </div>
                    <div class="controls">
                        <button class="control-btn" onclick="newScript()">NEW SCRIPT</button>
                        <button class="control-btn" onclick="saveScript()">SAVE</button>
                        <button class="control-btn" onclick="mountScript()" id="mount-btn">MOUNT</button>
                        <button class="control-btn" onclick="runScript()">RUN</button>
                        <button class="control-btn" onclick="uploadScript()">UPLOAD</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Library Modal - Compact -->
    <div class="modal" id="context-modal">
        <div class="modal-header">
            <div class="modal-title">CONTEXT</div>
            <button class="modal-close" onclick="closeModal('context-modal')">×</button>
        </div>
        <div class="modal-content">
            <div class="script-layout">
                <div class="script-list" id="context-list">
                    <!-- Context files will be listed here -->
                </div>
                <div class="script-editor-panel">
                    <div class="editor-container">
                        <textarea id="context-editor" class="editor" placeholder="# markdown content
## sections
- bullet points
- more content"></textarea>
                        <div class="file-info" id="context-info">0 chars</div>
                    </div>
                    <div class="controls">
                        <button class="control-btn" onclick="newContext()">NEW MD</button>
                        <button class="control-btn" onclick="saveContext()">SAVE</button>
                        <button class="control-btn" onclick="readContext()">READ</button>
                        <button class="control-btn" onclick="uploadContext()">UPLOAD</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal - Compact -->
    <div class="modal" id="upload-modal">
        <div class="modal-header">
            <div class="modal-title" id="upload-title">UPLOAD</div>
            <button class="modal-close" onclick="closeModal('upload-modal')">×</button>
        </div>
        <div class="modal-content">
            <div class="upload-area" onclick="triggerFileInput()">
                <div style="font-size: 20px; margin-bottom: 8px;">⬆️</div>
                <div style="font-size: 12px; margin-bottom: 4px;">SELECT FILES</div>
                <div style="color: var(--dim); font-size: 9px;" id="upload-accept-text">.md .txt .js .json</div>
            </div>
            
            <input type="file" id="file-input" style="display: none;" multiple onchange="handleFileUpload(event)">
            
            <div id="upload-status" style="margin:8px 0; font-size:10px; text-align:center;"></div>
            
            <div class="controls" style="justify-content: center;">
                <button class="control-btn" onclick="processUploadedFiles()" id="process-btn" style="display: none;">PROCESS</button>
                <button class="control-btn" onclick="closeModal('upload-modal')">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Export Modal - New -->
    <div class="modal" id="export-modal">
        <div class="modal-header">
            <div class="modal-title">EXPORT</div>
            <button class="modal-close" onclick="closeModal('export-modal')">×</button>
        </div>
        <div class="modal-content">
            <div class="export-section">
                <div class="export-section-title">EXPORT OPTIONS</div>
                <div class="export-options">
                    <button class="export-option active" onclick="setExportOption('all')" id="export-option-all">ALL (Unified JSON)</button>
                    <button class="export-option" onclick="setExportOption('context')" id="export-option-context">CONTEXT (.md)</button>
                    <button class="export-option" onclick="setExportOption('scripts')" id="export-option-scripts">SCRIPTS (.js)</button>
                    <button class="export-option" onclick="setExportOption('selected')" id="export-option-selected">SELECTED FILES</button>
                </div>
            </div>

            <div class="export-section">
                <div class="export-section-title">FILES</div>
                <div class="export-files-container">
                    <div class="export-files-column">
                        <div style="color:var(--neon); font-size:11px; margin-bottom:6px;">CONTEXT FILES</div>
                        <div class="export-files-list" id="export-context-list">
                            <!-- Context files for selection -->
                        </div>
                    </div>
                    <div class="export-files-column">
                        <div style="color:var(--neon); font-size:11px; margin-bottom:6px;">SCRIPTS</div>
                        <div class="export-files-list" id="export-script-list">
                            <!-- Scripts for selection -->
                        </div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                    <button class="control-btn" onclick="selectAllFiles()">SELECT ALL</button>
                    <button class="control-btn" onclick="deselectAllFiles()">DESELECT ALL</button>
                </div>
            </div>

            <div class="export-actions">
                <button class="export-action-btn" onclick="closeModal('export-modal')">CANCEL</button>
                <button class="export-action-btn primary" onclick="performExport()">EXPORT</button>
            </div>
        </div>
    </div>

    <script>
        // WEBXOS Terminal v3.0 - Minimal Neon Green
        const WEBXOS_ASCII = `    :::       ::: :::::::::: :::::::::  :::    :::  ::::::::   :::::::: 
   :+:       :+: :+:        :+:    :+: :+:    :+: :+:    :+: :+:    :+: 
  +:+       +:+ +:+        +:+    +:+  +:+  +:+  +:+    +:+ +:+         
 +#+  +:+  +#+ +#++:++#   +#++:++#+    +#++:+   +#+    +:+ +#++:++#++   
+#+ +#+#+ +#+ +#+        +#+    +#+  +#+  +#+  +#+    +#+        +#+    
#+#+# #+#+#  #+#        #+#    #+# #+#    #+# #+#    #+# #+#    #+#     
###   ###   ########## #########  ###    ###  ########   ########       `;

        // HELLO WORLD ASCII in WEBXOS style
        const HELLO_WORLD_ASCII = `██╗  ██╗███████╗██╗     ██╗      ██████╗     ██╗    ██╗ ██████╗ ██████╗ ██╗     ██████╗ 
██║  ██║██╔════╝██║     ██║     ██╔═══██╗    ██║    ██║██╔═══██╗██╔══██╗██║     ██╔══██╗
███████║█████╗  ██║     ██║     ██║   ██║    ██║ █╗ ██║██║   ██║██████╔╝██║     ██║  ██║
██╔══██║██╔══╝  ██║     ██║     ██║   ██║    ██║███╗██║██║   ██║██╔══██╗██║     ██║  ██║
██║  ██║███████╗███████╗███████╗╚██████╔╝    ╚███╔███╔╝╚██████╔╝██║  ██║███████╗██████╔╝
╚═╝  ╚═╝╚══════╝╚══════╝╚══════╝ ╚═════╝      ╚══╝╚══╝  ╚═════╝ ╚═╝  ╚═╝╚══════╝╚═════╝ `;

        // Main State
        const state = {
            knowledgeBase: [],
            scripts: [],
            currentInput: '',
            history: [],
            histIndex: -1,
            cursorPosition: 0,
            typing: false,
            uploadedFiles: [],
            uploadType: '',
            activeScript: null,
            activeContext: null,
            autoScroll: true,
            isReadingFile: false,
            exportOption: 'all',
            selectedFiles: {
                context: [],
                scripts: []
            },
            mountedScripts: {
                calculator: false,
                hello: false
            },
            isCalculatorActive: false,
            calculatorFunction: null
        };

        // DOM Elements
        const loading = document.getElementById('loading');
        const terminalContainer = document.getElementById('terminal-container');
        const output = document.getElementById('output');
        const inputText = document.getElementById('input-text');
        const cursor = document.getElementById('cursor');
        const hiddenInput = document.getElementById('hidden-input');
        const status = document.getElementById('status');
        const loadingProgress = document.getElementById('loading-progress');
        const loadingStatus = document.getElementById('loading-status');

        // Initialize System with enhanced loading
        window.addEventListener('load', async () => {
            await initializeSystemWithProgress();
            setTimeout(() => {
                loading.style.display = 'none';
                terminalContainer.style.display = 'flex';
                initTerminal();
            }, 300);
        });

        async function initializeSystemWithProgress() {
            const steps = [
                {progress: 10, status: "Loading core modules..."},
                {progress: 25, status: "Initializing terminal..."},
                {progress: 40, status: "Loading scripts..."},
                {progress: 60, status: "Loading context files..."},
                {progress: 80, status: "Setting up interface..."},
                {progress: 95, status: "Finalizing..."},
                {progress: 100, status: "Ready"}
            ];

            for (let i = 0; i < steps.length; i++) {
                await updateLoadingProgress(steps[i].progress, steps[i].status);
                await delay(100 + Math.random() * 100);
            }
            
            await initializeSystem();
        }

        function updateLoadingProgress(progress, message) {
            return new Promise(resolve => {
                loadingProgress.style.width = progress + '%';
                loadingStatus.textContent = message;
                setTimeout(resolve, 50);
            });
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function initializeSystem() {
            addLine('INITIALIZING WEBXOS TERMINAL v3.0...', 'info');
            
            initBuiltinScripts();
            loadSavedData();
            updateStatus();
        }

        function initTerminal() {
            addASCII(WEBXOS_ASCII, 'info');
            addLine('WEBXOS TERMINAL v3.0', 'response');
            addLine('Type /help for commands', 'response');
            addLine(`Loaded: ${state.knowledgeBase.length} context files | ${state.scripts.length} scripts`, 'info');

            // Add initial suggestions with neon glow
            updateSuggestions();

            setupInput();
        }

        // Update suggestions with bright neon glow
        function updateSuggestions() {
            const suggestions = [
                { text: '/help', action: () => { state.currentInput = '/help'; sendCommand(); } },
                { text: '/scripts', action: () => { state.currentInput = '/scripts'; sendCommand(); } },
                { text: '/context', action: () => { state.currentInput = '/context'; sendCommand(); } },
                { text: '/read', action: () => { state.currentInput = '/read '; hiddenInput.focus(); updateDisplay(); } },
                { text: '/import', action: () => { state.currentInput = '/import'; sendCommand(); } },
                { text: '/export', action: () => { state.currentInput = '/export'; sendCommand(); } },
                { text: '/clear', action: () => { state.currentInput = '/clear'; sendCommand(); } },
                { text: '/stats', action: () => { state.currentInput = '/stats'; sendCommand(); } }
            ];

            // Add /hello only if hello script is mounted
            if (state.mountedScripts.hello) {
                suggestions.push({ 
                    text: '/hello', 
                    action: () => { state.currentInput = '/hello'; sendCommand(); },
                    yellow: true 
                });
            }

            // Add /calc only if calculator script is mounted
            if (state.mountedScripts.calculator) {
                suggestions.push({ 
                    text: '/calc', 
                    action: () => { state.currentInput = '/calc'; sendCommand(); },
                    yellow: true 
                });
            }

            addSuggestions(suggestions);
        }

        function setupInput() {
            hiddenInput.focus();
            hiddenInput.addEventListener('input', handleInput);
            hiddenInput.addEventListener('keydown', handleKey);
            document.addEventListener('click', () => hiddenInput.focus());
            updateDisplay();
        }

        function handleInput(e) {
            state.currentInput = hiddenInput.value;
            state.cursorPosition = hiddenInput.selectionStart;
            updateDisplay();
        }

        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendCommand();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateHistory(-1);
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateHistory(1);
            } else if (e.key === 'Tab') {
                e.preventDefault();
                autoComplete();
            } else {
                setTimeout(() => {
                    state.cursorPosition = hiddenInput.selectionStart;
                    updateDisplay();
                }, 0);
            }
        }

        function navigateHistory(direction) {
            if (state.history.length === 0) return;
            
            state.histIndex += direction;
            
            if (state.histIndex < -1) state.histIndex = -1;
            if (state.histIndex >= state.history.length) state.histIndex = state.history.length - 1;
            
            if (state.histIndex === -1) {
                state.currentInput = '';
            } else {
                state.currentInput = state.history[state.histIndex];
            }
            
            hiddenInput.value = state.currentInput;
            hiddenInput.selectionStart = hiddenInput.selectionEnd = state.currentInput.length;
            updateDisplay();
        }

        function autoComplete() {
            let commands = ['/help', '/context', '/scripts', '/import', '/export', 
                          '/clear', '/stats', '/read'];
            
            // Add /hello only if mounted
            if (state.mountedScripts.hello) {
                commands.push('/hello');
            }
            
            // Add /calc only if mounted
            if (state.mountedScripts.calculator) {
                commands.push('/calc');
            }
            
            const current = state.currentInput.toLowerCase();
            const matches = commands.filter(cmd => cmd.startsWith(current));
            
            if (matches.length === 1) {
                state.currentInput = matches[0];
                hiddenInput.value = state.currentInput;
                updateDisplay();
            } else if (matches.length > 1) {
                addLine('Suggestions: ' + matches.join(', '), 'info');
            }
        }

        function sendCommand() {
            const cmd = state.currentInput.trim();
            if (!cmd) return;
            
            if (state.history[0] !== cmd) {
                state.history.unshift(cmd);
            }
            state.histIndex = -1;
            
            addLine(`$ ${cmd}`, 'cmd');
            processCommand(cmd);
            
            state.currentInput = '';
            hiddenInput.value = '';
            updateDisplay();
            
            scrollToBottom();
        }

        function importCommand() {
            openUpload('both');
        }

        function openExportModal() {
            showModal('export-modal');
            renderExportLists();
        }

        function updateDisplay() {
            inputText.textContent = state.currentInput;
            
            const textBeforeCursor = state.currentInput.substring(0, state.cursorPosition);
            const tempSpan = document.createElement('span');
            tempSpan.style.fontFamily = "'Courier New', monospace";
            tempSpan.style.fontSize = '13px';
            tempSpan.style.whiteSpace = 'pre';
            tempSpan.style.position = 'absolute';
            tempSpan.style.visibility = 'hidden';
            tempSpan.textContent = textBeforeCursor;
            
            document.body.appendChild(tempSpan);
            const cursorLeft = tempSpan.offsetWidth;
            document.body.removeChild(tempSpan);
            
            cursor.style.left = cursorLeft + 'px';
        }

        function processCommand(cmd) {
            if (cmd.startsWith('/')) {
                const parts = cmd.split(' ');
                const cmdName = parts[0].toLowerCase();
                const args = parts.slice(1).join(' ');
                
                switch(cmdName) {
                    case '/help':
                        showHelp();
                        break;
                    case '/context':
                        if (args === 'list') {
                            showContextList();
                        } else if (args) {
                            // If there's an argument, try to open that specific file
                            openContextFile(args);
                        } else {
                            // Show interactive context list
                            showContextList();
                        }
                        break;
                    case '/scripts':
                        if (args === 'list') {
                            showScriptList();
                        } else if (args.startsWith('run ')) {
                            runScriptByName(args.substring(4));
                        } else if (args) {
                            // Try to run script by name
                            runScriptByName(args);
                        } else {
                            // Show interactive script list
                            showScriptList();
                        }
                        break;
                    case '/import':
                        openUpload('both');
                        break;
                    case '/export':
                        openExportModal();
                        break;
                    case '/clear':
                        clearTerminal();
                        break;
                    case '/stats':
                        showStats();
                        break;
                    case '/read':
                        if (args) readFile(args);
                        else showReadHelp();
                        break;
                    case '/hello':
                        if (state.mountedScripts.hello) {
                            runHelloWorld();
                        } else {
                            addLine('Hello script not mounted. Use /scripts and mount the hello script first.', 'error');
                        }
                        break;
                    case '/calc':
                        if (state.mountedScripts.calculator) {
                            runCalculatorTool();
                        } else {
                            addLine('Calculator script not mounted. Use /scripts and mount the calculator script first.', 'error');
                        }
                        break;
                    default:
                        addLine('Unknown command. Type /help.', 'error');
                }
            } else {
                // If calculator is active, process as calculator input
                if (state.isCalculatorActive) {
                    processCalculatorInput(cmd);
                } else {
                    chatWithAI(cmd);
                }
            }
        }

        function showHelp() {
            let help = `COMMANDS:
/help       - this help
/clear      - clear terminal
/stats      - system stats
/context    - show context files (click to edit)
/scripts    - show scripts (click to mount/run)
/import     - upload files
/export     - export data
/read [file]- read file with typewriter effect
`;

            // Add /hello only if mounted
            if (state.mountedScripts.hello) {
                help += `/hello      - display hello world ascii art\n`;
            }

            // Add /calc only if mounted
            if (state.mountedScripts.calculator) {
                help += `/calc       - interactive calculator tool\n`;
            }

            help += `\nType to chat with AI.`;

            addLine(help, 'response');
            
            // Show mounted scripts status
            if (state.mountedScripts.hello || state.mountedScripts.calculator) {
                addLine('\nMounted Scripts:', 'info');
                if (state.mountedScripts.hello) {
                    addLine('  • /hello - Mounted', 'script');
                }
                if (state.mountedScripts.calculator) {
                    addLine('  • /calc - Mounted', 'script');
                }
            }
        }

        // Show interactive context list with clickable links
        function showContextList() {
            if (state.knowledgeBase.length === 0) {
                addLine('No context files found.', 'info');
                addLine('Use /import to upload .md or .txt files', 'info');
                return;
            }
            
            addLine('CONTEXT FILES:', 'response');
            addLine('Click any file to open it in the editor:', 'info');
            
            const listContainer = document.createElement('div');
            listContainer.className = 'interactive-list';
            
            state.knowledgeBase.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                
                const link = document.createElement('span');
                link.className = 'list-item-link';
                link.textContent = `${index + 1}. ${file.name}`;
                link.onclick = () => {
                    openContextLibraryWithFile(file.id);
                };
                
                const meta = document.createElement('span');
                meta.className = 'list-item-meta';
                meta.textContent = `(${file.content.length} chars)`;
                
                item.appendChild(link);
                item.appendChild(meta);
                listContainer.appendChild(item);
            });
            
            output.appendChild(listContainer);
            scrollToBottom();
        }

        // Show interactive script list with clickable links - YELLOW
        function showScriptList() {
            if (state.scripts.length === 0) {
                addLine('No scripts found.', 'info');
                addLine('Use /import to upload .js files or create new scripts', 'info');
                return;
            }
            
            addLine('SCRIPTS:', 'response');
            addLine('Click any script to open in editor (yellow = mountable):', 'info');
            
            const listContainer = document.createElement('div');
            listContainer.className = 'interactive-list';
            
            state.scripts.forEach((script, index) => {
                const item = document.createElement('div');
                item.className = 'list-item';
                
                const link = document.createElement('span');
                link.className = 'list-item-link';
                // Make special scripts yellow
                if (script.title === 'hello' || script.title === 'calculator') {
                    link.classList.add('yellow');
                }
                link.textContent = `${index + 1}. ${script.title}`;
                link.onclick = () => {
                    // Open the script in the editor popup
                    openScriptLibraryWithScript(script.id);
                };
                
                const meta = document.createElement('span');
                meta.className = 'list-item-meta';
                meta.textContent = script.description;
                
                // Add mounted indicator
                if ((script.title === 'hello' && state.mountedScripts.hello) || 
                    (script.title === 'calculator' && state.mountedScripts.calculator)) {
                    const mountedBadge = document.createElement('span');
                    mountedBadge.className = 'mounted-badge';
                    mountedBadge.textContent = 'Mounted';
                    meta.appendChild(mountedBadge);
                }
                
                item.appendChild(link);
                item.appendChild(meta);
                listContainer.appendChild(item);
            });
            
            output.appendChild(listContainer);
            scrollToBottom();
        }

        // Open script library with specific script loaded
        function openScriptLibraryWithScript(scriptId) {
            showModal('script-modal');
            // Small delay to ensure modal is rendered
            setTimeout(() => {
                loadScript(scriptId);
            }, 100);
        }

        // Open context library with specific file loaded
        function openContextLibraryWithFile(fileId) {
            showModal('context-modal');
            // Small delay to ensure modal is rendered
            setTimeout(() => {
                loadContext(fileId);
            }, 100);
        }

        // Open specific context file
        function openContextFile(filename) {
            const file = state.knowledgeBase.find(f => 
                f.name.toLowerCase().includes(filename.toLowerCase()) ||
                f.name.toLowerCase().replace(/ /g, '_') === filename.toLowerCase()
            );
            
            if (file) {
                openContextLibraryWithFile(file.id);
            } else {
                addLine(`Context file not found: ${filename}`, 'error');
                showContextList();
            }
        }

        function showReadHelp() {
            addLine('Usage: /read [filename]', 'error');
            addLine('Available files:', 'info');
            if (state.knowledgeBase.length === 0) {
                addLine('  No files available', 'dim');
            } else {
                state.knowledgeBase.forEach((file, index) => {
                    addLine(`  ${index + 1}. ${file.name}`, 'info');
                });
            }
            addLine('Tip: Use tab completion for file names', 'info');
        }

        // File reading function with typewriter effect
        function readFile(filename) {
            if (state.isReadingFile) {
                addLine('Already reading a file. Please wait...', 'error');
                return;
            }

            // Try to find the file with spaces replaced by underscores
            const normalizedFilename = filename.toLowerCase();
            const file = state.knowledgeBase.find(f => 
                f.name.toLowerCase() === normalizedFilename || 
                f.name.toLowerCase().replace(/ /g, '_') === normalizedFilename ||
                f.name.toLowerCase().includes(normalizedFilename)
            );

            if (!file) {
                addLine(`File not found: ${filename}`, 'error');
                addLine('Use /context to see available files', 'info');
                return;
            }

            state.isReadingFile = true;

            // Create file display container
            const container = document.createElement('div');
            container.className = 'file-content';
            
            const header = document.createElement('div');
            header.className = 'file-header';
            header.textContent = `Reading: ${file.name} (${file.content.length} chars)`;
            container.appendChild(header);
            
            const content = document.createElement('div');
            content.id = 'file-reading-content';
            container.appendChild(content);
            
            output.appendChild(container);
            scrollToBottom();

            // Typewriter effect
            const text = file.content;
            let i = 0;
            
            function typeWriter() {
                if (i < text.length) {
                    content.textContent += text.charAt(i);
                    i++;
                    setTimeout(typeWriter, 5); // 5ms per character
                    scrollToBottom();
                } else {
                    state.isReadingFile = false;
                    addLine('', 'info');
                    addLine(`Finished reading: ${file.name}`, 'response');
                    updateSuggestions();
                }
            }
            
            typeWriter();
        }

        // Read context from editor
        function readContext() {
            const content = document.getElementById('context-editor').value;
            if (!content.trim()) {
                addLine('Error: No content to read', 'error');
                return;
            }

            const fileName = state.activeContext ? state.activeContext.name : 'untitled.md';
            closeModal('context-modal');
            
            // Create file display container
            const container = document.createElement('div');
            container.className = 'file-content';
            
            const header = document.createElement('div');
            header.className = 'file-header';
            header.textContent = `Reading: ${fileName} (${content.length} chars)`;
            container.appendChild(header);
            
            const contentDiv = document.createElement('div');
            contentDiv.id = 'context-reading-content';
            container.appendChild(contentDiv);
            
            output.appendChild(container);
            scrollToBottom();

            // Typewriter effect
            let i = 0;
            
            function typeWriter() {
                if (i < content.length) {
                    contentDiv.textContent += content.charAt(i);
                    i++;
                    setTimeout(typeWriter, 5);
                    scrollToBottom();
                } else {
                    addLine('', 'info');
                    addLine(`Finished reading: ${fileName}`, 'response');
                    updateSuggestions();
                }
            }
            
            typeWriter();
        }

        function addLine(text, type = 'response') {
            const line = document.createElement('div');
            line.className = 'line';
            if (type === 'script') {
                line.style.color = 'var(--script-yellow)';
            } else {
                line.style.color = getColor(type);
            }
            line.textContent = text;
            output.appendChild(line);
            scrollToBottom();
        }

        function addASCII(ascii, type = 'info') {
            const container = document.createElement('div');
            container.className = 'ascii';
            container.style.color = getColor(type);
            container.textContent = ascii;
            output.appendChild(container);
            scrollToBottom();
        }

        function addTyping(text, type = 'response', speed = 10) {
            if (state.typing) return;
            state.typing = true;
            
            const line = document.createElement('div');
            line.className = 'line';
            line.style.color = getColor(type);
            output.appendChild(line);
            
            let i = 0;
            const typeChar = () => {
                if (i < text.length) {
                    line.textContent += text.charAt(i);
                    i++;
                    setTimeout(typeChar, speed);
                    scrollToBottom();
                } else {
                    state.typing = false;
                }
            };
            typeChar();
        }

        function addSuggestions(links) {
            const container = document.createElement('div');
            container.className = 'suggestions';
            
            links.forEach((link, index) => {
                const item = document.createElement('span');
                item.className = 'suggestion';
                if (link.yellow) {
                    item.classList.add('yellow');
                }
                item.textContent = link.text;
                item.onclick = () => {
                    // Immediately execute the command when clicked
                    if (link.action) {
                        link.action();
                    }
                };
                container.appendChild(item);
            });
            
            output.appendChild(container);
            scrollToBottom();
        }

        function getColor(type) {
            const colors = {
                'error': '#ff0000',
                'dim': 'var(--dim)',
                'response': 'var(--neon)',
                'info': 'var(--neon)',
                'cmd': 'var(--neon)',
                'ai-response': 'var(--neon)'
            };
            return colors[type] || 'var(--neon)';
        }

        function scrollToBottom() {
            setTimeout(() => {
                output.scrollTop = output.scrollHeight;
            }, 10);
        }

        // Chat with AI
        function chatWithAI(message) {
            addTyping('Thinking...', 'info');
            
            setTimeout(() => {
                let context = '';
                if (state.knowledgeBase.length > 0) {
                    const relevant = state.knowledgeBase.filter(entry => 
                        entry.content.toLowerCase().includes(message.toLowerCase())
                    ).slice(0, 1);
                    if (relevant.length > 0) {
                        context = `Based on context: ${relevant[0].content.substring(0, 80)}...\n\n`;
                    }
                }
                
                if (message.toLowerCase().includes('hello') || message.toLowerCase().includes('hi')) {
                    if (state.mountedScripts.hello) {
                        runHelloWorld();
                    } else {
                        addLine('HELLO. WEBXOS v3.0', 'ai-response');
                    }
                    return;
                } else if (message.toLowerCase().includes('script')) {
                    addLine(`Scripts: ${state.scripts.length}. Use /scripts to see and mount them.`, 'ai-response');
                    return;
                } else if (message.toLowerCase().includes('context')) {
                    addLine(`Context files: ${state.knowledgeBase.length}. Use /context to view and edit them.`, 'ai-response');
                    return;
                } else if (message.toLowerCase().includes('read') || message.toLowerCase().includes('file')) {
                    addLine(`Use /read [filename] to read files with typewriter effect.`, 'ai-response');
                    return;
                }
                
                const responses = [
                    `${context}You: "${message}"`,
                    `${context}Query: "${message}"`,
                    `${context}Understood: "${message}"`
                ];
                
                addLine(responses[Math.floor(Math.random() * responses.length)], 'ai-response');
            }, 300);
        }

        // Initialize Built-in Scripts
        function initBuiltinScripts() {
            const calculatorScript = {
                id: 'calc',
                title: 'calculator',
                description: 'interactive calculator tool',
                code: `// Calculator Tool - Returns a calculator function
console.log("Calculator Tool Initialized");
console.log("Function 'calculate(expression)' available");
console.log("Examples: calculate('2+2') returns 4");

function calculate(expr) {
    try {
        // Basic safety - only allow math expressions
        const safeExpr = expr.replace(/[^0-9+\\-*/().\\s]/g, '');
        
        // Handle some edge cases
        if (safeExpr.trim() === '') return 'Error: Empty expression';
        
        // Use Function constructor for safer eval in browser context
        const result = new Function('return ' + safeExpr)();
        
        // Handle division by zero
        if (!isFinite(result)) {
            return 'Error: Division by zero or infinite result';
        }
        
        return result;
    } catch(error) {
        return 'Error: ' + error.message;
    }
}

// Test the calculator
console.log("Test: 2 + 2 = " + calculate('2+2'));
console.log("Test: 3 * 4 = " + calculate('3*4'));
console.log("Test: (10 + 5) / 3 = " + calculate('(10+5)/3'));

// Export the calculator function
return calculate;`,
                isMounted: false
            };

            const helloScript = {
                id: 'hello',
                title: 'hello',
                description: 'display hello world ascii art',
                code: `// Hello World ASCII Art
console.log("Displaying HELLO WORLD...");
console.log("");

const helloAscii = \`${HELLO_WORLD_ASCII}\`;

console.log(helloAscii);
console.log("");
console.log("WEBXOS TERMINAL v3.0");
console.log("Type '/help' for commands");
console.log("");

// Return the ascii art
return helloAscii;`,
                isMounted: false
            };

            [calculatorScript, helloScript].forEach(script => {
                if (!state.scripts.find(s => s.id === script.id)) {
                    state.scripts.push(script);
                }
            });
        }

        // Script Library Functions
        function openScriptLibrary() {
            showModal('script-modal');
            renderScriptList();
            updateMountButton();
        }

        function renderScriptList() {
            const list = document.getElementById('script-list');
            list.innerHTML = '';
            
            state.scripts.forEach((script, index) => {
                const div = document.createElement('div');
                div.className = 'script-item';
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'script-title';
                titleSpan.textContent = script.title;
                
                const descSpan = document.createElement('span');
                descSpan.className = 'script-desc';
                descSpan.textContent = script.description;
                
                // Add mounted indicator
                if (script.isMounted) {
                    const mountIndicator = document.createElement('span');
                    mountIndicator.className = 'mount-indicator';
                    titleSpan.appendChild(mountIndicator);
                }
                
                div.appendChild(titleSpan);
                div.appendChild(descSpan);
                div.onclick = () => loadScript(script.id);
                list.appendChild(div);
            });
        }

        function loadScript(scriptId) {
            const script = state.scripts.find(s => s.id === scriptId);
            if (script) {
                document.getElementById('script-editor').value = script.code;
                state.activeScript = script;
                document.getElementById('script-output').textContent = `Loaded: ${script.title}`;
                updateMountButton();
            }
        }

        function updateMountButton() {
            const mountBtn = document.getElementById('mount-btn');
            if (state.activeScript) {
                if (state.activeScript.title === 'calculator' || state.activeScript.title === 'hello') {
                    mountBtn.textContent = state.activeScript.isMounted ? 'UNMOUNT' : 'MOUNT';
                    mountBtn.className = state.activeScript.isMounted ? 'control-btn mount' : 'control-btn mount';
                } else {
                    mountBtn.textContent = 'MOUNT';
                    mountBtn.className = 'control-btn';
                }
            } else {
                mountBtn.textContent = 'MOUNT';
                mountBtn.className = 'control-btn';
            }
        }

        function newScript() {
            document.getElementById('script-editor').value = `// New script
console.log('Hello WEBXOS');

function example() {
    return 'Example function';
}

// Call it
example();`;
            document.getElementById('script-output').textContent = 'New script created';
            state.activeScript = null;
            updateMountButton();
        }

        function saveScript() {
            const code = document.getElementById('script-editor').value.trim();
            
            if (!code) {
                addLine('Error: Code required', 'error');
                return;
            }
            
            if (state.activeScript) {
                state.activeScript.code = code;
                addLine(`Updated: ${state.activeScript.title}`, 'response');
            } else {
                const script = {
                    id: 'scr_' + Date.now().toString(36),
                    title: `script-${Date.now().toString(36)}`,
                    description: 'user script',
                    code: code,
                    isMounted: false
                };
                
                state.scripts.push(script);
                state.activeScript = script;
                addLine(`Created: ${script.title}`, 'response');
            }
            
            saveToStorage();
            renderScriptList();
            updateStatus();
            updateMountButton();
        }

        // Mount a script - with override system
        function mountScript() {
            if (!state.activeScript) {
                addLine('Error: No script selected', 'error');
                return;
            }

            const script = state.activeScript;
            
            // Only calculator and hello scripts can be mounted
            if (script.title !== 'calculator' && script.title !== 'hello') {
                addLine('Only calculator and hello scripts can be mounted.', 'error');
                return;
            }

            // Toggle mount state
            if (script.isMounted) {
                // Unmount
                script.isMounted = false;
                if (script.title === 'calculator') {
                    state.mountedScripts.calculator = false;
                    state.calculatorFunction = null;
                } else if (script.title === 'hello') {
                    state.mountedScripts.hello = false;
                }
                addLine(`Unmounted: ${script.title}`, 'response');
            } else {
                // Mount - override any existing mounted script
                // First unmount any other mounted script
                state.scripts.forEach(s => {
                    if (s.title === 'calculator' || s.title === 'hello') {
                        s.isMounted = false;
                    }
                });
                
                // Reset all mounted states
                state.mountedScripts.calculator = false;
                state.mountedScripts.hello = false;
                state.calculatorFunction = null;
                
                // Mount this one
                script.isMounted = true;
                if (script.title === 'calculator') {
                    state.mountedScripts.calculator = true;
                    
                    // Try to extract calculator function
                    try {
                        const fn = new Function(script.code);
                        const result = fn();
                        if (typeof result === 'function') {
                            state.calculatorFunction = result;
                        }
                    } catch (e) {
                        console.error('Failed to extract calculator function:', e);
                    }
                } else if (script.title === 'hello') {
                    state.mountedScripts.hello = true;
                }
                
                addLine(`Mounted: ${script.title}`, 'response');
                addLine(`Now you can use /${script.title} command`, 'info');
            }

            updateMountButton();
            renderScriptList();
            saveToStorage();
            updateSuggestions();
            closeModal('script-modal');
        }

        function uploadScript() {
            state.uploadType = 'script';
            document.getElementById('upload-title').textContent = 'UPLOAD SCRIPTS';
            document.getElementById('upload-accept-text').textContent = '.js .json';
            showModal('upload-modal');
            state.uploadedFiles = [];
            document.getElementById('upload-status').textContent = '';
            document.getElementById('process-btn').style.display = 'none';
            
            // Set file input accept attribute
            const fileInput = document.getElementById('file-input');
            fileInput.setAttribute('accept', '.js,.json');
            fileInput.value = ''; // Reset file input
        }

        function runScript() {
            const code = document.getElementById('script-editor').value;
            const output = document.getElementById('script-output');
            
            output.textContent = 'Running...\n';
            
            try {
                let consoleOutput = '';
                const originalLog = console.log;
                console.log = function(...args) {
                    consoleOutput += args.join(' ') + '\n';
                };
                
                const fn = new Function(code);
                const result = fn();
                
                console.log = originalLog;
                
                if (consoleOutput) {
                    output.textContent += consoleOutput;
                }
                
                if (result !== undefined) {
                    output.textContent += 'Result: ' + result;
                }
                
            } catch (error) {
                output.textContent += 'Error: ' + error.message;
            }
        }

        function runScriptByName(name) {
            const script = state.scripts.find(s => 
                s.title.toLowerCase() === name.toLowerCase() || 
                s.title.toLowerCase().includes(name.toLowerCase())
            );
            
            if (script) {
                addLine(`Running: ${script.title}`, 'info');
                
                // Create a container for script output with yellow styling
                const scriptOutputContainer = document.createElement('div');
                scriptOutputContainer.className = 'script-output yellow-border';
                
                const scriptHeader = document.createElement('div');
                scriptHeader.className = 'file-header';
                scriptHeader.textContent = `Script: ${script.title}`;
                scriptOutputContainer.appendChild(scriptHeader);
                
                const scriptContent = document.createElement('div');
                scriptContent.className = 'yellow-text';
                scriptOutputContainer.appendChild(scriptContent);
                
                output.appendChild(scriptOutputContainer);
                scrollToBottom();
                
                try {
                    let consoleOutput = '';
                    const originalLog = console.log;
                    console.log = function(...args) {
                        consoleOutput += args.join(' ') + '\n';
                        // Update the script content in real-time
                        scriptContent.textContent = consoleOutput;
                        scrollToBottom();
                    };
                    
                    const fn = new Function(script.code);
                    const result = fn();
                    
                    console.log = originalLog;
                    
                    if (result !== undefined && !consoleOutput.includes('Result:')) {
                        consoleOutput += 'Result: ' + result + '\n';
                        scriptContent.textContent = consoleOutput;
                    }
                    
                    if (consoleOutput.trim() === '') {
                        scriptContent.textContent = 'Script executed (no output)';
                    }
                    
                    addLine(`Script "${script.title}" completed.`, 'info');
                    
                } catch (error) {
                    scriptContent.textContent = 'Error: ' + error.message;
                    addLine('Error running script: ' + error.message, 'error');
                }
            } else {
                addLine('Script not found.', 'error');
                addLine('Use /scripts to see available scripts', 'info');
            }
        }

        // Hello World function with proper ASCII
        function runHelloWorld() {
            const helloScript = state.scripts.find(s => s.title === 'hello');
            
            if (helloScript) {
                addLine(`Running: ${helloScript.title}`, 'info');
                
                // Create a container for script output with yellow styling
                const scriptOutputContainer = document.createElement('div');
                scriptOutputContainer.className = 'script-output yellow-border';
                
                const scriptHeader = document.createElement('div');
                scriptHeader.className = 'file-header';
                scriptHeader.textContent = `Script: ${helloScript.title} (Mounted)`;
                scriptOutputContainer.appendChild(scriptHeader);
                
                const scriptContent = document.createElement('div');
                scriptContent.className = 'yellow-text';
                scriptOutputContainer.appendChild(scriptContent);
                
                output.appendChild(scriptOutputContainer);
                scrollToBottom();
                
                try {
                    let consoleOutput = '';
                    const originalLog = console.log;
                    console.log = function(...args) {
                        consoleOutput += args.join(' ') + '\n';
                        // Update the script content in real-time
                        scriptContent.textContent = consoleOutput;
                        scrollToBottom();
                    };
                    
                    const fn = new Function(helloScript.code);
                    const result = fn();
                    
                    console.log = originalLog;
                    
                    if (result !== undefined && !consoleOutput.includes('Result:')) {
                        consoleOutput += '\n' + result;
                        scriptContent.textContent = consoleOutput;
                    }
                    
                    addLine(`Hello World script executed.`, 'info');
                    
                } catch (error) {
                    scriptContent.textContent = 'Error: ' + error.message;
                    addLine('Error running hello world script: ' + error.message, 'error');
                }
            } else {
                // Fallback to basic ASCII
                const scriptOutputContainer = document.createElement('div');
                scriptOutputContainer.className = 'script-output yellow-border';
                
                const scriptHeader = document.createElement('div');
                scriptHeader.className = 'file-header';
                scriptHeader.textContent = 'Script: hello (Fallback)';
                scriptOutputContainer.appendChild(scriptHeader);
                
                const scriptContent = document.createElement('div');
                scriptContent.className = 'yellow-text';
                scriptContent.textContent = HELLO_WORLD_ASCII + '\n\nWEBXOS TERMINAL v3.0\nHELLO WORLD!';
                scriptOutputContainer.appendChild(scriptContent);
                
                output.appendChild(scriptOutputContainer);
                scrollToBottom();
                
                addLine(`Hello World displayed.`, 'info');
            }
        }

        // Calculator Tool with text-based interface
        function runCalculatorTool() {
            const calcScript = state.scripts.find(s => s.title === 'calculator');
            
            if (!calcScript) {
                addLine('Calculator script not found.', 'error');
                return;
            }
            
            // Create calculator container
            const calcContainer = document.createElement('div');
            calcContainer.className = 'calculator';
            
            const calcHeader = document.createElement('div');
            calcHeader.className = 'file-header';
            calcHeader.textContent = 'Calculator Tool (Mounted)';
            calcContainer.appendChild(calcHeader);
            
            const calcContent = document.createElement('div');
            calcContent.className = 'yellow-text';
            
            try {
                // Execute the script to get the calculator function
                const fn = new Function(calcScript.code);
                const calculate = fn();
                
                if (typeof calculate !== 'function') {
                    calcContent.textContent = 'Error: Calculator function not found in script';
                    calcContainer.appendChild(calcContent);
                    output.appendChild(calcContainer);
                    scrollToBottom();
                    return;
                }
                
                // Store the calculator function
                state.calculatorFunction = calculate;
                
                // Display instructions
                calcContent.innerHTML = `Calculator mounted and ready!<br><br>
Enter mathematical expressions to calculate.<br>
Type "exit" to close calculator.<br><br>
Examples:<br>
• 2 + 2<br>
• 3 * 4<br>
• (10 + 5) / 3<br>
• 2^3 (use 2**3)<br>
• sqrt(16) (use Math.sqrt(16))<br><br>
<div class="calc-prompt">Enter expression:</div>`;
                
                calcContainer.appendChild(calcContent);
                output.appendChild(calcContainer);
                scrollToBottom();
                
                // Activate calculator mode
                state.isCalculatorActive = true;
                addLine('Calculator activated. Type expressions or "exit" to quit.', 'info');
                
            } catch (error) {
                calcContent.textContent = 'Error: ' + error.message;
                calcContainer.appendChild(calcContent);
                output.appendChild(calcContainer);
                scrollToBottom();
                addLine('Error starting calculator: ' + error.message, 'error');
            }
        }

        // Process calculator input
        function processCalculatorInput(input) {
            if (input.toLowerCase() === 'exit') {
                state.isCalculatorActive = false;
                state.calculatorFunction = null;
                addLine('Calculator closed.', 'info');
                updateSuggestions();
                return;
            }
            
            if (!state.calculatorFunction) {
                addLine('Calculator function not available.', 'error');
                state.isCalculatorActive = false;
                return;
            }
            
            try {
                const result = state.calculatorFunction(input);
                // Create a yellow output line for the result
                const resultLine = document.createElement('div');
                resultLine.className = 'line';
                resultLine.style.color = 'var(--script-yellow)';
                resultLine.textContent = `> ${input} = ${result}`;
                output.appendChild(resultLine);
                scrollToBottom();
                
            } catch (error) {
                const errorLine = document.createElement('div');
                errorLine.className = 'line';
                errorLine.style.color = '#ff0000';
                errorLine.textContent = `> ${input} = Error: ${error.message}`;
                output.appendChild(errorLine);
                scrollToBottom();
            }
        }

        // Context Library Functions
        function openContextLibrary() {
            showModal('context-modal');
            renderContextList();
            updateContextInfo();
        }

        function renderContextList() {
            const list = document.getElementById('context-list');
            list.innerHTML = '';
            
            state.knowledgeBase.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'context-item';
                div.innerHTML = `<span class="context-name">${file.name}</span>
                                <span class="context-preview">${file.content.substring(0, 40)}...</span>`;
                div.onclick = () => loadContext(file.id);
                list.appendChild(div);
            });
        }

        function loadContext(fileId) {
            const file = state.knowledgeBase.find(f => f.id === fileId);
            if (file) {
                document.getElementById('context-editor').value = file.content;
                state.activeContext = file;
                updateContextInfo();
            }
        }

        function updateContextInfo() {
            const content = document.getElementById('context-editor').value;
            document.getElementById('context-info').textContent = `${content.length} chars`;
        }

        function newContext() {
            document.getElementById('context-editor').value = '# New Context\n\nAdd content here.';
            state.activeContext = null;
            updateContextInfo();
        }

        function saveContext() {
            const content = document.getElementById('context-editor').value.trim();
            
            if (!content) {
                addLine('Error: Content required', 'error');
                return;
            }
            
            if (state.activeContext) {
                state.activeContext.content = content;
                addLine(`Updated: ${state.activeContext.name}`, 'response');
            } else {
                const contextFile = {
                    id: 'ctx_' + Date.now().toString(36),
                    name: `context-${Date.now().toString(36)}.md`,
                    content: content
                };
                
                state.knowledgeBase.push(contextFile);
                state.activeContext = contextFile;
                addLine(`Created: ${contextFile.name}`, 'response');
            }
            
            saveToStorage();
            renderContextList();
            updateStatus();
            closeModal('context-modal');
        }

        function uploadContext() {
            state.uploadType = 'context';
            document.getElementById('upload-title').textContent = 'UPLOAD CONTEXT';
            document.getElementById('upload-accept-text').textContent = '.md .txt';
            showModal('upload-modal');
            state.uploadedFiles = [];
            document.getElementById('upload-status').textContent = '';
            document.getElementById('process-btn').style.display = 'none';
            
            // Set file input accept attribute
            const fileInput = document.getElementById('file-input');
            fileInput.setAttribute('accept', '.md,.txt');
            fileInput.value = ''; // Reset file input
        }

        // File Upload Functions
        function openUpload(type) {
            state.uploadType = type;
            document.getElementById('upload-title').textContent = 'UPLOAD FILES';
            document.getElementById('upload-accept-text').textContent = '.md .txt .js .json';
            showModal('upload-modal');
            state.uploadedFiles = [];
            document.getElementById('upload-status').textContent = '';
            document.getElementById('process-btn').style.display = 'none';
            
            // Set file input accept attribute
            const fileInput = document.getElementById('file-input');
            fileInput.setAttribute('accept', '.md,.txt,.js,.json');
            fileInput.value = ''; // Reset file input
        }

        function triggerFileInput() {
            document.getElementById('file-input').click();
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            state.uploadedFiles = Array.from(files);
            const fileList = Array.from(files).map(f => f.name).join(', ');
            document.getElementById('upload-status').innerHTML = 
                `Selected ${files.length} file(s):<br>${fileList}`;
            document.getElementById('process-btn').style.display = 'block';
        }

        async function processUploadedFiles() {
            if (state.uploadedFiles.length === 0) return;
            
            addLine('Processing...', 'info');
            closeModal('upload-modal');
            
            let processed = 0;
            
            for (const file of state.uploadedFiles) {
                try {
                    const content = await readFileAsText(file);
                    const ext = file.name.split('.').pop().toLowerCase();
                    
                    // Replace spaces with underscores in filename
                    const processedName = file.name.replace(/ /g, '_');
                    
                    if (ext === 'md' || ext === 'txt') {
                        const contextFile = {
                            id: 'imp_' + Date.now().toString(36),
                            name: processedName,
                            content: content
                        };
                        
                        state.knowledgeBase.push(contextFile);
                        addLine(`Added: ${processedName}`, 'response');
                        processed++;
                        
                    } else if (ext === 'js') {
                        const script = {
                            id: 'scr_' + Date.now().toString(36),
                            title: processedName.replace('.js', ''),
                            description: 'uploaded script',
                            code: content,
                            isMounted: false
                        };
                        
                        state.scripts.push(script);
                        addLine(`Added: ${processedName}`, 'response');
                        processed++;
                        
                    } else if (ext === 'json') {
                        try {
                            const data = JSON.parse(content);
                            if (data.scripts) {
                                data.scripts.forEach(script => {
                                    // Process script titles too
                                    if (script.title) {
                                        script.title = script.title.replace(/ /g, '_');
                                    }
                                    if (!state.scripts.find(s => s.id === script.id)) {
                                        script.isMounted = false;
                                        state.scripts.push(script);
                                    }
                                });
                                addLine(`Imported ${data.scripts.length} scripts`, 'response');
                                processed++;
                            }
                            if (data.knowledgeBase) {
                                data.knowledgeBase.forEach(ctx => {
                                    // Process context names
                                    if (ctx.name) {
                                        ctx.name = ctx.name.replace(/ /g, '_');
                                    }
                                    if (!state.knowledgeBase.find(k => k.id === ctx.id)) {
                                        state.knowledgeBase.push(ctx);
                                    }
                                });
                                addLine(`Imported ${data.knowledgeBase.length} context files`, 'response');
                                processed++;
                            }
                        } catch (e) {
                            addLine('Invalid JSON: ' + file.name, 'error');
                        }
                    } else {
                        addLine('Unsupported: ' + file.name, 'error');
                    }
                } catch (error) {
                    addLine('Error: ' + file.name, 'error');
                }
            }
            
            saveToStorage();
            updateStatus();
            updateSuggestions();
            
            addLine(`Done: ${processed} files processed`, 'response');
            addLine('Note: Spaces in filenames replaced with underscores', 'info');
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Export Functions
        function renderExportLists() {
            const contextList = document.getElementById('export-context-list');
            const scriptList = document.getElementById('export-script-list');
            
            contextList.innerHTML = '';
            scriptList.innerHTML = '';
            
            // Reset selected files
            state.selectedFiles = {
                context: [],
                scripts: []
            };
            
            // Render context files
            state.knowledgeBase.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'export-file-item';
                div.innerHTML = `
                    <input type="checkbox" class="export-checkbox" id="ctx-${file.id}" onclick="toggleFileSelection('context', '${file.id}')">
                    <span class="export-file-name">${file.name}</span>
                    <span class="export-file-type">.md</span>
                `;
                contextList.appendChild(div);
            });
            
            // Render scripts
            state.scripts.forEach((script, index) => {
                const div = document.createElement('div');
                div.className = 'export-file-item';
                div.innerHTML = `
                    <input type="checkbox" class="export-checkbox" id="scr-${script.id}" onclick="toggleFileSelection('script', '${script.id}')">
                    <span class="export-file-name">${script.title}</span>
                    <span class="export-file-type">.js</span>
                `;
                scriptList.appendChild(div);
            });
        }

        function setExportOption(option) {
            state.exportOption = option;
            
            // Update UI
            document.querySelectorAll('.export-option').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`export-option-${option}`).classList.add('active');
            
            // Enable/disable checkboxes based on selection
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => {
                cb.disabled = option !== 'selected';
                cb.checked = option === 'all';
            });
            
            // Update selected files based on option
            if (option === 'all') {
                state.selectedFiles.context = state.knowledgeBase.map(f => f.id);
                state.selectedFiles.scripts = state.scripts.map(s => s.id);
            } else if (option === 'context') {
                state.selectedFiles.context = state.knowledgeBase.map(f => f.id);
                state.selectedFiles.scripts = [];
            } else if (option === 'scripts') {
                state.selectedFiles.context = [];
                state.selectedFiles.scripts = state.scripts.map(s => s.id);
            } else if (option === 'selected') {
                // Keep current selection
            }
            
            // Update checkboxes
            updateCheckboxes();
        }

        function toggleFileSelection(type, id) {
            const checkbox = document.getElementById(`${type}-${id}`);
            const array = state.selectedFiles[type === 'ctx' ? 'context' : 'scripts'];
            const index = array.indexOf(id);
            
            if (checkbox.checked && index === -1) {
                array.push(id);
            } else if (!checkbox.checked && index !== -1) {
                array.splice(index, 1);
            }
        }

        function selectAllFiles() {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = true;
                const id = cb.id;
                const [type, fileId] = id.split('-');
                
                if (type === 'ctx') {
                    if (!state.selectedFiles.context.includes(fileId)) {
                        state.selectedFiles.context.push(fileId);
                    }
                } else if (type === 'scr') {
                    if (!state.selectedFiles.scripts.includes(fileId)) {
                        state.selectedFiles.scripts.push(fileId);
                    }
                }
            });
        }

        function deselectAllFiles() {
            const checkboxes = document.querySelectorAll('.export-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            state.selectedFiles.context = [];
            state.selectedFiles.scripts = [];
        }

        function updateCheckboxes() {
            // Update checkboxes based on selectedFiles
            state.selectedFiles.context.forEach(id => {
                const checkbox = document.getElementById(`ctx-${id}`);
                if (checkbox) checkbox.checked = true;
            });
            
            state.selectedFiles.scripts.forEach(id => {
                const checkbox = document.getElementById(`scr-${id}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        function performExport() {
            const selectedContextFiles = state.knowledgeBase.filter(f => 
                state.selectedFiles.context.includes(f.id)
            );
            
            const selectedScripts = state.scripts.filter(s => 
                state.selectedFiles.scripts.includes(s.id)
            );
            
            if (selectedContextFiles.length === 0 && selectedScripts.length === 0) {
                addLine('No files selected for export.', 'error');
                closeModal('export-modal');
                return;
            }
            
            closeModal('export-modal');
            
            if (state.exportOption === 'all' || (selectedContextFiles.length > 0 && selectedScripts.length > 0)) {
                // Export as unified JSON
                const data = {
                    knowledgeBase: selectedContextFiles,
                    scripts: selectedScripts,
                    exportDate: new Date().toISOString(),
                    version: 'WEBXOS v3.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `webxos_export_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addLine(`Exported ${selectedContextFiles.length} context files and ${selectedScripts.length} scripts as unified JSON`, 'response');
                
            } else if (state.exportOption === 'context' || selectedContextFiles.length === 1) {
                // Export as Markdown
                if (selectedContextFiles.length === 1) {
                    const file = selectedContextFiles[0];
                    const blob = new Blob([file.content], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name.endsWith('.md') ? file.name : file.name + '.md';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addLine(`Exported: ${file.name}`, 'response');
                } else if (selectedContextFiles.length > 1) {
                    // Create a zip or combined file? For simplicity, export first
                    const file = selectedContextFiles[0];
                    const blob = new Blob([file.content], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name.endsWith('.md') ? file.name : file.name + '.md';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addLine(`Exported first of ${selectedContextFiles.length} files: ${file.name}`, 'response');
                }
                
            } else if (state.exportOption === 'scripts' || selectedScripts.length === 1) {
                // Export as JavaScript
                if (selectedScripts.length === 1) {
                    const script = selectedScripts[0];
                    const blob = new Blob([script.code], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = script.title + '.js';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addLine(`Exported: ${script.title}`, 'response');
                } else if (selectedScripts.length > 1) {
                    // For simplicity, export first
                    const script = selectedScripts[0];
                    const blob = new Blob([script.code], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = script.title + '.js';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    addLine(`Exported first of ${selectedScripts.length} scripts: ${script.title}`, 'response');
                }
                
            } else if (state.exportOption === 'selected') {
                // Multiple selected files - export as JSON
                const data = {
                    knowledgeBase: selectedContextFiles,
                    scripts: selectedScripts,
                    exportDate: new Date().toISOString(),
                    version: 'WEBXOS v3.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `webxos_selected_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addLine(`Exported ${selectedContextFiles.length} context files and ${selectedScripts.length} scripts as JSON`, 'response');
            }
        }

        // Utility Functions
        function clearTerminal() {
            output.innerHTML = '';
            addASCII(WEBXOS_ASCII, 'info');
            addLine('Cleared.', 'response');
            updateSuggestions();
        }

        function showStats() {
            const storageSize = JSON.stringify(state).length;
            
            addLine('STATS:', 'response');
            addLine(`Context: ${state.knowledgeBase.length} files`, 'info');
            addLine(`Scripts: ${state.scripts.length}`, 'info');
            addLine(`Storage: ${formatBytes(storageSize)}`, 'info');
            addLine(`History: ${state.history.length} commands`, 'info');
            
            // Show mounted scripts
            if (state.mountedScripts.hello || state.mountedScripts.calculator) {
                addLine('\nMounted Scripts:', 'info');
                if (state.mountedScripts.hello) {
                    addLine('  • /hello - Ready', 'script');
                }
                if (state.mountedScripts.calculator) {
                    addLine('  • /calc - Ready', 'script');
                }
            }
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function updateStatus() {
            let statusText = `ctx:${state.knowledgeBase.length} scr:${state.scripts.length}`;
            if (state.mountedScripts.hello) statusText += ' ⦿/hello';
            if (state.mountedScripts.calculator) statusText += ' ⦿/calc';
            status.textContent = statusText;
        }

        function saveToStorage() {
            try {
                localStorage.setItem('webxos', JSON.stringify({
                    knowledgeBase: state.knowledgeBase,
                    scripts: state.scripts,
                    history: state.history,
                    mountedScripts: state.mountedScripts
                }));
                updateStatus();
            } catch (e) {
                addLine('Storage error', 'error');
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('webxos');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.knowledgeBase = data.knowledgeBase || [];
                    state.scripts = data.scripts || [];
                    state.history = data.history || [];
                    state.mountedScripts = data.mountedScripts || { calculator: false, hello: false };
                    
                    // Update script mounted status
                    state.scripts.forEach(script => {
                        if (script.title === 'calculator') {
                            script.isMounted = state.mountedScripts.calculator;
                        } else if (script.title === 'hello') {
                            script.isMounted = state.mountedScripts.hello;
                        }
                    });
                    
                    addLine(`Loaded ${state.knowledgeBase.length} context, ${state.scripts.length} scripts`, 'info');
                }
            } catch (e) {
                addLine('Failed to load saved data', 'error');
            }
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById(modalId).style.display = 'none';
            hiddenInput.focus();
        }

        // Event Listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('script-modal');
                closeModal('context-modal');
                closeModal('upload-modal');
                closeModal('export-modal');
                hiddenInput.focus();
            }
        });

        document.getElementById('overlay').addEventListener('click', () => {
            closeModal('script-modal');
            closeModal('context-modal');
            closeModal('upload-modal');
            closeModal('export-modal');
        });

        // Context editor live update
        document.getElementById('context-editor')?.addEventListener('input', updateContextInfo);

        // Initialize
        hiddenInput.focus();
    </script>
</body>
</html>
