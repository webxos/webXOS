<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SURGE OS v2.0 - Polyglot Computing Terminal</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    
    <style>
        /* ========== DOS TERMINAL THEME ========== */
        :root {
            --dos-bg: #000000;
            --dos-text: #00FF41;
            --dos-text-bright: #00FF9D;
            --dos-text-dim: #00AA00;
            --dos-border: #008800;
            --dos-glow: 0 0 5px #00FF41;
            
            --font-dos: 'Source Code Pro', monospace;
            --font-ascii: 'IBM Plex Mono', monospace;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--dos-bg);
        }
        
        body {
            font-family: var(--font-dos);
            color: var(--dos-text);
            font-size: 14px;
            line-height: 1.3;
            padding: 0;
            margin: 0;
        }
        
        /* ========== MAIN CONTAINER ========== */
        #terminal-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            background: var(--dos-bg);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        
        /* ========== TERMINAL HEADER ========== */
        #terminal-header {
            padding: 10px 20px;
            background: #000;
            border-bottom: 1px solid var(--dos-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .system-id {
            font-weight: 600;
            color: var(--dos-text-bright);
        }
        
        .system-status {
            display: flex;
            gap: 15px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--dos-text);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ========== TERMINAL OUTPUT ========== */
        #terminal-output {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--dos-bg);
            border: none;
            margin: 0;
            padding-bottom: 70px !important;
        }
        
        /* ========== FIXED BOTTOM INPUT ========== */
        #terminal-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid var(--dos-border);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            height: 60px;
        }
        
        /* ========== PROMPT & INPUT ========== */
        .prompt {
            color: var(--dos-text-bright);
            font-weight: 600;
            white-space: nowrap;
        }
        
        .blink {
            animation: blink 1s infinite;
            color: var(--dos-text);
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        #command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--dos-text);
            font-family: var(--font-dos);
            font-size: 14px;
            outline: none;
            caret-color: var(--dos-text);
            padding: 5px 0;
        }
        
        #command-input:focus {
            outline: none;
        }
        
        /* ========== OUTPUT STYLES ========== */
        .output-line {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .prompt-text {
            color: var(--dos-text-bright);
        }
        
        .command-text {
            color: var(--dos-text);
        }
        
        .response-text {
            color: var(--dos-text-dim);
        }
        
        .error-text {
            color: #FF3333;
        }
        
        .success-text {
            color: var(--dos-text-bright);
        }
        
        /* ========== ASCII ART - FIXED with <pre> ========== */
        pre.ascii-art {
            font-family: var(--font-ascii);
            line-height: 1.0 !important;
            white-space: pre;
            color: var(--dos-text-bright);
            margin-bottom: 20px;
            overflow: hidden;
            padding: 0;
        }
        
        /* ========== HELP MENU ========== */
        .help-menu {
            background: rgba(0, 20, 0, 0.3);
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--dos-border);
            font-family: var(--font-dos);
            font-size: 12px;
        }
        
        .help-category {
            margin-bottom: 15px;
        }
        
        .help-title {
            color: var(--dos-text-bright);
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .help-item {
            margin-left: 20px;
            margin-bottom: 4px;
        }
        
        /* ========== BUTTONS ========== */
        .dos-button {
            background: transparent;
            border: 1px solid var(--dos-border);
            color: var(--dos-text);
            font-family: var(--font-dos);
            font-size: 11px;
            padding: 4px 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dos-button:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--dos-text);
        }
        
        .dos-button:active {
            background: rgba(0, 255, 65, 0.2);
        }
        
        /* ========== TABS ========== */
        .dos-tabs {
            display: flex;
            gap: 1px;
            background: #000;
            padding: 0 20px;
            border-bottom: 1px solid var(--dos-border);
        }
        
        .dos-tab {
            background: #000;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--dos-text-dim);
            font-family: var(--font-dos);
            font-size: 11px;
            padding: 5px 15px;
            cursor: pointer;
        }
        
        .dos-tab:hover {
            color: var(--dos-text);
            background: rgba(0, 255, 65, 0.05);
        }
        
        .dos-tab.active {
            color: var(--dos-text-bright);
            border-bottom-color: var(--dos-text);
            background: rgba(0, 255, 65, 0.1);
        }
        
        /* ========== CONTENT AREAS ========== */
        .content-area {
            display: none;
            padding: 20px;
        }
        
        .content-area.active {
            display: block;
        }
        
        /* ========== SPY OUTPUT CONTAINER ========== */
        #spy-output {
            margin-top: 20px;
            border: 1px solid var(--dos-border);
            padding: 15px;
            background: #000;
            color: var(--dos-text);
            font-family: var(--font-dos);
            min-height: 200px;
            overflow: auto;
        }
        
        /* ========== EDITOR ========== */
        #code-editor {
            width: 100%;
            height: 400px;
            background: #000;
            color: var(--dos-text);
            font-family: var(--font-dos);
            font-size: 13px;
            border: 1px solid var(--dos-border);
            padding: 15px;
            line-height: 1.4;
            tab-size: 2;
            white-space: pre;
            overflow-x: auto;
            outline: none;
            caret-color: var(--dos-text);
            resize: none;
        }
        
        /* ========== SYSTEM INFO ========== */
        .system-info {
            background: rgba(0, 20, 0, 0.3);
            padding: 15px;
            margin: 20px 0;
            border: 1px solid var(--dos-border);
        }
        
        .info-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        /* ========== SCROLLBAR ========== */
        #terminal-output::-webkit-scrollbar,
        #spy-output::-webkit-scrollbar {
            width: 8px;
        }
        
        #terminal-output::-webkit-scrollbar-track,
        #spy-output::-webkit-scrollbar-track {
            background: #000;
        }
        
        #terminal-output::-webkit-scrollbar-thumb,
        #spy-output::-webkit-scrollbar-thumb {
            background: var(--dos-border);
        }
    </style>
</head>
<body>
    <!-- Main Terminal -->
    <div id="terminal-container">
        <!-- Header -->
        <div id="terminal-header">
            <div class="system-id">
                <span>SURGE OS</span> <span style="color: var(--dos-text-dim);">v2.0</span>
            </div>
            <div class="system-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>PYODIDE</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span id="current-time">00:00:00</span>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="dos-tabs">
            <button class="dos-tab active" data-tab="terminal">TERMINAL</button>
            <button class="dos-tab" data-tab="editor">SPY EDITOR</button>
            <button class="dos-tab" data-tab="python">PYTHON</button>
            <button class="dos-tab" data-tab="system">SYSTEM</button>
        </div>
        
        <!-- Terminal Tab -->
        <div id="terminal-tab" class="content-area active">
            <div id="terminal-output">
                <!-- Fixed ASCII Logo with <pre> -->
                <pre class="ascii-art">
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù      ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                </pre>
                
                <!-- Initial Help Display -->
                <div class="output-line">
                    <span class="prompt-text">SYSTEM</span> SURGE OS v2.0 - Polyglot Browser-Based Computing
                </div>
                <div class="output-line">
                    <span class="prompt-text">SYSTEM</span> Type <span style="color: var(--dos-text-bright);">help</span> for available commands
                </div>
                <div class="output-line">
                    <span class="prompt-text">SYSTEM</span> Initializing Polyglot Kernel...
                </div>
            </div>
        </div>
        
        <!-- Editor Tab -->
        <div id="editor-tab" class="content-area">
            <div style="margin-bottom: 15px;">
                <span class="prompt-text">SPYGHETTI CODE EDITOR</span>
            </div>
            
            <textarea id="code-editor" spellcheck="false"><spy>
# SURGE OS POLYGLOT COMPUTING ENGINE
import numpy as np
from js import performance, console, document

class MassComputing:
    def __init__(self):
        self.matrix_cache = {}
        self.results = []
        self.active = True
        
    def matrix_multiply(self, size=256):
        """Heavy matrix multiplication using numpy"""
        a = np.random.randn(size, size)
        b = np.random.randn(size, size)
        
        start = performance.now()
        result = np.dot(a, b)
        end = performance.now()
        
        ops = size ** 3 * 2
        time_ms = end - start
        gflops = (ops / (time_ms * 1e6)) if time_ms > 0 else 0
        
        return {
            'size': size,
            'time': time_ms,
            'gflops': gflops,
            'result_shape': result.shape,
            'type': 'matrix_multiplication'
        }
    
    def neural_inference(self, input_size=100):
        """Simulate neural network inference"""
        weights = np.random.randn(input_size, 10)
        biases = np.random.randn(10)
        inputs = np.random.randn(1, input_size)
        
        z = np.dot(inputs, weights) + biases
        probs = 1 / (1 + np.exp(-z))
        
        return {
            'input_size': input_size,
            'output': probs.tolist(),
            'confidence': float(np.max(probs)),
            'type': 'neural_inference'
        }
    
    def data_pipeline(self, samples=1000):
        """Complete data processing pipeline"""
        data = np.random.randn(samples, 20)
        
        mean = np.mean(data, axis=0)
        std = np.std(data, axis=0)
        normalized = (data - mean) / (std + 1e-8)
        
        cov = np.cov(normalized.T)
        eigenvalues, eigenvectors = np.linalg.eig(cov)
        
        return {
            'samples': samples,
            'features': 20,
            'eigenvalues': eigenvalues[:3].tolist(),
            'explained_variance': float(np.sum(eigenvalues[:3]) / np.sum(eigenvalues)),
            'type': 'data_pipeline'
        }

# Initialize global instance
mass_computer = MassComputing()
cpu_usage = 42
memory_usage = 65
neural_load = 28
viz_color = '#00FF41'
</spy>

<div class="surge-dashboard">
    <h1 class="cyber-title">SURGE COMPUTING ENGINE</h1>
    
    <div class="control-panel">
        <button onclick="run_matrix()" class="cyber-btn">
            ‚ö° RUN MATRIX MULTIPLICATION
        </button>
        
        <button onclick="run_neural()" class="cyber-btn">
            üß† NEURAL INFERENCE
        </button>
        
        <button onclick="run_pipeline()" class="cyber-btn">
            üîÑ DATA PIPELINE
        </button>
    </div>
    
    <div class="results-grid">
        <div class="result-card">
            <h3>LATEST RESULT</h3>
            <div class="result-data">
                <div class="result-item">
                    <span class="result-key">CPU:</span>
                    <span class="result-value">|cpu_usage|%</span>
                </div>
                <div class="result-item">
                    <span class="result-key">Memory:</span>
                    <span class="result-value">|memory_usage|%</span>
                </div>
                <div class="result-item">
                    <span class="result-key">Neural Load:</span>
                    <span class="result-value">|neural_load|%</span>
                </div>
            </div>
        </div>
        
        <div class="stats-card">
            <h3>PERFORMANCE METRICS</h3>
            <div class="meter-grid">
                <div class="meter">
                    <div class="meter-label">CPU UTILIZATION</div>
                    <div class="meter-bar" style="width: |cpu_usage|%"></div>
                </div>
                <div class="meter">
                    <div class="meter-label">MEMORY USAGE</div>
                    <div class="meter-bar" style="width: |memory_usage|%"></div>
                </div>
                <div class="meter">
                    <div class="meter-label">NEURAL LOAD</div>
                    <div class="meter-bar" style="width: |neural_load|%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.surge-dashboard {
    padding: 25px;
    background: rgba(10, 10, 15, 0.9);
    border: 2px solid #00FF41;
    border-radius: 12px;
    margin: 20px 0;
    color: #00FF41;
    font-family: 'Source Code Pro', monospace;
}
.cyber-title {
    color: #00FF41;
    text-align: center;
    margin-bottom: 25px;
}
.control-panel {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
}
.cyber-btn {
    padding: 15px 25px;
    background: transparent;
    border: 2px solid #00FF41;
    color: #00FF41;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}
.cyber-btn:hover {
    background: #00FF41;
    color: black;
}
.results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 25px 0;
}
.result-card, .stats-card {
    padding: 20px;
    border: 1px solid #008800;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.5);
}
.result-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}
.result-key {
    color: #00AA00;
    font-weight: bold;
}
.result-value {
    color: #00FF41;
}
.meter-grid {
    margin: 15px 0;
}
.meter {
    margin: 15px 0;
}
.meter-label {
    margin-bottom: 5px;
}
.meter-bar {
    height: 10px;
    background: linear-gradient(90deg, #00FF41, #00FF9D);
    border-radius: 5px;
    transition: width 0.5s;
}
</style>

<script>
function run_matrix() {
    console.log("Running matrix multiplication...");
    // This will be called from the rendered dashboard
    document.getElementById('spy-output').innerHTML += '<br>Matrix computation triggered';
}

function run_neural() {
    console.log("Running neural inference...");
    document.getElementById('spy-output').innerHTML += '<br>Neural inference triggered';
}

function run_pipeline() {
    console.log("Running data pipeline...");
    document.getElementById('spy-output').innerHTML += '<br>Data pipeline triggered';
}
</script></textarea>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="dos-button" onclick="executeSPYCode()">
                    EXECUTE
                </button>
                <button class="dos-button" onclick="saveSPYFile()">
                    SAVE
                </button>
                <button class="dos-button" onclick="optimizeSPYCode()">
                    OPTIMIZE
                </button>
            </div>
            
            <!-- Spy Output Container -->
            <div id="spy-output" style="margin-top: 20px; display: none;">
                <!-- Rendered SPYGHETTI output will appear here -->
            </div>
        </div>
        
        <!-- Python Tab -->
        <div id="python-tab" class="content-area">
            <div style="margin-bottom: 15px;">
                <span class="prompt-text">PYTHON INTERACTIVE SHELL</span>
            </div>
            
            <div id="python-output" style="
                height: 300px;
                overflow-y: auto;
                background: #000;
                border: 1px solid var(--dos-border);
                padding: 15px;
                margin-bottom: 15px;
                font-family: var(--font-dos);
                font-size: 13px;
            ">
                Python 3.10.0 (Pyodide v0.25.0)<br>
                Type "help", "copyright", "credits" or "license" for more information.<br>
                >>> 
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="prompt">>>></span>
                <input type="text" 
                       id="python-input" 
                       placeholder="Enter Python code..."
                       style="flex: 1; background: transparent; border: 1px solid var(--dos-border); color: var(--dos-text); padding: 5px; font-family: var(--font-dos);">
                <button class="dos-button" onclick="executePythonLine()">
                    EXEC
                </button>
            </div>
        </div>
        
        <!-- System Tab -->
        <div id="system-tab" class="content-area">
            <div style="margin-bottom: 15px;">
                <span class="prompt-text">SYSTEM STATUS</span>
            </div>
            
            <div class="system-info">
                <div class="info-line">
                    <span>CPU Usage:</span>
                    <span id="cpu-usage">42%</span>
                </div>
                <div class="info-line">
                    <span>Memory:</span>
                    <span id="memory-usage">1.2GB/2.0GB</span>
                </div>
                <div class="info-line">
                    <span>Python:</span>
                    <span id="python-status">3.10.0</span>
                </div>
                <div class="info-line">
                    <span>WASM:</span>
                    <span id="wasm-status">Active</span>
                </div>
                <div class="info-line">
                    <span>Pyodide:</span>
                    <span id="pyodide-status">Online</span>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <span class="prompt-text">QUICK ACTIONS</span>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="dos-button" onclick="runBenchmark()">
                    RUN BENCHMARK
                </button>
                <button class="dos-button" onclick="clearMemory()">
                    CLEAR MEMORY
                </button>
                <button class="dos-button" onclick="showHelp()">
                    HELP
                </button>
                <button class="dos-button" onclick="clearTerminal()">
                    CLEAR TERMINAL
                </button>
            </div>
        </div>
        
        <!-- FIXED BOTTOM INPUT -->
        <div id="terminal-input-area">
            <span class="prompt">USER@SURGE:~$</span>
            <span class="blink">‚ñà</span>
            <input type="text" 
                   id="command-input" 
                   placeholder="Type 'help' for commands..."
                   autocomplete="off"
                   spellcheck="false">
            <button class="dos-button" onclick="executeCommand()" style="padding: 5px 10px;">
                EXEC
            </button>
        </div>
    </div>
    
    <!-- SURGE OS JavaScript - FIXED VERSION -->
    <script>
        // ========== SURGE OS STATE ==========
        const surgeState = {
            pyodide: null,
            commandHistory: [],
            historyIndex: -1,
            currentTab: 'terminal',
            activeModules: new Set(),
            system: {
                cpu: 42,
                memory: 1200,
                totalMemory: 2000,
                python: '3.10.0',
                wasm: true,
                pyodideReady: false
            },
            // Template engine context
            templateContext: {
                cpu_usage: 42,
                memory_usage: 65,
                neural_load: 28,
                viz_color: '#00FF41'
            }
        };

        // ========== FIXED TEMPLATE ENGINE ==========
        class SpyTemplateEngine {
            constructor(pyodide) {
                this.pyodide = pyodide;
                this.context = {};
            }
            
            setContext(context) {
                this.context = context;
                // Pass JS context to Python
                for (const [key, value] of Object.entries(context)) {
                    try {
                        this.pyodide.globals.set(key, value);
                    } catch(e) {
                        console.log(`Could not set ${key} in Python globals:`, e);
                    }
                }
            }
            
            // Parse and evaluate expressions
            evaluateExpression(expr) {
                try {
                    // First check if it's in our JS context
                    if (this.context.hasOwnProperty(expr)) {
                        return this.context[expr];
                    }
                    
                    // Try to evaluate in Python
                    const result = this.pyodide.runPython(`str(${expr})`);
                    return result;
                } catch(error) {
                    console.log(`Expression error for "${expr}":`, error.message);
                    return `[ERROR: ${error.message}]`;
                }
            }
            
            // Main template rendering function
            render(template) {
                let output = '';
                let lines = template.split('\n');
                let inIf = false;
                let ifCondition = false;
                let inElse = false;
                let inFor = false;
                let forLoop = null;
                let forItems = [];
                let forIndex = 0;
                let forVar = '';
                let forLoopLines = [];
                let stack = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    
                    // Handle for loops
                    if (inFor && forLoop) {
                        if (line.includes('|end|')) {
                            // Execute the loop
                            for (let item of forItems) {
                                // Set loop variable in context
                                this.pyodide.globals.set(forVar, item);
                                
                                // Render each line in the loop
                                for (let loopLine of forLoopLines) {
                                    output += this.processLine(loopLine) + '\n';
                                }
                            }
                            
                            // Reset loop state
                            inFor = false;
                            forLoop = null;
                            forItems = [];
                            forLoopLines = [];
                            continue;
                        } else {
                            forLoopLines.push(line);
                            continue;
                        }
                    }
                    
                    // Check for |for| start
                    const forMatch = line.match(/\|for\s+(\w+)\s+in\s+([^:]+):/);
                    if (forMatch) {
                        inFor = true;
                        forVar = forMatch[1];
                        const collectionExpr = forMatch[2].trim();
                        
                        try {
                            // Evaluate collection in Python
                            const items = this.pyodide.runPython(`list(${collectionExpr})`);
                            forItems = Array.from(items);
                        } catch(e) {
                            console.log(`For loop error:`, e);
                            forItems = [];
                        }
                        
                        forLoopLines = [];
                        continue;
                    }
                    
                    // Check for |if| start
                    if (line.includes('|if') && line.includes(':|')) {
                        const condition = line.replace('|if', '').replace(':|', '').trim();
                        try {
                            ifCondition = this.pyodide.runPython(`bool(${condition})`);
                        } catch(e) {
                            console.log(`If condition error:`, e);
                            ifCondition = false;
                        }
                        inIf = true;
                        inElse = false;
                        continue;
                    }
                    
                    // Check for |else:|
                    if (line.includes('|else:|')) {
                        if (inIf) {
                            inElse = true;
                        }
                        continue;
                    }
                    
                    // Check for |end|
                    if (line.includes('|end|')) {
                        inIf = false;
                        inElse = false;
                        ifCondition = false;
                        continue;
                    }
                    
                    // Process line based on current state
                    if (inIf) {
                        if (ifCondition && !inElse) {
                            output += this.processLine(line) + '\n';
                        } else if (!ifCondition && inElse) {
                            output += this.processLine(line) + '\n';
                        }
                    } else {
                        output += this.processLine(line) + '\n';
                    }
                }
                
                return output;
            }
            
            processLine(line) {
                // Replace |expressions| with evaluated values
                return line.replace(/\|([^|]+)\|/g, (match, expr) => {
                    return this.evaluateExpression(expr.trim());
                });
            }
        }

        // ========== INITIALIZATION ==========
        async function initializeSURGEOS() {
            try {
                updateTerminal("INITIALIZING SURGE OS v2.0...", 'system');
                updateTerminal("LOADING POLYGLOT KERNEL...", 'system');
                
                // Load Pyodide with error handling
                updateTerminal("LOADING PYODIDE RUNTIME...", 'system');
                surgeState.pyodide = await loadPyodide({
                    stdout: (text) => updateTerminal(`[PYTHON] ${text}`, 'response'),
                    stderr: (text) => updateTerminal(`[PYTHON ERROR] ${text}`, 'error')
                });
                
                // Load numpy
                updateTerminal("LOADING NUMPY...", 'system');
                await surgeState.pyodide.loadPackage(["numpy"]);
                
                surgeState.system.pyodideReady = true;
                updateTerminal("PYTHON 3.10.0 LOADED SUCCESSFULLY", 'success');
                updateTerminal("WASM: WebAssembly module ready", 'success');
                updateTerminal("SHARED MEMORY: 256MB allocated", 'success');
                updateTerminal("SYSTEM READY", 'success');
                
                // Show initial help
                updateTerminal("", 'system');
                updateTerminal("=== SURGE OS v2.0 READY ===", 'success');
                updateTerminal("Type 'help' for available commands", 'system');
                
                updateSystemStatus();
                startSystemMonitor();
                
            } catch (error) {
                updateTerminal(`INITIALIZATION ERROR: ${error.message}`, 'error');
                updateTerminal("Check console for details", 'error');
                console.error("Pyodide initialization error:", error);
            }
        }

        // ========== FIXED SPYGHETTI EXECUTION ==========
        async function executeSPYCode() {
            const code = document.getElementById('code-editor').value;
            
            if (!surgeState.pyodide) {
                updateTerminal("ERROR: PYODIDE NOT INITIALIZED", 'error');
                return;
            }
            
            updateTerminal("EXECUTING SPYGHETTI CODE...", 'success');
            
            try {
                // Extract Python code from <spy> tags
                const spyMatch = code.match(/<spy>([\s\S]*?)<\/spy>/);
                if (spyMatch) {
                    const pythonCode = spyMatch[1];
                    await surgeState.pyodide.runPythonAsync(pythonCode);
                    
                    // Get Python classes for JS access
                    try {
                        const MassComputing = surgeState.pyodide.globals.get('MassComputing');
                        if (MassComputing) {
                            window.MassComputing = MassComputing;
                            window.mass_computer = MassComputing();
                            updateTerminal("Python classes exposed to JavaScript", 'success');
                        }
                    } catch(e) {
                        console.log("Could not get MassComputing from Python:", e);
                    }
                }
                
                // Extract template (remove spy, style, script blocks)
                let template = code.replace(/<spy>[\s\S]*?<\/spy>/g, '')
                                  .replace(/<style>[\s\S]*?<\/style>/g, '')
                                  .replace(/<script>[\s\S]*?<\/script>/g, '');
                
                // Create template engine
                const engine = new SpyTemplateEngine(surgeState.pyodide);
                engine.setContext(surgeState.templateContext);
                
                // Render template
                const rendered = engine.render(template);
                
                // Extract and apply CSS
                const styleMatch = code.match(/<style>([\s\S]*?)<\/style>/);
                if (styleMatch) {
                    const style = document.createElement('style');
                    style.textContent = styleMatch[1];
                    document.head.appendChild(style);
                }
                
                // Extract and execute JS
                const scriptMatch = code.match(/<script>([\s\S]*?)<\/script>/);
                if (scriptMatch) {
                    try {
                        // Use Function constructor for safer execution
                        const scriptFunc = new Function(scriptMatch[1]);
                        scriptFunc.call(window);
                    } catch(e) {
                        console.log("Script execution error:", e);
                    }
                }
                
                // Display rendered output
                const spyOutput = document.getElementById('spy-output');
                spyOutput.innerHTML = rendered;
                spyOutput.style.display = 'block';
                
                updateTerminal("SPYGHETTI CODE EXECUTED SUCCESSFULLY", 'success');
                
            } catch (error) {
                updateTerminal(`EXECUTION ERROR: ${error.message}`, 'error');
                console.error("SPYGHETTI execution error:", error);
            }
        }

        // ========== TERMINAL FUNCTIONS ==========
        function updateTerminal(text, type = 'response') {
            const output = document.getElementById('terminal-output');
            const line = document.createElement('div');
            line.className = 'output-line';
            
            let content = text;
            
            if (type === 'command') {
                content = `<span class="prompt-text">USER@SURGE:~$</span> <span class="command-text">${text}</span>`;
            } else if (type === 'system') {
                content = `<span class="prompt-text">SYSTEM</span> ${text}`;
            } else if (type === 'error') {
                content = `<span class="error-text">${text}</span>`;
            } else if (type === 'success') {
                content = `<span class="success-text">${text}</span>`;
            } else if (type === 'response') {
                content = `<span class="response-text">${text}</span>`;
            }
            
            line.innerHTML = content;
            output.appendChild(line);
            
            output.scrollTop = output.scrollHeight;
        }

        function executeCommand(command = null) {
            const input = document.getElementById('command-input');
            const cmd = command || input.value.trim();
            
            if (!cmd) return;
            
            surgeState.commandHistory.push(cmd);
            surgeState.historyIndex = surgeState.commandHistory.length;
            
            updateTerminal(cmd, 'command');
            processCommand(cmd.toLowerCase());
            
            input.value = '';
        }

        function processCommand(cmd) {
            switch(cmd) {
                case 'help':
                    showHelp();
                    break;
                case 'clear':
                    clearTerminal();
                    break;
                case 'status':
                    showStatus();
                    break;
                case 'python':
                    showTab('python');
                    break;
                case 'editor':
                case 'spy':
                    showTab('editor');
                    break;
                case 'system':
                    showTab('system');
                    break;
                case 'terminal':
                    showTab('terminal');
                    break;
                case 'benchmark':
                    runBenchmark();
                    break;
                case 'matrix':
                    runMatrixComputation();
                    break;
                case 'fibonacci':
                    runFibonacci();
                    break;
                case 'time':
                    showTime();
                    break;
                case 'ls':
                    listDirectory();
                    break;
                case 'memory':
                    showMemoryInfo();
                    break;
                case 'welcome':
                    showWelcome();
                    break;
                case 'exit':
                case 'quit':
                    shutdownSystem();
                    break;
                case 'distill':
                    runDistillation();
                    break;
                case 'test':
                    runTest();
                    break;
                case 'optimize':
                    optimizeSystem();
                    break;
                case 'run':
                    updateTerminal("Usage: run [script_name]", 'response');
                    break;
                default:
                    if (cmd.startsWith('run ')) {
                        const script = cmd.substring(4);
                        runScript(script);
                    } else if (cmd.startsWith('load ')) {
                        const module = cmd.substring(5);
                        loadModule(module);
                    } else {
                        updateTerminal(`COMMAND NOT FOUND: ${cmd}`, 'error');
                        updateTerminal("Type 'help' for available commands", 'response');
                    }
            }
        }

        function showHelp() {
            const helpHTML = `
                <div class="help-menu">
                    <div class="help-category">
                        <div class="help-title">BASIC COMMANDS:</div>
                        <div class="help-item">help - Show this help menu</div>
                        <div class="help-item">clear - Clear terminal screen</div>
                        <div class="help-item">status - Show system status</div>
                        <div class="help-item">time - Show current time</div>
                        <div class="help-item">exit - Exit SURGE OS</div>
                    </div>
                    
                    <div class="help-category">
                        <div class="help-title">NAVIGATION:</div>
                        <div class="help-item">terminal - Switch to terminal</div>
                        <div class="help-item">editor - Open SPYGHETTI editor</div>
                        <div class="help-item">python - Open Python shell</div>
                        <div class="help-item">system - System information</div>
                    </div>
                    
                    <div class="help-category">
                        <div class="help-title">COMPUTATION:</div>
                        <div class="help-item">benchmark - Run system benchmark</div>
                        <div class="help-item">matrix - Run matrix computation</div>
                        <div class="help-item">fibonacci - Compute sequence</div>
                        <div class="help-item">distill - Run model distillation</div>
                        <div class="help-item">test - Run system tests</div>
                    </div>
                    
                    <div class="help-category">
                        <div class="help-title">SYSTEM:</div>
                        <div class="help-item">memory - Show memory usage</div>
                        <div class="help-item">ls - List files</div>
                        <div class="help-item">optimize - Optimize system</div>
                        <div class="help-item">welcome - Show welcome message</div>
                    </div>
                    
                    <div class="help-category">
                        <div class="help-title">KEY SHORTCUTS:</div>
                        <div class="help-item">TAB - Auto-complete commands</div>
                        <div class="help-item">‚Üë‚Üì - Command history</div>
                        <div class="help-item">CTRL+C - Cancel operation</div>
                    </div>
                </div>
            `;
            
            updateTerminal("=== SURGE OS COMMAND REFERENCE ===", 'success');
            
            const output = document.getElementById('terminal-output');
            const line = document.createElement('div');
            line.innerHTML = helpHTML;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function clearTerminal() {
            const output = document.getElementById('terminal-output');
            output.innerHTML = '';
            
            // Add ASCII logo back
            const asciiArt = document.createElement('pre');
            asciiArt.className = 'ascii-art';
            asciiArt.innerHTML = `
 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù      ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            `;
            output.appendChild(asciiArt);
            
            updateTerminal("TERMINAL CLEARED", 'success');
            updateTerminal("Type 'help' for available commands", 'system');
        }

        function showStatus() {
            updateTerminal("=== SYSTEM STATUS ===", 'success');
            updateTerminal(`CPU USAGE: ${surgeState.system.cpu}%`, 'response');
            updateTerminal(`MEMORY: ${surgeState.system.memory}MB/${surgeState.system.totalMemory}MB`, 'response');
            updateTerminal(`PYTHON: ${surgeState.system.python}`, 'response');
            updateTerminal(`WASM: ${surgeState.system.wasm ? 'ACTIVE' : 'INACTIVE'}`, 'response');
            updateTerminal(`PYODIDE: ${surgeState.system.pyodideReady ? 'ONLINE' : 'OFFLINE'}`, 'response');
        }

        // ========== TAB MANAGEMENT ==========
        function showTab(tabId) {
            document.querySelectorAll('.dos-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.content-area').forEach(area => {
                area.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            surgeState.currentTab = tabId;
            
            if (tabId === 'terminal') {
                updateTerminal(`SWITCHED TO ${tabId.toUpperCase()} MODE`, 'system');
            }
        }

        document.querySelectorAll('.dos-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                showTab(this.dataset.tab);
            });
        });

        // ========== PYTHON SHELL ==========
        async function executePythonLine() {
            const input = document.getElementById('python-input');
            const code = input.value.trim();
            
            if (!code) return;
            
            const output = document.getElementById('python-output');
            output.innerHTML += `<br>>>> ${code}`;
            
            if (!surgeState.pyodide) {
                output.innerHTML += `<br><span style="color: #FF3333;">Pyodide not initialized</span>`;
                return;
            }
            
            try {
                const result = await surgeState.pyodide.runPythonAsync(code);
                if (result !== undefined) {
                    output.innerHTML += `<br>${result}`;
                }
            } catch (error) {
                output.innerHTML += `<br><span style="color: #FF3333;">${error.message}</span>`;
            }
            
            output.innerHTML += `<br>>>> `;
            output.scrollTop = output.scrollHeight;
            input.value = '';
        }

        // ========== SYSTEM FUNCTIONS ==========
        function updateSystemStatus() {
            document.getElementById('cpu-usage').textContent = `${surgeState.system.cpu}%`;
            document.getElementById('memory-usage').textContent = 
                `${surgeState.system.memory}MB/${surgeState.system.totalMemory}MB`;
            document.getElementById('python-status').textContent = surgeState.system.python;
            document.getElementById('wasm-status').textContent = surgeState.system.wasm ? 'Active' : 'Inactive';
            document.getElementById('pyodide-status').textContent = surgeState.system.pyodideReady ? 'Online' : 'Offline';
        }

        function startSystemMonitor() {
            setInterval(() => {
                surgeState.system.cpu = Math.max(10, Math.min(90, 
                    surgeState.system.cpu + (Math.random() * 10 - 5)));
                
                surgeState.system.memory = 1200 + Math.random() * 200;
                
                updateSystemStatus();
                
                const now = new Date();
                document.getElementById('current-time').textContent = 
                    now.toLocaleTimeString([], {hour12: false});
                
            }, 2000);
        }

        async function runBenchmark() {
            updateTerminal("RUNNING SYSTEM BENCHMARK...", 'success');
            
            for (let i = 0; i <= 100; i += 20) {
                await new Promise(resolve => setTimeout(resolve, 300));
                updateTerminal(`PROGRESS: ${i}%`, 'response');
            }
            
            const score = Math.floor(Math.random() * 1000) + 500;
            updateTerminal(`BENCHMARK COMPLETE: ${score} GFLOPS`, 'success');
        }

        async function runMatrixComputation() {
            if (!surgeState.pyodide) {
                updateTerminal("PYODIDE NOT AVAILABLE", 'error');
                return;
            }
            
            updateTerminal("RUNNING MATRIX COMPUTATION...", 'success');
            
            try {
                const code = `
import numpy as np
import time

size = 128
a = np.random.randn(size, size)
b = np.random.randn(size, size)

start = time.time()
result = np.dot(a, b)
end = time.time()

ops = size ** 3 * 2
time_taken = end - start
gflops = (ops / (time_taken * 1e9)) if time_taken > 0 else 0

print(f"Matrix {size}x{size} computed in {time_taken:.4f}s")
print(f"Performance: {gflops:.2f} GFLOPS")
print(f"Total operations: {ops:,}")
                `;
                
                await surgeState.pyodide.runPythonAsync(code);
                
            } catch (error) {
                updateTerminal(`MATRIX ERROR: ${error.message}`, 'error');
            }
        }

        function runFibonacci() {
            updateTerminal("COMPUTING FIBONACCI SEQUENCE...", 'success');
            
            const fib = [0, 1];
            for (let i = 2; i < 30; i++) {
                fib.push(fib[i-1] + fib[i-2]);
            }
            
            updateTerminal(`FIBONACCI(30) = ${fib[29]}`, 'success');
            updateTerminal(`LAST 10: ${fib.slice(-10).join(', ')}`, 'response');
        }

        function listDirectory() {
            updateTerminal("=== DIRECTORY LISTING ===", 'success');
            updateTerminal("  surge_code.spy", 'response');
            updateTerminal("  matrix_compute.py", 'response');
            updateTerminal("  neural_network.spy", 'response');
            updateTerminal("  data/", 'response');
            updateTerminal("  logs/", 'response');
            updateTerminal("  modules/", 'response');
        }

        function showTime() {
            const now = new Date();
            updateTerminal(`SYSTEM TIME: ${now.toLocaleString()}`, 'success');
        }

        function showMemoryInfo() {
            if (performance.memory) {
                const used = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                const total = (performance.memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
                updateTerminal(`JS HEAP: ${used}MB/${total}MB`, 'success');
            }
            updateTerminal(`SYSTEM MEMORY: ${surgeState.system.memory}MB/${surgeState.system.totalMemory}MB`, 'response');
        }

        function clearMemory() {
            surgeState.system.memory = 1200;
            updateSystemStatus();
            updateTerminal("MEMORY CLEARED", 'success');
        }

        function runDistillation() {
            updateTerminal("RUNNING MODEL DISTILLATION...", 'success');
            updateTerminal("Knowledge transfer in progress...", 'response');
            setTimeout(() => {
                const loss = (Math.random() * 0.5 + 0.1).toFixed(4);
                updateTerminal(`DISTILLATION COMPLETE - Loss: ${loss}`, 'success');
            }, 2000);
        }

        function runTest() {
            updateTerminal("RUNNING SYSTEM TESTS...", 'success');
            updateTerminal("[‚úì] Pyodide runtime", 'response');
            updateTerminal("[‚úì] Numpy module", 'response');
            updateTerminal("[‚úì] SPYGHETTI parser", 'response');
            updateTerminal("[‚úì] System monitoring", 'response');
            updateTerminal("ALL TESTS PASSED", 'success');
        }

        function optimizeSystem() {
            updateTerminal("OPTIMIZING SYSTEM...", 'success');
            surgeState.system.cpu = Math.max(10, surgeState.system.cpu - 20);
            surgeState.system.memory = 1200;
            updateSystemStatus();
            updateTerminal("SYSTEM OPTIMIZED", 'success');
        }

        function shutdownSystem() {
            updateTerminal("SYSTEM SHUTDOWN INITIATED", 'system');
            setTimeout(() => {
                clearTerminal();
                updateTerminal("SURGE OS TERMINATED", 'system');
                updateTerminal("SYSTEM OFFLINE", 'system');
            }, 1000);
        }

        function saveSPYFile() {
            const code = document.getElementById('code-editor').value;
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'surge_code.spy';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateTerminal("FILE SAVED AS 'surge_code.spy'", 'success');
        }

        function optimizeSPYCode() {
            const editor = document.getElementById('code-editor');
            let code = editor.value;
            
            code = code.replace(/^\s*[\r\n]/gm, '');
            code = code.replace(/\s+$/gm, '');
            
            editor.value = code;
            updateTerminal("CODE OPTIMIZED (WHITESPACE CLEANUP)", 'success');
        }

        async function runScript(scriptName) {
            updateTerminal(`RUNNING SCRIPT: ${scriptName}`, 'success');
            
            if (!surgeState.pyodide) {
                updateTerminal("PYODIDE NOT AVAILABLE", 'error');
                return;
            }
            
            try {
                // Simulate script loading
                const code = `print("Executing script: ${scriptName}")`;
                await surgeState.pyodide.runPythonAsync(code);
                updateTerminal("SCRIPT EXECUTED SUCCESSFULLY", 'success');
            } catch (error) {
                updateTerminal(`SCRIPT ERROR: ${error.message}`, 'error');
            }
        }

        function loadModule(moduleName) {
            surgeState.activeModules.add(moduleName);
            updateTerminal(`MODULE '${moduleName}' LOADED`, 'success');
        }

        function showWelcome() {
            clearTerminal();
            updateTerminal("=== SURGE OS v2.0 - POLYGLOT COMPUTING PLATFORM ===", 'success');
            updateTerminal("", 'system');
            updateTerminal("ARCHITECTURE:", 'system');
            updateTerminal("  ‚Ä¢ JavaScript UI orchestration", 'response');
            updateTerminal("  ‚Ä¢ WebAssembly (Rust/C++) for heavy computation", 'response');
            updateTerminal("  ‚Ä¢ Pyodide for Python execution in browser", 'response');
            updateTerminal("  ‚Ä¢ SPYGHETTI syntax for embedded Python", 'response');
            updateTerminal("", 'system');
            updateTerminal("Type 'help' for available commands", 'prompt-text');
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Command input
            const commandInput = document.getElementById('command-input');
            commandInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeCommand();
                }
            });
            
            // Command history
            commandInput.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (surgeState.commandHistory.length > 0) {
                        surgeState.historyIndex = Math.max(0, surgeState.historyIndex - 1);
                        commandInput.value = surgeState.commandHistory[surgeState.historyIndex] || '';
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (surgeState.commandHistory.length > 0) {
                        surgeState.historyIndex = Math.min(
                            surgeState.commandHistory.length, 
                            surgeState.historyIndex + 1
                        );
                        commandInput.value = surgeState.commandHistory[surgeState.historyIndex] || '';
                    }
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    const current = commandInput.value.toLowerCase();
                    const commands = ['help', 'status', 'python', 'clear', 'benchmark', 'exit', 'ls', 'matrix', 'fibonacci', 'editor', 'system', 'memory', 'distill', 'test', 'optimize', 'welcome', 'run'];
                    const match = commands.find(cmd => cmd.startsWith(current));
                    if (match) {
                        commandInput.value = match;
                    }
                }
            });
            
            // Python input
            document.getElementById('python-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executePythonLine();
                }
            });
            
            // Initialize
            initializeSURGEOS();
            
            // Show welcome message
            setTimeout(() => {
                updateTerminal("", 'system');
                updateTerminal("Type 'welcome' for system overview", 'prompt-text');
            }, 1500);
        });
    </script>
</body>
</html>
