<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GalaxyCraft v2.1 BETA TEST</title>
  <meta name="description" content="GalaxyCraft v2.0 BETA - A WebGL-powered space mining MMO with enhanced RuneScape-style chat system.">
  <meta name="keywords" content="GalaxyCraft, space mining, WebGL, JavaScript, 3D game, MMO, RuneScape-style chat">
  <meta name="author" content="GalaxyCraft">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: #0a0e17;
      color: #e0f7ff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: radial-gradient(circle at center, #0a0e17 0%, #050811 100%);
    }
    
    header {
      padding: 8px 15px;
      background: rgba(5, 8, 17, 0.8);
      border-bottom: 1px solid #1e3a5f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }
    
    .logo {
      font-size: 18px;
      font-weight: bold;
      color: #4fc3f7;
      text-shadow: 0 0 10px rgba(79, 195, 247, 0.7);
    }
    
    .game-stats {
      display: flex;
      gap: 12px;
      font-size: 13px;
    }
    
    .stat {
      background: rgba(30, 58, 95, 0.6);
      padding: 5px 10px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .stat i {
      color: #4fc3f7;
      font-size: 13px;
    }
    
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .game-canvas-container {
      flex: 1;
      position: relative;
    }
    
    #gameCanvas {
      position: absolute;
      width: 100%;
      height: 100%;
    }
    
    /* Console Popup Windows */
    .console-window {
      position: absolute;
      background: rgba(5, 8, 17, 0.92);
      border: 1px solid #4fc3f7;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(79, 195, 247, 0.3);
      min-width: 250px;
      max-width: 90vw;
      max-height: 90vh;
      z-index: 20;
      overflow: hidden;
      backdrop-filter: blur(5px);
      resize: both;
      min-height: 150px;
      min-width: 200px;
      transition: all 0.2s ease;
    }
    
    .console-header {
      padding: 8px 12px;
      background: rgba(30, 58, 95, 0.6);
      border-bottom: 1px solid #1e3a5f;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      font-size: 14px;
      font-weight: bold;
      color: #4fc3f7;
      user-select: none;
    }
    
    .console-close {
      background: none;
      border: none;
      color: #e0f7ff;
      cursor: pointer;
      font-size: 16px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .console-content {
      padding: 12px;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    /* Specific console windows */
    #dronesConsole { top: 80px; right: 20px; width: 280px; height: auto; }
    
    #chatConsole { bottom: 50px; left: 20px; width: 350px; height: 400px; }
    
    #craftingConsole { 
      bottom: 50px; 
      right: 20px; 
      width: 250px; 
      height: auto; 
      max-height: 400px;
    }
    
    #mapConsole {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      height: 400px;
      z-index: 25;
    }
    
    #statisticsConsole { top: 80px; left: 50%; transform: translateX(-50%); width: 350px; height: auto; }
    
    #auctionConsole { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 500px; height: auto; z-index: 25; }
    
    /* Controls bar */
    .controls-bar {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(5, 8, 17, 0.8);
      border: 1px solid #1e3a5f;
      border-radius: 30px;
      z-index: 15;
    }
    
    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(30, 58, 95, 0.6);
      border: 1px solid #1e3a5f;
      color: #e0f7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      gap: 2px;
    }
    
    .control-btn:hover {
      background: rgba(40, 78, 120, 0.6);
    }
    
    .control-btn.active {
      background: rgba(33, 150, 243, 0.3);
      border: 1px solid #2196f3;
    }
    
    .control-btn i {
      font-size: 16px;
    }
    
    .control-btn.large {
      width: 70px;
      height: 70px;
    }
    
    .control-btn.large i {
      font-size: 20px;
    }
    
    /* Enhanced Chat System - RuneScape/WoW Style */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .chat-tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 1px solid #1e3a5f;
    }
    
    .chat-tab {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 3px solid transparent;
      font-weight: bold;
      transition: all 0.2s ease;
      flex: 1;
      text-align: center;
    }
    
    .chat-tab.active {
      border-bottom: 3px solid;
    }
    
    .chat-tab.quest {
      color: #FFD700; /* Bright Gold */
    }
    
    .chat-tab.quest.active {
      border-bottom-color: #FFD700;
      background: rgba(255, 215, 0, 0.1);
    }
    
    .chat-tab.sector {
      color: #4fc3f7; /* Light Blue */
    }
    
    .chat-tab.sector.active {
      border-bottom-color: #4fc3f7;
      background: rgba(79, 195, 247, 0.1);
    }
    
    .chat-tab.universe {
      color: #00FF00; /* Neon Green */
    }
    
    .chat-tab.universe.active {
      border-bottom-color: #00FF00;
      background: rgba(0, 255, 0, 0.1);
    }
    
    .chat-tab.auction {
      color: #9370DB; /* Medium Purple */
    }
    
    .chat-tab.auction.active {
      border-bottom-color: #9370DB;
      background: rgba(147, 112, 219, 0.1);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      padding: 5px;
      background: rgba(10, 20, 40, 0.5);
      border-radius: 4px;
      max-height: 280px;
    }
    
    .message {
      margin-bottom: 5px;
      font-size: 13px;
      line-height: 1.4;
      padding: 3px 5px;
      border-radius: 3px;
    }
    
    .message:hover {
      background: rgba(30, 58, 95, 0.3);
    }
    
    .message.quest {
      color: #FFD700; /* Bright Gold */
    }
    
    .message.sector {
      color: #4fc3f7; /* Light Blue */
    }
    
    .message.universe {
      color: #00FF00; /* Neon Green */
    }
    
    .message.auction {
      color: #9370DB; /* Medium Purple */
    }
    
    .message.system {
      color: #90caf9;
      font-style: italic;
    }
    
    .message.player {
      color: #ffffff;
    }
    
    .message.captain {
      color: #FFD700;
      font-weight: bold;
    }
    
    .chat-input-container {
      display: flex;
      gap: 8px;
    }
    
    .chat-input {
      flex: 1;
      background: rgba(30, 58, 95, 0.6);
      border: 1px solid #1e3a5f;
      border-radius: 15px;
      padding: 8px 12px;
      color: white;
      font-size: 13px;
    }
    
    .chat-send-btn {
      background: #1565c0;
      color: white;
      border: none;
      border-radius: 15px;
      padding: 0 15px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    
    .chat-send-btn:hover {
      background: #1976d2;
    }
    
    /* Suggested responses */
    .suggested-responses {
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(30, 58, 95, 0.3);
      border-radius: 8px;
    }
    
    .suggestions-title {
      font-size: 11px;
      color: #4fc3f7;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .suggestion-btn {
      background: rgba(30, 58, 95, 0.6);
      border: 1px solid #1e3a5f;
      border-radius: 12px;
      padding: 5px 10px;
      color: #e0f7ff;
      font-size: 11px;
      cursor: pointer;
      margin: 2px;
      transition: all 0.2s;
    }
    
    .suggestion-btn:hover {
      background: rgba(40, 78, 120, 0.6);
      border-color: #4fc3f7;
    }
    
    /* Modal windows */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(5, 8, 17, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .modal-content {
      background: #0f1724;
      border: 1px solid #1e3a5f;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 0 30px rgba(0, 150, 255, 0.2);
    }
    
    .modal-title {
      font-size: 20px;
      color: #4fc3f7;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .modal-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .modal-option {
      background: rgba(30, 58, 95, 0.6);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-option:hover {
      background: rgba(40, 78, 120, 0.6);
    }
    
    .modal-option.active {
      background: rgba(33, 150, 243, 0.3);
      border: 1px solid #2196f3;
    }
    
    .modal-option i {
      font-size: 30px;
      color: #4fc3f7;
      margin-bottom: 8px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      background: #1565c0;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
      text-align: center;
      flex: 1;
      font-size: 14px;
    }
    
    .btn:hover {
      background: #1976d2;
    }
    
    .btn-primary {
      background: #0277bd;
    }
    
    .btn-danger {
      background: #c62828;
    }
    
    .btn-success {
      background: #2e7d32;
    }
    
    .btn-warning {
      background: #f57c00;
    }
    
    footer {
      padding: 8px 15px;
      background: rgba(5, 8, 17, 0.8);
      border-top: 1px solid #1e3a5f;
      text-align: center;
      font-size: 11px;
      color: #5d7a9c;
    }
    
    /* Drone controls */
    .drone-controls {
      margin-bottom: 15px;
    }
    
    .drone-status {
      margin-bottom: 10px;
    }
    
    .drone-progress {
      height: 8px;
      background: rgba(30, 58, 95, 0.6);
      border-radius: 4px;
      margin: 5px 0;
      overflow: hidden;
    }
    
    .drone-progress-bar {
      height: 100%;
      background: #4fc3f7;
      border-radius: 4px;
    }
    
    /* Crafting elements */
    .crafting-item {
      background: rgba(30, 58, 95, 0.6);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .crafting-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .crafting-requirements {
      font-size: 12px;
      color: #90caf9;
      margin-bottom: 8px;
    }
    
    .crafting-missing {
      font-size: 11px;
      color: #ff6b6b;
      margin-top: 5px;
    }
    
    /* HUD elements */
    .hud {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 5;
    }
    
    .crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(74, 144, 226, 0.8);
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
    }
    
    .crosshair::before, .crosshair::after {
      content: '';
      position: absolute;
      background: rgba(74, 144, 226, 0.8);
    }
    
    .crosshair::before {
      top: 50%;
      left: 0;
      width: 100%;
      height: 2px;
      transform: translateY(-50%);
    }
    
    .crosshair::after {
      left: 50%;
      top: 0;
      height: 100%;
      width: 2px;
      transform: translateX(-50%);
    }
    
    .crosshair.in-range {
      border-color: rgba(76, 175, 80, 0.8);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    
    .planet-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 10, 30, 0.8);
      padding: 8px 12px;
      border-radius: 15px;
      font-size: 12px;
      z-index: 20;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(74, 144, 226, 0.3);
      pointer-events: none;
    }
    
    /* Mining overlay */
    .mining-overlay {
      position: absolute;
      bottom: 150px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 10, 30, 0.9);
      padding: 12px;
      border-radius: 10px;
      display: none;
      z-index: 15;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(74, 144, 226, 0.3);
      pointer-events: none;
    }
    
    .mining-overlay.active {
      display: block;
    }
    
    .mining-progress {
      width: 200px;
      height: 10px;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      margin: 8px 0;
    }
    
    .mining-progress-bar {
      height: 100%;
      background: #4a90e2;
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Settings panel */
    .settings-section {
      margin-bottom: 15px;
    }
    
    .settings-section h3 {
      margin-bottom: 10px;
      color: #4fc3f7;
      border-bottom: 1px solid #1e3a5f;
      padding-bottom: 5px;
      font-size: 16px;
    }
    
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .settings-label {
      font-size: 14px;
    }
    
    .settings-control {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    input[type="range"] {
      width: 150px;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    
    .controls-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }
    
    .control-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid rgba(30, 58, 95, 0.6);
    }
    
    /* Map console */
    .map-container {
      width: 100%;
      height: 300px;
      background: rgba(10, 20, 40, 0.8);
      border-radius: 8px;
      margin-bottom: 15px;
      position: relative;
      overflow: hidden;
    }
    
    .map-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 4px;
      height: 4px;
      background: #4fc3f7;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    
    /* Player position indicator on map */
    .player-indicator {
      position: absolute;
      width: 6px;
      height: 6px;
      background: #ff4444;
      border-radius: 50%;
      box-shadow: 0 0 10px #ff4444;
      z-index: 10;
    }
    
    /* Quest system */
    .quest-item {
      background: rgba(30, 58, 95, 0.6);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    
    .quest-item.active {
      background: rgba(33, 150, 243, 0.3);
      border: 1px solid #2196f3;
    }
    
    .quest-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #4fc3f7;
    }
    
    .quest-progress {
      height: 6px;
      background: rgba(30, 58, 95, 0.8);
      border-radius: 3px;
      margin: 5px 0;
      overflow: hidden;
    }
    
    .quest-progress-bar {
      height: 100%;
      background: #4fc3f7;
      border-radius: 3px;
    }
    
    /* Statistics console - Updated with colored resource dots */
    .stats-list {
      font-size: 12px;
      line-height: 1.3;
      padding: 10px;
    }
    
    .stat-header {
      color: #4fc3f7;
      font-weight: bold;
      margin: 8px 0 4px 0;
      border-bottom: 1px solid #1e3a5f;
      padding-bottom: 3px;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }
    
    .resource-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    /* Auction console */
    .auction-item {
      background: rgba(30, 58, 95, 0.6);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }
    
    .auction-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .auction-stats {
      font-size: 12px;
      color: #90caf9;
      margin-bottom: 8px;
    }
    
    /* NFT Engines */
    .nft-engine {
      background: rgba(30, 58, 95, 0.6);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .nft-engine.active {
      background: rgba(33, 150, 243, 0.3);
      border: 1px solid #2196f3;
      box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
    }
    
    .nft-engine:hover {
      background: rgba(40, 78, 120, 0.6);
    }
    
    .nft-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #4fc3f7;
    }
    
    .nft-stats {
      font-size: 12px;
      color: #90caf9;
      margin-bottom: 8px;
    }
    
    .empty-engine-list {
      text-align: center;
      padding: 15px;
      color: #90caf9;
      font-size: 13px;
    }
    
    .missing-resources {
      font-size: 11px;
      color: #ff6b6b;
      margin-top: 8px;
    }
    
    /* Mobile controls */
    .mobile-controls {
      display: none;
      position: absolute;
      bottom: 80px;
      width: 100%;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 15;
    }
    
    .joystick-area {
      width: 120px;
      height: 120px;
      background: rgba(30, 58, 95, 0.3);
      border-radius: 50%;
      position: relative;
      touch-action: none;
    }
    
    .joystick-thumb {
      width: 40px;
      height: 40px;
      background: rgba(79, 195, 247, 0.7);
      border-radius: 50%;
      position: absolute;
      top: 40px;
      left: 40px;
    }
    
    /* Level display */
    .level-display {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .level-bar {
      width: 100px;
      height: 8px;
      background: rgba(30, 58, 95, 0.8);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .level-progress {
      height: 100%;
      background: linear-gradient(90deg, #4fc3f7, #2196f3);
      border-radius: 4px;
    }
    
    /* Splash Text Animation (WoW-style) */
    .splash-text {
      position: absolute;
      color: #4fc3f7;
      font-weight: bold;
      font-size: 24px;
      text-shadow: 2px 2px 4px black;
      pointer-events: none;
      animation: splashFloat 2s ease-out forwards;
      z-index: 100;
    }
    
    @keyframes splashFloat {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -100px) scale(1.5);
        opacity: 0;
      }
    }
    
    /* Performance indicators */
    .performance-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 10, 30, 0.8);
      padding: 6px 10px;
      border-radius: 15px;
      font-size: 11px;
      z-index: 20;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(74, 144, 226, 0.3);
      pointer-events: none;
      display: flex;
      gap: 10px;
    }
    
    .fps-indicator {
      color: #4fc3f7;
    }
    
    .fps-indicator.low {
      color: #ff4444;
    }
    
    .fps-indicator.medium {
      color: #ffb74d;
    }
    
    .fps-indicator.high {
      color: #4fc3f7;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .game-stats {
        font-size: 11px;
        gap: 8px;
      }
      
      .stat {
        padding: 4px 8px;
      }
      
      .console-window {
        min-width: 200px;
        max-width: 280px;
        font-size: 13px;
      }
      
      #chatConsole {
        width: 300px;
      }
      
      #craftingConsole {
        width: 220px;
      }
      
      #mapConsole {
        width: 320px;
        height: 300px;
      }
      
      .controls-bar {
        padding: 8px 12px;
        bottom: 10px;
      }
      
      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 10px;
      }
      
      .control-btn i {
        font-size: 14px;
      }
      
      .control-btn.large {
        width: 60px;
        height: 60px;
      }
      
      .control-btn.large i {
        font-size: 16px;
      }
      
      .mobile-controls {
        display: flex;
      }
    }
    
    @media (max-width: 480px) {
      .logo {
        font-size: 16px;
      }
      
      .game-stats {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .stat {
        margin-bottom: 4px;
      }
      
      header {
        flex-direction: column;
        gap: 8px;
        padding: 8px;
      }
      
      .console-window {
        min-width: 180px;
        max-width: 240px;
      }
      
      #chatConsole {
        width: 270px;
      }
      
      #craftingConsole {
        width: 200px;
      }
      
      #mapConsole {
        width: 300px;
        height: 280px;
      }
      
      .control-btn {
        width: 45px;
        height: 45px;
        font-size: 9px;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">GALAXYCRAFT BETA TEST v2.1</div>
      <div class="game-stats">
        <div class="stat">
          <i class="fas fa-tachometer-alt"></i>
          <span id="speedStat">1.0x</span>
        </div>
        <div class="stat">
          <i class="fas fa-coins"></i>
          <span id="webxosStat">0.00</span>
        </div>
        <div class="stat">
          <i class="fas fa-chart-line"></i>
          <span id="levelStat">1</span>
        </div>
        <div class="stat level-display">
          <i class="fas fa-star"></i>
          <div class="level-bar">
            <div id="levelProgress" class="level-progress" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </header>
    
    <div class="main-content">
      <div class="game-canvas-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- HUD Elements -->
        <div class="hud">
          <div class="crosshair" id="crosshair"></div>
          <div class="planet-indicator" id="planetIndicator">Distance to Planet: --</div>
          <div class="mining-overlay" id="miningOverlay">
            <div>Mining: <span id="miningResource">Unknown</span></div>
            <div class="mining-progress">
              <div id="miningProgress" class="mining-progress-bar"></div>
            </div>
            <div>Yield: <span id="miningYield">0</span> units</div>
          </div>
          <div class="performance-indicator">
            <span class="fps-indicator high" id="fpsIndicator">FPS: --</span>
            <span id="performanceMode">Performance: Optimized</span>
          </div>
        </div>
        
        <!-- Console Windows -->
        <div class="console-window" id="dronesConsole">
          <div class="console-header">
            <span>Drone Control</span>
            <button class="console-close" onclick="toggleConsole('dronesConsole')">&times;</button>
          </div>
          <div class="console-content">
            <div class="drone-controls">
              <div class="drone-status">
                <div style="display: flex; justify-content: space-between;">
                  <span>Red Drone:</span>
                  <span id="redDroneStatus">Idle</span>
                </div>
                <div class="drone-progress">
                  <div id="redDroneProgress" class="drone-progress-bar" style="width: 0%;"></div>
                </div>
              </div>
              <div class="drone-status">
                <div style="display: flex; justify-content: space-between;">
                  <span>Blue Drone:</span>
                  <span id="blueDroneStatus">Idle</span>
                </div>
                <div class="drone-progress">
                  <div id="blueDroneProgress" class="drone-progress-bar" style="width: 0%;"></div>
                </div>
              </div>
              <div class="drone-status">
                <div style="display: flex; justify-content: space-between;">
                  <span>Green Drone:</span>
                  <span id="greenDroneStatus">Idle</span>
                </div>
                <div class="drone-progress">
                  <div id="greenDroneProgress" class="drone-progress-bar" style="width: 0%;"></div>
                </div>
              </div>
            </div>
            <div class="modal-actions">
              <button class="btn btn-primary" onclick="activateAllDrones()">Auto Mine All</button>
              <button class="btn btn-danger" onclick="stopAllDrones()">Stop All</button>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Chat Console -->
        <div class="console-window" id="chatConsole">
          <div class="console-header">
            <span>Galaxy Communications</span>
            <button class="console-close" onclick="toggleConsole('chatConsole')">&times;</button>
          </div>
          <div class="console-content">
            <div class="chat-container">
              <div class="chat-tabs">
                <div class="chat-tab quest active" data-tab="quest" onclick="switchChatTab('quest')">QUEST</div>
                <div class="chat-tab sector" data-tab="sector" onclick="switchChatTab('sector')">SECTOR</div>
                <div class="chat-tab universe" data-tab="universe" onclick="switchChatTab('universe')">UNIVERSE</div>
                <div class="chat-tab auction" data-tab="auction" onclick="switchChatTab('auction')">AUCTION</div>
              </div>
              
              <!-- Suggested Responses -->
              <div id="suggestedResponses" class="suggested-responses"></div>
              
              <div class="chat-messages" id="chatMessages">
                <div class="message quest">[CAPTAIN TAYLOR] Welcome to GalaxyCraft v2.0 with Enhanced Chat!</div>
                <div class="message quest">[CAPTAIN TAYLOR] New resource distribution: 50% chance of no ore, then balanced resources.</div>
                <div class="message quest">[CAPTAIN TAYLOR] Your first mission: Mine at least 5 units of Iron.</div>
              </div>
              <div class="chat-input-container">
                <input type="text" class="chat-input" placeholder="Type your message..." id="chatInput" onkeypress="handleChatInput(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Crafting Console -->
        <div class="console-window" id="craftingConsole">
          <div class="console-header">
            <span>Crafting & NFT Forge</span>
            <button class="console-close" onclick="toggleConsole('craftingConsole')">&times;</button>
          </div>
          <div class="console-content">
            <div class="crafting-item">
              <div class="crafting-name">NFT Engine</div>
              <div class="crafting-requirements">Requires: 100 Iron, 75 Silicon, 50 Gold, 25 Platinum, 10 Uranium, 5 Dark Matter</div>
              <button class="btn btn-primary" style="width: 100%;" onclick="craftNFTEngine()">Craft NFT Engine</button>
              <div id="missingResources" class="crafting-missing"></div>
            </div>
            
            <div class="stat-header" style="margin-top: 15px;">Your NFT Engines</div>
            <div id="nftEnginesList">
              <!-- NFT Engines will be listed here -->
              <div class="empty-engine-list" id="emptyEngineMessage">
                EMPTY - CRAFT YOUR FIRST ENGINE
              </div>
            </div>
          </div>
        </div>
        
        <div class="console-window" id="mapConsole">
          <div class="console-header">
            <span>Sector Map</span>
            <button class="console-close" onclick="toggleConsole('mapConsole')">&times;</button>
          </div>
          <div class="console-content">
            <div class="map-container" id="mapContainer">
              <div class="map-center"></div>
              <div class="player-indicator" id="playerIndicator"></div>
              <!-- Map will be drawn here -->
            </div>
            <div style="text-align: center;">
              <button class="btn" onclick="centerMap()">Center Map</button>
            </div>
          </div>
        </div>
        
        <!-- Statistics Console -->
        <div class="console-window" id="statisticsConsole">
          <div class="console-header">
            <span>Player Statistics</span>
            <button class="console-close" onclick="toggleConsole('statisticsConsole')">&times;</button>
          </div>
          <div class="console-content">
            <div class="stats-list" id="statsList">
              <!-- Statistics will be dynamically populated here -->
            </div>
          </div>
        </div>
        
        <div class="console-window" id="auctionConsole">
          <div class="console-header">
            <span>Auction House</span>
            <button class="console-close" onclick="toggleConsole('auctionConsole')">&times;</button>
          </div>
          <div class="console-content">
            <div class="auction-item">
              <div class="auction-name">NFT Engine - Speed Boost</div>
              <div class="auction-stats">Speed: +35%, Mining: +42%</div>
              <div class="auction-stats">Price: 15.50 WebXOS</div>
              <button class="btn btn-primary" style="width: 100%;" onclick="buyNFTEngine(1)">Buy NFT Engine</button>
            </div>
            
            <div class="auction-item">
              <div class="auction-name">Resource Bundle - Iron & Silicon</div>
              <div class="auction-stats">Iron: 500, Silicon: 300</div>
              <div class="auction-stats">Price: 8.25 WebXOS</div>
              <button class="btn" style="width: 100%;" onclick="buyResourceBundle(1)">Buy Resource Bundle</button>
            </div>
            
            <div class="auction-item">
              <div class="auction-name">Drone Upgrade Kit</div>
              <div class="auction-stats">Upgrades all drones by 1 level</div>
              <div class="auction-stats">Price: 25.00 WebXOS</div>
              <button class="btn" style="width: 100%;" onclick="buyDroneUpgrade()">Buy Drone Upgrade</button>
            </div>
            
            <div class="modal-actions" style="margin-top: 15px;">
              <button class="btn btn-success" onclick="sellNFTEngine()">Sell Selected NFT</button>
              <button class="btn btn-warning" onclick="sellResources()">Sell Resources</button>
            </div>
          </div>
        </div>
        
        <!-- Controls Bar -->
        <div class="controls-bar">
          <button class="control-btn" title="Drones" onclick="toggleConsole('dronesConsole')">
            <i class="fas fa-robot"></i>
            <span>DRONES</span>
          </button>
          <button class="control-btn" title="Statistics" onclick="toggleConsole('statisticsConsole')">
            <i class="fas fa-chart-bar"></i>
            <span>STATS</span>
          </button>
          <button class="control-btn" title="Chat" onclick="openQuestChat()">
            <i class="fas fa-comments"></i>
            <span>CHAT</span>
          </button>
          <button class="control-btn large" title="Mine" onclick="startMining()">
            <i class="fas fa-digging"></i>
            <span>MINE</span>
          </button>
          <button class="control-btn" title="Crafting" onclick="toggleConsole('craftingConsole')">
            <i class="fas fa-hammer"></i>
            <span>CRAFT</span>
          </button>
          <button class="control-btn" title="Map" onclick="toggleMapConsole()">
            <i class="fas fa-map"></i>
            <span>MAP</span>
          </button>
          <button class="control-btn" title="Auction" onclick="toggleConsole('auctionConsole')">
            <i class="fas fa-gavel"></i>
            <span>AUCTION</span>
          </button>
          <button class="control-btn" title="Settings" onclick="toggleModal('settingsModal')">
            <i class="fas fa-cog"></i>
            <span>SETTINGS</span>
          </button>
        </div>
        
        <!-- Mobile Controls (hidden on desktop) -->
        <div class="mobile-controls">
          <div class="joystick-area" id="leftJoystick">
            <div class="joystick-thumb"></div>
          </div>
          <div class="joystick-area" id="rightJoystick">
            <div class="joystick-thumb"></div>
          </div>
        </div>
      </div>
    </div>
    
    <footer>
      &copy; 2025 GalaxyCraft | BETA TEST v2.1 | <span id="currentSector">Sector: Localdb</span>
    </footer>
  </div>
  
  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-title">CONTROLS & SETTINGS</div>
      <div class="console-content">
        <div class="settings-section">
          <h3>Performance Settings</h3>
          <div class="settings-row">
            <div class="settings-label">Performance Mode</div>
            <div class="settings-control">
              <select id="performanceModeSelect" onchange="changePerformanceMode()">
                <option value="low">Low (Max FPS)</option>
                <option value="medium" selected>Medium (Balanced)</option>
                <option value="high">High (Best Graphics)</option>
              </select>
            </div>
          </div>
          <div class="settings-row">
            <div class="settings-label">Asteroid Detail</div>
            <div class="settings-control">
              <select id="asteroidDetail" onchange="updateAsteroidDetail()">
                <option value="low">Low (Best Performance)</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High (Best Visuals)</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>Mouse Controls</h3>
          <div class="settings-row">
            <div class="settings-label">Mouse Sensitivity</div>
            <div class="settings-control">
              <input type="range" min="1" max="100" value="50" id="mouseSensitivity">
              <span id="sensitivityValue">1.0x</span>
            </div>
          </div>
          <div class="settings-row">
            <div class="settings-label">Invert Y-Axis</div>
            <div class="settings-control">
              <input type="checkbox" id="invertYAxis">
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>Game Controls</h3>
          <div class="controls-list">
            <div class="control-item">
              <span>W</span>
              <span>Thrust Forward</span>
            </div>
            <div class="control-item">
              <span>S</span>
              <span>Thrust Backward</span>
            </div>
            <div class="control-item">
              <span>A</span>
              <span>Strafe Left</span>
            </div>
            <div class="control-item">
              <span>D</span>
              <span>Strafe Right</span>
            </div>
            <div class="control-item">
              <span>Q</span>
              <span>Tilt Left (Roll)</span>
            </div>
            <div class="control-item">
              <span>E</span>
              <span>Tilt Right (Roll)</span>
            </div>
            <div class="control-item">
              <span>Z</span>
              <span>Barrel Roll Left</span>
            </div>
            <div class="control-item">
              <span>X</span>
              <span>Barrel Roll Right</span>
            </div>
            <div class="control-item">
              <span>Mouse</span>
              <span>360° Free Look & Steering</span>
            </div>
            <div class="control-item">
              <span>Space / Left Click</span>
              <span>Mine Asteroid</span>
            </div>
            <div class="control-item">
              <span>Right Click</span>
              <span>Auto Mine All</span>
            </div>
            <div class="control-item">
              <span>M</span>
              <span>Toggle Map</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
        <button class="btn btn-danger" onclick="toggleModal('settingsModal')">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // Game state
    const gameState = {
      // Resources - UPDATED with new distribution
      resources: {
        iron: { ship: 0, stash: 0, mined: 0 },
        silicon: { ship: 0, stash: 0, mined: 0 },
        gold: { ship: 0, stash: 0, mined: 0 },
        platinum: { ship: 0, stash: 0, mined: 0 },
        uranium: { ship: 0, stash: 0, mined: 0 },
        darkMatter: { ship: 0, stash: 0, mined: 0 }
      },
      
      // Player stats
      speed: 1.0,
      level: 1,
      xp: 0,
      webxos: 0,
      totalDistanceTraveled: 0,
      previousPosition: null,
      
      // Drones
      drones: [
        { id: 'red', status: 'idle', progress: 0, capacity: 200, level: 1, object: null, speed: 3.0 },
        { id: 'blue', status: 'idle', progress: 0, capacity: 200, level: 1, object: null, speed: 3.0 },
        { id: 'green', status: 'idle', progress: 0, capacity: 200, level: 1, object: null, speed: 3.0 }
      ],
      
      // NFT Engines
      nftEngines: [],
      activeNftEngine: null,
      
      // Quests
      availableQuests: [
        { 
          id: 'mineIron', 
          name: 'Mine 10 Iron', 
          description: 'Mine 10 iron asteroids',
          reward: { webxos: 5.0, xp: 500 },
          progress: 0,
          target: 10,
          type: 'resourceCount',
          resource: 'iron'
        },
        { 
          id: 'mineSilicon', 
          name: 'Mine 5 Silicon', 
          description: 'Mine 5 silicon asteroids',
          reward: { webxos: 5.0, xp: 500 },
          progress: 0,
          target: 5,
          type: 'resourceCount',
          resource: 'silicon'
        },
        { 
          id: 'travel500', 
          name: 'Travel 500 Units', 
          description: 'Travel 500 units from planet',
          reward: { webxos: 10.0, xp: 1000 },
          progress: 0,
          target: 500,
          type: 'distanceTraveled'
        },
        { 
          id: 'mineGold', 
          name: 'Mine 3 Gold', 
          description: 'Mine 3 gold asteroids',
          reward: { webxos: 15.0, xp: 1500 },
          progress: 0,
          target: 3,
          type: 'resourceCount',
          resource: 'gold'
        },
        { 
          id: 'upgradeRedDrone', 
          name: 'Upgrade Red Drone', 
          description: 'Upgrade red drone to level 2',
          reward: { webxos: 20.0, xp: 2000 },
          progress: 0,
          target: 2,
          type: 'droneLevel',
          drone: 'red'
        },
        { 
          id: 'minePlatinum', 
          name: 'Mine 2 Platinum', 
          description: 'Mine 2 platinum asteroids',
          reward: { webxos: 25.0, xp: 2500 },
          progress: 0,
          target: 2,
          type: 'resourceCount',
          resource: 'platinum'
        },
        { 
          id: 'collect1000', 
          name: 'Collect 1000 Resources', 
          description: 'Collect 1000 total resources',
          reward: { webxos: 50.0, xp: 5000 },
          progress: 0,
          target: 1000,
          type: 'totalResources'
        },
        { 
          id: 'mineUranium', 
          name: 'Mine 1 Uranium', 
          description: 'Mine 1 uranium asteroid',
          reward: { webxos: 75.0, xp: 7500 },
          progress: 0,
          target: 1,
          type: 'resourceCount',
          resource: 'uranium'
        },
        { 
          id: 'mineDarkMatter', 
          name: 'Mine 1 Dark Matter', 
          description: 'Mine 1 dark matter asteroid',
          reward: { webxos: 100.0, xp: 10000 },
          progress: 0,
          target: 1,
          type: 'resourceCount',
          resource: 'darkMatter'
        }
      ],
      activeQuest: null,
      completedQuests: [],
      
      // Settings
      settings: {
        mouseSensitivity: 1.0,
        invertYAxis: false,
        performanceMode: 'medium',
        asteroidDetail: 'medium'
      },
      
      // Game objects
      asteroids: [],
      homePlanet: null,
      player: null,
      
      // Game state
      isMining: false,
      miningTarget: null,
      miningProgress: 0,
      gameStarted: false,
      asteroidsMined: 0,
      autoMining: false,
      
      // Movement state
      movement: {
        forward: false,
        backward: false,
        strafeLeft: false,
        strafeRight: false,
        tiltLeft: false,
        tiltRight: false,
        barrelRollLeft: false,
        barrelRollRight: false
      },
      
      // Chat state
      currentChatTab: 'quest',
      
      // Performance tracking
      frameCount: 0,
      lastFpsUpdate: 0,
      fps: 0,
      frameTimes: [],
      
      // FPS throttling for low mode
      lastFrameTime: 0
    };

    // Performance optimizations
    const performanceSettings = {
      low: {
        asteroidSegments: 4,
        starCount: 500,
        droneDetail: 'low',
        updateInterval: 33,
        asteroidLimit: 50,
        disableShadows: true
      },
      medium: {
        asteroidSegments: 12,
        starCount: 3000,
        droneDetail: 'medium',
        updateInterval: 100
      },
      high: {
        asteroidSegments: 24,
        starCount: 5000,
        droneDetail: 'high',
        updateInterval: 50
      }
    };

    // Resource colors for UI
    const resourceColors = {
      iron: '#ff8c00',      // Dark orange
      silicon: '#00bfff',    // Deep sky blue
      gold: '#ffd700',       // Gold
      platinum: '#e5e4e2',   // Platinum
      uranium: '#00ff00',    // Bright green
      darkMatter: '#8a2be2'  // Blue violet
    };

    // Captain Taylor chat system
    const captainTaylor = {
      currentStep: 0,
      questsGiven: false,
      activeQuestOffer: [],
      
      // Initialize Captain Taylor's quest system
      init: function() {
        this.showWelcomeMessage();
      },
      
      // Show welcome message and initial guidance
      showWelcomeMessage: function() {
        addChatMessage("quest", "[CAPTAIN TAYLOR] Welcome to GalaxyCraft v2.0 with Enhanced Chat!");
        addChatMessage("quest", "[CAPTAIN TAYLOR] New resource distribution: 50% chance of no ore, then balanced resources.");
        addChatMessage("quest", "[CAPTAIN TAYLOR] Type 'quests' to see available missions or 'help' for guidance.");
        
        // Show suggested responses
        this.showSuggestedResponses();
      },
      
      // Show suggested chat responses
      showSuggestedResponses: function() {
        const suggestions = document.getElementById('suggestedResponses');
        if (!suggestions) return;
        
        let html = '<div class="suggestions-title">Quick Commands:</div>';
        
        html += `
          <button class="suggestion-btn" onclick="setChatInput('quests')">Show Quests</button>
          <button class="suggestion-btn" onclick="setChatInput('status')">Quest Status</button>
          <button class="suggestion-btn" onclick="setChatInput('complete quest')">Complete Quest</button>
          <button class="suggestion-btn" onclick="setChatInput('help')">Help</button>
        `;
        
        suggestions.innerHTML = html;
      },
      
      // Handle player messages to Captain Taylor
      handleMessage: function(message) {
        const lowerMessage = message.toLowerCase();
        
        // Quest-related commands
        if (lowerMessage.includes('quest') || lowerMessage === 'quests') {
          this.showAvailableQuests();
        } else if (lowerMessage.startsWith('accept ')) {
          this.acceptQuest(message);
        } else if (lowerMessage.includes('status') || lowerMessage === 'status') {
          this.showQuestStatus();
        } else if (lowerMessage.includes('complete')) {
          this.completeCurrentQuest();
        } else if (lowerMessage === 'help') {
          this.showHelp();
        } else {
          this.showGenericResponse();
        }
      },
      
      // Show available quests (3 at a time)
      showAvailableQuests: function() {
        // If we have an active quest, show only that
        if (gameState.activeQuest) {
          addChatMessage("quest", "[CAPTAIN TAYLOR] You have an active mission:");
          this.showQuestDetails(gameState.activeQuest);
          addChatMessage("quest", "[CAPTAIN TAYLOR] Complete it first before taking on new missions.");
          return;
        }
        
        // Generate 3 random quests from available pool
        this.activeQuestOffer = this.getRandomQuests(3);
        
        addChatMessage("quest", "[CAPTAIN TAYLOR] Pilot, I have missions for you:");
        
        this.activeQuestOffer.forEach((quest, index) => {
          addChatMessage("quest", `[CAPTAIN TAYLOR] ${index + 1}. ${quest.name} - ${quest.description}`);
          addChatMessage("quest", `[CAPTAIN TAYLOR]    Reward: ${quest.reward.webxos} WebXOS + ${quest.reward.xp} XP`);
        });
        
        addChatMessage("quest", "[CAPTAIN TAYLOR] Type 'accept 1/2/3' to choose a mission.");
        
        this.showSuggestedResponses();
      },
      
      // Get random quests from available pool
      getRandomQuests: function(count) {
        const available = gameState.availableQuests.filter(q => !q.completed);
        const shuffled = [...available].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
      },
      
      // Accept a specific quest
      acceptQuest: function(message) {
        // If we already have an active quest
        if (gameState.activeQuest) {
          addChatMessage("quest", "[CAPTAIN TAYLOR] You already have an active mission! Complete it first.");
          return;
        }
        
        let questNumber;
        
        if (message.toLowerCase().includes('accept')) {
          questNumber = parseInt(message.replace('accept ', ''));
        }
        
        if (!questNumber || isNaN(questNumber) || questNumber < 1 || questNumber > this.activeQuestOffer.length) {
          addChatMessage("quest", "[CAPTAIN TAYLOR] Invalid quest number. Type 'quests' to see available missions.");
          return;
        }
        
        const questIndex = questNumber - 1;
        const quest = this.activeQuestOffer[questIndex];
        
        // Set as active quest
        gameState.activeQuest = quest;
        this.activeQuestOffer = []; // Clear the offer
        
        addChatMessage("quest", `[CAPTAIN TAYLOR] Mission accepted: ${quest.name}`);
        addChatMessage("quest", `[CAPTAIN TAYLOR] ${quest.description}`);
        addChatMessage("quest", "[CAPTAIN TAYLOR] I'll track your progress automatically. Good luck!");
        
        this.showSuggestedResponses();
      },
      
      // Show current quest status
      showQuestStatus: function() {
        if (gameState.activeQuest) {
          const quest = gameState.activeQuest;
          this.showQuestDetails(quest);
        } else {
          addChatMessage("quest", "[CAPTAIN TAYLOR] You don't have an active mission. Type 'quests' to see available missions.");
        }
      },
      
      // Show detailed quest information
      showQuestDetails: function(quest) {
        addChatMessage("quest", `[CAPTAIN TAYLOR] Current Mission: ${quest.name}`);
        addChatMessage("quest", `[CAPTAIN TAYLOR] Progress: ${quest.progress}/${quest.target}`);
        addChatMessage("quest", `[CAPTAIN TAYLOR] ${quest.description}`);
      },
      
      // Try to complete the current quest
      completeCurrentQuest: function() {
        if (gameState.activeQuest) {
          const quest = gameState.activeQuest;
          if (quest.progress >= quest.target) {
            this.completeQuest(quest);
            gameState.activeQuest = null;
            
            // Offer new quests after completion
            setTimeout(() => {
              addChatMessage("quest", "[CAPTAIN TAYLOR] Outstanding work! Ready for your next mission?");
              this.showAvailableQuests();
            }, 2000);
          } else {
            addChatMessage("quest", `[CAPTAIN TAYLOR] You haven't completed this mission yet!`);
            addChatMessage("quest", `[CAPTAIN TAYLOR] Progress: ${quest.progress}/${quest.target}`);
            addChatMessage("quest", `[CAPTAIN TAYLOR] Keep working on: ${quest.description}`);
          }
        } else {
          addChatMessage("quest", "[CAPTAIN TAYLOR] You don't have an active quest to complete.");
          addChatMessage("quest", "[CAPTAIN TAYLOR] Type 'quests' to see available missions.");
        }
      },
      
      // Show general help
      showHelp: function() {
        addChatMessage("quest", "[CAPTAIN TAYLOR] GalaxyCraft v2.0 - Enhanced Chat - Quick Guide:");
        addChatMessage("quest", "[CAPTAIN TAYLOR] • Mining: SPACE or click to mine asteroids (0.1 WebXOS + 10 XP each)");
        addChatMessage("quest", "[CAPTAIN TAYLOR] • Resource Distribution: 50% chance of no ore, then:");
        addChatMessage("quest", "[CAPTAIN TAYLOR]   - Iron & Silicon: 50% chance each");
        addChatMessage("quest", "[CAPTAIN TAYLOR]   - Gold & Platinum: 10% chance each");
        addChatMessage("quest", "[CAPTAIN TAYLOR]   - Uranium: 5% chance");
        addChatMessage("quest", "[CAPTAIN TAYLOR]   - Dark Matter: 1% chance");
        addChatMessage("quest", "[CAPTAIN TAYLOR] • Movement: W/A/S/D to fly, mouse to look around");
        addChatMessage("quest", "[CAPTAIN TAYLOR] • Drones: Auto-mine resources while you explore (0.05 WebXOS + 5 XP each)");
        addChatMessage("quest", "[CAPTAIN TAYLOR] • Leveling: Mine asteroids and complete quests to level up (1-100)");
        addChatMessage("quest", "[CAPTAIN TAYLOR] • NFT Engines: Craft these for permanent ship upgrades (requires all resources)");
        addChatMessage("quest", "[CAPTAIN TAYLOR] • Commands: 'quests', 'accept [number]', 'status', 'complete quest', 'help'");
        addChatMessage("quest", "[CAPTAIN TAYLOR] Type specific commands for more detailed help!");
        
        this.showSuggestedResponses();
      },
      
      // Show generic response for unrecognized messages
      showGenericResponse: function() {
        const responses = [
          "I'm here to help with your mining operations. Try asking about quests!",
          "Need guidance? Type 'help' for general assistance or 'quests' to see available missions.",
          "Remember, every asteroid you mine brings you closer to building your mining empire!",
          "Have you checked your current quest progress? Type 'status' to see how you're doing."
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        addChatMessage("quest", `[CAPTAIN TAYLOR] ${randomResponse}`);
        
        this.showSuggestedResponses();
      },
      
      // Update quest progress (called from main game loop)
      updateQuestProgress: function() {
        // Update active quest progress
        if (gameState.activeQuest && !gameState.activeQuest.completed) {
          const quest = gameState.activeQuest;
          let questCompleted = false;
          
          switch(quest.type) {
            case 'resourceCount':
              quest.progress = gameState.resources[quest.resource].mined;
              if (quest.progress >= quest.target) questCompleted = true;
              break;
            case 'distanceTraveled':
              quest.progress = Math.min(quest.target, gameState.totalDistanceTraveled);
              if (quest.progress >= quest.target) questCompleted = true;
              break;
            case 'droneLevel':
              const drone = gameState.drones.find(d => d.id === quest.drone);
              if (drone) {
                quest.progress = drone.level;
                if (quest.progress >= quest.target) questCompleted = true;
              }
              break;
            case 'totalResources':
              let total = 0;
              Object.values(gameState.resources).forEach(resource => {
                total += resource.mined;
              });
              quest.progress = Math.min(quest.target, total);
              if (quest.progress >= quest.target) questCompleted = true;
              break;
          }
          
          if (questCompleted) {
            this.completeQuest(quest);
            gameState.activeQuest = null;
          }
        }
      },
      
      // Complete a quest and award rewards
      completeQuest: function(quest) {
        quest.completed = true;
        
        // Award WebXOS and XP
        gameState.webxos += quest.reward.webxos;
        gameState.xp += quest.reward.xp;
        
        // Check for level up
        checkLevelUp();
        
        // Show completion message
        addChatMessage("quest", `[CAPTAIN TAYLOR] MISSION COMPLETED: ${quest.name}`);
        addChatMessage("quest", `[CAPTAIN TAYLOR] Reward: ${quest.reward.webxos} WebXOS and ${quest.reward.xp} XP`);
        
        // Update UI
        updateUI();
      }
    };

    // Initialize Three.js scene
    let scene, camera, renderer;
    let stars;
    
    // Mouse control variables
    let isPointerLocked = false;
    const euler = new THREE.Euler(0, 0, 0, 'YXZ');
    
    // Console management
    let activeConsoles = {};
    let dragData = { isDragging: false, element: null, offsetX: 0, offsetY: 0 };
    
    // Map variables
    let mapCanvas, mapCtx;
    let mapUpdateInterval;

    // UPDATED: Get random resource type with new distribution
    function getRandomResourceType() {
      const rand = Math.random();
      
      // 50% chance of no ore
      if (rand < 0.5) return 'none';
      
      // Remaining 50% divided among resources
      const resourceRand = Math.random();
      
      if (resourceRand < 0.5) return 'iron';       // 25% overall (50% of 50%)
      if (resourceRand < 0.75) return 'silicon';   // 12.5% overall (25% of 50%)
      if (resourceRand < 0.85) return 'gold';      // 5% overall (10% of 50%)
      if (resourceRand < 0.95) return 'platinum';  // 5% overall (10% of 50%)
      if (resourceRand < 0.99) return 'uranium';   // 2% overall (4% of 50%)
      return 'darkMatter';                         // 0.5% overall (1% of 50%)
    }

    function toggleMapConsole() {
      const map = document.getElementById('mapConsole');
      if (map.style.display === 'block') {
        map.style.display = 'none';
        // Stop map updates when closed
        if (mapUpdateInterval) {
          clearInterval(mapUpdateInterval);
          mapUpdateInterval = null;
        }
      } else {
        map.style.display = 'block';
        map.style.left = '50%';
        map.style.top = '50%';
        map.style.transform = 'translate(-50%, -50%)';
        
        // Initialize map canvas if not already done
        if (!mapCanvas) {
          initMapCanvas();
        }
        
        // Start map updates
        if (!mapUpdateInterval) {
          mapUpdateInterval = setInterval(drawMap, 100); // Update every 100ms
        }
      }
    }

    // Initialize map canvas
    function initMapCanvas() {
      const mapContainer = document.getElementById('mapContainer');
      mapCanvas = document.createElement('canvas');
      mapCanvas.width = 480;
      mapCanvas.height = 280;
      mapCanvas.style.width = '100%';
      mapCanvas.style.height = '100%';
      mapContainer.appendChild(mapCanvas);
      mapCtx = mapCanvas.getContext('2d');
    }

    // Draw the map with player position indicator
    function drawMap() {
      if (!mapCtx) return;
      
      const width = mapCanvas.width;
      const height = mapCanvas.height;
      
      // Clear the canvas
      mapCtx.clearRect(0, 0, width, height);
      
      // Draw background
      mapCtx.fillStyle = 'rgba(5, 8, 17, 0.9)';
      mapCtx.fillRect(0, 0, width, height);
      
      // Draw grid
      mapCtx.strokeStyle = 'rgba(30, 58, 95, 0.5)';
      mapCtx.lineWidth = 1;
      
      // Vertical lines
      for (let x = 0; x <= width; x += width / 10) {
        mapCtx.beginPath();
        mapCtx.moveTo(x, 0);
        mapCtx.lineTo(x, height);
        mapCtx.stroke();
      }
      
      // Horizontal lines
      for (let y = 0; y <= height; y += height / 10) {
        mapCtx.beginPath();
        mapCtx.moveTo(0, y);
        mapCtx.lineTo(width, y);
        mapCtx.stroke();
      }
      
      // Draw home planet at center with bright green
      mapCtx.fillStyle = '#00FF00';
      mapCtx.beginPath();
      mapCtx.arc(width / 2, height / 2, 8, 0, Math.PI * 2);
      mapCtx.fill();
      
      // Draw player position indicator
      const playerX = width / 2 + (camera.position.x / 400) * (width / 2);
      const playerY = height / 2 + (camera.position.z / 400) * (height / 2);
      
      // Only draw if within map bounds
      if (playerX >= 0 && playerX <= width && playerY >= 0 && playerY <= height) {
        // Draw player indicator
        const playerIndicator = document.getElementById('playerIndicator');
        playerIndicator.style.left = `${playerX - 3}px`;
        playerIndicator.style.top = `${playerY - 3}px`;
        
        // Also draw on canvas for backup
        mapCtx.fillStyle = '#ff4444';
        mapCtx.beginPath();
        mapCtx.arc(playerX, playerY, 3, 0, Math.PI * 2);
        mapCtx.fill();
        
        // Draw a small arrow indicating direction
        const forward = new THREE.Vector3();
        camera.getWorldDirection(forward);
        const angle = Math.atan2(forward.x, forward.z);
        
        mapCtx.strokeStyle = '#ff4444';
        mapCtx.lineWidth = 2;
        mapCtx.beginPath();
        mapCtx.moveTo(playerX, playerY);
        mapCtx.lineTo(
          playerX + Math.sin(angle) * 10,
          playerY + Math.cos(angle) * 10
        );
        mapCtx.stroke();
      }
      
      // Draw asteroids
      mapCtx.fillStyle = '#888888';
      gameState.asteroids.forEach(asteroid => {
        if (!asteroid.userData.mined) {
          const x = width / 2 + (asteroid.position.x / 400) * (width / 2);
          const y = height / 2 + (asteroid.position.z / 400) * (height / 2);
          
          // Only draw if within map bounds
          if (x >= 0 && x <= width && y >= 0 && y <= height) {
            mapCtx.beginPath();
            mapCtx.arc(x, y, 2, 0, Math.PI * 2);
            mapCtx.fill();
          }
        }
      });
      
      // Draw drones
      const droneColors = {
        red: '#ff4444',
        blue: '#4444ff',
        green: '#44ff44'
      };
      
      gameState.drones.forEach(drone => {
        if (drone.object) {
          const x = width / 2 + (drone.object.position.x / 400) * (width / 2);
          const y = height / 2 + (drone.object.position.z / 400) * (height / 2);
          
          // Only draw if within map bounds
          if (x >= 0 && x <= width && y >= 0 && y <= height) {
            mapCtx.fillStyle = droneColors[drone.id];
            mapCtx.beginPath();
            mapCtx.arc(x, y, 3, 0, Math.PI * 2);
            mapCtx.fill();
          }
        }
      });
    }

    // Initialize the game
    function init() {
      // Create scene
      scene = new THREE.Scene();
      
      // Create camera
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(0, 5, 15);
      gameState.previousPosition = camera.position.clone();
      
      // Create renderer with performance optimizations
      renderer = new THREE.WebGLRenderer({ 
        canvas: document.getElementById('gameCanvas'), 
        antialias: true,
        alpha: true,
        powerPreference: "high-performance"
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x050811);
      
      // Low-end memory management
      if (gameState.settings.performanceMode === 'low') {
        // Reduce render target for better performance
        renderer.setPixelRatio(0.5);
        // Limit draw calls
        scene.traverse(obj => {
          if (obj.geometry) obj.geometry.dispose();
        });
      } else {
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for performance
      }
      
      // Add stars background
      createStarfield();
      
      // Create home planet
      createHomePlanet();
      
      // Create asteroid field
      createAsteroids(50);
      
      // Create player ship
      createPlayerShip();
      
      // Create drones
      createDrones();
      
      // Setup console dragging
      setupConsoleDragging();
      
      // Initialize consoles as hidden
      document.querySelectorAll('.console-window').forEach(console => {
        console.style.display = 'none';
      });
      
      // Show statistics console by default
      toggleConsole('statisticsConsole');
      
      // Handle window resize
      window.addEventListener('resize', onWindowResize);
      
      // Setup event listeners
      setupEventListeners();
      
      // Initialize Captain Taylor
      initCaptainTaylor();
      
      // Start animation loop
      animate();
      
      // Start game loop with performance-based interval
      startGameLoop();
      
      // Initialize UI
      updateUI();
      
      // Update missing resources display
      updateMissingResources();
      
      // Add welcome message
      addChatMessage("system", "[SYSTEM] GalaxyCraft v2.0 with Enhanced Chat initialized. Welcome, pilot!");
      addChatMessage("system", "[SYSTEM] New resource distribution: 50% chance of no ore, then balanced resources.");
      addChatMessage("system", "[SYSTEM] Use W to thrust forward, A/D to strafe, mouse to look around, SPACE to mine.");
      
      // Initialize FPS counter
      updateFPS();
    }
    
    // Start game loop with performance-based interval
    function startGameLoop() {
      const interval = performanceSettings[gameState.settings.performanceMode].updateInterval;
      setInterval(gameLoop, interval);
    }
    
    // Initialize Captain Taylor
    function initCaptainTaylor() {
      captainTaylor.init();
    }
    
    // Function to set chat input value
    function setChatInput(text) {
      document.getElementById('chatInput').value = text;
      document.getElementById('chatInput').focus();
    }
    
    // Open Quest chat
    function openQuestChat() {
      toggleConsole('chatConsole');
      switchChatTab('quest');
    }
    
    // Create starfield background with performance settings
    function createStarfield() {
      const starCount = performanceSettings[gameState.settings.performanceMode].starCount;
      const starGeometry = new THREE.BufferGeometry();
      const starMaterial = new THREE.PointsMaterial({
        color: 0xffffff,
        size: 0.1,
        sizeAttenuation: true
      });
      
      const starVertices = [];
      for (let i = 0; i < starCount; i++) {
        const x = (Math.random() - 0.5) * 2000;
        const y = (Math.random() - 0.5) * 2000;
        const z = (Math.random() - 0.5) * 2000;
        starVertices.push(x, y, z);
      }
      
      starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
      stars = new THREE.Points(starGeometry, starMaterial);
      scene.add(stars);
    }
    
    // Create home planet with neon green glow
    function createHomePlanet() {
      const planetGeometry = new THREE.SphereGeometry(15, 32, 32);
      const planetMaterial = new THREE.MeshPhongMaterial({ 
        color: 0x00ff00,
        shininess: 100,
        emissive: 0x00ff00,
        emissiveIntensity: 0.5
      });
      gameState.homePlanet = new THREE.Mesh(planetGeometry, planetMaterial);
      gameState.homePlanet.position.set(0, 0, 0);
      scene.add(gameState.homePlanet);
      
      // Add bright directional light for planet
      const planetLight = new THREE.PointLight(0x00ff00, 2, 200);
      planetLight.position.set(0, 0, 0);
      scene.add(planetLight);
      
      // Add glow effect with point light
      const glowLight = new THREE.PointLight(0x00ff00, 1, 150);
      glowLight.position.set(0, 0, 0);
      scene.add(glowLight);
    }
    
    // Create asteroid field with performance settings
    function createAsteroids(count) {
      const maxCount = gameState.settings.performanceMode === 'low' ? 50 : 100;
      count = Math.min(count, maxCount);
      
      const segments = performanceSettings[gameState.settings.performanceMode].asteroidSegments;
      
      for (let i = 0; i < count; i++) {
        const size = 1 + Math.random() * 3;
        const geometry = new THREE.SphereGeometry(size, segments, segments);
        
        // Create a rocky texture with slight glow
        const material = new THREE.MeshPhongMaterial({ 
          color: 0x888888,
          shininess: 10,
          emissive: 0x222222
        });
        
        const asteroid = new THREE.Mesh(geometry, material);
        
        // Position randomly in space (avoiding the center where the planet is)
        let position;
        do {
          position = new THREE.Vector3(
            (Math.random() - 0.5) * 400,
            (Math.random() - 0.5) * 400,
            (Math.random() - 0.5) * 400
          );
        } while (position.length() < 50); // Keep asteroids away from the planet
        
        asteroid.position.copy(position);
        
        // Add rotation animation data
        asteroid.userData = {
          rotationSpeed: {
            x: (Math.random() - 0.5) * 0.01,
            y: (Math.random() - 0.5) * 0.01,
            z: (Math.random() - 0.5) * 0.01
          },
          resourceType: getRandomResourceType(),
          mined: false,
          respawnTimer: null
        };
        
        scene.add(asteroid);
        gameState.asteroids.push(asteroid);
      }
    }
    
    // Create drones with performance settings
    function createDrones() {
      const droneColors = {
        red: 0xff4444,
        blue: 0x4444ff,
        green: 0x44ff44
      };
      
      const detail = performanceSettings[gameState.settings.performanceMode].droneDetail;
      
      gameState.drones.forEach(drone => {
        // Create a drone with a distinct shape (cylindrical body with rotors)
        const bodyGeometry = new THREE.CylinderGeometry(0.5, 1, 2, detail === 'low' ? 6 : 8);
        const rotorGeometry = new THREE.BoxGeometry(0.2, 1.5, 0.1);
        
        const bodyMaterial = new THREE.MeshPhongMaterial({ 
          color: droneColors[drone.id],
          shininess: 100,
          emissive: droneColors[drone.id],
          emissiveIntensity: 0.3
        });
        
        const rotorMaterial = new THREE.MeshPhongMaterial({ 
          color: 0xffffff,
          shininess: 50,
          emissive: 0xffffff,
          emissiveIntensity: 0.1
        });
        
        const droneBody = new THREE.Mesh(bodyGeometry, bodyMaterial);
        const rotor1 = new THREE.Mesh(rotorGeometry, rotorMaterial);
        const rotor2 = new THREE.Mesh(rotorGeometry, rotorMaterial);
        const rotor3 = new THREE.Mesh(rotorGeometry, rotorMaterial);
        const rotor4 = new THREE.Mesh(rotorGeometry, rotorMaterial);
        
        // Position rotors
        rotor1.position.set(1, 0, 0);
        rotor2.position.set(-1, 0, 0);
        rotor3.position.set(0, 0, 1);
        rotor4.position.set(0, 0, -1);
        
        // Create drone group
        const droneGroup = new THREE.Group();
        droneGroup.add(droneBody);
        droneGroup.add(rotor1);
        droneGroup.add(rotor2);
        droneGroup.add(rotor3);
        droneGroup.add(rotor4);
        
        // Position drone randomly in space
        droneGroup.position.set(
          (Math.random() - 0.5) * 100,
          (Math.random() - 0.5) * 100,
          (Math.random() - 0.5) * 100
        );
        
        scene.add(droneGroup);
        drone.object = droneGroup;
        drone.targetAsteroid = null;
        drone.rotors = [rotor1, rotor2, rotor3, rotor4];
      });
    }
    
    // Create player ship
    function createPlayerShip() {
      const shipGeometry = new THREE.ConeGeometry(2, 5, 4);
      const shipMaterial = new THREE.MeshPhongMaterial({ 
        color: 0x4fc3f7,
        shininess: 100,
        emissive: 0x073642
      });
      gameState.player = new THREE.Mesh(shipGeometry, shipMaterial);
      gameState.player.rotation.x = Math.PI;
      gameState.player.position.set(0, 0, 30); // Start near the planet
      scene.add(gameState.player);
      
      // Add directional light
      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5, 5, 5);
      scene.add(light);
      
      // Add ambient light
      const ambientLight = new THREE.AmbientLight(0x444444);
      scene.add(ambientLight);
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Keyboard controls
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);
      
      // Mouse controls
      document.addEventListener('mousedown', handleMouseDown);
      document.addEventListener('mouseup', handleMouseUp);
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('contextmenu', handleContextMenu);
      
      // Pointer lock for mouse look
      document.getElementById('gameCanvas').addEventListener('click', () => {
        document.getElementById('gameCanvas').requestPointerLock();
      });
      
      // Pointer lock change events
      document.addEventListener('pointerlockchange', handlePointerLockChange);
    }
    
    // Handle pointer lock change
    function handlePointerLockChange() {
      isPointerLocked = document.pointerLockElement === document.getElementById('gameCanvas');
    }
    
    // Handle keyboard input
    function handleKeyDown(e) {
      switch(e.key.toLowerCase()) {
        case 'w':
          gameState.movement.forward = true;
          break;
        case 's':
          gameState.movement.backward = true;
          break;
        case 'a':
          gameState.movement.strafeLeft = true;
          break;
        case 'd':
          gameState.movement.strafeRight = true;
          break;
        case 'q':
          gameState.movement.tiltLeft = true;
          break;
        case 'e':
          gameState.movement.tiltRight = true;
          break;
        case 'z':
          gameState.movement.barrelRollLeft = true;
          break;
        case 'x':
          gameState.movement.barrelRollRight = true;
          break;
        case ' ':
          startMining();
          break;
        case 'm':
          toggleMapConsole();
          break;
      }
    }
    
    function handleKeyUp(e) {
      switch(e.key.toLowerCase()) {
        case 'w':
          gameState.movement.forward = false;
          break;
        case 's':
          gameState.movement.backward = false;
          break;
        case 'a':
          gameState.movement.strafeLeft = false;
          break;
        case 'd':
          gameState.movement.strafeRight = false;
          break;
        case 'q':
          gameState.movement.tiltLeft = false;
          break;
        case 'e':
          gameState.movement.tiltRight = false;
          break;
        case 'z':
          gameState.movement.barrelRollLeft = false;
          break;
        case 'x':
          gameState.movement.barrelRollRight = false;
          break;
      }
    }
    
    // Handle mouse input
    function handleMouseDown(e) {
      if (e.button === 0) { // Left click
        startMining();
      }
    }
    
    function handleMouseUp(e) {
      // Handle mouse up events if needed
    }
    
    // Handle right-click context menu
    function handleContextMenu(e) {
      e.preventDefault();
      toggleAutoMining();
    }
    
    // Toggle auto mining for all drones and player
    function toggleAutoMining() {
      gameState.autoMining = !gameState.autoMining;
      
      if (gameState.autoMining) {
        activateAllDrones();
        addChatMessage("system", "[SYSTEM] Auto mining activated for all drones and player");
      } else {
        stopAllDrones();
        addChatMessage("system", "[SYSTEM] Auto mining deactivated");
      }
    }
    
    // Mouse controls with proper Euler angles
    function handleMouseMove(e) {
      // Handle mouse look if pointer lock is active
      if (isPointerLocked) {
        const movementX = e.movementX || 0;
        const movementY = e.movementY || 0;
        
        // Apply mouse sensitivity and invert Y if needed
        const sensitivity = gameState.settings.mouseSensitivity;
        const invertY = gameState.settings.invertYAxis ? -1 : 1;
        
        // Use Euler angles for proper rotation
        euler.setFromQuaternion(camera.quaternion);
        
        euler.y -= movementX * 0.002 * sensitivity;
        euler.x -= movementY * 0.002 * sensitivity * invertY;
        
        // Limit vertical rotation
        euler.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, euler.x));
        
        camera.quaternion.setFromEuler(euler);
        
        // Sync ship rotation with camera
        gameState.player.rotation.copy(camera.rotation);
      }
    }
    
    // Setup console dragging
    function setupConsoleDragging() {
      const consoleHeaders = document.querySelectorAll('.console-header');
      
      consoleHeaders.forEach(header => {
        header.addEventListener('mousedown', startDrag);
      });
      
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', stopDrag);

      document.querySelectorAll('.console-close').forEach(btn => {
        btn.onclick = () => {
          const win = btn.closest('.console-window');
          win.style.display = 'none';
          
          // Stop map updates when map console is closed
          if (win.id === 'mapConsole' && mapUpdateInterval) {
            clearInterval(mapUpdateInterval);
            mapUpdateInterval = null;
          }
        };
      });
    }
    
    function startDrag(e) {
      const consoleWindow = e.target.closest('.console-window');
      dragData = {
        isDragging: true,
        element: consoleWindow,
        offsetX: e.clientX - consoleWindow.offsetLeft,
        offsetY: e.clientY - consoleWindow.offsetTop
      };
    }
    
    function drag(e) {
      if (!dragData.isDragging) return;
      
      dragData.element.style.left = (e.clientX - dragData.offsetX) + 'px';
      dragData.element.style.top = (e.clientY - dragData.offsetY) + 'px';
    }
    
    function stopDrag() {
      dragData.isDragging = false;
    }
    
    // Console management
    function toggleConsole(consoleId) {
      const console = document.getElementById(consoleId);
      if (console.style.display === 'none' || !console.style.display) {
        console.style.display = 'block';
        activeConsoles[consoleId] = true;
        
        // Bring to front
        console.style.zIndex = 20;
        Object.keys(activeConsoles).forEach(id => {
          if (id !== consoleId) {
            document.getElementById(id).style.zIndex = 10;
          }
        });
      } else {
        console.style.display = 'none';
        delete activeConsoles[consoleId];
        
        // Stop map updates when map console is closed
        if (consoleId === 'mapConsole' && mapUpdateInterval) {
          clearInterval(mapUpdateInterval);
          mapUpdateInterval = null;
        }
      }
    }
    
    function toggleModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal.style.display === 'none' || !modal.style.display) {
        modal.style.display = 'flex';
      } else {
        modal.style.display = 'none';
      }
    }
    
    // Enhanced Chat Functions
    function switchChatTab(tab) {
      gameState.currentChatTab = tab;
      
      // Update tab UI
      document.querySelectorAll('.chat-tab').forEach(tabElement => {
        tabElement.classList.remove('active');
      });
      document.querySelector(`.chat-tab[data-tab="${tab}"]`).classList.add('active');
      
      // Update chat placeholder and clear messages
      const chatInput = document.getElementById('chatInput');
      const chatMessages = document.getElementById('chatMessages');
      
      // Clear existing messages
      chatMessages.innerHTML = '';
      
      switch(tab) {
        case 'quest':
          chatInput.placeholder = "Ask Captain Taylor...";
          captainTaylor.showSuggestedResponses();
          addChatMessage("quest", "[CAPTAIN TAYLOR] Welcome to the Quest tab. Type 'quests' to see available missions.");
          break;
        case 'sector':
          chatInput.placeholder = "Message Sector Chat...";
          addChatMessage("sector", "[SECTOR] Welcome to Sector Alpha chat. Connect with nearby miners.");
          addChatMessage("sector", "[MINER_JAX] Anyone found any platinum asteroids in Sector Gamma?");
          addChatMessage("sector", "[TRADER_KIRA] Selling 200 Iron for 3.5 WebXOS, DM me");
          break;
        case 'universe':
          chatInput.placeholder = "Message Universe Chat...";
          addChatMessage("universe", "[UNIVERSE] Welcome to Galaxy-wide chat. Connect with all pilots.");
          addChatMessage("universe", "[EXPLORER_LEX] The quantum field near Nebula X is rich today!");
          addChatMessage("universe", "[CAPTAIN_REX] New players: Remember to upgrade your drones!");
          addChatMessage("universe", "[MINER_ZARA] Dark Matter spawn rate seems increased today");
          break;
        case 'auction':
          chatInput.placeholder = "Auction House Chat...";
          addChatMessage("auction", "[AUCTION] Welcome to the Auction House. Buy and sell resources.");
          addChatMessage("auction", "[AUCTION_BOT] NFT Engine v3 sold for 22.5 WebXOS");
          addChatMessage("auction", "[BIDDER_TROY] 15 WebXOS for Quantum Bundle!");
          addChatMessage("auction", "[SELLER_NOVA] Listing 500 Silicon - starting bid 8 WebXOS");
          break;
      }
    }
    
    function handleChatInput(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    }
    
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (message) {
        // Add player message to chat with appropriate color
        addChatMessage("player", `[PLAYER] ${message}`);
        input.value = '';
        
        // Handle commands based on current tab
        switch(gameState.currentChatTab) {
          case 'quest':
            captainTaylor.handleMessage(message);
            break;
          case 'sector':
            // Simulate sector chat responses
            setTimeout(() => {
              const sectorResponses = [
                "[MINER_JAX] Anyone found any platinum asteroids in Sector Gamma?",
                "[TRADER_KIRA] Selling 200 Iron for 3.5 WebXOS, DM me",
                "[EXPLORER_LEX] The quantum field near Nebula X is rich today!",
                "[CAPTAIN_REX] New players: Remember to upgrade your drones!",
                "[MINER_ZARA] Dark Matter spawn rate seems increased today"
              ];
              const randomResponse = sectorResponses[Math.floor(Math.random() * sectorResponses.length)];
              addChatMessage("sector", randomResponse);
            }, 1000);
            break;
          case 'universe':
            // Simulate universe chat responses
            setTimeout(() => {
              const universeResponses = [
                "[EXPLORER_LEX] The quantum field near Nebula X is rich today!",
                "[CAPTAIN_REX] New players: Remember to upgrade your drones!",
                "[MINER_ZARA] Dark Matter spawn rate seems increased today",
                "[PILOT_NOVA] Just completed the 1000 resources quest - 50 WebXOS!",
                "[TRADER_MAX] Buying Dark Matter - 2 WebXOS per unit"
              ];
              const randomResponse = universeResponses[Math.floor(Math.random() * universeResponses.length)];
              addChatMessage("universe", randomResponse);
            }, 1000);
            break;
          case 'auction':
            // Simulate auction chat responses
            setTimeout(() => {
              const auctionResponses = [
                "[AUCTION_BOT] NFT Engine v3 sold for 22.5 WebXOS",
                "[BIDDER_TROY] 15 WebXOS for Quantum Bundle!",
                "[SELLER_NOVA] Listing 500 Silicon - starting bid 8 WebXOS",
                "[AUCTION_BOT] New bid: 18.75 WebXOS for NFT Engine v2",
                "[TRADER_MAX] Buying Dark Matter - 2 WebXOS per unit"
              ];
              const randomResponse = auctionResponses[Math.floor(Math.random() * auctionResponses.length)];
              addChatMessage("auction", randomResponse);
            }, 1000);
            break;
        }
      }
    }
    
    function addChatMessage(type, text) {
      const chatMessages = document.getElementById('chatMessages');
      const message = document.createElement('div');
      message.className = `message ${type}`;
      message.textContent = text;
      chatMessages.appendChild(message);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Create WoW-style splash text
    function createSplashText(text, worldPosition) {
      const splash = document.createElement('div');
      splash.className = 'splash-text';
      splash.textContent = text;
      
      // Convert world position to screen position
      const vector = worldPosition.clone();
      vector.project(camera);
      
      const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
      const y = -(vector.y * 0.5 - 0.5) * window.innerHeight;
      
      splash.style.left = `${x}px`;
      splash.style.top = `${y}px`;
      
      document.querySelector('.game-canvas-container').appendChild(splash);
      
      // Remove after animation completes
      setTimeout(() => {
        if (splash.parentNode) {
          splash.parentNode.removeChild(splash);
        }
      }, 2000);
    }
    
    // Start mining process with 2-second progress bar
    function startMining() {
      if (gameState.isMining) return;
      
      // Find closest asteroid
      let closestAsteroid = null;
      let closestDistance = Infinity;
      
      gameState.asteroids.forEach(asteroid => {
        if (asteroid.userData.mined) return;
        
        const distance = camera.position.distanceTo(asteroid.position);
        if (distance < 20 && distance < closestDistance) {
          closestDistance = distance;
          closestAsteroid = asteroid;
        }
      });
      
      if (closestAsteroid) {
        gameState.isMining = true;
        gameState.miningTarget = closestAsteroid;
        gameState.miningProgress = 0;
        
        // Show mining overlay
        document.getElementById('miningResource').textContent = closestAsteroid.userData.resourceType;
        document.getElementById('miningOverlay').classList.add('active');
        
        // Clear any existing interval
        if (gameState.miningInterval) {
          clearInterval(gameState.miningInterval);
        }
        
        // Start mining interval (2 seconds total)
        gameState.miningInterval = setInterval(() => {
          gameState.miningProgress += 5; // 100% in 2 seconds (20 intervals of 100ms)
          document.getElementById('miningProgress').style.width = `${gameState.miningProgress}%`;
          
          if (gameState.miningProgress >= 100) {
            clearInterval(gameState.miningInterval);
            finishMining();
          }
        }, 100);
      } else {
        addChatMessage("system", "[SYSTEM] No asteroids in mining range");
      }
    }
    
    // UPDATED: Finish mining and collect resource - handles 'none' resource type
    function finishMining() {
      gameState.isMining = false;
      
      const resourceType = gameState.miningTarget.userData.resourceType;
      
      if (resourceType === 'none') {
        // No resources from this asteroid
        addChatMessage("system", `[MINING] Asteroid contained no valuable resources`);
        
        // Still create splash text for visual feedback
        createSplashText("EMPTY!", gameState.miningTarget.position);
      } else {
        const resourceValue = calculateMiningYield(resourceType);
        
        // Update resource count
        gameState.resources[resourceType].ship += resourceValue;
        gameState.resources[resourceType].mined += resourceValue;
        
        // Award WebXOS and XP for mining
        gameState.webxos += 0.1;
        gameState.xp += 10;
        
        // Create WoW-style splash text
        createSplashText(`${resourceValue} ${resourceType.toUpperCase()}!`, gameState.miningTarget.position);
        
        addChatMessage("system", `[MINING] Mined ${resourceValue} units of ${resourceType} (+0.10 WebXOS, +10 XP)`);
      }
      
      // Mark asteroid as mined and hide it (regardless of resource type)
      gameState.miningTarget.userData.mined = true;
      gameState.miningTarget.visible = false;
      
      // Set respawn timer for asteroid (30-60 seconds)
      const respawnTime = 30000 + Math.random() * 30000; // 30-60 seconds
      gameState.miningTarget.userData.respawnTimer = setTimeout(() => {
        gameState.miningTarget.visible = true;
        gameState.miningTarget.userData.mined = false;
        gameState.miningTarget.userData.resourceType = getRandomResourceType();
      }, respawnTime);
      
      // Increment asteroids mined counter
      gameState.asteroidsMined++;
      
      // Check for level up
      checkLevelUp();
      
      // Update quest progress
      captainTaylor.updateQuestProgress();
      
      // Update missing resources display
      updateMissingResources();
      
      // Hide overlay after delay
      setTimeout(() => {
        document.getElementById('miningOverlay').classList.remove('active');
      }, 2000);
      
      // Update UI
      updateUI();
    }
    
    // Calculate mining yield based on resource type and player level
    function calculateMiningYield(resourceType) {
      const baseYields = {
        iron: 10,
        silicon: 8,
        gold: 5,
        platinum: 4,
        uranium: 2,
        darkMatter: 1
      };
      
      const levelBonus = 1 + (gameState.level * 0.05);
      return Math.floor(baseYields[resourceType] * levelBonus);
    }
    
    // Check if player should level up
    function checkLevelUp() {
      const xpNeeded = gameState.level * 1000;
      if (gameState.xp >= xpNeeded) {
        gameState.level++;
        gameState.xp = 0;
        gameState.speed = 1.0 + (gameState.level * 0.05);
        
        addChatMessage("system", `[SYSTEM] Level up! You are now level ${gameState.level}`);
        addChatMessage("system", `[SYSTEM] Speed increased to ${gameState.speed.toFixed(2)}x`);
        
        // Update quest progress for level-based quests
        captainTaylor.updateQuestProgress();
      }
    }
    
    // Update missing resources display
    function updateMissingResources() {
      const missingResources = document.getElementById('missingResources');
      const requirements = {
        iron: 100,
        silicon: 75,
        gold: 50,
        platinum: 25,
        uranium: 10,
        darkMatter: 5
      };
      
      let missing = [];
      Object.keys(requirements).forEach(resource => {
        const total = gameState.resources[resource].ship + gameState.resources[resource].stash;
        if (total < requirements[resource]) {
          missing.push(`${requirements[resource] - total} ${resource}`);
        }
      });
      
      if (missing.length > 0) {
        missingResources.innerHTML = `Missing: ${missing.join(', ')}`;
        missingResources.style.display = 'block';
      } else {
        missingResources.style.display = 'none';
      }
    }
    
    // UPDATED: Update statistics display with colored resource dots
    function updateStatisticsDisplay() {
      const statsList = document.getElementById('statsList');
      if (!statsList) return;
      
      let html = '';
      
      // Player Stats
      html += '<div class="stat-header">PLAYER</div>';
      const xpNeeded = gameState.level * 1000;
      html += `<div class="stat-row"><span>Level:</span><span>${gameState.level} | XP: ${gameState.xp}/${xpNeeded}</span></div>`;
      html += `<div class="stat-row"><span>Speed:</span><span>${gameState.speed.toFixed(2)}x</span></div>`;
      html += `<div class="stat-row"><span>WebXOS:</span><span>${gameState.webxos.toFixed(2)}</span></div>`;
      
      // Drone Levels
      html += '<div class="stat-header">DRONES</div>';
      html += `<div class="stat-row"><span>Red:</span><span>Lv${gameState.drones[0].level}</span></div>`;
      html += `<div class="stat-row"><span>Blue:</span><span>Lv${gameState.drones[1].level}</span></div>`;
      html += `<div class="stat-row"><span>Green:</span><span>Lv${gameState.drones[2].level}</span></div>`;
      
      // Current Resources (Ship + Stash) with colored dots
      html += '<div class="stat-header">RESOURCES</div>';
      const resourceOrder = ['iron', 'silicon', 'gold', 'platinum', 'uranium', 'darkMatter'];
      resourceOrder.forEach(resource => {
        const total = gameState.resources[resource].ship + gameState.resources[resource].stash;
        const color = resourceColors[resource];
        html += `
          <div class="stat-row">
            <span>
              <span class="resource-dot" style="background-color: ${color};"></span>
              ${resource.charAt(0).toUpperCase() + resource.slice(1)}:
            </span>
            <span>${total} (${gameState.resources[resource].ship}+${gameState.resources[resource].stash})</span>
          </div>
        `;
      });
      
      // Mined Totals with colored dots
      html += '<div class="stat-header">MINED TOTAL</div>';
      resourceOrder.forEach(resource => {
        const color = resourceColors[resource];
        html += `
          <div class="stat-row">
            <span>
              <span class="resource-dot" style="background-color: ${color};"></span>
              ${resource.charAt(0).toUpperCase() + resource.slice(1)}:
            </span>
            <span>${gameState.resources[resource].mined}</span>
          </div>
        `;
      });
      
      statsList.innerHTML = html;
    }
    
    // Deposit all resources to planet stash
    function depositAllResources() {
      Object.keys(gameState.resources).forEach(resource => {
        gameState.resources[resource].stash += gameState.resources[resource].ship;
        gameState.resources[resource].ship = 0;
      });
      
      addChatMessage("system", "[SYSTEM] All resources deposited to planet stash");
      updateUI();
      updateMissingResources();
    }
    
    // Withdraw all resources from planet stash
    function withdrawAllResources() {
      Object.keys(gameState.resources).forEach(resource => {
        gameState.resources[resource].ship += gameState.resources[resource].stash;
        gameState.resources[resource].stash = 0;
      });
      
      addChatMessage("system", "[SYSTEM] All resources withdrawn from planet stash");
      updateUI();
      updateMissingResources();
    }
    
    // Drone controls - Auto mine all drones
    function activateAllDrones() {
      const availableAsteroids = gameState.asteroids.filter(a => !a.userData.mined && !gameState.drones.some(d => d.targetAsteroid === a));
      gameState.drones.forEach(drone => {
        if (drone.status === 'idle' && availableAsteroids.length > 0) {
          drone.status = 'mining';
          drone.progress = 0;
          const idx = Math.floor(Math.random() * availableAsteroids.length);
          drone.targetAsteroid = availableAsteroids[idx];
          availableAsteroids.splice(idx, 1);
        }
      });
      addChatMessage('system', '[SYSTEM] All drones activated for mining');
      captainTaylor.updateQuestProgress();
      updateUI();
    }
    
    // Stop all drones
    function stopAllDrones() {
      gameState.drones.forEach(drone => {
        drone.status = 'idle';
        drone.progress = 0;
        drone.targetAsteroid = null;
      });
      
      addChatMessage("system", "[SYSTEM] All drones stopped");
      updateUI();
    }
    
    // UPDATED: Craft NFT Engine with all resource requirements
    function craftNFTEngine() {
      const requirements = {
        iron: 100,
        silicon: 75,
        gold: 50,
        platinum: 25,
        uranium: 10,
        darkMatter: 5
      };
      
      // Check if we have enough resources
      let canCraft = true;
      Object.keys(requirements).forEach(resource => {
        const total = gameState.resources[resource].ship + gameState.resources[resource].stash;
        if (total < requirements[resource]) {
          canCraft = false;
          addChatMessage("system", `[CRAFTING] Not enough ${resource} (need ${requirements[resource]}, have ${total})`);
        }
      });
      
      if (canCraft) {
        // Deduct resources from stash first, then from ship
        Object.keys(requirements).forEach(resource => {
          let remaining = requirements[resource];
          
          // Take from stash first
          if (gameState.resources[resource].stash >= remaining) {
            gameState.resources[resource].stash -= remaining;
          } else {
            remaining -= gameState.resources[resource].stash;
            gameState.resources[resource].stash = 0;
            gameState.resources[resource].ship -= remaining;
          }
        });
        
        // Generate random speed boost between 25% and 75%
        const speedBoost = 25 + Math.floor(Math.random() * 51); // 25-75%
        
        // Create NFT Engine
        const nftEngine = {
          id: gameState.nftEngines.length + 1,
          name: `NFT Engine v${gameState.nftEngines.length + 1}`,
          speedBoost: speedBoost,
          perfect: (speedBoost >= 70) // Consider 70+ as "perfect"
        };
        
        // Add to player's NFT Engines
        gameState.nftEngines.push(nftEngine);
        
        // Automatically activate the first engine
        if (gameState.nftEngines.length === 1) {
          activateNFTEngine(nftEngine.id);
        }
        
        addChatMessage("system", `[CRAFTING] NFT Engine crafted! Speed boost: +${speedBoost}%`);
        if (nftEngine.perfect) {
          addChatMessage("system", "[CRAFTING] PERFECT ENGINE! This is a rare high-performance NFT Engine!");
        }
        
        // Update NFT Engines list in UI
        updateNFTEnginesList();
        
        // Update missing resources
        updateMissingResources();
        
        // Update quest progress
        captainTaylor.updateQuestProgress();
        
        updateUI();
      }
    }
    
    // Update NFT Engines list in crafting console
    function updateNFTEnginesList() {
      const nftEnginesList = document.getElementById('nftEnginesList');
      const emptyMessage = document.getElementById('emptyEngineMessage');
      
      if (gameState.nftEngines.length === 0) {
        nftEnginesList.innerHTML = '';
        nftEnginesList.appendChild(emptyMessage);
        emptyMessage.style.display = 'block';
      } else {
        emptyMessage.style.display = 'none';
        nftEnginesList.innerHTML = '';
        
        gameState.nftEngines.forEach(engine => {
          const engineElement = document.createElement('div');
          engineElement.className = `nft-engine ${engine.id === gameState.activeNftEngine ? 'active' : ''}`;
          engineElement.innerHTML = `
            <div class="nft-name">${engine.name} ${engine.perfect ? '⭐' : ''}</div>
            <div class="nft-stats">Speed Boost: +${engine.speedBoost}%</div>
            <button class="btn ${engine.id === gameState.activeNftEngine ? 'btn-success' : ''}" style="width: 100%; margin-top: 5px;" onclick="activateNFTEngine(${engine.id})">
              ${engine.id === gameState.activeNftEngine ? 'Active' : 'Activate'}
            </button>
          `;
          nftEnginesList.appendChild(engineElement);
        });
      }
    }
    
    // Activate an NFT Engine
    function activateNFTEngine(engineId) {
      const engine = gameState.nftEngines.find(e => e.id === engineId);
      if (engine) {
        gameState.activeNftEngine = engineId;
        
        // Apply engine bonus to base speed
        const baseSpeed = 1.0 + (gameState.level * 0.05);
        gameState.speed = baseSpeed + (baseSpeed * (engine.speedBoost / 100));
        
        addChatMessage("system", `[SYSTEM] ${engine.name} activated! Speed: +${engine.speedBoost}%`);
        
        // Update NFT Engines list
        updateNFTEnginesList();
        
        // Update UI
        updateUI();
      }
    }
    
    // Sell the currently active NFT Engine
    function sellNFTEngine() {
      if (!gameState.activeNftEngine) {
        addChatMessage("system", "[AUCTION] No active NFT Engine to sell");
        return;
      }
      
      const engineIndex = gameState.nftEngines.findIndex(e => e.id === gameState.activeNftEngine);
      if (engineIndex !== -1) {
        const engine = gameState.nftEngines[engineIndex];
        
        // Calculate value based on stats
        let value = 10 + (engine.speedBoost / 5);
        if (engine.perfect) value *= 2; // Double value for perfect engines
        
        // Add WebXOS
        gameState.webxos += value;
        
        // Remove engine
        gameState.nftEngines.splice(engineIndex, 1);
        gameState.activeNftEngine = null;
        
        // Reset speed if no active engine
        gameState.speed = 1.0 + (gameState.level * 0.05);
        
        addChatMessage("system", `[AUCTION] Sold ${engine.name} for ${value.toFixed(2)} WebXOS`);
        
        // Update NFT Engines list
        updateNFTEnginesList();
        
        // Update quest progress
        captainTaylor.updateQuestProgress();
        
        // Update UI
        updateUI();
      }
    }
    
    // Sell resources for WebXOS
    function sellResources() {
      let totalValue = 0;
      
      // Calculate value of all resources in stash
      Object.keys(gameState.resources).forEach(resource => {
        const resourceValue = calculateResourceValue(resource, gameState.resources[resource].stash);
        totalValue += resourceValue;
        gameState.resources[resource].stash = 0;
      });
      
      if (totalValue > 0) {
        gameState.webxos += totalValue;
        addChatMessage("system", `[AUCTION] Sold all resources for ${totalValue.toFixed(2)} WebXOS`);
        
        // Update quest progress
        captainTaylor.updateQuestProgress();
        
        updateUI();
        updateMissingResources();
      } else {
        addChatMessage("system", "[AUCTION] No resources in stash to sell");
      }
    }
    
    // Calculate value of a resource
    function calculateResourceValue(resourceType, amount) {
      const baseValues = {
        iron: 0.01,
        silicon: 0.02,
        gold: 0.05,
        platinum: 0.08,
        uranium: 0.20,
        darkMatter: 1.00
      };
      
      return baseValues[resourceType] * amount;
    }
    
    // Placeholder functions for auction purchases
    function buyNFTEngine(id) {
      addChatMessage("system", "[AUCTION] This is a placeholder. In a real game, this would purchase the NFT Engine.");
    }
    
    function buyResourceBundle(id) {
      addChatMessage("system", "[AUCTION] This is a placeholder. In a real game, this would purchase the Resource Bundle.");
    }
    
    function buyDroneUpgrade() {
      addChatMessage("system", "[AUCTION] This is a placeholder. In a real game, this would purchase the Drone Upgrade.");
    }
    
    // Performance functions
    function changePerformanceMode() {
      const mode = document.getElementById('performanceModeSelect').value;
      gameState.settings.performanceMode = mode;
      
      // Update performance indicator
      document.getElementById('performanceMode').textContent = `Performance: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`;
      
      // Restart game loop with new interval
      startGameLoop();
      
      addChatMessage("system", `[SYSTEM] Performance mode changed to ${mode}`);
    }
    
    function updateAsteroidDetail() {
      const detail = document.getElementById('asteroidDetail').value;
      gameState.settings.asteroidDetail = detail;
      
      // Update all asteroids with new detail level
      const segments = performanceSettings[gameState.settings.performanceMode].asteroidSegments;
      
      gameState.asteroids.forEach(asteroid => {
        scene.remove(asteroid);
        
        const size = asteroid.geometry.parameters.radius;
        const newGeometry = new THREE.SphereGeometry(size, segments, segments);
        asteroid.geometry = newGeometry;
        
        scene.add(asteroid);
      });
      
      addChatMessage("system", `[SYSTEM] Asteroid detail changed to ${detail}`);
    }
    
    // Settings functions
    function saveSettings() {
      // Get values from form
      gameState.settings.mouseSensitivity = document.getElementById('mouseSensitivity').value / 50;
      gameState.settings.invertYAxis = document.getElementById('invertYAxis').checked;
      
      // Update sensitivity display
      document.getElementById('sensitivityValue').textContent = gameState.settings.mouseSensitivity.toFixed(1) + 'x';
      
      toggleModal('settingsModal');
      addChatMessage("system", "[SYSTEM] Settings saved successfully");
    }
    
    // Map functions
    function centerMap() {
      // This would center the map on the player
      addChatMessage("system", "[SYSTEM] Map centered on player position");
    }
    
    // FPS tracking
    function updateFPS() {
      gameState.frameCount++;
      const now = performance.now();
      
      if (now >= gameState.lastFpsUpdate + 1000) {
        gameState.fps = Math.round((gameState.frameCount * 1000) / (now - gameState.lastFpsUpdate));
        gameState.frameCount = 0;
        gameState.lastFpsUpdate = now;
        
        // Update FPS indicator
        const fpsIndicator = document.getElementById('fpsIndicator');
        fpsIndicator.textContent = `FPS: ${gameState.fps}`;
        
        // Color code based on FPS
        fpsIndicator.className = 'fps-indicator';
        if (gameState.fps < 30) {
          fpsIndicator.classList.add('low');
        } else if (gameState.fps < 60) {
          fpsIndicator.classList.add('medium');
        } else {
          fpsIndicator.classList.add('high');
        }
      }
      
      requestAnimationFrame(updateFPS);
    }
    
    // Update UI elements with throttling
    let lastUIUpdate = 0;
    function updateUI() {
      // Throttle UI updates to 16ms (approx 60fps)
      const now = Date.now();
      if (now - lastUIUpdate < 16) return;
      lastUIUpdate = now;
      
      // Update stats in header
      document.getElementById('speedStat').textContent = gameState.speed.toFixed(1) + 'x';
      document.getElementById('webxosStat').textContent = gameState.webxos.toFixed(2);
      document.getElementById('levelStat').textContent = gameState.level;
      
      // Update level progress bar
      const xpNeeded = gameState.level * 1000;
      const xpPercent = (gameState.xp / xpNeeded) * 100;
      document.getElementById('levelProgress').style.width = `${xpPercent}%`;
      
      // Update drone displays
      gameState.drones.forEach(drone => {
        document.getElementById(`${drone.id}DroneStatus`).textContent = drone.status.charAt(0).toUpperCase() + drone.status.slice(1);
        document.getElementById(`${drone.id}DroneProgress`).style.width = `${drone.progress}%`;
      });
      
      // Update statistics display with new layout
      updateStatisticsDisplay();
      
      // Update crosshair based on mining range
      const crosshair = document.getElementById('crosshair');
      let inRange = false;
      
      gameState.asteroids.forEach(asteroid => {
        if (!asteroid.userData.mined) {
          const distance = camera.position.distanceTo(asteroid.position);
          if (distance < 20) {
            inRange = true;
          }
        }
      });
      
      if (inRange) {
        crosshair.classList.add('in-range');
      } else {
        crosshair.classList.remove('in-range');
      }
      
      // Update planet distance
      const planetDistance = camera.position.distanceTo(gameState.homePlanet.position);
      document.getElementById('planetIndicator').textContent = `Distance to Planet: ${Math.round(planetDistance)}`;
    }
    
    // UPDATED: Game loop for updates - handles 'none' resource for drones
    function gameLoop() {
      // Update drone states
      gameState.drones.forEach(drone => {
        if (drone.status === 'mining') {
          // Move drone towards target asteroid
          if (drone.targetAsteroid && !drone.targetAsteroid.userData.mined) {
            const direction = new THREE.Vector3();
            direction.subVectors(drone.targetAsteroid.position, drone.object.position).normalize();
            drone.object.position.add(direction.multiplyScalar(drone.speed));
            
            // Rotate drone to face movement direction
            drone.object.lookAt(drone.targetAsteroid.position);
            
            // Animate rotors
            if (drone.rotors) {
              drone.rotors.forEach(rotor => {
                rotor.rotation.z += 0.2;
              });
            }
          } else {
            // Find a new target asteroid
            let targetAsteroid = null;
            let closestDistance = Infinity;
            
            gameState.asteroids.forEach(asteroid => {
              if (!asteroid.userData.mined) {
                const distance = drone.object.position.distanceTo(asteroid.position);
                if (distance < closestDistance) {
                  closestDistance = distance;
                  targetAsteroid = asteroid;
                }
              }
            });
            
            drone.targetAsteroid = targetAsteroid;
          }
          
          drone.progress += 1;
          if (drone.progress >= 100) {
            drone.status = 'returning';
            drone.progress = 0;
            
            // Only add resources if the asteroid wasn't empty
            if (drone.targetAsteroid.userData.resourceType !== 'none') {
              const resourceType = drone.targetAsteroid.userData.resourceType;
              const resourceValue = calculateMiningYield(resourceType) * 5; // Drones get 5x yield
              gameState.resources[resourceType].ship += resourceValue;
              gameState.resources[resourceType].mined += resourceValue;
              
              // Award WebXOS and XP for drone mining
              gameState.webxos += 0.05;
              gameState.xp += 5;
              
              addChatMessage("system", `[DRONE] ${drone.id.charAt(0).toUpperCase() + drone.id.slice(1)} drone delivered ${resourceValue} ${resourceType} (+0.05 WebXOS, +5 XP)`);
            } else {
              addChatMessage("system", `[DRONE] ${drone.id.charAt(0).toUpperCase() + drone.id.slice(1)} drone found an empty asteroid`);
            }
            
            // Check for level up
            checkLevelUp();
            
            // Update quest progress
            captainTaylor.updateQuestProgress();
            
            updateUI();
            updateMissingResources();
          }
        } else if (drone.status === 'returning') {
          // Move drone back to player
          const direction = new THREE.Vector3();
          direction.subVectors(camera.position, drone.object.position).normalize();
          drone.object.position.add(direction.multiplyScalar(drone.speed * 1.5)); // Faster return speed
          
          // Rotate drone to face movement direction
          drone.object.lookAt(camera.position);
          
          // Animate rotors
          if (drone.rotors) {
            drone.rotors.forEach(rotor => {
              rotor.rotation.z += 0.2;
            });
          }
          
          drone.progress += 2;
          if (drone.progress >= 100) {
            drone.status = 'mining';
            drone.progress = 0;
          }
        } else if (drone.status === 'idle') {
          // Follow the player when idle
          const direction = new THREE.Vector3();
          direction.subVectors(camera.position, drone.object.position).normalize();
          if (camera.position.distanceTo(drone.object.position) > 10) {
            drone.object.position.add(direction.multiplyScalar(drone.speed * 0.5)); // Slower follow speed
          }
        }
      });
      
      // Update quest progress
      captainTaylor.updateQuestProgress();
      
      // Respawn asteroids if needed
      if (gameState.asteroids.filter(a => !a.userData.mined).length < 40) {
        // Respawn 1-2 asteroids
        const respawnCount = 1 + Math.floor(Math.random() * 2);
        for (let i = 0; i < respawnCount; i++) {
          const asteroid = gameState.asteroids.find(a => a.userData.mined);
          if (asteroid) {
            // Reset asteroid
            asteroid.visible = true;
            asteroid.userData.mined = false;
            asteroid.userData.resourceType = getRandomResourceType();
            
            // Reposition asteroid
            let position;
            do {
              position = new THREE.Vector3(
                (Math.random() - 0.5) * 400,
                (Math.random() - 0.5) * 400,
                (Math.random() - 0.5) * 400
              );
            } while (position.length() < 50); // Keep asteroids away from the planet
            
            asteroid.position.copy(position);
          }
        }
      }
    }
    
    // Animation loop with movement controls and 30 FPS throttle for low mode
    function animate(currentTime) {
      requestAnimationFrame(animate);
      
      // 30 FPS cap for low mode
      if (gameState.settings.performanceMode === 'low') {
        if (currentTime - gameState.lastFrameTime < 33) return;
        gameState.lastFrameTime = currentTime;
      }
      
      // Movement based on keys
      const moveSpeed = 0.5 * gameState.speed;
      const strafeSpeed = 0.3 * gameState.speed;
      const rollSpeed = 0.05 * gameState.speed;
      
      // Get camera's forward and right vectors
      const forward = new THREE.Vector3();
      const right = new THREE.Vector3();
      camera.getWorldDirection(forward);
      right.crossVectors(forward, camera.up).normalize();
      
      // Handle forward/backward movement (W/S keys)
      if (gameState.movement.forward) {
        camera.position.add(forward.clone().multiplyScalar(moveSpeed));
      }
      if (gameState.movement.backward) {
        camera.position.add(forward.clone().multiplyScalar(-moveSpeed));
      }
      
      // Handle strafing (A/D keys)
      if (gameState.movement.strafeLeft) {
        camera.position.add(right.clone().multiplyScalar(-strafeSpeed));
      }
      if (gameState.movement.strafeRight) {
        camera.position.add(right.clone().multiplyScalar(strafeSpeed));
      }
      
      // Handle tilting/rolling (Q/E keys)
      if (gameState.movement.tiltLeft) {
        camera.rotateZ(rollSpeed);
        gameState.player.rotateZ(rollSpeed);
      }
      if (gameState.movement.tiltRight) {
        camera.rotateZ(-rollSpeed);
        gameState.player.rotateZ(-rollSpeed);
      }
      
      // Handle barrel rolls (Z/X keys) - faster rotation
      if (gameState.movement.barrelRollLeft) {
        camera.rotateOnWorldAxis(forward, rollSpeed * 3);
        gameState.player.rotateOnWorldAxis(forward, rollSpeed * 3);
      }
      if (gameState.movement.barrelRollRight) {
        camera.rotateOnWorldAxis(forward, -rollSpeed * 3);
        gameState.player.rotateOnWorldAxis(forward, -rollSpeed * 3);
      }
      
      // Track distance traveled
      if (gameState.previousPosition) {
        const distance = camera.position.distanceTo(gameState.previousPosition);
        gameState.totalDistanceTraveled += distance;
        gameState.previousPosition = camera.position.clone();
      }
      
      // Rotate asteroids
      gameState.asteroids.forEach(asteroid => {
        if (!asteroid.userData.mined) {
          asteroid.rotation.x += asteroid.userData.rotationSpeed.x;
          asteroid.rotation.y += asteroid.userData.rotationSpeed.y;
          asteroid.rotation.z += asteroid.userData.rotationSpeed.z;
        }
      });
      
      // Rotate planet
      gameState.homePlanet.rotation.y += 0.001;
      
      // Slowly rotate stars for ambient effect
      stars.rotation.x += 0.0001;
      stars.rotation.y += 0.0001;
      
      // Update player position based on camera
      gameState.player.position.copy(camera.position);
      
      // Render the scene
      renderer.render(scene, camera);
      
      // Update UI (throttled internally)
      updateUI();
    }
    
    // Handle window resize
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    // Initialize the game when the page loads
    window.onload = init;
  </script>
</body>
</html>
