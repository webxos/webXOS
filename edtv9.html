<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>edTV: CHANNEL 9 - MEDICAL AR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0ff;overflow:hidden;height:100vh;user-select:none}
    #app{position:relative;width:100%;height:100vh}
    
    /* Light blue neon aesthetic */
    .grid{position:absolute;inset:0;background:
         linear-gradient(rgba(0,255,255,0.05)1px,transparent 1px),
         linear-gradient(90deg,rgba(0,255,255,0.05)1px,transparent 1px);
         background-size:22px 22px;opacity:0.4}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,40,60,0.06)50%);
         background-size:100% 4px;pointer-events:none;animation:s 10s linear infinite}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    
    /* Top banner - clean hierarchy */
    .top{position:absolute;top:0;left:0;width:100%;z-index:100;background:rgba(0,10,30,0.7);border-bottom:1px solid #0ff}
    .logo{font-size:12px;padding:8px 12px;text-align:center;color:#0ff;text-shadow:0 0 12px #0ff;letter-spacing:2px}
    .btns{display:flex;gap:12px;justify-content:center;padding:6px;background:rgba(0,20,40,0.6)}
    .btn{background:transparent;border:1px solid #0ff;color:#0ff;padding:6px 11px;font-size:9px;
         cursor:pointer;box-shadow:0 0 10px #0ff;transition:0.2s}
    .btn:active{background:#0ff;color:#000;box-shadow:0 0 20px #0ff}
    
    /* Console just below top */
    .console{position:absolute;top:78px;left:8px;right:8px;font-size:7px;color:#0ff;
             background:rgba(0,15,40,0.8);padding:8px;border:1px solid #0ff;
             max-height:110px;overflow-y:auto;z-index:90;backdrop-filter:blur(2px)}
    
    /* Bottom 3D hero + PiP button */
    .bottom3d{position:absolute;bottom:0;left:0;width:100%;height:50%;background:rgba(0,0,0,0.7);z-index:10}
    #hero3d{width:100%;height:100%}
    .pipbtn{position:absolute;bottom:10px;right:10px;z-index:20}
    
    video, #arCanvas{display:block;position:absolute;top:0;left:0;width:100%;height:100%}
    #arCanvas{mix-blend-mode:screen;pointer-events:none;z-index:5}
</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<div id="app">
    <div class="grid"></div><div class="crt"></div>
    
    <!-- Top Banner -->
    <div class="top">
        <div class="logo">CHANNEL 9 - MEDICAL AR</div>
        <div class="btns">
            <button class="btn" id="start">START AR</button>
            <button class="btn" id="pip">PiP 3D</button>
            <button class="btn" id="export">EXPORT JSON</button>
        </div>
    </div>
    
    <!-- Console Log -->
    <div class="console" id="log">System ready. Tap START AR</div>
    
    <!-- Full AR View -->
    <video id="video" autoplay playsinline muted></video>
    <canvas id="arCanvas"></canvas>
    
    <!-- Bottom 3D Hero View -->
    <div class="bottom3d">
        <canvas id="hero3d"></canvas>
        <button class="btn pipbtn" id="pipToggle">â—± PiP ON</button>
    </div>
</div>

<script type="module">
import {FaceMesh} from "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js";
import {Camera} from "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js";
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js";
import {OrbitControls} from "https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/controls/OrbitControls.js";

const log = msg => {
    const l = document.getElementById('log');
    l.innerHTML += '<br>' + msg;
    l.scrollTop = l.scrollHeight;
};

const video = document.getElementById('video');
const arCanvas = document.getElementById('arCanvas');
const heroCanvas = document.getElementById('hero3d');
const ctx = arCanvas.getContext('2d');
arCanvas.width = innerWidth; heroCanvas.height = innerHeight * 0.5;

let landmarks = [];
let heroScene, heroCam, heroRen, heroCtrl, heroWire;
let arScene, arCam, arRen, arWire;

// Init Hero 3D (bottom)
function initHero() {
    heroScene = new THREE.Scene();
    heroCam = new THREE.PerspectiveCamera(60, innerWidth/(innerHeight*0.5), 0.1, 100);
    heroRen = new THREE.WebGLRenderer({canvas: heroCanvas, alpha: true});
    heroRen.setSize(innerWidth, innerHeight*0.5);
    heroRen.setPixelRatio(devicePixelRatio);
    heroCtrl = new OrbitControls(heroCam, heroCanvas);
    heroCtrl.enableDamping = true;
    heroCam.position.z = 6;
    
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(468*3);
    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    const idx = [];
    FaceMesh.FACEMESH_TESSELATION.forEach(p=>idx.push(p[0],p[1]));
    geo.setIndex(idx);
    const mat = new THREE.LineBasicMaterial({color:0x00ffff});
    heroWire = new THREE.LineSegments(geo, mat);
    heroScene.add(heroWire);
    heroScene.add(new THREE.AmbientLight(0x00ffff, 1));
    animateHero();
}
function animateHero() {
    requestAnimationFrame(animateHero);
    heroCtrl.update();
    heroRen.render(heroScene, heroCam);
}

// Init AR overlay
function initAR() {
    arScene = new THREE.Scene();
    arCam = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
    arRen = new THREE.WebGLRenderer({canvas: arCanvas, alpha: true});
    arRen.setSize(innerWidth, innerHeight);
    arRen.setPixelRatio(Math.min(devicePixelRatio,2));
    
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(468*3);
    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    const idx = [];
    FaceMesh.FACEMESH_TESSELATION.forEach(p=>idx.push(p[0],p[1]));
    geo.setIndex(idx);
    const mat = new THREE.LineBasicMaterial({color:0x00ffff, transparent:true, opacity:0.9});
    arWire = new THREE.LineSegments(geo, mat);
    arScene.add(arWire);
    animateAR();
}
function animateAR() {
    requestAnimationFrame(animateAR);
    arRen.render(arScene, arCam);
}

function updateBoth(lm) {
    const update = (wire) => {
        const pos = wire.geometry.attributes.position.array;
        lm.forEach((p,i) => {
            pos[i*3]   = (p.x-0.5)*11;
            pos[i*3+1] = -(p.y-0.5)*11;
            pos[i*3+2] = p.z*11;
        });
        wire.geometry.attributes.position.needsUpdate = true;
    };
    update(heroWire);
    update(arWire);
}

// FaceMesh
const faceMesh = new FaceMesh({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.85});
faceMesh.onResults(r => {
    ctx.clearRect(0,0,arCanvas.width,arCanvas.height);
    if (r.multiFaceLandmarks?.[0]) {
        landmarks = r.multiFaceLandmarks[0].map(p=>({x:p.x,y:p.y,z:p.z}));
        updateBoth(r.multiFaceLandmarks[0]);
    }
});

// Start AR
document.getElementById('start').onclick = async () => {
    try {
        const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
        video.srcObject = s;
        video.onloadedmetadata = () => {
            video.play();
            new Camera(video, {onFrame:()=>faceMesh.send({image:video})}).start();
            log('Medical AR activated');
        };
    } catch(e) { log('Permission denied: ' + e.message); }
};

// PiP Toggle
document.getElementById('pipToggle').onclick =
document.getElementById('pip').onclick = () => {
    document.querySelector('.bottom3d').classList.toggle('hidden');
    log('PiP 3D ' + (document.querySelector('.bottom3d').classList.contains('hidden') ? 'off' : 'on'));
};

// Export
document.getElementById('export').onclick = () => {
    if (!landmarks.length) { log('No scan data'); return; }
    const blob = new Blob([JSON.stringify({
        landmarks,
        topology: FaceMesh.FACEMESH_TESSELATION,
        note: "Medical-grade AR face scan - DICOM/STL ready"
    }, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'medical_ar_scan.json';
    a.click();
    log('Exported medical_ar_scan.json');
};

window.onresize = () => {
    arCanvas.width = innerWidth; arCanvas.height = innerHeight;
    heroRen.setSize(innerWidth, innerHeight*0.5);
    heroCam.aspect = innerWidth/(innerHeight*0.5);
    heroCam.updateProjectionMatrix();
};

initHero();
initAR();
</script>
</body>
</html>
