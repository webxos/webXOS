<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 9 - MEDICAL AR FITTING v2.5</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0ff;overflow:hidden;height:100vh}
    #app{position:relative;width:100%;height:100vh;display:flex;flex-direction:column}
    .grid{position:absolute;inset:0;background:
        linear-gradient(rgba(0,255,255,0.08)1px,transparent 1px),
        linear-gradient(90deg,rgba(0,255,255,0.08)1px,transparent 1px);
        background-size:16px 16px;z-index:-1}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,40,80,0.1)50%);
        background-size:100% 4px;pointer-events:none;animation:scanlines 8s linear infinite}
    @keyframes scanlines{0%{background-position:0 0}100%{background-position:0 100%}}
    .banner{background:rgba(0,20,50,0.95);border-bottom:2px solid #0ff;padding:10px;text-align:center;
        font-size:12px;letter-spacing:1px;text-shadow:0 0 12px #0ff}
    .content{flex:1;display:flex;flex-direction:column;padding:10px;gap:10px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
        padding:10px;background:rgba(0,30,60,0.8);border:1px solid #0ff;box-shadow:0 0 10px rgba(0,255,255,0.4)}
    .btn,.btn-medical,.btn-vr{background:#000;border:1px solid #0ff;color:#0ff;padding:8px 16px;font-size:11px;
        cursor:pointer;box-shadow:0 0 8px #0ff;transition:.2s}
    .btn-medical{border-color:#f00;color:#f00;box-shadow:0 0 8px #f00}
    .btn-vr{border-color:#0f0;color:#0f0;box-shadow:0 0 10px #0f0}
    .btn:hover,.btn-medical:hover,.btn-vr:hover{background:#0ff;color:#000;box-shadow:0 0 20px #0ff}
    .btn-medical:hover{background:#f00}
    .btn-vr:hover{background:#0f0}
    .dropdown{background:#000;border:1px solid #0ff;color:#0ff;padding:8px;font-size:10px;width:220px;box-shadow:0 0 8px rgba(0,255,255,0.5)}
    .terminal{flex:1;background:rgba(0,20,40,0.8);border:1px solid #0ff;padding:10px;font-size:10px;
        overflow-y:auto;max-height:140px;box-shadow:0 0 10px rgba(0,255,255,0.3);user-select:text}
    .ar-view{flex:3;position:relative;border:2px solid #0ff;background:#000;overflow:hidden;box-shadow:0 0 20px rgba(0,255,255,0.6)}
    #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #view3d{position:absolute;inset:0;width:100%;height:100%;z-index:10}
    .medical-indicators{position:absolute;top:10px;left:10px;display:flex;gap:10px;z-index:20;flex-wrap:wrap}
    .indicator{background:rgba(255,0,0,0.7);border:1px solid #f00;color:#fff;padding:5px 10px;
        font-size:9px;box-shadow:0 0 8px #f00;transition:all .4s}
    .indicator.locked{background:rgba(0,255,0,0.8);border-color:#0f0;box-shadow:0 0 15px #0f0}
    .indicator.vr{background:rgba(0,100,255,0.8);border-color:#0ff}
</style>
</head>
<body>
<div id="app">
    <div class="grid"></div><div class="crt"></div>
    <div class="banner">EDTV: CHANNEL 9 - MEDICAL AR FITTING v2.5</div>
    <div class="content">
        <div class="controls">
            <button class="btn-medical" id="start">START CAMERA & SYNC</button>
            <button class="btn-vr" id="enter-vr">ENTER VR/AR MODE</button>
            <button class="btn-medical" id="export">EXPORT 3D JSON</button>
            <select class="dropdown" id="mask-select">
                <option value="surgical">SURGICAL MASK</option>
                <option value="n95">N95 RESPIRATOR</option>
                <option value="full_face">FULL FACE SHIELD</option>
                <option value="goggle_mask">GOGGLE + MASK</option>
                <option value="tactical">TACTICAL RESPIRATOR</option>
            </select>
            <select class="dropdown" id="addon-select">
                <option value="none">NO ADDON</option>
                <option value="comms">COMMS HEADSET</option>
                <option value="filter">FILTER CARTRIDGE</option>
                <option value="visor">VISOR</option>
                <option value="sensor">VITAL SENSORS</option>
            </select>
        </div>
        <div class="terminal" id="log">> MEDICAL AR SYSTEM ONLINE<br>> 2025 PROTOCOL ACTIVE</div>
        <div class="ar-view">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="view3d"></canvas>
            <div class="medical-indicators">
                <div class="indicator" id="track">TRACKING: OFF</div>
                <div class="indicator" id="mask">MASK: NONE</div>
                <div class="indicator" id="addon">ADDON: NONE</div>
                <div class="indicator vr" id="vr">VR: OFFLINE</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.min.js"></script>
<script type="module">
import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

const video = document.getElementById('video');
const canvas = document.getElementById('view3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');
const addonEl = document.getElementById('addon');
const vrEl = document.getElementById('vr');

let faceLandmarker = null;
let running = false;
let lastTime = 0;
let scene, camera, renderer, maskGroup, currentMask = null, currentAddon = null;

const maskMat = new THREE.MeshPhongMaterial({
    color: 0x00ffff,
    transparent: true,
    opacity: 0.78,
    shininess: 80,
    specular: 0x44ffff
});

function log(m) {
    logEl.innerHTML += `<br>> ${m}`;
    logEl.scrollTop = logEl.scrollHeight;
}

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
    camera.position.z = 0.8; // Perfect for 2D video overlay
    renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    renderer.xr.enabled = true;
    renderer.setAnimationLoop(animate);
    scene.add(new THREE.HemisphereLight(0xffffff, 0x0088ff, 2.2));
    scene.add(new THREE.AmbientLight(0x00ffff, 0.8));
    maskGroup = new THREE.Group();
    scene.add(maskGroup);
    window.addEventListener('resize', () => {
        camera.aspect = canvas.clientWidth / canvas.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    });
    animate();
    log('3D MEDICAL RENDER CORE ONLINE');
}

function createMask(type) {
    if (currentMask) maskGroup.remove(currentMask);
    currentMask = new THREE.Group();

    switch(type) {
        case 'surgical':
            // Surgical mask with pleats + ear loops
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.48, 0.28, 0.06), maskMat);
            body.position.z = 0.04;
            currentMask.add(body);
            for (let i = -0.09; i <= 0.09; i += 0.06) {
                const pleat = new THREE.Mesh(new THREE.BoxGeometry(0.44, 0.015, 0.07), maskMat);
                pleat.position.y = i;
                pleat.position.z = 0.05;
                currentMask.add(pleat);
            }
            const loopGeo = new THREE.TorusGeometry(0.18, 0.025, 8, 20, Math.PI);
            const loopMat = maskMat.clone(); loopMat.opacity = 0.9;
            const left = new THREE.Mesh(loopGeo, loopMat);
            left.position.set(-0.28, 0, 0.02);
            left.rotation.set(0, Math.PI/2, Math.PI/2);
            currentMask.add(left);
            const right = left.clone();
            right.position.x = 0.28;
            right.rotation.y = -Math.PI/2;
            currentMask.add(right);
            break;

        case 'n95':
            // N95 cupped respirator + valve
            const n95mat = maskMat.clone(); n95mat.color.set(0x00ffaa);
            const body2 = new THREE.Mesh(new THREE.DodecahedronGeometry(0.26, 2), n95mat);
            body2.scale.set(1.3, 1.0, 1.5);
            body2.position.z = 0.06;
            currentMask.add(body2);
            const valve = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 0.05, 16), n95mat);
            valve.position.set(0, -0.04, 0.12);
            currentMask.add(valve);
            break;

        case 'full_face':
            // Full face shield visor + head strap
            const visorMat = new THREE.MeshPhongMaterial({color: 0x88ffff, transparent: true, opacity: 0.35, side: THREE.DoubleSide, shininess: 120});
            const visor = new THREE.Mesh(new THREE.PlaneGeometry(0.62, 0.75), visorMat);
            visor.position.z = 0.18;
            visor.rotation.x = -0.35;
            currentMask.add(visor);
            const strap = new THREE.Mesh(new THREE.BoxGeometry(0.58, 0.1, 0.1), maskMat);
            strap.position.set(0, 0.22, -0.06);
            currentMask.add(strap);
            break;

        case 'goggle_mask':
            // Safety goggles + surgical mask combo
            const goggleMat = maskMat.clone(); goggleMat.opacity = 0.9;
            const frame = new THREE.Mesh(new THREE.BoxGeometry(0.54, 0.18, 0.12), goggleMat);
            frame.position.z = 0.08;
            currentMask.add(frame);
            const lensMat = new THREE.MeshPhongMaterial({color: 0x88ffff, transparent: true, opacity: 0.45, side: THREE.DoubleSide});
            const leftLens = new THREE.Mesh(new THREE.CircleGeometry(0.1, 32), lensMat);
            leftLens.position.set(-0.13, 0.06, 0.14);
            currentMask.add(leftLens);
            const rightLens = leftLens.clone();
            rightLens.position.x = 0.13;
            currentMask.add(rightLens);
            // lower mask
            const lower = new THREE.Mesh(new THREE.BoxGeometry(0.48, 0.18, 0.06), maskMat);
            lower.position.z = 0.02;
            lower.position.y = -0.1;
            currentMask.add(lower);
            break;

        case 'tactical':
            // Tactical respirator with side filters
            const tacMat = maskMat.clone(); tacMat.color.set(0x0088ff); tacMat.opacity = 0.85;
            const main = new THREE.Mesh(new THREE.CylinderGeometry(0.18, 0.2, 0.32, 32, 1, true), tacMat);
            main.rotation.x = Math.PI / 2;
            main.position.z = 0.06;
            currentMask.add(main);
            const filter = new THREE.Mesh(new THREE.CylinderGeometry(0.09, 0.09, 0.14, 20), tacMat);
            filter.position.set(-0.18, -0.04, 0.08);
            filter.rotation.z = Math.PI / 2;
            currentMask.add(filter);
            const filterR = filter.clone();
            filterR.position.x = 0.18;
            currentMask.add(filterR);
            break;
    }
    maskGroup.add(currentMask);
    maskEl.textContent = `MASK: ${type.toUpperCase()}`;
}

function createAddon(type) {
    if (currentAddon) maskGroup.remove(currentAddon);
    currentAddon = null;
    if (type === 'none') {
        addonEl.textContent = 'ADDON: NONE';
        return;
    }
    currentAddon = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({color: 0x00ffaa, shininess: 60});

    switch(type) {
        case 'comms':
            const comm = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 0.22), mat);
            comm.position.set(0.18, 0.06, 0.1);
            comm.rotation.z = Math.PI / 3.5;
            currentAddon.add(comm);
            break;
        case 'filter':
            const f = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.1, 0.18), mat);
            f.position.set(0, -0.22, 0.08);
            currentAddon.add(f);
            break;
        case 'visor':
            const vmat = new THREE.MeshPhongMaterial({color: 0x88ffff, transparent: true, opacity: 0.4, side: THREE.DoubleSide});
            const vis = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 0.32), vmat);
            vis.position.z = 0.22;
            vis.rotation.x = -0.45;
            currentAddon.add(vis);
            break;
        case 'sensor':
            const sensor = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.04, 0.03), mat);
            sensor.position.set(-0.12, 0.12, 0.1);
            currentAddon.add(sensor);
            const sensorR = sensor.clone();
            sensorR.position.x = 0.12;
            currentAddon.add(sensorR);
            break;
    }
    maskGroup.add(currentAddon);
    addonEl.textContent = `ADDON: ${type.toUpperCase()}`;
}

function updateHeadPose(rawLandmarks) {
    // Flip X to match mirrored video
    const landmarks = rawLandmarks.map(l => ({x: 1 - l.x, y: l.y, z: l.z}));

    const nose = landmarks[1];
    const chin = landmarks[152];
    const leftEye = landmarks[33];
    const rightEye = landmarks[263];
    const leftTemple = landmarks[234];
    const rightTemple = landmarks[454];

    const centerX = (leftTemple.x + rightTemple.x) / 2;
    const centerY = (nose.y + chin.y) / 2;
    const faceWidth = Math.abs(rightTemple.x - leftTemple.x);
    const scale = THREE.MathUtils.lerp(1.0, 2.3, faceWidth * 9.5);

    maskGroup.position.x = (centerX - 0.5) * 2.4;
    maskGroup.position.y = -(centerY - 0.5) * 2.4;
    maskGroup.scale.set(scale, scale, scale);

    const yaw = (rightEye.x - leftEye.x) * 3.2;
    maskGroup.rotation.y = -yaw;

    const eyeMidY = (leftEye.y + rightEye.y) / 2;
    const pitch = (eyeMidY - nose.y) * 42;
    maskGroup.rotation.x = pitch;

    const dx = rightEye.x - leftEye.x;
    const dy = rightEye.y - leftEye.y;
    const roll = Math.atan2(dy, dx);
    maskGroup.rotation.z = -roll;
}

async function startAR() {
    if (running) return;
    running = true;
    log('DEPLOYING MEDICAL AR SYSTEM...');
    try {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");
        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                delegate: "GPU"
            },
            outputFaceBlendshapes: false,
            runningMode: "VIDEO",
            numFaces: 1
        });

        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 }}
        });
        video.srcObject = stream;
        await video.play();

        const detect = () => {
            if (!running) return;
            const now = performance.now();
            const results = faceLandmarker.detectForVideo(video, now);
            if (results.faceLandmarks?.[0]) {
                updateHeadPose(results.faceLandmarks[0]);
                trackEl.textContent = 'TRACKING: LOCKED';
                trackEl.classList.add('locked');
            } else {
                trackEl.textContent = 'TRACKING: SEARCHING';
                trackEl.classList.remove('locked');
            }
            requestAnimationFrame(detect);
        };
        detect();
        log('MEDICAL AR ACTIVE // FACE LOCK ACHIEVED');
    } catch (e) {
        log('ERROR: ' + e.message);
        running = false;
    }
}

function animate(t = 0) {
    requestAnimationFrame(animate);
    if (currentMask) {
        currentMask.rotation.z += 0.003;
        maskMat.opacity = 0.7 + Math.sin(t * 0.004) * 0.15;
    }
    renderer.render(scene, camera);
}

async function enterXR() {
    if (!navigator.xr) { log("WebXR NOT AVAILABLE"); return; }
    try {
        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local-floor'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: { root: document.body }
        });
        await renderer.xr.setSession(session);
        vrEl.textContent = 'VR: IMMERSIVE-AR';
        vrEl.style.background = 'rgba(0,255,0,0.8)';
        log('IMMERSIVE AR MODE ACTIVE');
        session.addEventListener('end', () => {
            vrEl.textContent = 'VR: OFFLINE';
            vrEl.style.background = 'rgba(255,0,0,0.7)';
            log('XR SESSION TERMINATED');
        });
    } catch (e) {
        log('XR FAILED: ' + e.message);
    }
}

document.getElementById('start').onclick = startAR;
document.getElementById('enter-vr').onclick = enterXR;
document.getElementById('mask-select').onchange = e => createMask(e.target.value);
document.getElementById('addon-select').onchange = e => createAddon(e.target.value);

document.getElementById('export').onclick = () => {
    const data = {
        channel: "9-MEDICAL",
        timestamp: new Date().toISOString(),
        mask: document.getElementById('mask-select').value,
        addon: document.getElementById('addon-select').value,
        pose: {
            position: maskGroup.position.toArray(),
            rotation: maskGroup.rotation.toArray().slice(0,3),
            scale: maskGroup.scale.x
        }
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `MEDICAL_FIT_${data.mask}_${data.addon}_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    log('MEDICAL FIT DATA EXPORTED');
};

init3D();
createMask('surgical');
createAddon('none');
log('CHANNEL 9 READY â€“ START CAMERA TO FIT MASK');
</script>
</body>
</html>
