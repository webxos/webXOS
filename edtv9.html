<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 9 - MEDICAL MASK DESIGNER (FIXED)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0ff;overflow:hidden;height:100vh;user-select:none}
    #app{position:relative;width:100%;height:100vh;display:flex;flex-direction:column}
    .grid{position:absolute;inset:0;background:linear-gradient(rgba(0,200,255,0.08)1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,0.08)1px,transparent 1px);background-size:16px 16px;z-index:-1}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,40,80,0.1)50%);background-size:100% 4px;pointer-events:none;animation:s 8s linear infinite;z-index:-1}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    .banner{background:rgba(0,20,50,0.95);border-bottom:2px solid #0ff;padding:10px;text-align:center;font-size:12px;letter-spacing:1px;text-shadow:0 0 12px #0ff}
    .content{flex:1;display:flex;flex-direction:column;padding:10px;gap:10px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;padding:10px;background:rgba(0,30,60,0.8);border:1px solid #0ff;box-shadow:0 0 10px rgba(0,200,255,0.4)}
    .btn,.btn-medical{background:#000;border:1px solid #0ff;color:#0ff;padding:8px 16px;font-size:11px;cursor:pointer;box-shadow:0 0 8px #0ff;transition:.2s}
    .btn-medical{border:1px solid #f00;color:#f00;box-shadow:0 0 8px #f00}
    .btn:hover,.btn-medical:hover{background:#0ff;color:#000;box-shadow:0 0 20px #0ff}
    .btn-medical:hover{background:#f00;color:#000;box-shadow:0 0 20px #f00}
    .dropdown{background:#000;border:1px solid #0ff;color:#0ff;padding:8px;font-size:10px;width:220px;box-shadow:0 0 8px rgba(0,200,255,0.5)}
    .terminal{flex:1;background:rgba(0,20,40,0.8);border:1px solid #0ff;padding:10px;font-size:10px;overflow-y:auto;max-height:140px;box-shadow:0 0 10px rgba(0,200,255,0.3)}
    .ar-view{flex:1;position:relative;border:1px solid #0ff;background:#000;overflow:hidden;box-shadow:0 0 15px rgba(0,200,255,0.4)}
    #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #view3d{position:absolute;inset:0;width:100%;height:100%}
    .medical-indicators{position:absolute;top:10px;left:10px;display:flex;gap:10px;z-index:20}
    .indicator{background:rgba(255,0,0,0.7);border:1px solid #f00;color:#fff;padding:5px 10px;font-size:9px;box-shadow:0 0 8px #f00}
</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<div id="app">
    <div class="grid"></div>
    <div class="crt"></div>
    <div class="banner">EDTV: CHANNEL 9 - MEDICAL MASK DESIGNER (v9.1 FIXED)</div>
    <div class="content">
        <div class="controls">
            <button class="btn-medical" id="start">START CAMERA & SYNC</button>
            <button class="btn-medical" id="export">EXPORT 3D JSON</button>
            <select class="dropdown" id="mask-select">
                <option value="surgical">SURGICAL MASK</option>
                <option value="n95">N95 RESPIRATOR</option>
                <option value="full_face">FULL FACE SHIELD</option>
                <option value="goggle_mask">GOGGLE MASK COMBO</option>
                <option value="tactical">TACTICAL MEDICAL MASK</option>
            </select>
            <select class="dropdown" id="addon-select">
                <option value="none">NO ADDONS</option>
                <option value="comms">COMMUNICATION SET</option>
                <option value="filter">ADVANCED FILTER</option>
                <option value="visor">PROTECTIVE VISOR</option>
                <option value="sensor">VITAL SENSORS</option>
            </select>
        </div>
        <div class="terminal" id="log">> SYSTEM READY - PRESS START</div>
        <div class="ar-view">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="view3d"></canvas>
            <div class="medical-indicators">
                <div class="indicator" id="track">FACE TRACKING: OFF</div>
                <div class="indicator" id="mask">MASK: NONE</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
const log = msg => { 
    document.getElementById('log').innerHTML += '<br>> ' + msg;
    document.getElementById('log').scrollTop = 999999;
};

const video = document.getElementById('video');
const canvas = document.getElementById('view3d');
let scene, camera, renderer;
let faceMesh, landmarks = [];
let maskGroup = new THREE.Group();
let isRunning = false;

// ----- 3D SETUP -----
function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, canvas.clientWidth/canvas.clientHeight, 0.1, 100);
    camera.position.z = 4;

    renderer = new THREE.WebGLRenderer({canvas, alpha:true, antialias:false});
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    const light = new THREE.HemisphereLight(0x00ffff, 0xff0088, 1);
    scene.add(light);
    scene.add(maskGroup);

    window.addEventListener('resize', () => {
        camera.aspect = canvas.clientWidth/canvas.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    });
}

// ----- MASK MODELS (improved geometry & positioning) -----
function loadMask(type) {
    maskGroup.clear();
    let mask;

    switch(type){
        case'surgical': mask = createSurgical(); break;
        case'n95': mask = createN95(); break;
        case'full_face': mask = createFullFace(); break;
        case'goggle_mask': mask = createGoggleMask(); break;
        case'tactical': mask = createTactical(); break;
    }
    maskGroup.add(mask);
    document.getElementById('mask').textContent = `MASK: ${type.toUpperCase()}`;
}

function createSurgical(){
    const g = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({color:0xff3366, transparent:true, opacity:0.85});
    const geo = new THREE.BoxGeometry(2.2, 1.4, 0.1);
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.z = 0.6;
    g.add(mesh);
    // ear loops
    const loop = new THREE.TorusGeometry(0.25, 0.06, 8, 30);
    const l = new THREE.Mesh(loop, mat); l.position.set(-1.2,0,0.3); l.rotation.y = 0.5;
    const r = new THREE.Mesh(loop, mat); r.position.set(1.2,0,0.3); r.rotation.y = -0.5;
    g.add(l,r);
    return g;
}
function createN95(){
    const g = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({color:0xff3366, transparent:true, opacity:0.9});
    const geo = new THREE.SphereGeometry(1.1, 32, 16, 0, Math.PI*2, 0, Math.PI/2);
    const mesh = new THREE.Mesh(geo, mat);
    mesh.rotation.x = Math.PI;
    mesh.position.z = 0.7;
    g.add(mesh);
    // valve
    const valve = new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.22,0.12,16), new THREE.MeshPhongMaterial({color:0x333333}));
    valve.position.set(0,-0.25,1.1);
    g.add(valve);
    return g;
}
function createFullFace(){
    const g = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({color:0x00ffff, transparent:true, opacity:0.35, side:THREE.DoubleSide});
    const geo = new THREE.CylinderGeometry(1.8,2,2.2,32,1,true);
    const shield = new THREE.Mesh(geo, mat);
    shield.rotation.x = Math.PI/2;
    shield.position.z = 0.9;
    g.add(shield);
    return g;
}
function createGoggleMask(){
    const g = createN95();
    const mat = new THREE.MeshPhongMaterial({color:0x00ff00, transparent:true, opacity:0.6});
    const lens = new THREE.Mesh(new THREE.RingGeometry(0.4,0.7,32), mat);
    lens.position.set(0,0.4,0.9);
    g.add(lens);
    return g;
}
function createTactical(){
    const g = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({color:0xff0033, transparent:true, opacity:0.9});
    const geo = new THREE.SphereGeometry(1.3,32,20,0,Math.PI*2,0,Math.PI/2);
    const mesh = new THREE.Mesh(geo, mat);
    mesh.rotation.x = Math.PI;
    mesh.position.z = 0.7;
    g.add(mesh);
    // filters
    for(let x of [-0.5,0.5]){
        const f = new THREE.Mesh(new THREE.CylinderGeometry(0.18,0.18,0.25,16), new THREE.MeshPhongMaterial({color:0x222222}));
        f.position.set(x,-0.3,1.0);
        g.add(f);
    }
    return g;
}

// ----- FACE TRACKING & POSE -----
function onResults(results) {
    if (results.multiFaceLandmarks?.[0]) {
        landmarks = results.multiFaceLandmarks[0];
        document.getElementById('track').textContent = 'FACE TRACKING: ACTIVE';
        updateMaskPose();
    } else {
        document.getElementById('track').textContent = 'FACE TRACKING: SEARCHING...';
    }
}

function updateMaskPose() {
    if (!landmarks.length) return;

    const nose = landmarks[1];
    const left = landmarks[33];
    const right = landmarks[263];
    const chin = landmarks[152];

    // Translation
    const scale = 7;
    maskGroup.position.x = (nose.x - 0.5) * scale;
    maskGroup.position.y = (0.5 - nose.y) * scale * (canvas.clientHeight/canvas.clientWidth);
    maskGroup.position.z = -nose.z * scale * 10;

    // Scale by face width
    const faceWidth = Math.hypot(right.x-left.x, right.y-left.y);
    const base = 0.18;
    const s = faceWidth / base;
    maskGroup.scale.set(s, s, s);

    // Rotation (simple but smooth)
    const dx = right.x - left.x;
    const dy = right.y - left.y;
    maskGroup.rotation.z = Math.atan2(dy, dx); // roll
    maskGroup.rotation.y = (nose.x - (left.x + right.x)/2) * 4; // yaw
    maskGroup.rotation.x = ((left.y + right.y)/2 - nose.y) * 4; // pitch
}

// ----- CAMERA & FACEMESH (ONE-TIME START) -----
let cameraInstance;
async function startCamera() {
    if (isRunning) return;
    isRunning = true;

    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
    video.srcObject = stream;

    faceMesh = new FaceMesh({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.8, minTrackingConfidence:0.8});
    faceMesh.onResults(onResults);

    cameraInstance = new Camera(video, {
        onFrame: async () => await faceMesh.send({image: video}),
        width: 640,
        height: 480
    });
    cameraInstance.start();
    log('CAMERA + FACE MESH ONLINE');
}

// ----- EXPORT -----
function exportJSON() {
    if (!landmarks.length) { log('NO FACE DATA - MOVE INTO FRAME'); return; }

    const data = {
        exportDate: new Date().toISOString(),
        maskType: document.getElementById('mask-select').value,
        addon: document.getElementById('addon-select').value,
        faceLandmarks: landmarks.map(p=>({x:p.x,y:p.y,z:p.z})),
        maskTransform: {
            position: {x:maskGroup.position.x, y:maskGroup.position.y, z:maskGroup.position.z},
            rotation: {x:maskGroup.rotation.x, y:maskGroup.rotation.y, z:maskGroup.rotation.z},
            scale: {x:maskGroup.scale.x, y:maskGroup.scale.y, z:maskGroup.scale.z}
        }
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mask_fit_${Date.now()}.json`;
    a.click();
    log('3D FIT DATA EXPORTED');
}

// ----- ANIMATION LOOP -----
function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}

// ----- INIT -----
init3D();
loadMask('surgical');
animate();

document.getElementById('start').onclick = () => {
    startCamera();
    log('SYNCING MASK TO FACE...');
};
document.getElementById('export').onclick = exportJSON;
document.getElementById('mask-select').onchange = e => loadMask(e.target.value);
document.getElementById('addon-select').onchange = () => log('Addon change ready (visual only in this fix)');
</script>
</body>
</html>
