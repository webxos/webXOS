<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEGACY OS - Linux Inspired Edition by webXOS</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêß</text></svg>">
    <style>
        /* Early 90s Linux/X11 Style */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 12px;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background-color: #000033;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23000033"/><circle cx="50" cy="50" r="40" fill="%23000044"/></svg>');
            color: #00ff00;
            position: relative;
        }
        
        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fill, 90px);
            grid-auto-rows: 90px;
            gap: 10px;
            padding: 15px;
            align-content: start;
            overflow: hidden;
        }
        
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            background: #333344;
            border-top: 2px solid #777788;
            display: flex;
            align-items: center;
            padding: 0 4px;
            z-index: 1000;
            color: #aaffaa;
        }
        
        #start-button {
            height: 20px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            padding: 2px 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-right: 4px;
            cursor: pointer;
            color: #ffffff;
            min-width: 100px;
        }
        
        #start-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        #taskbar-programs {
            flex: 1;
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 0 4px;
            gap: 4px;
        }
        
        #clock {
            padding: 2px 8px;
            background: #555566;
            border: 2px solid;
            border-color: #222233 #777788 #777788 #222233;
            margin-left: auto;
            white-space: nowrap;
            min-width: 60px;
            text-align: center;
            color: #aaffaa;
        }
        
        /* Start Menu */
        #start-menu {
            position: absolute;
            bottom: 24px;
            left: 4px;
            width: 200px;
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            padding: 2px;
            display: none;
            z-index: 1001;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        .start-menu-item {
            padding: 6px 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #aaffaa;
        }
        
        .start-menu-item:hover {
            background-color: #000066;
            color: white;
        }
        
        .start-menu-separator {
            height: 1px;
            background: #777788;
            margin: 4px 0;
        }
        
        /* Desktop Icons - Fixed for all screen sizes */
        .desktop-icon {
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-align: center;
            color: #00ff00;
            border: 1px dashed transparent;
            padding: 5px;
        }
        
        .desktop-icon:hover {
            background-color: rgba(0, 100, 0, 0.2);
            border-color: #00ff00;
        }
        
        .desktop-icon.selected {
            background-color: rgba(0, 100, 0, 0.4);
            border-color: #00ff00;
        }
        
        .desktop-icon .icon-image {
            font-size: 32px;
            margin-bottom: 4px;
        }
        
        .desktop-icon .icon-label {
            font-size: 11px;
            word-break: break-word;
            line-height: 1.2;
            max-width: 100%;
        }
        
        /* Window Styles - X11/Motif inspired with RESIZABLE edges */
        .window {
            position: absolute;
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            min-width: 300px;
            min-height: 200px;
            display: none;
            flex-direction: column;
            z-index: 100;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
            color: #aaffaa;
            resize: both;
            overflow: hidden;
        }
        
        /* Hide the default resize handle */
        .window::-webkit-resizer {
            display: none;
        }
        
        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100% - 24px) !important;
            resize: none;
        }
        
        .window-header {
            background: linear-gradient(to right, #000066, #333377);
            color: #ffffff;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            cursor: move;
            user-select: none;
            border-bottom: 1px solid #777788;
        }
        
        .window-controls {
            display: flex;
        }
        
        .window-control {
            width: 18px;
            height: 16px;
            background: #555566;
            border: 1px solid;
            border-color: #777788 #222233 #222233 #777788;
            margin-left: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            color: #aaffaa;
        }
        
        .window-control:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        .window-content {
            flex: 1;
            padding: 8px;
            overflow: auto;
            background: #222233;
            resize: none;
            min-height: 0;
        }
        
        /* Custom resize handles */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 101;
        }
        
        .resize-handle.n {
            top: 0;
            left: 5px;
            right: 5px;
            height: 5px;
            cursor: n-resize;
        }
        
        .resize-handle.s {
            bottom: 0;
            left: 5px;
            right: 5px;
            height: 5px;
            cursor: s-resize;
        }
        
        .resize-handle.e {
            top: 5px;
            right: 0;
            bottom: 5px;
            width: 5px;
            cursor: e-resize;
        }
        
        .resize-handle.w {
            top: 5px;
            left: 0;
            bottom: 5px;
            width: 5px;
            cursor: w-resize;
        }
        
        .resize-handle.ne {
            top: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: ne-resize;
        }
        
        .resize-handle.nw {
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: nw-resize;
        }
        
        .resize-handle.se {
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            cursor: se-resize;
        }
        
        .resize-handle.sw {
            bottom: 0;
            left: 0;
            width: 10px;
            height: 10px;
            cursor: sw-resize;
        }
        
        /* Terminal Window */
        .terminal-content {
            background: #000011;
            color: #00ff00;
            padding: 8px;
            height: 100%;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-y: auto;
        }
        
        .terminal-input-line {
            display: flex;
            margin-top: 4px;
        }
        
        .terminal-prompt {
            color: #ffff00;
            margin-right: 8px;
            white-space: nowrap;
        }
        
        .terminal-input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 13px;
            flex: 1;
            outline: none;
        }
        
        /* File Manager */
        .file-manager-toolbar {
            display: flex;
            padding: 4px;
            border-bottom: 1px solid #777788;
            background: #333344;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .toolbar-button {
            padding: 2px 8px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            cursor: pointer;
            color: #aaffaa;
            white-space: nowrap;
        }
        
        .toolbar-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        .file-list {
            display: flex;
            flex-wrap: wrap;
            padding: 8px;
            gap: 8px;
        }
        
        .file-item {
            width: 100px;
            height: 90px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            color: #aaffaa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .file-item:hover {
            background-color: rgba(0, 100, 0, 0.2);
            border: 1px dashed #00ff00;
        }
        
        .file-item.selected {
            background-color: rgba(0, 100, 0, 0.4);
            border: 1px solid #00ff00;
        }
        
        /* Text Editor */
        .text-editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .text-editor-toolbar {
            display: flex;
            padding: 4px;
            border-bottom: 1px solid #777788;
            background: #333344;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .text-editor {
            width: 100%;
            flex: 1;
            background: #000011;
            color: #00ff00;
            border: 1px solid #555566;
            padding: 8px;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            font-size: 13px;
            resize: none;
            min-height: 0;
        }
        
        /* System Monitor */
        .system-stats {
            padding: 8px;
        }
        
        .stat-bar {
            height: 16px;
            background: #555566;
            border: 1px solid #777788;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .stat-fill {
            height: 100%;
            background: #006600;
        }
        
        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }
        
        /* Modal Dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-dialog {
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            min-width: 300px;
            max-width: 90%;
            padding: 0;
            color: #aaffaa;
        }
        
        .modal-header {
            background: linear-gradient(to right, #000066, #333377);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            border-bottom: 1px solid #777788;
        }
        
        .modal-body {
            padding: 16px;
            background: #222233;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 8px;
            text-align: right;
            border-top: 1px solid #777788;
            background: #333344;
        }
        
        .dialog-button {
            padding: 4px 12px;
            margin-left: 4px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            cursor: pointer;
            color: #aaffaa;
        }
        
        .dialog-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        .dialog-button.primary {
            background: #006600;
            font-weight: bold;
        }
        
        /* Context Menu */
        .context-menu {
            position: absolute;
            background: #333344;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            padding: 2px;
            display: none;
            z-index: 1500;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        .context-menu-item {
            padding: 6px 24px 6px 12px;
            cursor: pointer;
            white-space: nowrap;
            color: #aaffaa;
        }
        
        .context-menu-item:hover {
            background-color: #000066;
            color: white;
        }
        
        /* Taskbar Program Button */
        .taskbar-program {
            padding: 2px 8px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            cursor: pointer;
            white-space: nowrap;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #aaffaa;
            flex-shrink: 0;
        }
        
        .taskbar-program.active {
            border-color: #222233 #777788 #777788 #222233;
            background: #000066;
        }
        
        /* Status Bar */
        #status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 18px;
            background: #333344;
            border-top: 1px solid #777788;
            padding: 2px 8px;
            font-size: 10px;
            display: none;
            color: #aaffaa;
        }
        
        /* Welcome Screen */
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 24px;
            background: #000011;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2001;
            font-family: "Fixed", "Monospace", "Terminus", "Courier New", monospace;
            text-align: center;
            padding: 20px;
        }
        
        #welcome-screen h1 {
            font-size: clamp(24px, 5vw, 36px);
            margin-bottom: 20px;
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }
        
        #welcome-screen .logo {
            font-size: clamp(36px, 8vw, 48px);
            margin-bottom: 20px;
        }
        
        #welcome-screen p {
            font-size: clamp(12px, 2vw, 14px);
            margin-bottom: 20px;
            max-width: 600px;
            line-height: 1.5;
        }
        
        .welcome-button {
            padding: 10px 20px;
            background: #555566;
            border: 2px solid;
            border-color: #777788 #222233 #222233 #777788;
            cursor: pointer;
            font-size: clamp(12px, 2vw, 14px);
            margin: 8px;
            color: #aaffaa;
        }
        
        .welcome-button:active {
            border-color: #222233 #777788 #777788 #222233;
        }
        
        /* Help Window */
        .help-content {
            padding: 8px;
            line-height: 1.4;
        }
        
        .help-command {
            color: #ffff00;
            margin: 8px 0 4px 0;
        }
        
        .help-description {
            margin-left: 16px;
            margin-bottom: 12px;
        }
        
        /* File Operations Window */
        .file-ops-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 4px;
            border-bottom: 1px solid #777788;
            background: #333344;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #333344;
            border: 1px solid #555566;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #555566;
            border: 1px solid #777788;
        }
        
        /* CLI Output */
        .cli-output {
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .cli-error {
            color: #ff5555;
        }
        
        .cli-success {
            color: #55ff55;
        }
        
        .cli-directory {
            color: #5555ff;
        }
        
        .cli-executable {
            color: #ff55ff;
        }
        
        /* Desktop wallpaper text */
        #desktop-text {
            position: absolute;
            bottom: 30px;
            right: 20px;
            color: #008800;
            font-size: 10px;
            opacity: 0.7;
        }
        
        /* File properties */
        .file-properties {
            margin: 8px 0;
            padding: 8px;
            background: #000011;
            border: 1px solid #555566;
        }
        
        .property-row {
            display: flex;
            margin: 4px 0;
        }
        
        .property-label {
            width: 120px;
            font-weight: bold;
        }
        
        .property-value {
            flex: 1;
            word-break: break-word;
        }
        
        /* Save dialog */
        .save-dialog-options {
            margin: 12px 0;
        }
        
        .save-option {
            margin: 8px 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #desktop {
                grid-template-columns: repeat(auto-fill, 80px);
                grid-auto-rows: 80px;
                gap: 8px;
                padding: 10px;
            }
            
            .desktop-icon {
                width: 70px;
                height: 70px;
            }
            
            .window {
                min-width: 280px;
                min-height: 180px;
            }
            
            .file-item {
                width: 90px;
                height: 80px;
            }
            
            #start-button {
                min-width: 80px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            #desktop {
                grid-template-columns: repeat(auto-fill, 70px);
                grid-auto-rows: 70px;
                gap: 6px;
                padding: 8px;
            }
            
            .desktop-icon {
                width: 60px;
                height: 60px;
            }
            
            .desktop-icon .icon-image {
                font-size: 24px;
            }
            
            .desktop-icon .icon-label {
                font-size: 10px;
            }
            
            .window {
                min-width: 250px;
                min-height: 150px;
            }
            
            .file-item {
                width: 80px;
                height: 70px;
            }
            
            #start-button {
                min-width: 70px;
                padding: 2px 4px;
                font-size: 10px;
            }
            
            #clock {
                min-width: 50px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="logo">üêß</div>
        <h1>LEGACY OS</h1>
        <p>Linux inspired Edition</p>
        <p>All files saved in browser storage | Real file operations | Export/Import system</p>
        <div>
            <button class="welcome-button" id="start-demo">Boot System</button>
            <button class="welcome-button" id="view-guide">Quick Start</button>
        </div>
        <p style="margin-top: 30px; font-size: 12px;">This is a 2026 tribute to Linus by webXOS</p>
    </div>

    <!-- Desktop -->
    <div id="desktop">
        <!-- Desktop Icons will be dynamically created here -->
        <div id="desktop-text">LEGACY OS by webXOS | 2026 </div>
    </div>
    
    <!-- Taskbar -->
    <div id="taskbar">
        <div id="start-button">
            <span>Applications</span>
        </div>
        <div id="taskbar-programs">
            <!-- Active programs will appear here -->
        </div>
        <div id="clock">00:00</div>
    </div>
    
    <!-- Start Menu -->
    <div id="start-menu">
        <div class="start-menu-item" id="start-terminal">
            <span>Terminal (CLI)</span>
        </div>
        <div class="start-menu-item" id="start-fileman">
            <span>File Manager</span>
        </div>
        <div class="start-menu-item" id="start-editor">
            <span>Text Editor</span>
        </div>
        <div class="start-menu-separator"></div>
        <div class="start-menu-item" id="start-monitor">
            <span>System Monitor</span>
        </div>
        <div class="start-menu-item" id="start-help">
            <span>Help & Commands</span>
        </div>
        <div class="start-menu-separator"></div>
        <div class="start-menu-item" id="start-import">
            <span>Import Files...</span>
        </div>
        <div class="start-menu-item" id="start-export">
            <span>Export Files...</span>
        </div>
        <div class="start-menu-separator"></div>
        <div class="start-menu-item" id="start-about">
            <span>About LEGACY OS</span>
        </div>
        <div class="start-menu-item" id="start-shutdown">
            <span>Shutdown</span>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-text">Ready</span>
    </div>
    
    <!-- Terminal Window -->
    <div class="window" id="terminal">
        <div class="window-header">
            <span>Terminal - bash</span>
            <div class="window-controls">
                <div class="window-control" id="terminal-minimize">_</div>
                <div class="window-control" id="terminal-maximize">‚ñ°</div>
                <div class="window-control" id="terminal-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="terminal-content" id="terminal-output">
                <div class="cli-output">LEGACY OS by webXOS Terminal v1.0</div>
                <div class="cli-output">Type 'help' for available commands</div>
                <div class="cli-output">Type 'man [command]' for detailed help</div>
                <div id="terminal-history"></div>
                <div class="terminal-input-line">
                    <span class="terminal-prompt">[user@legacyos ~]$</span>
                    <input type="text" class="terminal-input" id="terminal-input" autocomplete="off">
                </div>
            </div>
        </div>
        <!-- Resize handles -->
        <div class="resize-handle n"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle se"></div>
        <div class="resize-handle sw"></div>
    </div>
    
    <!-- File Manager -->
    <div class="window" id="file-manager">
        <div class="window-header">
            <span>File Manager</span>
            <div class="window-controls">
                <div class="window-control" id="file-manager-minimize">_</div>
                <div class="window-control" id="file-manager-maximize">‚ñ°</div>
                <div class="window-control" id="file-manager-close">√ó</div>
            </div>
        </div>
        <div class="file-manager-toolbar">
            <div class="toolbar-button" id="fm-home">Home</div>
            <div class="toolbar-button" id="fm-up">Up</div>
            <div class="toolbar-button" id="fm-new-folder">New Folder</div>
            <div class="toolbar-button" id="fm-new-file">New File</div>
            <div class="toolbar-button" id="fm-rename">Rename</div>
            <div class="toolbar-button" id="fm-delete">Delete</div>
            <div class="toolbar-button" id="fm-properties">Properties</div>
            <div class="toolbar-button" id="fm-refresh">Refresh</div>
        </div>
        <div class="window-content">
            <div class="file-list" id="file-manager-list">
                <!-- Files and folders will be listed here -->
            </div>
        </div>
        <!-- Resize handles -->
        <div class="resize-handle n"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle se"></div>
        <div class="resize-handle sw"></div>
    </div>
    
    <!-- Text Editor -->
    <div class="window" id="text-editor">
        <div class="window-header">
            <span>Text Editor - [unnamed]</span>
            <div class="window-controls">
                <div class="window-control" id="text-editor-minimize">_</div>
                <div class="window-control" id="text-editor-maximize">‚ñ°</div>
                <div class="window-control" id="text-editor-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="text-editor-container">
                <div class="text-editor-toolbar">
                    <div class="toolbar-button" id="te-new">New</div>
                    <div class="toolbar-button" id="te-open">Open</div>
                    <div class="toolbar-button" id="te-save">Save</div>
                    <div class="toolbar-button" id="te-saveas">Save As</div>
                    <div class="toolbar-button" id="te-close">Close</div>
                </div>
                <textarea class="text-editor" id="text-editor-area"></textarea>
            </div>
        </div>
        <!-- Resize handles -->
        <div class="resize-handle n"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle se"></div>
        <div class="resize-handle sw"></div>
    </div>
    
    <!-- System Monitor -->
    <div class="window" id="system-monitor">
        <div class="window-header">
            <span>System Monitor</span>
            <div class="window-controls">
                <div class="window-control" id="system-monitor-minimize">_</div>
                <div class="window-control" id="system-monitor-maximize">‚ñ°</div>
                <div class="window-control" id="system-monitor-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="system-stats">
                <h3>System Resources</h3>
                <div>
                    <div class="stat-label">
                        <span>Memory Usage</span>
                        <span id="memory-percent">45%</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="memory-bar" style="width: 45%"></div>
                    </div>
                </div>
                <div>
                    <div class="stat-label">
                        <span>CPU Usage</span>
                        <span id="cpu-percent">30%</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="cpu-bar" style="width: 30%"></div>
                    </div>
                </div>
                <div>
                    <div class="stat-label">
                        <span>Storage Usage</span>
                        <span id="storage-percent">65%</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" id="storage-bar" style="width: 65%"></div>
                    </div>
                </div>
                <div>
                    <h3>File System Info</h3>
                    <p id="db-info">Loading IndexedDB...</p>
                    <p id="current-path">Path: /home/user</p>
                    <div class="toolbar-button" id="sm-export-all" style="margin-top: 8px;">Export All Files</div>
                    <div class="toolbar-button" id="sm-clear-db">Clear Database</div>
                </div>
            </div>
        </div>
        <!-- Resize handles -->
        <div class="resize-handle n"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle se"></div>
        <div class="resize-handle sw"></div>
    </div>
    
    <!-- Help Window -->
    <div class="window" id="help-window">
        <div class="window-header">
            <span>Help & Commands</span>
            <div class="window-controls">
                <div class="window-control" id="help-minimize">_</div>
                <div class="window-control" id="help-maximize">‚ñ°</div>
                <div class="window-control" id="help-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="help-content">
                <h3>LEGACY OS by webXOS- Complete File System</h3>
                <p><strong>All files are saved in IndexedDB and persist between sessions</strong></p>
                
                <h3>File Operations:</h3>
                <ul>
                    <li><strong>Save</strong>: Files auto-save or use Save/Save As</li>
                    <li><strong>Import</strong>: Import text files from your computer</li>
                    <li><strong>Export</strong>: Export files to your computer</li>
                    <li><strong>Organize</strong>: Create folders and move files</li>
                </ul>
                
                <h3>Available CLI Commands:</h3>
                <div class="help-command">help</div>
                <div class="help-description">Show this help message</div>
                
                <div class="help-command">ls [path]</div>
                <div class="help-description">List directory contents</div>
                
                <div class="help-command">cd [path]</div>
                <div class="help-description">Change directory</div>
                
                <div class="help-command">pwd</div>
                <div class="help-description">Print working directory</div>
                
                <div class="help-command">mkdir [name]</div>
                <div class="help-description">Create new directory</div>
                
                <div class="help-command">touch [name]</div>
                <div class="help-description">Create new file</div>
                
                <div class="help-command">cat [file]</div>
                <div class="help-description">Display file contents</div>
                
                <div class="help-command">edit [file]</div>
                <div class="help-description">Edit file in text editor</div>
                
                <div class="help-command">rm [file]</div>
                <div class="help-description">Remove file</div>
                
                <div class="help-command">rmdir [directory]</div>
                <div class="help-description">Remove empty directory</div>
                
                <div class="help-command">clear</div>
                <div class="help-description">Clear terminal screen</div>
                
                <div class="help-command">echo [text]</div>
                <div class="help-description">Display text</div>
                
                <div class="help-command">date</div>
                <div class="help-description">Show current date and time</div>
                
                <div class="help-command">whoami</div>
                <div class="help-description">Show current user</div>
                
                <div class="help-command">man [command]</div>
                <div class="help-description">Show manual for command</div>
                
                <div class="help-command">exportfs</div>
                <div class="help-description">Export all files to JSON</div>
                
                <div class="help-command">importfs [json]</div>
                <div class="help-description">Import files from JSON</div>
            </div>
        </div>
        <!-- Resize handles -->
        <div class="resize-handle n"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle se"></div>
        <div class="resize-handle sw"></div>
    </div>
    
    <!-- About Window -->
    <div class="window" id="about-window">
        <div class="window-header">
            <span>About LEGACY OS</span>
            <div class="window-controls">
                <div class="window-control" id="about-minimize">_</div>
                <div class="window-control" id="about-maximize">‚ñ°</div>
                <div class="window-control" id="about-close">√ó</div>
            </div>
        </div>
        <div class="window-content">
            <div class="help-content">
                <h2>LEGACY OS - by webXOS</h2>
                <p><strong>Version:</strong> 1.0 by</p>
                <p><strong>Storage:</strong> IndexedDB with full file hierarchy</p>
                <p><strong>Data Persistence:</strong> All files saved in browser storage</p>
                
                <h3>File System Features:</h3>
                <ul>
                    <li><strong>Hierarchical Storage</strong>: Files and folders in proper tree structure</li>
                    <li><strong>Auto-Save</strong>: Text editor auto-saves changes</li>
                    <li><strong>Import/Export</strong>: Bring files in and out of the system</li>
                    <li><strong>Metadata</strong>: File size, dates, permissions</li>
                    <li><strong>CLI Integration</strong>: All file operations available via terminal</li>
                    <li><strong>Session Persistence</strong>: Files remain between browser sessions</li>
                </ul>
                
                <h3>Technical Details:</h3>
                <p>Each file stores:</p>
                <ul>
                    <li>Name, path, and type (file/folder)</li>
                    <li>Content (for text files)</li>
                    <li>Parent folder reference</li>
                    <li>Creation and modification dates</li>
                    <li>File size in bytes</li>
                </ul>
                
                <p><strong>Note:</strong> This is a frontend-only system. Files are stored in your browser's IndexedDB.</p>
            </div>
        </div>
        <!-- Resize handles -->
        <div class="resize-handle n"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle se"></div>
        <div class="resize-handle sw"></div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="desktop-context-menu">
        <div class="context-menu-item" id="context-terminal">Open Terminal</div>
        <div class="context-menu-item" id="context-refresh">Refresh Desktop</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="context-new-folder">New Folder</div>
        <div class="context-menu-item" id="context-new-file">New Text File</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="context-import">Import Files...</div>
        <div class="context-menu-item" id="context-export">Export Files...</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="context-about">About LEGACY OS</div>
    </div>
    
    <!-- Modal Dialogs -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-dialog" id="modal-dialog">
            <div class="modal-header" id="modal-header">Dialog</div>
            <div class="modal-body" id="modal-body">
                Dialog content goes here
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="dialog-button" id="modal-cancel">Cancel</button>
                <button class="dialog-button primary" id="modal-ok">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for import -->
    <input type="file" id="file-import-input" multiple style="display: none;">
    
    <!-- Hidden anchor for export -->
    <a id="file-export-anchor" style="display: none;"></a>

    <script>
        // LEGACY OS - Linux Edition with Complete File System
        document.addEventListener('DOMContentLoaded', function() {
            initLegacyOS();
        });
        
        // Global variables
        let db;
        let currentPath = '/home/user';
        let currentFolderId = 'user';
        let activeWindows = [];
        let zIndexCounter = 100;
        let selectedDesktopIcon = null;
        let selectedFileItem = null;
        let commandHistory = [];
        let historyIndex = -1;
        
        // Current editor state
        let currentEditorFile = null;
        let editorIsModified = false;
        
        // Window resizing state
        let isResizing = false;
        let currentResizeHandle = null;
        let resizeStartX, resizeStartY, resizeStartWidth, resizeStartHeight, resizeStartLeft, resizeStartTop;
        
        // CLI Command Registry
        const COMMANDS = {
            'help': {
                description: 'Show available commands',
                execute: cmdHelp,
                usage: 'help'
            },
            'ls': {
                description: 'List directory contents',
                execute: cmdLs,
                usage: 'ls [path]'
            },
            'cd': {
                description: 'Change directory',
                execute: cmdCd,
                usage: 'cd [path]'
            },
            'pwd': {
                description: 'Print working directory',
                execute: cmdPwd,
                usage: 'pwd'
            },
            'mkdir': {
                description: 'Create new directory',
                execute: cmdMkdir,
                usage: 'mkdir [name]'
            },
            'touch': {
                description: 'Create new file',
                execute: cmdTouch,
                usage: 'touch [filename]'
            },
            'cat': {
                description: 'Display file contents',
                execute: cmdCat,
                usage: 'cat [filename]'
            },
            'edit': {
                description: 'Edit file in text editor',
                execute: cmdEdit,
                usage: 'edit [filename]'
            },
            'rm': {
                description: 'Remove file',
                execute: cmdRm,
                usage: 'rm [filename]'
            },
            'rmdir': {
                description: 'Remove empty directory',
                execute: cmdRmdir,
                usage: 'rmdir [dirname]'
            },
            'clear': {
                description: 'Clear terminal screen',
                execute: cmdClear,
                usage: 'clear'
            },
            'echo': {
                description: 'Display text',
                execute: cmdEcho,
                usage: 'echo [text]'
            },
            'date': {
                description: 'Show current date and time',
                execute: cmdDate,
                usage: 'date'
            },
            'whoami': {
                description: 'Show current user',
                execute: cmdWhoami,
                usage: 'whoami'
            },
            'man': {
                description: 'Show manual for command',
                execute: cmdMan,
                usage: 'man [command]'
            },
            'exportfs': {
                description: 'Export all files to JSON',
                execute: cmdExportfs,
                usage: 'exportfs'
            },
            'importfs': {
                description: 'Import files from JSON',
                execute: cmdImportfs,
                usage: 'importfs [json]'
            }
        };
        
        // Application registry
        const APP_REGISTRY = {
            'terminal': {
                name: 'Terminal',
                icon: 'üíª',
                windowId: 'terminal',
                open: openTerminal
            },
            'file-manager': {
                name: 'File Manager',
                icon: 'üìÅ',
                windowId: 'file-manager',
                open: openFileManager
            },
            'text-editor': {
                name: 'Text Editor',
                icon: 'üìù',
                windowId: 'text-editor',
                open: openTextEditor
            },
            'system-monitor': {
                name: 'System Monitor',
                icon: 'üìä',
                windowId: 'system-monitor',
                open: openSystemMonitor
            },
            'help': {
                name: 'Help',
                icon: '‚ùì',
                windowId: 'help-window',
                open: openHelp
            },
            'about': {
                name: 'About',
                icon: '‚ÑπÔ∏è',
                windowId: 'about-window',
                open: openAbout
            }
        };
        
        // Initialize the OS
        function initLegacyOS() {
            // Hide welcome screen after a delay or on button click
            document.getElementById('start-demo').addEventListener('click', function() {
                document.getElementById('welcome-screen').style.display = 'none';
                initDesktop();
                initEventListeners();
                initDatabase();
                updateClock();
                setInterval(updateClock, 1000);
                setInterval(updateSystemStats, 2000);
                updateStatus('System ready. All files saved in IndexedDB.');
            });
            
            document.getElementById('view-guide').addEventListener('click', function() {
                document.getElementById('welcome-screen').style.display = 'none';
                initDesktop();
                initEventListeners();
                initDatabase();
                updateClock();
                setInterval(updateClock, 1000);
                openHelp();
            });
            
            // Auto-start after 3 seconds
            setTimeout(function() {
                if (document.getElementById('welcome-screen').style.display !== 'none') {
                    document.getElementById('welcome-screen').style.display = 'none';
                    initDesktop();
                    initEventListeners();
                    initDatabase();
                    updateClock();
                    setInterval(updateClock, 1000);
                    setInterval(updateSystemStats, 2000);
                    updateStatus('System ready. All files saved in IndexedDB.');
                }
            }, 3000);
            
            // Handle window resize for responsive layout
            window.addEventListener('resize', function() {
                // Update desktop grid if needed
                updateDesktopLayout();
            });
        }
        
        // Initialize desktop icons - FIXED FOR ALL SCREEN SIZES
        function initDesktop() {
            const desktop = document.getElementById('desktop');
            
            // Clear any existing icons
            desktop.innerHTML = '';
            
            // Create desktop icons for each app
            for (const appId in APP_REGISTRY) {
                const app = APP_REGISTRY[appId];
                const icon = document.createElement('div');
                icon.className = 'desktop-icon';
                icon.id = `desktop-icon-${appId}`;
                icon.innerHTML = `
                    <div class="icon-image">${app.icon}</div>
                    <div class="icon-label">${app.name}</div>
                `;
                icon.addEventListener('dblclick', function() {
                    app.open();
                });
                icon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectDesktopIcon(appId);
                });
                desktop.appendChild(icon);
            }
            
            // Add "Home" icon
            const homeIcon = document.createElement('div');
            homeIcon.className = 'desktop-icon';
            homeIcon.id = 'desktop-icon-home';
            homeIcon.innerHTML = `
                <div class="icon-image">üè†</div>
                <div class="icon-label">Home</div>
            `;
            homeIcon.addEventListener('dblclick', function() {
                openFileManager();
                navigateToFolder('user');
            });
            homeIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                selectDesktopIcon('home');
            });
            desktop.appendChild(homeIcon);
            
            // Add "Documents" icon
            const docsIcon = document.createElement('div');
            docsIcon.className = 'desktop-icon';
            docsIcon.id = 'desktop-icon-documents';
            docsIcon.innerHTML = `
                <div class="icon-image">üìÑ</div>
                <div class="icon-label">Documents</div>
            `;
            docsIcon.addEventListener('dblclick', function() {
                openFileManager();
                // Navigate to documents folder if it exists
                getFolderByPath('/home/user/documents').then(folder => {
                    if (folder) {
                        navigateToFolder(folder.id);
                    }
                });
            });
            docsIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                selectDesktopIcon('documents');
            });
            desktop.appendChild(docsIcon);
            
            // Add desktop text at the end
            const desktopText = document.createElement('div');
            desktopText.id = 'desktop-text';
            desktopText.textContent = 'LEGACY OS Linux v1.0 | Complete File System';
            desktop.appendChild(desktopText);
            
            // Desktop click listener to clear selection
            desktop.addEventListener('click', function(e) {
                if (e.target === desktop || e.target.id === 'desktop') {
                    clearDesktopSelection();
                }
            });
            
            // Desktop context menu
            desktop.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, 'desktop');
            });
            
            // Update layout initially
            updateDesktopLayout();
        }
        
        // Update desktop layout for responsive design
        function updateDesktopLayout() {
            const desktop = document.getElementById('desktop');
            const desktopWidth = desktop.clientWidth;
            
            // Calculate optimal number of columns based on available width
            const minIconWidth = 90; // Includes icon width + gap
            const columns = Math.max(2, Math.floor(desktopWidth / minIconWidth));
            
            // Update grid columns
            desktop.style.gridTemplateColumns = `repeat(${columns}, 90px)`;
        }
        
        // Initialize event listeners
        function initEventListeners() {
            // Start button - FIXED
            document.getElementById('start-button').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleStartMenu();
            });
            
            // Close start menu when clicking elsewhere
            document.addEventListener('click', function(e) {
                const startMenu = document.getElementById('start-menu');
                const startButton = document.getElementById('start-button');
                
                // If click is outside both start menu and start button
                if (!startMenu.contains(e.target) && !startButton.contains(e.target)) {
                    startMenu.style.display = 'none';
                }
            });
            
            // Start menu items
            document.getElementById('start-terminal').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                openTerminal();
            });
            
            document.getElementById('start-fileman').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                openFileManager();
            });
            
            document.getElementById('start-editor').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                openTextEditor();
            });
            
            document.getElementById('start-monitor').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                openSystemMonitor();
            });
            
            document.getElementById('start-help').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                openHelp();
            });
            
            document.getElementById('start-import').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                importFilesDialog();
            });
            
            document.getElementById('start-export').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                exportFilesDialog();
            });
            
            document.getElementById('start-about').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                openAbout();
            });
            
            document.getElementById('start-shutdown').addEventListener('click', function() {
                document.getElementById('start-menu').style.display = 'none';
                showDialog('Shutdown', 'Are you sure you want to shut down LEGACY OS?', true, 'shutdown');
            });
            
            // Context menu items
            document.getElementById('context-terminal').addEventListener('click', function() {
                hideContextMenu();
                openTerminal();
            });
            
            document.getElementById('context-refresh').addEventListener('click', function() {
                hideContextMenu();
                updateStatus('Desktop refreshed');
            });
            
            document.getElementById('context-new-folder').addEventListener('click', function() {
                hideContextMenu();
                showDialog('Create Folder', 'Enter folder name:', true, 'new-folder');
            });
            
            document.getElementById('context-new-file').addEventListener('click', function() {
                hideContextMenu();
                showDialog('Create File', 'Enter file name:', true, 'new-file');
            });
            
            document.getElementById('context-import').addEventListener('click', function() {
                hideContextMenu();
                importFilesDialog();
            });
            
            document.getElementById('context-export').addEventListener('click', function() {
                hideContextMenu();
                exportFilesDialog();
            });
            
            document.getElementById('context-about').addEventListener('click', function() {
                hideContextMenu();
                openAbout();
            });
            
            // File manager toolbar buttons
            document.getElementById('fm-home').addEventListener('click', function() {
                navigateToFolder('user');
            });
            
            document.getElementById('fm-up').addEventListener('click', function() {
                navigateUp();
            });
            
            document.getElementById('fm-new-folder').addEventListener('click', function() {
                showDialog('Create Folder', 'Enter folder name:', true, 'new-folder');
            });
            
            document.getElementById('fm-new-file').addEventListener('click', function() {
                showDialog('Create File', 'Enter file name:', true, 'new-file');
            });
            
            document.getElementById('fm-rename').addEventListener('click', function() {
                if (selectedFileItem) {
                    showDialog('Rename', `Enter new name for "${selectedFileItem.name}":`, true, 'rename-file');
                } else {
                    showDialog('Rename', 'Please select a file or folder first.');
                }
            });
            
            document.getElementById('fm-delete').addEventListener('click', function() {
                if (selectedFileItem) {
                    showDialog('Delete', `Are you sure you want to delete "${selectedFileItem.name}"?`, true, 'delete-file');
                } else {
                    showDialog('Delete', 'Please select a file or folder first.');
                }
            });
            
            document.getElementById('fm-properties').addEventListener('click', function() {
                if (selectedFileItem) {
                    showFileProperties(selectedFileItem);
                } else {
                    showDialog('Properties', 'Please select a file or folder first.');
                }
            });
            
            document.getElementById('fm-refresh').addEventListener('click', function() {
                refreshFileManager();
            });
            
            // Text editor toolbar buttons
            document.getElementById('te-new').addEventListener('click', function() {
                newTextFile();
            });
            
            document.getElementById('te-open').addEventListener('click', function() {
                openFileDialog();
            });
            
            document.getElementById('te-save').addEventListener('click', function() {
                saveCurrentFile();
            });
            
            document.getElementById('te-saveas').addEventListener('click', function() {
                saveAsDialog();
            });
            
            document.getElementById('te-close').addEventListener('click', function() {
                closeTextEditor();
            });
            
            // System monitor buttons
            document.getElementById('sm-export-all').addEventListener('click', function() {
                exportAllFiles();
            });
            
            document.getElementById('sm-clear-db').addEventListener('click', function() {
                showDialog('Clear Database', 'Are you sure you want to clear all files? This cannot be undone.', true, 'clear-database');
            });
            
            // Modal buttons
            document.getElementById('modal-cancel').addEventListener('click', function() {
                hideModal();
            });
            
            document.getElementById('modal-ok').addEventListener('click', function() {
                const dialogType = document.getElementById('modal-dialog').getAttribute('data-type');
                handleDialogOk(dialogType);
            });
            
            // Terminal input handler
            document.getElementById('terminal-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    processCommand(this.value);
                    this.value = '';
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateCommandHistory('up');
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateCommandHistory('down');
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    autoCompleteCommand(this.value);
                }
            });
            
            // Text editor change handler
            document.getElementById('text-editor-area').addEventListener('input', function() {
                editorIsModified = true;
                if (currentEditorFile) {
                    document.querySelector('#text-editor .window-header span').textContent = 
                        `Text Editor - ${currentEditorFile.name} *`;
                } else {
                    document.querySelector('#text-editor .window-header span').textContent = 
                        'Text Editor - [unnamed] *';
                }
            });
            
            // Initialize window dragging and resizing
            initWindowDragging();
            initWindowResizing();
            
            // Initialize all window controls
            initAllWindowControls();
            
            // File import handler
            document.getElementById('file-import-input').addEventListener('change', function(e) {
                handleFileImport(e.target.files);
                e.target.value = ''; // Reset input
            });
        }
        
        // Toggle start menu - FIXED
        function toggleStartMenu() {
            const startMenu = document.getElementById('start-menu');
            if (startMenu.style.display === 'block') {
                startMenu.style.display = 'none';
            } else {
                startMenu.style.display = 'block';
                // Bring to front
                startMenu.style.zIndex = ++zIndexCounter;
            }
        }
        
        // Select desktop icon
        function selectDesktopIcon(iconId) {
            clearDesktopSelection();
            
            selectedDesktopIcon = iconId;
            const iconElement = document.getElementById(`desktop-icon-${iconId}`);
            if (iconElement) {
                iconElement.classList.add('selected');
            }
        }
        
        // Clear desktop selection
        function clearDesktopSelection() {
            if (selectedDesktopIcon) {
                const iconElement = document.getElementById(`desktop-icon-${selectedDesktopIcon}`);
                if (iconElement) {
                    iconElement.classList.remove('selected');
                }
                selectedDesktopIcon = null;
            }
        }
        
        // Show context menu
        function showContextMenu(x, y, context) {
            const contextMenu = document.getElementById('desktop-context-menu');
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.display = 'block';
            contextMenu.style.zIndex = ++zIndexCounter;
            
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu);
            }, 10);
        }
        
        // Hide context menu
        function hideContextMenu() {
            document.getElementById('desktop-context-menu').style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
        }
        
        // Update clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('clock').textContent = timeString;
        }
        
        // Initialize IndexedDB database
        function initDatabase() {
            const request = indexedDB.open('LegacyOSFileSystem', 2);
            
            request.onerror = function(event) {
                console.error('Database error:', event.target.error);
                showDialog('Database Error', 'Unable to initialize database. Some features may not work properly.');
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                const oldVersion = event.oldVersion;
                
                if (oldVersion < 1) {
                    // Create object store for files
                    const fileStore = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                    fileStore.createIndex('parentId', 'parentId', { unique: false });
                    fileStore.createIndex('path', 'path', { unique: false });
                    fileStore.createIndex('type', 'type', { unique: false });
                    fileStore.createIndex('name', 'name', { unique: false });
                    
                    // Create object store for settings
                    db.createObjectStore('settings', { keyPath: 'key' });
                    
                    // Add initial files
                    const transaction = event.target.transaction;
                    const files = transaction.objectStore('files');
                    
                    // Create root directory
                    files.add({
                        id: 'root',
                        name: '/',
                        path: '/',
                        type: 'folder',
                        parentId: null,
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        size: 0
                    });
                    
                    // Create home directory
                    files.add({
                        id: 'home',
                        name: 'home',
                        path: '/home',
                        type: 'folder',
                        parentId: 'root',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        size: 0
                    });
                    
                    // Create user directory
                    files.add({
                        id: 'user',
                        name: 'user',
                        path: '/home/user',
                        type: 'folder',
                        parentId: 'home',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        size: 0
                    });
                    
                    // Create documents folder
                    files.add({
                        id: 'documents',
                        name: 'documents',
                        path: '/home/user/documents',
                        type: 'folder',
                        parentId: 'user',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        size: 0
                    });
                    
                    // Create a sample text file
                    files.add({
                        name: 'readme.txt',
                        path: '/home/user/readme.txt',
                        type: 'file',
                        content: 'Welcome to LEGACY OS Linux Edition!\n\nThis is a sample text file stored in IndexedDB.\nYou can edit this file using the text editor or CLI.\n\nAll files are saved in your browser\'s storage and persist between sessions.\n\nType "help" in the terminal for available commands.',
                        parentId: 'user',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        size: 365
                    });
                    
                    // Create another sample file
                    files.add({
                        name: 'todo.txt',
                        path: '/home/user/todo.txt',
                        type: 'file',
                        content: 'TODO List:\n1. Explore LEGACY OS file system\n2. Try CLI commands\n3. Create new files and folders\n4. Import/export files\n5. Learn about IndexedDB storage',
                        parentId: 'user',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        size: 185
                    });
                }
                
                if (oldVersion < 2) {
                    // Add size field to existing files
                    const transaction = event.target.transaction;
                    const fileStore = transaction.objectStore('files');
                    const request = fileStore.getAll();
                    
                    request.onsuccess = function(event) {
                        const files = event.target.result;
                        files.forEach(file => {
                            if (file.type === 'file' && !file.size) {
                                file.size = file.content ? file.content.length : 0;
                                fileStore.put(file);
                            } else if (file.type === 'folder' && !file.size) {
                                file.size = 0;
                                fileStore.put(file);
                            }
                        });
                    };
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                updateStatus('File system initialized');
                refreshFileManager();
                updateDBInfo();
            };
        }
        
        // Open terminal
        function openTerminal() {
            const termWindow = openWindow('terminal');
            document.getElementById('terminal-input').focus();
            
            // Add welcome message if terminal is empty
            const history = document.getElementById('terminal-history');
            if (history.children.length === 0) {
                addTerminalOutput('LEGACY OS Linux Terminal v1.0');
                addTerminalOutput('Complete file system with IndexedDB storage');
                addTerminalOutput('Type "help" for available commands');
                addTerminalOutput('');
            }
        }
        
        // Process CLI command
        function processCommand(command) {
            if (!command.trim()) {
                addTerminalOutput('');
                return;
            }
            
            // Add command to history
            commandHistory.push(command);
            historyIndex = commandHistory.length;
            
            // Show command in terminal
            addTerminalOutput(`[user@legacyos ~]$ ${command}`);
            
            // Parse command
            const parts = command.trim().split(/\s+/);
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);
            
            // Execute command
            if (COMMANDS[cmd]) {
                COMMANDS[cmd].execute(args);
            } else {
                addTerminalOutput(`bash: ${cmd}: command not found`, 'error');
                addTerminalOutput(`Type 'help' for available commands`);
            }
            
            // Scroll to bottom
            const terminalOutput = document.getElementById('terminal-output');
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }
        
        // Add output to terminal
        function addTerminalOutput(text, type = 'normal') {
            const history = document.getElementById('terminal-history');
            const output = document.createElement('div');
            output.className = 'cli-output';
            
            if (type === 'error') {
                output.classList.add('cli-error');
            } else if (type === 'success') {
                output.classList.add('cli-success');
            } else if (type === 'directory') {
                output.classList.add('cli-directory');
            }
            
            output.textContent = text;
            history.appendChild(output);
            
            // Keep only last 100 lines
            if (history.children.length > 100) {
                history.removeChild(history.children[0]);
            }
        }
        
        // Navigate command history
        function navigateCommandHistory(direction) {
            const input = document.getElementById('terminal-input');
            
            if (commandHistory.length === 0) return;
            
            if (direction === 'up') {
                if (historyIndex > 0) {
                    historyIndex--;
                }
            } else if (direction === 'down') {
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                } else {
                    historyIndex = commandHistory.length;
                    input.value = '';
                    return;
                }
            }
            
            if (historyIndex >= 0 && historyIndex < commandHistory.length) {
                input.value = commandHistory[historyIndex];
            }
        }
        
        // Auto-complete command
        function autoCompleteCommand(partial) {
            if (!partial) return;
            
            const matches = Object.keys(COMMANDS).filter(cmd => 
                cmd.startsWith(partial.toLowerCase())
            );
            
            if (matches.length === 1) {
                document.getElementById('terminal-input').value = matches[0];
            } else if (matches.length > 1) {
                addTerminalOutput('');
                matches.forEach(cmd => {
                    addTerminalOutput(`${cmd} - ${COMMANDS[cmd].description}`);
                });
                addTerminalOutput('');
            }
        }
        
        // CLI Command Implementations
        
        function cmdHelp(args) {
            addTerminalOutput('Available commands:');
            addTerminalOutput('');
            
            for (const cmd in COMMANDS) {
                addTerminalOutput(`${cmd.padEnd(12)} - ${COMMANDS[cmd].description}`);
            }
            
            addTerminalOutput('');
            addTerminalOutput('Type "man [command]" for detailed help');
        }
        
        function cmdLs(args) {
            const path = args[0] || currentPath;
            
            // Convert path to folder ID
            getFolderByPath(path).then(folder => {
                if (!folder) {
                    addTerminalOutput(`ls: cannot access '${path}': No such file or directory`, 'error');
                    return;
                }
                
                // Get files in folder
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const parentIndex = fileStore.index('parentId');
                const request = parentIndex.getAll(folder.id);
                
                request.onsuccess = function(event) {
                    const files = event.target.result;
                    
                    if (files.length === 0) {
                        addTerminalOutput('(empty directory)');
                        return;
                    }
                    
                    // Group by type
                    const folders = files.filter(f => f.type === 'folder');
                    const fileList = files.filter(f => f.type === 'file');
                    
                    // Display
                    addTerminalOutput(`total ${files.length}`);
                    folders.forEach(folder => {
                        const date = new Date(folder.modified).toLocaleDateString();
                        addTerminalOutput(`drwxr-xr-x 1 user user ${folder.size.toString().padStart(8)} ${date} ${folder.name}/`, 'directory');
                    });
                    
                    fileList.forEach(file => {
                        const date = new Date(file.modified).toLocaleDateString();
                        addTerminalOutput(`-rw-r--r-- 1 user user ${file.size.toString().padStart(8)} ${date} ${file.name}`);
                    });
                };
            }).catch(error => {
                addTerminalOutput(`ls: cannot access '${path}': ${error}`, 'error');
            });
        }
        
        function cmdCd(args) {
            const path = args[0] || '/home/user';
            
            getFolderByPath(path).then(folder => {
                if (!folder) {
                    addTerminalOutput(`cd: ${path}: No such file or directory`, 'error');
                    return;
                }
                
                if (folder.type !== 'folder') {
                    addTerminalOutput(`cd: ${path}: Not a directory`, 'error');
                    return;
                }
                
                currentPath = folder.path;
                currentFolderId = folder.id;
                document.getElementById('current-path').textContent = `Path: ${currentPath}`;
                updateStatus(`Changed directory to ${currentPath}`);
                addTerminalOutput(`Directory changed to ${currentPath}`);
            }).catch(error => {
                addTerminalOutput(`cd: ${path}: ${error}`, 'error');
            });
        }
        
        function cmdPwd(args) {
            addTerminalOutput(currentPath);
        }
        
        function cmdMkdir(args) {
            if (args.length === 0) {
                addTerminalOutput('mkdir: missing operand', 'error');
                addTerminalOutput('Try: mkdir [dirname]');
                return;
            }
            
            const dirName = args[0];
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + dirName;
            
            // Check if already exists
            getFileByPath(newPath).then(existing => {
                if (existing) {
                    addTerminalOutput(`mkdir: cannot create directory '${dirName}': File exists`, 'error');
                    return;
                }
                
                // Create new folder
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                
                fileStore.add({
                    name: dirName,
                    path: newPath,
                    type: 'folder',
                    parentId: currentFolderId,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    size: 0
                });
                
                transaction.oncomplete = function() {
                    addTerminalOutput(`Directory '${dirName}' created`, 'success');
                    refreshFileManager();
                };
            });
        }
        
        function cmdTouch(args) {
            if (args.length === 0) {
                addTerminalOutput('touch: missing file operand', 'error');
                addTerminalOutput('Try: touch [filename]');
                return;
            }
            
            const fileName = args[0];
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            // Check if already exists
            getFileByPath(newPath).then(existing => {
                if (existing) {
                    // Update modification time
                    const transaction = db.transaction(['files'], 'readwrite');
                    const fileStore = transaction.objectStore('files');
                    existing.modified = new Date().toISOString();
                    fileStore.put(existing);
                    
                    transaction.oncomplete = function() {
                        addTerminalOutput(`File '${fileName}' timestamp updated`, 'success');
                        refreshFileManager();
                    };
                    return;
                }
                
                // Create new file
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                
                fileStore.add({
                    name: fileName,
                    path: newPath,
                    type: 'file',
                    content: '',
                    parentId: currentFolderId,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    size: 0
                });
                
                transaction.oncomplete = function() {
                    addTerminalOutput(`File '${fileName}' created`, 'success');
                    refreshFileManager();
                };
            });
        }
        
        function cmdCat(args) {
            if (args.length === 0) {
                addTerminalOutput('cat: missing file operand', 'error');
                addTerminalOutput('Try: cat [filename]');
                return;
            }
            
            const fileName = args[0];
            const filePath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            getFileByPath(filePath).then(file => {
                if (!file) {
                    addTerminalOutput(`cat: ${fileName}: No such file or directory`, 'error');
                    return;
                }
                
                if (file.type !== 'file') {
                    addTerminalOutput(`cat: ${fileName}: Is a directory`, 'error');
                    return;
                }
                
                if (file.content) {
                    addTerminalOutput(file.content);
                } else {
                    addTerminalOutput('(empty file)');
                }
            });
        }
        
        function cmdEdit(args) {
            if (args.length === 0) {
                addTerminalOutput('edit: missing file operand', 'error');
                addTerminalOutput('Try: edit [filename]');
                return;
            }
            
            const fileName = args[0];
            const filePath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            getFileByPath(filePath).then(file => {
                if (!file) {
                    addTerminalOutput(`edit: ${fileName}: No such file or directory`, 'error');
                    return;
                }
                
                if (file.type !== 'file') {
                    addTerminalOutput(`edit: ${fileName}: Is a directory`, 'error');
                    return;
                }
                
                openTextEditor(file);
                addTerminalOutput(`Opening ${fileName} in text editor`, 'success');
            });
        }
        
        function cmdRm(args) {
            if (args.length === 0) {
                addTerminalOutput('rm: missing operand', 'error');
                addTerminalOutput('Try: rm [filename]');
                return;
            }
            
            const fileName = args[0];
            const filePath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            getFileByPath(filePath).then(file => {
                if (!file) {
                    addTerminalOutput(`rm: cannot remove '${fileName}': No such file or directory`, 'error');
                    return;
                }
                
                if (file.type === 'folder') {
                    // Check if directory is empty
                    const transaction = db.transaction(['files'], 'readonly');
                    const fileStore = transaction.objectStore('files');
                    const parentIndex = fileStore.index('parentId');
                    const request = parentIndex.getAll(file.id);
                    
                    request.onsuccess = function(event) {
                        const children = event.target.result;
                        
                        if (children.length > 0) {
                            addTerminalOutput(`rm: cannot remove '${fileName}': Directory not empty`, 'error');
                            addTerminalOutput('Use "rmdir" to remove empty directories');
                            return;
                        }
                        
                        // Delete empty directory
                        const deleteTransaction = db.transaction(['files'], 'readwrite');
                        const deleteStore = deleteTransaction.objectStore('files');
                        deleteStore.delete(file.id);
                        
                        deleteTransaction.oncomplete = function() {
                            addTerminalOutput(`Directory '${fileName}' removed`, 'success');
                            refreshFileManager();
                        };
                    };
                    return;
                }
                
                // Delete file
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                fileStore.delete(file.id);
                
                transaction.oncomplete = function() {
                    addTerminalOutput(`File '${fileName}' removed`, 'success');
                    refreshFileManager();
                };
            });
        }
        
        function cmdRmdir(args) {
            if (args.length === 0) {
                addTerminalOutput('rmdir: missing operand', 'error');
                addTerminalOutput('Try: rmdir [dirname]');
                return;
            }
            
            const dirName = args[0];
            const dirPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + dirName;
            
            getFileByPath(dirPath).then(folder => {
                if (!folder) {
                    addTerminalOutput(`rmdir: failed to remove '${dirName}': No such file or directory`, 'error');
                    return;
                }
                
                if (folder.type !== 'folder') {
                    addTerminalOutput(`rmdir: failed to remove '${dirName}': Not a directory`, 'error');
                    return;
                }
                
                // Check if directory is empty
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const parentIndex = fileStore.index('parentId');
                const request = parentIndex.getAll(folder.id);
                
                request.onsuccess = function(event) {
                    const children = event.target.result;
                    
                    if (children.length > 0) {
                        addTerminalOutput(`rmdir: failed to remove '${dirName}': Directory not empty`, 'error');
                        return;
                    }
                    
                    // Delete empty directory
                    const deleteTransaction = db.transaction(['files'], 'readwrite');
                    const deleteStore = deleteTransaction.objectStore('files');
                    deleteStore.delete(folder.id);
                    
                    deleteTransaction.oncomplete = function() {
                        addTerminalOutput(`Directory '${dirName}' removed`, 'success');
                        refreshFileManager();
                    };
                };
            });
        }
        
        function cmdClear(args) {
            document.getElementById('terminal-history').innerHTML = '';
        }
        
        function cmdEcho(args) {
            addTerminalOutput(args.join(' '));
        }
        
        function cmdDate(args) {
            const now = new Date();
            addTerminalOutput(now.toString());
        }
        
        function cmdWhoami(args) {
            addTerminalOutput('user');
        }
        
        function cmdMan(args) {
            if (args.length === 0) {
                addTerminalOutput('man: missing command name', 'error');
                addTerminalOutput('Try: man [command]');
                return;
            }
            
            const cmd = args[0].toLowerCase();
            
            if (COMMANDS[cmd]) {
                addTerminalOutput(`NAME: ${cmd} - ${COMMANDS[cmd].description}`);
                addTerminalOutput(`USAGE: ${COMMANDS[cmd].usage}`);
                addTerminalOutput('');
                
                // Add command-specific help
                if (cmd === 'ls') {
                    addTerminalOutput('DESCRIPTION:');
                    addTerminalOutput('  List information about files and directories');
                    addTerminalOutput('');
                    addTerminalOutput('EXAMPLES:');
                    addTerminalOutput('  ls           List current directory');
                    addTerminalOutput('  ls /home     List /home directory');
                } else if (cmd === 'cd') {
                    addTerminalOutput('DESCRIPTION:');
                    addTerminalOutput('  Change the current working directory');
                    addTerminalOutput('');
                    addTerminalOutput('EXAMPLES:');
                    addTerminalOutput('  cd /home/user    Change to /home/user');
                    addTerminalOutput('  cd ..            Move up one directory');
                }
            } else {
                addTerminalOutput(`No manual entry for ${cmd}`, 'error');
            }
        }
        
        function cmdExportfs(args) {
            exportAllFilesToJSON().then(json => {
                addTerminalOutput('File system exported to JSON:', 'success');
                addTerminalOutput(json.substring(0, 500) + '...');
                addTerminalOutput('');
                addTerminalOutput('Full JSON available via export button in System Monitor');
            });
        }
        
        function cmdImportfs(args) {
            if (args.length === 0) {
                addTerminalOutput('importfs: missing JSON data', 'error');
                addTerminalOutput('Try: Use import button in System Monitor');
                return;
            }
            
            try {
                const json = args.join(' ');
                const data = JSON.parse(json);
                importFilesFromJSON(data).then(() => {
                    addTerminalOutput('File system imported successfully', 'success');
                }).catch(err => {
                    addTerminalOutput(`importfs: ${err}`, 'error');
                });
            } catch (err) {
                addTerminalOutput(`importfs: Invalid JSON: ${err}`, 'error');
            }
        }
        
        // Utility function to get folder by path
        function getFolderByPath(path) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                // Normalize path
                if (path === '~') path = '/home/user';
                if (path === '.') path = currentPath;
                if (path === '..') {
                    // Get parent path
                    const parts = currentPath.split('/').filter(p => p);
                    parts.pop();
                    path = '/' + parts.join('/');
                    if (path === '') path = '/';
                }
                
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const pathIndex = fileStore.index('path');
                const request = pathIndex.get(path);
                
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };
                
                request.onerror = function(event) {
                    reject('Path not found');
                };
            });
        }
        
        // Utility function to get file by path
        function getFileByPath(path) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const pathIndex = fileStore.index('path');
                const request = pathIndex.get(path);
                
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };
                
                request.onerror = function(event) {
                    reject('File not found');
                };
            });
        }
        
        // Open file manager
        function openFileManager() {
            openWindow('file-manager');
            refreshFileManager();
        }
        
        // Refresh file manager
        function refreshFileManager() {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const parentIndex = fileStore.index('parentId');
            const request = parentIndex.getAll(currentFolderId);
            
            request.onsuccess = function(event) {
                const files = event.target.result;
                const fileList = document.getElementById('file-manager-list');
                fileList.innerHTML = '';
                
                // Add "Up" folder if not in root
                if (currentFolderId !== 'root') {
                    const upFolder = document.createElement('div');
                    upFolder.className = 'file-item';
                    upFolder.innerHTML = `
                        <div style="font-size: 32px;">‚¨ÜÔ∏è</div>
                        <span>..</span>
                    `;
                    upFolder.addEventListener('dblclick', function() {
                        navigateUp();
                    });
                    upFolder.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectFileItem(null);
                    });
                    fileList.appendChild(upFolder);
                }
                
                // Display files and folders
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.id = file.id;
                    fileItem.dataset.name = file.name;
                    fileItem.dataset.type = file.type;
                    
                    const icon = file.type === 'folder' ? 'üìÅ' : 'üìÑ';
                    fileItem.innerHTML = `
                        <div style="font-size: 32px;">${icon}</div>
                        <span>${file.name}</span>
                    `;
                    
                    fileItem.addEventListener('dblclick', function() {
                        if (file.type === 'folder') {
                            navigateToFolder(file.id);
                        } else {
                            openFile(file);
                        }
                    });
                    
                    fileItem.addEventListener('click', function(e) {
                        e.stopPropagation();
                        selectFileItem(file);
                    });
                    
                    fileItem.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        selectFileItem(file);
                        // Could add file-specific context menu here
                    });
                    
                    fileList.appendChild(fileItem);
                });
                
                // Update window title
                document.querySelector('#file-manager .window-header span').textContent = 
                    `File Manager - ${currentPath}`;
            };
        }
        
        // Navigate to a folder
        function navigateToFolder(folderId) {
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.get(folderId);
            
            request.onsuccess = function(event) {
                const folder = event.target.result;
                if (folder) {
                    currentFolderId = folder.id;
                    currentPath = folder.path;
                    document.getElementById('current-path').textContent = `Path: ${currentPath}`;
                    refreshFileManager();
                }
            };
        }
        
        // Navigate up one folder
        function navigateUp() {
            if (currentFolderId === 'root') return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.get(currentFolderId);
            
            request.onsuccess = function(event) {
                const file = event.target.result;
                if (file && file.parentId) {
                    const parentRequest = fileStore.get(file.parentId);
                    
                    parentRequest.onsuccess = function(event) {
                        const parent = event.target.result;
                        if (parent) {
                            currentFolderId = parent.id;
                            currentPath = parent.path;
                            document.getElementById('current-path').textContent = `Path: ${currentPath}`;
                            refreshFileManager();
                        }
                    };
                }
            };
        }
        
        // Select a file item
        function selectFileItem(file) {
            if (selectedFileItem) {
                const prevItem = document.querySelector(`.file-item[data-id="${selectedFileItem.id}"]`);
                if (prevItem) prevItem.classList.remove('selected');
            }
            
            if (!file) {
                selectedFileItem = null;
                return;
            }
            
            selectedFileItem = file;
            const item = document.querySelector(`.file-item[data-id="${file.id}"]`);
            if (item) item.classList.add('selected');
        }
        
        // Open a file
        function openFile(file) {
            if (file.type === 'file') {
                openTextEditor(file);
            }
        }
        
        // Open text editor
        function openTextEditor(file) {
            const editorWindow = openWindow('text-editor');
            const textarea = document.getElementById('text-editor-area');
            
            if (file) {
                textarea.value = file.content || '';
                currentEditorFile = file;
                editorIsModified = false;
                document.querySelector('#text-editor .window-header span').textContent = 
                    `Text Editor - ${file.name}`;
            } else {
                textarea.value = '';
                currentEditorFile = null;
                editorIsModified = true;
                document.querySelector('#text-editor .window-header span').textContent = 
                    'Text Editor - [unnamed] *';
            }
            
            textarea.focus();
        }
        
        // New text file
        function newTextFile() {
            if (editorIsModified && currentEditorFile) {
                if (!confirm('Save changes to current file?')) {
                    // User cancelled
                    return;
                }
                saveCurrentFile();
            }
            
            openTextEditor(null);
        }
        
        // Open file dialog
        function openFileDialog() {
            // Show file picker in file manager
            openFileManager();
            showDialog('Open File', 'Select a file from the file manager and double-click it.', false, 'info');
        }
        
        // Save current file
        function saveCurrentFile() {
            if (!currentEditorFile) {
                saveAsDialog();
                return;
            }
            
            const content = document.getElementById('text-editor-area').value;
            saveFile(currentEditorFile.id, content).then(() => {
                editorIsModified = false;
                document.querySelector('#text-editor .window-header span').textContent = 
                    `Text Editor - ${currentEditorFile.name}`;
                updateStatus(`Saved ${currentEditorFile.name}`);
            });
        }
        
        // Save as dialog
        function saveAsDialog() {
            const content = document.getElementById('text-editor-area').value;
            showDialog('Save As', 'Enter file name:', true, 'save-as');
        }
        
        // Close text editor
        function closeTextEditor() {
            if (editorIsModified) {
                if (confirm('Save changes before closing?')) {
                    saveCurrentFile();
                }
            }
            closeWindow('text-editor');
        }
        
        // Save file to database
        function saveFile(fileId, content) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                const request = fileStore.get(fileId);
                
                request.onsuccess = function(event) {
                    const file = event.target.result;
                    if (file) {
                        file.content = content;
                        file.size = content.length;
                        file.modified = new Date().toISOString();
                        fileStore.put(file);
                        
                        transaction.oncomplete = function() {
                            resolve();
                            refreshFileManager();
                        };
                        
                        transaction.onerror = function() {
                            reject('Failed to save file');
                        };
                    } else {
                        reject('File not found');
                    }
                };
            });
        }
        
        // Create new file in database
        function createFile(fileName, content, parentId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                // Get parent folder path
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                const parentRequest = fileStore.get(parentId || currentFolderId);
                
                parentRequest.onsuccess = function(event) {
                    const parent = event.target.result;
                    if (!parent) {
                        reject('Parent folder not found');
                        return;
                    }
                    
                    const newPath = parent.path + (parent.path.endsWith('/') ? '' : '/') + fileName;
                    
                    // Check if file already exists
                    const pathIndex = fileStore.index('path');
                    const existingRequest = pathIndex.get(newPath);
                    
                    existingRequest.onsuccess = function(event) {
                        if (event.target.result) {
                            reject('File already exists');
                            return;
                        }
                        
                        // Create new file
                        fileStore.add({
                            name: fileName,
                            path: newPath,
                            type: 'file',
                            content: content,
                            parentId: parent.id,
                            created: new Date().toISOString(),
                            modified: new Date().toISOString(),
                            size: content.length
                        });
                        
                        transaction.oncomplete = function() {
                            resolve();
                            refreshFileManager();
                        };
                        
                        transaction.onerror = function() {
                            reject('Failed to create file');
                        };
                    };
                };
            });
        }
        
        // Open system monitor
        function openSystemMonitor() {
            openWindow('system-monitor');
            updateSystemStats();
        }
        
        // Update system stats
        function updateSystemStats() {
            if (!db) return;
            
            // Get file system stats
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const countRequest = fileStore.count();
            
            countRequest.onsuccess = function(event) {
                const fileCount = event.target.result;
                
                // Get total size
                const sizeRequest = fileStore.getAll();
                sizeRequest.onsuccess = function(event) {
                    const files = event.target.result;
                    let totalSize = 0;
                    let fileCountActual = 0;
                    
                    files.forEach(file => {
                        if (file.type === 'file') {
                            totalSize += file.size || 0;
                            fileCountActual++;
                        }
                    });
                    
                    // Simulate system stats based on actual usage
                    const memoryPercent = Math.min(90, Math.floor(totalSize / 10000) + 40);
                    const cpuPercent = Math.floor(Math.random() * 30) + 20;
                    const storagePercent = Math.min(95, Math.floor(totalSize / 50000) + 30);
                    
                    document.getElementById('memory-bar').style.width = `${memoryPercent}%`;
                    document.getElementById('cpu-bar').style.width = `${cpuPercent}%`;
                    document.getElementById('storage-bar').style.width = `${storagePercent}%`;
                    
                    document.getElementById('memory-percent').textContent = `${memoryPercent}%`;
                    document.getElementById('cpu-percent').textContent = `${cpuPercent}%`;
                    document.getElementById('storage-percent').textContent = `${storagePercent}%`;
                    
                    document.getElementById('db-info').innerHTML = 
                        `Files in database: ${fileCount}<br>` +
                        `Total size: ${totalSize} bytes<br>` +
                        `Text files: ${fileCountActual}`;
                };
            };
        }
        
        // Update database info
        function updateDBInfo() {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const countRequest = fileStore.count();
            
            countRequest.onsuccess = function(event) {
                const fileCount = event.target.result;
                document.getElementById('db-info').textContent = 
                    `Files in database: ${fileCount}`;
            };
        }
        
        // Open help
        function openHelp() {
            openWindow('help-window');
        }
        
        // Open about
        function openAbout() {
            openWindow('about-window');
        }
        
        // Show file properties
        function showFileProperties(file) {
            const content = `
                <div class="file-properties">
                    <div class="property-row">
                        <div class="property-label">Name:</div>
                        <div class="property-value">${file.name}</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Type:</div>
                        <div class="property-value">${file.type === 'folder' ? 'Folder' : 'File'}</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Path:</div>
                        <div class="property-value">${file.path}</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Size:</div>
                        <div class="property-value">${file.size || 0} bytes</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Created:</div>
                        <div class="property-value">${new Date(file.created).toLocaleString()}</div>
                    </div>
                    <div class="property-row">
                        <div class="property-label">Modified:</div>
                        <div class="property-value">${new Date(file.modified).toLocaleString()}</div>
                    </div>
                </div>
            `;
            showDialog('Properties', content);
        }
        
        // Import files dialog
        function importFilesDialog() {
            document.getElementById('file-import-input').click();
        }
        
        // Handle file import
        function handleFileImport(fileList) {
            if (!fileList || fileList.length === 0) return;
            
            let importedCount = 0;
            let errorCount = 0;
            
            Array.from(fileList).forEach(file => {
                if (file.type.startsWith('text/') || file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        const fileName = file.name;
                        
                        createFile(fileName, content, currentFolderId).then(() => {
                            importedCount++;
                            updateStatus(`Imported ${fileName}`);
                            
                            if (importedCount + errorCount === fileList.length) {
                                showDialog('Import Complete', 
                                    `Imported ${importedCount} file(s)${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
                            }
                        }).catch(err => {
                            errorCount++;
                            console.error('Failed to import file:', err);
                            
                            if (importedCount + errorCount === fileList.length) {
                                showDialog('Import Complete', 
                                    `Imported ${importedCount} file(s)${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
                            }
                        });
                    };
                    reader.readAsText(file);
                } else {
                    errorCount++;
                    console.warn('Unsupported file type:', file.type);
                    
                    if (importedCount + errorCount === fileList.length) {
                        showDialog('Import Complete', 
                            `Imported ${importedCount} file(s)${errorCount > 0 ? `, ${errorCount} failed (unsupported type)` : ''}`);
                    }
                }
            });
        }
        
        // Export files dialog
        function exportFilesDialog() {
            const content = `
                <div class="save-dialog-options">
                    <p>Export options:</p>
                    <div class="save-option">
                        <button class="dialog-button" onclick="exportCurrentFolder()" style="width: 100%;">Export Current Folder</button>
                    </div>
                    <div class="save-option">
                        <button class="dialog-button" onclick="exportAllFiles()" style="width: 100%;">Export All Files</button>
                    </div>
                    <div class="save-option">
                        <button class="dialog-button" onclick="exportSelectedFile()" style="width: 100%;" ${selectedFileItem ? '' : 'disabled'}>Export Selected File</button>
                    </div>
                </div>
            `;
            showDialog('Export Files', content);
        }
        
        // Export current folder
        function exportCurrentFolder() {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const parentIndex = fileStore.index('parentId');
            const request = parentIndex.getAll(currentFolderId);
            
            request.onsuccess = function(event) {
                const files = event.target.result;
                const exportData = {
                    folder: currentPath,
                    files: files.filter(f => f.type === 'file'),
                    folders: files.filter(f => f.type === 'folder'),
                    exported: new Date().toISOString()
                };
                
                const json = JSON.stringify(exportData, null, 2);
                downloadFile(`${currentPath.replace(/\//g, '_')}_export.json`, json);
                hideModal();
                updateStatus(`Exported folder ${currentPath}`);
            };
        }
        
        // Export all files
        function exportAllFiles() {
            exportAllFilesToJSON().then(json => {
                downloadFile('legacyos_full_export.json', json);
                updateStatus('Exported all files');
            });
        }
        
        // Export all files to JSON
        function exportAllFilesToJSON() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                const transaction = db.transaction(['files'], 'readonly');
                const fileStore = transaction.objectStore('files');
                const request = fileStore.getAll();
                
                request.onsuccess = function(event) {
                    const files = event.target.result;
                    const exportData = {
                        files: files,
                        exported: new Date().toISOString(),
                        version: '1.0'
                    };
                    
                    resolve(JSON.stringify(exportData, null, 2));
                };
                
                request.onerror = function() {
                    reject('Failed to export files');
                };
            });
        }
        
        // Import files from JSON
        function importFilesFromJSON(jsonData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Database not available');
                    return;
                }
                
                const transaction = db.transaction(['files'], 'readwrite');
                const fileStore = transaction.objectStore('files');
                
                // Clear existing files (except root)
                const clearRequest = fileStore.getAllKeys();
                
                clearRequest.onsuccess = function(event) {
                    const keys = event.target.result;
                    keys.forEach(key => {
                        if (key !== 'root' && key !== 'home' && key !== 'user') {
                            fileStore.delete(key);
                        }
                    });
                    
                    // Import new files
                    jsonData.files.forEach(file => {
                        if (file.id !== 'root' && file.id !== 'home' && file.id !== 'user') {
                            fileStore.add(file);
                        }
                    });
                    
                    transaction.oncomplete = function() {
                        resolve();
                        refreshFileManager();
                        updateDBInfo();
                    };
                    
                    transaction.onerror = function() {
                        reject('Failed to import files');
                    };
                };
            });
        }
        
        // Export selected file
        function exportSelectedFile() {
            if (!selectedFileItem || selectedFileItem.type !== 'file') {
                showDialog('Export', 'Please select a file first.');
                return;
            }
            
            const content = selectedFileItem.content || '';
            downloadFile(selectedFileItem.name, content);
            updateStatus(`Exported ${selectedFileItem.name}`);
        }
        
        // Download file helper
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const anchor = document.getElementById('file-export-anchor');
            anchor.href = url;
            anchor.download = filename;
            anchor.click();
            URL.revokeObjectURL(url);
        }
        
        // Open a window
        function openWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            
            // Bring to front if already open
            if (windowElement.style.display === 'flex') {
                windowElement.style.zIndex = ++zIndexCounter;
                return windowElement;
            }
            
            // Show window
            windowElement.style.display = 'flex';
            windowElement.style.zIndex = ++zIndexCounter;
            
            // Position window
            const offset = activeWindows.length * 20;
            windowElement.style.top = `${50 + offset}px`;
            windowElement.style.left = `${50 + offset}px`;
            
            // Set minimum size
            windowElement.style.width = '400px';
            windowElement.style.height = '300px';
            
            // Add to active windows
            activeWindows.push(windowId);
            
            // Add to taskbar
            addToTaskbar(windowId);
            
            return windowElement;
        }
        
        // Initialize window dragging
        function initWindowDragging() {
            const windowHeaders = document.querySelectorAll('.window-header');
            
            windowHeaders.forEach(header => {
                header.addEventListener('mousedown', function(e) {
                    const windowElement = this.parentElement;
                    const isMaximized = windowElement.classList.contains('maximized');
                    
                    if (isMaximized) return;
                    
                    // Bring window to front
                    windowElement.style.zIndex = ++zIndexCounter;
                    
                    // Calculate initial positions
                    const rect = windowElement.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left;
                    const offsetY = e.clientY - rect.top;
                    
                    // Move window on mouse move
                    function onMouseMove(e) {
                        const newX = e.clientX - offsetX;
                        const newY = e.clientY - offsetY;
                        
                        // Keep window within bounds
                        const maxX = window.innerWidth - 50;
                        const maxY = window.innerHeight - 100;
                        
                        windowElement.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
                        windowElement.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
                    }
                    
                    // Remove event listeners on mouse up
                    function onMouseUp() {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    
                    e.stopPropagation();
                });
            });
        }
        
        // Initialize window resizing
        function initWindowResizing() {
            // Add event listeners to all resize handles
            document.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('resize-handle')) {
                    startResizing(e.target, e.clientX, e.clientY);
                }
            });
        }
        
        // Start resizing a window
        function startResizing(handle, startX, startY) {
            const windowElement = handle.parentElement;
            const isMaximized = windowElement.classList.contains('maximized');
            
            if (isMaximized) return;
            
            // Bring window to front
            windowElement.style.zIndex = ++zIndexCounter;
            
            // Get initial dimensions and position
            const rect = windowElement.getBoundingClientRect();
            resizeStartX = startX;
            resizeStartY = startY;
            resizeStartWidth = rect.width;
            resizeStartHeight = rect.height;
            resizeStartLeft = rect.left;
            resizeStartTop = rect.top;
            currentResizeHandle = handle;
            isResizing = true;
            
            // Add event listeners for resizing
            function onMouseMove(e) {
                if (!isResizing) return;
                
                const dx = e.clientX - resizeStartX;
                const dy = e.clientY - resizeStartY;
                const handleClass = currentResizeHandle.className;
                
                let newWidth = resizeStartWidth;
                let newHeight = resizeStartHeight;
                let newLeft = resizeStartLeft;
                let newTop = resizeStartTop;
                
                // Calculate new dimensions based on which handle is being dragged
                if (handleClass.includes('e')) {
                    newWidth = Math.max(300, resizeStartWidth + dx);
                }
                if (handleClass.includes('s')) {
                    newHeight = Math.max(200, resizeStartHeight + dy);
                }
                if (handleClass.includes('w')) {
                    newWidth = Math.max(300, resizeStartWidth - dx);
                    newLeft = resizeStartLeft + dx;
                }
                if (handleClass.includes('n')) {
                    newHeight = Math.max(200, resizeStartHeight - dy);
                    newTop = resizeStartTop + dy;
                }
                
                // Apply new dimensions and position
                windowElement.style.width = `${newWidth}px`;
                windowElement.style.height = `${newHeight}px`;
                windowElement.style.left = `${newLeft}px`;
                windowElement.style.top = `${newTop}px`;
            }
            
            function onMouseUp() {
                isResizing = false;
                currentResizeHandle = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            
            e.stopPropagation();
        }
        
        // Initialize all window controls
        function initAllWindowControls() {
            // Terminal controls
            document.getElementById('terminal-minimize').addEventListener('click', () => minimizeWindow('terminal'));
            document.getElementById('terminal-maximize').addEventListener('click', () => toggleMaximizeWindow('terminal'));
            document.getElementById('terminal-close').addEventListener('click', () => closeWindow('terminal'));
            
            // File manager controls
            document.getElementById('file-manager-minimize').addEventListener('click', () => minimizeWindow('file-manager'));
            document.getElementById('file-manager-maximize').addEventListener('click', () => toggleMaximizeWindow('file-manager'));
            document.getElementById('file-manager-close').addEventListener('click', () => closeWindow('file-manager'));
            
            // Text editor controls
            document.getElementById('text-editor-minimize').addEventListener('click', () => minimizeWindow('text-editor'));
            document.getElementById('text-editor-maximize').addEventListener('click', () => toggleMaximizeWindow('text-editor'));
            document.getElementById('text-editor-close').addEventListener('click', () => closeWindow('text-editor'));
            
            // System monitor controls
            document.getElementById('system-monitor-minimize').addEventListener('click', () => minimizeWindow('system-monitor'));
            document.getElementById('system-monitor-maximize').addEventListener('click', () => toggleMaximizeWindow('system-monitor'));
            document.getElementById('system-monitor-close').addEventListener('click', () => closeWindow('system-monitor'));
            
            // Help window controls
            document.getElementById('help-minimize').addEventListener('click', () => minimizeWindow('help-window'));
            document.getElementById('help-maximize').addEventListener('click', () => toggleMaximizeWindow('help-window'));
            document.getElementById('help-close').addEventListener('click', () => closeWindow('help-window'));
            
            // About window controls
            document.getElementById('about-minimize').addEventListener('click', () => minimizeWindow('about-window'));
            document.getElementById('about-maximize').addEventListener('click', () => toggleMaximizeWindow('about-window'));
            document.getElementById('about-close').addEventListener('click', () => closeWindow('about-window'));
        }
        
        // Minimize window
        function minimizeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            windowElement.style.display = 'none';
            updateTaskbarButton(windowId, false);
        }
        
        // Toggle maximize window
        function toggleMaximizeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            const isMaximized = windowElement.classList.contains('maximized');
            
            if (isMaximized) {
                windowElement.classList.remove('maximized');
                windowElement.style.width = '400px';
                windowElement.style.height = '300px';
                windowElement.style.top = '50px';
                windowElement.style.left = '50px';
            } else {
                windowElement.classList.add('maximized');
            }
        }
        
        // Close window
        function closeWindow(windowId) {
            const windowElement = document.getElementById(windowId);
            windowElement.style.display = 'none';
            
            // Remove from active windows
            const index = activeWindows.indexOf(windowId);
            if (index > -1) {
                activeWindows.splice(index, 1);
            }
            
            // Remove from taskbar
            removeFromTaskbar(windowId);
            
            // Special handling for text editor
            if (windowId === 'text-editor') {
                if (editorIsModified && currentEditorFile) {
                    if (confirm('Save changes before closing?')) {
                        saveCurrentFile();
                    }
                }
                currentEditorFile = null;
                editorIsModified = false;
            }
        }
        
        // Add window to taskbar
        function addToTaskbar(windowId) {
            const taskbarPrograms = document.getElementById('taskbar-programs');
            const windowElement = document.getElementById(windowId);
            const windowTitle = windowElement.querySelector('.window-header span').textContent;
            
            // Check if already in taskbar
            if (document.getElementById(`taskbar-${windowId}`)) return;
            
            const taskbarButton = document.createElement('div');
            taskbarButton.className = 'taskbar-program';
            taskbarButton.id = `taskbar-${windowId}`;
            taskbarButton.textContent = windowTitle;
            
            taskbarButton.addEventListener('click', function() {
                const windowElement = document.getElementById(windowId);
                const isVisible = windowElement.style.display === 'flex';
                
                if (isVisible) {
                    minimizeWindow(windowId);
                } else {
                    windowElement.style.display = 'flex';
                    windowElement.style.zIndex = ++zIndexCounter;
                    updateTaskbarButton(windowId, true);
                }
            });
            
            taskbarPrograms.appendChild(taskbarButton);
            updateTaskbarButton(windowId, true);
        }
        
        // Update taskbar button state
        function updateTaskbarButton(windowId, isActive) {
            const button = document.getElementById(`taskbar-${windowId}`);
            if (button) {
                button.classList.toggle('active', isActive);
            }
        }
        
        // Remove window from taskbar
        function removeFromTaskbar(windowId) {
            const button = document.getElementById(`taskbar-${windowId}`);
            if (button) {
                button.remove();
            }
        }
        
        // Show dialog
        function showDialog(title, message, showInput = false, dialogType = 'info') {
            const modal = document.getElementById('modal-overlay');
            const modalDialog = document.getElementById('modal-dialog');
            
            document.getElementById('modal-header').textContent = title;
            document.getElementById('modal-body').innerHTML = message;
            
            if (showInput) {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = 'dialog-input';
                input.className = 'text-editor';
                input.style = 'width: 100%; margin-top: 8px;';
                input.autofocus = true;
                document.getElementById('modal-body').appendChild(input);
            }
            
            modalDialog.setAttribute('data-type', dialogType);
            modal.style.display = 'flex';
            modal.style.zIndex = ++zIndexCounter;
            
            // Focus input if present
            if (showInput) {
                setTimeout(() => {
                    document.getElementById('dialog-input').focus();
                }, 10);
            }
        }
        
        // Hide modal
        function hideModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }
        
        // Handle dialog OK button
        function handleDialogOk(dialogType) {
            const input = document.getElementById('dialog-input');
            const inputValue = input ? input.value.trim() : '';
            
            switch(dialogType) {
                case 'new-folder':
                    if (inputValue) {
                        createFolderInDB(inputValue);
                    }
                    break;
                    
                case 'new-file':
                    if (inputValue) {
                        createFileInDB(inputValue, '');
                    }
                    break;
                    
                case 'rename-file':
                    if (inputValue && selectedFileItem) {
                        renameFile(selectedFileItem.id, inputValue);
                    }
                    break;
                    
                case 'delete-file':
                    if (selectedFileItem) {
                        deleteFileFromDB(selectedFileItem.id);
                    }
                    break;
                    
                case 'save-as':
                    if (inputValue) {
                        const content = document.getElementById('text-editor-area').value;
                        createFile(inputValue, content, currentFolderId).then(() => {
                            updateStatus(`Saved as ${inputValue}`);
                        }).catch(err => {
                            showDialog('Save Error', `Failed to save: ${err}`);
                        });
                    }
                    break;
                    
                case 'clear-database':
                    clearDatabase();
                    break;
                    
                case 'shutdown':
                    // Show welcome screen again
                    document.getElementById('welcome-screen').style.display = 'flex';
                    // Close all windows
                    activeWindows.forEach(windowId => {
                        document.getElementById(windowId).style.display = 'none';
                        removeFromTaskbar(windowId);
                    });
                    activeWindows = [];
                    updateStatus('System shut down');
                    break;
            }
            
            hideModal();
        }
        
        // Create folder in database
        function createFolderInDB(folderName) {
            if (!db) return;
            
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + folderName;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            
            fileStore.add({
                name: folderName,
                path: newPath,
                type: 'folder',
                parentId: currentFolderId,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                size: 0
            });
            
            transaction.oncomplete = function() {
                refreshFileManager();
                updateStatus(`Folder "${folderName}" created`);
                addTerminalOutput(`Directory '${folderName}' created`, 'success');
            };
        }
        
        // Create file in database
        function createFileInDB(fileName, content) {
            if (!db) return;
            
            const newPath = currentPath + (currentPath.endsWith('/') ? '' : '/') + fileName;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            
            fileStore.add({
                name: fileName,
                path: newPath,
                type: 'file',
                content: content,
                parentId: currentFolderId,
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                size: content.length
            });
            
            transaction.oncomplete = function() {
                refreshFileManager();
                updateStatus(`File "${fileName}" created`);
                addTerminalOutput(`File '${fileName}' created`, 'success');
            };
        }
        
        // Rename file
        function renameFile(fileId, newName) {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            const request = fileStore.get(fileId);
            
            request.onsuccess = function(event) {
                const file = event.target.result;
                if (file) {
                    const oldPath = file.path;
                    const pathParts = oldPath.split('/');
                    pathParts[pathParts.length - 1] = newName;
                    const newPath = pathParts.join('/');
                    
                    file.name = newName;
                    file.path = newPath;
                    file.modified = new Date().toISOString();
                    fileStore.put(file);
                    
                    transaction.oncomplete = function() {
                        refreshFileManager();
                        updateStatus(`Renamed to ${newName}`);
                    };
                }
            };
        }
        
        // Delete file from database
        function deleteFileFromDB(fileId) {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            
            // For folders, also delete children
            const getRequest = fileStore.get(fileId);
            
            getRequest.onsuccess = function(event) {
                const file = event.target.result;
                if (file && file.type === 'folder') {
                    // Get children
                    const parentIndex = fileStore.index('parentId');
                    const childrenRequest = parentIndex.getAll(fileId);
                    
                    childrenRequest.onsuccess = function(event) {
                        const children = event.target.result;
                        children.forEach(child => {
                            fileStore.delete(child.id);
                        });
                        
                        // Delete the folder itself
                        fileStore.delete(fileId);
                        
                        transaction.oncomplete = function() {
                            refreshFileManager();
                            selectedFileItem = null;
                            updateStatus('Folder deleted');
                        };
                    };
                } else {
                    // Delete single file
                    fileStore.delete(fileId);
                    
                    transaction.oncomplete = function() {
                        refreshFileManager();
                        selectedFileItem = null;
                        updateStatus('File deleted');
                    };
                }
            };
        }
        
        // Clear database
        function clearDatabase() {
            if (!db) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            const clearRequest = fileStore.clear();
            
            clearRequest.onsuccess = function() {
                // Recreate basic structure
                fileStore.add({
                    id: 'root',
                    name: '/',
                    path: '/',
                    type: 'folder',
                    parentId: null,
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    size: 0
                });
                
                fileStore.add({
                    id: 'home',
                    name: 'home',
                    path: '/home',
                    type: 'folder',
                    parentId: 'root',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    size: 0
                });
                
                fileStore.add({
                    id: 'user',
                    name: 'user',
                    path: '/home/user',
                    type: 'folder',
                    parentId: 'home',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    size: 0
                });
                
                transaction.oncomplete = function() {
                    currentFolderId = 'user';
                    currentPath = '/home/user';
                    refreshFileManager();
                    updateDBInfo();
                    updateStatus('Database cleared');
                };
            };
        }
        
        // Update status bar
        function updateStatus(message) {
            const statusBar = document.getElementById('status-bar');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            statusBar.style.display = 'block';
            
            setTimeout(() => {
                statusBar.style.display = 'none';
            }, 3000);
        }
        
        // Global functions for export dialog
        window.exportCurrentFolder = exportCurrentFolder;
        window.exportAllFiles = exportAllFiles;
        window.exportSelectedFile = exportSelectedFile;
    </script>
</body>
</html>
