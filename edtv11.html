<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 9 - MEDICAL AR FITTING v3.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0ff;overflow:hidden;height:100dvh}
  #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column;background:#000}
  .grid,.crt{position:absolute;inset:0;pointer-events:none}
  .grid{background:linear-gradient(rgba(0,255,255,0.08)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,255,0.08)1px,transparent 1px);background-size:16px 16px;z-index:-1}
  .crt{background:linear-gradient(transparent 50%,rgba(0,40,80,0.1)50%);background-size:100% 4px;animation:scanlines 8s linear infinite}
  @keyframes scanlines{0%{background-position:0 0}100%{background-position:0 100%}}
  .banner{background:rgba(0,20,50,0.95);border-bottom:2px solid #0ff;padding:12px 8px;font-size:10px;text-align:center;text-shadow:0 0 10px #0ff}
  .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;padding-bottom:max(env(safe-area-inset-bottom,16px),16px)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;background:rgba(0,30,60,0.9);border:1px solid #0ff;box-shadow:0 0 10px rgba(0,255,255,0.5)}
  .btn{font-size:10px;padding:10px 14px;border:1px solid #0ff;background:#000;color:#0ff;cursor:pointer;box-shadow:0 0 8px #0ff;transition:.2s;flex:1 1 120px;max-width:280px}
  .btn-medical{border-color:#f00;color:#f00;box-shadow:0 0 8px #f00}
  .btn-medical:hover{background:#f00;color:#000}
  .dropdown{padding:8px;font-size:9px;border:1px solid #0ff;background:#000;color:#0ff;flex:1 1 100px;min-width:120px}
  .terminal{flex:none;height:18dvh;background:rgba(0,20,40,0.85);border:1px solid #0ff;padding:8px;font-size:9px;overflow-y:auto}
  .ar-view{flex:1;position:relative;border:2px solid #0ff;overflow:hidden;box-shadow:0 0 20px rgba(0,255,255,0.7);border-radius:4px}
  #video{width:100%;height:100%;object-fit:contain;background:#000;transform:scaleX(-1)}
  #view3d{position:absolute;inset:0;z-index:10}
  .medical-indicators{position:absolute;top:8px;left:8px;display:flex;flex-wrap:wrap;gap:6px;z-index:20}
  .indicator{padding:4px 8px;font-size:8px;border:1px solid #f00;background:rgba(255,0,0,0.7);box-shadow:0 0 8px #f00}
  .indicator.locked{background:rgba(0,255,0,0.8);border-color:#0f0;box-shadow:0 0 12px #0f0}
</style>
</head>
<body>
<div id="app">
  <div class="grid"></div><div class="crt"></div>
  <div class="banner">EDTV: CHANNEL 9 - MEDICAL AR FITTING v3.0</div>
  <div class="content">
    <div class="controls">
      <button class="btn btn-medical" id="start">SYNC / CALIBRATE / START</button>
      <button class="btn" id="enter-vr">ENTER VR/AR</button>
      <button class="btn" id="export">EXPORT JSON</button>
      <select class="dropdown" id="mask-select">
        <option value="surgical">SURGICAL</option>
        <option value="n95">N95</option>
        <option value="full_face">FULL SHIELD</option>
        <option value="goggle_mask">GOGGLES+MASK</option>
        <option value="tactical">TACTICAL</option>
      </select>
      <select class="dropdown" id="addon-select">
        <option value="none">NO ADDON</option>
        <option value="comms">COMMS</option>
        <option value="filter">FILTER</option>
        <option value="visor">VISOR</option>
        <option value="sensor">SENSORS</option>
      </select>
    </div>
    <div class="terminal" id="log">> SYSTEM READY</div>
    <div class="ar-view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="view3d"></canvas>
      <div class="medical-indicators">
        <div class="indicator" id="track">TRACKING: OFF</div>
        <div class="indicator" id="mask">MASK: NONE</div>
        <div class="indicator" id="addon">ADDON: NONE</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/loaders/GLTFLoader.js';
import {FaceLandmarker, FilesetResolver} from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs';

const video = document.getElementById('video');
const canvas = document.getElementById('view3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');
const addonEl = document.getElementById('addon');
let faceLandmarker, scene, camera, renderer, maskGroup = new THREE.Group();
let currentMask = null, currentAddon = null;
let calibrationOffset = new THREE.Vector2(0, 0.06);

const loader = new GLTFLoader();
const maskModels = {
  surgical: 'models/surgical_mask.glb',
  n95: 'models/n95_mask.glb',
  full_face: 'models/full_face_shield.glb',
  goggle_mask: 'models/goggles_mask.glb',
  tactical: 'models/tactical_mask.glb'
};
const addonModels = {
  comms: 'addons/comms.glb',
  filter: 'addons/filter.glb',
  visor: 'addons/visor.glb',
  sensor: 'addons/sensor.glb'
};

function log(m) { const d = document.createElement('div'); d.textContent = '> ' + m; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }

function init3D() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.01, 100);
  camera.position.z = 0.6;
  renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  renderer.xr.enabled = true;
  scene.add(new THREE.HemisphereLight(0xffffff, 0x0088ff, 1.8));
  scene.add(maskGroup);
  window.addEventListener('resize', () => {
    camera.aspect = canvas.clientWidth / canvas.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  });
}

function loadMask(type) {
  if (currentMask) maskGroup.remove(currentMask);
  loader.load(maskModels[type] || maskModels.surgical, gltf => {
    currentMask = gltf.scene;
    currentMask.scale.setScalar(0.8);
    maskGroup.add(currentMask);
    mask
