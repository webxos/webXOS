<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 9 - MEDICAL AR FITTING v3.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Courier New',monospace;image-rendering:pixelated}
  body{background:#000;color:#0ff;overflow:hidden;height:100dvh}
  #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column;background:#000}
  .grid,.crt{position:absolute;inset:0;pointer-events:none}
  .grid{background:linear-gradient(rgba(0,255,255,0.08)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,255,0.08)1px,transparent 1px);background-size:16px 16px;z-index:-1}
  .crt{background:linear-gradient(transparent 50%,rgba(0,40,80,0.1)50%);background-size:100% 4px;animation:scanlines 8s linear infinite}
  @keyframes scanlines{0%{background-position:0 0}100%{background-position:0 100%}}
  .banner{background:rgba(0,20,50,0.95);border-bottom:2px solid #0ff;padding:12px 8px;font-size:10px;text-align:center;text-shadow:0 0 10px #0ff}
  .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;padding-bottom:max(env(safe-area-inset-bottom,16px),16px)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;background:rgba(0,30,60,0.9);border:1px solid #0ff;box-shadow:0 0 10px rgba(0,255,255,0.5)}
  .btn{font-size:10px;padding:10px 14px;border:1px solid #0ff;background:#000;color:#0ff;cursor:pointer;box-shadow:0 0 8px #0ff;transition:.2s;flex:1 1 120px;max-width:280px}
  .btn-medical{border-color:#f00;color:#f00;box-shadow:0 0 8px #f00}
  .btn-medical:hover{background:#f00;color:#000}
  .dropdown{padding:8px;font-size:9px;border:1px solid #0ff;background:#000;color:#0ff;flex:1 1 100px;min-width:120px}
  .terminal{flex:none;height:18dvh;background:rgba(0,20,40,0.85);border:1px solid #0ff;padding:8px;font-size:9px;overflow-y:auto}
  .ar-view{flex:1;position:relative;border:2px solid #0ff;overflow:hidden;box-shadow:0 0 20px rgba(0,255,255,0.7);border-radius:4px}
  #video{width:100%;height:100%;object-fit:contain;background:#000;transform:scaleX(-1)}
  #view3d{position:absolute;inset:0;z-index:10}
  .medical-indicators{position:absolute;top:8px;left:8px;display:flex;flex-wrap:wrap;gap:6px;z-index:20}
  .indicator{padding:4px 8px;font-size:8px;border:1px solid #f00;background:rgba(255,0,0,0.7);box-shadow:0 0 8px #f00}
  .indicator.locked{background:rgba(0,255,0,0.8);border-color:#0f0;box-shadow:0 0 12px #0f0}
  
  /* Color Editor Styles */
  .color-editor{display:flex;flex-direction:column;gap:6px;padding:8px;background:rgba(0,30,60,0.9);border:1px solid #0ff;margin-top:8px}
  .color-control{display:flex;align-items:center;gap:8px}
  .color-label{font-size:8px;min-width:60px}
  .color-slider{flex:1;height:12px;-webkit-appearance:none;background:linear-gradient(to right,#000,#f00,#0f0,#00f,#fff);border:1px solid #0ff}
  .color-slider::-webkit-slider-thumb{width:12px;height:12px;background:#0ff;cursor:pointer}
  .color-preview{width:40px;height:20px;border:1px solid #0ff;background:#0ff}
  
  /* Mask Resize Controls */
  .size-controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .size-btn{flex:1;min-width:80px;font-size:8px;padding:6px;border:1px solid #0ff;background:#000;color:#0ff;cursor:pointer}
</style>
</head>
<body>
<div id="app">
  <div class="grid"></div><div class="crt"></div>
  <div class="banner">EDTV: CHANNEL 9 - MEDICAL AR FITTING v3.1</div>
  <div class="content">
    <div class="controls">
      <button class="btn btn-medical" id="start">SYNC / CALIBRATE / START</button>
      <button class="btn" id="enter-vr">ENTER VR/AR</button>
      <button class="btn" id="export">EXPORT JSON</button>
      <select class="dropdown" id="mask-select">
        <option value="surgical">SURGICAL</option>
        <option value="n95">N95</option>
        <option value="full_face">FULL SHIELD</option>
        <option value="goggle_mask">GOGGLES+MASK</option>
        <option value="tactical">TACTICAL</option>
      </select>
      <div class="size-controls">
        <button class="size-btn" id="size-down">SIZE -</button>
        <button class="size-btn" id="size-up">SIZE +</button>
        <button class="size-btn" id="reset-size">RESET SIZE</button>
      </div>
    </div>
    
    <div class="color-editor">
      <div class="color-control">
        <div class="color-label">HUE</div>
        <input type="range" min="0" max="360" value="180" class="color-slider" id="hue-slider">
        <div class="color-preview" id="hue-preview"></div>
      </div>
      <div class="color-control">
        <div class="color-label">SATURATION</div>
        <input type="range" min="0" max="100" value="100" class="color-slider" id="saturation-slider">
        <div class="color-preview" id="saturation-preview"></div>
      </div>
      <div class="color-control">
        <div class="color-label">BRIGHTNESS</div>
        <input type="range" min="0" max="100" value="100" class="color-slider" id="brightness-slider">
        <div class="color-preview" id="brightness-preview"></div>
      </div>
    </div>
    
    <div class="terminal" id="log">> SYSTEM READY</div>
    <div class="ar-view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="view3d"></canvas>
      <div class="medical-indicators">
        <div class="indicator" id="track">TRACKING: OFF</div>
        <div class="indicator" id="mask">MASK: NONE</div>
        <div class="indicator" id="color">COLOR: DEFAULT</div>
        <div class="indicator" id="size">SIZE: 100%</div>
      </div>
    </div>
  </div>
</div>

<script>
// Application state
const video = document.getElementById('video');
const canvas = document.getElementById('view3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');
const colorEl = document.getElementById('color');
const sizeEl = document.getElementById('size');

let isTracking = false;
let currentMaskType = 'surgical';
let maskSize = 1.0; // 100% size
let maskColor = { h: 180, s: 100, b: 100 }; // Default cyan color

// Mask definitions with base dimensions
const masks = {
  surgical: {
    name: 'SURGICAL',
    width: 120,
    height: 60,
    earLoopOffset: 40,
    draw: function(ctx, x, y, color, size) {
      const w = this.width * size;
      const h = this.height * size;
      const earOffset = this.earLoopOffset * size;
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      // Main mask body
      ctx.rect(x - w/2, y - h/2, w, h);
      
      // Ear loops
      ctx.moveTo(x - w/2, y - h/4);
      ctx.lineTo(x - w/2 - earOffset, y - h/2 - earOffset/2);
      ctx.moveTo(x + w/2, y - h/4);
      ctx.lineTo(x + w/2 + earOffset, y - h/2 - earOffset/2);
      
      // Nose bridge wire
      ctx.moveTo(x - w/4, y - h/2);
      ctx.lineTo(x + w/4, y - h/2);
      
      ctx.stroke();
    }
  },
  n95: {
    name: 'N95',
    width: 100,
    height: 80,
    curve: 20,
    draw: function(ctx, x, y, color, size) {
      const w = this.width * size;
      const h = this.height * size;
      const curve = this.curve * size;
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      // Curved mask body
      ctx.moveTo(x - w/2, y - h/4);
      ctx.quadraticCurveTo(x - w/4, y - h/2 - curve, x, y - h/2);
      ctx.quadraticCurveTo(x + w/4, y - h/2 - curve, x + w/2, y - h/4);
      ctx.lineTo(x + w/2, y + h/4);
      ctx.quadraticCurveTo(x + w/4, y + h/2 + curve, x, y + h/2);
      ctx.quadraticCurveTo(x - w/4, y + h/2 + curve, x - w/2, y + h/4);
      ctx.closePath();
      
      // Straps
      ctx.moveTo(x - w/2, y - h/4);
      ctx.lineTo(x - w/2 - 30*size, y - h/2);
      ctx.moveTo(x + w/2, y - h/4);
      ctx.lineTo(x + w/2 + 30*size, y - h/2);
      
      // Valve
      ctx.arc(x, y - h/8, 10*size, 0, Math.PI * 2);
      
      ctx.stroke();
    }
  },
  full_face: {
    name: 'FULL FACE SHIELD',
    width: 160,
    height: 120,
    draw: function(ctx, x, y, color, size) {
      const w = this.width * size;
      const h = this.height * size;
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      // Main shield
      ctx.rect(x - w/2, y - h/2, w, h);
      
      // Headband
      ctx.moveTo(x - w/2, y - h/2);
      ctx.lineTo(x - w/4, y - h/2 - 30*size);
      ctx.lineTo(x + w/4, y - h/2 - 30*size);
      ctx.lineTo(x + w/2, y - h/2);
      
      // Chin guard
      ctx.moveTo(x - w/4, y + h/2);
      ctx.lineTo(x, y + h/2 + 15*size);
      ctx.lineTo(x + w/4, y + h/2);
      
      ctx.stroke();
    }
  },
  goggle_mask: {
    name: 'GOGGLES + MASK',
    width: 140,
    height: 100,
    goggleRadius: 25,
    draw: function(ctx, x, y, color, size) {
      const w = this.width * size;
      const h = this.height * size;
      const goggleRadius = this.goggleRadius * size;
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      // Lower mask
      ctx.rect(x - w/2, y, w, h/2);
      
      // Goggles
      ctx.arc(x - w/4, y - goggleRadius/2, goggleRadius, 0, Math.PI * 2);
      ctx.moveTo(x + w/4 + goggleRadius, y - goggleRadius/2);
      ctx.arc(x + w/4, y - goggleRadius/2, goggleRadius, 0, Math.PI * 2);
      
      // Bridge between goggles
      ctx.moveTo(x - w/4 + goggleRadius, y - goggleRadius/2);
      ctx.lineTo(x + w/4 - goggleRadius, y - goggleRadius/2);
      
      // Straps
      ctx.moveTo(x - w/2, y + h/4);
      ctx.lineTo(x - w/2 - 30*size, y + h/8);
      ctx.moveTo(x + w/2, y + h/4);
      ctx.lineTo(x + w/2 + 30*size, y + h/8);
      
      ctx.stroke();
    }
  },
  tactical: {
    name: 'TACTICAL MASK',
    width: 140,
    height: 80,
    filterSize: 30,
    draw: function(ctx, x, y, color, size) {
      const w = this.width * size;
      const h = this.height * size;
      const filterSize = this.filterSize * size;
      
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      // Main mask body
      ctx.rect(x - w/2, y - h/2, w, h);
      
      // Filters
      ctx.rect(x - w/3, y - h/4, filterSize, filterSize/2);
      ctx.rect(x + w/3 - filterSize, y - h/4, filterSize, filterSize/2);
      
      // Ventilation holes
      for (let i = 0; i < 5; i++) {
        ctx.moveTo(x - w/4 + i*10*size, y + h/4);
        ctx.lineTo(x - w/4 + i*10*size, y + h/3);
      }
      
      // Head strap attachments
      ctx.moveTo(x - w/2, y - h/4);
      ctx.lineTo(x - w/2 - 20*size, y - h/2 - 10*size);
      ctx.moveTo(x + w/2, y - h/4);
      ctx.lineTo(x + w/2 + 20*size, y - h/2 - 10*size);
      
      ctx.stroke();
    }
  }
};

// Convert HSL to RGB
function hslToRgb(h, s, l) {
  h /= 360;
  s /= 100;
  l /= 100;
  
  let r, g, b;
  
  if (s === 0) {
    r = g = b = l;
  } else {
    const hue2rgb = (p, q, t) => {
      if (t < 0) t += 1;
      if (t > 1) t -= 1;
      if (t < 1/6) return p + (q - p) * 6 * t;
      if (t < 1/2) return q;
      if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
      return p;
    };
    
    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
    const p = 2 * l - q;
    
    r = hue2rgb(p, q, h + 1/3);
    g = hue2rgb(p, q, h);
    b = hue2rgb(p, q, h - 1/3);
  }
  
  return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

// Convert RGB to hex
function rgbToHex(r, g, b) {
  return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

// Get current color as hex
function getCurrentColor() {
  const rgb = hslToRgb(maskColor.h, maskColor.s, maskColor.b);
  return rgbToHex(rgb[0], rgb[1], rgb[2]);
}

// Update color previews
function updateColorPreviews() {
  const hueColor = rgbToHex(...hslToRgb(maskColor.h, 100, 50));
  const saturationColor = rgbToHex(...hslToRgb(maskColor.h, maskColor.s, 50));
  const brightnessColor = rgbToHex(...hslToRgb(maskColor.h, maskColor.s, maskColor.b));
  
  document.getElementById('hue-preview').style.backgroundColor = hueColor;
  document.getElementById('saturation-preview').style.backgroundColor = saturationColor;
  document.getElementById('brightness-preview').style.backgroundColor = brightnessColor;
  
  colorEl.textContent = `COLOR: ${getCurrentColor().toUpperCase()}`;
}

// Log function
function log(message) {
  const d = document.createElement('div');
  d.textContent = '> ' + message;
  logEl.appendChild(d);
  logEl.scrollTop = logEl.scrollHeight;
}

// Draw current mask
function drawMask() {
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (isTracking && masks[currentMaskType]) {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const color = getCurrentColor();
    
    masks[currentMaskType].draw(ctx, centerX, centerY, color, maskSize);
  }
}

// Animation loop
function animate() {
  drawMask();
  requestAnimationFrame(animate);
}

// Start AR simulation
async function startAR() {
  if (isTracking) return;
  
  log('SYNC + CALIBRATE + START');
  
  try {
    // Get camera access
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
    });
    
    video.srcObject = stream;
    video.play();
    
    isTracking = true;
    trackEl.textContent = 'TRACKING: LOCKED';
    trackEl.classList.add('locked');
    
    log('FACE TRACKING ACTIVE: SIMULATION MODE');
    log('CALIBRATING FACE CENTER... KEEP FACE STRAIGHT');
    
    // Simulate calibration
    setTimeout(() => {
      log('CALIBRATION COMPLETE: TRACKING STABLE');
    }, 2000);
    
  } catch (error) {
    log('CAMERA ERROR: ' + error.message);
    log('USING SIMULATION MODE WITHOUT CAMERA');
    isTracking = true;
    trackEl.textContent = 'TRACKING: SIMULATION';
  }
}

// Export JSON function
function exportJSON() {
  const exportData = {
    application: "EDTV: CHANNEL 9 - MEDICAL AR FITTING",
    version: "v3.1",
    timestamp: new Date().toISOString(),
    mask: currentMaskType,
    color: getCurrentColor(),
    size: Math.round(maskSize * 100) + "%",
    status: isTracking ? "TRACKING_ACTIVE" : "TRACKING_INACTIVE"
  };
  
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  
  // Create download link
  const link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = 'medical_ar_fitting_' + new Date().toISOString().replace(/:/g, '-') + '.json';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  log('EXPORT COMPLETE: CONFIGURATION DOWNLOADED');
}

// Initialize application
function initApp() {
  // Set up canvas
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  // Set up event listeners
  document.getElementById('start').addEventListener('click', startAR);
  document.getElementById('export').addEventListener('click', exportJSON);
  document.getElementById('enter-vr').addEventListener('click', () => {
    log('VR/AR MODE ACTIVATED: FULL IMMERSION');
  });
  
  // Mask selection
  document.getElementById('mask-select').addEventListener('change', (e) => {
    currentMaskType = e.target.value;
    maskEl.textContent = `MASK: ${masks[currentMaskType].name}`;
    log(`MASK SELECTED: ${masks[currentMaskType].name}`);
  });
  
  // Size controls
  document.getElementById('size-down').addEventListener('click', () => {
    maskSize = Math.max(0.5, maskSize - 0.1);
    sizeEl.textContent = `SIZE: ${Math.round(maskSize * 100)}%`;
    log(`MASK SIZE: ${Math.round(maskSize * 100)}%`);
  });
  
  document.getElementById('size-up').addEventListener('click', () => {
    maskSize = Math.min(2.0, maskSize + 0.1);
    sizeEl.textContent = `SIZE: ${Math.round(maskSize * 100)}%`;
    log(`MASK SIZE: ${Math.round(maskSize * 100)}%`);
  });
  
  document.getElementById('reset-size').addEventListener('click', () => {
    maskSize = 1.0;
    sizeEl.textContent = `SIZE: ${Math.round(maskSize * 100)}%`;
    log(`MASK SIZE RESET: ${Math.round(maskSize * 100)}%`);
  });
  
  // Color controls
  document.getElementById('hue-slider').addEventListener('input', (e) => {
    maskColor.h = parseInt(e.target.value);
    updateColorPreviews();
    log(`HUE ADJUSTED: ${maskColor.h}Â°`);
  });
  
  document.getElementById('saturation-slider').addEventListener('input', (e) => {
    maskColor.s = parseInt(e.target.value);
    updateColorPreviews();
    log(`SATURATION ADJUSTED: ${maskColor.s}%`);
  });
  
  document.getElementById('brightness-slider').addEventListener('input', (e) => {
    maskColor.b = parseInt(e.target.value);
    updateColorPreviews();
    log(`BRIGHTNESS ADJUSTED: ${maskColor.b}%`);
  });
  
  // Initialize UI
  maskEl.textContent = `MASK: ${masks[currentMaskType].name}`;
  updateColorPreviews();
  sizeEl.textContent = `SIZE: ${Math.round(maskSize * 100)}%`;
  
  // Start animation loop
  animate();
  
  log('SYSTEM READY: ALL MODULES INITIALIZED');
  log('COLOR EDITOR ACTIVE: CUSTOMIZE MASK APPEARANCE');
}

// Start the application when the page loads
window.addEventListener('DOMContentLoaded', initApp);

// Handle window resize
window.addEventListener('resize', () => {
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
});
</script>
</body>
</html>
