<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 9 - MEDICAL AR FITTING v2.7</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0ff;overflow:hidden;height:100dvh}
  #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column;background:#000}
  .grid,.crt{position:absolute;inset:0;pointer-events:none}
  .grid{background:linear-gradient(rgba(0,255,255,0.08)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,255,0.08)1px,transparent 1px);background-size:16px 16px;z-index:-1}
  .crt{background:linear-gradient(transparent 50%,rgba(0,40,80,0.1)50%);background-size:100% 4px;animation:scanlines 8s linear infinite}
  @keyframes scanlines{0%{background-position:0 0}100%{background-position:0 100%}}
  .banner{background:rgba(0,20,50,0.95);border-bottom:2px solid #0ff;padding:12px 8px;font-size:10px;text-align:center;text-shadow:0 0 10px #0ff}
  .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;padding-bottom:max(env(safe-area-inset-bottom,16px),16px)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;background:rgba(0,30,60,0.9);border:1px solid #0ff;box-shadow:0 0 10px rgba(0,255,255,0.5)}
  .btn{font-size:10px;padding:10px 14px;border:1px solid #0ff;background:#000;color:#0ff;cursor:pointer;box-shadow:0 0 8px #0ff;transition:.2s;flex:1 1 120px;max-width:280px}
  .btn-medical{border-color:#f00;color:#f00;box-shadow:0 0 8px #f00}
  .btn-medical:hover{background:#f00;color:#000}
  .dropdown{padding:8px;font-size:9px;border:1px solid #0ff;background:#000;color:#0ff;flex:1 1 100px;min-width:120px}
  .terminal{flex:none;height:18dvh;background:rgba(0,20,40,0.85);border:1px solid #0ff;padding:8px;font-size:9px;overflow-y:auto}
  .ar-view{flex:1;position:relative;border:2px solid #0ff;overflow:hidden;box-shadow:0 0 20px rgba(0,255,255,0.7);border-radius:4px}
  #video{width:100%;height:100%;object-fit:contain;background:#000;transform:scaleX(-1)}
  #view3d{position:absolute;inset:0;z-index:10}
  .medical-indicators{position:absolute;top:8px;left:8px;display:flex;flex-wrap:wrap;gap:6px;z-index:20}
  .indicator{padding:4px 8px;font-size:8px;border:1px solid #f00;background:rgba(255,0,0,0.7);box-shadow:0 0 8px #f00}
  .indicator.locked{background:rgba(0,255,0,0.8);border-color:#0f0;box-shadow:0 0 12px #0f0}
</style>
</head>
<body>
<div id="app">
  <div class="grid"></div><div class="crt"></div>
  <div class="banner">EDTV: CHANNEL 9 - MEDICAL AR FITTING v2.7</div>
  <div class="content">
    <div class="controls">
      <button class="btn btn-medical" id="start">SYNC / CALIBRATE / START</button>
      <button class="btn" id="enter-vr">ENTER VR/AR</button>
      <button class="btn" id="export">EXPORT JSON</button>
      <select class="dropdown" id="mask-select">
        <option value="surgical">SURGICAL</option>
        <option value="n95">N95</option>
        <option value="full_face">FULL SHIELD</option>
        <option value="goggle_mask">GOGGLES+MASK</option>
        <option value="tactical">TACTICAL</option>
      </select>
      <select class="dropdown" id="addon-select">
        <option value="none">NO ADDON</option>
        <option value="comms">COMMS</option>
        <option value="filter">FILTER</option>
        <option value="visor">VISOR</option>
        <option value="sensor">SENSORS</option>
      </select>
    </div>
    <div class="terminal" id="log">> SYSTEM READY</div>
    <div class="ar-view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="view3d"></canvas>
      <div class="medical-indicators">
        <div class="indicator" id="track">TRACKING: OFF</div>
        <div class="indicator" id="mask">MASK: NONE</div>
        <div class="indicator" id="addon">ADDON: NONE</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/loaders/GLTFLoader.js';
import {FaceLandmarker, FilesetResolver} from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs';

const video = document.getElementById('video');
const canvas = document.getElementById('view3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
let faceLandmarker, scene, camera, renderer, maskGroup = new THREE.Group();
let currentMask = null;
let calibrationOffset = new THREE.Vector2(0, 0.06); // will auto-calibrate

const loader = new GLTFLoader();
const maskModels = {
  surgical: 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/surgical_mask.glb',
  n95: 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/n95.glb',
  full_face: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf', // placeholder real models later
  goggle_mask: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
  tactical: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf'
};

function log(m) { const d = document.createElement('div'); d.textContent = '> ' + m; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }

function init3D() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.01, 100);
  camera.position.z = 0.6;
  renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  renderer.xr.enabled = true;
  scene.add(new THREE.HemisphereLight(0xffffff, 0x0088ff, 1.8));
  scene.add(maskGroup);
  window.addEventListener('resize', () => {
    camera.aspect = canvas.clientWidth / canvas.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  });
}

function loadRealMask(type) {
  if (currentMask) maskGroup.remove(currentMask);
  loader.load(maskModels[type] || maskModels.surgical, gltf => {
    currentMask = gltf.scene;
    currentMask.scale.setScalar(0.8);
    maskGroup.add(currentMask);
    log(`MASK LOADED: ${type.toUpperCase()}`);
  }, undefined, () => createProceduralMask(type));
}

function createProceduralMask(type) {
  // fallback realistic shapes
  const geo = type === 'n95' ? new THREE.SphereGeometry(0.1, 32, 16, 0, Math.PI*2, 0, Math.PI/2) :
             type === 'full_face' ? new THREE.CylinderGeometry(0.14, 0.14, 0.28, 32, 1, true) :
             new THREE.BoxGeometry(0.22, 0.13, 0.09);
  const mat = new THREE.MeshStandardMaterial({color: type==='surgical'?0xffffff:0x88aaff, roughness:0.6, metalness:0.1, transparent:true, opacity:0.9});
  const mesh = new THREE.Mesh(geo, mat);
  if (type==='full_face') mesh.rotation.x = Math.PI/2;
  maskGroup.add(mesh);
  currentMask = mesh;
}

function updateHeadPose(landmarks) {
  const lm = landmarks.map(p=>({x:1-p.x, y:p.y, z:p.z}));
  const nose = lm[1];
  const chin = lm[175];
  const leftEye = lm[33], rightEye = lm[263];

  // Better face center: midpoint between eyes + small downward offset
  const faceCenterX = (leftEye.x + rightEye.x) / 2;
  const faceCenterY = (leftEye.y + rightEye.y) / 2 + calibrationOffset.y;

  const faceWidth = Math.abs(rightEye.x - leftEye.x);
  const scale = THREE.MathUtils.lerp(1.2, 2.2, faceWidth * 8);

  maskGroup.position.x = (faceCenterX - 0.5) * 2.1;
  maskGroup.position.y = -(faceCenterY - 0.5) * 2.1 + calibrationOffset.x;
  maskGroup.scale.set(scale, scale, scale);

  // Simple rotation
  const yaw = (rightEye.x - leftEye.x) * 2.8;
  maskGroup.rotation.y = -yaw;
  maskGroup.rotation.x = (faceCenterY - nose.y) * 30;
}

let lastTime = 0;
function animate(t) {
  if (!lastTime) lastTime = t;
  if (t - lastTime > 33 && running && faceLandmarker) {
    lastTime = t;
    const results = faceLandmarker.detectForVideo(video, t);
    if (results.faceLandmarks?.[0]) {
      updateHeadPose(results.faceLandmarks[0]);
      trackEl.textContent = 'TRACKING: LOCKED';
      trackEl.classList.add('locked');
      // Auto-calibrate center on first 30 good frames
      if (calibrationFrames < 30) { calibrationOffset.y += 0.002; calibrationFrames++; }
    } else {
      trackEl.textContent = 'TRACKING: SEARCHING';
      trackEl.classList.remove('locked');
    }
  }
  renderer.render(scene, camera);
  if (!renderer.xr.isPresenting) requestAnimationFrame(animate);
}

let running = false, calibrationFrames = 0;

async function startAR() {
  if (running) return;
  log('SYNC + CALIBRATE + START');
  calibrationFrames = 0;
  calibrationOffset.set(0, 0.06);
  // same mediapipe init as before...
  const vision = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm');
  faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
    baseOptions: { modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task', delegate: 'GPU' },
    runningMode: 'VIDEO', numFaces: 1
  });
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user', width:{ideal:1280}, height:{ideal:720}}});
  video.srcObject = stream;
  video.play();
  running = true;
  requestAnimationFrame(animate);
  log('CALIBRATING FACE CENTER... KEEP FACE STRAIGHT');
}

document.getElementById('start').onclick = startAR;
document.getElementById('mask-select').onchange = e => loadRealMask(e.target.value);
document.getElementById('addon-select').onchange = () => log('Addons NYI in v2.7');

init3D();
loadRealMask('surgical');
requestAnimationFrame(animate);
</script>
</body>
</html>
