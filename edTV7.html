<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>edTV: CHANNEL 7</title>
    <meta name="theme-color" content="#000000">
    <meta name="description" content="edTV Channel 7: Object guessing app with face and hand detection in full screen webcam.">
    <meta name="keywords" content="AR, webcam, face detection, hand detection, object guessing">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
        body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
        #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
        .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3;z-index:0}
        .crt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;z-index:1;pointer-events:none;animation:scanline 8s linear infinite}
        @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
        .top-banner{position:absolute;top:0;left:0;width:100%;height:50px;background:rgba(255,0,255,0.9);border-bottom:2px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:12;animation:glitch 3s infinite}
        @keyframes glitch{0%,100%{transform:translateX(0)}5%{transform:translateX(-2px)}10%{transform:translateX(2px)}15%{transform:translateX(-1px)}20%{transform:translateX(1px)}25%{transform:translateX(0)}55%{transform:translateX(-1px) skewX(-2deg)}60%{transform:translateX(1px) skewX(2deg)}65%{transform:translateX(-1px) skewX(-1deg)}70%{transform:translateX(1px) skewX(1deg)}75%{transform:translateX(0)}}
        .top-banner-text{font-size:14px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
        .mirror-btn{width:200px;height:60px;background:#000;border:3px solid #0ff;color:#0ff;font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transform:skew(-2deg);transition:0.1s;position:absolute;top:70px;left:20px;z-index:11;padding:10px;margin-bottom:20px}
        .mirror-btn:hover,.mirror-btn:active,.mirror-btn.active{background:#0ff;color:#000}
        .ppv-face-view{position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:2;overflow:hidden}
        .ppv-canvas{width:100%;height:100%}
        .scanner{position:absolute;top:0;left:0;width:100%;height:4px;background:red;box-shadow:0 0 20px red;animation:scan 2s linear infinite;display:none}
        @keyframes scan{0%{top:0%}100%{top:100%}}
        .status-panel{position:absolute;top:70px;right:20px;font-size:10px;color:#0ff;z-index:11;background:rgba(0,0,0,0.7);padding:10px;border:1px solid #0ff}
        .guess-text{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);font-size:16px;color:#ff0;z-index:11;background:rgba(0,0,0,0.7);padding:10px;border:1px solid #ff0}
        #hudWarning{position:absolute;top:20%;left:50%;transform:translate(-50%,-50%);color:#f00;font-size:12px;text-shadow:1px 1px #000;z-index:11;display:none}
        #visualizationContainer{position:absolute;top:10px;right:10px;width:140px;height:105px;z-index:15;cursor:pointer;transition:0.3s;background:#000;border:2px solid #0ff;overflow:hidden}
        #visualizationContainer.expanded{width:300px;height:225px;z-index:20}
        @media(max-width:767px){.mirror-btn{width:180px;height:70px;font-size:16px;left:calc(50% - 90px);top:auto;bottom:100px}.status-panel{top:10px;right:10px;font-size:8px}.guess-text{font-size:14px;bottom:180px}}
    </style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt-overlay"></div>
    <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 7</div></div>
    <div class="ppv-face-view" id="ppvFaceView">
        <canvas class="ppv-canvas" id="ppvCanvas"></canvas>
        <div class="scanner" id="scanner"></div>
    </div>
    <div class="status-panel" id="statusPanel">
        FPS: <span id="fpsCounter">60</span><br>
        SCENE: <span id="sceneStatus">READY</span>
    </div>
    <div class="guess-text" id="guessDisplay">Guessing...</div>
    <div id="visualizationContainer"><canvas id="visualizationCanvas"></canvas></div>
    <button id="mirrorBtn" class="mirror-btn" aria-label="Start Scan">START SCAN</button>
    <div id="hudWarning">NO DETECTION - STAY IN CAMERA</div>
</div>

<script>
    let scene, cam, ren, controls, clock;
    let faceWireframe, handWireframes = [];
    let userDetected = false;
    let stream, faceMesh, hands, camera;
    let animationId = null;
    let frameCount = 0, lastFpsUpdate = 0;
    const fpsUpdateInterval = 1000;
    let worker;
    let faceScale = 12, handScale = 12;
    const targetScale = 10;

    const HAND_CONNECTIONS = [
        [0,1],[1,2],[2,3],[3,4],
        [0,5],[5,6],[6,7],[7,8],
        [5,9],[9,10],[10,11],[11,12],
        [9,13],[13,14],[14,15],[15,16],
        [13,17],[17,18],[18,19],[19,20],
        [0,17]
    ];

    const $ = s => document.querySelector(s);

    function init() {
        init3D();
        setupFaceDetection();
        setupHandDetection();
        setupServiceWorker();
        setupEventListeners();
        animate();
    }

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        cam = new THREE.PerspectiveCamera(75, 140/105, 0.1, 1000);
        cam.position.z = 5;
        ren = new THREE.WebGLRenderer({canvas: $('#visualizationCanvas'), antialias:false});
        ren.setSize(140, 105);
        ren.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        controls = new THREE.OrbitControls(cam, ren.domElement);
        controls.enableDamping = true;
        clock = new THREE.Clock();
        scene.add(new THREE.AmbientLight(0x003300));
        scene.add(new THREE.DirectionalLight(0x00ff00, 0.4).position.set(5,10,5));
        scene.add(new THREE.GridHelper(20,20,0x004400,0x002200));
        faceWireframe = createWireframe(468, 0x00ff00); // green for face
        scene.add(faceWireframe);
    }

    function createWireframe(numPoints, color) {
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(numPoints*3), 3));
        const mat = new THREE.LineBasicMaterial({color});
        return new THREE.LineSegments(geo, mat);
    }

    function updateWireframe(wireframe, landmarks, connections, scale) {
        const pos = wireframe.geometry.attributes.position.array;
        landmarks.forEach((lm, i) => {
            pos[i*3] = (lm.x - 0.5) * 2 * scale;
            pos[i*3 + 1] = -(lm.y - 0.5) * 2 * scale;
            pos[i*3 + 2] = lm.z * -2 * scale;
        });
        wireframe.geometry.attributes.position.needsUpdate = true;
        const indices = [];
        connections.forEach(([a,b]) => indices.push(a,b));
        wireframe.geometry.setIndex(indices);
    }

    function animateWireframe() {
        if (faceScale > targetScale) faceScale -= 0.1;
        if (handScale > targetScale) handScale -= 0.1;
    }

    function setupFaceDetection() {
        faceMesh = new FaceMesh({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        faceMesh.onResults(onFaceResults);
    }

    function setupHandDetection() {
        hands = new Hands({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
        hands.onResults(onHandResults);
    }

    function onFaceResults(results) {
        userDetected = !!results.multiFaceLandmarks?.length;
        const ppvCtx = $('#ppvCanvas').getContext('2d');
        ppvCtx.clearRect(0,0, ppvCtx.canvas.width, ppvCtx.canvas.height);
        if (results.image) ppvCtx.drawImage(results.image, 0, 0, ppvCtx.canvas.width, ppvCtx.canvas.height);
        if (userDetected) {
            const landmarks = results.multiFaceLandmarks[0];
            drawConnectors(ppvCtx, landmarks, FACEMESH_TESSELATION, {color: '#00FF00', lineWidth: 1}); // green
            updateWireframe(faceWireframe, landmarks, FACEMESH_TESSELATION, faceScale);
            if (worker) worker.postMessage({type: 'face'});
        }
        $('#hudWarning').style.display = userDetected ? 'none' : 'block';
    }

    function onHandResults(results) {
        const ppvCtx = $('#ppvCanvas').getContext('2d');
        if (results.multiHandLandmarks) {
            results.multiHandLandmarks.forEach((landmarks, i) => {
                drawConnectors(ppvCtx, landmarks, HAND_CONNECTIONS, {color: '#FF0000', lineWidth: 1}); // red
                if (!handWireframes[i]) {
                    handWireframes[i] = createWireframe(21, 0xFF0000);
                    scene.add(handWireframes[i]);
                }
                updateWireframe(handWireframes[i], landmarks, HAND_CONNECTIONS, handScale);
                if (worker) worker.postMessage({type: 'hand'});
            });
        }
    }

    async function setupServiceWorker() {
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('message', (event) => {
                    const data = event.data;
                    let guess = 'unknown object';
                    if (data.type === 'face') guess = Math.random() > 0.5 ? 'a face' : 'a mask?';
                    if (data.type === 'hand') guess = Math.random() > 0.5 ? 'a hand' : 'a glove?';
                    event.source.postMessage({guess});
                });
            `;
            const blob = new Blob([swCode], {type: 'application/javascript'});
            const url = URL.createObjectURL(blob);
            const reg = await navigator.serviceWorker.register(url);
            worker = reg.active || (await navigator.serviceWorker.ready).active;
            navigator.serviceWorker.addEventListener('message', (event) => {
                $('#guessDisplay').textContent = `Guess: ${event.data.guess}`;
            });
        }
    }

    function startWebcam() {
        navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}}).then(s => {
            stream = s;
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.style.display = 'none';
            document.body.appendChild(video);
            camera = new Camera(video, {
                onFrame: async () => {
                    await faceMesh.send({image: video});
                    await hands.send({image: video});
                },
                width: 640,
                height: 480
            });
            camera.start();
            $('#ppvCanvas').width = window.innerWidth;
            $('#ppvCanvas').height = window.innerHeight;
        }).catch(e => alert('Camera error'));
    }

    function setupEventListeners() {
        $('#mirrorBtn').addEventListener('click', () => {
            $('#mirrorBtn').classList.add('active');
            $('#mirrorBtn').textContent = 'SCANNING';
            startWebcam();
            $('#scanner').style.display = 'block';
            faceScale = 12;
            handScale = 12;
        });
        $('#visualizationContainer').addEventListener('click', () => {
            $('#visualizationContainer').classList.toggle('expanded');
            const w = $('#visualizationContainer').clientWidth;
            const h = $('#visualizationContainer').clientHeight;
            cam.aspect = w / h;
            cam.updateProjectionMatrix();
            ren.setSize(w, h);
        });
        window.addEventListener('resize', () => {
            $('#ppvCanvas').width = window.innerWidth;
            $('#ppvCanvas').height = window.innerHeight;
        });
    }

    function animate() {
        animationId = requestAnimationFrame(animate);
        controls.update();
        animateWireframe();
        ren.render(scene, cam);
        const now = performance.now();
        if (now - lastFpsUpdate > fpsUpdateInterval) {
            const fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
            $('#fpsCounter').textContent = fps;
            frameCount = 0;
            lastFpsUpdate = now;
        }
        frameCount++;
    }

    window.addEventListener('load', init);
</script>
</body>
</html>
