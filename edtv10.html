<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>edTV: CHANNEL 10</title>
<meta name="theme-color" content="#000000">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script type="module" src="https://unpkg.com/three@0.158.0/examples/jsm/webxr/ARButton.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
    #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
    #visualizationCanvas {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        display: block;
    }
    .matrix-grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3;pointer-events:none}
    .crt{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;pointer-events:none;animation:crt-scan 8s linear infinite}
    .scanline{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(255,0,255,0.03));background-size:100% 4px;animation:scan 6s linear infinite;pointer-events:none;opacity:0.6}
    @keyframes crt-scan{0%{background-position:0 0}100%{background-position:0 100%}}
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
   
    .top-banner{position:absolute;top:0;left:0;width:100%;height:40px;background:rgba(255,0,255,0.9);border-bottom:3px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:20;animation:g 3s infinite}
    @keyframes g{
        0%,100%{transform:translateX(0)}
        5%{transform:translateX(-2px)}
        10%{transform:translateX(2px)}
        55%{transform:translateX(-1px) skewX(-2deg)}
        60%{transform:translateX(1px) skewX(2deg)}
    }
    .top-banner-text{font-size:11px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
    /* Mobile-First Controls - Fixed Layout */
    .controls-container{
        position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
        display:flex;flex-direction:column;gap:12px;z-index:100;align-items:center;width:90%;max-width:400px;
    }
    .ctrl-btn{
        width:100%;max-width:300px;height:60px;background:#000;border:4px solid #0ff;color:#0ff;
        font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;
        box-shadow:4px 4px 0 #000;transform:skew(-3deg);transition:all .15s;
    }
    .ctrl-btn:hover,.ctrl-btn:active,.ctrl-btn.active{background:#0ff;color:#000}
    .export-btn{border-color:#f0f;color:#f0f}
    .export-btn:hover{background:#f0f;color:#000}
    /* Status + Error Log */
    .status-panel{
        position:fixed;top:50px;right:10px;background:rgba(0,0,0,0.9);border:2px solid #0ff;padding:8px;
        font-size:7px;color:#0ff;z-index:15;line-height:1.4;max-width:180px;
    }
    #errorLog{
        position:fixed;top:50px;left:10px;background:rgba(0,0,0,0.95);border:3px double #f00;padding:8px;
        font-size:6.5px;color:#f00;z-index:15;max-height:280px;overflow:auto;width:280px;line-height:1.3;
        text-shadow:0 0 6px #f00;opacity:0.97;
    }
    .error-line{color:#ff3333}
    .warn-line{color:#ff8800}
    /* PIP + Mirror */
    #pipWindow{
        position:fixed;top:50px;right:10px;width:160px;height:160px;border:3px solid #0f0;overflow:hidden;z-index:14;display:none;
    }
    #pipCanvas{width:100%;height:100%}
    .mirror-popup{
        display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
        width:90%;max-width:340px;height:420px;background:rgba(0,10,0,0.97);border:4px solid #0ff;
        z-index:200;box-shadow:8px 8px 0 #000;color:#0ff;font-size:8px;
    }
    .mirror-header{background:rgba(0,255,255,0.2);border-bottom:2px solid #0ff;padding:6px;display:flex;justify-content:space-between;align-items:center;cursor:move}
    .mirror-close{width:28px;height:28px;background:#000;border:2px solid #f00;color:#f00;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .mirror-close:hover{background:#f00;color:#000}
    #calibStatus{text-align:center;color:#ff0;margin:8px 0;font-size:9px}
    #webcamCanvas{width:100%;height:220px;background:#000}
    /* HUD */
    #hudWarning{position:fixed;top:30%;left:50%;transform:translateX(-50%);color:#f00;font-size:16px;z-index:50;display:none}
    #scanTimer{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff0;font-size:32px;z-index:201;display:none}
</style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt"></div>
    <div class="scanline"></div>
    <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 10</div></div>
    <canvas id="visualizationCanvas"></canvas>
    <!-- Status Panel -->
    <div class="status-panel">
        <div>STATUS: <span id="pointCount">AWAITING SYNC</span></div>
        <div>FACES: <span id="faceCount">0</span></div>
        <div>OBJECTS: <span id="objectCount">0</span></div>
    </div>
    <!-- Red Error Log (Pre-filled + Live) -->
    <div id="errorLog">
14:27:08 ERROR AR FAIL: NotAllowedError: Permission denied<br>
<span class="error-line">14:27:08 DETAILS User denied camera or page not HTTPS</span><br>
14:27:15 ERROR WebXR immersive-ar not supported<br>
<span class="error-line">14:27:15 DETAILS Device lacks hit-test or AR runtime</span><br>
14:27:42 ERROR Failed to load ARButton.js<br>
<span class="warn-line">14:28:03 WARN Retrying from mirror...</span><br>
14:28:05 ERROR SecurityError: Operation insecure<br>
<span class="error-line">14:28:05 DETAILS Must serve over HTTPS</span><br>
14:28:19 WARN No rear camera - using selfie mode<br>
<span class="error-line">14:28:26 ERROR WebXR session failed to start</span><br>
    </div>
    <!-- Mobile-First Controls -->
    <div class="controls-container">
        <button id="syncArBtn" class="ctrl-btn">SYNC AR</button>
        <button id="calibrateBtn" class="ctrl-btn">CALIBRATE FACE</button>
        <button id="exportBtn" class="ctrl-btn export-btn">EXPORT DATA</button>
        <button id="clearBtn" class="ctrl-btn" style="border-color:#ff0;color:#ff0">CLEAR ALL</button>
    </div>
    <!-- PIP + Mirror -->
    <div id="pipWindow"><canvas id="pipCanvas"></canvas></div>
    <div class="mirror-popup" id="mirrorPopup">
        <div class="mirror-header">
            <div>WEBCAM CALIBRATION</div>
            <div class="mirror-close">X</div>
        </div>
        <div style="padding:8px">
            <canvas id="webcamCanvas"></canvas>
            <div id="calibStatus">INITIALIZING...</div>
        </div>
    </div>
    <div id="hudWarning">NO DATA CAPTURED</div>
    <div id="scanTimer">60</div>
</div>
<script type="module">
let scene, camera, renderer, controller;
let reticle, heroGroup, faceMeshObj;
let hitTestSource = null, hitTestSourceRequested = false;
let isARActive = false;
let stream = null;
const $ = s => document.querySelector(s);
const log = (level, msg, details) => {
    const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const line = document.createElement('div');
    line.innerHTML = `${time} <span style="color:${level==='ERROR'?'#ff0000':level==='WARN'?'#ff8800':'#00ff00'}">${level}</span> ${msg}`;
    if (details) {
        const d = document.createElement('div');
        d.innerHTML = `<span style="color:#ff5555">${time} DETAILS ${details}</span>`;
        $('#errorLog').appendChild(d);
    }
    $('#errorLog').appendChild(line);
    $('#errorLog').scrollTop = $('#errorLog').scrollHeight;
};
function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
    renderer = new THREE.WebGLRenderer({canvas: $('#visualizationCanvas'), antialias: false, alpha: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    // Neuro Hero (wireframe head)
    heroGroup = new THREE.Group();
    const geo = new THREE.IcosahedronGeometry(0.3, 1);
    const mat = new THREE.MeshBasicMaterial({color: 0x00ffff, wireframe: true});
    const head = new THREE.Mesh(geo, mat);
    heroGroup.add(head);
    heroGroup.scale.set(2,2,2);
    heroGroup.visible = false;
    scene.add(heroGroup);
    // Grid
    const grid = new THREE.GridHelper(10, 40, 0x00ff00, 0x003300);
    grid.material.opacity = 0.3; grid.material.transparent = true;
    scene.add(grid);
    // Reticle
    const reticleGeometry = new THREE.RingGeometry(0.15, 0.2, 32);
    reticleGeometry.rotateX(-Math.PI/2);
    reticle = new THREE.Mesh(
        reticleGeometry,
        new THREE.MeshBasicMaterial({color: 0x00ffff, side: THREE.DoubleSide})
    );
    reticle.visible = false;
    scene.add(reticle);
    // Lighting
    scene.add(new THREE.HemisphereLight(0x00ffaa, 0x00ff00, 1));
    // Proper AR Button (appears automatically on supported devices)
    let arButton;
    try {
        arButton = ARButton.createButton(renderer, {
            requiredFeatures: ['hit-test'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: {root: document.getElementById('appContainer')}
        });
        arButton.style.bottom = '20px';
        arButton.style.left = '50%';
        arButton.style.transform = 'translateX(-50%)';
        arButton.style.zIndex = '1000';
        document.body.appendChild(arButton);
    } catch (err) {
        log('ERROR', 'Failed to create ARButton', err.message);
    }
    // Session handling
    renderer.xr.addEventListener('sessionstart', async () => {
        const session = renderer.xr.getSession();
        const referenceSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space: referenceSpace });
        hitTestSourceRequested = true;
        isARActive = true;
        heroGroup.visible = true;
        log('INFO', 'WebXR AR session started');
    });
    renderer.xr.addEventListener('sessionend', () => {
        isARActive = false;
        reticle.visible = false;
        heroGroup.visible = false;
        if (hitTestSource) {
            hitTestSource.release();
            hitTestSource = null;
        }
        log('WARN', 'AR session ended');
    });
    // Event Listeners
    $('#syncArBtn').onclick = () => log('INFO', 'SYNC AR button pressed', 'Forwarding to native ARButton...');
    $('#calibrateBtn').onclick = () => {
        $('#mirrorPopup').style.display = 'block';
        startWebcam();
        log('INFO', 'Face calibration started');
    };
    $('#exportBtn').onclick = () => {
        const data = {channel: "10", timestamp: new Date().toISOString(), synced: isARActive};
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'edtv_channel10_harvest.json';
        a.click();
        log('INFO', 'Data export triggered');
    };
    $('.mirror-close').onclick = () => $('#mirrorPopup').style.display = 'none';
    $('#clearBtn').onclick = () => {
        heroGroup.visible = false;
        reticle.visible = false;
        log('INFO', 'Scene cleared');
    };
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
    animate();
}
function startWebcam() {
    if (stream) return;
    navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}})
        .then(s => {
            stream = s;
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsinline = true;
            video.style.display = 'none'; // Hide video, draw to canvas
            document.body.appendChild(video); // Append to DOM for stability
            video.onloadedmetadata = () => {
                const ctx = $('#webcamCanvas').getContext('2d');
                const draw = () => {
                    ctx.drawImage(video, 0, 0, 400, 300);
                    requestAnimationFrame(draw);
                };
                draw();
                $('#calibStatus').textContent = 'FACE LOCK ACQUIRED';
            };
        })
        .catch(err => {
            log('ERROR', 'Camera access failed', err.message);
            $('#calibStatus').textContent = 'CAMERA DENIED';
        });
}
function animate() {
    renderer.setAnimationLoop((timestamp, frame) => {
        if (!frame) return;
        if (frame && hitTestSource) {
            const hits = frame.getHitTestResults(hitTestSource);
            if (hits.length) {
                const hit = hits[0];
                const pose = hit.getPose(renderer.xr.getReferenceSpace());
                const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
                reticle.matrix.copy(matrix);
                reticle.matrix.decompose(reticle.position, reticle.quaternion, reticle.scale);
                reticle.visible = true;
            } else reticle.visible = false;
        }
        if (heroGroup.visible) {
            heroGroup.rotation.y += 0.01;
            heroGroup.scale.setScalar(2 + Math.sin(timestamp * 0.002) * 0.2);
        }
        renderer.render(scene, camera);
    });
}
init();
</script>
</body>
</html>
