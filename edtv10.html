<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>edTV: CHANNEL 10</title>
    <meta name="theme-color" content="#000000">
    <meta name="description" content="edTV Channel 10: Fixed AR face scanner with MediaPipe constants">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
        body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
        #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
        .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3}
        .crt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;z-index:5;pointer-events:none;animation:scanline 8s linear infinite}
        @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
        .top-banner{position:absolute;top:0;left:0;width:100%;height:40px;background:rgba(255,0,255,0.9);border-bottom:2px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:12;animation:glitch 3s infinite}
        @keyframes glitch{0%,100%{transform:translateX(0)}5%{transform:translateX(-2px)}10%{transform:translateX(2px)}15%{transform:translateX(-1px)}20%{transform:translateX(1px)}25%{transform:translateX(0)}55%{transform:translateX(-1px) skewX(-2deg)}60%{transform:translateX(1px) skewX(2deg)}65%{transform:translateX(-1px) skewX(-1deg)}70%{transform:translateX(1px) skewX(1deg)}75%{transform:translateX(0)}}
        .top-banner-text{font-size:12px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
        .mirror-btn{width:180px;height:52px;background:#000;border:3px solid #0ff;color:#0ff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transform:skew(-2deg);transition:0.1s;position:absolute;top:60px;left:20px;z-index:11}
        .mirror-btn:hover,.mirror-btn:active,.mirror-btn.active{background:#0ff;color:#000}
        .right-controls{position:absolute;top:60px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:11}
        .zoom-in-btn,.zoom-out-btn,.reset-btn{width:120px;height:40px;background:#000;color:#0f0;border:3px solid #0f0;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .zoom-out-btn{border-color:#f00;color:#f00}
        .reset-btn{border-color:#ff0;color:#ff0}
        .zoom-in-btn:hover,.zoom-in-btn:active{background:#0f0;color:#000}
        .zoom-out-btn:hover,.zoom-out-btn:active{background:#f00;color:#000}
        .reset-btn:hover,.reset-btn:active{background:#ff0;color:#000}
        .camera-controls{position:absolute;bottom:100px;right:20px;display:grid;grid-template-columns:1fr 1fr;gap:10px;z-index:11}
        .camera-btn{width:60px;height:40px;background:#000;border:2px solid #0ff;color:#0ff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .camera-btn:hover,.camera-btn:active{background:#0ff;color:#000}
        .ppv-face-view{position:absolute;top:10px;right:10px;width:140px;height:105px;background:#000;border:2px solid #0ff;z-index:15;overflow:hidden;cursor:pointer;transition:0.3s}
        .ppv-face-view.expanded{width:300px;height:225px;z-index:20}
        .scanner{position:absolute;top:0;left:0;width:100%;height:4px;background:red;box-shadow:0 0 20px red;animation:scan 2s linear infinite;display:none}
        @keyframes scan{0%{top:0%}100%{top:100%}}
        .radar-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:200px;height:200px;border-radius:50%;border:2px solid rgba(0,255,0,0.5);background:rgba(0,0,0,0.3);z-index:10}
        .radar-sweep{position:absolute;top:0;left:50%;width:2px;height:100%;background:linear-gradient(transparent,#0f0,transparent);transform-origin:center}
        .radar-dot{position:absolute;width:6px;height:6px;border-radius:50%;transform:translate(-50%,-50%)}
        .green-dot{background:#0f0;box-shadow:0 0 8px #0f0}
        .red-dot{background:#f00;box-shadow:0 0 8px #f00}
        #hudWarning{position:absolute;top:20%;left:50%;transform:translate(-50%,-50%);color:#f00;font-size:12px;text-shadow:1px  1px #000;z-index:11;display:none}
        .neurots-status,.status-panel,.timer-panel{position:absolute;font-size:8px;color:#0ff;background:rgba(0,0,0,0.7);padding:5px;border:1px solid #0ff;z-index:11}
        .neurots-status{top:50px;left:10px}
        .status-panel{top:50px;right:160px}
        .timer-panel{top:120px;left:20px;color:#ff0;border-color:#ff0}
        .calibration-panel,.json-panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);border:3px solid #0ff;padding:15px;z-index:30;max-width:500px;display:none;text-align:center}
        .json-content{width:100%;height:200px;background:#000;border:2px solid #0f0;color:#0f0;padding:10px;overflow:auto;font-family:monospace;font-size:8px;white-space:pre-wrap}
        @media(max-width:767px){.ppv-face-view{width:100px;height:75px}.ppv-face-view.expanded{width:280px;height:210px}.mirror-btn{left:10px;width:160px;height:48px;font-size:9px}}
    </style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt-overlay"></div>
    <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 10</div></div>
    <div class="ppv-face-view" id="ppvFaceView"><canvas id="ppvCanvas"></canvas><div class="scanner" id="scanner"></div></div>
    <div class="neurots-status" id="neurotsStatus">LIVE READY</div>
    <div class="status-panel">OBJECTS: <span id="objectCount">0</span><br>FPS: <span id="fpsCounter">60</span><br>SCENE: <span id="sceneStatus">CALIBRATING</span></div>
    <div class="timer-panel">PROCESSING: <span id="timerDisplay">400s</span><br>PROGRESS: <span id="progressDisplay">0%</span></div>
    <div class="calibration-panel" id="calibrationPanel">
        <div class="calibration-text">CALIBRATION REQUIRED<br><br>Look UP then DOWN.<br>Then turn 360° slowly.</div>
        <button class="calibration-btn" id="startCalibrationBtn">START CALIBRATION</button>
    </div>
    <div class="json-panel" id="jsonPanel">
        <div class="json-title">3D FACE SCAN EXPORT</div>
        <div class="json-content" id="jsonContent"></div>
        <button class="json-btn" id="copyJsonBtn">COPY JSON</button>
    </div>
    <div id="visualizationContainer"><canvas id="visualizationCanvas"></canvas></div>
    <div class="radar-container" id="radarContainer"><div class="radar-sweep" id="radarSweep"></div></div>
    <button id="mirrorBtn" class="mirror-btn">START SCAN</button>
    <div class="right-controls">
        <button id="zoomInBtn" class="zoom-in-btn">ZOOM IN</button>
        <button id="zoomOutBtn" class="zoom-out-btn">ZOOM OUT</button>
        <button id="resetViewBtn" class="reset-btn">RESET VIEW</button>
    </div>
    <div class="camera-controls">
        <button id="cameraLeftBtn" class="camera-btn">←</button>
        <button id="cameraRightBtn" class="camera-btn">→</button>
        <button id="cameraUpBtn" class="camera-btn">↑</button>
        <button id="cameraDownBtn" class="camera-btn">↓</button>
    </div>
    <div id="hudWarning">USER OUT OF VIEW</div>
</div>

<script>
    // Import MediaPipe constants after face_mesh.js loads
    const { FaceMesh, FACEMESH_TESSELATION, FACEMESH_RIGHT_EYE, FACEMESH_LEFT_EYE, FACEMESH_FACE_OVAL } = faceMesh;
    const { drawConnectors } = faceMeshDrawingUtils;
    const { Camera } = cameraUtils;

    let scene, cam, ren, controls, clock;
    let faceWireframe, compassArrow, neurotsObjects = [];
    let faceDirection = 0, userDetected = false;
    let stream, faceMeshInstance, camera;
    let isProcessing = false, calibrationComplete = false, calibrationStep = 0;
    let faceLandmarksHistory = [];
    const maxHistory = 100;
    let objectCount = 0, processingTimer = 400, timerInterval = null;
    let radarDotPool = [], dotGeometry, greenMaterial, redMaterial;

    const sceneData = { userPosition:{x:0,y:0,z:0}, faceLandmarks:[], faceTopology:FACEMESH_TESSELATION, objects:[], calibrationData:{}, processingTime:0, timestamp:null };

    const $ = s => document.querySelector(s);

    function init() {
        init3D();
        setupPerformanceOptimizations();
        setupFaceDetection();
        setupEventListeners();
        showCalibrationPanel();
        animate();
    }

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        cam = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
        cam.position.z = 5;
        ren = new THREE.WebGLRenderer({canvas: $('#visualizationCanvas'), antialias:false});
        ren.setSize(innerWidth, innerHeight);
        ren.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Fixed blurry output

        controls = new THREE.OrbitControls(cam, ren.domElement);
        controls.enableDamping = true;
        clock = new THREE.Clock();

        scene.add(new THREE.AmbientLight(0x003300));
        scene.add(new THREE.DirectionalLight(0x00ff00, 0.4).setPosition(5,10,5));
        scene.add(new THREE.GridHelper(20,20,0x004400,0x002200));

        faceWireframe = createFaceWireframe();
        faceWireframe.scale.set(10,10,10);
        scene.add(faceWireframe);

        compassArrow = createCompassArrow();
        scene.add(compassArrow);
    }

    function createFaceWireframe() {
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(468*3), 3));
        const indices = [];
        FACEMESH_TESSELATION.forEach(([a,b]) => { indices.push(a,b); });
        geo.setIndex(indices);
        return new THREE.LineSegments(geo, new THREE.LineBasicMaterial({color:0x00ffff}));
    }

    function updateFaceWireframe(landmarks) {
        const pos = faceWireframe.geometry.attributes.position.array;
        landmarks.forEach((lm,i) => {
            pos[i*3]   = (lm.x-0.5)*2;
            pos[i*3+1] = -(lm.y-0.5)*2;
            pos[i*3+2] = lm.z*-2;
        });
        faceWireframe.geometry.attributes.position.needsUpdate = true;
    }

    function createCompassArrow() {
        const g = new THREE.Group();
        g.add(new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.4,8), new THREE.MeshBasicMaterial({color:0xff0000})).translateY(0.2));
        g.add(new THREE.Mesh(new THREE.ConeGeometry(0.05,0.1,8), new THREE.MeshBasicMaterial({color:0xff0000})).translateY(0.45));
        return g;
    }

    function setupPerformanceOptimizations() {
        dotGeometry = new THREE.SphereGeometry(0.05,4,4);
        greenMaterial = new THREE.MeshBasicMaterial({color:0x00ff00});
        redMaterial = new THREE.MeshBasicMaterial({color:0xff0000});
        for(let i=0;i<100;i++){
            const d=document.createElement('div'); d.className='radar-dot'; d.style.display='none';
            radarDotPool.push(d);
        }
    }

    function setupFaceDetection() {
        faceMeshInstance = new FaceMesh({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMeshInstance.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
        faceMeshInstance.onResults(onResults);
        $('#neurotsStatus').textContent = 'FACE DETECTION READY';
    }

    function onResults(results) {
        userDetected = !!(results.multiFaceLandmarks?.length);
        $('#hudWarning').style.display = userDetected ? 'none' : 'block';

        const ctx = $('#ppvCanvas').getContext('2d');
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
        if(results.image) ctx.drawImage(results.image,0,0,ctx.canvas.width,ctx.canvas.height);

        if(userDetected){
            const lm = results.multiFaceLandmarks[0];
            drawConnectors(ctx, lm, FACEMESH_TESSELATION, {color:'#C0C0C070', lineWidth:1});
            drawConnectors(ctx, lm, FACEMESH_RIGHT_EYE, {color:'#FF3030', lineWidth:1});
            drawConnectors(ctx, lm, FACEMESH_LEFT_EYE, {color:'#30FF30', lineWidth:1});
            drawConnectors(ctx, lm, FACEMESH_FACE_OVAL, {color:'#E0E0E0', lineWidth:2});

            updateFaceWireframe(lm);
            if(isProcessing && calibrationComplete && faceLandmarksHistory.length < maxHistory){
                faceLandmarksHistory.push(lm.map(p=>({x:p.x,y:p.y,z:p.z})));
            }

            const yaw = Math.atan2((lm[454].x-lm[234].x)*ctx.canvas.width, (lm[234].z-lm[454].z)*1000) * 180/Math.PI;
            faceDirection = yaw;
            compassArrow.rotation.y = -yaw * Math.PI/180;
            faceWireframe.rotation.y = -yaw * Math.PI/180;

            if(isProcessing && !calibrationComplete) handleCalibration(lm);
            $('#neurotsStatus').textContent = `TRACKING (${yaw.toFixed(0)}°)`;
        }else{
            $('#neurotsStatus').textContent = 'FACE NOT DETECTED';
        }
    }

    function handleCalibration(lm){
        const pitch = (lm[1].y - lm[10].y)*1000;
        if(calibrationStep===0 && pitch<-5){ calibrationStep=2; $('#sceneStatus').textContent='LOOK DOWN'; }
        if(calibrationStep===2 && pitch>5){
            calibrationComplete=true; $('#sceneStatus').textContent='SCANNING FACE'; $('#neurotsStatus').textContent='CALIBRATION COMPLETE';
        }
    }

    function startWebcam(){
        navigator.mediaDevices.getUserMedia({video:{facingMode:'user', width:{ideal:640}, height:{ideal:480}}}).then(s=>{
            stream=s;
            const vid=document.createElement('video');
            vid.srcObject=stream; vid.autoplay=true; vid.playsInline=true; vid.style.display='none';
            document.body.appendChild(vid);
            camera = new Camera(vid, {onFrame:()=>faceMeshInstance.send({image:vid}), width:640, height:480});
            camera.start();
            $('#ppvCanvas').width=$('#ppvFaceView').clientWidth;
            $('#ppvCanvas').height=$('#ppvFaceView').clientHeight;
            $('#neurotsStatus').textContent='FACE DETECTION ACTIVE';
        }).catch(e=>{ $('#neurotsStatus').textContent='CAMERA ERROR'; alert('Camera access denied'); });
    }

    function startCalibration(){
        $('#calibrationPanel').style.display='none';
        $('#mirrorBtn').classList.add('active'); $('#mirrorBtn').textContent='SCANNING ACTIVE';
        startWebcam(); startProcessingTimer(); $('#scanner').style.display='block';
    }

    function startProcessingTimer(){
        isProcessing=true; processingTimer=400;
        timerInterval=setInterval(()=>{
            if(userDetected){ processingTimer--;
                $('#timerDisplay').textContent=processingTimer+'s';
                $('#progressDisplay').textContent=Math.round((400-processingTimer)/4)+'%';
                if(processingTimer<=0){ clearInterval(timerInterval); finishProcessing(); }
            }
        },1000);
    }

    function finishProcessing(){
        isProcessing=false; $('#scanner').style.display='none'; stopWebcam();
        $('#sceneStatus').textContent='COMPLETE'; $('#neurotsStatus').textContent='SCAN COMPLETE';
        $('#mirrorBtn').textContent='SCAN COMPLETE'; $('#mirrorBtn').classList.remove('active');

        if(faceLandmarksHistory.length>0){
            sceneData.faceLandmarks = averageLandmarks(faceLandmarksHistory);
            updateFaceWireframe(sceneData.faceLandmarks);
        }
        generateJSONExport();
    }

    function averageLandmarks(hist){
        const avg = Array(468).fill().map(()=>({x:0,y:0,z:0}));
        hist.forEach(f=>f.forEach((p,i)=>{avg[i].x+=p.x/hist.length; avg[i].y+=p.y/hist.length; avg[i].z+=p.z/hist.length;}));
        return avg;
    }

    function generateJSONExport(){
        sceneData.processingTime=400-processingTimer;
        sceneData.timestamp=new Date().toISOString();
        sceneData.calibrationData={calibrationComplete, objectsDetected:objectCount};
        $('#jsonContent').textContent=JSON.stringify(sceneData,null,2);
        $('#jsonPanel').style.display='block';
    }

    function addDetectedObject(){
        const large = Math.random()>0.5;
        const dist = 2+Math.random()*8;
        const ang = (Math.random()*120-60+faceDirection)*Math.PI/180;
        const x=Math.cos(ang)*dist, z=Math.sin(ang)*dist, y=Math.random()*3;
        const mesh = new THREE.Mesh(dotGeometry, large?greenMaterial:redMaterial);
        mesh.position.set(x,y,z);
        mesh.userData={type:large?'surface':'object', id:objectCount++};
        scene.add(mesh); neurotsObjects.push(mesh);
        sceneData.objects.push({type:mesh.userData.type, id:mesh.userData.id, position:{x,y,z}, timestamp:Date.now()});
        $('#objectCount').textContent=objectCount;
        addRadarDot(x,z,large);
    }

    function addRadarDot(x,z,large){
        let dot = radarDotPool.length?radarDotPool.pop():document.createElement('div');
        dot.className=`radar-dot ${large?'green-dot':'red-dot'}`;
        dot.style.left=(x/10*100+50)+'%';
        dot.style.top=(z/10*100+50)+'%';
        dot.style.display='block';
        $('#radarContainer').appendChild(dot);
    }

    function setupEventListeners(){
        $('#mirrorBtn').onclick=()=>{if(!isProcessing) startCalibration();}
        $('#startCalibrationBtn').onclick=startCalibration;
        $('#copyJsonBtn').onclick=()=>{navigator.clipboard.writeText($('#jsonContent').textContent).then(()=>alert('JSON copied!'));}
        $('#zoomInBtn').onclick=()=>controls.dollyIn();
        $('#zoomOutBtn').onclick=()=>controls.dollyOut();
        $('#resetViewBtn').onclick=()=>controls.reset();
        $('#cameraLeftBtn').onclick=()=>controls.rotateLeft(0.1);
        $('#cameraRightBtn').onclick=()=>controls.rotateLeft(-0.1);
        $('#cameraUpBtn').onclick=()=>controls.rotateUp(0.1);
        $('#cameraDownBtn').onclick=()=>controls.rotateUp(-0.1);
        $('#ppvFaceView').onclick=()=>{ $('#ppvFaceView').classList.toggle('expanded');
            $('#ppvCanvas').width=$('#ppvFaceView').clientWidth; $('#ppvCanvas').height=$('#ppvFaceView').clientHeight; };
        window.onresize=()=>{ cam.aspect=innerWidth/innerHeight; cam.updateProjectionMatrix(); ren.setSize(innerWidth,innerHeight); };
        setInterval(()=>{ if(isProcessing && calibrationComplete && objectCount<200) addDetectedObject(); }, 100);
    }

    function stopWebcam(){
        if(stream) stream.getTracks().forEach(t=>t.stop());
        if(camera) camera.stop();
    }

    function showCalibrationPanel(){ $('#calibrationPanel').style.display='block'; }

    function animate(){
        requestAnimationFrame(animate);
        controls.update();
        $('#radarSweep').style.transform=`translateX(-50%) rotate(${(Date.now()*0.002)%360}deg)`;
        ren.render(scene,cam);
    }

    function cleanup(){
        cancelAnimationFrame(animationId);
        clearInterval(timerInterval);
        stopWebcam();
        if(ren) ren.dispose();
        if(controls) controls.dispose();
        scene?.clear();
    }

    window.onload=init;
    window.onbeforeunload=cleanup;
</script>
</body>
</html>
