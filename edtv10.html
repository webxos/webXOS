<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GIFTED: CHANNEL 10</title>
<meta name="theme-color" content="#000000">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7"></script>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none}
    #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
    canvas,video{display:block;width:100%;height:100%;object-fit:cover}
    .matrix-grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3;pointer-events:none}
    .crt{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;pointer-events:none;animation:stripes 8s linear infinite}
    .scanline{position:absolute;inset:0;background:rgba(255,0,255,0.03);animation:scan 6s linear infinite;pointer-events:none}
    @keyframes stripes{0%{background-position:0 0}100%{background-position:0 100%}}
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
    .top-banner{position:absolute;top:0;left:0;width:100%;height:44px;background:rgba(255,0,255,0.92);border-bottom:3px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:100;animation:glitch 3s infinite}
    @keyframes glitch{
        0%,100%{transform:translate(0)}
        10%,30%,50%,70%,90%{transform:translate(-3px,-3px)}
        20%,40%,60%,80%{transform:translate(6px,3px)}
    }
    .top-banner-text{font-size:11px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
    #pip{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;height:420px;border:6px solid #0ff;border-radius:16px;z-index:14;background:#000;box-shadow:0 0 40px #0ff, inset 0 0 50px rgba(0,255,255,0.3);}
    #mask-canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;height:420px;z-index:15;pointer-events:none}
    .face-detected .top-banner,.recording .top-banner{animation:glitch 0.1s infinite;background:#f00}
    .recording #pip{border-color:#f00;box-shadow:0 0 100px #f00}
    .controls-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:16px;z-index:100}
    .ctrl-btn{height:66px;background:#000;border:4px solid #0ff;color:#0ff;font-size:14px;padding:0 20px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:6px 6px 0 #000;transform:skew(-4deg);transition:all .15s}
    .ctrl-btn:active,.ctrl-btn.active{background:#0ff;color:#000}
    #recordBtn{border-color:#f00;color:#f00}
    #recordBtn.recording{background:#f00;color:#000;animation:pulse 1s infinite}
    #switchMask{border-color:#ff0;color:#ff0}
    #switchMask:active{background:#ff0;color:#000}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
    #errorLog{position:absolute;bottom:100px;left:10px;background:rgba(0,0,0,0.96);border:3px double #f00;padding:8px;font-size:7px;color:#f00;z-index:15;max-height:220px;overflow:auto;width:calc(100%-20px)}
    .mask-name{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);padding:4px 12px;border:2px solid #0ff;color:#0ff;font-size:9px;z-index:16;opacity:0;transition:opacity .3s}
    .face-detected .mask-name{opacity:1}
</style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt"></div>
    <div class="scanline"></div>

    <div class="top-banner">
        <div class="top-banner-text">GIFTED: CHANNEL 10</div>
    </div>

    <video id="pip" autoplay playsinline muted></video>
    <canvas id="mask-canvas"></canvas>
    <div class="mask-name" id="currentMaskName">MASK: GLITCH CORE</div>

    <div class="controls-container">
        <button id="startSync" class="ctrl-btn">SYNC</button>
        <button id="switchMask" class="ctrl-btn">SWITCH MASK</button>
        <button id="recordBtn" class="ctrl-btn">RECORD GIF</button>
    </div>

    <div id="errorLog">
        <div>00:00:00 INFO GIFTED: CHANNEL 10 // READY</div>
    </div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js';
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: false });

const video = document.getElementById('pip');
const canvas = document.getElementById('mask-canvas');
const ctx = canvas.getContext('2d');
const logEl = document.getElementById('errorLog');
const maskNameEl = document.getElementById('currentMaskName');

let model, stream, mediaRecorder, chunks = [], recording = false;
let scene, camera, renderer, maskObject, particles, currentMask = 0;

const MASKS = [
    { name: "GLITCH CORE", geometry: () => new THREE.IcosahedronGeometry(0.22, 2), material: () => new THREE.MeshBasicMaterial({color:0x00ffff, wireframe:true}), scale: [2.3,2.0,2.2], glitch: true },
    { name: "NEON DEMON", geometry: () => new THREE.TorusKnotGeometry(0.15, 0.05, 128, 16), material: () => new THREE.MeshBasicMaterial({color:0xff00ff, wireframe:true}), scale: [2.4,2.4,2.4], glitch: true },
    { name: "VOID HELIX", geometry: () => new THREE.SphereGeometry(0.2, 32, 16), material: () => new THREE.MeshBasicMaterial({color:0x000000, wireframe:true, emissive:0xff00ff, emissiveIntensity:10}), scale: [2.5,2.5,2.5], glitch: false },
    { name: "CHROME SKULL", geometry: () => new THREE.DodecahedronGeometry(0.2, 1), material: () => new THREE.MeshStandardMaterial({color:0xffffff, metalness:1, roughness:0, wireframe:true}), scale: [2.1,2.1,2.1], glitch: true },
    { name: "DATA PHANTOM", geometry: () => new THREE.OctahedronGeometry(0.25, 2), material: () => new THREE.MeshBasicMaterial({color:0x00ff00, wireframe:true, transparent:true, opacity:0.7}), scale: [2.6,2.2,2.4], glitch: true }
];

function log(msg, color = '#00ff00') {
    const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const line = document.createElement('div');
    line.style.color = color;
    line.innerHTML = `${time} <span style="color:#0ff">GIFTED</span> ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
}

async function startCamera() {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 720, height: 720 }, audio: false });
    video.srcObject = stream;
    video.play();
    canvas.width = 420; canvas.height = 420;
    log('CAMERA SYNC ACTIVE');
}

async function loadFaceModel() {
    model = await blazeface.load();
    log('NEUROFACE LOADED');
}

function create3DScene() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, 1, 0.1, 10);
    renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
    renderer.setSize(420, 420);
    renderer.setPixelRatio(window.devicePixelRatio);

    const pGeo = new THREE.BufferGeometry();
    const pos = new Float32Array(1200);
    for(let i=0;i<1200;i++) pos[i]=(Math.random()-0.5)*3;
    pGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    particles = new THREE.Points(pGeo, new THREE.PointsMaterial({color:0x00ffff,size:0.03,transparent:true,opacity:0.6}));
    scene.add(particles);

    loadMask(0);
}

function loadMask(i) {
    if(maskObject) scene.remove(maskObject);
    const m = MASKS[i];
    maskObject = new THREE.Mesh(m.geometry(), m.material());
    maskObject.scale.set(...m.scale);
    scene.add(maskObject);
    maskNameEl.textContent = `MASK: ${m.name}`;
    currentMask = i;
    log(`MASK â†’ ${m.name}`, '#ff00ff');
}

async function detectLoop() {
    if(!model || video.readyState < 2) { requestAnimationFrame(detectLoop); return; }
    const preds = await model.estimateFaces(video, false);
    ctx.clearRect(0,0,420,420);

    if(preds.length > 0) {
        document.body.classList.add('face-detected');
        const f = preds[0];
        const cx = (f.topLeft[0] + f.bottomRight[0]) / 2 / video.videoWidth;
        const cy = (f.topLeft[1] + f.bottomRight[1]) / 2 / video.videoHeight;
        const size = Math.max(f.bottomRight[0]-f.topLeft[0], f.bottomRight[1]-f.topLeft[1]);

        maskObject.position.x = (cx - 0.5) * 2.2;
        maskObject.position.y = (0.5 - cy) * 2.2;
        const s = 1 + size/300;
        maskObject.scale.multiplyScalar(s);

        if(MASKS[currentMask].glitch) {
            maskObject.rotation.y += 0.04;
            maskObject.rotation.x = Math.sin(Date.now()*0.008)*0.3;
            if(maskObject.material.color) maskObject.material.color.setHSL((Date.now()*0.0005)%1,1,0.5);
        } else maskObject.rotation.y += 0.02;

        particles.rotation.y += 0.002;
    } else {
        document.body.classList.remove('face-detected');
        maskObject.rotation.y += 0.008;
        particles.rotation.y += 0.001;
    }
    renderer.render(scene, camera);
    requestAnimationFrame(detectLoop);
}

// RECORD 5-SECOND GIF
document.getElementById('recordBtn').onclick = async () => {
    if(recording) return;
    recording = true;
    document.body.classList.add('recording');
    document.getElementById('recordBtn').textContent = 'RECORDING...';
    document.getElementById('recordBtn').classList.add('recording');
    chunks = [];

    const displayStream = canvas.captureStream(15); // 15 fps
    mediaRecorder = new MediaRecorder(displayStream, { mimeType: 'video/webm;codecs=vp9' });
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.start();

    log('RECORDING 5 SEC GIF', '#f00');

    setTimeout(async () => {
        mediaRecorder.stop();
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            if(!ffmpeg.isLoaded()) { log('LOADING FFMPEG...'); await ffmpeg.load(); }
            log('CONVERTING TO GIF...');
            ffmpeg.FS('writeFile', 'in.webm', await fetchFile(blob));
            await ffmpeg.run('-i','in.webm','-vf','fps=10,scale=420:-1:flags=lanczos','-loop','0','out.gif');
            const data = ffmpeg.FS('readFile','out.gif');
            const gifBlob = new Blob([data.buffer], {type:'image/gif'});
            const url = URL.createObjectURL(gifBlob);
            const a = document.createElement('a');
            a.href = url; a.download = `GIFTED_${Date.now()}.gif`; a.click();

            recording = false;
            document.body.classList.remove('recording');
            document.getElementById('recordBtn').textContent = 'RECORD GIF';
            document.getElementById('recordBtn').classList.remove('recording');
            log('GIF SAVED', '#0f0');
        };
    }, 5000);
};

document.getElementById('startSync').onclick = async () => {
    await startCamera();
    await loadFaceModel();
    create3DScene();
    detectLoop();
    log('GIFTED ACTIVE // POINT AT FACE', '#00ffff');
};

document.getElementById('switchMask').onclick = () => loadMask((currentMask+1)%MASKS.length);

log('GIFTED: CHANNEL 10 // NEUROSYNC READY');
</script>
</body>
</html>
