<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 8</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100dvh;touch-action:manipulation;user-select:none}
    #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column}
    .grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.06)1px,transparent 1px),
         linear-gradient(90deg,rgba(0,255,0,0.06)1px,transparent 1px);background-size:12px 12px;z-index:-1}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,30,0,0.15)50%);
         background-size:100% 3px;animation:s 6s linear infinite;pointer-events:none}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    .banner{background:rgba(0,40,0,0.98);border-bottom:2px solid #0f0;padding:8px 12px;font-size:10px;
            text-align:center;letter-spacing:1.5px;z-index:10}
    .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;overflow:hidden}
    .ar-view{flex:1;position:relative;border:2px solid #0f0;overflow:hidden;background:#000;border-radius:8px}
    #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #canvas3d{position:absolute;inset:0;width:100%;height:100%;image-rendering:pixelated}
    .controls{background:rgba(0,20,0,0.9);border:1px solid #0f0;padding:10px;border-radius:6px;
             display:grid;grid-template-columns:1fr 1fr;gap:8px;z-index:10}
    @media(min-width:480px){.controls{grid-template-columns:repeat(4,1fr)}}
    .btn,.dropdown{background:#000;border:2px solid #0f0;color:#0f0;padding:10px 8px;font-size:9px;
            cursor:pointer;transition:0.2s;text-align:center;border-radius:4px}
    .btn:active,.dropdown:active,.btn:hover{background:#0f0;color:#000;box-shadow:0 0 12px #0f0}
    .terminal{background:rgba(0,0,0,0.8);border:1px solid #0f0;padding:8px;font-size:8px;
              max-height:100px;overflow-y:auto;border-radius:4px;line-height:1.4}
    .status{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:8px;z-index:20;flex-wrap:wrap}
    .ind{background:rgba(0,60,0,0.9);border:1px solid #0f0;padding:4px 8px;font-size:7px;border-radius:4px}
</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<div id="app">
    <div class="grid"></div><div class="crt"></div>
    <div class="banner">EDTV: CHANNEL 8</div>
    <div class="content">
        <div class="ar-view">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas3d"></canvas>
            <div class="status">
                <div class="ind" id="track">TRACKING: OFF</div>
                <div class="ind" id="mask">MASK: NONE</div>
                <div class="ind" id="fps">FPS: 0</div>
            </div>
        </div>
        <div class="controls">
            <button class="btn" id="start">START AR</button>
            <button class="btn" id="export">EXPORT 3D</button>
            <select class="dropdown" id="mask-select">
                <option value="tactical">TACTICAL</option>
                <option value="half">HALF FACE</option>
                <option value="full">FULL FACE</option>
                <option value="respirator">RESPIRATOR</option>
                <option value="gas">GAS MASK</option>
            </select>
            <select class="dropdown" id="addon-select">
                <option value="none">NO ADDON</option>
                <option value="nvg">NVG</option>
                <option value="comms">COMMS</option>
                <option value="filter">FILTER+</option>
                <option value="visor">VISOR</option>
            </select>
        </div>
        <div class="terminal" id="log">>EDTV <br>><br>> READY</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script type="module">
import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

// === Safe DOM References ===
const video = document.getElementById('video');
const canvas = document.getElementById('canvas3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');
const fpsEl = document.getElementById('fps');

const log = (m) => {
    if (logEl) {
        logEl.innerHTML += `<br>> ${m}`;
        logEl.scrollTop = logEl.scrollHeight;
    }
    console.log('[EDTV]', m);
};

// === Global State ===
let faceLandmarker = null;
let cameraActive = false;
let lastTime = 0;
let fps = 0;

// Three.js objects (initialized safely later)
let scene, camera, renderer, maskGroup, currentAddon;

// === Safe 3D Initialization ===
function init3D() {
    try {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
        camera.position.z = 5;

        renderer = new THREE.WebGLRenderer({
            canvas,
            alpha: true,
            antialias: false,
            preserveDrawingBuffer: true
        });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        renderer.setClearColor(0x000000, 0);

        const light = new THREE.HemisphereLight(0x00ff88, 0x008800, 1.6);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x00ff88, 0.4));

        maskGroup = new THREE.Group();
        scene.add(maskGroup);

        window.addEventListener('resize', onWindowResize);
        animate();
        log('3D ENGINE v9.1 READY');
    } catch (err) {
        log('3D INIT FAILED: ' + err.message);
        console.error(err);
    }
}

function onWindowResize() {
    if (!camera || !renderer || !canvas) return;
    camera.aspect = canvas.clientWidth / canvas.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
}

// === Mask & Addon Creation (Safe Cleanup) ===
function createMask(type = 'tactical') {
    if (!maskGroup) return;
    // Clear previous mask
    while (maskGroup.children.length) {
        const child = maskGroup.children[0];
        child.geometry?.dispose();
        child.material?.dispose();
        maskGroup.remove(child);
    }
    currentAddon = null;

    const mat = new THREE.MeshBasicMaterial({
        color: 0x00ff00,
        wireframe: true,
        transparent: true,
        opacity: 0.9
    });

    let mask;
    switch(type) {
        case 'tactical': mask = new THREE.Mesh(new THREE.BoxGeometry(2.2,1.4,1.2), mat); mask.position.z = 0.4; break;
        case 'half': mask = new THREE.Mesh(new THREE.SphereGeometry(1.1,32,20,0,Math.PI*2,Math.PI/2,Math.PI/2), mat); mask.position.z = 0.3; break;
        case 'full': mask = new THREE.Mesh(new THREE.SphereGeometry(1.25,36,28,0,Math.PI*2,0,Math.PI), mat); mask.position.z = 0.1; break;
        case 'respirator': mask = new THREE.Mesh(new THREE.CylinderGeometry(1.1,1.1,1.4,32,8,false,0,Math.PI), mat); mask.rotation.x = Math.PI/2; mask.position.z = 0.35; break;
        case 'gas': mask = new THREE.Mesh(new THREE.SphereGeometry(1.35,40,32,0,Math.PI*2,0,Math.PI), mat); mask.position.z = 0.15; break;
    }

    if (mask) {
        maskGroup.add(mask);
        if (maskEl) maskEl.textContent = `MASK: ${type.toUpperCase()}`;
        log(`MASK LOADED: ${type.toUpperCase()}`);
    }
}

function createAddon(type = 'none') {
    if (!maskGroup || !currentAddon && type === 'none') return;
    if (currentAddon) {
        maskGroup.remove(currentAddon);
        currentAddon = null;
    }
    if (type === 'none') return;

    currentAddon = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({ color: 0x00ff88 });

    switch(type) {
        case 'nvg': {
            const n = new THREE.Mesh(new THREE.BoxGeometry(1.8,0.6,0.6), mat);
            n.position.set(0,0.9,0.7);
            currentAddon.add(n);
            break;
        }
        case 'comms': {
            const m = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,1,8), mat);
            m.rotation.z = Math.PI/3;
            m.position.set(0.65,-0.2,0.4);
            currentAddon.add(m);
            break;
        }
        case 'filter': {
            const f = new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.4,0.8,20), mat);
            f.position.y = -0.8;
            currentAddon.add(f);
            break;
        }
        case 'visor': {
            const v = new THREE.Mesh(new THREE.PlaneGeometry(3,1.8),
                new THREE.MeshPhongMaterial({color:0x00ffff, transparent:true, opacity:0.4, side:THREE.DoubleSide}));
            v.position.set(0,0.85,0.7);
            v.rotation.x = -0.3;
            currentAddon.add(v);
            break;
        }
    }
    maskGroup.add(currentAddon);
}

// === Robust Face Tracking (2025 MediaPipe) ===
function onResultsModern(results) {
    if (!maskGroup || !trackEl) return;

    if (!results || !results.faceLandmarks || results.faceLandmarks.length === 0) {
        trackEl.textContent = 'TRACKING: LOST';
        return;
    }

    trackEl.textContent = 'TRACKING: LOCKED';
    const lm = results.faceLandmarks[0];
    const flipX = x => 1 - x;

    const leftEyeOuter = lm[234];
    const rightEyeOuter = lm[454];
    const forehead = lm[10];
    const chin = lm[152];
    const nose = lm[1];
    const leftEye = lm[33];
    const rightEye = lm[263];

    if (!leftEyeOuter || !rightEyeOuter || !forehead || !chin) return;

    const centerX = (flipX(leftEyeOuter.x) + flipX(rightEyeOuter.x)) / 2;
    const centerY = (forehead.y + chin.y) / 2;
    const faceWidth = Math.abs(flipX(rightEyeOuter.x) - flipX(leftEyeOuter.x));
    const scale = Math.max(faceWidth * 22, 0.5);

    maskGroup.position.x = (centerX - 0.5) * 10;
    maskGroup.position.y = -(centerY - 0.5) * 10;
    maskGroup.scale.set(scale, scale, scale);

    const eyeMidX = (leftEye.x + rightEye.x) / 2;
    const eyeMidY = (leftEye.y + rightEye.y) / 2;
    maskGroup.rotation.y = (flipX(eyeMidX) - 0.5) * 2.8;
    maskGroup.rotation.x = (eyeMidY - nose.y) * 28;
}

// === Safe AR Start ===
async function startAR() {
    if (cameraActive) return;
    cameraActive = true;
    log('INITIALIZING MEDIAPIPE 2025...');

    try {
        const vision = await FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
        );

        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                delegate: "GPU"
            },
            runningMode: "VIDEO",
            outputFaceBlendshapes: false,
            numFaces: 1
        });

        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }
        });

        video.srcObject = stream;
        await video.play();

        log('CAMERA ACTIVE – TRACKING LOOP STARTED');

        const predictLoop = () => {
            if (!cameraActive || !faceLandmarker || video.readyState < 2) {
                requestAnimationFrame(predictLoop);
                return;
            }

            try {
                const results = faceLandmarker.detectForVideo(video, performance.now());
                onResultsModern(results);
            } catch (err) {
                // Ignore transient errors (common on first frames)
                if (!err.message.includes("No face") && !err.message.includes("aborted")) {
                    log('TRACK WARN: ' + err.message);
                }
            }
            requestAnimationFrame(predictLoop);
        };
        predictLoop();

        log('EDTV v9.1 2025 FULLY OPERATIONAL');
    } catch (err) {
        log('FATAL: ' + (err.message || err));
        log('CAMERA BLOCKED OR UNSUPPORTED DEVICE');
        console.error('AR Start Error:', err);
        cameraActive = false;
        if (trackEl) trackEl.textContent = 'TRACKING: ERROR';
    }
}

// === Render Loop ===
function animate(t = 0) {
    requestAnimationFrame(animate);
    if (lastTime && fpsEl) {
        fps = Math.round(1000 / (t - lastTime));
        fpsEl.textContent = `FPS: ${fps}`;
    }
    lastTime = t;
    if (renderer && scene && camera) {
        renderer.render(scene, camera);
    }
}

// === Export Config ===
document.getElementById('export')?.addEventListener('click', () => {
    if (!maskGroup) {
        log('EXPORT FAILED: No 3D scene');
        return;
    }
    const data = {
        version: "9.1-2025",
        mask: document.getElementById('mask-select')?.value || "tactical",
        addon: document.getElementById('addon-select')?.value || "none",
        transform: {
            position: maskGroup.position.toArray(),
            rotation: [maskGroup.rotation.x, maskGroup.rotation.y, maskGroup.rotation.z],
            scale: maskGroup.scale.toArray()
        },
        timestamp: Date.now()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `edtv_v9.1_2025_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    log('CONFIG EXPORTED');
});

// === Event Listeners (Safe) ===
document.getElementById('start')?.addEventListener('click', startAR);
document.getElementById('mask-select')?.addEventListener('change', e => createMask(e.target.value));
document.getElementById('addon-select')?.addEventListener('change', e => createAddon(e.target.value));

// === INIT ===
init3D();
createMask('tactical');
createAddon('none');
log('EDTV v9.1 FULLY FIXED – NOV 2025');

</script>
</body>
</html>
