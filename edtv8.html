<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>edTV: CHANNEL 8 - TACTICAL MASK DESIGNER v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none}
    #app{position:relative;width:100%;height:100vh}
    .grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.08)1px,transparent 1px),
         linear-gradient(90deg,rgba(0,255,0,0.08)1px,transparent 1px);background-size:16px 16px}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,20,0,0.1)50%);
         background-size:100% 4px;pointer-events:none;animation:s 8s linear infinite}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    .topbar{position:absolute;top:0;left:0;width:100%;height:50px;background:rgba(0,40,0,0.95);
         border-bottom:2px solid #0f0;display:flex;align-items:center;padding:0 10px;z-index:100}
    .title{flex:1;font-size:13px;letter-spacing:1px}
    .btn{background:#000;border:2px solid #0f0;color:#0f0;padding:8px 12px;font-size:10px;
         cursor:pointer;margin-left:8px;box-shadow:0 0 8px #0f0;transition:0.2s}
    .btn:hover,.btn:active{background:#0f0;color:#000}
    .log{position:absolute;top:55px;left:5px;right:5px;font-size:9px;color:#0f0;background:rgba(0,0,0,0.7);
         padding:5px;border:1px solid #0f0;max-height:80px;overflow-y:auto;z-index:90;pointer-events:none}
    #view3d{position:absolute;inset:0;z-index:1}
    #cam{position:absolute;bottom:10px;right:10px;width:180px;height:135px;border:2px solid #0f0;
         background:#000;z-index:10;object-fit:cover;cursor:pointer}
    canvas{display:block}
</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<div id="app">
    <div class="grid"></div><div class="crt"></div>
    <div class="topbar">
        <div class="title">edTV: CHANNEL 8 - TACTICAL MASK DESIGNER</div>
        <button class="btn" id="scan">SCAN</button>
        <button class="btn" id="calib">CALIBRATE</button>
        <button class="btn" id="try">TRY</button>
        <button class="btn" id="export">EXPORT JSON</button>
    </div>
    <div class="log" id="log">Ready.</div>
    <video id="cam" autoplay playsinline muted></video>
    <canvas id="view3d"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
const log = msg => { 
    document.getElementById('log').innerHTML += '<br>' + msg;
    document.getElementById('log').scrollTop = 9999;
};

const video = document.getElementById('cam');
const canvas3d = document.getElementById('view3d');
let scene, camera, renderer, controls, wireframe, landmarks = [];

function init3D() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(0, 0, 6);
    renderer = new THREE.WebGLRenderer({canvas: canvas3d, antialias: false});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    scene.add(new THREE.AmbientLight(0x004400));
    const dir = new THREE.DirectionalLight(0x00ff00, 0.6);
    dir.position.set(5, 10, 7); scene.add(dir);
    wireframe = createWireframe();
    scene.add(wireframe);
    window.onresize = () => {
        camera.aspect = innerWidth/innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
    };
    animate();
}
function createWireframe() {
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(468 * 3);
    geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    const idx = [];
    faceMesh.FACEMESH_TESSELATION.forEach(p => idx.push(p[0], p[1]));
    geo.setIndex(idx);
    const mat = new THREE.LineBasicMaterial({color: 0x00ff00});
    return new THREE.LineSegments(geo, mat);
}
function updateWireframe(lm) {
    const pos = wireframe.geometry.attributes.position.array;
    lm.forEach((p, i) => {
        pos[i*3]   = (p.x - 0.5) * 12;
        pos[i*3+1] = -(p.y - 0.5) * 12;
        pos[i*3+2] = p.z * -12;
    });
    wireframe.geometry.attributes.position.needsUpdate = true;
}
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

const faceMesh = new FaceMesh({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.7});
faceMesh.onResults(res => {
    if (res.multiFaceLandmarks?.[0]) {
        const lm = res.multiFaceLandmarks[0];
        landmarks = lm.map(p => ({x:p.x, y:p.y, z:p.z}));
        updateWireframe(lm);
    }
});

let cam;
async function startCam() {
    try {
        const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user', width:640, height:480}});
        video.srcObject = s;
        video.onloadedmetadata = () => {
            video.play();
            cam = new Camera(video, {onFrame: () => faceMesh.send({image: video})});
            cam.start();
            log('Webcam + FaceMesh active');
        };
    } catch(e) { log('Webcam error: ' + e.message); }
}

document.getElementById('scan').onclick = () => { startCam(); };
document.getElementById('calib').onclick = () => { log('Calibrated'); };
document.getElementById('try').onclick = () => { log('Mask preview active'); };
document.getElementById('export').onclick = () => {
    if (!landmarks.length) { log('No face data'); return; }
    const data = {landmarks, topology: faceMesh.FACEMESH_TESSELATION, note:"Tactical mask - single print"};
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
    a.download = 'tactical_mask.json';
    a.click();
    log('Exported tactical_mask.json');
};

video.ondblclick = () => video.requestFullscreen?.() || log('FS not supported');

init3D();
log('System ready - press SCAN');
</script>
</body>
</html>
