<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 8 - TACTICAL MASK DESIGNER v8.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100dvh;touch-action:manipulation;user-select:none}
    #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column}
    .grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.06)1px,transparent 1px),
         linear-gradient(90deg,rgba(0,255,0,0.06)1px,transparent 1px);background-size:12px 12px;z-index:-1}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,30,0,0.15)50%);
         background-size:100% 3px;animation:s 6s linear infinite;pointer-events:none}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}

    .banner{background:rgba(0,40,0,0.98);border-bottom:2px solid #0f0;padding:8px 12px;font-size:10px;
            text-align:center;letter-spacing:1.5px;z-index:10}

    .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;overflow:hidden}

    .ar-view{flex:1;position:relative;border:2px solid #0f0;overflow:hidden;background:#000;border-radius:8px}
    #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #canvas3d{position:absolute;inset:0;width:100%;height:100%;transform:scaleX(-1)}

    .controls{background:rgba(0,20,0,0.9);border:1px solid #0f0;padding:10px;border-radius:6px;
             display:grid;grid-template-columns:1fr 1fr;gap:8px;z-index:10}
    @media(min-width:480px){.controls{grid-template-columns:repeat(4,1fr)}}

    .btn,.dropdown{background:#000;border:2px solid #0f0;color:#0f0;padding:10px 8px;font-size:9px;
            cursor:pointer;transition:0.2s;text-align:center;border-radius:4px}
    .btn:active,.dropdown:active,.btn:hover{background:#0f0;color:#000;box-shadow:0 0 12px #0f0}

    .terminal{background:rgba(0,0,0,0.8);border:1px solid #0f0;padding:8px;font-size:8px;
              max-height:100px;overflow-y:auto;border-radius:4px;line-height:1.4}

    .status{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:8px;z-index:20;flex-wrap:wrap}
    .ind{background:rgba(0,60,0,0.9);border:1px solid #0f0;padding:4px 8px;font-size:7px;border-radius:4px}
</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<div id="app">
    <div class="grid"></div><div class="crt"></div>
    
    <div class="banner">EDTV: CHANNEL 8 - TACTICAL MASK DESIGNER v8.1</div>
    
    <div class="content">
        <div class="ar-view">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas3d"></canvas>
            <div class="status">
                <div class="ind" id="track">FACE TRACKING: OFF</div>
                <div class="ind" id="mask">MASK: NONE</div>
                <div class="ind" id="fps">FPS: 0</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="start">START AR</button>
            <button class="btn" id="export">EXPORT 3D</button>
            <select class="dropdown" id="mask-select">
                <option value="tactical_mask">TACTICAL</option>
                <option value="half_mask">HALF FACE</option>
                <option value="full_mask">FULL FACE</option>
                <option value="respirator">RESPIRATOR</option>
                <option value="gas_mask">GAS MASK</option>
            </select>
            <select class="dropdown" id="addon-select">
                <option value="none">NO ADDON</option>
                <option value="night_vision">NVG</option>
                <option value="comms">COMMS</option>
                <option value="filter">FILTER+</option>
                <option value="visor">VISOR</option>
            </select>
        </div>

        <div class="terminal" id="log">> SYSTEM BOOT v8.1<br>> READY</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
// ────────────────────────────── ERROR LOGGER ──────────────────────────────
const ERROR = (msg, e=null) => {
    console.error('[EDTV ERROR]', msg, e);
    log(`ERROR: ${msg}`);
};
const WARN = (msg) => {
    console.warn('[EDTV WARN]', msg);
    log(`WARN: ${msg}`);
};

// ────────────────────────────── SAFE UTILS ──────────────────────────────
const safeClearGroup = (group) => {
    while(group.children.length) {
        const child = group.children[0];
        if (child.geometry) child.geometry.dispose();
        if (child.material) child.material.dispose();
        group.remove(child);
    }
};

// ────────────────────────────── MAIN CODE ──────────────────────────────
const video = document.getElementById('video');
const canvas = document.getElementById('canvas3d');
const log = m => {
    const el = document.getElementById('log');
    el.innerHTML += `<br>> ${m}`;
    el.scrollTop = 9999;
};

let scene, camera, renderer, maskGroup, currentAddon;
let faceMesh, cameraActive = false;
let lastTime = 0, fps = 0;

function resize() {
    if (!renderer) return;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    renderer.setSize(w, h);
    camera.aspect = w/h;
    camera.updateProjectionMatrix();
}
window.addEventListener('resize', resize);

function init3D() {
    try {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
        camera.position.z = 4;

        renderer = new THREE.WebGLRenderer({canvas, alpha: true, antialias: false});
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        resize();

        const light = new THREE.HemisphereLight(0x00ff88, 0x008800, 1.4);
        scene.add(light);

        maskGroup = new THREE.Group();
        scene.add(maskGroup);

        animate();
        log('3D ENGINE READY');
    } catch(e) { ERROR('Three.js init failed', e); }
}

function createMask(type) {
    if (!maskGroup) return WARN('MaskGroup not ready');
    safeClearGroup(maskGroup);
    currentAddon = null;

    const g = new THREE.Group();
    const mat = new THREE.MeshPhongMaterial({color: 0xff0033, transparent: true, opacity: 0.85});

    let geo;
    switch(type) {
        case 'tactical_mask': geo = new THREE.SphereGeometry(1, 24, 18, 0, Math.PI*2, 0, Math.PI/2); break;
        case 'half_mask':     geo = new THREE.BoxGeometry(2, 1.2, 0.5); break;
        case 'full_mask':     geo = new THREE.SphereGeometry(1.3, 32, 28, 0, Math.PI*2, 0, Math.PI); break;
        case 'respirator':    geo = new THREE.SphereGeometry(1, 24, 18, 0, Math.PI*2, 0, Math.PI/2); break;
        case 'gas_mask':      geo = new THREE.SphereGeometry(1.35, 36, 30, 0, Math.PI*2, 0, Math.PI); break;
        default: type = 'tactical_mask'; geo = new THREE.SphereGeometry(1, 24, 18, 0, Math.PI*2, 0, Math.PI/2);
    }

    const mesh = new THREE.Mesh(geo, mat);
    mesh.rotation.x = Math.PI;
    mesh.position.z = 0.6;
    g.add(mesh);
    maskGroup.add(g);

    document.getElementById('mask').textContent = `MASK: ${type.toUpperCase().replace('_', ' ')}`;
    log(`MASK LOADED: ${type}`);
}

function createAddon(type) {
    if (!maskGroup) return;
    if (currentAddon) { maskGroup.remove(currentAddon); currentAddon = null; }
    if (type === 'none') return;

    const mat = new THREE.MeshPhongMaterial({color: 0x00ff00});
    const addon = new THREE.Group();

    try {
        switch(type) {
            case 'night_vision':
                addon.add(new THREE.Mesh(new THREE.BoxGeometry(1.7, 0.5, 0.45), mat)).position.set(0, 0.9, 0.5);
                break;
            case 'comms':
                const mic = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 0.9, 8), mat);
                mic.rotation.z = Math.PI / 3;
                mic.position.set(0.6, -0.1, 0.4);
                addon.add(mic);
                break;
            case 'filter':
                addon.add(new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.35, 0.7, 16), mat)).position.y = -0.65;
                break;
            case 'visor':
                const v = new THREE.Mesh(new THREE.PlaneGeometry(2.7, 1.7),
                    new THREE.MeshPhongMaterial({color: 0x00ff88, transparent: true, opacity: 0.33, side: THREE.DoubleSide}));
                v.position.set(0, 0.9, 0.5);
                v.rotation.x = -0.35;
                addon.add(v);
                break;
        }
        maskGroup.add(addon);
        currentAddon = addon;
    } catch(e) { ERROR('Addon failed', e); }
}

function startFaceMesh() {
    if (cameraActive) return;
    cameraActive = true;

    try {
        faceMesh = new FaceMesh({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.82,
            minTrackingConfidence: 0.82
        });
        faceMesh.onResults(onResults);

        const cam = new Camera(video, {
            onFrame: async () => { try { await faceMesh.send({image: video}); } catch(e) {} },
            width: 640, height: 480
        });
        cam.start();
        log('FACEMESH ONLINE');
    } catch(e) { ERROR('FaceMesh init failed', e); }
}

function onResults(results) {
    if (!results.multiFaceLandmarks?.[0]) {
        document.getElementById('track').textContent = 'FACE TRACKING: LOST';
        return;
    }
    document.getElementById('track').textContent = 'FACE TRACKING: LOCKED';
    const lm = results.multiFaceLandmarks[0];

    const nose = lm[1];
    const le = lm[33], re = lm[263];
    const scale = 8;

    maskGroup.position.x = (nose.x - 0.5) * scale;
    maskGroup.position.y = -(nose.y - 0.5) * scale * (innerHeight/innerWidth);
    maskGroup.position.z = -nose.z * scale * 1.8;

    const eyeDist = Math.hypot(re.x - le.x, re.y - le.y);
    const dynamic = Math.max(0.8, eyeDist * 19);
    maskGroup.scale.set(dynamic, dynamic, dynamic);

    const midEye = {x: (le.x + re.x)/2, y: (le.y + re.y)/2};
    maskGroup.rotation.y = (nose.x - midEye.x) * 5.5;
    maskGroup.rotation.x = (nose.y - midEye.y) * 5.5;
    maskGroup.rotation.z = Math.atan2(re.y - le.y, re.x - le.x);
}

function animate(t = 0) {
    requestAnimationFrame(animate);
    if (lastTime) {
        fps = Math.round(1000 / (t - lastTime));
        document.getElementById('fps').textContent = `FPS: ${fps}`;
    }
    lastTime = t;
    if (renderer && scene && camera) renderer.render(scene, camera);
}

document.getElementById('export').onclick = () => {
    if (!maskGroup || maskGroup.children.length === 0) return log('NO MASK TO EXPORT');
    const data = {
        mask: document.getElementById('mask-select').value,
        addon: document.getElementById('addon-select').value,
        position: maskGroup.position.toArray(),
        rotation: [maskGroup.rotation.x, maskGroup.rotation.y, maskGroup.rotation.z],
        scale: maskGroup.scale.toArray(),
        timestamp: Date.now()
    };
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}));
    a.download = `edtv_mask_${Date.now()}.json`;
    a.click();
    log('EXPORT SUCCESS');
};

document.getElementById('start').onclick = () => {
    if (!navigator.mediaDevices?.getUserMedia) return ERROR('getUserMedia not supported');
    navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}})
        .then(stream => {
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                startFaceMesh();
                log('AR LIVE');
            };
        })
        .catch(err => {
            ERROR('Camera access denied', err);
            if (location.protocol !== 'https:' && !location.hostname.includes('localhost'))
                log('HTTPS REQUIRED FOR CAMERA');
        });
};

document.getElementById('mask-select').onchange = e => createMask(e.target.value);
document.getElementById('addon-select').onchange = e => createAddon(e.target.value);

// INIT
init3D();
createMask('tactical_mask');
log('EDTV v8.1 FULLY ARMORED - NO ERRORS');
</script>
</body>
</html>
