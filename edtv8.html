<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>edTV: CHANNEL 8 - TACTICAL MASK DESIGNER v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P', cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none}
    #app{position:relative;width:100%;height:100vh;display:flex;flex-direction:column}
    .grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.08)1px, transparent 1px),
         linear-gradient(90deg,rgba(0,255,0,0.08)1px, transparent 1px);background-size:16px 16px;z-index:-1}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,20,0,0.1)50%);
         background-size:100% 4px;pointer-events:none;animation:s 8s linear infinite;z-index:-1}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    
    /* Top Banner */
    .banner{background:rgba(0,40,0,0.95);border-bottom:2px solid #0f0;padding:10px;text-align:center;font-size:12px;letter-spacing:1px}
    
    /* Main Content Area */
    .content{flex:1;display:flex;flex-direction:column;padding:10px;gap:10px}
    
    /* Controls Panel */
    .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;padding:10px;background:rgba(0,20,0,0.7);border:1px solid #0f0}
    
    .btn{background:#000;border:2px solid #0f0;color:#0f0;padding:8px 12px;font-size:10px;cursor:pointer;box-shadow:0 0 8px #0f0;transition:0.2s}
    .btn:hover,.btn:active{background:#0f0;color:#000}
    
    .dropdown{background:#000;border:2px solid #0f0;color:#0f0;padding:8px 12px;font-size:10px;cursor:pointer;width:200px}
    
    .color-picker{display:flex;align-items:center;gap:10px}
    .color-picker input{width:40px;height:30px;border:2px solid #0f0;background:#000;cursor:pointer}
    
    /* Terminal */
    .terminal{flex:1;background:rgba(0,0,0,0.7);border:1px solid #0f0;padding:10px;font-size:10px;overflow-y:auto;max-height:120px;min-height:120px}
    
    /* Bottom Section - Face and 3D View */
    .bottom-section{display:flex;height:60vh;gap:10px}
    
    .face-container{flex:1;position:relative;border:2px solid #0f0;background:#000;display:flex;justify-content:center;align-items:center;overflow:hidden}
    
    #cam{width:100%;height:100%;object-fit:cover}
    
    .view3d-container{flex:1;border:2px solid #0f0;background:#000;position:relative}
    
    #view3d{width:100%;height:100%;display:block}
    
    .mask-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10}
</style>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<div id="app">
    <div class="grid"></div>
    <div class="crt"></div>
    
    <div class="banner">
        edTV: CHANNEL 8 - TACTICAL MASK DESIGNER v2
    </div>
    
    <div class="content">
        <div class="controls">
            <button class="btn" id="scan">SCAN FACE</button>
            <button class="btn" id="calib">CALIBRATE</button>
            <button class="btn" id="try">TRY MASK</button>
            <button class="btn" id="export">EXPORT JSON</button>
            
            <div class="color-picker">
                <span>COLOR:</span>
                <input type="color" id="mask-color" value="#00ff00">
            </div>
            
            <select class="dropdown" id="addon-select">
                <option value="none">NO ADDONS</option>
                <option value="goggles">TACTICAL GOGGLES</option>
                <option value="helmet">FULL HELMET</option>
                <option value="respirator">RESPIRATOR</option>
                <option value="comms">COMMUNICATION SET</option>
            </select>
        </div>
        
        <div class="terminal" id="log">
            > SYSTEM INITIALIZED<br>
            > READY FOR FACE SCAN
        </div>
        
        <div class="bottom-section">
            <div class="face-container">
                <video id="cam" autoplay playsinline muted></video>
                <div class="mask-overlay" id="mask-overlay"></div>
            </div>
            
            <div class="view3d-container">
                <canvas id="view3d"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
const log = msg => { 
    document.getElementById('log').innerHTML += '<br>> ' + msg;
    document.getElementById('log').scrollTop = 9999;
};

const video = document.getElementById('cam');
const canvas3d = document.getElementById('view3d');
let scene, camera, renderer, controls, mask, helmet, currentAddon = null;
let landmarks = [];

// Mask parts
let maskParts = {
    base: null,
    goggles: null,
    respirator: null,
    comms: null
};

function init3D() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    camera = new THREE.PerspectiveCamera(60, canvas3d.clientWidth / canvas3d.clientHeight, 0.1, 100);
    camera.position.set(0, 0, 6);
    renderer = new THREE.WebGLRenderer({canvas: canvas3d, antialias: false});
    renderer.setSize(canvas3d.clientWidth, canvas3d.clientHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    
    // Lighting
    scene.add(new THREE.AmbientLight(0x004400));
    const dir = new THREE.DirectionalLight(0x00ff00, 0.6);
    dir.position.set(5, 10, 7); 
    scene.add(dir);
    
    // Create initial mask
    createMask();
    
    // Handle window resize
    window.addEventListener('resize', onWindowResize);
    
    animate();
}

function onWindowResize() {
    camera.aspect = canvas3d.clientWidth / canvas3d.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(canvas3d.clientWidth, canvas3d.clientHeight);
}

function createMask() {
    // Base mask
    const maskGeometry = new THREE.SphereGeometry(2, 32, 32, 0, Math.PI * 2, 0, Math.PI / 2);
    const maskMaterial = new THREE.MeshPhongMaterial({ 
        color: 0x00ff00, 
        transparent: true, 
        opacity: 0.7,
        shininess: 30
    });
    
    mask = new THREE.Mesh(maskGeometry, maskMaterial);
    mask.rotation.x = Math.PI / 2;
    scene.add(mask);
    
    // Add some details to the mask
    const detailGeometry = new THREE.TorusGeometry(1.5, 0.1, 16, 100, Math.PI);
    const detailMaterial = new THREE.MeshPhongMaterial({ color: 0x00aa00 });
    const detail = new THREE.Mesh(detailGeometry, detailMaterial);
    detail.rotation.x = Math.PI / 2;
    detail.position.z = 0.1;
    mask.add(detail);
    
    maskParts.base = mask;
}

function createAddon(type) {
    // Remove existing addon
    if (currentAddon && scene.getObjectById(currentAddon.id)) {
        scene.remove(currentAddon);
    }
    
    let addon;
    
    switch(type) {
        case 'goggles':
            const goggleGeometry = new THREE.TorusGeometry(0.8, 0.15, 16, 100);
            const goggleMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x006600, 
                transparent: true, 
                opacity: 0.8 
            });
            addon = new THREE.Mesh(goggleGeometry, goggleMaterial);
            addon.position.set(0, 0.5, 0.8);
            addon.rotation.x = Math.PI / 2;
            maskParts.goggles = addon;
            break;
            
        case 'helmet':
            const helmetGeometry = new THREE.SphereGeometry(2.2, 32, 32, 0, Math.PI * 2, 0, Math.PI);
            const helmetMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x004400,
                wireframe: true
            });
            addon = new THREE.Mesh(helmetGeometry, helmetMaterial);
            addon.position.set(0, 0.5, 0);
            maskParts.helmet = addon;
            break;
            
        case 'respirator':
            const respGeometry = new THREE.CylinderGeometry(0.3, 0.5, 1, 32);
            const respMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
            addon = new THREE.Mesh(respGeometry, respMaterial);
            addon.position.set(0, -0.8, 0.5);
            addon.rotation.x = Math.PI / 2;
            maskParts.respirator = addon;
            break;
            
        case 'comms':
            const commGeometry = new THREE.BoxGeometry(0.8, 0.2, 0.4);
            const commMaterial = new THREE.MeshPhongMaterial({ color: 0x222222 });
            addon = new THREE.Mesh(commGeometry, commMaterial);
            addon.position.set(0, -0.5, 1.2);
            maskParts.comms = addon;
            break;
            
        default:
            // No addon
            return;
    }
    
    if (addon) {
        scene.add(addon);
        currentAddon = addon;
    }
}

function updateMaskColor(color) {
    if (maskParts.base) {
        maskParts.base.material.color.set(color);
    }
    
    // Update addon colors if applicable
    if (maskParts.goggles) {
        maskParts.goggles.material.color.set(color);
    }
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// Face Mesh setup
const faceMesh = new FaceMesh({
    locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
    }
});

faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
});

faceMesh.onResults((results) => {
    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        landmarks = results.multiFaceLandmarks[0];
        
        // Update mask position based on face landmarks
        if (mask) {
            // Simple positioning based on face center
            const noseTip = landmarks[1]; // Nose tip landmark
            mask.position.x = (noseTip.x - 0.5) * 4;
            mask.position.y = -(noseTip.y - 0.5) * 4;
            
            // Update addon position if exists
            if (currentAddon) {
                currentAddon.position.x = mask.position.x;
                currentAddon.position.y = mask.position.y;
            }
        }
    }
});

let cam;
async function startCam() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user', width: 640, height: 480 }
        });
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            video.play();
            cam = new Camera(video, {
                onFrame: async () => {
                    await faceMesh.send({image: video});
                },
                width: 640,
                height: 480
            });
            cam.start();
            log('Webcam + FaceMesh active');
        };
    } catch(e) { 
        log('Webcam error: ' + e.message); 
    }
}

// Event Listeners
document.getElementById('scan').onclick = () => { 
    startCam(); 
    log('Initiating face scan...');
};

document.getElementById('calib').onclick = () => { 
    log('Calibration complete'); 
};

document.getElementById('try').onclick = () => { 
    log('Mask preview active'); 
};

document.getElementById('export').onclick = () => {
    if (!landmarks.length) { 
        log('No face data - scan face first'); 
        return; 
    }
    
    const maskData = {
        landmarks: landmarks.map(p => ({x: p.x, y: p.y, z: p.z})),
        maskColor: document.getElementById('mask-color').value,
        addon: document.getElementById('addon-select').value,
        topology: faceMesh.FACEMESH_TESSELATION,
        note: "Tactical mask design for 3D printing",
        timestamp: new Date().toISOString()
    };
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(maskData, null, 2)], {type: 'application/json'}));
    a.download = 'tactical_mask_design.json';
    a.click();
    log('Exported tactical_mask_design.json');
};

document.getElementById('mask-color').addEventListener('input', (e) => {
    updateMaskColor(e.target.value);
    log('Mask color updated: ' + e.target.value);
});

document.getElementById('addon-select').addEventListener('change', (e) => {
    createAddon(e.target.value);
    log('Addon changed: ' + e.target.value.toUpperCase());
});

// Initialize the app
init3D();
log('System ready - press SCAN FACE to begin');

// Make the face container fullscreen on double click
document.querySelector('.face-container').ondblclick = () => {
    if (video.requestFullscreen) {
        video.requestFullscreen();
    } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
    }
};
</script>
</body>
</html>