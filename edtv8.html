<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 8 // 2025 VR MASK DEPLOYMENT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0f0;overflow:hidden;height:100dvh;touch-action:manipulation;user-select:none}
  #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column}
  .grid,.crt{position:absolute;inset:0;pointer-events:none}
  .grid{background:linear-gradient(rgba(0,255,0,0.06)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.06)1px,transparent 1px);background-size:12px 12px;z-index:-1}
  .crt{background:linear-gradient(transparent 50%,rgba(0,30,0,0.15)50%);background-size:100% 3px;animation:s 6s linear infinite}
  @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
  .banner{background:rgba(0,40,0,0.98);border-bottom:2px solid #0f0;padding:12px 8px;font-size:10px;text-align:center;text-shadow:0 0 10px #0f0}
  .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;padding-bottom:max(env(safe-area-inset-bottom),16px)}
  .ar-view{flex:1;position:relative;border:2px solid #0f0;overflow:hidden;background:#000;border-radius:8px;box-shadow:0 0 20px rgba(0,255,0,0.6)}
  #video{width:100%;height:100%;object-fit:contain;background:#000;transform:scaleX(-1)}
  #view3d{position:absolute;inset:0;z-index:10}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;background:rgba(0,30,0,0.9);border:1px solid #0f0;box-shadow:0 0 12px rgba(0,255,0,0.5)}
  .btn,.dropdown{font-size:9px;padding:10px;border:2px solid #0f0;background:#000;color:#0f0;cursor:pointer;transition:.2s;flex:1 1 100px;max-width:240px}
  .btn:hover,.btn:active,.dropdown:active{background:#0f0;color:#000;box-shadow:0 0 15px #0f0}
  .terminal{flex:none;height:18dvh;background:rgba(0,0,0,0.85);border:1px solid #0f0;padding:8px;font-size:8px;overflow-y:auto;border-radius:4px}
  .status{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:8px;z-index:20;flex-wrap:wrap}
  .ind{padding:4px 8px;font-size:7px;background:rgba(0,60,0,0.9);border:1px solid #0f0;border-radius:4px}
  .locked{background:rgba(0,255,0,0.9);box-shadow:0 0 12px #0f0;animation:p 1.5s infinite}
  @keyframes p{0%,100%{opacity:1}50%{opacity:0.6}}
</style>
</head>
<body>
<div id="app">
  <div class="grid"></div><div class="crt"></div>
  <div class="banner">EDTV: CHANNEL 8 // 2025 VR MASK DEPLOYMENT</div>
  <div class="content">
    <div class="controls">
      <button class="btn" id="start">SYNC / CALIBRATE / START</button>
      <button class="btn" id="export">EXPORT JSON</button>
      <select class="dropdown" id="mask-select">
        <option value="tactical">TACTICAL</option>
        <option value="half">HALF FACE</option>
        <option value="full">FULL HELMET</option>
        <option value="respirator">RESPIRATOR</option>
        <option value="gas">GAS MASK</option>
        <option value="cyber" selected>CYBER DOG</option>
        <option value="oni">ONI DEMON</option>
      </select>
      <select class="dropdown" id="addon-select">
        <option value="none" selected>NO ADDON</option>
        <option value="nvg">NVG MOUNT</option>
        <option value="comms">COMMS PACK</option>
        <option value="filter">FILTER+</option>
        <option value="visor">VISOR SHIELD</option>
        <option value="horns">DEMON HORNS</option>
      </select>
    </div>
    <div class="terminal" id="log">> CHANNEL 8 2025 ONLINE<br>> READY FOR DEPLOYMENT</div>
    <div class="ar-view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="view3d"></canvas>
      <div class="status">
        <div class="ind" id="track">TRACKING: OFF</div>
        <div class="ind" id="mask">MASK: CYBER DOG</div>
        <div class="ind" id="addon">ADDON: NONE</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/loaders/GLTFLoader.js';
import {FaceLandmarker, FilesetResolver} from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs';

const video = document.getElementById('video');
const canvas = document.getElementById('view3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');
const addonEl = document.getElementById('addon');

let faceLandmarker, scene, camera, renderer, maskGroup = new THREE.Group();
let currentMask = null;
let calibrationOffset = new THREE.Vector2(0, 0.07);
let calibrationFrames = 0;

const loader = new GLTFLoader();

// Real-looking fallback models (public URLs – replace with your own for production)
const maskModels = {
  cyber: 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf',
  tactical: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Avocado/glTF/Avocado.gltf',
  oni: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Fox/glTF/Fox.gltf',
  full: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoomBox/glTF/BoomBox.gltf',
  gas: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Lantern/glTF/Lantern.gltf',
  respirator: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
  half: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf'
};

function log(m){const d=document.createElement('div');d.textContent='> '+m;logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}

function init3D(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, canvas.clientWidth/canvas.clientHeight, 0.01, 100);
  camera.position.z = 0.6;
  renderer = new THREE.WebGLRenderer({canvas, alpha:true, antialias:true});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  scene.add(new THREE.HemisphereLight(0x00ff88, 0x004422, 2));
  scene.add(maskGroup);
  window.addEventListener('resize',()=>{camera.aspect=canvas.clientWidth/canvas.clientHeight;camera.updateProjectionMatrix();renderer.setSize(canvas.clientWidth,canvas.clientHeight);});
}

function loadMask(type){
  if(currentMask){maskGroup.remove(currentMask);}
  loader.load(maskModels[type]||maskModels.cyber, gltf=>{
    currentMask = gltf.scene;
    currentMask.scale.setScalar(0.9);
    currentMask.rotation.y = Math.PI;
    maskGroup.add(currentMask);
    maskEl.textContent = `MASK: ${type.toUpperCase().replace('_',' ')}`;
    log(`LOADED: ${type.toUpperCase()}`);
  }, undefined, ()=>{createFallbackMask(type);});
}

function createFallbackMask(type){
  const geo = type==='cyber' ? new THREE.DodecahedronGeometry(0.12,1) :
              type==='oni' ? new THREE.TorusKnotGeometry(0.1,0.03,128,16) :
              new THREE.BoxGeometry(0.22,0.18,0.14);
  const mat = new THREE.MeshStandardMaterial({color:0x00ff88, metalness:0.8, roughness:0.2});
  const mesh = new THREE.Mesh(geo, mat);
  maskGroup.add(mesh);
  currentMask = mesh;
}

function updatePose(landmarks){
  const lm = landmarks.map(p=>({x:1-p.x, y:p.y, z:p.z}));
  const leftEye = lm[33], rightEye = lm[263], nose = lm[1];

  const centerX = (leftEye.x + rightEye.x)/2;
  const centerY = (leftEye.y + rightEye.y)/2 + calibrationOffset.y;

  const faceWidth = Math.abs(rightEye.x - leftEye.x);
  const scale = THREE.MathUtils.lerp(1.3, 2.4, faceWidth * 8);

  maskGroup.position.x = (centerX - 0.5) * 2.15;
  maskGroup.position.y = -(centerY - 0.5) * 2.15 + calibrationOffset.x;
  maskGroup.scale.set(scale, scale, scale);

  const yaw = (rightEye.x - leftEye.x) * 3;
  maskGroup.rotation.y = -yaw;
  maskGroup.rotation.x = (centerY - nose.y) * 32;
}

let running = false, last = 0;
function animate(t=0){
  if(running && faceLandmarker && t-last>33){
    last = t;
    const res = faceLandmarker.detectForVideo(video,t);
    if(res.faceLandmarks?.[0]){
      updatePose(res.faceLandmarks[0]);
      trackEl.textContent='TRACKING: LOCKED';
      trackEl.classList.add('locked');
      if(calibrationFrames<40){calibrationOffset.y += 0.0018; calibrationFrames++;}
    }else{
      trackEl.textContent='TRACKING: SEARCHING';
      trackEl.classList.remove('locked');
    }
  }
  renderer.render(scene,camera);
  if(!renderer.xr?.isPresenting) requestAnimationFrame(animate);
}

async function start(){
  if(running) return;
  log('SYNC + CALIBRATE + DEPLOY');
  calibrationFrames=0; calibrationOffset.set(0,0.07);
  const vision = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm');
  faceLandmarker = await FaceLandmarker.createFromOptions(vision,{
    baseOptions:{modelAssetPath:'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',delegate:'GPU'},
    runningMode:'VIDEO',numFaces:1
  });
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}}});
  video.srcObject=stream;
  await video.play();
  running=true;
  requestAnimationFrame(animate);
  log('CALIBRATING... KEEP FACE CENTERED');
}

document.getElementById('start').onclick = start;
document.getElementById('mask-select').onchange = e => loadMask(e.target.value);
document.getElementById('addon-select').onchange = () => log('ADDONS COMING SOON');
document.getElementById('export').onclick = () => {
  const data = {mask:maskEl.textContent,transform:{p:maskGroup.position.toArray(),r:[maskGroup.rotation.x,maskGroup.rotation.y,maskGroup.rotation.z],s:maskGroup.scale.x}};
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='channel8_mask.json'; a.click();
};

init3D();
loadMask('cyber');
log('CHANNEL 8 READY – PRESS SYNC TO DEPLOY');
requestAnimationFrame(animate);
</script>
</body>
</html>
