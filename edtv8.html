<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 8 // 2025 AR MASK DEPLOYMENT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0f0;overflow:hidden;height:100dvh;touch-action:manipulation;user-select:none}
  #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column}
  .grid,.crt{position:absolute;inset:0;pointer-events:none}
  .grid{background:linear-gradient(rgba(0,255,0,0.06)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.06)1px,transparent 1px);background-size:12px 12px}
  .crt{background:linear-gradient(transparent 50%,rgba(0,30,0,0.15)50%);background-size:100% 4px;animation:s 8s linear infinite}
  @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
  .banner{background:rgba(0,40,0,0.98);border-bottom:2px solid #0f0;padding:12px 8px;font-size:10px;text-align:center;text-shadow:0 0 10px #0f0}
  .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;padding-bottom:max(env(safe-area-inset-bottom),20px)}
  .ar-view{flex:1;position:relative;border:2px solid #0f0;overflow:hidden;background:#000;border-radius:8px;box-shadow:0 0 20px rgba(0,255,0,0.6)}
  #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #canvas{position:absolute;inset:0;width:100%;height:100%}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;padding:10px;background:rgba(0,30,0,0.9);border:2px solid #0f0}
  .btn,.dropdown{font-size:9px;padding:10px 14px;border:2px solid #0f0;background:#000;color:#0f0;cursor:pointer;transition:.2s;flex:1 1 100px;max-width:220px}
  .btn:hover,.btn:active,.dropdown:active{background:#0f0;color:#000;box-shadow:0 0 15px #0f0}
  .terminal{height:16dvh;background:rgba(0,0,0,0.9);border:2px solid #0f0;padding:8px;font-size:8px;overflow-y:auto;color:#0f0}
  .status{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:8px;z-index:20;flex-wrap:wrap}
  .ind{padding:4px 8px;font-size:7px;background:rgba(0,60,0,0.9);border:1px solid #0f0;border-radius:4px}
  .locked{background:rgba(0,255,0,0.9);box-shadow:0 0 12px #0f0;animation:p 1.5s infinite}
  @keyframes p{0%,100%{opacity:1}50%{opacity:0.6}}
</style>
</head>
<body>
<div id="app">
  <div class="grid"></div><div class="crt"></div>
  <div class="banner">EDTV: CHANNEL 8 // 2025 AR MASK DEPLOYMENT</div>
  <div class="content">
    <div class="controls">
      <button class="btn" id="start">SYNC / CALIBRATE / DEPLOY</button>
      <button class="btn" id="export">EXPORT FIT JSON</button>
      <select class="dropdown" id="mask-select">
        <option value="oni" selected>ONI DEMON</option>
        <option value="tactical">TACTICAL</option>
        <option value="gas">GAS MASK</option>
        <option value="respirator">RESPIRATOR</option>
        <option value="half">HALF FACE</option>
        <option value="full">FULL HELMET</option>
      </select>
    </div>
    <div class="terminal" id="log">> CHANNEL 8 2025 ONLINE<br>> READY FOR AR DEPLOYMENT</div>
    <div class="ar-view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="status">
        <div class="ind" id="track">TRACKING: OFF</div>
        <div class="ind" id="mask">MASK: ONI DEMON</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
import {GLTFLoader} from 'https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/loaders/GLTFLoader.js';
import {FaceLandmarker, FilesetResolver} from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs';

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');

let faceLandmarker, renderer, scene, camera, maskObject = null;
let currentMask = 'oni';
let currentConfig = {};

const maskConfigs = {
  oni: {baseScale: 1.8, zOffset: -0.58, yOffset: -0.04},
  tactical: {baseScale: 2.2, zOffset: -0.52, yOffset: 0.08},
  gas: {baseScale: 2.6, zOffset: -0.68, yOffset: 0.02},
  respirator: {baseScale: 1.4, zOffset: -0.45, yOffset: 0.12},
  half: {baseScale: 1.6, zOffset: -0.50, yOffset: 0.06},
  full: {baseScale: 2.0, zOffset: -0.55, yOffset: 0.04}
};

const maskModels = {
  oni: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Fox/glTF/Fox.gltf',
  tactical: 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf',
  gas: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Lantern/glTF/Lantern.gltf',
  respirator: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
  half: 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf',
  full: 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf'
};

function log(m){ const d=document.createElement('div'); d.textContent='> '+m; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }

function initThree() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, 1, 0.1, 10);
  renderer = new THREE.WebGLRenderer({canvas, alpha: true, antialias: true});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  const light = new THREE.HemisphereLight(0x00ff88, 0x008844, 1.8);
  scene.add(light);
  resize();
  window.addEventListener('resize', resize);
}

function resize() {
  const w = canvas.clientWidth, h = canvas.clientHeight;
  canvas.width = w; canvas.height = h;
  renderer.setSize(w, h);
  camera.aspect = w/h; camera.updateProjectionMatrix();
}

function loadMask(type) {
  if (maskObject) scene.remove(maskObject);
  currentMask = type;
  currentConfig = maskConfigs[type] || {baseScale: 1.8, zOffset: -0.55, yOffset: 0};
  new GLTFLoader().load(maskModels[type], gltf => {
    maskObject = gltf.scene;
    maskObject.scale.setScalar(currentConfig.baseScale);
    maskObject.position.z = currentConfig.zOffset;
    maskObject.position.y = currentConfig.yOffset;
    maskObject.rotation.y = Math.PI;
    scene.add(maskObject);
    maskEl.textContent = `MASK: ${type.toUpperCase()}`;
    log(`MASK LOADED: ${type.toUpperCase()}`);
  }, undefined, () => {
    const geo = new THREE.DodecahedronGeometry(0.15, 1);
    const mat = new THREE.MeshStandardMaterial({color:0x00ff88, metalness:0.9, roughness:0.1});
    maskObject = new THREE.Mesh(geo, mat);
    maskObject.scale.setScalar(currentConfig.baseScale);
    maskObject.position.z = currentConfig.zOffset;
    maskObject.position.y = currentConfig.yOffset;
    maskObject.rotation.y = Math.PI;
    scene.add(maskObject);
    log(`FALLBACK MASK: ${type.toUpperCase()}`);
  });
}

function updateMask(landmarks) {
  if (!maskObject) return;
  const lm = landmarks.map(p => ({x: 1 - p.x, y: p.y, z: p.z}));
  const le = lm[33], re = lm[263], nose = lm[1];

  const eyeDist = Math.hypot(re.x - le.x, re.y - le.y);
  const centerX = (le.x + re.x)/2;
  const centerY = (le.y + re.y)/2;

  const trackedScale = THREE.MathUtils.lerp(1.5, 3.0, eyeDist * 10);

  maskObject.scale.setScalar(trackedScale * currentConfig.baseScale);

  maskObject.position.x = (centerX - 0.5) * 2.4;
  maskObject.position.y = -(centerY - 0.5) * 2.4 + currentConfig.yOffset + 0.08;
  maskObject.position.z = currentConfig.zOffset;

  const yaw = (re.x - le.x) * 4.8;
  const pitch = (centerY - nose.y) * 36;
  const roll = Math.atan2(le.y - re.y, re.x - le.x);

  maskObject.rotation.set(pitch * Math.PI/180, Math.PI + yaw, roll);
}

async function start() {
  log('INITIALIZING AR CORE...');
  const vision = await FilesetResolver.forVisionTasks('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm');
  faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
    baseOptions: {modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task', delegate: 'GPU'},
    runningMode: 'VIDEO',
    numFaces: 1
  });

  const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'user', width: {ideal: 1280}, height: {ideal: 720}});
  video.srcObject = stream;
  video.onloadedmetadata = () => video.play();

  log('AR CORE ACTIVE – FACE TRACKING LOCKED');
  trackEl.textContent = 'TRACKING: LOCKED';
  trackEl.classList.add('locked');

  function detect() {
    if (faceLandmarker && video.readyState >= 2) {
      const results = faceLandmarker.detectForVideo(video, performance.now());
      if (results.faceLandmarks?.[0]) {
        updateMask(results.faceLandmarks[0]);
        renderer.render(scene, camera);
      }
      // keep last pose if face lost
    }
    requestAnimationFrame(detect);
  }
  detect();
}

document.getElementById('start').onclick = start;
document.getElementById('mask-select').onchange = e => loadMask(e.target.value);

document.getElementById('export').onclick = () => {
  if (!maskObject) return log('NO MASK LOADED');
  const data = {
    mask: currentMask,
    position: maskObject.position.toArray(),
    rotation: maskObject.rotation.toArray(),
    scale: maskObject.scale.x
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `channel8_${currentMask}_fit.json`;
  a.click();
  log(`EXPORTED: ${currentMask.toUpperCase()} FIT JSON`);
};

initThree();
loadMask('oni');
log('CHANNEL 8 AR READY – PRESS SYNC TO DEPLOY');
</script>
</body>
</html>
