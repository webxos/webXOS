<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>edTV: CHANNEL 8</title>
    <meta name="theme-color" content="#000000">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
        body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
        #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
        .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3}
        .crt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;z-index:5;pointer-events:none;animation:scanline 8s linear infinite}
        @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
        .top-banner{position:absolute;top:0;left:0;width:100%;height:50px;background:rgba(0,100,0,0.9);border-bottom:2px solid #0f0;display:flex;align-items:center;justify-content:center;z-index:12}
        .top-banner-text{font-size:14px;color:#0f0;text-shadow:1px 1px 0 #000;letter-spacing:1px}
        .ppv-face-view{position:absolute;top:10px;right:10px;width:140px;height:105px;background:#000;border:2px solid #0f0;z-index:15;overflow:hidden;cursor:pointer;transition:0.3s}
        .ppv-face-view.expanded{width:100%;height:100%;top:0;right:0;z-index:20}
        .scanner{position:absolute;top:0;left:0;width:100%;height:4px;background:#0f0;box-shadow:0 0 10px #0f0;animation:scan 2s linear infinite;display:none}
        @keyframes scan{0%{top:0%}100%{top:100%}}
        #visualizationContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2}
        .instructions{position:absolute;top:60px;left:10px;right:10px;font-size:8px;color:#0f0;z-index:11;background:rgba(0,0,0,0.7);padding:10px;border:1px solid #0f0}

        /* MOBILE-FIXED BOTTOM BAR */
        .controls{
            position:fixed;
            bottom:0;
            left:0;
            width:100%;
            padding:20px 10px 30px 10px;
            padding-bottom:max(30px, env(safe-area-inset-bottom));
            background:linear-gradient(transparent,rgba(0,0,0,0.9));
            display:flex;
            justify-content:center;
            gap:15px;
            z-index:999;
            flex-wrap:wrap;
        }
        .btn{
            min-width:100px;
            height:50px;
            background:#000;
            border:3px solid #0f0;
            color:#0f0;
            font-size:11px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:0.2s;
            box-shadow:0 0 10px #0f0;
        }
        .btn:hover,.btn:active{background:#0f0;color:#000}

        @media(max-width:767px){
            .btn{min-width:90px;height:48px;font-size:10px}
            .controls{gap:10px;padding:15px 8px 35px 8px}
        }
    </style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt-overlay"></div>
    <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 8 - TACTICAL MASK DESIGNER</div></div>
    <div class="ppv-face-view" id="ppvFaceView"><canvas id="ppvCanvas"></canvas><div class="scanner" id="scanner"></div></div>
    <div id="visualizationContainer"><canvas id="visualizationCanvas"></canvas></div>
    <div class="instructions">
        TACTICAL MASK DESIGN<br>
        • Scan face → Edit wireframe → Calibrate → TRY → Export JSON<br>
        • Single-color, lightweight lattice for 3D print<br>
        • For Anduril-style military contractors
    </div>
    <div class="controls">
        <button id="scanBtn" class="btn">SCAN</button>
        <button id="calibrateBtn" class="btn">CALIBRATE</button>
        <button id="tryBtn" class="btn">TRY</button>
        <button id="exportBtn" class="btn">EXPORT JSON</button>
    </div>
</div>

<script>
    const { FaceMesh, FACEMESH_TESSELATION } = window.faceMesh;
    const { drawConnectors } = window.drawingUtils;
    const { Camera } = window.cameraUtils;

    let scene, cam, ren, controls;
    let faceWireframe, editedLandmarks = [];
    let stream, faceMesh, camera;
    let isScanning = false, isFullScreen = false;

    const $ = s => document.querySelector(s);

    function init() { init3D(); setupFaceDetection(); setupEventListeners(); }
    function init3D() {
        scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000);
        cam = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
        cam.position.set(0,0,5);
        ren = new THREE.WebGLRenderer({canvas: $('#visualizationCanvas'), antialias:false});
        ren.setSize(innerWidth, innerHeight); ren.setPixelRatio(Math.min(devicePixelRatio,2));
        controls = new THREE.OrbitControls(cam, ren.domElement); controls.enableDamping = true;
        scene.add(new THREE.AmbientLight(0x003300));
        scene.add(new THREE.DirectionalLight(0x00ff00,0.4).position.set(5,10,5));
        faceWireframe = createWireframe(); scene.add(faceWireframe);
        animate();
    }
    function createWireframe() {
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(468*3),3));
        const indices = []; FACEMESH_TESSELATION.forEach(([a,b])=>indices.push(a,b));
        geo.setIndex(indices);
        const mat = new THREE.LineBasicMaterial({color:0x00ff00});
        const wire = new THREE.LineSegments(geo, mat);
        wire.scale.set(10,10,10); return wire;
    }
    function updateWireframe(lm) {
        const pos = faceWireframe.geometry.attributes.position.array;
        lm.forEach((l,i)=>{ pos[i*3]=(l.x-0.5)*2; pos[i*3+1]=-(l.y-0.5)*2; pos[i*3+2]=l.z*-2; });
        faceWireframe.geometry.attributes.position.needsUpdate = true;
    }
    function setupFaceDetection() {
        faceMesh = new FaceMesh({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
        faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true});
        faceMesh.onResults(r=>{
            const ctx=$('#ppvCanvas').getContext('2d');
            ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
            if(r.image) ctx.drawImage(r.image,0,0,ctx.canvas.width,ctx.canvas.height);
            if(r.multiFaceLandmarks?.length){
                const lm = r.multiFaceLandmarks[0];
                drawConnectors(ctx, lm, FACEMESH_TESSELATION, {color:'#0f0',lineWidth:1});
                if(isScanning){ editedLandmarks=lm.map(p=>({x:p.x,y:p.y,z:p.z})); updateWireframe(lm); }
            }
        });
    }
    function startWebcam(){
        navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}).then(s=>{
            stream=s;
            const v=document.createElement('video'); v.srcObject=s; v.autoplay=v.playsInline=true; v.style.display='none'; document.body.appendChild(v);
            camera = new Camera(v, {onFrame:()=>faceMesh.send({image:v})}); camera.start();
            $('#ppvCanvas').width=$('#ppvFaceView').clientWidth; $('#ppvCanvas').height=$('#ppvFaceView').clientHeight;
        });
    }
    function setupEventListeners(){
        $('#scanBtn').onclick=()=>{isScanning=true; startWebcam(); $('#scanner').style.display='block';};
        $('#calibrateBtn').onclick=()=>{alert('Calibrated for tactical fit'); isScanning=false; $('#scanner').style.display='none';};
        $('#tryBtn').onclick=()=>{alert('Mask applied in view');};
        $('#exportBtn').onclick=()=>{
            const data={landmarks:editedLandmarks, topology:FACEMESH_TESSELATION, note:"Tactical single-print mask"};
            const a=document.createElement('a');
            a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
            a.download='tactical_mask.json'; a.click();
        };
        $('#ppvFaceView').ondblclick=()=>{
            isFullScreen=!isFullScreen;
            $('#ppvFaceView').classList.toggle('expanded',isFullScreen);
        };
        window.onresize=()=>{cam.aspect=innerWidth/innerHeight; cam.updateProjectionMatrix(); ren.setSize(innerWidth,innerHeight);};
    }
    function animate(){requestAnimationFrame(animate); controls.update(); ren.render(scene,cam);}
    window.onload=init;
</script>
</body>
</html>
