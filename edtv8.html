<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EDTV: CHANNEL 8 // 2025 VR MASK DEPLOYMENT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100dvh;touch-action:manipulation;user-select:none}
    #app{position:relative;width:100%;height:100dvh;display:flex;flex-direction:column}
    .grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.06)1px,transparent 1px),
         linear-gradient(90deg,rgba(0,255,0,0.06)1px,transparent 1px);background-size:12px 12px;z-index:-1}
    .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,30,0,0.15)50%);
         background-size:100% 3px;animation:s 6s linear infinite;pointer-events:none}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    .banner{background:rgba(0,40,0,0.98);border-bottom:2px solid #0f0;padding:8px 12px;font-size:10px;
            text-align:center;letter-spacing:1.5px;z-index:10;color:#0f0;text-shadow:0 0 8px #0f0}
    .content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px;overflow:hidden}
    .ar-view{flex:1;position:relative;border:2px solid #0f0;overflow:hidden;background:#000;border-radius:8px}
    #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #canvas3d{position:absolute;inset:0;width:100%;height:100%}
    .controls{background:rgba(0,20,0,0.9);border:1px solid #0f0;padding:10px;border-radius:6px;
             display:grid;grid-template-columns:1fr 1fr;gap:8px;z-index:10}
    @media(min-width:480px){.controls{grid-template-columns:repeat(4,1fr)}}
    .btn,.dropdown{background:#000;border:2px solid #0f0;color:#0f0;padding:10px 8px;font-size:9px;
            cursor:pointer;transition:0.2s;text-align:center;border-radius:4px}
    .btn:active,.dropdown:active,.btn:hover{background:#0f0;color:#000;box-shadow:0 0 12px #0f0}
    .terminal{background:rgba(0,0,0,0.8);border:1px solid #0f0;padding:8px;font-size:8px;
              max-height:120px;overflow-y:auto;border-radius:4px;line-height:1.4;color:#0f0}
    .status{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:8px;z-index:20;flex-wrap:wrap}
    .ind{background:rgba(0,60,0,0.9);border:1px solid #0f0;padding:4px 8px;font-size:7px;border-radius:4px}
    .locked{color:#0ff;text-shadow:0 0 12px #0ff;animation:p 1.5s infinite}
    @keyframes p{0%,100%{opacity:1}50%{opacity:0.6}}
</style>
</head>
<body>
<div id="app">
    <div class="grid"></div><div class="crt"></div>
    <div class="banner">EDTV: CHANNEL 8 // 2025 VR MASK DEPLOYMENT</div>
    <div class="content">
        <div class="ar-view">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas3d"></canvas>
            <div class="status">
                <div class="ind" id="track">TRACKING: OFF</div>
                <div class="ind" id="mask">MASK: TACTICAL</div>
                <div class="ind" id="addon">ADDON: NONE</div>
                <div class="ind" id="fps">FPS: 0</div>
            </div>
        </div>
        <div class="controls">
            <button class="btn" id="start">START AR</button>
            <button class="btn" id="export">EXPORT JSON</button>
            <select class="dropdown" id="mask-select">
                <option value="tactical">TACTICAL</option>
                <option value="half">HALF FACE</option>
                <option value="full">FULL HELMET</option>
                <option value="respirator">RESPIRATOR</option>
                <option value="gas">GAS MASK</option>
                <option value="cyber">CYBER DOG</option>
                <option value="oni">ONI DEMON</option>
            </select>
            <select class="dropdown" id="addon-select">
                <option value="none">NO ADDON</option>
                <option value="nvg">NVG MOUNT</option>
                <option value="comms">COMMS PACK</option>
                <option value="filter">FILTER+</option>
                <option value="visor">VISOR SHIELD</option>
                <option value="horns">DEMON HORNS</option>
            </select>
        </div>
        <div class="terminal" id="log">
            >EDTV CHANNEL 8 2025<br>>HIGH-PRECISION 3D PRINT MASK SYSTEM<br>>READY FOR DEPLOYMENT
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script type="module">
import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

const video = document.getElementById('video');
const canvas = document.getElementById('canvas3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');
const addonEl = document.getElementById('addon');
const fpsEl = document.getElementById('fps');

let faceLandmarker = null;
let running = false;
let lastTime = 0;

// Three.js
let scene, camera, renderer, maskGroup, currentMask = null, currentAddon = null;

function log(m) {
    logEl.innerHTML += `<br>> ${m}`;
    logEl.scrollTop = logEl.scrollHeight;
}

function init3D() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
    camera.position.z = 0.8;
    renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    scene.add(new THREE.HemisphereLight(0x00ff88, 0x0088ff, 1.8));
    scene.add(new THREE.AmbientLight(0x00ff88, 0.6));
    maskGroup = new THREE.Group();
    scene.add(maskGroup);
    window.addEventListener('resize', () => {
        camera.aspect = canvas.clientWidth / canvas.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    });
    animate();
    log('3D CORE 2025 ONLINE');
}

function createMask(type) {
    if (currentMask) maskGroup.remove(currentMask);
    currentMask = new THREE.Group();
    
    const mat = new THREE.MeshBasicMaterial({
        color: 0x00ff88,
        wireframe: true,
        transparent: true,
        opacity: 0.94
    });

    let geo;
    switch(type) {
        case 'tactical':   geo = new THREE.BoxGeometry(0.46, 0.38, 0.34); break;
        case 'half':       geo = new THREE.SphereGeometry(0.28, 40, 20, 0, Math.PI*2, 0, Math.PI/2); break;
        case 'full':       geo = new THREE.IcosahedronGeometry(0.32, 1); break;
        case 'respirator': geo = new THREE.CylinderGeometry(0.25, 0.28, 0.40, 32); break;
        case 'gas':        geo = new THREE.SphereGeometry(0.34, 48, 36); break;
        case 'cyber':      geo = new THREE.TorusKnotGeometry(0.22, 0.06, 128, 16); break;
        case 'oni':        geo = new THREE.OctahedronGeometry(0.32, 2); break;
    }
    const mesh = new THREE.Mesh(geo, mat);
    currentMask.add(mesh);
    maskGroup.add(currentMask);
    maskEl.textContent = `MASK: ${type.toUpperCase()}`;
    log(`MASK LOADED: ${type.toUpperCase()}`);
    createAddon(document.getElementById('addon-select').value);
}

function createAddon(type) {
    if (currentAddon) maskGroup.remove(currentAddon);
    currentAddon = null;
    if (type === 'none') { addonEl.textContent = 'ADDON: NONE'; return; }
    
    currentAddon = new THREE.Group();
    const mat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
    
    switch(type) {
        case 'nvg':
            const nvg = new THREE.Mesh(new THREE.BoxGeometry(0.38, 0.14, 0.18), mat);
            nvg.position.set(0, 0.18, 0.20);
            currentAddon.add(nvg);
            break;
        case 'comms':
            const comm = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 0.24, 8), mat);
            comm.rotation.z = Math.PI / 3; comm.position.set(0.16, -0.06, 0.14);
            currentAddon.add(comm);
            break;
        case 'filter':
            const filter = new THREE.Mesh(new THREE.CylinderGeometry(0.09, 0.11, 0.20, 20), mat);
            filter.position.y = -0.24;
            currentAddon.add(filter);
            break;
        case 'visor':
            const visor = new THREE.Mesh(new THREE.PlaneGeometry(0.54, 0.34),
                new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.5, side: THREE.DoubleSide }));
            visor.position.set(0, 0.10, 0.22); visor.rotation.x = -0.4;
            currentAddon.add(visor);
            break;
        case 'horns':
            const hornGeo = new THREE.ConeGeometry(0.06, 0.24, 8);
            const hornL = new THREE.Mesh(hornGeo, mat); hornL.position.set(-0.14, 0.22, 0.06); hornL.rotation.x = -0.4;
            const hornR = new THREE.Mesh(hornGeo, mat); hornR.position.set(0.14, 0.22, 0.06); hornR.rotation.x = -0.4;
            currentAddon.add(hornL, hornR);
            break;
    }
    maskGroup.add(currentAddon);
    addonEl.textContent = `ADDON: ${type.toUpperCase()}`;
}

function updateHeadPose(landmarks) {
    const nose = landmarks[1];
    const chin = landmarks[152];
    const leftEye = landmarks[33];
    const rightEye = landmarks[263];
    const leftTemple = landmarks[234];
    const rightTemple = landmarks[454];

    const centerX = (leftTemple.x + rightTemple.x) / 2;
    const centerY = (nose.y + chin.y) / 2;
    const faceWidth = Math.abs(rightTemple.x - leftTemple.x);
    const scale = THREE.MathUtils.lerp(0.9, 2.0, faceWidth * 9);

    maskGroup.position.x = (centerX - 0.5) * 2.3;
    maskGroup.position.y = -(centerY - 0.5) * 2.3;
    maskGroup.scale.set(scale, scale, scale);

    const yaw = (rightEye.x - leftEye.x) * 3.0;
    maskGroup.rotation.y = -yaw;

    const eyeMidY = (leftEye.y + rightEye.y) / 2;
    const pitch = (eyeMidY - nose.y) * 40;
    maskGroup.rotation.x = pitch;

    const dx = rightEye.x - leftEye.x;
    const dy = rightEye.y - leftEye.y;
    const roll = Math.atan2(dy, dx);
    maskGroup.rotation.z = -roll;

    trackEl.textContent = 'TRACKING: LOCKED';
    trackEl.classList.add('locked');
}

async function startAR() {
    if (running) return;
    running = true;
    log('DEPLOYING 2025 VR MASK SYSTEM...');
    try {
        const vision = await FilesetResolver.forVisionTasks(
            "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
        );
        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                delegate: "GPU"
            },
            outputFaceBlendshapes: true,
            runningMode: "VIDEO",
            numFaces: 1
        });

        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 }}
        });
        video.srcObject = stream;
        await video.play();

        const detect = () => {
            if (!running) return;
            const now = performance.now();
            const results = faceLandmarker.detectForVideo(video, now);
            if (results.faceLandmarks?.[0]) {
                updateHeadPose(results.faceLandmarks[0]);
            } else {
                trackEl.textContent = 'TRACKING: SEARCHING';
                trackEl.classList.remove('locked');
            }
            requestAnimationFrame(detect);
        };
        detect();
        log('CHANNEL 8 // FULLY DEPLOYED');
    } catch (e) {
        log('DEPLOY FAILED: ' + e.message);
        running = false;
    }
}

function animate(t = 0) {
    requestAnimationFrame(animate);
    if (lastTime) fpsEl.textContent = `FPS: ${Math.round(1000/(t-lastTime))}`;
    lastTime = t;
    if (currentMask) {
        currentMask.rotation.z += 0.003;
        currentMask.rotation.y += 0.001;
    }
    renderer.render(scene, camera);
}

document.getElementById('start').onclick = startAR;
document.getElementById('mask-select').onchange = e => createMask(e.target.value);
document.getElementById('addon-select').onchange = e => createAddon(e.target.value);

document.getElementById('export').onclick = () => {
    const data = {
        channel: "EDTV8",
        timestamp: new Date().toISOString(),
        mask: document.getElementById('mask-select').value,
        addon: document.getElementById('addon-select').value,
        pose: {
            position: maskGroup.position.toArray(),
            rotation: maskGroup.rotation.toArray().slice(0,3),
            scale: maskGroup.scale.x
        }
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `EDTV8_${data.mask}_${data.addon}_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    log('CONFIG EXPORTED – READY FOR 3D PRINT');
};

init3D();
createMask('cyber');
log('SYSTEM ARMED – TAP "START AR"');
</script>
</body>
</html>
