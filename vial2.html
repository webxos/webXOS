<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Vial MCP - Gateway</title>
  <style>
    body {
      background: #000000;
      margin: 0;
      font-family: 'Courier New', monospace;
      color: #00ff00;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      text-align: center;
      padding: 1rem;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      text-shadow: 0 0 3px #00ff00;
    }
    .terminal {
      background: #000000;
      border: 1px solid #00ff00;
      width: 90vw;
      max-width: 300px;
      height: 300px;
      overflow-y: auto;
      padding: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
    .input {
      width: 80%;
      background: #000000;
      border: 1px solid #00ff00;
      color: #00ff00;
      padding: 0.3rem;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      max-width: 300px;
    }
    .button {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #00ff00;
      color: #00ff00;
      padding: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 3px;
    }
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .error {
      color: #ff0000;
      text-shadow: 0 0 2px #ff0000;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }
    .import-export {
      margin-top: 0.5rem;
    }
    .footer {
      position: fixed;
      bottom: 0.5rem;
      font-size: 0.7rem;
      color: #00ff00;
    }
    @media (min-width: 768px) {
      .terminal { max-width: 400px; height: 350px; }
      .button { font-size: 1rem; padding: 0.7rem; }
      h1 { font-size: 2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Vial MCP - Gateway</h1>
    <div class="terminal" id="terminal"></div>
    <input type="text" class="input" id="commandInput" placeholder="Enter command (e.g., /auth, /help)" />
    <div id="error" class="error"></div>
    <div class="buttons" id="authButtons" style="display: none;">
      <button class="button" id="dashboardBtn">Dashboard</button>
      <button class="button" id="vialRemoteBtn">Vial MCP Remote</button>
      <button class="button" id="chatbotBtn">Chatbot</button>
      <button class="button" id="apiKeyBtn">Generate API Key</button>
    </div>
    <div class="import-export" id="importExport" style="display: none;">
      <input type="file" id="importFile" accept=".md" />
      <button class="button" id="exportBtn">Export MD</button>
    </div>
    <button class="button" id="troubleshootBtn">Troubleshoot</button>
    <div class="footer">WebXOS 2025 Â© | Version: xAI Artifact Updated | Time: 02:58 AM EDT, August 15, 2025</div>

    <script>
      const terminal = document.getElementById('terminal');
      const commandInput = document.getElementById('commandInput');
      const errorDiv = document.getElementById('error');
      const authButtons = document.getElementById('authButtons');
      const importExport = document.getElementById('importExport');
      const dashboardBtn = document.getElementById('dashboardBtn');
      const vialRemoteBtn = document.getElementById('vialRemoteBtn');
      const chatbotBtn = document.getElementById('chatbotBtn');
      const apiKeyBtn = document.getElementById('apiKeyBtn');
      const importFile = document.getElementById('importFile');
      const exportBtn = document.getElementById('exportBtn');
      const troubleshootBtn = document.getElementById('troubleshootBtn');
      const SERVER_URL = 'http://localhost:8080';

      const log = (message, isError = false) => {
        const color = isError ? '#ff0000' : '#00ff00';
        terminal.innerHTML += `<span style="color: ${color}">${message}</span>\n`;
        terminal.scrollTop = terminal.scrollHeight;
      };

      const fetchWithFallback = async (url, options) => {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (err) {
          if (navigator.onLine) {
            log(`Network Error: ${err.message}\nTraceback: ${err.stack}`, true);
            return { error: { code: -32000, message: err.message, traceback: err.stack } };
          }
          log('Offline: Using cached data or fallback...', true);
          const cached = localStorage.getItem('lastResponse');
          return cached ? JSON.parse(cached) : { error: { code: -32005, message: 'Offline with no cached data' } };
        }
      };

      const handleCommand = async (command) => {
        log(`> ${command}`);
        try {
          let response;
          const [cmd, ...args] = command.split(' ');
          switch (cmd.toLowerCase()) {
            case '/auth':
              const username = prompt('Enter username:') || '';
              const password = prompt('Enter password:') || '';
              if (!username || !password) throw new Error('Username and password are required');
              response = await fetchWithFallback(`${SERVER_URL}/mcp/auth`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password }),
              });
              if (response.error) throw new Error(response.error.message);
              localStorage.setItem('access_token', response.access_token);
              localStorage.setItem('vials', JSON.stringify(response.vials));
              localStorage.setItem('lastResponse', JSON.stringify(response));
              authButtons.style.display = 'flex';
              importExport.style.display = 'block';
              log(`Authenticated. Vials: ${JSON.stringify(response.vials)}`);
              setInterval(fetchStatus, 5000);
              break;
            case '/help':
              log('Commands: /auth, /status, /troubleshoot');
              break;
            case '/status':
              await fetchStatus();
              break;
            case '/troubleshoot':
              response = await fetchWithFallback(`${SERVER_URL}/mcp/checklist`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
              if (response.error) throw new Error(response.error.message);
              log(`Checklist Result:\n${JSON.stringify(response.result, null, 2)}`);
              break;
            default:
              throw new Error(`Unknown command: ${cmd}`);
          }
        } catch (err) {
          log(`Error: ${err.message}\nTraceback: ${err.stack}`, true);
          errorDiv.textContent = `Authentication Failed: ${err.message}`;
        }
      };

      const fetchStatus = async () => {
        try {
          const token = localStorage.getItem('access_token');
          if (!token) throw new Error('No authentication token found');
          const response = await fetchWithFallback(`${SERVER_URL}/mcp/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ jsonrpc: '2.0', method: 'mcp.getSystemMetrics', params: { user_id: 'test_user' }, id: 1 }),
          });
          if (response.error) throw new Error(response.error.message);
          log(`Status: CPU ${response.result.cpu_usage}%, Memory ${response.result.memory_usage}%, Users ${response.result.active_users}, Balance: ${response.result.balance || 0} WebXOS`);
          localStorage.setItem('lastResponse', JSON.stringify(response));
        } catch (err) {
          log(`Status Error: ${err.message}\nTraceback: ${err.stack}`, true);
        }
      };

      dashboardBtn.addEventListener('click', () => window.location.href = '/dashboard');
      vialRemoteBtn.addEventListener('click', () => window.location.href = '/vial');
      chatbotBtn.addEventListener('click', () => window.location.href = '/chatbot');
      apiKeyBtn.addEventListener('click', async () => {
        try {
          const token = localStorage.getItem('access_token');
          if (!token) throw new Error('No authentication token found');
          const response = await fetchWithFallback(`${SERVER_URL}/mcp/api_key`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ jsonrpc: '2.0', method: 'mcp.generateApiKey', params: { user_id: 'test_user' }, id: 2 }),
          });
          if (response.error) throw new Error(response.error.message);
          log(`API Key: ${response.result}`);
        } catch (err) {
          log(`API Key Error: ${err.message}\nTraceback: ${err.stack}`, true);
        }
      });
      exportBtn.addEventListener('click', async () => {
        try {
          const token = localStorage.getItem('access_token');
          if (!token) throw new Error('No authentication token found');
          const response = await fetchWithFallback(`${SERVER_URL}/mcp/export`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ jsonrpc: '2.0', method: 'mcp.exportMd', params: { user_id: 'test_user' }, id: 3 }),
          });
          if (response.error) throw new Error(response.error.message);
          const blob = new Blob([response.result], { type: 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'vial_data.md';
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          log(`Export Error: ${err.message}\nTraceback: ${err.stack}`, true);
        }
      });
      importFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          const text = await file.text();
          try {
            const token = localStorage.getItem('access_token');
            if (!token) throw new Error('No authentication token found');
            const response = await fetchWithFallback(`${SERVER_URL}/mcp/import`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ jsonrpc: '2.0', method: 'mcp.importMd', params: { user_id: 'test_user', md_content: text }, id: 4 }),
            });
            if (response.error) throw new Error(response.error.message);
            log(`Imported: ${JSON.stringify(response.result)}`);
          } catch (err) {
            log(`Import Error: ${err.message}\nTraceback: ${err.stack}`, true);
          }
        }
      });
      troubleshootBtn.addEventListener('click', () => handleCommand('/troubleshoot'));

      commandInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && commandInput.value.trim()) {
          handleCommand(commandInput.value.trim());
          commandInput.value = '';
        }
      });

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(() => {
          log('Service Worker registered');
        }).catch(err => {
          log(`Service Worker Error: ${err.message}\nTraceback: ${err.stack}`, true);
        });
      }

      log('Welcome to Vial MCP Gateway! Type /help for commands.');
    </script>
  </div>
</body>
</html>
