<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Vial MCP - Gateway</title>
  <style>
    body {
      background: #000000;
      margin: 0;
      font-family: 'Courier New', monospace;
      color: #00ff00;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    .container {
      text-align: center;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 90vw;
      height: 90vh;
      justify-content: space-between;
    }
    .logo {
      font-size: 2rem;
      font-weight: bold;
      text-align: center;
      text-shadow: 
        0 0 5px #ff3333,
        0 0 10px #00ff00,
        0 0 15px #00ff00;
      margin-bottom: 1rem;
      line-height: 1;
    }
    .header {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      text-shadow: 0 0 3px #00ff00;
    }
    .terminal {
      background: #000000;
      border: 2px solid #00ff00;
      box-shadow: 0 0 10px #00ff00;
      width: 100%;
      max-width: 300px;
      height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      margin: 0 auto 1rem;
      font-size: 0.9rem;
      color: #00ff00;
      text-align: left;
      flex-grow: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }
    .terminal span.error {
      color: #ff3333;
      text-shadow: 0 0 2px #ff3333;
    }
    .input {
      width: 80%;
      background: #000000;
      border: 1px solid #00ff00;
      color: #00ff00;
      padding: 0.3rem;
      margin: 0 auto 1rem;
      font-size: 0.9rem;
      display: block;
    }
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 0 auto 1rem;
      max-width: 250px;
    }
    .button {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #00ff00;
      color: #00ff00;
      padding: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      border-radius: 3px;
      transition: box-shadow 0.3s;
      touch-action: manipulation; /* Enable one-click for mobile */
    }
    .button:hover, .button:focus {
      box-shadow: 0 0 10px #ff3333;
    }
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .error {
      color: #ff3333;
      text-shadow: 0 0 2px #ff3333;
      margin: 0 auto 1rem;
      font-size: 0.8rem;
    }
    .footer {
      font-size: 0.7rem;
      color: #00ff00;
      text-align: center;
      width: 100%;
      margin-top: auto;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    @media (min-width: 768px) {
      .logo { font-size: 2.5rem; }
      .header { font-size: 1.5rem; }
      .terminal { max-width: 350px; height: 250px; }
      .button { font-size: 1rem; padding: 0.7rem; }
      .container { max-width: 400px; }
    }
  </style>
</head>
<body>
  <canvas id="galaxy"></canvas>
  <div class="container">
    <div class="logo">VIAL MCP GATEWAY</div>
    <div class="header">Vial MCP - Gateway</div>
    <div class="terminal" id="terminal">
      Welcome to Vial MCP Gateway!<br>
      Service Worker Error: ServiceWorker script at https://artifacts.grokusercontent.com/sw.js for scope https://artifacts.grokusercontent.com/ encountered an error during installation.<br>
    </div>
    <input type="text" class="input" id="commandInput" placeholder="Enter command (e.g., /auth, /troubleshoot)" />
    <div id="error" class="error"></div>
    <div class="buttons">
      <button class="button" id="oauthBtn">OAuth</button>
      <button class="button" id="troubleshootBtn">Troubleshoot</button>
    </div>
    <div class="footer">WebXOS 2025 Â© | Version: xAI Artifact Updated | Time: 04:30 AM EDT, August 15, 2025</div>

    <script>
      const terminal = document.getElementById('terminal');
      const commandInput = document.getElementById('commandInput');
      const errorDiv = document.getElementById('error');
      const oauthBtn = document.getElementById('oauthBtn');
      const troubleshootBtn = document.getElementById('troubleshootBtn');
      const SERVER_URL = 'http://localhost:8080';
      let lastTroubleshoot = 0;
      let isConnected = true;
      let connectionCheckInterval;

      const log = (message, isError = false) => {
        const colorClass = isError ? 'error' : '';
        terminal.innerHTML += `<span class="${colorClass}">${message}</span><br>`;
        terminal.scrollTop = terminal.scrollHeight;
      };

      const fetchWithFallback = async (url, options) => {
        try {
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (err) {
          if (navigator.onLine) {
            log(`Network Error: NetworkError when attempting to fetch resource.\nTraceback: ${err.message}`, true);
            return { error: { code: -32000, message: err.message, traceback: err.stack } };
          }
          log('Offline: Fallback to cached data or default response...', true);
          const cached = localStorage.getItem('lastResponse');
          return cached ? JSON.parse(cached) : { result: { status: 'Offline mode', message: 'No recent data available' } };
        }
      };

      const checkConnection = async () => {
        try {
          const response = await fetchWithFallback(`${SERVER_URL}/mcp/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jsonrpc: '2.0', method: 'mcp.ping', id: 1 }),
          });
          if (response.error) throw new Error(response.error.message);
          isConnected = true;
        } catch (err) {
          isConnected = false;
          if (localStorage.getItem('access_token')) {
            log('Server connection lost. Redirecting to landing page...', true);
            localStorage.removeItem('access_token');
            localStorage.removeItem('vials');
            localStorage.removeItem('lastResponse');
            window.location.href = '/';
          }
        }
      };

      const handleCommand = async (command) => {
        log(`> ${command}`);
        try {
          let response;
          const [cmd, ...args] = command.split(' ');
          switch (cmd.toLowerCase()) {
            case '/auth':
              // Handled by OAuth button
              break;
            case '/troubleshoot':
              const now = Date.now();
              if (now - lastTroubleshoot < 5000) {
                log('Please wait 5 seconds before next troubleshoot.', true);
                return;
              }
              lastTroubleshoot = now;
              response = await fetchWithFallback(`${SERVER_URL}/mcp/checklist`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
              if (response.error) {
                log(`Troubleshoot Error: ${response.error.message}\nSource: ${response.error.traceback || 'Unknown backend issue'}`);
                if (response.error.code === -32000) {
                  log('Possible Cause: Network connectivity issue or server down.');
                } else if (response.error.code === -32603) {
                  log('Possible Cause: Internal server error or misconfiguration.');
                } else {
                  log('Possible Cause: Unknown backend issue, check server logs.');
                }
              } else {
                log(`Checklist Result:\n${JSON.stringify(response.result, null, 2)}`);
              }
              break;
            case '/status':
              await fetchStatus();
              break;
            case '/help':
              log('Help Menu:\n- /auth: Authenticate via OAuth\n- /status: Check server status\n- /troubleshoot: Run system check\n- /clear: Clear terminal\n- /version: Display version');
              break;
            case '/clear':
              terminal.innerHTML = '';
              break;
            case '/version':
              log('Version: xAI Artifact Updated');
              break;
            default:
              throw new Error(`Unknown command: ${cmd}`);
          }
        } catch (err) {
          log(`Error: ${err.message}\nTraceback: ${err.stack}`, true);
          errorDiv.textContent = `Command Failed: ${err.message}`;
          errorDiv.style.textShadow = '0 0 5px #ff3333';
          setTimeout(() => errorDiv.style.textShadow = '0 0 2px #ff3333', 300);
        }
      };

      const fetchStatus = async () => {
        try {
          const response = await fetchWithFallback(`${SERVER_URL}/mcp/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ jsonrpc: '2.0', method: 'mcp.getSystemMetrics', id: 1 }),
          });
          if (response.error) throw new Error(response.error.message);
          log(`Status: CPU ${response.result.cpu_usage}%, Memory ${response.result.memory_usage}%, Users ${response.result.active_users}`);
        } catch (err) {
          log(`Status Error: ${err.message}\nTraceback: ${err.stack}`, true);
        }
      };

      oauthBtn.addEventListener('click', async () => {
        try {
          const response = await fetchWithFallback(`${SERVER_URL}/mcp/auth/oauth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ provider: 'mock', code: 'test_code' }),
          });
          if (response.error) {
            throw new Error(`OAuth Validation Failed: ${response.error.message} (Code: ${response.error.code})`);
          }
          if (!response.access_token || !response.vials) {
            throw new Error('OAuth response missing required fields');
          }
          localStorage.setItem('access_token', response.access_token);
          localStorage.setItem('vials', JSON.stringify(response.vials));
          localStorage.setItem('lastResponse', JSON.stringify(response));
          log('Authentication successful. Redirecting to dashboard...');
          window.location.href = '/app/dashboard';
        } catch (err) {
          log(`OAuth Error: ${err.message}\nTraceback: ${err.stack}`, true);
          errorDiv.textContent = `OAuth Failed: ${err.message}`;
          errorDiv.style.textShadow = '0 0 5px #ff3333';
          setTimeout(() => errorDiv.style.textShadow = '0 0 2px #ff3333', 300);
        }
      });

      troubleshootBtn.addEventListener('click', async () => {
        try {
          const now = Date.now();
          if (now - lastTroubleshoot < 5000) {
            log('Please wait 5 seconds before next troubleshoot.', true);
            return;
          }
          lastTroubleshoot = now;
          const response = await fetchWithFallback(`${SERVER_URL}/mcp/checklist`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          if (response.error) {
            log(`Troubleshoot Error: ${response.error.message}\nSource: ${response.error.traceback || 'Unknown backend issue'}`);
            if (response.error.code === -32000) {
              log('Possible Cause: Network connectivity issue or server down.');
            } else if (response.error.code === -32603) {
              log('Possible Cause: Internal server error or misconfiguration.');
            } else {
              log('Possible Cause: Unknown backend issue, check server logs.');
            }
          } else {
            log(`Checklist Result:\n${JSON.stringify(response.result, null, 2)}`);
          }
        } catch (err) {
          log(`Troubleshoot Error: ${err.message}\nTraceback: ${err.stack}`, true);
          errorDiv.textContent = `Troubleshoot Failed: ${err.message}`;
          errorDiv.style.textShadow = '0 0 5px #ff3333';
          setTimeout(() => errorDiv.style.textShadow = '0 0 2px #ff3333', 300);
        }
      });

      commandInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && commandInput.value.trim()) {
          handleCommand(commandInput.value.trim());
          commandInput.value = '';
        }
      });

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(() => {
          log('Service Worker registered');
        }).catch(err => {
          log(`Service Worker Error: ${err.message}\nTraceback: ${err.stack}`, true);
        });
      }

      // Simplified Neurots-like galaxy effect
      const canvas = document.getElementById('galaxy');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const stars = [];

      for (let i = 0; i < 30; i++) stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 2 + 1 });

      function drawGalaxy() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        stars.forEach(star => {
          ctx.beginPath();
          ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
          ctx.fillStyle = '#00ff00';
          ctx.shadowBlur = 5;
          ctx.shadowColor = '#00ff00';
          ctx.fill();
          star.y -= 0.2;
          if (star.y < 0) star.y = canvas.height;
        });
        requestAnimationFrame(drawGalaxy);
      }

      drawGalaxy();

      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });

      // Connection check
      connectionCheckInterval = setInterval(checkConnection, 5000);
    </script>
  </div>
</body>
</html>
