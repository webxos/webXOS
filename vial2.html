<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vial2 MCP Controller (BETA)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; }
        html, body { height: 100vh; overflow: hidden; background: #000; color: #0f0; display: flex; flex-direction: column; align-items: center; touch-action: manipulation; }
        body.glow { background: rgba(255, 0, 0, 0.1); box-shadow: 0 0 20px #ff0000; }
        body.train-glow { background: rgba(255, 255, 0, 0.1); box-shadow: 0 0 20px #ff0; }
        h1 { font-size: 1.6rem; text-align: center; margin: 0.8rem 0; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 5px #0f0; }
        #console { width: 90%; max-width: 900px; background: rgba(0, 255, 0, 0.1); border: 1px solid #0f0; padding: 0.6rem; flex: 1; max-height: calc(100vh - 380px); overflow-y: auto; margin: 0.5rem 0; border-radius: 5px; font-size: 0.8rem; }
        #console.active-monitor { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        #console.active-train { border-color: #ff0; box-shadow: 0 0 10px #ff0; }
        #console p { margin: 0.2rem 0; }
        #console .command { font-weight: 700; text-shadow: 0 0 3px #0f0; }
        #console .error { color: #ff0000; text-shadow: 0 0 3px #ff0000; }
        #console .balance { color: #00f; text-shadow: 0 0 3px #00f; position: sticky; bottom: 0; background: rgba(0, 0, 0, 0.8); padding: 0.2rem; }
        #error-notification { display: none; position: fixed; top: 10px; right: 10px; background: rgba(255, 0, 0, 0.8); color: #fff; padding: 0.5rem; border-radius: 3px; font-size: 0.8rem; max-width: 300px; box-shadow: 0 0 10px #ff0000; }
        #error-notification.visible { display: block; }
        #api-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 500px; background: #000; border: 2px solid #0f0; padding: 1rem; border-radius: 5px; box-shadow: 0 0 20px #0f0; color: #0f0; }
        #api-popup.visible { display: block; }
        #api-popup textarea { width: 100%; height: 100px; background: #000; border: 1px solid #0f0; color: #0f0; padding: 0.5rem; font-size: 0.9rem; border-radius: 3px; resize: none; }
        #api-popup button { background: #0f0; color: #000; border: none; padding: 0.5rem 1rem; font-size: 0.9rem; cursor: pointer; border-radius: 3px; margin-top: 0.5rem; }
        #api-popup button:hover { background: #0c0; }
        .button-group { display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap; justify-content: center; width: 90%; max-width: 900px; }
        button { background: #0f0; color: #000; border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; cursor: pointer; border-radius: 3px; min-width: 90px; }
        button:hover, button:focus { background: #0c0; outline: 2px solid #0f0; }
        button.active-monitor { background: #ff0000; box-shadow: 0 0 10px #ff0000; }
        button.active-train { background: #ff0; color: #000; box-shadow: 0 0 10px #ff0; }
        button:disabled { background: #666; cursor: not-allowed; }
        #prompt-input { width: 90%; max-width: 900px; background: #000; border: 1px solid #0f0; color: #0f0; padding: 0.6rem; font-size: 0.9rem; border-radius: 3px; margin: 0.5rem 0; }
        #vial-status-bars { width: 90%; max-width: 900px; margin: 0.5rem 0; display: flex; flex-direction: column; gap: 0.2rem; }
        .progress-container { display: flex; align-items: center; gap: 0.4rem; }
        .progress-label { width: 90px; font-size: 0.75rem; color: #0f0; }
        .progress-bar { flex: 1; height: 8px; background: #333; border: 1px solid #0f0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #0f0; transition: width 0.5s; }
        .progress-fill.offline-grey { background: #666; }
        .progress-fill.training { background: #ff0; }
        .progress-fill.offline { background: #f00; }
        .status-text { font-size: 0.75rem; width: 250px; text-align: right; }
        .status-text.online { color: #0f0; }
        .status-text.training { color: #ff0; }
        .status-text.offline-grey { color: #666; }
        .status-text.offline { color: #f00; }
        footer { width: 100%; padding: 0.4rem; font-size: 9pt; text-align: center; color: #0f0; background: rgba(0, 0, 0, 0.8); }
        #file-input { display: none; }
        @media (max-width: 600px) {
            h1 { font-size: 1.1rem; margin: 0.5rem 0; }
            #console { font-size: 0.75rem; padding: 0.5rem; max-height: calc(100vh - 380px); }
            button { padding: 0.5rem 1rem; font-size: 0.85rem; min-width: 80px; }
            #prompt-input { font-size: 0.85rem; padding: 0.5rem; }
            .progress-label { width: 70px; font-size: 0.7rem; }
            .progress-bar { height: 7px; }
            .status-text { font-size: 0.7rem; width: 200px; }
            #error-notification { font-size: 0.7rem; max-width: 250px; }
        }
        @media (max-width: 400px) {
            .button-group { flex-direction: column; align-items: center; }
            button { width: 100%; max-width: 160px; }
            #console { max-height: calc(100vh - 320px); }
            .status-text { width: 150px; }
        }
    </style>
</head>
<body>
    <h1>Vial2 MCP Controller (BETA)</h1>
    <div id="console">
        <p>Vial2 MCP Controller initialized. Use /help for commands.</p>
        <p class="balance">$WEBXOS Balance: 0.0000 | Reputation: 0</p>
    </div>
    <div id="error-notification"></div>
    <div id="api-popup">
        <h2>API Access Credentials</h2>
        <textarea id="api-input" readonly></textarea>
        <button id="api-generate">Generate New Credentials</button>
        <button id="api-close">Close</button>
    </div>
    <div class="button-group">
        <button id="authButton">Authenticate</button>
        <button id="voidButton" disabled>Void</button>
        <button id="troubleshootButton" disabled>Troubleshoot</button>
        <button id="quantumLinkButton" disabled>Quantum Sync</button>
        <button id="exportButton" disabled>Export</button>
        <button id="importButton" disabled>Import</button>
        <button id="apiAccessButton" disabled>API Access</button>
    </div>
    <textarea id="prompt-input" placeholder="Enter commands (e.g., /mcp status, /git status, /wallet sync vial2)..."></textarea>
    <div id="vial-status-bars"></div>
    <footer>WebXOS Vial2 MCP Controller | Testing Mode (BETA) | 2025 | v2.8 WARNING: $webxos token is in development under MIT license. @WEBXOS claims no fault for token loss. For more info: webxos.netlify.app & github.com/webxos/webxos</footer>
    <input type="file" id="file-input" accept=".md">
    <script>
        // Global state
        let logQueue = ['<p>Vial2 MCP Controller initialized. Use /help for commands.</p>', '<p class="balance">$WEBXOS Balance: 0.0000 | Reputation: 0</p>'];
        let isAuthenticated = false;
        let isOffline = true;
        let wallet = { address: null, balance: 0, hash: null };
        let reputation = 0;
        let apiCredentials = { key: null, secret: null };
        let vials = Array(4).fill().map((_, i) => ({
            id: `vial${i+1}`, status: 'stopped', code: '', codeLength: 0, isPython: true,
            webxosHash: crypto.randomUUID(), wallet: { address: null, balance: 0, hash: null },
            tasks: [], quantumState: null, trainingData: [], config: {}, isTraining: false, latency: 0
        }));

        // Utility functions
        function logEvent(type, message) {
            const timestamp = new Date().toISOString();
            logQueue.push(`<p class="${type === 'error' ? 'error' : 'command'}">[${timestamp}] ${message}</p>`);
            if (logQueue.length > 50) logQueue.shift();
            updateConsole();
        }

        function updateConsole() {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML = logQueue.join('');
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            document.getElementById('console').classList.toggle('active-monitor', type === 'monitor');
            document.getElementById('console').classList.toggle('active-train', type === 'train');
        }

        function showError(message) {
            const notification = document.getElementById('error-notification');
            notification.textContent = message;
            notification.classList.add('visible');
            setTimeout(() => notification.classList.remove('visible'), 5000);
        }

        function updateStatusBars() {
            const statusBars = document.getElementById('vial-status-bars');
            statusBars.innerHTML = vials.map(v => {
                const mode = v.isTraining ? 'Training' : (isOffline ? 'Offline' : 'Online');
                const statusClass = v.isTraining ? 'training' : (isOffline ? 'offline-grey' : 'online');
                const fillClass = v.status === 'stopped' ? 'offline-grey' : (v.isTraining ? 'training' : '');
                return `
                    <div class="progress-container">
                        <span class="progress-label">${v.id}</span>
                        <div class="progress-bar"><div class="progress-fill ${fillClass}" style="width: ${v.status === 'running' ? '100%' : '0%'}"></div></div>
                        <span class="status-text ${statusClass}">Latency: ${v.latency}ms | Size: ${v.codeLength} bytes | Mode: ${mode}</span>
                    </div>
                `;
            }).join('');
        }

        function disableButtons(disabled) {
            ['voidButton', 'troubleshootButton', 'quantumLinkButton', 'exportButton', 'importButton', 'apiAccessButton'].forEach(id => {
                document.getElementById(id).disabled = disabled;
            });
        }

        // Button handlers
        document.getElementById('authButton').addEventListener('click', () => {
            if (isAuthenticated) {
                voidVials();
                return;
            }
            isOffline = !confirm('Authenticate in online mode? Cancel for offline mode.');
            if (!isOffline) {
                logEvent('auth', 'Online authentication not implemented offline. Using mock data.');
                mockAuthentication();
            } else {
                isAuthenticated = true;
                logEvent('auth', 'Authenticated in offline mode.');
            }
            document.getElementById('authButton').textContent = 'Toggle Off';
            document.getElementById('authButton').classList.add('active-monitor');
            disableButtons(!isOffline);
            updateStatusBars();
        });

        document.getElementById('voidButton').addEventListener('click', () => {
            voidVials();
            logEvent('void', 'All data voided.');
        });

        document.getElementById('troubleshootButton').addEventListener('click', () => {
            if (isOffline) {
                logEvent('error', 'Troubleshoot requires online mode.');
                return;
            }
            logEvent('diagnostics', 'Troubleshoot: Mock error check - No errors found (offline).');
        });

        document.getElementById('quantumLinkButton').addEventListener('click', async () => {
            if (isOffline || !isAuthenticated) {
                showError('Quantum Sync requires authentication and online mode.');
                return;
            }
            document.body.classList.add('train-glow');
            document.getElementById('console').classList.add('active-train');
            try {
                const file = document.getElementById('file-input').files[0];
                const inputData = file ? await file.text() : '{}';
                mockQuantumSync(inputData);
                logEvent('quantum', 'Quantum sync completed (mock).');
                updateStatusBars();
            } catch (err) {
                showError(`Quantum Sync failed: ${err.message}`);
                logEvent('error', `Quantum Sync failed: ${err.message}`);
            } finally {
                document.body.classList.remove('train-glow');
                document.getElementById('console').classList.remove('active-train');
            }
        });

        document.getElementById('exportButton').addEventListener('click', () => {
            if (isOffline) {
                logEvent('error', 'Export requires online mode.');
                return;
            }
            const exportData = {
                network: { id: crypto.randomUUID(), start: new Date().toISOString(), duration: 0, reputation: reputation },
                wallet, apiCredentials, vials
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vial_export_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            logEvent('export', 'Export completed.');
        });

        document.getElementById('importButton').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    wallet = data.wallet || wallet;
                    apiCredentials = data.apiCredentials || apiCredentials;
                    vials = data.vials || vials;
                    reputation = data.network?.reputation || reputation;
                    logEvent('import', 'Import completed.');
                    updateStatusBars();
                } catch (err) {
                    showError(`Import failed: ${err.message}`);
                    logEvent('error', `Import failed: ${err.message}`);
                }
            }
        });

        document.getElementById('apiAccessButton').addEventListener('click', () => {
            if (isOffline) {
                logEvent('error', 'API Access requires online mode.');
                return;
            }
            const popup = document.getElementById('api-popup');
            popup.classList.add('visible');
            document.getElementById('api-input').value = `Key: ${apiCredentials.key}\nSecret: ${apiCredentials.secret}`;
        });

        document.getElementById('api-generate').addEventListener('click', () => {
            apiCredentials = { key: crypto.randomUUID(), secret: crypto.randomUUID() };
            document.getElementById('api-input').value = `Key: ${apiCredentials.key}\nSecret: ${apiCredentials.secret}`;
            logEvent('api', 'New API credentials generated.');
        });

        document.getElementById('api-close').addEventListener('click', () => {
            document.getElementById('api-popup').classList.remove('visible');
        });

        document.getElementById('prompt-input').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const command = e.target.value.trim();
                if (command) {
                    logEvent('command', `Executing: ${command}`);
                    e.target.value = '';
                    try {
                        if (isOffline) {
                            mockCommand(command);
                        } else {
                            showError('Online commands not implemented offline.');
                        }
                    } catch (err) {
                        showError(`Command failed: ${err.message}`);
                        logEvent('error', `Command failed: ${err.message}`);
                    }
                }
            }
        });

        // Mock functions for offline capability
        function mockAuthentication() {
            isAuthenticated = true;
            wallet = { address: crypto.randomUUID(), balance: 55373.0000, hash: crypto.randomUUID() };
            reputation = 153726462096;
            apiCredentials = { key: crypto.randomUUID(), secret: crypto.randomUUID() };
            vials.forEach(v => {
                v.wallet = { address: crypto.randomUUID(), balance: 13843.2500, hash: wallet.hash };
                v.status = 'running';
                v.codeLength = 699641;
            });
            updateConsole();
            updateStatusBars();
        }

        function mockQuantumSync(inputData) {
            vials.forEach(v => {
                v.isTraining = true;
                v.status = 'running';
                v.quantumState = { qubits: [], entanglement: 'synced' };
                v.trainingData = [{ tasks: [], parameters: {}, hash: crypto.randomUUID() }];
            });
        }

        function mockCommand(command) {
            const commands = {
                '/help': 'Available commands: /status, /train, /sync',
                '/status': `Vials: ${vials.map(v => `${v.id}: ${v.status}`).join(', ')}`,
                '/train': 'Training initiated (mock).',
                '/sync': 'Wallet synced (mock). Balance: ' + wallet.balance
            };
            logEvent('command', commands[command] || 'Unknown command. Use /help.');
        }

        function voidVials() {
            isAuthenticated = false;
            isOffline = true;
            wallet = { address: null, balance: 0, hash: null };
            reputation = 0;
            apiCredentials = { key: null, secret: null };
            vials.forEach(v => {
                v.status = 'stopped'; v.code = ''; v.codeLength = 0; v.wallet = { address: null, balance: 0, hash: null };
                v.tasks = []; v.quantumState = null; v.trainingData = []; v.config = {}; v.isTraining = false; v.latency = 0;
            });
            disableButtons(true);
            document.getElementById('authButton').textContent = 'Authenticate';
            document.getElementById('authButton').classList.remove('active-monitor');
            logQueue = ['<p>Vial2 MCP Controller initialized. Use /help for commands.</p>', '<p class="balance">$WEBXOS Balance: 0.0000 | Reputation: 0</p>'];
            updateConsole();
            updateStatusBars();
        }

        // Initial update
        updateStatusBars();
    </script>
</body>
</html>
