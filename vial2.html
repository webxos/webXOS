<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vial MCP Terminal</title>
    <link rel="stylesheet" href="/vial/mcp/frontend/static/css/vial-terminal.css">
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        #terminal { width: 90%; max-width: 900px; height: 60vh; background: rgba(0, 255, 0, 0.1); border: 1px solid #0f0; padding: 10px; overflow-y: auto; font-size: 14px; }
        #terminal .error { color: #ff0000; }
        #input { width: 90%; max-width: 900px; background: #000; border: 1px solid #0f0; color: #0f0; padding: 8px; font-size: 14px; }
        .button-group { display: flex; gap: 10px; margin: 10px 0; }
        button { background: #0f0; color: #000; border: none; padding: 8px 16px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0c0; }
        #status { width: 90%; max-width: 900px; margin: 10px 0; }
        .status-bar { display: flex; align-items: center; margin: 5px 0; }
        .status-bar div { flex: 1; height: 10px; background: #0f0; }
    </style>
</head>
<body>
    <h1>Vial MCP Testing Terminal</h1>
    <div id="terminal"></div>
    <input id="input" placeholder="Enter git commands (e.g., /prompt vial1 train dataset)">
    <div class="button-group">
        <button onclick="authenticate()">Authenticate</button>
        <button onclick="voidVials()">Void</button>
        <button onclick="troubleshoot()">Troubleshoot</button>
        <button onclick="quantumLink()">Quantum Link</button>
        <button onclick="exportVials()">Export</button>
        <button onclick="importVials()">Import</button>
        <button onclick="showApiCredentials()">API Credentials</button>
    </div>
    <div id="status"></div>
    <input type="file" id="file-input" style="display: none;" accept=".md">
    <script>
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('input');
        let logs = [];
        let isAuthenticated = false;
        let accessToken = null;
        let userId = null;
        let vials = ['vial1', 'vial2', 'vial3', 'vial4'].map(id => ({ id, status: 'stopped', tasks: [] }));

        function log(message, isError = false) {
            logs.push(`<div${isError ? ' class="error"' : ''}>${new Date().toISOString()} - ${message}</div>`);
            if (logs.length > 100) logs.shift();
            terminal.innerHTML = logs.join('');
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateStatus() {
            document.getElementById('status').innerHTML = vials.map(vial => 
                `<div class="status-bar">${vial.id}: ${vial.status} <div style="width: ${vial.status === 'running' ? '100%' : '0%'};"></div></div>`
            ).join('');
        }

        async function handleCommand(command) {
            if (!isAuthenticated && command !== '/help') {
                log('Error: Not authenticated. Please authenticate first.', true);
                return;
            }
            command = command.trim();
            if (command === '/help') {
                log(`Available commands:
- /prompt <vial> <text> - Send prompt to vial
- /task <vial> <task> - Assign task to vial
- /config <vial> <key> <value> - Set vial config
- /status - Show vial statuses`, false);
                return;
            }

            try {
                const [cmd, vialId, ...args] = command.split(' ');
                const response = await fetch('/vial/mcp/api/endpoints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                    body: JSON.stringify({ command: cmd.slice(1), vialId, args, userId })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                log(`Command ${command} executed: ${JSON.stringify(result)}`);
                if (cmd === '/status') {
                    vials = result.vials;
                    updateStatus();
                } else if (vialId) {
                    const vial = vials.find(v => v.id === vialId);
                    if (vial) vial.status = 'running';
                    updateStatus();
                }
            } catch (error) {
                log(`Command ${command} failed: ${error.message}`, true);
            }
        }

        async function authenticate() {
            try {
                const response = await fetch('/vial/mcp/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ method: 'oauth_login' })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                accessToken = result.access_token;
                userId = result.user_id;
                isAuthenticated = true;
                log('Authentication successful');
            } catch (error) {
                log(`Authentication failed: ${error.message}`, true);
            }
        }

        function voidVials() {
            vials.forEach(vial => vial.status = 'stopped');
            isAuthenticated = false;
            accessToken = null;
            userId = null;
            log('All vials voided');
            updateStatus();
        }

        async function troubleshoot() {
            try {
                const response = await fetch('/vial/mcp/api/health', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const result = await response.json();
                log(`Health check: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`Troubleshoot failed: ${error.message}`, true);
            }
        }

        async function quantumLink() {
            try {
                const response = await fetch('/vial/mcp/api/vials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                    body: JSON.stringify({ method: 'createVial', userId })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                log('Quantum link established');
                vials.forEach(vial => vial.status = 'running');
                updateStatus();
            } catch (error) {
                log(`Quantum link failed: ${error.message}`, true);
            }
        }

        async function exportVials() {
            try {
                const response = await fetch('/vial/mcp/api/wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                    body: JSON.stringify({ method: 'export', userId })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                const blob = new Blob([result.markdown], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vial_export_${new Date().toISOString().replace(/[:.]/g, '-')}.md`;
                a.click();
                URL.revokeObjectURL(url);
                log('Vials exported successfully');
            } catch (error) {
                log(`Export failed: ${error.message}`, true);
            }
        }

        async function importVials() {
            const fileInput = document.getElementById('file-input');
            if (!fileInput.files.length) {
                log('No file selected', true);
                return;
            }
            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const response = await fetch('/vial/mcp/api/wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                    body: JSON.stringify({ method: 'import', userId, markdown: text })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                vials = result.vials;
                log('Vials imported successfully');
                updateStatus();
            } catch (error) {
                log(`Import failed: ${error.message}`, true);
            }
        }

        async function showApiCredentials() {
            try {
                const response = await fetch('/vial/mcp/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },
                    body: JSON.stringify({ method: 'generateAPICredentials', userId })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                log(`API Credentials: Key=${result.key}, Secret=${result.secret}`);
            } catch (error) {
                log(`API Credentials failed: ${error.message}`, true);
            }
        }

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                handleCommand(input.value);
                input.value = '';
            }
        });

        document.getElementById('file-input').addEventListener('change', importVials);
        log('Vial MCP Terminal initialized. Use /help for commands.');
        updateStatus();
    </script>
</body>
</html>
