<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vial MCP Terminal</title>
    <link rel="stylesheet" href="/vial2/static/css/vial-terminal.css">
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; }
        #terminal { width: 90%; max-width: 900px; height: 60vh; background: rgba(0, 255, 0, 0.1); border: 1px solid #0f0; padding: 10px; overflow-y: auto; font-size: 14px; }
        #terminal .error { color: #ff0000; }
        #input { width: 90%; max-width: 900px; background: #000; border: 1px solid #0f0; color: #0f0; padding: 8px; font-size: 14px; }
        .button-group { display: flex; gap: 10px; margin: 10px 0; }
        button { background: #0f0; color: #000; border: none; padding: 8px 16px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0c0; }
        button.auth-active { background: #ff0000; }
        #status { width: 90%; max-width: 900px; margin: 10px 0; }
        .status-bar { display: flex; align-items: center; margin: 5px 0; }
        .status-bar div { flex: 1; height: 10px; background: #0f0; }
    </style>
</head>
<body>
    <h1>Vial MCP Terminal</h1>
    <div id="terminal"></div>
    <input id="input" placeholder="Enter commands (e.g., /prompt vial1 train dataset)">
    <div class="button-group">
        <button id="auth-btn" onclick="authenticate()">Authenticate with Neon</button>
        <button onclick="voidVials()">Void</button>
        <button onclick="troubleshoot()">Troubleshoot</button>
        <button onclick="quantumLink()">Quantum Link</button>
        <button onclick="exportVials()">Export</button>
        <button onclick="importVials()">Import</button>
        <button onclick="showApiCredentials()">API Credentials</button>
        <button onclick="dataApiQuery()">Data API Query</button>
    </div>
    <div id="status"></div>
    <input type="file" id="file-input" style="display: none;" accept=".md">
    <script>
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('input');
        const authBtn = document.getElementById('auth-btn');
        let logs = [];
        let isAuthenticated = false;
        let accessToken = null;
        let userId = null;
        let vials = ['vial1', 'vial2', 'vial3', 'vial4'].map(id => ({ id, status: 'stopped', tasks: [] }));
        const DATA_API_URL = 'https://app-billowing-king-08029676.dpl.myneon.app';
        const NEON_PROJECT_ID = 'twilight-art-21036984';

        function log(message, isError = false, file = '', line = '', id = '') {
            const timestamp = new Date().toISOString();
            const errorDetails = isError ? ` [${file}:${line}] [ID:${id}]` : '';
            logs.push(`<div${isError ? ' class="error"' : ''}>${timestamp} - ${message}${errorDetails}</div>`);
            if (logs.length > 100) logs.shift();
            terminal.innerHTML = logs.join('');
            terminal.scrollTop = terminal.scrollHeight;
        }

        function updateStatus() {
            document.getElementById('status').innerHTML = vials.map(vial => 
                `<div class="status-bar">${vial.id}: ${vial.status} <div style="width: ${vial.status === 'running' ? '100%' : '0%'};"></div></div>`
            ).join('');
        }

        function updateAuthButton() {
            authBtn.classList.toggle('auth-active', isAuthenticated);
            authBtn.textContent = isAuthenticated ? 'Authenticated' : 'Authenticate with Neon';
        }

        async function handleCommand(command) {
            if (!isAuthenticated && command !== '/help') {
                log('Error: Not authenticated. Please authenticate first.', true, 'vial2.html', '50', 'cmd_unauth');
                return;
            }
            command = command.trim();
            if (command === '/help') {
                log(`Available commands:
- /prompt <vial> <text> - Send prompt to vial
- /task <vial> <task> - Assign task to vial
- /config <vial> <key> <value> - Set vial config
- /status - Show vial statuses
- /git <command> - Run git commands
- /data <table> <action> - Query Data API`, false);
                return;
            }

            try {
                const [cmd, vialId, ...args] = command.split(' ');
                if (cmd === '/data') {
                    const [table, action] = args;
                    const result = await dataApiQuery(table, action);
                    log(`Data API ${table} ${action}: ${JSON.stringify(result)}`);
                    return;
                }
                const response = await fetch('/vial2/mcp/api/endpoints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`, 'Neon-Project-Id': NEON_PROJECT_ID },
                    body: JSON.stringify({ command: cmd.slice(1), vialId, args, userId, project_id: NEON_PROJECT_ID })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                log(`Command ${command} executed: ${JSON.stringify(result)}`);
                if (cmd === '/status') {
                    vials = result.vials;
                    updateStatus();
                } else if (vialId) {
                    const vial = vials.find(v => v.id === vialId);
                    if (vial) vial.status = 'running';
                    updateStatus();
                }
            } catch (error) {
                log(`Command ${command} failed: ${error.message}`, true, 'vial2.html', '70', 'cmd_error');
            }
        }

        async function authenticate() {
            try {
                const codeVerifier = btoa(String.fromCharCode(...new Uint8Array(32).map(() => Math.floor(Math.random() * 256))));
                const codeChallenge = await sha256(codeVerifier).then(hash => btoa(hash).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, ''));
                const authUrl = `https://api.stack-auth.com/api/v1/projects/142ad169-5d57-4be3-bf41-6f3cd0a9ae1d/authorize?client_id=your_stack_auth_client_id&redirect_uri=https://webxos.netlify.app/vial2/callback&response_type=code&scope=profile&code_challenge=${codeChallenge}&code_challenge_method=S256&project_id=${NEON_PROJECT_ID}`;
                const popup = window.open(authUrl, '_blank');
                window.addEventListener('message', async (event) => {
                    if (event.origin !== 'https://webxos.netlify.app') return;
                    const { code } = event.data;
                    popup.close();
                    const response = await fetch('/vial2/mcp/api/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Neon-Project-Id': NEON_PROJECT_ID },
                        body: JSON.stringify({ method: 'oauth_login', code, code_verifier: codeVerifier, project_id: NEON_PROJECT_ID })
                    });
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);
                    accessToken = result.access_token;
                    userId = result.user_id;
                    isAuthenticated = true;
                    updateAuthButton();
                    log('Authentication successful: User profile synced with Neon');
                }, { once: true });
            } catch (error) {
                log(`Authentication failed: ${error.message}`, true, 'vial2.html', '90', 'auth_error');
            }
        }

        async function dataApiQuery(table = 'users', action = 'select') {
            if (!isAuthenticated) {
                log('Data API query failed: Not authenticated', true, 'vial2.html', '100', 'data_unauth');
                return;
            }
            try {
                const response = await fetch(`${DATA_API_URL}/${table}${action === 'select' ? '?select=*' : ''}`, {
                    method: action === 'select' ? 'GET' : action.toUpperCase(),
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`, 'Neon-Project-Id': NEON_PROJECT_ID },
                    body: action !== 'select' ? JSON.stringify({ user_id: userId, project_id: NEON_PROJECT_ID }) : null
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                return result;
            } catch (error) {
                log(`Data API query failed: ${error.message}`, true, 'vial2.html', '110', 'data_error');
                return { error: error.message };
            }
        }

        async function voidVials() {
            vials.forEach(vial => vial.status = 'stopped');
            isAuthenticated = false;
            accessToken = null;
            userId = null;
            logs = [];
            terminal.innerHTML = '';
            updateAuthButton();
            updateStatus();
            window.location.reload();
            log('All vials voided and session cleared', false, 'vial2.html', '120', 'void_success');
        }

        async function troubleshoot() {
            try {
                const response = await fetch('/vial2/mcp/api/health', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Neon-Project-Id': NEON_PROJECT_ID }
                });
                const result = await response.json();
                log(`Health check: ${JSON.stringify(result)}`);
            } catch (error) {
                log(`Troubleshoot failed: ${error.message}`, true, 'vial2.html', '130', 'troubleshoot_error');
            }
        }

        async function quantumLink() {
            try {
                const response = await fetch('/vial2/mcp/api/vials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`, 'Neon-Project-Id': NEON_PROJECT_ID },
                    body: JSON.stringify({ method: 'createVial', userId, project_id: NEON_PROJECT_ID })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                log('Quantum link established: Agents synced');
                vials.forEach(vial => vial.status = 'running');
                updateStatus();
            } catch (error) {
                log(`Quantum link failed: ${error.message}`, true, 'vial2.html', '140', 'quantum_error');
            }
        }

        async function exportVials() {
            if (!isAuthenticated) {
                log('Export failed: Not authenticated', true, 'vial2.html', '150', 'export_unauth');
                return;
            }
            try {
                const response = await fetch('/vial2/mcp/api/wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`, 'Neon-Project-Id': NEON_PROJECT_ID },
                    body: JSON.stringify({ method: 'export', userId, project_id: NEON_PROJECT_ID })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                const blob = new Blob([result.markdown], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vial_export_${new Date().toISOString().replace(/[:.]/g, '-')}.md`;
                a.click();
                URL.revokeObjectURL(url);
                log('Vials exported successfully');
            } catch (error) {
                log(`Export failed: ${error.message}`, true, 'vial2.html', '160', 'export_error');
            }
        }

        async function importVials() {
            if (!isAuthenticated) {
                log('Import failed: Not authenticated', true, 'vial2.html', '170', 'import_unauth');
                return;
            }
            const fileInput = document.getElementById('file-input');
            if (!fileInput.files.length) {
                log('No file selected', true, 'vial2.html', '180', 'import_nofile');
                return;
            }
            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const response = await fetch('/vial2/mcp/api/wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`, 'Neon-Project-Id': NEON_PROJECT_ID },
                    body: JSON.stringify({ method: 'import', userId, markdown: text, project_id: NEON_PROJECT_ID })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                vials = result.vials;
                log('Vials imported successfully');
                updateStatus();
            } catch (error) {
                log(`Import failed: ${error.message}`, true, 'vial2.html', '190', 'import_error');
            }
        }

        async function showApiCredentials() {
            if (!isAuthenticated) {
                log('API Credentials failed: Not authenticated', true, 'vial2.html', '200', 'creds_unauth');
                return;
            }
            try {
                const response = await fetch('/vial2/mcp/api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}`, 'Neon-Project-Id': NEON_PROJECT_ID },
                    body: JSON.stringify({ method: 'generateAPICredentials', userId, project_id: NEON_PROJECT_ID })
                });
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                log(`API Credentials: Key=${result.key}, Secret=${result.secret}`);
            } catch (error) {
                log(`API Credentials failed: ${error.message}`, true, 'vial2.html', '210', 'creds_error');
            }
        }

        async function sha256(str) {
            const buffer = new TextEncoder().encode(str);
            const hash = await crypto.subtle.digest('SHA-256', buffer);
            return Array.from(new Uint8Array(hash)).map(b => String.fromCharCode(b)).join('');
        }

        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                handleCommand(input.value);
                input.value = '';
            }
        });

        document.getElementById('file-input').addEventListener('change', importVials);
        log('Vial MCP Terminal initialized. Use /help for commands.', false, 'vial2.html', '220', 'init');
        updateStatus();
    </script>
</body>
</html>
