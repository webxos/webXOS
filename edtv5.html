<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>edTV: DA3 MASK CREATOR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #threeCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .control-panel {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 12px;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 95%;
            max-width: 400px;
            border: 1px solid rgba(0, 255, 100, 0.3);
        }
        
        .title {
            text-align: center;
            font-size: 1rem;
            margin-bottom: 3px;
            color: #00ff64;
            text-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        
        .btn {
            background: rgba(0, 255, 100, 0.2);
            border: 1px solid #00ff64;
            color: #fff;
            padding: 8px 12px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
            flex: 1;
            min-width: 100px;
            text-align: center;
        }
        
        .btn:hover {
            background: rgba(0, 255, 100, 0.4);
            box-shadow: 0 0 15px rgba(0, 255, 100, 0.5);
        }
        
        .btn.active {
            background: rgba(0, 255, 100, 0.7);
            box-shadow: 0 0 15px rgba(0, 255, 100, 0.8);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 3px;
        }
        
        .slider-container span {
            font-size: 0.75rem;
            color: #ccc;
            min-width: 80px;
        }
        
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00ff64;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 100, 0.8);
        }
        
        .status {
            text-align: center;
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 3px;
        }
        
        .instructions {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 12px;
            z-index: 3;
            max-width: 250px;
            border: 1px solid rgba(0, 255, 100, 0.3);
            font-size: 0.8rem;
            line-height: 1.3;
        }
        
        .instructions h3 {
            color: #00ff64;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .instructions p {
            margin-bottom: 6px;
        }
        
        .instructions ul {
            padding-left: 15px;
        }
        
        .instructions li {
            margin-bottom: 4px;
            font-size: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .instructions {
                display: none;
            }
            
            .control-panel {
                width: 98%;
                padding: 10px;
            }
            
            .btn {
                padding: 7px 10px;
                font-size: 0.75rem;
                min-width: 90px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="threeCanvas"></canvas>
        
        <div class="instructions">
            <h3>edTV: DA3 MASK CREATOR</h3>
            <p>Real-time 720Ã—720 face point cloud using your webcam.</p>
            <ul>
                <li>Allow camera access when prompted</li>
                <li>Click and drag to rotate view</li>
                <li>Scroll to zoom in/out</li>
                <li>Use controls to adjust visualization</li>
            </ul>
        </div>
        
        <div class="control-panel">
            <div class="title">edTV DA3 Face Point Cloud</div>
            
            <div class="controls">
                <button id="startBtn" class="btn">START</button>
                <button id="stopBtn" class="btn" disabled>STOP</button>
            </div>
            
            <div class="slider-container">
                <span>Point Size:</span>
                <input type="range" id="pointSize" min="0.1" max="2" step="0.1" value="0.5">
            </div>
            
            <div class="slider-container">
                <span>Depth Intensity:</span>
                <input type="range" id="depthIntensity" min="1" max="20" step="1" value="8">
            </div>
            
            <div class="status" id="status">Ready - Click START to begin</div>
        </div>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // Main application
        document.addEventListener('DOMContentLoaded', function() {
            // Scene setup
            let scene, camera, renderer, pointCloud, pointMaterial;
            let video, canvas2D, ctx2D;
            let isWebcamActive = false;
            let stream = null;
            
            // Mouse controls
            let isMouseDown = false;
            let mouseX = 0, mouseY = 0;
            let targetRotationX = 0, targetRotationY = 0;
            let targetZoom = 15;
            
            // Initialize Three.js
            function initThreeJS() {
                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x050505);
                
                // Camera
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 0, 15);
                
                // Renderer
                renderer = new THREE.WebGLRenderer({
                    canvas: document.getElementById('threeCanvas'),
                    antialias: true,
                    alpha: true
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);
                
                // Create initial point cloud (will be updated with webcam data)
                createPointCloud();
                
                // Handle window resize
                window.addEventListener('resize', onWindowResize);
                
                // Mouse controls
                setupMouseControls();
                
                // Start animation loop
                animate();
            }
            
            // Set up mouse controls for camera rotation and zoom
            function setupMouseControls() {
                const canvas = document.getElementById('threeCanvas');
                
                // Mouse down event
                canvas.addEventListener('mousedown', function(event) {
                    isMouseDown = true;
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                });
                
                // Mouse move event
                canvas.addEventListener('mousemove', function(event) {
                    if (!isMouseDown) return;
                    
                    const deltaX = event.clientX - mouseX;
                    const deltaY = event.clientY - mouseY;
                    
                    targetRotationY += deltaX * 0.01;
                    targetRotationX += deltaY * 0.01;
                    
                    mouseX = event.clientX;
                    mouseY = event.clientY;
                });
                
                // Mouse up event
                canvas.addEventListener('mouseup', function() {
                    isMouseDown = false;
                });
                
                // Mouse wheel for zoom
                canvas.addEventListener('wheel', function(event) {
                    event.preventDefault();
                    targetZoom += event.deltaY * 0.01;
                    targetZoom = Math.max(5, Math.min(30, targetZoom));
                });
            }
            
            // Create point cloud geometry
            function createPointCloud() {
                // Create a simple geometry with a grid of points
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(720 * 720 * 3);
                const colors = new Float32Array(720 * 720 * 3);
                
                let index = 0;
                for (let i = 0; i < 720; i++) {
                    for (let j = 0; j < 720; j++) {
                        positions[index] = (i - 360) * 0.01;
                        positions[index + 1] = (j - 360) * 0.01;
                        positions[index + 2] = 0;
                        
                        // Set initial color to gray
                        colors[index] = 0.5;
                        colors[index + 1] = 0.5;
                        colors[index + 2] = 0.5;
                        
                        index += 3;
                    }
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                // Material
                pointMaterial = new THREE.PointsMaterial({
                    size: parseFloat(document.getElementById('pointSize').value),
                    vertexColors: true,
                    sizeAttenuation: true
                });
                
                // Points
                pointCloud = new THREE.Points(geometry, pointMaterial);
                scene.add(pointCloud);
            }
            
            // Update point cloud with webcam data
            function updatePointCloud() {
                if (!isWebcamActive || !video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
                
                // Get video dimensions
                const srcW = video.videoWidth;
                const srcH = video.videoHeight;
                
                // Calculate crop area to get center 720x720
                const sx = Math.max(0, (srcW - 720) / 2);
                const sy = Math.max(0, (srcH - 720) / 2);
                const cropSize = Math.min(720, srcW, srcH);
                
                // Draw cropped video to 2D canvas for processing
                ctx2D.clearRect(0, 0, canvas2D.width, canvas2D.height);
                ctx2D.drawImage(video, sx, sy, cropSize, cropSize, 0, 0, canvas2D.width, canvas2D.height);
                
                const imageData = ctx2D.getImageData(0, 0, canvas2D.width, canvas2D.height);
                const data = imageData.data;
                
                // Get point cloud geometry
                const positions = pointCloud.geometry.attributes.position.array;
                const colors = pointCloud.geometry.attributes.color.array;
                
                const depthIntensity = parseFloat(document.getElementById('depthIntensity').value);
                const width = canvas2D.width;
                const height = canvas2D.height;
                
                // Update point positions based on video data (simplified depth from brightness)
                let pointIndex = 0;
                for (let i = 0; i < height; i += 1) {
                    for (let j = 0; j < width; j += 1) {
                        const pixelIndex = (i * width + j) * 4;
                        const r = data[pixelIndex] / 255;
                        const g = data[pixelIndex + 1] / 255;
                        const b = data[pixelIndex + 2] / 255;
                        
                        // Calculate brightness and use it as depth
                        const brightness = (r + g + b) / 3;
                        
                        // Map to 3D space (centered, scaled)
                        const x = (j / width - 0.5) * 10;
                        const y = (0.5 - i / height) * 10;
                        const z = (brightness - 0.5) * depthIntensity;
                        
                        // Update position
                        positions[pointIndex * 3] = x;
                        positions[pointIndex * 3 + 1] = y;
                        positions[pointIndex * 3 + 2] = z;
                        
                        // Use actual video colors
                        colors[pointIndex * 3] = r;
                        colors[pointIndex * 3 + 1] = g;
                        colors[pointIndex * 3 + 2] = b;
                        
                        pointIndex++;
                        
                        // Safety check - don't exceed point cloud size
                        if (pointIndex * 3 >= positions.length) break;
                    }
                    // Safety check - don't exceed point cloud size
                    if (pointIndex * 3 >= positions.length) break;
                }
                
                // Mark attributes as needing update
                pointCloud.geometry.attributes.position.needsUpdate = true;
                pointCloud.geometry.attributes.color.needsUpdate = true;
            }
            
            // Start webcam
            async function startWebcam() {
                try {
                    updateStatus('Accessing camera...');
                    
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        }, 
                        audio: false 
                    });
                    
                    video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    
                    // Create 2D canvas for processing video frames
                    canvas2D = document.createElement('canvas');
                    canvas2D.width = 720;
                    canvas2D.height = 720;
                    ctx2D = canvas2D.getContext('2d');
                    
                    // Wait for video to be ready
                    video.addEventListener('loadeddata', function() {
                        isWebcamActive = true;
                        updateStatus('Webcam active - Drag to rotate, scroll to zoom');
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                    });
                    
                } catch (error) {
                    console.error('Error accessing webcam:', error);
                    updateStatus('Error: Could not access webcam. Please check permissions.');
                }
            }
            
            // Stop webcam
            function stopWebcam() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                isWebcamActive = false;
                video = null;
                canvas2D = null;
                ctx2D = null;
                
                updateStatus('Webcam stopped - Click START to begin');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                
                if (isWebcamActive) {
                    updatePointCloud();
                }
                
                // Smooth camera rotation
                camera.rotation.x += (targetRotationX - camera.rotation.x) * 0.05;
                camera.rotation.y += (targetRotationY - camera.rotation.y) * 0.05;
                
                // Smooth camera zoom
                camera.position.z += (targetZoom - camera.position.z) * 0.1;
                
                renderer.render(scene, camera);
            }
            
            // Handle window resize
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            // Update status message
            function updateStatus(message) {
                document.getElementById('status').textContent = message;
            }
            
            // Initialize event listeners
            function initEventListeners() {
                // Webcam buttons
                document.getElementById('startBtn').addEventListener('click', startWebcam);
                document.getElementById('stopBtn').addEventListener('click', stopWebcam);
                
                // Sliders
                document.getElementById('pointSize').addEventListener('input', function() {
                    pointMaterial.size = parseFloat(this.value);
                });
            }
            
            // Initialize the application
            function init() {
                initThreeJS();
                initEventListeners();
            }
            
            // Start the app
            init();
        });
    </script>
</body>
</html>