<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>edTV: DA3 MASK CREATOR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #0a0a0a;
            color: #fff;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        
        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #threeCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #videoContainer {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25vw;
            max-width: 200px;
            z-index: 2;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 100, 0.3);
            border: 2px solid #00ff64;
        }
        
        #webcamVideo {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1); /* Mirror the video */
        }
        
        .control-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            z-index: 3;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(0, 255, 100, 0.3);
        }
        
        .title {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: #00ff64;
            text-shadow: 0 0 10px rgba(0, 255, 100, 0.5);
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .btn {
            background: rgba(0, 255, 100, 0.2);
            border: 1px solid #00ff64;
            color: #fff;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .btn:hover {
            background: rgba(0, 255, 100, 0.4);
            box-shadow: 0 0 15px rgba(0, 255, 100, 0.5);
        }
        
        .btn.active {
            background: rgba(0, 255, 100, 0.7);
            box-shadow: 0 0 15px rgba(0, 255, 100, 0.8);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .slider-container span {
            font-size: 0.8rem;
            color: #ccc;
            min-width: 100px;
        }
        
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ff64;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 100, 0.8);
        }
        
        .status {
            text-align: center;
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            z-index: 3;
            max-width: 300px;
            border: 1px solid rgba(0, 255, 100, 0.3);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .instructions h3 {
            color: #00ff64;
            margin-bottom: 8px;
        }
        
        .instructions p {
            margin-bottom: 8px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .instructions {
                display: none;
            }
            
            #videoContainer {
                width: 30vw;
            }
            
            .control-panel {
                width: 95%;
                padding: 10px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                min-width: 100px;
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 100, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 100, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 100, 0); }
        }
        
        .color-options {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 5px;
        }
        
        .color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option.active {
            border-color: white;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="threeCanvas"></canvas>
        
        <div id="videoContainer" class="pulse">
            <video id="webcamVideo" autoplay playsinline></video>
        </div>
        
        <div class="instructions">
            <h3>edTV: DA3 MASK CREATOR</h3>
            <p>Real-time 3D face visualization using your webcam.</p>
            <ul>
                <li>Allow camera access when prompted</li>
                <li>Move your head to see the 3D effect</li>
                <li>Use controls to adjust the visualization</li>
                <li>Toggle between different visualization modes</li>
            </ul>
        </div>
        
        <div class="control-panel">
            <div class="title">edTV DA3 Face Mask Controls</div>
            
            <div class="controls">
                <button id="startBtn" class="btn active">Start Webcam</button>
                <button id="maskBtn" class="btn">Face Mask</button>
                <button id="pointsBtn" class="btn">Point Cloud</button>
                <button id="wireframeBtn" class="btn">Wireframe</button>
            </div>
            
            <div class="slider-container">
                <span>Point Size:</span>
                <input type="range" id="pointSize" min="0.1" max="2" step="0.1" value="0.5">
            </div>
            
            <div class="slider-container">
                <span>Depth Intensity:</span>
                <input type="range" id="depthIntensity" min="1" max="20" step="1" value="8">
            </div>
            
            <div class="color-options">
                <div class="color-option active" style="background-color: #00ff64;" data-color="#00ff64"></div>
                <div class="color-option" style="background-color: #ff3366;" data-color="#ff3366"></div>
                <div class="color-option" style="background-color: #3366ff;" data-color="#3366ff"></div>
                <div class="color-option" style="background-color: #ffcc00;" data-color="#ffcc00"></div>
                <div class="color-option" style="background-color: #cc66ff;" data-color="#cc66ff"></div>
            </div>
            
            <div class="status" id="status">Initializing...</div>
        </div>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        // Main application
        document.addEventListener('DOMContentLoaded', function() {
            // Scene setup
            let scene, camera, renderer, pointCloud, pointMaterial;
            let video, videoTexture, canvas2D, ctx2D;
            let isWebcamActive = false;
            let currentMode = 'points'; // 'points', 'mask', 'wireframe'
            let pointColor = new THREE.Color(0x00ff64);
            
            // Initialize Three.js
            function initThreeJS() {
                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x050505);
                
                // Camera
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 0, 15);
                
                // Renderer
                renderer = new THREE.WebGLRenderer({
                    canvas: document.getElementById('threeCanvas'),
                    antialias: true,
                    alpha: true
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);
                
                // Grid helper
                const gridHelper = new THREE.GridHelper(20, 20, 0x00ff64, 0x00ff64);
                gridHelper.material.opacity = 0.1;
                gridHelper.material.transparent = true;
                scene.add(gridHelper);
                
                // Axes helper
                const axesHelper = new THREE.AxesHelper(5);
                scene.add(axesHelper);
                
                // Create initial point cloud (will be updated with webcam data)
                createPointCloud();
                
                // Handle window resize
                window.addEventListener('resize', onWindowResize);
                
                // Start animation loop
                animate();
                
                updateStatus('Ready - Click "Start Webcam" to begin');
            }
            
            // Create point cloud geometry
            function createPointCloud() {
                // Create a simple geometry with a grid of points
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(100 * 100 * 3);
                const colors = new Float32Array(100 * 100 * 3);
                
                let index = 0;
                for (let i = 0; i < 100; i++) {
                    for (let j = 0; j < 100; j++) {
                        positions[index] = (i - 50) * 0.1;
                        positions[index + 1] = (j - 50) * 0.1;
                        positions[index + 2] = 0;
                        
                        // Set initial color
                        colors[index] = pointColor.r;
                        colors[index + 1] = pointColor.g;
                        colors[index + 2] = pointColor.b;
                        
                        index += 3;
                    }
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                // Material
                pointMaterial = new THREE.PointsMaterial({
                    size: parseFloat(document.getElementById('pointSize').value),
                    vertexColors: true,
                    sizeAttenuation: true
                });
                
                // Points
                pointCloud = new THREE.Points(geometry, pointMaterial);
                scene.add(pointCloud);
            }
            
            // Update point cloud with webcam data
            function updatePointCloud() {
                if (!isWebcamActive || !video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
                
                // Draw video to 2D canvas for processing
                ctx2D.drawImage(video, 0, 0, canvas2D.width, canvas2D.height);
                const imageData = ctx2D.getImageData(0, 0, canvas2D.width, canvas2D.height);
                const data = imageData.data;
                
                // Get point cloud geometry
                const positions = pointCloud.geometry.attributes.position.array;
                const colors = pointCloud.geometry.attributes.color.array;
                
                const depthIntensity = parseFloat(document.getElementById('depthIntensity').value);
                const width = canvas2D.width;
                const height = canvas2D.height;
                
                // Update point positions based on video data (simplified depth from brightness)
                let pointIndex = 0;
                for (let i = 0; i < height; i += 10) {
                    for (let j = 0; j < width; j += 10) {
                        const pixelIndex = (i * width + j) * 4;
                        const r = data[pixelIndex] / 255;
                        const g = data[pixelIndex + 1] / 255;
                        const b = data[pixelIndex + 2] / 255;
                        
                        // Calculate brightness and use it as depth
                        const brightness = (r + g + b) / 3;
                        
                        // Map to 3D space (centered, scaled)
                        const x = (j / width - 0.5) * 10;
                        const y = (0.5 - i / height) * 10;
                        const z = (brightness - 0.5) * depthIntensity;
                        
                        // Update position
                        positions[pointIndex * 3] = x;
                        positions[pointIndex * 3 + 1] = y;
                        positions[pointIndex * 3 + 2] = z;
                        
                        // Update color based on mode
                        if (currentMode === 'points') {
                            colors[pointIndex * 3] = pointColor.r;
                            colors[pointIndex * 3 + 1] = pointColor.g;
                            colors[pointIndex * 3 + 2] = pointColor.b;
                        } else if (currentMode === 'mask') {
                            // Use video colors for mask mode
                            colors[pointIndex * 3] = r;
                            colors[pointIndex * 3 + 1] = g;
                            colors[pointIndex * 3 + 2] = b;
                        } else if (currentMode === 'wireframe') {
                            // Monochrome for wireframe
                            const intensity = (r + g + b) / 3;
                            colors[pointIndex * 3] = intensity * pointColor.r;
                            colors[pointIndex * 3 + 1] = intensity * pointColor.g;
                            colors[pointIndex * 3 + 2] = intensity * pointColor.b;
                        }
                        
                        pointIndex++;
                        
                        // Safety check - don't exceed point cloud size
                        if (pointIndex * 3 >= positions.length) break;
                    }
                    // Safety check - don't exceed point cloud size
                    if (pointIndex * 3 >= positions.length) break;
                }
                
                // Mark attributes as needing update
                pointCloud.geometry.attributes.position.needsUpdate = true;
                pointCloud.geometry.attributes.color.needsUpdate = true;
            }
            
            // Start webcam
            async function startWebcam() {
                try {
                    updateStatus('Accessing camera...');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }, 
                        audio: false 
                    });
                    
                    video = document.getElementById('webcamVideo');
                    video.srcObject = stream;
                    
                    // Create 2D canvas for processing video frames
                    canvas2D = document.createElement('canvas');
                    canvas2D.width = 100;
                    canvas2D.height = 100;
                    ctx2D = canvas2D.getContext('2d');
                    
                    // Wait for video to be ready
                    video.addEventListener('loadeddata', function() {
                        isWebcamActive = true;
                        updateStatus('Webcam active - Move your head to see 3D effect');
                        document.getElementById('startBtn').classList.remove('active');
                        document.getElementById('videoContainer').classList.remove('pulse');
                    });
                    
                } catch (error) {
                    console.error('Error accessing webcam:', error);
                    updateStatus('Error: Could not access webcam. Please check permissions.');
                }
            }
            
            // Change visualization mode
            function setMode(mode) {
                currentMode = mode;
                
                // Update UI
                document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(mode + 'Btn').classList.add('active');
                
                // Update point material based on mode
                if (mode === 'wireframe') {
                    pointMaterial.size = 0.1;
                } else {
                    pointMaterial.size = parseFloat(document.getElementById('pointSize').value);
                }
                
                updateStatus(`Mode: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
            }
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                
                if (isWebcamActive) {
                    updatePointCloud();
                    
                    // Auto-rotate slowly
                    pointCloud.rotation.y += 0.002;
                }
                
                renderer.render(scene, camera);
            }
            
            // Handle window resize
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            // Update status message
            function updateStatus(message) {
                document.getElementById('status').textContent = message;
            }
            
            // Set point color
            function setPointColor(color) {
                pointColor = new THREE.Color(color);
                
                // Update all color options UI
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            // Initialize event listeners
            function initEventListeners() {
                // Webcam button
                document.getElementById('startBtn').addEventListener('click', startWebcam);
                
                // Mode buttons
                document.getElementById('maskBtn').addEventListener('click', () => setMode('mask'));
                document.getElementById('pointsBtn').addEventListener('click', () => setMode('points'));
                document.getElementById('wireframeBtn').addEventListener('click', () => setMode('wireframe'));
                
                // Sliders
                document.getElementById('pointSize').addEventListener('input', function() {
                    pointMaterial.size = parseFloat(this.value);
                });
                
                // Color options
                document.querySelectorAll('.color-option').forEach(option => {
                    option.addEventListener('click', function() {
                        setPointColor(this.dataset.color);
                    });
                });
            }
            
            // Initialize the application
            function init() {
                initThreeJS();
                initEventListeners();
            }
            
            // Start the app
            init();
        });
    </script>
</body>
</html>
