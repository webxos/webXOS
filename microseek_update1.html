<!DOCTYPE html>
<html>
<head>
    <title>MicroSeek OS by webXOS 2025</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@latest/lib/browser/math.js"></script>
    <style>
        /* Base Variables */
        :root {
            --bg-dark: #0a0a0a;
            --bg-darker: #000000;
            --bg-light: #111111;
            --bg-lighter: #1a1a1a;
            --text: #00ff00;
            --text-dim: #00aa00;
            --text-bright: #00ff88;
            --accent: #00ff00;
            --accent-glow: rgba(0, 255, 0, 0.1);
            --border: #003300;
            --border-light: #005500;
            --hover: rgba(0, 255, 0, 0.05);
            --selected: rgba(0, 255, 0, 0.1);
        }
        
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--bg-darker);
            color: var(--text);
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.3;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        /* Loading Screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-darker);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .loading-hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-text {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 0 0 8px var(--accent-glow);
        }
        
        .loading-subtext {
            color: var(--text-dim);
            margin-bottom: 30px;
            font-size: 0.8rem;
            text-align: center;
            padding: 0 20px;
        }
        
        #loading-bar {
            width: 80%;
            max-width: 300px;
            height: 1px;
            background: var(--border);
            overflow: hidden;
        }
        
        #loading-progress {
            width: 0%;
            height: 100%;
            background: var(--accent);
            transition: width 0.2s ease;
        }
        
        /* Main App */
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .app-visible {
            opacity: 1 !important;
        }
        
        .header {
            padding: 8px 12px;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            user-select: none;
        }
        
        .os-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .header-info {
            color: var(--text-dim);
            font-size: 0.7rem;
            text-align: right;
        }
        
        /* Terminal */
        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        
        .terminal-output {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }
        
        .terminal-content {
            flex: 1;
            min-height: min-content;
            display: flex;
            flex-direction: column;
        }
        
        .terminal-line {
            margin-bottom: 6px;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .prompt-line {
            margin-bottom: 8px;
        }
        
        .prompt {
            color: var(--accent);
            font-weight: bold;
        }
        
        .command {
            color: var(--text-bright);
        }
        
        .dim {
            color: var(--text-dim);
        }
        
        .highlight {
            color: var(--accent);
            font-weight: bold;
        }
        
        .error {
            color: #ff3333;
        }
        
        .success {
            color: var(--accent);
        }
        
        /* Typewriter Effect */
        .typewriter-line {
            border-right: 2px solid var(--accent);
            animation: blink-caret 0.75s step-end infinite;
            display: inline-block;
            overflow: hidden;
            white-space: nowrap;
            letter-spacing: normal;
        }
        
        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: var(--accent); }
        }
        
        .reading-indicator {
            color: var(--text-dim);
            font-style: italic;
            font-size: 0.8rem;
            margin: 5px 0;
        }
        
        .typewriter-speed-control {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .speed-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 2px;
            background: var(--border);
            outline: none;
        }
        
        .speed-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
        }
        
        .speed-label {
            color: var(--text-dim);
            font-size: 0.8rem;
            min-width: 60px;
        }
        
        /* Links */
        .link {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
            border-bottom: 1px dotted var(--accent);
            padding-bottom: 1px;
        }
        
        .link:hover, .link:active {
            border-bottom: 1px solid var(--accent);
        }
        
        .file-link {
            color: var(--accent);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }
        
        /* Suggestions */
        .suggestions {
            margin-top: 12px;
            padding-left: 12px;
            border-left: 1px solid var(--border);
        }
        
        .suggestion {
            margin: 4px 0;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.1s;
            font-size: 0.85rem;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .suggestion:hover, .suggestion:active {
            color: var(--text);
            background: var(--hover);
        }
        
        /* Input Bar */
        .input-container {
            padding: 8px;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            min-height: 32px;
        }
        
        .input-prompt {
            color: var(--accent);
            margin-right: 8px;
            font-weight: bold;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        #terminal-input {
            flex: 1;
            background: transparent;
            color: var(--text);
            border: none;
            outline: none;
            padding: 6px 0;
            font-family: inherit;
            font-size: 0.9rem;
            min-width: 0;
        }
        
        #terminal-input::placeholder {
            color: var(--text-dim);
            opacity: 0.7;
        }
        
        .input-button {
            background: var(--bg-darker);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 5px 10px;
            cursor: pointer;
            outline: none;
            font-family: inherit;
            font-size: 0.8rem;
            white-space: nowrap;
            min-width: 60px;
            text-align: center;
            appearance: none;
            border-radius: 2px;
        }
        
        .input-button:hover, .input-button:active {
            border-color: var(--accent);
            background: var(--hover);
        }
        
        /* File Upload Hidden */
        #file-upload {
            display: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Rename Prompt Modal */
        #rename-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2500;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            padding: 10px;
        }
        
        .rename-visible {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        #rename-container {
            width: 100%;
            max-width: 400px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 15px;
        }
        
        .rename-title {
            color: var(--accent);
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        #rename-message {
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--text);
        }
        
        #rename-input {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 10px;
            margin-bottom: 10px;
            outline: none;
            font-family: inherit;
        }
        
        .rename-buttons {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        
        /* Editor Popup */
        #editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            padding: 10px;
        }
        
        .editor-visible {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        #editor-container {
            width: 100%;
            max-width: 600px;
            height: 80%;
            max-height: 500px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .editor-header {
            padding: 8px 12px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 0.85rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .editor-buttons {
            display: flex;
            gap: 5px;
        }
        
        .editor-buttons button {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 3px 8px;
            cursor: pointer;
            outline: none;
            font-size: 0.75rem;
        }
        
        .editor-buttons .delete-btn {
            background: rgba(255, 51, 51, 0.1);
            border-color: #ff3333;
            color: #ff6666;
        }
        
        .editor-buttons .delete-btn:hover {
            background: rgba(255, 51, 51, 0.2);
        }
        
        #editor-textarea {
            flex: 1;
            background: var(--bg-darker);
            color: var(--text);
            border: none;
            outline: none;
            padding: 12px;
            resize: none;
            line-height: 1.3;
            font-family: inherit;
            font-size: 0.9rem;
        }
        
        /* Calculator Popup */
        #calc-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            padding: 10px;
        }
        
        .calc-visible {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        #calc-container {
            width: 100%;
            max-width: 400px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .calc-header {
            padding: 8px 12px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calc-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .calc-display {
            padding: 12px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border);
            min-height: 40px;
            font-size: 1rem;
            word-break: break-all;
        }
        
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--border);
        }
        
        .calc-button {
            background: var(--bg-dark);
            border: none;
            color: var(--text);
            padding: 12px;
            cursor: pointer;
            outline: none;
            font-family: inherit;
            font-size: 0.9rem;
            transition: background 0.1s;
        }
        
        .calc-button:hover, .calc-button:active {
            background: var(--bg-darker);
        }
        
        .calc-button.operator {
            color: var(--accent);
            background: rgba(0, 255, 0, 0.05);
        }
        
        .calc-button.equals {
            background: rgba(0, 255, 0, 0.1);
            color: var(--accent);
        }
        
        /* File Browser Popup (Windows-style) */
        #browser-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            padding: 10px;
        }
        
        .browser-visible {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        #browser-container {
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .browser-header {
            padding: 8px 12px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .browser-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .browser-toolbar {
            padding: 6px 12px;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
        }
        
        .browser-toolbar-item {
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 2px;
        }
        
        .browser-toolbar-item:hover {
            background: var(--hover);
        }
        
        .browser-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .browser-sidebar {
            width: 200px;
            background: var(--bg-darker);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .browser-tree-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .browser-tree-item:hover {
            background: var(--hover);
        }
        
        .browser-tree-item.selected {
            background: var(--selected);
            color: var(--text-bright);
        }
        
        .tree-icon {
            margin-right: 8px;
            color: var(--accent);
            font-size: 0.9rem;
        }
        
        .browser-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .browser-path {
            padding: 6px 12px;
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        
        .browser-files {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .browser-file-item {
            background: var(--bg-darker);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.1s;
            user-select: none;
            position: relative;
        }
        
        .browser-file-item:hover {
            border-color: var(--accent);
            background: var(--hover);
        }
        
        .browser-file-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .file-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--accent);
        }
        
        .file-name {
            font-size: 0.8rem;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .file-size {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 3px;
        }
        
        .file-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid #ff3333;
            color: #ff6666;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .browser-file-item:hover .file-delete-btn {
            opacity: 1;
        }
        
        .file-delete-btn:hover {
            background: rgba(255, 51, 51, 0.2);
        }
        
        .browser-footer {
            padding: 8px 12px;
            background: var(--bg-darker);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        
        /* Import Branch Selector */
        #import-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            padding: 20px;
        }
        
        .import-visible {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        #import-container {
            width: 100%;
            max-width: 300px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 15px;
        }
        
        .import-title {
            color: var(--accent);
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .import-select {
            width: 100%;
            background: var(--bg-darker);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px;
            margin-bottom: 10px;
            outline: none;
            font-family: inherit;
        }
        
        .import-buttons {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
        }
        
        /* Warning Modal */
        #warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 4000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            padding: 20px;
        }
        
        .warning-visible {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        #warning-container {
            width: 100%;
            max-width: 400px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 20px;
            text-align: center;
        }
        
        .warning-title {
            color: #ff3333;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .warning-message {
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text);
        }
        
        .warning-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .warning-btn {
            padding: 6px 20px;
            min-width: 80px;
        }
        
        .warning-btn.delete {
            background: rgba(255, 51, 51, 0.1);
            border-color: #ff3333;
            color: #ff6666;
        }
        
        .warning-btn.delete:hover {
            background: rgba(255, 51, 51, 0.2);
        }
        
        /* Help Menu */
        .help-menu {
            margin: 10px 0;
            padding-left: 10px;
        }
        
        .help-item {
            margin: 5px 0;
            font-size: 0.85rem;
        }
        
        .help-cmd {
            color: var(--accent);
            font-weight: bold;
            margin-right: 8px;
        }
        
        .help-desc {
            color: var(--text-dim);
        }
        
        /* File Tree in Terminal */
        .file-tree {
            margin: 8px 0;
        }
        
        .branch-item {
            margin: 8px 0;
        }
        
        .branch-name {
            color: var(--accent);
            font-weight: bold;
            cursor: pointer;
            padding: 4px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        
        .branch-name:hover {
            color: var(--text-bright);
        }
        
        .file-list {
            padding-left: 15px;
            margin: 3px 0;
        }
        
        .terminal-file-item {
            margin: 3px 0;
            padding: 2px 4px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            justify-content: space-between;
        }
        
        .terminal-file-item:hover {
            background: rgba(0, 255, 0, 0.05);
        }
        
        .terminal-file-badge {
            background: rgba(0, 255, 0, 0.1);
            color: var(--accent);
            padding: 1px 6px;
            border-radius: 2px;
            font-size: 0.7rem;
            margin-right: 8px;
        }
        
        .terminal-delete-btn {
            background: rgba(255, 51, 51, 0.1);
            border: 1px solid #ff3333;
            color: #ff6666;
            padding: 1px 6px;
            border-radius: 2px;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
        }
        
        .terminal-rename-btn {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 1px 6px;
            border-radius: 2px;
            font-size: 0.7rem;
            cursor: pointer;
            display: none;
            margin-right: 5px;
        }
        
        .terminal-file-item:hover .terminal-delete-btn,
        .terminal-file-item:hover .terminal-rename-btn {
            display: block;
        }
        
        .terminal-delete-btn:hover {
            background: rgba(255, 51, 51, 0.2);
        }
        
        .terminal-rename-btn:hover {
            background: rgba(0, 255, 0, 0.2);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 12px;
            }
            
            .header {
                padding: 6px 10px;
            }
            
            .os-title {
                font-size: 0.8rem;
            }
            
            .header-info {
                font-size: 0.65rem;
            }
            
            .terminal-output {
                padding: 10px;
            }
            
            .input-container {
                padding: 6px;
            }
            
            .input-button {
                padding: 4px 8px;
                font-size: 0.75rem;
                min-width: 55px;
            }
            
            #editor-container, #calc-container, #browser-container {
                height: 70%;
                max-height: 400px;
            }
            
            .calc-button {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .browser-sidebar {
                width: 150px;
            }
            
            .browser-files {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .input-button {
                min-width: 50px;
                font-size: 0.7rem;
                padding: 3px 6px;
            }
            
            #terminal-input {
                font-size: 0.85rem;
            }
            
            .calc-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .calc-button {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .browser-sidebar {
                width: 120px;
            }
            
            .browser-files {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loading-text">MicroSeek OS</div>
        <div class="loading-subtext" id="loading-status">BOOTING KERNEL</div>
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="app" class="hidden">
        <div class="header">
            <div class="os-title">MicroSeek OS</div>
            <div class="header-info">
                <span id="file-count">0 FILES</span> | <span id="branch-status">/tree</span>
            </div>
        </div>
        
        <div class="terminal-container">
            <div id="terminal-output" class="terminal-output">
                <div id="terminal-content" class="terminal-content"></div>
            </div>
            
            <div class="input-container">
                <div class="input-wrapper">
                    <div class="input-prompt" id="terminal-prompt">/tree></div>
                    <input 
                        id="terminal-input" 
                        type="text" 
                        placeholder="TYPE COMMAND OR CLICK HELP"
                        autocomplete="off"
                        spellcheck="false"
                        autocapitalize="none"
                        enterkeyhint="send"
                    >
                </div>
                <button id="import-button" class="input-button">IMPORT</button>
                <button id="send-button" class="input-button">SEND</button>
                <input type="file" id="file-upload" accept=".md,text/markdown" style="display: none;">
            </div>
        </div>
    </div>
    
    <!-- Rename Prompt Modal -->
    <div id="rename-overlay" class="hidden">
        <div id="rename-container">
            <div class="rename-title">RENAME FILE</div>
            <div id="rename-message">Enter new name for:</div>
            <input 
                id="rename-input" 
                type="text" 
                placeholder="NEW_FILE_NAME.MD"
                spellcheck="false"
                autocapitalize="none"
            >
            <div class="rename-buttons">
                <button id="rename-cancel" class="input-button">CANCEL</button>
                <button id="rename-confirm" class="input-button">RENAME</button>
            </div>
        </div>
    </div>
    
    <!-- Editor Popup -->
    <div id="editor-overlay" class="hidden">
        <div id="editor-container">
            <div class="editor-header">
                <div class="editor-title" id="editor-filename">EDITING: UNTITLED.MD</div>
                <div class="editor-buttons">
                    <button id="editor-save">SAVE</button>
                    <button id="editor-delete" class="delete-btn">DELETE</button>
                    <button id="editor-cancel">CLOSE</button>
                </div>
            </div>
            <textarea id="editor-textarea" spellcheck="false"></textarea>
        </div>
    </div>
    
    <!-- File Browser Popup -->
    <div id="browser-overlay" class="hidden">
        <div id="browser-container">
            <div class="browser-header">
                <div class="browser-title">FILE BROWSER</div>
                <div class="editor-buttons">
                    <button id="browser-close">CLOSE</button>
                </div>
            </div>
            <div class="browser-toolbar">
                <div class="browser-toolbar-item" onclick="browserCreateFile()">New File</div>
                <div class="browser-toolbar-item" onclick="browserCreateBranch()">New Branch</div>
                <div class="browser-toolbar-item" onclick="openImportFromBrowser()">Import</div>
            </div>
            <div class="browser-content">
                <div class="browser-sidebar" id="browser-sidebar">
                    <div class="browser-tree-item selected" data-branch="all">
                        <span class="tree-icon">üìÅ</span> All Files
                    </div>
                </div>
                <div class="browser-main">
                    <div class="browser-path" id="browser-path">/tree</div>
                    <div class="browser-files" id="browser-files"></div>
                </div>
            </div>
            <div class="browser-footer">
                <span id="browser-stats">0 files</span>
                <span>Drag files between branches</span>
            </div>
        </div>
    </div>
    
    <!-- Calculator Popup -->
    <div id="calc-overlay" class="hidden">
        <div id="calc-container">
            <div class="calc-header">
                <div class="calc-title">CALCULATOR</div>
                <div class="editor-buttons">
                    <button id="calc-close">CLOSE</button>
                </div>
            </div>
            <div class="calc-display" id="calc-display">0</div>
            <div class="calc-buttons">
                <button class="calc-button" data-op="C">C</button>
                <button class="calc-button" data-op="CE">CE</button>
                <button class="calc-button" data-op="back">‚Üê</button>
                <button class="calc-button operator" data-op="/">/</button>
                <button class="calc-button" data-op="7">7</button>
                <button class="calc-button" data-op="8">8</button>
                <button class="calc-button" data-op="9">9</button>
                <button class="calc-button operator" data-op="*">√ó</button>
                <button class="calc-button" data-op="4">4</button>
                <button class="calc-button" data-op="5">5</button>
                <button class="calc-button" data-op="6">6</button>
                <button class="calc-button operator" data-op="-">-</button>
                <button class="calc-button" data-op="1">1</button>
                <button class="calc-button" data-op="2">2</button>
                <button class="calc-button" data-op="3">3</button>
                <button class="calc-button operator" data-op="+">+</button>
                <button class="calc-button" data-op="0">0</button>
                <button class="calc-button" data-op=".">.</button>
                <button class="calc-button operator" data-op="(">(</button>
                <button class="calc-button operator" data-op=")">)</button>
                <button class="calc-button equals" data-op="=">=</button>
            </div>
        </div>
    </div>
    
    <!-- Import Branch Selector -->
    <div id="import-overlay" class="hidden">
        <div id="import-container">
            <div class="import-title">SELECT BRANCH TO IMPORT TO:</div>
            <select id="branch-select" class="import-select">
                <option value="main">main</option>
            </select>
            <div class="import-buttons">
                <button id="import-confirm" class="input-button">IMPORT</button>
                <button id="import-cancel" class="input-button">CANCEL</button>
            </div>
        </div>
    </div>
    
    <!-- Warning Modal -->
    <div id="warning-overlay" class="hidden">
        <div id="warning-container">
            <div class="warning-title">DELETE FILE</div>
            <div class="warning-message" id="warning-message">Are you sure you want to delete this file? This action cannot be undone.</div>
            <div class="warning-buttons">
                <button id="warning-cancel" class="input-button warning-btn">CANCEL</button>
                <button id="warning-confirm" class="input-button warning-btn delete">DELETE</button>
            </div>
        </div>
    </div>

    <script>
        // System State
        let systemState = {
            initialized: false,
            fileSystem: [],
            branches: ['main'],
            currentBranch: 'main',
            currentFile: null,
            commandHistory: [],
            historyIndex: -1,
            recentFiles: [],
            embeddings: {},
            gpu: null,
            ragModel: null,
            pendingImport: null,
            calcExpression: '',
            calcResult: '0',
            fileToDelete: null,
            selectedBrowserBranch: 'all',
            dragSource: null,
            currentTreeView: null,
            // Typewriter reading state
            isReading: false,
            readInterval: null,
            readSpeed: 200, // 200 characters per second = 5ms per character
            readPosition: 0,
            readContent: '',
            readFileData: null,
            // Rename state
            renameFileData: null,
            renameTargetBranch: null
        };
        
        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const appEl = document.getElementById('app');
        const progressEl = document.getElementById('loading-progress');
        const loadingStatusEl = document.getElementById('loading-status');
        const terminalOutputEl = document.getElementById('terminal-output');
        const terminalContentEl = document.getElementById('terminal-content');
        const terminalInputEl = document.getElementById('terminal-input');
        const terminalPromptEl = document.getElementById('terminal-prompt');
        const fileCountEl = document.getElementById('file-count');
        const branchStatusEl = document.getElementById('branch-status');
        const sendButton = document.getElementById('send-button');
        const importButton = document.getElementById('import-button');
        const fileUpload = document.getElementById('file-upload');
        
        // Rename Modal Elements
        const renameOverlay = document.getElementById('rename-overlay');
        const renameMessage = document.getElementById('rename-message');
        const renameInput = document.getElementById('rename-input');
        const renameCancelBtn = document.getElementById('rename-cancel');
        const renameConfirmBtn = document.getElementById('rename-confirm');
        
        // Popup Elements
        const editorOverlay = document.getElementById('editor-overlay');
        const editorTextarea = document.getElementById('editor-textarea');
        const editorFilename = document.getElementById('editor-filename');
        const editorSaveBtn = document.getElementById('editor-save');
        const editorDeleteBtn = document.getElementById('editor-delete');
        const editorCancelBtn = document.getElementById('editor-cancel');
        
        const browserOverlay = document.getElementById('browser-overlay');
        const browserSidebar = document.getElementById('browser-sidebar');
        const browserFiles = document.getElementById('browser-files');
        const browserPath = document.getElementById('browser-path');
        const browserStats = document.getElementById('browser-stats');
        const browserCloseBtn = document.getElementById('browser-close');
        
        const calcOverlay = document.getElementById('calc-overlay');
        const calcDisplay = document.getElementById('calc-display');
        const calcCloseBtn = document.getElementById('calc-close');
        const calcButtons = document.querySelectorAll('.calc-button');
        
        const importOverlay = document.getElementById('import-overlay');
        const branchSelect = document.getElementById('branch-select');
        const importConfirmBtn = document.getElementById('import-confirm');
        const importCancelBtn = document.getElementById('import-cancel');
        
        const warningOverlay = document.getElementById('warning-overlay');
        const warningMessage = document.getElementById('warning-message');
        const warningCancelBtn = document.getElementById('warning-cancel');
        const warningConfirmBtn = document.getElementById('warning-confirm');
        
        // IndexedDB
        let db;
        const DB_NAME = 'microseek_os';
        const DB_VERSION = 1;
        const STORE_NAME = 'files';
        
        // File name sanitization function - ENFORCE .md EXTENSION
        function sanitizeFilename(filename) {
            if (!filename) return filename;
            // Replace all spaces with underscores
            let sanitized = filename.replace(/\s+/g, '_');
            // Replace multiple underscores with single underscore
            sanitized = sanitized.replace(/_{2,}/g, '_');
            // Remove any other problematic characters
            sanitized = sanitized.replace(/[<>:"/\\|?*]/g, '');
            // ENSURE it ends with .md - FORCE markdown files
            if (!sanitized.toLowerCase().endsWith('.md')) {
                sanitized += '.md';
            }
            return sanitized;
        }
        
        // Function to find file with automatic sanitization
        function findFileWithSanitization(filename, branch = null) {
            if (!filename) return null;
            
            // First try exact match
            let file = null;
            if (branch) {
                file = systemState.fileSystem.find(f => 
                    f.branch === branch && f.name === filename
                );
            } else {
                file = systemState.fileSystem.find(f => f.name === filename);
            }
            
            if (file) return file;
            
            // Try sanitized version
            const sanitized = sanitizeFilename(filename);
            if (branch) {
                file = systemState.fileSystem.find(f => 
                    f.branch === branch && f.name === sanitized
                );
            } else {
                file = systemState.fileSystem.find(f => f.name === sanitized);
            }
            
            return file;
        }
        
        // Loading Simulation
        let loadingSteps = [
            'BOOTING KERNEL',
            'LOADING WEBLLM',
            'SETTING UP RAG INDEX',
            'MOUNTING GPU.JS',
            'LOADING FILE SYSTEM',
            'READY'
        ];
        
        let currentStep = 0;
        
        // Scroll to bottom function
        function scrollToBottom() {
            setTimeout(() => {
                terminalOutputEl.scrollTop = terminalOutputEl.scrollHeight;
            }, 10);
        }
        
        // Initialize loading
        async function simulateLoading() {
            for (let i = 0; i < loadingSteps.length; i++) {
                loadingStatusEl.textContent = loadingSteps[i];
                progressEl.style.width = ((i + 1) * (100 / loadingSteps.length)) + '%';
                
                if (loadingSteps[i] === 'LOADING WEBLLM') {
                    await initWebLLM();
                } else if (loadingSteps[i] === 'SETTING UP RAG INDEX') {
                    await initRAG();
                } else if (loadingSteps[i] === 'MOUNTING GPU.JS') {
                    await initGPU();
                } else if (loadingSteps[i] === 'LOADING FILE SYSTEM') {
                    await initDatabase();
                    await loadFileSystem();
                }
                
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            finishBoot();
        }
        
        async function initWebLLM() {
            systemState.llm = {
                process: async (query) => {
                    const patterns = {
                        'help': 'HELP - SHOW COMMANDS\nTREE - SHOW FILES\nBROWSER - FILE MANAGER\nWRITE - CREATE FILE\nREAD - VIEW FILE WITH TYPEWRITER\nEDIT - EDIT FILE\nRENAME - RENAME FILE\nCALC - CALCULATOR\nIMPORT - UPLOAD MARKDOWN FILE\nEXPORT - EXPORT MARKDOWN FILES\nBRANCH - SWITCH BRANCH\nCLEAR - CLEAR TERMINAL',
                        'hello': 'SYSTEM READY.',
                        'hi': 'HELLO.',
                        'clear': 'TERMINAL CLEARED.',
                        'files': `${systemState.fileSystem.length} FILES IN ${systemState.branches.length} BRANCHES`
                    };
                    
                    const lowerQuery = query.toLowerCase();
                    for (const [pattern, response] of Object.entries(patterns)) {
                        if (lowerQuery.includes(pattern)) {
                            return response;
                        }
                    }
                    
                    return `PROCESSED: "${query}"`;
                }
            };
        }
        
        async function initRAG() {
            try {
                await tf.setBackend('webgl');
                systemState.ragModel = {
                    embed: async (text) => {
                        const embedding = new Array(16).fill(0);
                        for (let i = 0; i < Math.min(text.length, 16); i++) {
                            embedding[i] = text.charCodeAt(i) / 255;
                        }
                        return embedding;
                    },
                    similarity: (a, b) => {
                        let dot = 0, normA = 0, normB = 0;
                        for (let i = 0; i < a.length; i++) {
                            dot += a[i] * b[i];
                            normA += a[i] * a[i];
                            normB += b[i] * b[i];
                        }
                        return normA && normB ? dot / (Math.sqrt(normA) * Math.sqrt(normB)) : 0;
                    }
                };
            } catch (error) {
                console.warn('RAG init failed:', error);
            }
        }
        
        async function initGPU() {
            try {
                systemState.gpu = new GPU();
            } catch (error) {
                console.warn('GPU.js init failed:', error);
            }
        }
        
        async function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = reject;
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('name', 'name', { unique: false });
                        store.createIndex('branch', 'branch', { unique: false });
                        
                        // Welcome file - MARKDOWN ONLY
                        store.add({
                            name: 'README.md',
                            branch: 'main',
                            content: '# MICROSEEK OS\n\nMINIMAL TEXT OPERATING SYSTEM\n\n## APPS\n- WRITE: MARKDOWN EDITOR\n- CALC: CALCULATOR\n- BROWSER: FILE MANAGER\n\n## COMMANDS\n- HELP: SHOW THIS MENU\n- TREE: SHOW FILES\n- BROWSER: FILE MANAGER\n- BRANCH: SWITCH BRANCH\n- READ: VIEW FILE WITH TYPEWRITER\n- EDIT: EDIT FILE\n- RENAME: RENAME FILE\n- IMPORT: UPLOAD MARKDOWN FILE (.MD ONLY)\n- EXPORT: EXPORT MARKDOWN FILES\n- CLEAR: CLEAR TERMINAL\n\n## IMPORTANT\n- SYSTEM ONLY ACCEPTS MARKDOWN (.md) FILES\n- ALL FILES ARE SAVED WITH .md EXTENSION',
                            lastModified: new Date(),
                            size: 256,
                            accessed: 0
                        });
                    }
                };
            });
        }
        
        async function loadFileSystem() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = async (event) => {
                    systemState.fileSystem = event.target.result || [];
                    
                    // Sanitize existing filenames on load - ENFORCE .md
                    let needsUpdate = false;
                    const updatePromises = [];
                    
                    systemState.fileSystem.forEach(file => {
                        const sanitized = sanitizeFilename(file.name);
                        if (sanitized !== file.name) {
                            needsUpdate = true;
                            const oldName = file.name;
                            file.name = sanitized;
                            
                            // Update in database
                            const updateTransaction = db.transaction([STORE_NAME], 'readwrite');
                            const updateStore = updateTransaction.objectStore(STORE_NAME);
                            updatePromises.push(
                                new Promise((resolveUpdate, rejectUpdate) => {
                                    const updateRequest = updateStore.put(file);
                                    updateRequest.onsuccess = () => resolveUpdate();
                                    updateRequest.onerror = rejectUpdate;
                                })
                            );
                            
                            console.log(`Sanitized filename: ${oldName} ‚Üí ${sanitized}`);
                        }
                    });
                    
                    if (needsUpdate) {
                        await Promise.all(updatePromises);
                        addTerminalOutput('<span class="dim">SYSTEM: Filenames sanitized (spaces‚Üíunderscores, enforced .md)</span>', 'dim');
                    }
                    
                    // Extract branches
                    const branchSet = new Set(['main']);
                    systemState.fileSystem.forEach(file => {
                        if (file.branch) branchSet.add(file.branch);
                    });
                    systemState.branches = Array.from(branchSet);
                    
                    updateStatus();
                    resolve();
                };
                
                request.onerror = reject;
            });
        }
        
        function updateStatus() {
            fileCountEl.textContent = `${systemState.fileSystem.length} FILES`;
            branchStatusEl.textContent = `/tree/${systemState.currentBranch}`;
            terminalPromptEl.textContent = `/tree/${systemState.currentBranch}>`;
        }
        
        function finishBoot() {
            setTimeout(() => {
                loadingEl.classList.add('loading-hidden');
                setTimeout(() => {
                    loadingEl.classList.add('hidden');
                    appEl.classList.remove('hidden');
                    setTimeout(() => {
                        appEl.classList.add('app-visible');
                        terminalInputEl.focus();
                        
                        // Welcome
                        addTerminalOutput('<span class="highlight">MICROSEEK OS</span>', 'output');
                        addTerminalOutput('MINIMAL TEXT OS | TYPEWRITER READ | FILE BROWSER', 'dim');
                        addTerminalOutput('<span class="dim">SYSTEM: MARKDOWN-ONLY (.md) | All files saved as .md</span>', 'dim');
                        addTerminalOutput('');
                        addTerminalOutput(`LOADED ${systemState.fileSystem.length} MARKDOWN FILES`, 'success');
                        addTerminalOutput('CLICK <span class="link" onclick="showHelp()">HELP</span> TO BEGIN', 'dim');
                        addTerminalOutput('');
                        
                        showSuggestions();
                    }, 50);
                }, 200);
            }, 200);
        }
        
        function addTerminalOutput(text, type = 'output') {
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            
            // Process text to add links
            let processedText = text;
            if (type === 'output' || type === 'dim') {
                // Convert /tree/ links
                processedText = processedText.replace(/\/tree\/([a-zA-Z0-9_-]+)/g, (match, branch) => {
                    return `<span class="link" onclick="switchBranch('${branch}')">${match}</span>`;
                });
                
                // Convert /tree/branch/file.md links
                processedText = processedText.replace(/\/tree\/([a-zA-Z0-9_-]+)\/([a-zA-Z0-9_\-\.]+\.md)/g, (match, branch, file) => {
                    return `<span class="link" onclick="readFileFromBranch('${file}', '${branch}')">${match}</span>`;
                });
                
                // Convert .md file mentions
                processedText = processedText.replace(/([a-zA-Z0-9_\-]+\.md)/g, (match, file) => {
                    return `<span class="file-link" onclick="readFileWithTypewriter('${match}')">${match}</span>`;
                });
            }
            
            if (type === 'prompt') {
                line.innerHTML = `<span class="prompt">/tree/${systemState.currentBranch}></span> <span class="command">${text}</span>`;
            } else if (type === 'highlight') {
                line.innerHTML = `<span class="highlight">${text}</span>`;
            } else if (type === 'error') {
                line.innerHTML = `<span class="error">${text}</span>`;
            } else if (type === 'success') {
                line.innerHTML = `<span class="success">${text}</span>`;
            } else if (type === 'dim') {
                line.innerHTML = `<span class="dim">${processedText}</span>`;
            } else {
                line.innerHTML = processedText;
            }
            
            terminalContentEl.appendChild(line);
            scrollToBottom();
        }
        
        function showSuggestions() {
            const container = document.createElement('div');
            container.className = 'suggestions';
            
            const suggestions = [
                {text: 'HELP - SHOW COMMANDS', action: () => showHelp()},
                {text: 'BROWSER - FILE MANAGER', action: () => openFileBrowser()},
                {text: 'TREE - SHOW FILES', action: () => executeCommand('tree')},
                {text: 'WRITE - CREATE MARKDOWN FILE', action: () => executeCommand('write')},
                {text: 'CALC - CALCULATOR', action: () => openCalculator()},
                {text: 'EXPORT ALL - EXPORT SYSTEM', action: () => executeCommand('export all')},
                {text: 'IMPORT - UPLOAD MARKDOWN (.md)', action: () => fileUpload.click()}
            ];
            
            suggestions.forEach(s => {
                const div = document.createElement('div');
                div.className = 'suggestion';
                div.textContent = s.text;
                div.addEventListener('click', s.action);
                container.appendChild(div);
            });
            
            terminalContentEl.appendChild(container);
            scrollToBottom();
        }
        
        function showHelp() {
            addTerminalOutput('<span class="highlight">MICROSEEK OS COMMANDS:</span>', 'output');
            addTerminalOutput('<span class="dim">MARKDOWN-ONLY SYSTEM: All files are .md format</span>', 'dim');
            
            const helpMenu = document.createElement('div');
            helpMenu.className = 'help-menu';
            
            const commands = [
                {cmd: 'HELP', desc: 'SHOW THIS MENU'},
                {cmd: 'BROWSER', desc: 'FILE MANAGER (DRAG & DROP)'},
                {cmd: 'TREE', desc: 'SHOW FILE STRUCTURE'},
                {cmd: 'BRANCH [NAME]', desc: 'SWITCH BRANCH'},
                {cmd: 'WRITE [FILE]', desc: 'CREATE/EDIT MARKDOWN FILE'},
                {cmd: 'READ FILE.MD', desc: 'VIEW FILE (TYPEWRITER MODE)'},
                {cmd: 'READ STOP', desc: 'STOP TYPEWRITER READING'},
                {cmd: 'EDIT FILE.MD', desc: 'EDIT MARKDOWN FILE'},
                {cmd: 'RENAME FILE.MD', desc: 'RENAME FILE (SEAMLESS)'},
                {cmd: 'DELETE FILE', desc: 'DELETE FILE'},
                {cmd: 'CALC', desc: 'OPEN CALCULATOR'},
                {cmd: 'IMPORT', desc: 'UPLOAD MARKDOWN FILE (.MD ONLY)'},
                {cmd: 'EXPORT ALL', desc: 'EXPORT ENTIRE SYSTEM AS MARKDOWN'},
                {cmd: 'EXPORT FILE.MD', desc: 'EXPORT SINGLE MARKDOWN FILE'},
                {cmd: 'CLEAR', desc: 'CLEAR TERMINAL'}
            ];
            
            commands.forEach(c => {
                const item = document.createElement('div');
                item.className = 'help-item';
                item.innerHTML = `<span class="help-cmd">${c.cmd}</span><span class="help-desc">${c.desc}</span>`;
                helpMenu.appendChild(item);
            });
            
            terminalContentEl.appendChild(helpMenu);
            
            // Quick links
            const linkDiv = document.createElement('div');
            linkDiv.className = 'suggestions';
            linkDiv.innerHTML = `
                <div class="suggestion" onclick="openFileBrowser()">QUICK: FILE BROWSER</div>
                <div class="suggestion" onclick="executeCommand('tree')">QUICK: SHOW FILES</div>
                <div class="suggestion" onclick="executeCommand('export all')">QUICK: EXPORT SYSTEM</div>
            `;
            terminalContentEl.appendChild(linkDiv);
            
            scrollToBottom();
        }
        
        function executeCommand(input) {
            if (!input.trim()) return;
            
            // Add to history
            systemState.commandHistory.push(input);
            systemState.historyIndex = systemState.commandHistory.length;
            
            // Show command
            addTerminalOutput(input, 'prompt');
            
            const parts = input.trim().split(' ');
            const cmd = parts[0].toUpperCase();
            const args = parts.slice(1);
            
            switch (cmd) {
                case 'HELP':
                    showHelp();
                    break;
                    
                case 'CLEAR':
                    clearTerminal();
                    break;
                    
                case 'TREE':
                    showTree();
                    break;
                    
                case 'BROWSER':
                    openFileBrowser();
                    break;
                    
                case 'WRITE':
                    if (args.length > 0) {
                        openEditor(sanitizeFilename(args[0]));
                    } else {
                        openEditor(`NOTE_${Date.now().toString().slice(-4)}.md`);
                    }
                    break;
                    
                case 'READ':
                    if (args.length > 0) {
                        if (args[0].toUpperCase() === 'STOP') {
                            stopTypewriter();
                        } else {
                            readFileWithTypewriter(sanitizeFilename(args[0]));
                        }
                    } else {
                        addTerminalOutput('USE: READ FILE.MD', 'error');
                        addTerminalOutput('OR: READ STOP TO STOP READING', 'dim');
                    }
                    break;
                    
                case 'EDIT':
                    if (args.length > 0) {
                        editFile(sanitizeFilename(args[0]));
                    } else {
                        addTerminalOutput('USE: EDIT FILE.MD', 'error');
                    }
                    break;
                    
                case 'RENAME':
                    if (args.length > 0) {
                        renameFilePrompt(sanitizeFilename(args[0]));
                    } else {
                        addTerminalOutput('USE: RENAME FILE.MD', 'error');
                        addTerminalOutput('SYSTEM WILL ASK FOR NEW FILE NAME', 'dim');
                    }
                    break;
                    
                case 'DELETE':
                    if (args.length > 0) {
                        const file = findFileWithSanitization(args[0], systemState.currentBranch);
                        if (file) {
                            showDeleteWarning(file);
                        } else {
                            addTerminalOutput(`FILE NOT FOUND: ${sanitizeFilename(args[0])}`, 'error');
                        }
                    } else {
                        addTerminalOutput('USE: DELETE FILE.MD', 'error');
                    }
                    break;
                    
                case 'BRANCH':
                    if (args.length > 0) {
                        switchBranch(args[0]);
                    } else {
                        showBranches();
                    }
                    break;
                    
                case 'CALC':
                    openCalculator();
                    break;
                    
                case 'EXPORT':
                    if (args.length > 0) {
                        if (args[0].toUpperCase() === 'ALL') {
                            exportAllFiles();
                        } else {
                            exportSingleFile(sanitizeFilename(args[0]));
                        }
                    } else {
                        addTerminalOutput('USE: EXPORT ALL OR EXPORT FILE.MD', 'error');
                    }
                    break;
                    
                case 'IMPORT':
                    fileUpload.click();
                    break;
                    
                default:
                    addTerminalOutput(`CMD NOT FOUND: ${cmd}`, 'error');
                    addTerminalOutput('CLICK <span class="link" onclick="showHelp()">HELP</span> FOR COMMANDS', 'dim');
            }
            
            terminalInputEl.value = '';
            if (cmd !== 'CLEAR') setTimeout(showSuggestions, 100);
        }
        
        // RENAME FUNCTIONALITY
        function renameFilePrompt(filename) {
            const file = findFileWithSanitization(filename, systemState.currentBranch);
            
            if (!file) {
                addTerminalOutput(`FILE NOT FOUND: ${sanitizeFilename(filename)}`, 'error');
                addTerminalOutput('TRY: <span class="link" onclick="showTree()">TREE</span> TO SEE FILES', 'dim');
                return;
            }
            
            systemState.renameFileData = file;
            systemState.renameTargetBranch = systemState.currentBranch;
            
            renameMessage.textContent = `Enter new name for: ${file.name}`;
            renameInput.value = file.name;
            renameInput.focus();
            renameInput.select();
            
            renameOverlay.classList.remove('hidden');
            setTimeout(() => renameOverlay.classList.add('rename-visible'), 10);
        }
        
        function closeRenamePrompt() {
            renameOverlay.classList.remove('rename-visible');
            setTimeout(() => {
                renameOverlay.classList.add('hidden');
                systemState.renameFileData = null;
                systemState.renameTargetBranch = null;
                terminalInputEl.focus();
            }, 150);
        }
        
        async function performFileRename() {
            if (!systemState.renameFileData) {
                closeRenamePrompt();
                return;
            }
            
            const newName = sanitizeFilename(renameInput.value.trim());
            if (!newName) {
                addTerminalOutput('RENAME CANCELLED: NO NAME PROVIDED', 'error');
                closeRenamePrompt();
                return;
            }
            
            if (newName === systemState.renameFileData.name) {
                addTerminalOutput('RENAME CANCELLED: SAME NAME', 'dim');
                closeRenamePrompt();
                return;
            }
            
            // Check if new name already exists in the same branch
            const existing = systemState.fileSystem.find(f => 
                f.branch === systemState.renameTargetBranch && 
                f.name === newName
            );
            
            if (existing) {
                addTerminalOutput(`RENAME FAILED: FILE ALREADY EXISTS: ${newName}`, 'error');
                closeRenamePrompt();
                return;
            }
            
            // Update the file name
            const oldName = systemState.renameFileData.name;
            systemState.renameFileData.name = newName;
            systemState.renameFileData.lastModified = new Date();
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(systemState.renameFileData);
            
            transaction.oncomplete = async () => {
                addTerminalOutput(`RENAMED: ${oldName} ‚Üí ${newName}`, 'success');
                closeRenamePrompt();
                await refreshAllViews();
            };
            
            transaction.onerror = (event) => {
                addTerminalOutput(`RENAME ERROR: ${event.target.error}`, 'error');
                closeRenamePrompt();
            };
        }
        
        function openFileBrowser() {
            updateFileBrowser();
            browserOverlay.classList.remove('hidden');
            setTimeout(() => browserOverlay.classList.add('browser-visible'), 10);
        }
        
        function closeFileBrowser() {
            browserOverlay.classList.remove('browser-visible');
            setTimeout(() => {
                browserOverlay.classList.add('hidden');
                terminalInputEl.focus();
            }, 150);
        }
        
        function updateFileBrowser() {
            // Update sidebar
            browserSidebar.innerHTML = '';
            
            // All files option
            const allItem = document.createElement('div');
            allItem.className = `browser-tree-item ${systemState.selectedBrowserBranch === 'all' ? 'selected' : ''}`;
            allItem.dataset.branch = 'all';
            allItem.innerHTML = '<span class="tree-icon">üìÅ</span> All Files';
            allItem.addEventListener('click', () => {
                systemState.selectedBrowserBranch = 'all';
                updateFileBrowser();
            });
            browserSidebar.appendChild(allItem);
            
            // Each branch
            systemState.branches.forEach(branch => {
                const branchItem = document.createElement('div');
                branchItem.className = `browser-tree-item ${systemState.selectedBrowserBranch === branch ? 'selected' : ''}`;
                branchItem.dataset.branch = branch;
                branchItem.innerHTML = `<span class="tree-icon">üìÇ</span> ${branch}`;
                branchItem.addEventListener('click', () => {
                    systemState.selectedBrowserBranch = branch;
                    updateFileBrowser();
                });
                
                // Make branch items droppable
                branchItem.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    branchItem.style.background = 'var(--hover)';
                });
                
                branchItem.addEventListener('dragleave', () => {
                    if (systemState.selectedBrowserBranch !== branch) {
                        branchItem.style.background = '';
                    }
                });
                
                branchItem.addEventListener('drop', (e) => {
                    e.preventDefault();
                    branchItem.style.background = '';
                    
                    if (systemState.dragSource) {
                        moveFileToBranch(systemState.dragSource.fileId, branch);
                        systemState.dragSource = null;
                    }
                });
                
                browserSidebar.appendChild(branchItem);
            });
            
            // Update files display
            browserFiles.innerHTML = '';
            
            let filteredFiles = systemState.fileSystem;
            if (systemState.selectedBrowserBranch !== 'all') {
                filteredFiles = systemState.fileSystem.filter(f => f.branch === systemState.selectedBrowserBranch);
            }
            
            // Update path and stats
            browserPath.textContent = systemState.selectedBrowserBranch === 'all' ? '/tree' : `/tree/${systemState.selectedBrowserBranch}`;
            browserStats.textContent = `${filteredFiles.length} markdown file${filteredFiles.length !== 1 ? 's' : ''}`;
            
            // Display files
            filteredFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'browser-file-item';
                fileItem.dataset.fileId = file.id;
                fileItem.draggable = true;
                
                const fileIcon = document.createElement('div');
                fileIcon.className = 'file-icon';
                fileIcon.textContent = 'üìÑ';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-size';
                fileSize.textContent = formatFileSize(file.size || 0);
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'file-delete-btn';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteWarning(file);
                });
                
                const renameBtn = document.createElement('div');
                renameBtn.className = 'file-delete-btn';
                renameBtn.innerHTML = '‚úé';
                renameBtn.style.right = '25px';
                renameBtn.style.background = 'rgba(0, 255, 0, 0.1)';
                renameBtn.style.borderColor = 'var(--accent)';
                renameBtn.style.color = 'var(--accent)';
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    systemState.currentBranch = file.branch;
                    renameFilePrompt(file.name);
                    closeFileBrowser();
                });
                
                fileItem.appendChild(fileIcon);
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileSize);
                fileItem.appendChild(deleteBtn);
                fileItem.appendChild(renameBtn);
                
                // Click to open
                fileItem.addEventListener('click', () => {
                    systemState.currentBranch = file.branch;
                    readFileWithTypewriter(file.name);
                    closeFileBrowser();
                });
                
                // Double-click to edit
                fileItem.addEventListener('dblclick', () => {
                    systemState.currentBranch = file.branch;
                    editFile(file.name);
                    closeFileBrowser();
                });
                
                // Drag start
                fileItem.addEventListener('dragstart', (e) => {
                    systemState.dragSource = { fileId: file.id, branch: file.branch };
                    fileItem.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', file.id);
                });
                
                // Drag end
                fileItem.addEventListener('dragend', () => {
                    fileItem.classList.remove('dragging');
                    systemState.dragSource = null;
                });
                
                browserFiles.appendChild(fileItem);
            });
        }
        
        function moveFileToBranch(fileId, targetBranch) {
            const file = systemState.fileSystem.find(f => f.id == fileId);
            if (!file) return;
            
            if (file.branch === targetBranch) {
                addTerminalOutput(`FILE ALREADY IN BRANCH: ${targetBranch}`, 'dim');
                return;
            }
            
            file.branch = targetBranch;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(file);
            
            transaction.oncomplete = async () => {
                addTerminalOutput(`MOVED: ${file.name} ‚Üí /tree/${targetBranch}`, 'success');
                await refreshAllViews();
            };
        }
        
        function browserCreateFile() {
            const fileName = prompt('Enter file name (will be saved as .md):', `note_${Date.now().toString().slice(-6)}.md`);
            if (fileName) {
                const sanitized = sanitizeFilename(fileName);
                const branch = systemState.selectedBrowserBranch === 'all' ? 'main' : systemState.selectedBrowserBranch;
                systemState.currentBranch = branch;
                systemState.currentFile = sanitized;
                openEditor(sanitized);
                closeFileBrowser();
            }
        }
        
        function browserCreateBranch() {
            const branchName = prompt('Enter new branch name:');
            if (branchName && !systemState.branches.includes(branchName)) {
                systemState.branches.push(branchName);
                systemState.branches.sort();
                updateFileBrowser();
                addTerminalOutput(`CREATED BRANCH: ${branchName}`, 'success');
            } else if (branchName) {
                addTerminalOutput(`BRANCH EXISTS: ${branchName}`, 'error');
            }
        }
        
        function openImportFromBrowser() {
            closeFileBrowser();
            setTimeout(() => fileUpload.click(), 200);
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // Enhanced Typewriter READ functionality
        function readFileWithTypewriter(filename) {
            const file = findFileWithSanitization(filename, systemState.currentBranch);
            
            if (!file) {
                addTerminalOutput(`FILE NOT FOUND: ${sanitizeFilename(filename)}`, 'error');
                addTerminalOutput('TRY: <span class="link" onclick="showTree()">TREE</span> TO SEE FILES', 'dim');
                return;
            }
            
            // Stop any current reading
            stopTypewriter();
            
            // Update access count
            file.accessed = (file.accessed || 0) + 1;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            transaction.objectStore(STORE_NAME).put(file);
            
            // Show file header
            addTerminalOutput(`<span class="highlight">READING: ${file.branch}/${file.name}</span>`, 'output');
            addTerminalOutput(`<span class="dim">TYPEWRITER MODE ACTIVE | 5ms/char (200 CPS) | SAY "READ STOP" TO STOP</span>`, 'dim');
            
            // Add speed control
            const speedControl = document.createElement('div');
            speedControl.className = 'typewriter-speed-control';
            speedControl.innerHTML = `
                <span class="speed-label">SPEED: ${systemState.readSpeed} CPS</span>
                <input type="range" min="50" max="400" value="${systemState.readSpeed}" class="speed-slider" id="read-speed-slider">
                <span class="speed-label">${Math.round(1000/systemState.readSpeed)}ms/char</span>
            `;
            terminalContentEl.appendChild(speedControl);
            
            // Add speed slider event
            const speedSlider = document.getElementById('read-speed-slider');
            speedSlider.addEventListener('input', (e) => {
                systemState.readSpeed = parseInt(e.target.value);
                speedControl.querySelector('.speed-label').textContent = `SPEED: ${systemState.readSpeed} CPS`;
                speedControl.querySelectorAll('.speed-label')[1].textContent = `${Math.round(1000/systemState.readSpeed)}ms/char`;
                
                // Restart typewriter with new speed
                if (systemState.isReading) {
                    clearInterval(systemState.readInterval);
                    startTypewriter();
                }
            });
            
            // Initialize typewriter state
            systemState.isReading = true;
            systemState.readFileData = file;
            systemState.readContent = file.content;
            systemState.readPosition = 0;
            systemState.currentLine = '';
            systemState.currentLineElement = null;
            
            // Create initial typewriter line
            createNewTypewriterLine();
            
            scrollToBottom();
            
            // Start typewriter
            startTypewriter();
        }
        
        function createNewTypewriterLine() {
            if (systemState.currentLineElement) {
                // Remove cursor from previous line
                systemState.currentLineElement.classList.remove('typewriter-line');
            }
            
            const typewriterLine = document.createElement('div');
            typewriterLine.className = 'terminal-line typewriter-line';
            typewriterLine.id = 'typewriter-current-line';
            terminalContentEl.appendChild(typewriterLine);
            
            systemState.currentLine = '';
            systemState.currentLineElement = typewriterLine;
            return typewriterLine;
        }
        
        function startTypewriter() {
            if (!systemState.isReading) return;
            
            const delay = Math.round(1000 / systemState.readSpeed); // Convert CPS to ms per character
            
            systemState.readInterval = setInterval(() => {
                if (systemState.readPosition >= systemState.readContent.length) {
                    stopTypewriter();
                    
                    // Remove cursor from last line
                    if (systemState.currentLineElement) {
                        systemState.currentLineElement.classList.remove('typewriter-line');
                    }
                    
                    // Add completion message
                    const completeDiv = document.createElement('div');
                    completeDiv.className = 'reading-indicator';
                    completeDiv.textContent = 'READING COMPLETE';
                    terminalContentEl.appendChild(completeDiv);
                    
                    // Add action buttons
                    const actionDiv = document.createElement('div');
                    actionDiv.className = 'suggestions';
                    actionDiv.innerHTML = `
                        <div class="suggestion" onclick="editFile('${systemState.readFileData.name}')">EDIT FILE</div>
                        <div class="suggestion" onclick="renameFilePrompt('${systemState.readFileData.name}')">RENAME FILE</div>
                        <div class="suggestion" onclick="executeCommand('export ${systemState.readFileData.name}')">EXPORT FILE</div>
                        <div class="suggestion" onclick="showDeleteWarning(${JSON.stringify(systemState.readFileData).replace(/"/g, '&quot;')})">DELETE FILE</div>
                        <div class="suggestion" onclick="showSuggestions()">BACK TO TERMINAL</div>
                    `;
                    terminalContentEl.appendChild(actionDiv);
                    
                    scrollToBottom();
                    return;
                }
                
                // Get next character
                const nextChar = systemState.readContent[systemState.readPosition];
                
                // Handle newlines
                if (nextChar === '\n') {
                    // Create a new line for next character
                    systemState.currentLineElement.textContent = systemState.currentLine;
                    systemState.currentLineElement.classList.remove('typewriter-line');
                    
                    createNewTypewriterLine();
                    systemState.currentLine = '';
                } else {
                    // Add character with typewriter effect
                    systemState.currentLine += nextChar;
                    systemState.currentLineElement.textContent = systemState.currentLine;
                }
                
                systemState.readPosition++;
                scrollToBottom();
                
            }, delay);
        }
        
        function stopTypewriter() {
            systemState.isReading = false;
            if (systemState.readInterval) {
                clearInterval(systemState.readInterval);
                systemState.readInterval = null;
            }
            
            // Remove typewriter cursor
            if (systemState.currentLineElement) {
                systemState.currentLineElement.classList.remove('typewriter-line');
            }
            
            // Remove speed control
            const speedControl = document.querySelector('.typewriter-speed-control');
            if (speedControl) {
                speedControl.remove();
            }
            
            addTerminalOutput('<span class="dim">TYPEWRITER STOPPED</span>', 'dim');
        }
        
        function showTree() {
            // Clear previous tree
            const existingTree = document.querySelector('.file-tree');
            if (existingTree) {
                existingTree.remove();
            }
            
            addTerminalOutput('<span class="highlight">FILE TREE:</span>', 'output');
            addTerminalOutput('<span class="dim">MARKDOWN-ONLY: All files are .md format</span>', 'dim');
            
            if (systemState.fileSystem.length === 0) {
                addTerminalOutput('NO FILES. CLICK <span class="link" onclick="executeCommand(\'write\')">WRITE</span> TO CREATE', 'dim');
                return;
            }
            
            const treeContainer = document.createElement('div');
            treeContainer.className = 'file-tree';
            systemState.currentTreeView = treeContainer;
            
            systemState.branches.forEach(branch => {
                const branchFiles = systemState.fileSystem.filter(f => f.branch === branch);
                if (branchFiles.length === 0) return;
                
                const branchDiv = document.createElement('div');
                branchDiv.className = 'branch-item';
                
                const branchName = document.createElement('div');
                branchName.className = 'branch-name';
                branchName.innerHTML = `<span class="link" onclick="switchBranch('${branch}')">/tree/${branch}</span> (${branchFiles.length})`;
                
                const fileList = document.createElement('div');
                fileList.className = 'file-list';
                
                branchFiles.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'terminal-file-item';
                    fileDiv.dataset.fileId = file.id;
                    
                    const leftContainer = document.createElement('div');
                    leftContainer.style.display = 'flex';
                    leftContainer.style.alignItems = 'center';
                    
                    const badge = document.createElement('span');
                    badge.className = 'terminal-file-badge';
                    badge.textContent = 'MD';
                    
                    const link = document.createElement('span');
                    link.className = 'file-link';
                    link.textContent = file.name;
                    link.addEventListener('click', () => {
                        systemState.currentBranch = branch;
                        readFileWithTypewriter(file.name);
                    });
                    
                    leftContainer.appendChild(badge);
                    leftContainer.appendChild(link);
                    
                    const buttonContainer = document.createElement('div');
                    buttonContainer.style.display = 'flex';
                    buttonContainer.style.gap = '5px';
                    
                    const renameBtn = document.createElement('span');
                    renameBtn.className = 'terminal-rename-btn';
                    renameBtn.textContent = 'RENAME';
                    renameBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        systemState.currentBranch = branch;
                        renameFilePrompt(file.name);
                    });
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'terminal-delete-btn';
                    deleteBtn.textContent = 'DELETE';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        systemState.currentBranch = branch;
                        showDeleteWarning(file);
                    });
                    
                    buttonContainer.appendChild(renameBtn);
                    buttonContainer.appendChild(deleteBtn);
                    
                    fileDiv.appendChild(leftContainer);
                    fileDiv.appendChild(buttonContainer);
                    fileList.appendChild(fileDiv);
                });
                
                branchDiv.appendChild(branchName);
                branchDiv.appendChild(fileList);
                treeContainer.appendChild(branchDiv);
            });
            
            terminalContentEl.appendChild(treeContainer);
            scrollToBottom();
        }
        
        function openEditor(filename = '') {
            const sanitized = sanitizeFilename(filename);
            systemState.currentFile = sanitized;
            editorFilename.textContent = `EDITING: ${systemState.currentFile}`;
            editorTextarea.value = '';
            
            // Check if file exists
            const existing = systemState.fileSystem.find(f => 
                f.branch === systemState.currentBranch && 
                f.name === systemState.currentFile
            );
            
            if (existing) {
                editorTextarea.value = existing.content;
            }
            
            editorOverlay.classList.remove('hidden');
            setTimeout(() => editorOverlay.classList.add('editor-visible'), 10);
            editorTextarea.focus();
        }
        
        function closeEditor() {
            editorOverlay.classList.remove('editor-visible');
            setTimeout(() => {
                editorOverlay.classList.add('hidden');
                terminalInputEl.focus();
            }, 150);
        }
        
        async function saveEditor() {
            const content = editorTextarea.value;
            if (!content.trim()) {
                addTerminalOutput('FILE EMPTY', 'error');
                closeEditor();
                return;
            }
            
            const size = new Blob([content]).size;
            const existing = systemState.fileSystem.find(f => 
                f.branch === systemState.currentBranch && 
                f.name === systemState.currentFile
            );
            
            const file = {
                name: systemState.currentFile,
                branch: systemState.currentBranch,
                content: content,
                lastModified: new Date(),
                size: size,
                accessed: (existing ? existing.accessed : 0) + 1
            };
            
            if (existing) file.id = existing.id;
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            
            const request = existing ? store.put(file) : store.add(file);
            
            request.onsuccess = async () => {
                addTerminalOutput(`SAVED: ${systemState.currentFile}`, 'success');
                closeEditor();
                await refreshAllViews();
            };
            
            request.onerror = (event) => {
                addTerminalOutput(`ERROR: ${event.target.error}`, 'error');
            };
        }
        
        function showDeleteWarning(file) {
            systemState.fileToDelete = file;
            warningMessage.textContent = `Are you sure you want to delete "${file.name}"? This action cannot be undone.`;
            warningOverlay.classList.remove('hidden');
            setTimeout(() => warningOverlay.classList.add('warning-visible'), 10);
        }
        
        function closeWarning() {
            warningOverlay.classList.remove('warning-visible');
            setTimeout(() => {
                warningOverlay.classList.add('hidden');
                systemState.fileToDelete = null;
                terminalInputEl.focus();
            }, 150);
        }
        
        async function performFileDeletion() {
            if (!systemState.fileToDelete) {
                closeWarning();
                return;
            }
            
            const file = systemState.fileToDelete;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.delete(file.id);
            
            transaction.oncomplete = async () => {
                addTerminalOutput(`DELETED: ${file.name}`, 'success');
                closeWarning();
                closeEditor();
                await refreshAllViews();
            };
            
            transaction.onerror = (event) => {
                addTerminalOutput(`DELETE ERROR: ${event.target.error}`, 'error');
                closeWarning();
            };
        }
        
        async function refreshAllViews() {
            // Reload file system
            await loadFileSystem();
            
            // Update file browser if open
            if (browserOverlay.classList.contains('browser-visible')) {
                updateFileBrowser();
            }
            
            // Update tree view if visible
            if (systemState.currentTreeView && systemState.currentTreeView.parentNode) {
                const currentScroll = terminalOutputEl.scrollTop;
                showTree();
                terminalOutputEl.scrollTop = currentScroll;
            }
            
            // Update recent files
            systemState.recentFiles = [...systemState.fileSystem]
                .sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified))
                .slice(0, 3);
        }
        
        // Export functionality - MARKDOWN ONLY
        function exportAllFiles() {
            if (systemState.fileSystem.length === 0) {
                addTerminalOutput('NO MARKDOWN FILES TO EXPORT', 'error');
                return;
            }
            
            addTerminalOutput('<span class="highlight">EXPORTING ENTIRE SYSTEM AS MARKDOWN...</span>', 'output');
            
            // Create unified markdown export
            let exportContent = `# MICROSEEK OS EXPORT\n`;
            exportContent += `## MARKDOWN SYSTEM EXPORT - ${new Date().toLocaleString()}\n`;
            exportContent += `### Total Files: ${systemState.fileSystem.length}\n`;
            exportContent += `### Total Branches: ${systemState.branches.length}\n\n`;
            
            // Sort files by branch for organization
            const filesByBranch = {};
            systemState.fileSystem.forEach(file => {
                if (!filesByBranch[file.branch]) {
                    filesByBranch[file.branch] = [];
                }
                filesByBranch[file.branch].push(file);
            });
            
            // Add each branch section
            Object.keys(filesByBranch).sort().forEach(branch => {
                exportContent += `## BRANCH: ${branch}\n\n`;
                
                filesByBranch[branch].forEach(file => {
                    exportContent += `### ${file.name}\n`;
                    exportContent += `**Path:** /tree/${branch}/${file.name}\n`;
                    exportContent += `**Size:** ${formatFileSize(file.size || 0)}\n`;
                    exportContent += `**Modified:** ${new Date(file.lastModified).toLocaleString()}\n`;
                    exportContent += `**Accessed:** ${file.accessed || 0} times\n\n`;
                    exportContent += '```markdown\n';
                    exportContent += file.content + '\n';
                    exportContent += '```\n\n';
                    exportContent += '---\n\n';
                });
            });
            
            // Add system metadata
            exportContent += `## SYSTEM METADATA\n`;
            exportContent += `- Export Date: ${new Date().toISOString()}\n`;
            exportContent += `- Total Characters: ${exportContent.length}\n`;
            exportContent += `- MicroSeek OS Version: 5.0\n`;
            exportContent += `- File Format: Markdown (.md) Only\n`;
            
            // Download the file
            downloadFile(exportContent, `microseek_os_export_${Date.now()}.md`);
            addTerminalOutput(`EXPORTED ${systemState.fileSystem.length} MARKDOWN FILES TO UNIFIED MARKDOWN`, 'success');
        }
        
        function exportSingleFile(filename) {
            const file = findFileWithSanitization(filename, systemState.currentBranch);
            
            if (!file) {
                addTerminalOutput(`MARKDOWN FILE NOT FOUND: ${sanitizeFilename(filename)}`, 'error');
                return;
            }
            
            let exportContent = `# ${file.name}\n`;
            exportContent += `## MARKDOWN FILE EXPORT - ${new Date().toLocaleString()}\n`;
            exportContent += `**Path:** /tree/${file.branch}/${file.name}\n`;
            exportContent += `**Size:** ${formatFileSize(file.size || 0)}\n`;
            exportContent += `**Modified:** ${new Date(file.lastModified).toLocaleString()}\n`;
            exportContent += `**Accessed:** ${file.accessed || 0} times\n\n`;
            exportContent += '---\n\n';
            exportContent += file.content;
            
            // Download the file
            downloadFile(exportContent, file.name);
            addTerminalOutput(`EXPORTED MARKDOWN FILE: ${file.name}`, 'success');
        }
        
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function openCalculator() {
            systemState.calcExpression = '';
            systemState.calcResult = '0';
            calcDisplay.textContent = '0';
            calcOverlay.classList.remove('hidden');
            setTimeout(() => calcOverlay.classList.add('calc-visible'), 10);
        }
        
        function closeCalculator() {
            calcOverlay.classList.remove('calc-visible');
            setTimeout(() => {
                calcOverlay.classList.add('hidden');
                terminalInputEl.focus();
            }, 150);
        }
        
        function handleCalcButton(op) {
            if (op === 'C') {
                systemState.calcExpression = '';
                systemState.calcResult = '0';
            } else if (op === 'CE') {
                systemState.calcExpression = systemState.calcExpression.slice(0, -1);
            } else if (op === 'back') {
                systemState.calcExpression = systemState.calcExpression.slice(0, -1);
            } else if (op === '=') {
                try {
                    systemState.calcResult = math.evaluate(systemState.calcExpression);
                    addTerminalOutput(`CALC: ${systemState.calcExpression} = ${systemState.calcResult}`, 'success');
                    closeCalculator();
                } catch (error) {
                    systemState.calcResult = 'ERROR';
                }
            } else {
                systemState.calcExpression += op;
            }
            
            // Update display
            calcDisplay.textContent = systemState.calcExpression || '0';
        }
        
        function editFile(filename) {
            const sanitized = sanitizeFilename(filename);
            systemState.currentFile = sanitized;
            openEditor(sanitized);
        }
        
        function switchBranch(branchName) {
            if (!systemState.branches.includes(branchName)) {
                systemState.branches.push(branchName);
            }
            systemState.currentBranch = branchName;
            addTerminalOutput(`SWITCHED TO: /tree/${branchName}`, 'success');
            updateStatus();
        }
        
        function showBranches() {
            addTerminalOutput('<span class="highlight">BRANCHES:</span>', 'output');
            systemState.branches.forEach(branch => {
                const count = systemState.fileSystem.filter(f => f.branch === branch).length;
                const current = branch === systemState.currentBranch ? ' (CURRENT)' : '';
                const branchLine = document.createElement('div');
                branchLine.className = 'terminal-line';
                branchLine.innerHTML = `<span class="link" onclick="switchBranch('${branch}')">${branch}</span> - ${count} markdown files${current}`;
                terminalContentEl.appendChild(branchLine);
            });
            scrollToBottom();
        }
        
        function clearTerminal() {
            // Stop typewriter if active
            stopTypewriter();
            
            terminalContentEl.innerHTML = '';
            systemState.currentTreeView = null;
            addTerminalOutput('TERMINAL CLEARED.', 'dim');
            showSuggestions();
        }
        
        function showImportBranchSelector(fileData) {
            // Update branch select options
            branchSelect.innerHTML = '';
            systemState.branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                if (branch === systemState.currentBranch) option.selected = true;
                branchSelect.appendChild(option);
            });
            
            // Sanitize the filename before import - ENFORCE .md
            fileData.name = sanitizeFilename(fileData.name);
            systemState.pendingImport = fileData;
            importOverlay.classList.remove('hidden');
            setTimeout(() => importOverlay.classList.add('import-visible'), 10);
        }
        
        function hideImportBranchSelector() {
            importOverlay.classList.remove('import-visible');
            setTimeout(() => {
                importOverlay.classList.add('hidden');
                systemState.pendingImport = null;
            }, 150);
        }
        
        async function importFile() {
            if (!systemState.pendingImport) return;
            
            const selectedBranch = branchSelect.value;
            const fileData = systemState.pendingImport;
            
            const file = {
                name: fileData.name,
                branch: selectedBranch,
                content: fileData.content,
                lastModified: new Date(),
                size: fileData.size,
                accessed: 0
            };
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.add(file);
            
            request.onsuccess = async () => {
                addTerminalOutput(`IMPORTED MARKDOWN: ${file.name} TO /tree/${selectedBranch}`, 'success');
                hideImportBranchSelector();
                await refreshAllViews();
            };
            
            request.onerror = (event) => {
                addTerminalOutput(`IMPORT ERROR: ${event.target.error}`, 'error');
                hideImportBranchSelector();
            };
        }
        
        // Event Listeners
        terminalInputEl.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const command = this.value.trim();
                if (command) executeCommand(command);
                this.value = '';
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (systemState.commandHistory.length > 0) {
                    if (systemState.historyIndex > 0) systemState.historyIndex--;
                    if (systemState.historyIndex >= 0) {
                        this.value = systemState.commandHistory[systemState.historyIndex];
                    }
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (systemState.historyIndex < systemState.commandHistory.length - 1) {
                    systemState.historyIndex++;
                    this.value = systemState.commandHistory[systemState.historyIndex];
                } else {
                    systemState.historyIndex = systemState.commandHistory.length;
                    this.value = '';
                }
            }
        });
        
        sendButton.addEventListener('click', () => {
            const command = terminalInputEl.value.trim();
            if (command) {
                executeCommand(command);
                terminalInputEl.value = '';
            }
        });
        
        importButton.addEventListener('click', () => {
            fileUpload.click();
        });
        
        fileUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // MARKDOWN-ONLY: Check if file is markdown
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.md') && !fileName.endsWith('.markdown')) {
                addTerminalOutput('IMPORT ERROR: Only markdown (.md) files are allowed', 'error');
                fileUpload.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                const content = event.target.result;
                showImportBranchSelector({
                    name: file.name,
                    content: content,
                    size: file.size
                });
            };
            reader.readAsText(file);
            fileUpload.value = '';
        });
        
        // Rename events
        renameCancelBtn.addEventListener('click', closeRenamePrompt);
        renameConfirmBtn.addEventListener('click', performFileRename);
        renameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performFileRename();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeRenamePrompt();
            }
        });
        
        // Automatically sanitize rename input - ENFORCE .md
        renameInput.addEventListener('input', (e) => {
            const cursorPos = e.target.selectionStart;
            const original = e.target.value;
            const sanitized = sanitizeFilename(original);
            
            if (original !== sanitized) {
                e.target.value = sanitized;
                // Restore cursor position
                e.target.setSelectionRange(cursorPos, cursorPos);
            }
        });
        
        // Editor events
        editorSaveBtn.addEventListener('click', saveEditor);
        editorDeleteBtn.addEventListener('click', () => {
            if (systemState.currentFile) {
                const file = systemState.fileSystem.find(f => 
                    f.branch === systemState.currentBranch && 
                    f.name === systemState.currentFile
                );
                if (file) {
                    showDeleteWarning(file);
                }
            }
        });
        editorCancelBtn.addEventListener('click', closeEditor);
        
        // Browser events
        browserCloseBtn.addEventListener('click', closeFileBrowser);
        
        // Calculator events
        calcCloseBtn.addEventListener('click', closeCalculator);
        calcButtons.forEach(button => {
            button.addEventListener('click', () => {
                const op = button.getAttribute('data-op');
                handleCalcButton(op);
            });
        });
        
        // Import events
        importConfirmBtn.addEventListener('click', importFile);
        importCancelBtn.addEventListener('click', hideImportBranchSelector);
        
        // Warning events
        warningCancelBtn.addEventListener('click', closeWarning);
        warningConfirmBtn.addEventListener('click', performFileDeletion);
        
        // Click outside to focus input
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.suggestion') && 
                !e.target.closest('.link') && 
                !e.target.closest('.file-link') &&
                !e.target.closest('.branch-name') &&
                !e.target.closest('#editor-overlay') &&
                !e.target.closest('#calc-overlay') &&
                !e.target.closest('#browser-overlay') &&
                !e.target.closest('#import-overlay') &&
                !e.target.closest('#warning-overlay') &&
                !e.target.closest('#rename-overlay')) {
                terminalInputEl.focus();
            }
        });
        
        // Prevent zoom on mobile
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Start boot process
        window.addEventListener('load', () => {
            simulateLoading();
        });
        
        // Global functions for inline handlers
        window.showHelp = showHelp;
        window.readFileWithTypewriter = readFileWithTypewriter;
        window.readFileFromBranch = readFileFromBranch;
        window.editFile = editFile;
        window.renameFilePrompt = renameFilePrompt;
        window.switchBranch = switchBranch;
        window.openCalculator = openCalculator;
        window.openFileBrowser = openFileBrowser;
        window.executeCommand = executeCommand;
        window.showTree = showTree;
        window.showSuggestions = showSuggestions;
        window.showDeleteWarning = showDeleteWarning;
        window.stopTypewriter = stopTypewriter;
        window.exportAllFiles = exportAllFiles;
        window.exportSingleFile = exportSingleFile;
        window.browserCreateFile = browserCreateFile;
        window.browserCreateBranch = browserCreateBranch;
        window.openImportFromBrowser = openImportFromBrowser;
    </script>
</body>
</html>