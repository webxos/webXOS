<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXOS MCP Terminal</title>
    <link rel="stylesheet" href="/server.css">
    <style>
        body { font-family: 'Courier New', monospace; background: #000000; color: #00ff00; margin: 0; }
    </style>
</head>
<body>
    <div class="console-container">
        <h1>WebXOS MCP Terminal</h1>
        <div id="console-output"></div>
        <div class="input-container">
            <span>&gt;</span>
            <input type="text" id="console-input" placeholder="Type /help for commands" autofocus>
        </div>
    </div>

    <script>
        const commands = {
            '/help': 'Available commands:\n/status - Check MCP and agent status\n/debug - Run diagnostics with tracebacks\n/llm - Configure LLM API key\n/help - Show this help menu',
            '/status': async () => await checkStatus(),
            '/debug': async () => await runDebug(),
            '/llm': async (args) => await configureLLM(args)
        };

        async function fetchWithErrorHandling(url, options = {}) {
            try {
                const response = await fetch(url, { ...options, timeout: 5000 });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON, got ${contentType}: ${text.slice(0, 50)}...`);
                }
                return await response.json();
            } catch (error) {
                const stack = error.stack || 'No stack trace available';
                const aiAnalysis = analyzeError(error.message, stack, url);
                logOutput(`Error fetching ${url}: ${error.message}\nStack Trace:\n${stack}\nAI Analysis: ${aiAnalysis}`);
                return null;
            }
        }

        function analyzeError(message, stack, url) {
            const analysis = [];
            if (message.includes('HTTP 404')) {
                analysis.push('404 Error: Endpoint not found. Verify Netlify Function deployment and routing in netlify.toml.');
                analysis.push(`Check if ${url} exists in server/[function]/index.js and is deployed to /.netlify/functions/[function].`);
            }
            if (message.includes('Expected JSON')) {
                analysis.push('Server returned non-JSON response. Ensure the endpoint returns Content-Type: application/json.');
            }
            if (stack.includes('Timeout')) {
                analysis.push('Request timed out. Check server availability or increase timeout in fetch options.');
            }
            return analysis.length ? analysis.join('\n') : 'No specific issues identified. Check server logs and network configuration.';
        }

        function logOutput(message) {
            const output = document.getElementById('console-output');
            const entry = document.createElement('div');
            entry.textContent = message;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        }

        async function checkStatus() {
            logOutput('Checking MCP and agent status...');
            const mcpData = await fetchWithErrorHandling('/.netlify/functions/mcp/status');
            if (mcpData) {
                logOutput(`MCP Status: ${mcpData.status}, Active Agents: ${mcpData.activeAgents?.length || 0}`);
                mcpData.details.forEach(agent => {
                    logOutput(`${agent.id}: ${agent.status}${agent.error ? ` (Error: ${agent.error})` : ''}`);
                });
            } else {
                logOutput('Failed to retrieve MCP status.');
            }
        }

        async function runDebug() {
            logOutput('Running diagnostics...');
            const debugData = await fetchWithErrorHandling('/.netlify/functions/mcp/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: 'diagnostics' })
            });
            if (debugData) {
                logOutput(`Diagnostics: ${debugData.message}`);
                debugData.details.forEach(agent => {
                    logOutput(`${agent.id}: ${agent.status}${agent.error ? ` (Error: ${agent.error})` : ''}`);
                });
                // Pipeline testing
                const agents = ['chatbot-agent1', 'chatbot-agent2', 'chatbot-agent3', 'chatbot-agent4', 'server-agent1', 'server-agent2', 'server-agent3', 'server-agent4'];
                for (const agent of agents) {
                    const healthData = await fetchWithErrorHandling(`/.netlify/functions/${agent}/health`);
                    logOutput(`Pipeline Test - ${agent}: ${healthData ? healthData.status : 'Failed'}`);
                }
            } else {
                logOutput('Diagnostics failed.');
            }
        }

        async function configureLLM(args) {
            const apiKey = args.trim();
            if (!apiKey) {
                logOutput('Error: No API key provided. Usage: /llm <api-key>');
                return;
            }
            logOutput('Configuring LLM...');
            const response = await fetchWithErrorHandling('/.netlify/functions/mcp/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: 'llm-test', apiKey })
            });
            logOutput(response ? `LLM Config: ${response.message}` : 'LLM configuration failed.');
        }

        function handleCommand(input) {
            const [command, ...args] = input.trim().split(' ');
            if (commands[command]) {
                if (typeof commands[command] === 'string') {
                    logOutput(commands[command]);
                } else {
                    commands[command](args.join(' '));
                }
            } else {
                logOutput(`Unknown command: ${command}. Type /help for available commands.`);
            }
        }

        document.getElementById('console-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const input = event.target.value;
                logOutput(`> ${input}`);
                handleCommand(input);
                event.target.value = '';
            }
        });

        window.onload = () => {
            logOutput('WebXOS MCP Terminal initialized. Type /help for commands.');
            logOutput('Neurots: Initialized successfully');
        };
    </script>
</body>
</html>
