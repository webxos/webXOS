<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MYSTERIUM BLACKBOX · COLIGNUM TESSERACT (DOS ERA + ZOOM)</title>
    <style>
        /* ---------- GROUNDING: PURE BLACK & WHITE, MINIMAL TEXT BUTTONS ---------- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            font-family: 'Courier New', Courier, monospace;
        }
        .text-btn {
            position: absolute;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            z-index: 300;
            text-decoration: none;
            background: transparent;
            border: none;
            padding: 4px 8px;
            transition: 0.2s;
        }
        .text-btn:hover {
            text-decoration: underline;
            color: #aaa;
        }
        #grounding-btn { top: 20px; right: 120px; }
        #fullscreen-btn { top: 20px; right: 20px; }
        #screensaver-btn { top: 20px; right: 240px; }

        #info-badge {
            position: absolute;
            top: 18px;
            left: 24px;
            color: white;
            background: black;
            border: 1px solid white;
            padding: 6px 16px;
            z-index: 300;
            font-size: 14px;
            letter-spacing: 2px;
            text-transform: uppercase;
            box-shadow: 0 0 8px rgba(255,255,255,0.2);
            pointer-events: none;
        }

        /* CLI */
        #cli-container {
            position: absolute;
            bottom: 24px;
            left: 24px;
            right: 24px;
            background: rgba(0,0,0,0.95);
            border: 1px solid white;
            color: white;
            padding: 16px 20px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            z-index: 400;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }
        #cli-output {
            height: 110px;
            overflow-y: auto;
            margin-bottom: 12px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #ddd;
            font-size: 14px;
            line-height: 1.5;
        }
        #cli-input-line {
            display: flex;
            align-items: center;
            border-top: 1px solid #333;
            padding-top: 8px;
        }
        .prompt {
            color: white;
            margin-right: 12px;
            font-weight: bold;
            font-size: 16px;
        }
        #cli-input {
            flex: 1;
            background: black;
            border: 1px solid #555;
            color: white;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            outline: none;
            caret-color: white;
        }
        #cli-input:focus { border-color: white; }

        /* FACE TERMINALS — larger, double‑clickable */
        .face-terminal {
            background: black;
            border: 2px solid white;
            color: white;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            width: 350px;
            height: 250px;
            overflow: auto;
            box-shadow: 0 0 30px rgba(255,255,255,0.15);
            text-shadow: 0 0 5px white;
            backdrop-filter: blur(1px);
            word-wrap: break-word;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: white black;
            resize: none;
            cursor: pointer; /* hint that it's clickable */
            transition: border 0.1s;
        }
        .face-terminal:hover {
            border-color: #ccc;
        }
        .face-terminal::-webkit-scrollbar {
            width: 6px;
        }
        .face-terminal::-webkit-scrollbar-track {
            background: black;
            border-left: 1px solid white;
        }
        .face-terminal::-webkit-scrollbar-thumb {
            background: white;
            border-radius: 0px;
        }

        /* ---------- ZOOM MODAL (full‑screen overlay) ---------- */
        #zoom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
        }
        .modal-content {
            background: black;
            border: 2px solid white;
            width: 80%;
            max-width: 900px;
            height: 80%;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            color: white;
            box-shadow: 0 0 50px white;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid white;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: normal;
            letter-spacing: 2px;
        }
        .modal-close {
            cursor: pointer;
            font-size: 28px;
            line-height: 1;
            padding: 0 10px;
        }
        .modal-close:hover {
            color: #aaa;
        }
        .modal-body {
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }
        .modal-edit-area {
            width: 100%;
            flex: 1;
            background: black;
            border: 1px solid white;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            padding: 15px;
            resize: none;
            outline: none;
            margin-bottom: 20px;
        }
        .modal-edit-area:focus {
            border-color: #ccc;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
        }
        .modal-btn {
            background: black;
            border: 1px solid white;
            color: white;
            padding: 10px 25px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .modal-btn:hover {
            background: white;
            color: black;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
        }
    </style>
</head>
<body>
    <div id="info-badge">⚿ COLIGNUM: MYSTERIUM BLACKBOX // 6 FACES ⚿</div>
    
    <button id="grounding-btn" class="text-btn">GROUNDING</button>
    <button id="screensaver-btn" class="text-btn">SCREENSAVER</button>
    <button id="fullscreen-btn" class="text-btn">FULLSCREEN</button>

    <div id="cli-container">
        <div id="cli-output">
> MYSTERIUM BLACKBOX [BOOT]: TESSERACT WIREFRAME ACTIVE.
> MS‑DOS MODE: TYPE /HELP FOR COMMANDS.
        </div>
        <div id="cli-input-line">
            <span class="prompt">C:\BLACKBOX&gt;</span>
            <input type="text" id="cli-input" placeholder="command" autofocus spellcheck="false">
        </div>
    </div>

    <!-- ZOOM MODAL -->
    <div id="zoom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>FACE <span id="modal-face-num">1</span> // RAW HTML</h2>
                <span class="modal-close" id="modal-close">✕</span>
            </div>
            <div class="modal-body">
                <textarea id="modal-html" class="modal-edit-area" spellcheck="false" placeholder="Edit HTML..."></textarea>
                <div class="modal-actions">
                    <button id="modal-apply" class="modal-btn">APPLY</button>
                    <button id="modal-cancel" class="modal-btn">CANCEL</button>
                </div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // ---------- SCENE ----------
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);

        const camera = new THREE.PerspectiveCamera(48, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(3.5, 2.0, 6.0);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const css2DRenderer = new CSS2DRenderer();
        css2DRenderer.setSize(window.innerWidth, window.innerHeight);
        css2DRenderer.domElement.style.position = 'absolute';
        css2DRenderer.domElement.style.top = '0px';
        css2DRenderer.domElement.style.left = '0px';
        // Let child divs receive pointer events
        css2DRenderer.domElement.style.pointerEvents = 'none'; 
        document.getElementById('canvas-container').appendChild(css2DRenderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.8;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.enableRotate = true;
        controls.rotateSpeed = 0.7;
        controls.zoomSpeed = 1.0;

        // Lights
        const ambient = new THREE.AmbientLight(0x404040);
        scene.add(ambient);
        const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
        backLight.position.set(-1, 1, -1);
        scene.add(backLight);

        // ---------- TESSERACT WIREFRAME ----------
        const outerGeo = new THREE.BoxGeometry(2.2, 2.2, 2.2);
        const outerEdges = new THREE.EdgesGeometry(outerGeo);
        const outerLines = new THREE.LineSegments(outerEdges, new THREE.LineBasicMaterial({ color: 0xffffff }));
        scene.add(outerLines);

        const innerGeo = new THREE.BoxGeometry(1.2, 1.2, 1.2);
        const innerEdges = new THREE.EdgesGeometry(innerGeo);
        const innerLines = new THREE.LineSegments(innerEdges, new THREE.LineBasicMaterial({ color: 0xaaaaaa }));
        scene.add(innerLines);

        const outerCorners = [
            new THREE.Vector3(-1.1, -1.1, -1.1), new THREE.Vector3( 1.1, -1.1, -1.1), new THREE.Vector3( 1.1, -1.1,  1.1), new THREE.Vector3(-1.1, -1.1,  1.1),
            new THREE.Vector3(-1.1,  1.1, -1.1), new THREE.Vector3( 1.1,  1.1, -1.1), new THREE.Vector3( 1.1,  1.1,  1.1), new THREE.Vector3(-1.1,  1.1,  1.1)
        ];
        const innerCorners = [
            new THREE.Vector3(-0.6, -0.6, -0.6), new THREE.Vector3( 0.6, -0.6, -0.6), new THREE.Vector3( 0.6, -0.6,  0.6), new THREE.Vector3(-0.6, -0.6,  0.6),
            new THREE.Vector3(-0.6,  0.6, -0.6), new THREE.Vector3( 0.6,  0.6, -0.6), new THREE.Vector3( 0.6,  0.6,  0.6), new THREE.Vector3(-0.6,  0.6,  0.6)
        ];

        const connectorVertices = [];
        for (let i = 0; i < 8; i++) {
            connectorVertices.push(outerCorners[i], innerCorners[i]);
        }
        const connectorGeo = new THREE.BufferGeometry().setFromPoints(connectorVertices);
        const connectorLines = new THREE.LineSegments(connectorGeo, new THREE.LineBasicMaterial({ color: 0x888888 }));
        scene.add(connectorLines);

        // ---------- 6 LARGE FACE TERMINALS ----------
        const facePositions = [
            { pos: [ 1.1, 0, 0], name: 'FACE 1' },
            { pos: [-1.1, 0, 0], name: 'FACE 2' },
            { pos: [ 0, 1.1, 0], name: 'FACE 3' },
            { pos: [ 0,-1.1, 0], name: 'FACE 4' },
            { pos: [ 0, 0, 1.1], name: 'FACE 5' },
            { pos: [ 0, 0,-1.1], name: 'FACE 6' }
        ];

        const faceDivs = [];

        facePositions.forEach((face, idx) => {
            const div = document.createElement('div');
            div.className = 'face-terminal';
            div.id = `face-${idx + 1}`;
            
            div.innerHTML = `
                <span style="color:white; font-weight:bold;">⚡ MYSTERIUM BLACKBOX [FACE ${idx+1}]</span><br>
                <span style="color:#ccc;">> tesseract terminal</span><br>
                <span style="color:#888;">HTML ready.</span><br>
                <span style="color:white;">$ /modify ${idx+1} &lt;html&gt;</span>
            `;

            // Make div receive pointer events and double‑click
            div.style.pointerEvents = 'auto';
            div.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                openZoomModal(idx); // 0‑based index
            });

            const css2dLabel = new CSS2DObject(div);
            css2dLabel.position.set(face.pos[0], face.pos[1], face.pos[2]);
            scene.add(css2dLabel);
            
            faceDivs.push(div);
        });

        // ---------- ZOOM MODAL LOGIC ----------
        const modal = document.getElementById('zoom-modal');
        const modalFaceSpan = document.getElementById('modal-face-num');
        const modalTextarea = document.getElementById('modal-html');
        const modalClose = document.getElementById('modal-close');
        const modalApply = document.getElementById('modal-apply');
        const modalCancel = document.getElementById('modal-cancel');
        let currentFaceIndex = 0;

        function openZoomModal(faceIdx) {
            currentFaceIndex = faceIdx;
            modalFaceSpan.textContent = (faceIdx + 1).toString();
            modalTextarea.value = faceDivs[faceIdx].innerHTML;
            modal.style.display = 'flex';
        }

        function closeZoomModal() {
            modal.style.display = 'none';
        }

        modalClose.addEventListener('click', closeZoomModal);
        modalCancel.addEventListener('click', closeZoomModal);
        modalApply.addEventListener('click', () => {
            // Update the face div with the edited HTML
            faceDivs[currentFaceIndex].innerHTML = modalTextarea.value;
            closeZoomModal();
        });

        // Close modal if user clicks outside content? Not needed, but we can add.
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeZoomModal();
        });

        // ---------- SCREENSAVER MODE ----------
        let screensaverMode = false;
        let originalColors = {
            outer: 0xffffff,
            inner: 0xaaaaaa,
            connector: 0x888888
        };
        
        function toggleScreensaver() {
            screensaverMode = !screensaverMode;
            const msg = screensaverMode ? 'SCREENSAVER ON' : 'SCREENSAVER OFF';
            document.getElementById('cli-output').innerHTML += `\n> ${msg}`;
            if (!screensaverMode) {
                outerLines.material.color.setHex(originalColors.outer);
                innerLines.material.color.setHex(originalColors.inner);
                connectorLines.material.color.setHex(originalColors.connector);
            }
        }

        // ---------- GUITEST ----------
        function guitest() {
            const patterns = [
                '<span style="color:white;">TEST PATTERN A</span><br>████████<br>████████',
                '<span style="color:white;">TEST PATTERN B</span><br>▒▒▒▒▒▒▒▒<br>░░░░░░░░',
                '<span style="color:white;">TEST PATTERN C</span><br>▄▄▄▄▄▄▄▄<br>▀▀▀▀▀▀▀▀',
                '<span style="color:white;">TEST PATTERN D</span><br>▓▓▓▓▓▓▓▓<br>▓▓▓▓▓▓▓▓',
                '<span style="color:white;">TEST PATTERN E</span><br>▌▌▌▌▌▌▌▌<br>▐▐▐▐▐▐▐▐',
                '<span style="color:white;">TEST PATTERN F</span><br>◤◤◤◤◤◤◤◤<br>◥◥◥◥◥◥◥◥'
            ];
            faceDivs.forEach((div, i) => {
                div.innerHTML = patterns[i % patterns.length];
            });
            document.getElementById('cli-output').innerHTML += '\n> GUITEST: patterns displayed.';
        }

        // ---------- GROUNDING MODE ----------
        function groundingMode() {
            const output = document.getElementById('cli-output');
            const glRenderer = renderer.capabilities?.renderer || 'unknown';
            const glVendor = renderer.capabilities?.vendor || 'unknown';
            
            const specs = {
                'BROWSER': navigator.userAgent.substring(0, 70) + '…',
                'SCREEN': `${window.screen.width}×${window.screen.height}`,
                'VIEWPORT': `${window.innerWidth}×${window.innerHeight}`,
                'PIXEL RATIO': window.devicePixelRatio.toFixed(2),
                'WEBGL': glRenderer,
                'VENDOR': glVendor,
                'AUTO-ROTATE': controls.autoRotate ? 'ON' : 'OFF'
            };

            let report = '\n> GROUNDING MODE\n';
            for (let [k, v] of Object.entries(specs)) {
                report += `  ${k.padEnd(14)}: ${v}\n`;
            }
            output.innerHTML += report;
            output.scrollTop = output.scrollHeight;
        }

        // ---------- CLI PARSER (MSDOS style) ----------
        const cliInput = document.getElementById('cli-input');
        const cliOutput = document.getElementById('cli-output');

        function processCommand(cmd) {
            const trimmed = cmd.trim().toLowerCase();
            if (!trimmed) return;

            cliOutput.innerHTML += `> ${trimmed}\n`;

            if (trimmed === '/help' || trimmed === 'help') {
                cliOutput.innerHTML += `  AVAILABLE COMMANDS:\n`;
                cliOutput.innerHTML += `  /modify [1-6] [HTML]  — set face content\n`;
                cliOutput.innerHTML += `  /grounding            — show system info\n`;
                cliOutput.innerHTML += `  /rotate               — toggle auto-rotate\n`;
                cliOutput.innerHTML += `  /clear                — clear screen\n`;
                cliOutput.innerHTML += `  /reset-faces          — reset all faces\n`;
                cliOutput.innerHTML += `  /screensaver          — toggle animation mode\n`;
                cliOutput.innerHTML += `  /guitest              — show test patterns\n`;
                cliOutput.innerHTML += `  /exit                 — (just a joke)\n`;
                cliOutput.innerHTML += `  Double‑click any face to zoom & edit.\n`;
            }
            else if (trimmed === '/grounding' || trimmed === 'grounding') {
                groundingMode();
            }
            else if (trimmed === '/clear' || trimmed === 'cls') {
                cliOutput.innerHTML = '> screen cleared.\n';
            }
            else if (trimmed === '/rotate' || trimmed === 'rotate') {
                controls.autoRotate = !controls.autoRotate;
                cliOutput.innerHTML += `  auto-rotate: ${controls.autoRotate ? 'ON' : 'OFF'}\n`;
            }
            else if (trimmed === '/reset-faces' || trimmed === 'reset') {
                faceDivs.forEach((div, i) => {
                    div.innerHTML = `
                        <span style="color:white; font-weight:bold;">⚡ MYSTERIUM BLACKBOX [FACE ${i+1}]</span><br>
                        <span style="color:#ccc;">> tesseract terminal</span><br>
                        <span style="color:#888;">HTML ready.</span><br>
                        <span style="color:white;">$ /modify ${i+1} &lt;html&gt;</span>
                    `;
                });
                cliOutput.innerHTML += `  all faces reset.\n`;
            }
            else if (trimmed === '/screensaver' || trimmed === 'screensaver') {
                toggleScreensaver();
            }
            else if (trimmed === '/guitest' || trimmed === 'guitest') {
                guitest();
            }
            else if (trimmed === '/exit' || trimmed === 'exit') {
                cliOutput.innerHTML += `  Cannot exit. COLIGNUM is eternal.\n`;
            }
            else if (trimmed.startsWith('/modify') || trimmed.startsWith('modify')) {
                const parts = trimmed.split(' ');
                if (parts.length < 3) {
                    cliOutput.innerHTML += `  ERROR: /modify requires face number and HTML.\n`;
                } else {
                    const faceIndex = parseInt(parts[1]);
                    if (faceIndex >= 1 && faceIndex <= 6) {
                        const firstSpace = trimmed.indexOf(' ');
                        const secondSpace = trimmed.indexOf(' ', firstSpace + 1);
                        let htmlContent = '';
                        if (secondSpace === -1) {
                            htmlContent = '';
                        } else {
                            htmlContent = trimmed.slice(secondSpace + 1).trim();
                            if ((htmlContent.startsWith('"') && htmlContent.endsWith('"')) || 
                                (htmlContent.startsWith("'") && htmlContent.endsWith("'"))) {
                                htmlContent = htmlContent.slice(1, -1);
                            }
                        }
                        const targetDiv = faceDivs[faceIndex - 1];
                        if (htmlContent === '') {
                            targetDiv.innerHTML = '<span style="color:#888;">[empty]</span>';
                        } else {
                            targetDiv.innerHTML = htmlContent;
                        }
                        cliOutput.innerHTML += `  FACE ${faceIndex} updated.\n`;
                    } else {
                        cliOutput.innerHTML += `  ERROR: face must be 1–6.\n`;
                    }
                }
            }
            else {
                cliOutput.innerHTML += `  unknown command. try /help\n`;
            }

            cliOutput.scrollTop = cliOutput.scrollHeight;
        }

        cliInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                processCommand(cliInput.value);
                cliInput.value = '';
            }
        });

        // ---------- FULLSCREEN TOGGLE ----------
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                fullscreenBtn.textContent = 'EXIT';
            } else {
                document.exitFullscreen();
                fullscreenBtn.textContent = 'FULLSCREEN';
            }
        });
        document.addEventListener('fullscreenchange', () => {
            fullscreenBtn.textContent = document.fullscreenElement ? 'EXIT' : 'FULLSCREEN';
        });

        // ---------- BUTTON HANDLERS ----------
        document.getElementById('grounding-btn').addEventListener('click', groundingMode);
        document.getElementById('screensaver-btn').addEventListener('click', toggleScreensaver);

        // ---------- RESIZE ----------
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            css2DRenderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ---------- INIT ----------
        window.addEventListener('load', () => {
            groundingMode();
            cliOutput.innerHTML += '> WELCOME TO MYSTERIUM BLACKBOX (DOS EDITION).\n';
            cliOutput.innerHTML += '> Double‑click any face to zoom & edit.\n';
        });

        // ---------- ANIMATION LOOP (with screensaver effect) ----------
        function animate() {
            requestAnimationFrame(animate);

            if (screensaverMode) {
                const time = Date.now() * 0.001;
                const brightness = 0.8 + 0.2 * Math.sin(time * 2);
                outerLines.material.color.setRGB(brightness, brightness, brightness);
                innerLines.material.color.setRGB(brightness * 0.7, brightness * 0.7, brightness * 0.7);
                connectorLines.material.color.setRGB(brightness * 0.5, brightness * 0.5, brightness * 0.5);
                controls.autoRotateSpeed = 1.5;
            } else {
                controls.autoRotateSpeed = 0.8;
            }

            controls.update();
            renderer.render(scene, camera);
            css2DRenderer.render(scene, camera);
        }
        animate();

        // Ensure CSS2D container doesn't block buttons (already pointer-events: none, but child divs are auto)
    </script>
</body>
</html>
