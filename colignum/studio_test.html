<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COLIGNUM // 3D EDITOR BETA TEST</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <style>
        :root {
            --white: #ffffff;
            --black: #000000;
            --grey-1: #111;
            --grey-2: #222;
            --grey-3: #333;
            --grey-4: #444;
            --grey-5: #888;
            --bg-dark: #0a0a0a;
            --bg-panel: rgba(10, 10, 10, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border: #333;
            --border-light: #555;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--black);
            overflow: hidden;
            color: var(--white);
            height: 100vh;
        }

        #three-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* Header Bar ‚Äì more compact */
        #header-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--white);
            padding: 4px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: all;
            font-size: 12px;
        }

        .logo {
            font-size: 14px;
            font-weight: bold;
            color: var(--white);
        }

        .header-controls {
            display: flex;
            gap: 6px;
        }

        /* UI Windows ‚Äì smaller */
        .ui-window {
            position: absolute;
            background: var(--bg-panel);
            border: 1px solid var(--white);
            border-radius: 2px;
            pointer-events: all;
            min-width: 260px;
            min-height: 180px;
            backdrop-filter: blur(5px);
            overflow: hidden;
            font-size: 11px;
        }

        .title-bar {
            background: var(--grey-2);
            padding: 4px 8px;
            border-bottom: 1px solid var(--white);
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            user-select: none;
            color: var(--white);
            font-size: 11px;
        }

        .window-controls button {
            background: transparent;
            border: 1px solid var(--white);
            color: var(--white);
            width: 18px;
            height: 18px;
            margin-left: 3px;
            cursor: pointer;
            border-radius: 2px;
            font-size: 12px;
            line-height: 1;
        }

        .window-controls button:hover {
            background: var(--white);
            color: var(--black);
        }

        .window-content {
            padding: 8px;
            height: calc(100% - 30px);
            overflow-y: auto;
            color: var(--text-secondary);
        }

        /* Toolbar ‚Äì more compact */
        .toolbar {
            position: absolute;
            top: 45px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 3px;
            background: var(--bg-panel);
            border-radius: 2px;
            padding: 3px;
            border: 1px solid var(--white);
            pointer-events: all;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid var(--white);
            color: var(--white);
            width: 32px;
            height: 32px;
            cursor: pointer;
            border-radius: 2px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn.active {
            background: var(--white);
            color: var(--black);
        }

        /* Mode Switcher */
        #mode-switcher {
            position: absolute;
            top: 45px;
            right: 10px;
            z-index: 1000;
            display: flex;
            background: var(--bg-panel);
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid var(--white);
            pointer-events: all;
            font-size: 11px;
        }

        .mode-btn {
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .mode-btn.active {
            background: var(--white);
            color: var(--black);
        }

        /* Properties Panel */
        .properties-panel {
            background: var(--grey-2);
            border: 1px solid var(--white);
            border-radius: 2px;
            margin-bottom: 6px;
            overflow: hidden;
        }

        .properties-panel h3 {
            background: var(--grey-3);
            padding: 4px 8px;
            margin: 0;
            font-size: 11px;
            border-bottom: 1px solid var(--white);
            color: var(--white);
        }

        .properties-content {
            padding: 6px;
        }

        .control-group {
            margin-bottom: 8px;
        }

        .control-label {
            display: block;
            margin-bottom: 2px;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .control-input {
            width: 100%;
            background: var(--black);
            border: 1px solid var(--border-light);
            color: var(--white);
            padding: 3px 5px;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
        }

        .control-input:focus {
            outline: none;
            border-color: var(--white);
        }

        /* Buttons */
        .btn {
            background: transparent;
            border: 1px solid var(--white);
            color: var(--white);
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 2px;
            font-family: 'Share Tech Mono', monospace;
            transition: all 0.2s;
            font-size: 10px;
        }

        .btn:hover {
            background: var(--white);
            color: var(--black);
        }

        .btn-danger {
            border-color: var(--white);
            color: var(--white);
        }

        .btn-danger:hover {
            background: var(--white);
            color: var(--black);
        }

        /* Template Categories */
        .template-category {
            margin-bottom: 8px;
        }

        .category-title {
            color: var(--white);
            border-bottom: 1px solid var(--border);
            padding-bottom: 2px;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .template-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 4px;
        }

        .template-item {
            padding: 4px;
            background: var(--grey-2);
            border: 1px solid var(--white);
            cursor: pointer;
            text-align: center;
            border-radius: 2px;
            transition: all 0.2s;
            font-size: 9px;
            color: var(--text-secondary);
        }

        .template-item:hover {
            background: var(--white);
            color: var(--black);
            transform: translateY(-1px);
        }

        /* Object List */
        .object-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .object-item {
            padding: 4px;
            margin-bottom: 3px;
            background: var(--grey-2);
            border: 1px solid var(--border);
            border-radius: 2px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .object-item:hover {
            background: var(--grey-3);
        }

        .object-item.selected {
            background: var(--white);
            color: var(--black);
        }

        /* Status Bar */
        #status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-panel);
            border-top: 1px solid var(--white);
            padding: 4px 10px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            pointer-events: all;
            color: var(--text-secondary);
        }

        .status-item {
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
            background: var(--white);
        }

        /* COLIGNUM CLI */
        #colignum-cli {
            position: absolute;
            bottom: 40px;
            left: 10px;
            right: 10px;
            background: var(--bg-panel);
            border: 1px solid var(--white);
            color: var(--white);
            padding: 6px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            max-height: 150px;
            font-size: 11px;
            pointer-events: all;
        }

        #cli-output {
            overflow-y: auto;
            margin-bottom: 4px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-secondary);
            line-height: 1.3;
            max-height: 80px;
        }

        #cli-input-line {
            display: flex;
            align-items: center;
        }

        .cli-prompt {
            color: var(--white);
            margin-right: 4px;
        }

        #cli-input {
            flex: 1;
            background: var(--black);
            border: 1px solid var(--border-light);
            color: var(--white);
            padding: 4px 6px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            outline: none;
        }

        #cli-input:focus { border-color: var(--white); }

        /* Greyscale color picker */
        .grey-picker {
            display: flex;
            gap: 4px;
            margin: 4px 0;
        }
        .grey-option {
            width: 20px;
            height: 20px;
            border: 1px solid var(--white);
            cursor: pointer;
        }
        .grey-option.black { background: #000; }
        .grey-option.darkgrey { background: #333; }
        .grey-option.grey { background: #888; }
        .grey-option.lightgrey { background: #ccc; }
        .grey-option.white { background: #fff; }
        .grey-option.active { border-color: var(--white); outline: 1px solid var(--white); }

        /* Additional buttons row */
        .button-row {
            display: flex;
            gap: 4px;
            margin: 6px 0;
        }
    </style>
</head>
<body>
    <!-- Header Bar -->
    <div id="header-bar">
        <div class="logo">COLIGNUM // 3D STUDIO BETA TEST</div>
        <div class="header-controls">
            <button class="btn" id="new-project">NEW</button>
            <button class="btn" id="save-project">SAVE</button>
            <button class="btn" id="load-project">LOAD</button>
            <button class="btn" id="export-json">EXPORT</button>
            <button class="btn" id="import-json">IMPORT</button>
            <button class="btn" id="fullscreen-btn">‚õ∂</button>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <button class="tool-btn active" id="select-tool" title="Select">üîç</button>
        <button class="tool-btn" id="move-tool" title="Move">‚ÜîÔ∏è</button>
        <button class="tool-btn" id="rotate-tool" title="Rotate">üîÑ</button>
        <button class="tool-btn" id="scale-tool" title="Scale">üìè</button>
        <div style="height: 4px;"></div>
        <button class="tool-btn" id="add-cube" title="Add Cube">‚¨õ</button>
        <button class="tool-btn" id="add-sphere" title="Add Sphere">‚ö™</button>
        <button class="tool-btn" id="add-cylinder" title="Add Cylinder">üü¶</button>
        <button class="tool-btn" id="add-plane" title="Add Plane">‚¨ú</button>
        <button class="tool-btn" id="add-light" title="Add Light">üí°</button>
    </div>

    <!-- Mode Switcher -->
    <div id="mode-switcher">
        <div class="mode-btn active" id="model-mode-btn">MODEL</div>
        <div class="mode-btn" id="level-mode-btn">LEVEL</div>
        <div class="mode-btn" id="json-mode-btn">JSON</div>
    </div>

    <!-- Three.js Canvas Container -->
    <div id="three-container"></div>
    
    <!-- UI Overlay Container -->
    <div id="ui-container">
        <!-- Model Mode Windows -->
        <div class="ui-window model-mode" id="model-templates" style="top: 80px; left: 2%; width: 300px; height: 400px;">
            <div class="title-bar">
                <span>üì¶ TEMPLATES</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="template-category">
                    <div class="category-title">BASIC SHAPES</div>
                    <div class="template-list">
                        <div class="template-item" data-template="cube">Cube</div>
                        <div class="template-item" data-template="sphere">Sphere</div>
                        <div class="template-item" data-template="cylinder">Cylinder</div>
                        <div class="template-item" data-template="cone">Cone</div>
                        <div class="template-item" data-template="torus">Torus</div>
                        <div class="template-item" data-template="plane">Plane</div>
                    </div>
                </div>
                <div class="template-category">
                    <div class="category-title">EXTRA SHAPES</div>
                    <div class="template-list">
                        <div class="template-item" data-template="torusknot">Torus Knot</div>
                        <div class="template-item" data-template="icosahedron">Icosahedron</div>
                        <div class="template-item" data-template="octahedron">Octahedron</div>
                        <div class="template-item" data-template="dodecahedron">Dodecahedron</div>
                        <div class="template-item" data-template="tetrahedron">Tetrahedron</div>
                        <div class="template-item" data-template="ring">Ring</div>
                    </div>
                </div>
                <div class="template-category">
                    <div class="category-title">POINT CLOUDS</div>
                    <div class="template-list">
                        <div class="template-item" data-template="pointcube">Cube Cloud</div>
                        <div class="template-item" data-template="pointsphere">Sphere Cloud</div>
                        <div class="template-item" data-template="pointgrid">Grid Cloud</div>
                        <div class="template-item" data-template="pointrandom">Random Cloud</div>
                        <div class="template-item" data-template="pointspiral">Spiral Cloud</div>
                        <div class="template-item" data-template="pointwave">Wave Cloud</div>
                    </div>
                </div>
                <div class="template-category">
                    <div class="category-title">WIREFRAMES</div>
                    <div class="template-list">
                        <div class="template-item" data-template="wirecube">Wire Cube</div>
                        <div class="template-item" data-template="wiresphere">Wire Sphere</div>
                        <div class="template-item" data-template="wiretorus">Wire Torus</div>
                        <div class="template-item" data-template="wireknot">Wire Knot</div>
                        <div class="template-item" data-template="wireicosa">Wire Icosa</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ui-window model-mode" id="scene-hierarchy" style="top: 80px; left: 22%; width: 240px; height: 350px;">
            <div class="title-bar">
                <span>üìÅ HIERARCHY</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <ul class="object-list" id="hierarchy-list">
                    <!-- Objects will be listed here -->
                </ul>
            </div>
        </div>

        <div class="ui-window model-mode" id="model-properties" style="top: 80px; right: 2%; width: 280px; height: 450px;">
            <div class="title-bar">
                <span>‚öôÔ∏è PROPERTIES</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="properties-panel">
                    <h3>TRANSFORM</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">POSITION</label>
                            <div style="display: flex; gap: 3px;">
                                <input type="number" class="control-input" id="pos-x" placeholder="X" value="0" step="0.1">
                                <input type="number" class="control-input" id="pos-y" placeholder="Y" value="0" step="0.1">
                                <input type="number" class="control-input" id="pos-z" placeholder="Z" value="0" step="0.1">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">ROTATION</label>
                            <div style="display: flex; gap: 3px;">
                                <input type="number" class="control-input" id="rot-x" placeholder="X" value="0" step="1">
                                <input type="number" class="control-input" id="rot-y" placeholder="Y" value="0" step="1">
                                <input type="number" class="control-input" id="rot-z" placeholder="Z" value="0" step="1">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">SCALE</label>
                            <div style="display: flex; gap: 3px;">
                                <input type="number" class="control-input" id="scale-x" placeholder="X" value="1" step="0.1">
                                <input type="number" class="control-input" id="scale-y" placeholder="Y" value="1" step="0.1">
                                <input type="number" class="control-input" id="scale-z" placeholder="Z" value="1" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="properties-panel">
                    <h3>MATERIAL (GREYSCALE)</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">SHADE</label>
                            <div class="grey-picker">
                                <div class="grey-option black active" data-color="#000000"></div>
                                <div class="grey-option darkgrey" data-color="#333333"></div>
                                <div class="grey-option grey" data-color="#888888"></div>
                                <div class="grey-option lightgrey" data-color="#cccccc"></div>
                                <div class="grey-option white" data-color="#ffffff"></div>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">METALLIC</label>
                            <input type="range" id="metallic-slider" min="0" max="1" step="0.1" value="0" class="control-input">
                        </div>
                        <div class="control-group">
                            <label class="control-label">ROUGHNESS</label>
                            <input type="range" id="roughness-slider" min="0" max="1" step="0.1" value="0.5" class="control-input">
                        </div>
                        <div class="control-group">
                            <label class="control-label">WIREFRAME</label>
                            <input type="checkbox" id="wireframe-toggle" style="margin-left: 2px;">
                        </div>
                    </div>
                </div>

                <div class="properties-panel">
                    <h3>ACTIONS</h3>
                    <div class="properties-content">
                        <div class="button-row">
                            <button class="btn" style="flex:1" id="apply-properties">APPLY</button>
                            <button class="btn btn-danger" style="flex:1" id="delete-object">DELETE</button>
                        </div>
                        <div class="button-row">
                            <button class="btn" style="flex:1" id="duplicate-object">DUPLICATE</button>
                            <button class="btn" style="flex:1" id="randomize-object">RANDOMIZE</button>
                        </div>
                        <div class="button-row">
                            <button class="btn" style="flex:1" id="material-white">WHITE</button>
                            <button class="btn" style="flex:1" id="material-grey">GREY</button>
                            <button class="btn" style="flex:1" id="material-black">BLACK</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Level Mode Windows -->
        <div class="ui-window level-mode" style="display: none; top: 80px; left: 2%; width: 300px; height: 400px;">
            <div class="title-bar">
                <span>üó∫Ô∏è LEVEL EDITOR</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="properties-panel">
                    <h3>LEVEL SETTINGS</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">LEVEL NAME</label>
                            <input type="text" class="control-input" id="level-name" value="Level_1">
                        </div>
                        <div class="control-group">
                            <label class="control-label">LEVEL SIZE</label>
                            <div style="display: flex; gap: 3px;">
                                <input type="number" class="control-input" id="level-width" placeholder="Width" value="100" step="1">
                                <input type="number" class="control-input" id="level-height" placeholder="Height" value="100" step="1">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="properties-panel">
                    <h3>LEVEL OBJECTS</h3>
                    <div class="properties-content">
                        <div class="control-group">
                            <label class="control-label">SPAWN POINT</label>
                            <div style="display: flex; gap: 3px;">
                                <input type="number" class="control-input" id="spawn-x" placeholder="X" value="0" step="1">
                                <input type="number" class="control-input" id="spawn-y" placeholder="Y" value="0" step="1">
                                <input type="number" class="control-input" id="spawn-z" placeholder="Z" value="0" step="1">
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">ENEMY COUNT</label>
                            <input type="number" class="control-input" id="enemy-count" value="10" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label class="control-label">ITEMS COUNT</label>
                            <input type="number" class="control-input" id="item-count" value="5" min="0" max="50">
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 4px; margin-top: 8px;">
                    <button class="btn" style="flex: 1;" id="generate-level">GENERATE</button>
                    <button class="btn" style="flex: 1;" id="clear-level">CLEAR</button>
                </div>
            </div>
        </div>

        <!-- JSON Mode Window -->
        <div class="ui-window json-mode" style="display: none; top: 80px; left: 50%; transform: translateX(-50%); width: 500px; height: 400px;">
            <div class="title-bar">
                <span>üìÑ JSON EDITOR</span>
                <div class="window-controls">
                    <button class="btn-minimize">‚àí</button>
                    <button class="btn-close">√ó</button>
                </div>
            </div>
            <div class="window-content">
                <div class="control-group">
                    <label class="control-label">SCENE DATA</label>
                    <textarea id="json-editor" style="width:100%; height:250px; background:black; color:white; border:1px solid white; padding:6px; font-size:10px;"></textarea>
                </div>
                <div style="display: flex; gap: 4px; margin-top: 8px;">
                    <button class="btn" style="flex: 1;" id="update-from-json">UPDATE</button>
                    <button class="btn" style="flex: 1;" id="copy-json">COPY</button>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="status-bar">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span id="mode-status">MODEL MODE</span>
            </div>
            <div class="status-item">
                <span>OBJ: <span id="object-count">1</span></span>
            </div>
            <div class="status-item">
                <span>TOOL: <span id="tool-status">SELECT</span></span>
            </div>
            <div class="status-item">
                <span>FPS: <span id="fps-counter">60</span></span>
            </div>
        </div>
    </div>

    <!-- COLIGNUM CLI -->
    <div id="colignum-cli">
        <div id="cli-output">
> COLIGNUM 3D EDITOR (COMPACT) ACTIVE
> Type /help for commands
        </div>
        <div id="cli-input-line">
            <span class="cli-prompt">COLIGNUM:/$</span>
            <input type="text" id="cli-input" placeholder="command" autofocus spellcheck="false">
        </div>
    </div>

    <script>
        (function() {
            // --- Three.js Setup ---
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('three-container').appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Controls
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // TransformControls
            const transformControls = new THREE.TransformControls(camera, renderer.domElement);
            transformControls.addEventListener('dragging-changed', (event) => {
                controls.enabled = !event.value;
            });
            transformControls.addEventListener('change', () => {
                if (selectedObject) updatePropertiesPanel();
            });
            scene.add(transformControls);

            // Grid and axes
            const gridHelper = new THREE.GridHelper(20, 20, 0xffffff, 0x444444);
            scene.add(gridHelper);
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            // --- State ---
            let objects = [];
            let selectedObject = null;
            let currentMode = 'model';
            let currentTool = 'select';

            // --- Helper Functions ---
            function logToCLI(msg, level = 'info') {
                const cliOutput = document.getElementById('cli-output');
                const row = document.createElement('div');
                row.className = 'line';
                const p = document.createElement('span');
                p.className = 'cli-prompt';
                p.textContent = '>';
                const t = document.createElement('span');
                t.textContent = ' ' + msg;
                if (level === 'error') t.style.color = '#ff6666';
                if (level === 'success') t.style.color = '#7fffb1';
                row.appendChild(p);
                row.appendChild(t);
                cliOutput.appendChild(row);
                cliOutput.scrollTop = cliOutput.scrollHeight;
            }

            function updateObjectCount() {
                document.getElementById('object-count').textContent = objects.length;
            }

            function updateHierarchy() {
                const list = document.getElementById('hierarchy-list');
                list.innerHTML = '';
                objects.forEach(obj => {
                    const li = document.createElement('li');
                    li.className = `object-item ${obj === selectedObject ? 'selected' : ''}`;
                    li.textContent = obj.name;
                    li.addEventListener('click', () => selectObject(obj));
                    list.appendChild(li);
                });
            }

            function selectObject(obj) {
                selectedObject = obj;
                if (selectedObject) {
                    transformControls.attach(selectedObject);
                    updatePropertiesPanel();
                } else {
                    transformControls.detach();
                }
                updateHierarchy();
            }

            function updatePropertiesPanel() {
                if (!selectedObject) return;
                document.getElementById('pos-x').value = selectedObject.position.x.toFixed(2);
                document.getElementById('pos-y').value = selectedObject.position.y.toFixed(2);
                document.getElementById('pos-z').value = selectedObject.position.z.toFixed(2);
                document.getElementById('rot-x').value = (selectedObject.rotation.x * 180 / Math.PI).toFixed(2);
                document.getElementById('rot-y').value = (selectedObject.rotation.y * 180 / Math.PI).toFixed(2);
                document.getElementById('rot-z').value = (selectedObject.rotation.z * 180 / Math.PI).toFixed(2);
                document.getElementById('scale-x').value = selectedObject.scale.x.toFixed(2);
                document.getElementById('scale-y').value = selectedObject.scale.y.toFixed(2);
                document.getElementById('scale-z').value = selectedObject.scale.z.toFixed(2);
                if (selectedObject.material) {
                    const color = selectedObject.material.color;
                    const hex = color.getHexString();
                    if (hex === 'ffffff') setGreyActive('#ffffff');
                    else if (hex === 'cccccc') setGreyActive('#cccccc');
                    else if (hex === '888888') setGreyActive('#888888');
                    else if (hex === '333333') setGreyActive('#333333');
                    else setGreyActive('#000000');
                    document.getElementById('metallic-slider').value = selectedObject.material.metalness || 0;
                    document.getElementById('roughness-slider').value = selectedObject.material.roughness || 0.5;
                    document.getElementById('wireframe-toggle').checked = selectedObject.material.wireframe || false;
                }
            }

            function setGreyActive(color) {
                document.querySelectorAll('.grey-option').forEach(opt => opt.classList.remove('active'));
                const opt = Array.from(document.querySelectorAll('.grey-option')).find(o => o.dataset.color === color);
                if (opt) opt.classList.add('active');
            }

            function applyProperties() {
                if (!selectedObject) return;
                selectedObject.position.set(
                    parseFloat(document.getElementById('pos-x').value) || 0,
                    parseFloat(document.getElementById('pos-y').value) || 0,
                    parseFloat(document.getElementById('pos-z').value) || 0
                );
                selectedObject.rotation.set(
                    (parseFloat(document.getElementById('rot-x').value) || 0) * Math.PI / 180,
                    (parseFloat(document.getElementById('rot-y').value) || 0) * Math.PI / 180,
                    (parseFloat(document.getElementById('rot-z').value) || 0) * Math.PI / 180
                );
                selectedObject.scale.set(
                    parseFloat(document.getElementById('scale-x').value) || 1,
                    parseFloat(document.getElementById('scale-y').value) || 1,
                    parseFloat(document.getElementById('scale-z').value) || 1
                );
                if (selectedObject.material) {
                    const activeGrey = document.querySelector('.grey-option.active');
                    const color = activeGrey ? activeGrey.dataset.color : '#ffffff';
                    selectedObject.material.color.setStyle(color);
                    selectedObject.material.metalness = parseFloat(document.getElementById('metallic-slider').value) || 0;
                    selectedObject.material.roughness = parseFloat(document.getElementById('roughness-slider').value) || 0.5;
                    selectedObject.material.wireframe = document.getElementById('wireframe-toggle').checked;
                }
                transformControls.update();
                updateHierarchy();
            }

            function deleteSelected() {
                if (!selectedObject) return;
                scene.remove(selectedObject);
                objects = objects.filter(obj => obj !== selectedObject);
                selectedObject = null;
                transformControls.detach();
                updateObjectCount();
                updateHierarchy();
            }

            function duplicateSelected() {
                if (!selectedObject) return;
                let clone;
                if (selectedObject.isMesh) {
                    clone = selectedObject.clone();
                    clone.material = selectedObject.material.clone();
                } else if (selectedObject.isPoints) {
                    clone = new THREE.Points(selectedObject.geometry.clone(), selectedObject.material.clone());
                } else if (selectedObject.isLineSegments) {
                    clone = new THREE.LineSegments(selectedObject.geometry.clone(), selectedObject.material.clone());
                } else {
                    clone = selectedObject.clone();
                }
                clone.position.x += 1;
                clone.name = selectedObject.name + '_copy';
                scene.add(clone);
                objects.push(clone);
                selectObject(clone);
                updateObjectCount();
                updateHierarchy();
                logToCLI('Duplicated object', 'success');
            }

            function randomizeSelected() {
                if (!selectedObject) return;
                selectedObject.position.set(
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 10
                );
                selectedObject.rotation.set(
                    Math.random() * Math.PI * 2,
                    Math.random() * Math.PI * 2,
                    Math.random() * Math.PI * 2
                );
                selectedObject.scale.set(
                    0.5 + Math.random() * 1.5,
                    0.5 + Math.random() * 1.5,
                    0.5 + Math.random() * 1.5
                );
                transformControls.update();
                updatePropertiesPanel();
                logToCLI('Randomized object', 'success');
            }

            // --- Template generators ---
            function createCube() {
                const geo = new THREE.BoxGeometry(1,1,1);
                const mat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Cube_' + (objects.length+1);
                mesh.castShadow = mesh.receiveShadow = true;
                return mesh;
            }

            function createSphere() {
                const geo = new THREE.SphereGeometry(0.5, 32, 32);
                const mat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Sphere_' + (objects.length+1);
                mesh.castShadow = mesh.receiveShadow = true;
                return mesh;
            }

            function createCylinder() {
                const geo = new THREE.CylinderGeometry(0.5,0.5,1,32);
                const mat = new THREE.MeshStandardMaterial({ color: 0xcccccc });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Cylinder_' + (objects.length+1);
                mesh.castShadow = mesh.receiveShadow = true;
                return mesh;
            }

            function createCone() {
                const geo = new THREE.ConeGeometry(0.5,1,32);
                const mat = new THREE.MeshStandardMaterial({ color: 0x888888 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Cone_' + (objects.length+1);
                return mesh;
            }

            function createTorus() {
                const geo = new THREE.TorusGeometry(0.5,0.2,16,32);
                const mat = new THREE.MeshStandardMaterial({ color: 0xcccccc });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Torus_' + (objects.length+1);
                return mesh;
            }

            function createPlane() {
                const geo = new THREE.PlaneGeometry(2,2);
                const mat = new THREE.MeshStandardMaterial({ color: 0x888888, side: THREE.DoubleSide });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Plane_' + (objects.length+1);
                mesh.receiveShadow = true;
                return mesh;
            }

            // Extra shapes
            function createTorusKnot() {
                const geo = new THREE.TorusKnotGeometry(0.5, 0.15, 64, 8, 2, 3);
                const mat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'TorusKnot_' + (objects.length+1);
                return mesh;
            }

            function createIcosahedron() {
                const geo = new THREE.IcosahedronGeometry(0.7, 0);
                const mat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Icosa_' + (objects.length+1);
                return mesh;
            }

            function createOctahedron() {
                const geo = new THREE.OctahedronGeometry(0.7);
                const mat = new THREE.MeshStandardMaterial({ color: 0xcccccc });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Octa_' + (objects.length+1);
                return mesh;
            }

            function createDodecahedron() {
                const geo = new THREE.DodecahedronGeometry(0.7);
                const mat = new THREE.MeshStandardMaterial({ color: 0x888888 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Dodeca_' + (objects.length+1);
                return mesh;
            }

            function createTetrahedron() {
                const geo = new THREE.TetrahedronGeometry(0.7);
                const mat = new THREE.MeshStandardMaterial({ color: 0xcccccc });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Tetra_' + (objects.length+1);
                return mesh;
            }

            function createRing() {
                const geo = new THREE.TorusGeometry(0.7, 0.1, 16, 64);
                const mat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.name = 'Ring_' + (objects.length+1);
                return mesh;
            }

            // Point cloud generators
            function createPointCloud(positions) {
                const geo = new THREE.BufferGeometry();
                geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, sizeAttenuation: true });
                const points = new THREE.Points(geo, mat);
                return points;
            }

            function createPointCube() {
                const pos = [];
                const half = 2;
                for (let i = 0; i < 2000; i++) {
                    const x = (Math.random() - 0.5) * half * 2;
                    const y = (Math.random() - 0.5) * half * 2;
                    const z = (Math.random() - 0.5) * half * 2;
                    if (Math.abs(x) > half-0.2 || Math.abs(y) > half-0.2 || Math.abs(z) > half-0.2)
                        pos.push(x, y, z);
                }
                const points = createPointCloud(pos);
                points.name = 'PointCube_' + (objects.length+1);
                return points;
            }

            function createPointSphere() {
                const pos = [];
                const r = 2;
                for (let i = 0; i < 2000; i++) {
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const x = r * Math.sin(phi) * Math.cos(theta);
                    const y = r * Math.sin(phi) * Math.sin(theta);
                    const z = r * Math.cos(phi);
                    pos.push(x, y, z);
                }
                const points = createPointCloud(pos);
                points.name = 'PointSphere_' + (objects.length+1);
                return points;
            }

            function createPointGrid() {
                const pos = [];
                const step = 0.5;
                for (let x = -2; x <= 2; x += step)
                    for (let y = -2; y <= 2; y += step)
                        for (let z = -2; z <= 2; z += step)
                            pos.push(x, y, z);
                const points = createPointCloud(pos);
                points.name = 'PointGrid_' + (objects.length+1);
                return points;
            }

            function createRandomCloud() {
                const pos = [];
                for (let i = 0; i < 1000; i++) {
                    pos.push((Math.random() - 0.5) * 5, (Math.random() - 0.5) * 5, (Math.random() - 0.5) * 5);
                }
                const points = createPointCloud(pos);
                points.name = 'RandomCloud_' + (objects.length+1);
                return points;
            }

            function createSpiralCloud() {
                const pos = [];
                const turns = 3;
                for (let i = 0; i < 1000; i++) {
                    const t = (i / 1000) * turns * Math.PI * 2;
                    const r = 2;
                    const x = Math.cos(t) * r;
                    const y = Math.sin(t * 2) * 1;
                    const z = Math.sin(t) * r;
                    pos.push(x, y, z);
                }
                const points = createPointCloud(pos);
                points.name = 'SpiralCloud_' + (objects.length+1);
                return points;
            }

            function createWaveCloud() {
                const pos = [];
                for (let i = 0; i < 2000; i++) {
                    const x = (Math.random() - 0.5) * 6;
                    const z = (Math.random() - 0.5) * 6;
                    const y = Math.sin(x * 2) * Math.cos(z * 2);
                    pos.push(x, y, z);
                }
                const points = createPointCloud(pos);
                points.name = 'WaveCloud_' + (objects.length+1);
                return points;
            }

            // Wireframes
            function createWireCube() {
                const geo = new THREE.BoxGeometry(1,1,1);
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff }));
                line.name = 'WireCube_' + (objects.length+1);
                return line;
            }

            function createWireSphere() {
                const geo = new THREE.SphereGeometry(0.5, 16, 16);
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff }));
                line.name = 'WireSphere_' + (objects.length+1);
                return line;
            }

            function createWireTorus() {
                const geo = new THREE.TorusGeometry(0.5, 0.2, 16, 32);
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff }));
                line.name = 'WireTorus_' + (objects.length+1);
                return line;
            }

            function createWireKnot() {
                const geo = new THREE.TorusKnotGeometry(0.5, 0.15, 64, 8, 2, 3);
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff }));
                line.name = 'WireKnot_' + (objects.length+1);
                return line;
            }

            function createWireIcosa() {
                const geo = new THREE.IcosahedronGeometry(0.7, 0);
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff }));
                line.name = 'WireIcosa_' + (objects.length+1);
                return line;
            }

            function addTemplate(type) {
                let obj;
                switch(type) {
                    case 'cube': obj = createCube(); break;
                    case 'sphere': obj = createSphere(); break;
                    case 'cylinder': obj = createCylinder(); break;
                    case 'cone': obj = createCone(); break;
                    case 'torus': obj = createTorus(); break;
                    case 'plane': obj = createPlane(); break;
                    case 'torusknot': obj = createTorusKnot(); break;
                    case 'icosahedron': obj = createIcosahedron(); break;
                    case 'octahedron': obj = createOctahedron(); break;
                    case 'dodecahedron': obj = createDodecahedron(); break;
                    case 'tetrahedron': obj = createTetrahedron(); break;
                    case 'ring': obj = createRing(); break;
                    case 'pointcube': obj = createPointCube(); break;
                    case 'pointsphere': obj = createPointSphere(); break;
                    case 'pointgrid': obj = createPointGrid(); break;
                    case 'pointrandom': obj = createRandomCloud(); break;
                    case 'pointspiral': obj = createSpiralCloud(); break;
                    case 'pointwave': obj = createWaveCloud(); break;
                    case 'wirecube': obj = createWireCube(); break;
                    case 'wiresphere': obj = createWireSphere(); break;
                    case 'wiretorus': obj = createWireTorus(); break;
                    case 'wireknot': obj = createWireKnot(); break;
                    case 'wireicosa': obj = createWireIcosa(); break;
                    default: obj = createCube();
                }
                if (obj) {
                    scene.add(obj);
                    objects.push(obj);
                    selectObject(obj);
                    updateObjectCount();
                    updateHierarchy();
                    logToCLI(`Added ${obj.name}`, 'success');
                }
            }

            // --- UI Event Listeners ---
            document.querySelectorAll('.template-item').forEach(item => {
                item.addEventListener('click', () => {
                    addTemplate(item.dataset.template);
                });
            });

            // Tool buttons
            document.getElementById('select-tool').addEventListener('click', () => {
                currentTool = 'select';
                transformControls.setMode('translate');
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('select-tool').classList.add('active');
                document.getElementById('tool-status').textContent = 'SELECT';
            });
            document.getElementById('move-tool').addEventListener('click', () => {
                currentTool = 'move';
                transformControls.setMode('translate');
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('move-tool').classList.add('active');
                document.getElementById('tool-status').textContent = 'MOVE';
            });
            document.getElementById('rotate-tool').addEventListener('click', () => {
                currentTool = 'rotate';
                transformControls.setMode('rotate');
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('rotate-tool').classList.add('active');
                document.getElementById('tool-status').textContent = 'ROTATE';
            });
            document.getElementById('scale-tool').addEventListener('click', () => {
                currentTool = 'scale';
                transformControls.setMode('scale');
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('scale-tool').classList.add('active');
                document.getElementById('tool-status').textContent = 'SCALE';
            });

            // Add shape buttons
            document.getElementById('add-cube').addEventListener('click', () => addTemplate('cube'));
            document.getElementById('add-sphere').addEventListener('click', () => addTemplate('sphere'));
            document.getElementById('add-cylinder').addEventListener('click', () => addTemplate('cylinder'));
            document.getElementById('add-plane').addEventListener('click', () => addTemplate('plane'));
            document.getElementById('add-light').addEventListener('click', () => {
                const light = new THREE.PointLight(0xffffff, 1, 100);
                light.position.set(0, 5, 0);
                light.name = 'Light_' + (objects.length+1);
                scene.add(light);
                objects.push(light);
                selectObject(light);
                updateObjectCount();
                updateHierarchy();
            });

            // Mode switcher
            function switchMode(mode) {
                currentMode = mode;
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(mode + '-mode-btn').classList.add('active');
                document.getElementById('mode-status').textContent = mode.toUpperCase() + ' MODE';
                document.querySelectorAll('.ui-window').forEach(w => w.style.display = 'none');
                if (mode === 'model') {
                    document.getElementById('model-templates').style.display = 'block';
                    document.getElementById('scene-hierarchy').style.display = 'block';
                    document.getElementById('model-properties').style.display = 'block';
                    transformControls.enabled = true;
                } else if (mode === 'level') {
                    document.querySelector('.level-mode').style.display = 'block';
                    transformControls.enabled = false;
                } else if (mode === 'json') {
                    document.querySelector('.json-mode').style.display = 'block';
                    transformControls.enabled = false;
                    updateJSONEditor();
                }
            }
            document.getElementById('model-mode-btn').addEventListener('click', () => switchMode('model'));
            document.getElementById('level-mode-btn').addEventListener('click', () => switchMode('level'));
            document.getElementById('json-mode-btn').addEventListener('click', () => switchMode('json'));

            // Properties
            document.getElementById('apply-properties').addEventListener('click', applyProperties);
            document.getElementById('delete-object').addEventListener('click', deleteSelected);
            document.getElementById('duplicate-object').addEventListener('click', duplicateSelected);
            document.getElementById('randomize-object').addEventListener('click', randomizeSelected);
            document.getElementById('material-white').addEventListener('click', () => {
                const opt = document.querySelector('.grey-option.white');
                if (opt) opt.click();
                applyProperties();
            });
            document.getElementById('material-grey').addEventListener('click', () => {
                const opt = document.querySelector('.grey-option.grey');
                if (opt) opt.click();
                applyProperties();
            });
            document.getElementById('material-black').addEventListener('click', () => {
                const opt = document.querySelector('.grey-option.black');
                if (opt) opt.click();
                applyProperties();
            });

            // Greyscale picker
            document.querySelectorAll('.grey-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.grey-option').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                });
            });

            // JSON
            function updateJSONEditor() {
                const data = objects.map(obj => ({
                    name: obj.name,
                    type: obj.userData.type || 'unknown',
                    position: obj.position,
                    rotation: { x: obj.rotation.x, y: obj.rotation.y, z: obj.rotation.z },
                    scale: obj.scale,
                    color: obj.material ? '#' + obj.material.color.getHexString() : '#ffffff',
                    metalness: obj.material ? obj.material.metalness : 0,
                    roughness: obj.material ? obj.material.roughness : 0.5,
                    wireframe: obj.material ? obj.material.wireframe : false
                }));
                document.getElementById('json-editor').value = JSON.stringify(data, null, 2);
            }
            document.getElementById('update-from-json').addEventListener('click', () => {
                try {
                    const data = JSON.parse(document.getElementById('json-editor').value);
                    objects.forEach(obj => scene.remove(obj));
                    objects = [];
                    data.forEach(item => {
                        const geo = new THREE.BoxGeometry(1,1,1); // fallback
                        const mat = new THREE.MeshStandardMaterial({ color: item.color });
                        const mesh = new THREE.Mesh(geo, mat);
                        mesh.name = item.name;
                        mesh.position.set(item.position.x, item.position.y, item.position.z);
                        mesh.rotation.set(item.rotation.x, item.rotation.y, item.rotation.z);
                        mesh.scale.set(item.scale.x, item.scale.y, item.scale.z);
                        if (mat) {
                            mat.metalness = item.metalness;
                            mat.roughness = item.roughness;
                            mat.wireframe = item.wireframe;
                        }
                        scene.add(mesh);
                        objects.push(mesh);
                    });
                    updateObjectCount();
                    updateHierarchy();
                    logToCLI('Scene updated from JSON', 'success');
                } catch(e) {
                    logToCLI('Invalid JSON', 'error');
                }
            });
            document.getElementById('copy-json').addEventListener('click', () => {
                const ta = document.getElementById('json-editor');
                ta.select();
                document.execCommand('copy');
                logToCLI('JSON copied', 'success');
            });

            // File operations
            document.getElementById('new-project').addEventListener('click', () => {
                if (confirm('Clear scene?')) {
                    objects.forEach(obj => scene.remove(obj));
                    objects = [];
                    selectedObject = null;
                    transformControls.detach();
                    updateObjectCount();
                    updateHierarchy();
                    logToCLI('New project', 'success');
                }
            });
            document.getElementById('save-project').addEventListener('click', () => {
                updateJSONEditor();
                const blob = new Blob([document.getElementById('json-editor').value], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'colignum_scene.json';
                a.click();
            });
            document.getElementById('load-project').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = ev => {
                        document.getElementById('json-editor').value = ev.target.result;
                        document.getElementById('update-from-json').click();
                    };
                    reader.readAsText(file);
                };
                input.click();
            });
            document.getElementById('export-json').addEventListener('click', () => {
                switchMode('json');
                updateJSONEditor();
            });
            document.getElementById('import-json').addEventListener('click', () => {
                document.getElementById('load-project').click();
            });

            // Level editor
            document.getElementById('generate-level').addEventListener('click', () => {
                const w = parseFloat(document.getElementById('level-width').value) || 100;
                const h = parseFloat(document.getElementById('level-height').value) || 100;
                const ground = new THREE.Mesh(
                    new THREE.PlaneGeometry(w, h),
                    new THREE.MeshStandardMaterial({ color: 0x333333, side: THREE.DoubleSide })
                );
                ground.rotation.x = Math.PI / 2;
                ground.name = 'Ground';
                ground.receiveShadow = true;
                scene.add(ground);
                objects.push(ground);
                const enemyCount = parseInt(document.getElementById('enemy-count').value) || 10;
                const itemCount = parseInt(document.getElementById('item-count').value) || 5;
                for (let i = 0; i < enemyCount; i++) {
                    const cube = createCube();
                    cube.position.set((Math.random()-0.5)*w*0.8, 0.5, (Math.random()-0.5)*h*0.8);
                    cube.material.color.setHex(0x888888);
                    cube.name = 'Enemy_' + i;
                    scene.add(cube);
                    objects.push(cube);
                }
                for (let i = 0; i < itemCount; i++) {
                    const sphere = createSphere();
                    sphere.position.set((Math.random()-0.5)*w*0.8, 0.5, (Math.random()-0.5)*h*0.8);
                    sphere.material.color.setHex(0xcccccc);
                    sphere.name = 'Item_' + i;
                    scene.add(sphere);
                    objects.push(sphere);
                }
                const spawn = createCube();
                spawn.scale.set(0.5,0.5,0.5);
                spawn.position.set(
                    parseFloat(document.getElementById('spawn-x').value) || 0,
                    parseFloat(document.getElementById('spawn-y').value) || 0,
                    parseFloat(document.getElementById('spawn-z').value) || 0
                );
                spawn.material.color.setHex(0xffffff);
                spawn.name = 'Spawn';
                scene.add(spawn);
                objects.push(spawn);
                updateObjectCount();
                updateHierarchy();
                logToCLI('Level generated', 'success');
            });
            document.getElementById('clear-level').addEventListener('click', () => {
                objects.forEach(obj => scene.remove(obj));
                objects = [];
                selectedObject = null;
                transformControls.detach();
                updateObjectCount();
                updateHierarchy();
            });

            // Fullscreen
            document.getElementById('fullscreen-btn').addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    document.getElementById('fullscreen-btn').textContent = '‚õ∂';
                } else {
                    document.exitFullscreen();
                    document.getElementById('fullscreen-btn').textContent = '‚õ∂';
                }
            });

            // Window dragging
            function makeWindowsDraggable() {
                const windows = document.querySelectorAll('.ui-window');
                windows.forEach(win => {
                    const title = win.querySelector('.title-bar');
                    let isDown = false, offsetX, offsetY;
                    title.addEventListener('mousedown', e => {
                        isDown = true;
                        offsetX = e.clientX - win.offsetLeft;
                        offsetY = e.clientY - win.offsetTop;
                        win.style.zIndex = 1000;
                        windows.forEach(w => { if (w !== win) w.style.zIndex = 1; });
                    });
                    document.addEventListener('mousemove', e => {
                        if (!isDown) return;
                        win.style.left = (e.clientX - offsetX) + 'px';
                        win.style.top = (e.clientY - offsetY) + 'px';
                    });
                    document.addEventListener('mouseup', () => { isDown = false; });
                });
                document.querySelectorAll('.btn-close').forEach(btn => {
                    btn.addEventListener('click', e => e.target.closest('.ui-window').style.display = 'none');
                });
                document.querySelectorAll('.btn-minimize').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const win = e.target.closest('.ui-window');
                        const content = win.querySelector('.window-content');
                        content.style.display = content.style.display === 'none' ? 'block' : 'none';
                    });
                });
            }
            makeWindowsDraggable();

            // CLI
            const cliInput = document.getElementById('cli-input');
            cliInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    const cmd = cliInput.value.trim().toLowerCase();
                    logToCLI(`> ${cmd}`);
                    if (cmd === '/help') {
                        logToCLI('  Commands: /grounding, /experiment, /clear, /rotate, /reset, /duplicate, /random');
                    } else if (cmd === '/grounding') {
                        logToCLI(`Objects: ${objects.length}, Camera: (${camera.position.x.toFixed(1)},${camera.position.y.toFixed(1)},${camera.position.z.toFixed(1)})`);
                    } else if (cmd === '/experiment') {
                        addTemplate('pointrandom');
                    } else if (cmd === '/clear') {
                        document.getElementById('cli-output').innerHTML = '> CLI cleared\n';
                    } else if (cmd === '/rotate') {
                        controls.autoRotate = !controls.autoRotate;
                        logToCLI(`Auto-rotate: ${controls.autoRotate ? 'ON' : 'OFF'}`);
                    } else if (cmd === '/reset') {
                        document.getElementById('new-project').click();
                    } else if (cmd === '/duplicate') {
                        duplicateSelected();
                    } else if (cmd === '/random') {
                        randomizeSelected();
                    } else {
                        logToCLI('Unknown command', 'error');
                    }
                    cliInput.value = '';
                }
            });

            // Selection via click
            renderer.domElement.addEventListener('click', (event) => {
                if (currentMode !== 'model') return;
                const rect = renderer.domElement.getBoundingClientRect();
                const mouse = new THREE.Vector2(
                    ((event.clientX - rect.left) / rect.width) * 2 - 1,
                    -((event.clientY - rect.top) / rect.height) * 2 + 1
                );
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(objects);
                if (intersects.length) selectObject(intersects[0].object);
                else selectObject(null);
            });

            // FPS counter
            let lastTime = performance.now(), frames = 0;
            function animate() {
                requestAnimationFrame(animate);
                frames++;
                const now = performance.now();
                if (now - lastTime >= 1000) {
                    document.getElementById('fps-counter').textContent = frames;
                    frames = 0;
                    lastTime = now;
                }
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Start with a default cube
            addTemplate('cube');
            logToCLI('COLIGNUM 3D Editor (compact) ready. Type /help', 'success');
        })();
    </script>
</body>
</html>
