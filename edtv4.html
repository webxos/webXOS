<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>edTV: CHANNEL 4 // AR DOG MASK</title>
<meta name="theme-color" content="#000000">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- Three.js for AR mask rendering -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

<!-- TensorFlow.js + COCO-SSD for dog detection (objects, back-facing camera only) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
  canvas,video{display:block}
  .matrix-grid{position:absolute;inset:0;background:
    linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),
    linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);
    background-size:16px 16px;opacity:0.3;pointer-events:none}
  .crt{position:absolute;inset:0;background:
    linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);
    background-size:100% 4px;pointer-events:none;animation:stripes 8s linear infinite}
  .scanline{position:absolute;inset:0;background:
    linear-gradient(transparent 50%,rgba(255,0,255,0.03));
    background-size:100% 4px;animation:scan 6s linear infinite;pointer-events:none;opacity:0.6}
  @keyframes stripes{0%{background-position:0 0}100%{background-position:0 100%}}
  @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}

  .top-banner{position:absolute;top:0;left:0;width:100%;height:48px;background:rgba(255,0,255,0.92);
    border-bottom:4px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:100;animation:glitch 3s infinite}
  @keyframes glitch{0%,100%{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-3px,-3px)}20%,40%,60%,80%{transform:translate(6px,3px)}}
  .top-banner-text{font-size:11px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}

  #pip{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:min(92vw,720px);height:auto;aspect-ratio:16/9;border:6px solid #0ff;border-radius:16px;z-index:10;object-fit:cover;background:#000;
    box-shadow:0 0 50px #0ff, inset 0 0 60px rgba(0,255,255,0.25);}
  #mask-canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:min(92vw,720px);height:auto;aspect-ratio:16/9;z-index:15;pointer-events:none;}

  .dog-detected .top-banner{animation:glitch 0.08s infinite !important;background:#f0f !important}
  .dog-detected #pip{border-color:#f0f;box-shadow:0 0 90px #f0f,0 0 140px #f0f;animation:pulse 1.3s infinite}
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.04)}}

  .controls-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
    display:flex;gap:16px;z-index:100;flex-wrap:wrap;justify-content:center;}
  .ctrl-btn{height:68px;background:#000;border:4px solid #0ff;color:#0ff;font-size:13px;padding:0 18px;display:flex;
    align-items:center;justify-content:center;cursor:pointer;box-shadow:6px 6px 0 #000;transform:skew(-4deg);transition:all .15s;}
  .ctrl-btn:active{background:#0ff;color:#000}

  #errorLog{position:absolute;bottom:100px;left:10px;background:rgba(0,0,0,0.96);border:3px double #f00;padding:10px;font-size:7px;color:#f00;z-index:15;max-height:240px;overflow:auto;width:calc(100% - 20px);opacity:0.94;}
  .cam-status{position:absolute;top:56px;left:50%;transform:translateX(-50%);
    background:rgba(0,0,0,0.8);padding:4px 14px;border:2px solid #0ff;color:#0ff;font-size:9px;z-index:16;opacity:0;transition:opacity .4s;}
  .cam-status.show{opacity:1}

  .permission-overlay{
    position:absolute;inset:0;background:rgba(0,0,0,0.88);z-index:200;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#0ff;gap:16px;text-align:center;padding:24px
  }
  .permission-overlay .hint{font-size:10px;color:#ff0}
</style>
</head>
<body>
<div id="appContainer">
  <div class="matrix-grid"></div>
  <div class="crt"></div>
  <div class="scanline"></div>
  <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 4 // AR DOG MASK</div></div>

  <video id="pip" autoplay playsinline muted></video>
  <canvas id="mask-canvas"></canvas>

  <div class="cam-status" id="camStatus">CAMERA: REAR</div>

  <div class="controls-container">
    <button id="startSync" class="ctrl-btn">START</button>
    <button id="resetBtn" class="ctrl-btn" style="border-color:#ff0;color:#ff0">RESET</button>
  </div>

  <div id="errorLog">
    <div>INFO edTV: CHANNEL 4 // AR DOG MASK READY</div>
  </div>

  <div id="permissionOverlay" class="permission-overlay" style="display:none">
    <div style="font-size:14px;color:#0ff">Allow camera to detect dogs and render AR masks</div>
    <div class="hint">If you blocked it, change site permissions to "Allow camera" and press START again.</div>
    <button id="permissionRetry" class="ctrl-btn">RETRY</button>
  </div>
</div>

<script type="module">
  const video = document.getElementById('pip');
  const overlayCanvas = document.getElementById('mask-canvas');
  const logEl = document.getElementById('errorLog');
  const camStatus = document.getElementById('camStatus');
  const permissionOverlay = document.getElementById('permissionOverlay');
  const permissionRetryBtn = document.getElementById('permissionRetry');

  let currentStream = null;
  let scene, camera3d, renderer, dogMask, particleAura;
  let model = null; // COCO-SSD model
  let running = false;

  function log(msg, color = '#00ff00') {
    const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const line = document.createElement('div');
    line.style.color = color;
    line.innerHTML = `${time} <span style="color:#0ff">DOGSYNC</span> ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  async function startRearCamera() {
    if (!isSecureContext()) {
      log('HTTPS REQUIRED // open over https', '#ff0000');
    }
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    try {
      currentStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { exact: "environment" }, // back-facing camera only
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });
      video.srcObject = currentStream;
      await video.play();

      // Match overlay canvas to video frame
      overlayCanvas.width = video.videoWidth || 1280;
      overlayCanvas.height = video.videoHeight || 720;

      camStatus.textContent = `CAMERA: REAR`;
      camStatus.classList.add('show');
      setTimeout(() => camStatus.classList.remove('show'), 2000);
      permissionOverlay.style.display = 'none';
      log('Camera → REAR', '#00ff00');
    } catch (e) {
      log('CAMERA DENIED // enable permissions', '#ff0000');
      permissionOverlay.style.display = 'flex';
      throw e;
    }
  }

  function isSecureContext() {
    return window.isSecureContext || location.protocol === 'https:';
  }

  function initThree() {
    const w = overlayCanvas.width;
    const h = overlayCanvas.height;

    renderer = new THREE.WebGLRenderer({ canvas: overlayCanvas, alpha: true, antialias: true });
    renderer.setSize(w, h);
    renderer.setPixelRatio(window.devicePixelRatio);

    scene = new THREE.Scene();
    camera3d = new THREE.OrthographicCamera(0, w, h, 0, -1000, 1000);
    camera3d.position.z = 10;

    // Dog mask: stylized neon polygon
    const maskGroup = new THREE.Group();

    const headGeo = new THREE.IcosahedronGeometry(70, 1);
    const headMat = new THREE.MeshBasicMaterial({ color: 0xff00ff, wireframe: true, transparent: true, opacity: 0.85 });
    dogMask = new THREE.Mesh(headGeo, headMat);
    maskGroup.add(dogMask);

    // Ears
    const earGeo = new THREE.ConeGeometry(28, 60, 6);
    const earMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.9 });
    const leftEar = new THREE.Mesh(earGeo, earMat);
    const rightEar = new THREE.Mesh(earGeo, earMat);
    leftEar.rotation.z = Math.PI * -0.15;
    rightEar.rotation.z = Math.PI * 0.15;
    leftEar.position.set(-45, -75, 0);
    rightEar.position.set(45, -75, 0);
    maskGroup.add(leftEar, rightEar);

    // Particle aura
    const pGeo = new THREE.BufferGeometry();
    const count = 800;
    const pos = new Float32Array(count * 3);
    for (let i = 0; i < count; i++) {
      const angle = Math.random() * Math.PI * 2;
      const radius = 120 + Math.random() * 60;
      pos[i*3 + 0] = Math.cos(angle) * radius;
      pos[i*3 + 1] = Math.sin(angle) * radius;
      pos[i*3 + 2] = (Math.random() - 0.5) * 4;
    }
    pGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
    const pMat = new THREE.PointsMaterial({ color: 0x00ffff, size: 2.2, transparent: true, opacity: 0.6 });
    particleAura = new THREE.Points(pGeo, pMat);
    maskGroup.add(particleAura);

    // Start hidden
    maskGroup.visible = false;
    maskGroup.position.set(w/2, h/2, 0);

    scene.add(maskGroup);
    scene.userData.maskGroup = maskGroup;

    log('AR DOG MASK ONLINE', '#00ffff');
  }

  function renderMaskAtBox(box) {
    const maskGroup = scene.userData.maskGroup;
    if (!maskGroup) return;

    const w = overlayCanvas.width;
    const h = overlayCanvas.height;

    const x = box.x;
    const y = box.y;
    const width = box.width;
    const height = box.height;

    // Position mask at center of bounding box (COCO-SSD origin top-left)
    const cx = x + width / 2;
    const cy = y + height / 2;

    maskGroup.position.set(cx, cy, 0);
    // Scale mask relative to detected dog size
    const scaleBase = Math.max(width, height) / 160; // tuning constant
    maskGroup.scale.setScalar(scaleBase);

    // Animate
    dogMask.rotation.y += 0.02;
    dogMask.material.color.setHSL((Date.now() * 0.0006) % 1, 1, 0.6);
    particleAura.rotation.z += 0.01;

    maskGroup.visible = true;
    document.body.classList.add('dog-detected');
  }

  function hideMask() {
    const maskGroup = scene.userData.maskGroup;
    if (!maskGroup) return;
    maskGroup.visible = false;
    document.body.classList.remove('dog-detected');
  }

  async function loadModel() {
    try {
      model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
      log('COCO-SSD model loaded // dog detection ready', '#00ffff');
    } catch (e) {
      log('Model load failed', '#ff0000');
      throw e;
    }
  }

  async function detectLoop() {
    if (!running) return;
    if (!model || !video.videoWidth) {
      requestAnimationFrame(detectLoop);
      return;
    }

    try {
      const predictions = await model.detect(video);
      const dogs = predictions.filter(p => p.class === 'dog' && p.score > 0.55);

      if (dogs.length > 0) {
        // Pick the largest dog by area
        const best = dogs.reduce((a, b) => (a.bbox[2]*a.bbox[3] > b.bbox[2]*b.bbox[3]) ? a : b);
        const [x, y, w, h] = best.bbox;
        renderMaskAtBox({ x, y, width: w, height: h });
      } else {
        hideMask();
      }
    } catch (e) {
      log('Detection error', '#ff0000');
    }

    renderer.render(scene, camera3d);
    requestAnimationFrame(detectLoop);
  }

  async function startApp() {
    if (running) return;
    running = true;
    log('INITIATING AR DOGSYNC...');
    try {
      await startRearCamera();
      await loadModel();
      initThree();
      detectLoop();
      log('AR DOGSYNC ACTIVE // GIVE THE DOG A MASK', '#00ffff');
    } catch (e) {
      running = false;
    }
  }

  document.getElementById('startSync').onclick = startApp;
  document.getElementById('resetBtn').onclick = () => location.reload();
  permissionRetryBtn.onclick = startApp;

  // Initial hint
  log('Press START → back camera + dog detection → AR mask');
</script>
</body>
</html>
