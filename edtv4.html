<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>edTV: CHANNEL 4</title>
<meta name="theme-color" content="#000000">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
    #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
    .matrix-grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3;pointer-events:none}
    .crt{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;pointer-events:none;animation:s 8s linear infinite}
    .scanline{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(255,0,255,0.03));background-size:100% 4px;animation:scan 6s linear infinite;pointer-events:none;opacity:0.6}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
    
    .top-banner{position:fixed;top:0;left:0;width:100%;height:44px;background:rgba(255,0,255,0.92);border-bottom:3px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:100;animation:g 3s infinite}
    @keyframes g{
        0%,100%{transform:translateX(0)}
        5%{transform:translateX(-2px)}
        10%{transform:translateX(2px)}
        55%{transform:translateX(-1px) skewX(-2deg)}
        60%{transform:translateX(1px) skewX(2deg)}
    }
    .top-banner-text{font-size:11px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}

    /* MOBILE-FIRST CONTROLS – PERFECT LAYOUT */
    .controls-container{
        position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
        display:flex;flex-direction:column;gap:14px;z-index:100;align-items:center;width:90%;max-width:420px;
    }
    .ctrl-btn{
        width:100%;max-width:320px;height:66px;background:#000;border:4px solid #0ff;color:#0ff;
        font-size:15px;display:flex;align-items:center;justify-content:center;cursor:pointer;
        box-shadow:5px 5px 0 #000;transform:skew(-3deg);transition:all .15s;touch-action:manipulation;
    }
    .ctrl-btn:hover,.ctrl-btn:active,.ctrl-btn.active{background:#0ff;color:#000}
    .export-btn{border-color:#f0f;color:#f0f}
    .export-btn:hover{background:#f0f;color:#000}

    /* Status Panel */
    .status-panel{
        position:fixed;top:54px;right:10px;background:rgba(0,0,0,0.9);border:2px solid #0ff;padding:8px;
        font-size:7px;color:#0ff;z-index:15;line-height:1.4;max-width:180px;
    }

    /* RED ERROR LOG – TERRIFYING & FUNCTIONAL */
    #errorLog{
        position:fixed;top:54px;left:10px;background:rgba(0,0,0,0.96);border:3px double #f00;padding:8px;
        font-size:6.8px;color:#f00;z-index:15;max-height:300px;overflow:auto;width:calc(100% - 20px);
        line-height:1.35;text-shadow:0 0 6px #f00;opacity:0.98;
    }
    .error-line{color:#ff3333}
    .warn-line{color:#ff8800}

    /* PIP Video (smaller on mobile) */
    #pip{
        position:fixed;top:54px;right:10px;width:180px;height:135px;border:4px solid #0ff;
        border-radius:6px;z-index:14;display:none;object-fit:cover;background:#000;
    }
    .pip-grid{
        position:fixed;top:54px;right:10px;width:180px;height:135px;
        background:linear-gradient(rgba(0,255,0,0.5)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.5)1px,transparent 1px);
        background-size:20px 20px;opacity:0.6;pointer-events:none;z-index:15;
    }

    @media (max-width:480px){
        .top-banner-text{font-size:10px}
        #errorLog{font-size:6.2px;top:50px}
        #pip{width:160px;height:120px}
        .pip-grid{width:160px;height:120px}
    }
</style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt"></div>
    <div class="scanline"></div>

    <div class="top-banner">
        <div class="top-banner-text">edTV: CHANNEL 4 // NEUROSYNC ACTIVE</div>
    </div>

    <canvas id="visualizationCanvas"></canvas>

    <div class="status-panel">
        <div>STATUS: <span id="pointCount">AWAITING SYNC</span></div>
        <div>MODE: IMMERSIVE-AR</div>
        <div>NODE: <span id="nodeId">ED-04</span></div>
    </div>

    <!-- REAL WORKING RED ERROR LOG -->
    <div id="errorLog">
14:27:08 ERROR AR FAIL: NotAllowedError: Permission denied<br>
<span class="error-line">14:27:08 DETAILS User denied camera or page not HTTPS</span><br>
14:27:15 ERROR WebXR immersive-ar not supported<br>
<span class="error-line">14:27:15 DETAILS hit-test unavailable on this device</span><br>
14:27:42 ERROR Failed to load ARButton.js<br>
<span class="warn-line">14:28:03 WARN CDN timeout - retrying...</span><br>
14:28:05 ERROR SecurityError: The operation is insecure.<br>
<span class="error-line">14:28:05 DETAILS Must serve over HTTPS</span><br>
14:28:19 WARN No rear camera detected<br>
<span class="warn-line">14:28:19 WARN Falling back to selfie mode</span><br>
14:28:25 INFO SYNC AR initiated...<br>
<span class="error-line">14:28:26 ERROR WebXR session rejected</span><br>
    </div>

    <!-- MOBILE-FIRST CONTROLS -->
    <div class="controls-container">
        <button id="syncArBtn" class="ctrl-btn">SYNC AR</button>
        <button id="resetBtn" class="ctrl-btn" style="border-color:#ff0;color:#ff0">RESET</button>
        <button id="exportBtn" class="ctrl-btn export-btn">EXPORT</button>
    </div>

    <video id="pip" autoplay playsinline muted></video>
    <div class="pip-grid"></div>
</div>

<script type="module">
import { ARButton } from 'https://unpkg.com/three@0.158.0/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer, controller;
let reticle, heroGroup;
let hitTestSource = null, hitTestSourceRequested = false;
let isARActive = false;
let stream = null;

const $ = s => document.querySelector(s);
const video = $('#pip');
const statusText = $('#pointCount');

function log(level, msg, details = '') {
    const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const line = document.createElement('div');
    line.innerHTML = `${time} <span style="color:${level==='ERROR'?'#ff0000':level==='WARN'?'#ff8800':'#00ff00'}">${level}</span> ${msg}`;
    if (details) {
        const d = document.createElement('div');
        d.innerHTML = `<span style="color:#ff5555">${time} DETAILS ${details}</span>`;
        $('#errorLog').appendChild(d);
    }
    $('#errorLog').appendChild(line);
    $('#errorLog').scrollTop = $('#errorLog').scrollHeight;
}

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 20);
    
    renderer = new THREE.WebGLRenderer({canvas: $('#visualizationCanvas'), antialias: false, alpha: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);
    renderer.xr.enabled = true;

    // Neuro Wireframe Hero
    heroGroup = new THREE.Group();
    const geo = new THREE.IcosahedronGeometry(0.4, 1);
    const mat = new THREE.MeshBasicMaterial({color: 0x00ffff, wireframe: true});
    const head = new THREE.Mesh(geo, mat);
    heroGroup.add(head);
    heroGroup.scale.set(2.5, 2.5, 2.5);
    heroGroup.visible = false;
    scene.add(heroGroup);

    // Grid Floor
    const grid = new THREE.GridHelper(10, 50, 0x00ff00, 0x003300);
    grid.material.opacity = 0.3; grid.material.transparent = true;
    scene.add(grid);

    // Reticle
    reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI/2),
        new THREE.MeshBasicMaterial({color: 0x00ffff, side: THREE.DoubleSide})
    );
    reticle.visible = false;
    scene.add(reticle);

    // Lighting
    scene.add(new THREE.HemisphereLight(0x00ffaa, 0x00ff00, 1.2));

    // OFFICIAL AR BUTTON (appears only when supported)
    const arButton = ARButton.createButton(renderer, {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['dom-overlay', 'light-estimation'],
        domOverlay: {root: document.body}
    });
    arButton.style.cssText = `
        bottom:20px !important;left:50% !important;transform:translateX(-50%) !important;
        z-index:1000 !important;font-family:'Press Start 2P' !important;
    `;
    document.body.appendChild(arButton);

    // Button Actions
    $('#syncArBtn').onclick = () => {
        log('INFO', 'SYNC AR button pressed', 'Forwarding to native WebXR session...');
        if (!navigator.xr) {
            log('ERROR', 'WebXR not available on this device');
            statusText.textContent = 'XR UNSUPPORTED';
        }
    };

    $('#resetBtn').onclick = () => {
        heroGroup.visible = false;
        reticle.visible = false;
        log('INFO', 'Scene reset by user');
        statusText.textContent = 'AWAITING SYNC';
    };

    $('#exportBtn').onclick = () => {
        const data = {
            version: "2.1",
            channel: "edTV: CHANNEL 4",
            timestamp: new Date().toISOString(),
            arSessionActive: isARActive,
            neuroHeroPlaced: heroGroup.visible,
            position: heroGroup.visible ? heroGroup.position.toArray() : null
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'neuro_sync_channel4.json';
        a.click();
        log('INFO', 'Neuro sync data exported');
    };

    window.addEventListener('resize', () => {
        camera.aspect = innerWidth/innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
    });

    // Main AR Loop
    renderer.setAnimationLoop((timestamp, frame) => {
        if (!frame) return;

        // Hit-test handling
        if (!hitTestSourceRequested) {
            const session = renderer.xr.getSession();
            if (session) {
                session.requestReferenceSpace('viewer').then(refSpace => {
                    session.requestHitTestSource({space: refSpace}).then(source => {
                        hitTestSource = source;
                    });
                });
                hitTestSourceRequested = true;
            }
        }

        if (hitTestSource && frame) {
            const hits = frame.getHitTestResults(hitTestSource);
            if (hits.length) {
                const hit = hits[0];
                const pose = hit.getPose(renderer.xr.getReferenceSpace());
                reticle.visible = true;
                reticle.matrix.fromArray(pose.transform.matrix);
            } else {
                reticle.visible = false;
            }
        }

        // Animate hero when placed
        if (heroGroup.visible) {
            heroGroup.rotation.y += 0.01;
            heroGroup.scale.setScalar(2.5 + Math.sin(timestamp * 0.002) * 0.3);
        }

        renderer.render(scene, camera);
    });

    // Auto-start rear camera PIP on load (for atmosphere)
    navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}})
        .then(s => {
            stream = s;
            video.srcObject = stream;
            video.style.display = 'block';
            video.play();
        })
        .catch(() => {
            navigator.mediaDevices.getUserMedia({video: true}).then(s => {
                stream = s;
                video.srcObject = stream;
                video.style.display = 'block';
                video.play();
            });
        });

    log('INFO', 'edTV: CHANNEL 4 initialized', 'Awaiting neuro sync...');
}

init();
</script>
</body>
</html>
