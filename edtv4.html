<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>edTV: MEDICAL MASK CREATOR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale:5.0, user-scalable:yes">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  body{background:#000;color:#0ff;overflow:hidden;height:100vh}
  #app{position:relative;width:100%;height:100vh;display:flex;flex-direction:column}
  .grid{position:absolute;inset:0;background:
    linear-gradient(rgba(0,255,255,0.08)1px,transparent 1px),
    linear-gradient(90deg,rgba(0,255,255,0.08)1px,transparent 1px);
    background-size:16px 16px;z-index:-1}
  .crt{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(0,40,80,0.1)50%);
    background-size:100% 4px;pointer-events:none;animation:scanlines 8s linear infinite}
  @keyframes scanlines{0%{background-position:0 0}100%{background-position:0 100%}}
  .banner{background:rgba(0,20,50,0.95);border-bottom:2px solid #0ff;padding:10px;text-align:center;
    font-size:12px;letter-spacing:1px;text-shadow:0 0 12px #0ff}
  .content{flex:1;display:flex;flex-direction:column;padding:10px;gap:10px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
    padding:10px;background:rgba(0,30,60,0.8);border:1px solid #0ff;box-shadow:0 0 10px rgba(0,255,255,0.4)}
  .btn,.btn-medical,.btn-vr{background:#000;border:1px solid #0ff;color:#0ff;padding:8px 16px;font-size:11px;
    cursor:pointer;box-shadow:0 0 8px #0ff;transition:.2s}
  .btn-medical{border-color:#f00;color:#f00;box-shadow:0 0 8px #f00}
  .btn-vr{border-color:#0f0;color:#0f0;box-shadow:0 0 10px #0f0}
  /* FIX: remove Cyrillic character */
  .btn:hover,.btn-medical:hover,.btn-vr:hover{background:#0ff;color:#000;box-shadow:0 0 20px #0ff}
  .btn-medical:hover{background:#f00}
  .btn-vr:hover{background:#0f0}
  .dropdown{background:#000;border:1px solid #0ff;color:#0ff;padding:8px;font-size:10px;width:220px;box-shadow:0 0 8px rgba(0,255,255,0.5)}
  .terminal{flex:1;background:rgba(0,20,40,0.8);border:1px solid #0ff;padding:10px;font-size:10px;
    overflow-y:auto;max-height:28vh;box-shadow:0 0 10px rgba(0,255,255,0.3);user-select:text}
  .ar-view{flex:3;position:relative;border:2px solid #0ff;background:#000;overflow:hidden;box-shadow:0 0 20px rgba(0,255,255,0.6)}
  #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);will-change:transform}
  #view3d{position:absolute;inset:0;width:100%;height:100%;z-index:10}
  .medical-indicators{position:absolute;top:10px;left:10px;display:flex;gap:10px;z-index:20;flex-wrap:wrap}
  .indicator{background:rgba(255,0,0,0.7);border:1px solid #f00;color:#fff;padding:5px 10px;
    font-size:9px;box-shadow:0 0 8px #f00;transition:all .4s}
  .indicator.locked{background:rgba(0,255,0,0.8);border-color:#0f0;box-shadow:0 0 15px #0f0}
  .indicator.vr{background:rgba(0,100,255,0.8);border-color:#0ff}
</style>
</head>
<body>
<div id="app">
  <div class="grid"></div><div class="crt"></div>
  <div class="banner" role="heading" aria-level="1">edTV: medical mask creator</div>
  <div class="content">
    <div class="controls" role="group" aria-label="Controls">
      <button class="btn-medical" id="start" aria-label="Start camera and sync">START & SYNC</button>
      <button class="btn-vr" id="enter-vr" aria-label="Enter immersive AR mode">ENTER VR/AR MODE</button>
      <button class="btn-medical" id="export" aria-label="Export 3D JSON">EXPORT 3D JSON</button>
      <select class="dropdown" id="mask-select" aria-label="Select mask type">
        <option value="surgical">SURGICAL MASK</option>
        <option value="n95">N95 RESPIRATOR</option>
        <option value="full_face">FULL FACE SHIELD</option>
        <option value="goggle_mask">GOGGLE + MASK</option>
        <option value="tactical">TACTICAL RESPIRATOR</option>
      </select>
      <select class="dropdown" id="addon-select" aria-label="Select addon">
        <option value="none">NO ADDON</option>
        <option value="comms">COMMS HEADSET</option>
        <option value="filter">FILTER CARTRIDGE</option>
        <option value="visor">VISOR</option>
        <option value="sensor">VITAL SENSORS</option>
      </select>
    </div>
    <div class="terminal" id="log" role="log" aria-live="polite">> MEDICAL AR SYSTEM<br>> 2025 PROTOCOL ACTIVE</div>
    <div class="ar-view" aria-label="AR view">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="view3d"></canvas>
      <div class="medical-indicators" aria-label="Status indicators">
        <div class="indicator" id="track">TRACKING: OFF</div>
        <div class="indicator" id="mask">MASK: NONE</div>
        <div class="indicator" id="addon">ADDON: NONE</div>
        <div class="indicator vr" id="vr">VR: OFFLINE</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
import {FaceLandmarker, FilesetResolver} from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs';

const video = document.getElementById('video');
const canvas = document.getElementById('view3d');
const logEl = document.getElementById('log');
const trackEl = document.getElementById('track');
const maskEl = document.getElementById('mask');
const addonEl = document.getElementById('addon');
const vrEl = document.getElementById('vr');

let faceLandmarker = null;
let running = false;
let scene, camera, renderer, maskGroup, currentMask = null, currentAddon = null;

const maskMat = new THREE.MeshPhongMaterial({
  color: 0x00ffff, transparent: true, opacity: 0.78, shininess: 80, specular: 0x44ffff
});

/* Safe logger to avoid XSS and keep line breaks */
function log(m) {
  const line = document.createElement('div');
  line.textContent = `> ${m}`;
  logEl.appendChild(line);
  logEl.scrollTop = logEl.scrollHeight;
}

function init3D() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
  camera.position.z = 0.8;

  renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: false });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  renderer.xr.enabled = true;

  scene.add(new THREE.HemisphereLight(0xffffff, 0x0088ff, 2.2));
  scene.add(new THREE.AmbientLight(0x00ffff, 0.8));

  maskGroup = new THREE.Group();
  scene.add(maskGroup);

  window.addEventListener('resize', () => {
    camera.aspect = canvas.clientWidth / canvas.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  });

  log('3D MEDICAL RENDER CORE ONLINE');
}

/* Minimal procedural mask/addon to prevent runtime errors */
function clearGroup(g) { while (g.children.length) g.remove(g.children[0]); }

function createMask(type) {
  clearGroup(maskGroup);
  const baseGeom = new THREE.BoxGeometry(0.18, 0.12, 0.08);
  const geomMap = {
    surgical: new THREE.BoxGeometry(0.20, 0.12, 0.06),
    n95: new THREE.BoxGeometry(0.18, 0.12, 0.10),
    full_face: new THREE.CylinderGeometry(0.12, 0.12, 0.24, 24),
    goggle_mask: new THREE.BoxGeometry(0.22, 0.14, 0.10),
    tactical: new THREE.BoxGeometry(0.22, 0.13, 0.12)
  };
  const geom = geomMap[type] || baseGeom;
  const mesh = new THREE.Mesh(geom, maskMat);
  mesh.position.set(0, 0, 0);
  maskGroup.add(mesh);
  currentMask = mesh;
  maskEl.textContent = `MASK: ${type.toUpperCase().replace('_',' ')}`;
  log(`MASK APPLIED: ${type}`);
}

function createAddon(type) {
  const addonGroup = new THREE.Group();
  let addonMesh = null;
  switch (type) {
    case 'comms': addonMesh = new THREE.TorusGeometry(0.06, 0.02, 12, 24); break;
    case 'filter': addonMesh = new THREE.CylinderGeometry(0.04, 0.04, 0.05, 16); break;
    case 'visor': addonMesh = new THREE.PlaneGeometry(0.26, 0.16); break;
    case 'sensor': addonMesh = new THREE.SphereGeometry(0.03, 16, 16); break;
    default: addonEl.textContent = 'ADDON: NONE'; currentAddon = null; log('ADDON REMOVED'); return;
  }
  clearGroup(addonGroup);
  const mat = new THREE.MeshPhongMaterial({ color: 0x00aaff, transparent: true, opacity: 0.5, shininess: 60, specular: 0x2288ff });
  const mesh = new THREE.Mesh(addonMesh, mat);
  mesh.position.set(0.1, 0.02, 0.06);
  addonGroup.add(mesh);
  maskGroup.add(addonGroup);
  currentAddon = addonGroup;
  addonEl.textContent = `ADDON: ${type.toUpperCase()}`;
  log(`ADDON APPLIED: ${type}`);
}

/* Head pose mapping with clamped scaling */
function updateHeadPose(rawLandmarks) {
  const landmarks = rawLandmarks.map(l => ({x: 1 - l.x, y: l.y, z: l.z}));
  const nose = landmarks[1], chin = landmarks[152];
  const leftEye = landmarks[33], rightEye = landmarks[263];
  const leftTemple = landmarks[234], rightTemple = landmarks[454];

  const centerX = (leftTemple.x + rightTemple.x) / 2;
  const centerY = (nose.y + chin.y) / 2;
  const faceWidth = Math.abs(rightTemple.x - leftTemple.x);
  const t = Math.min(Math.max(faceWidth * 9.5, 0), 1); // clamp 0..1
  const scale = THREE.MathUtils.lerp(1.0, 2.0, t);

  maskGroup.position.x = (centerX - 0.5) * 2.2;
  maskGroup.position.y = -(centerY - 0.5) * 2.2;
  maskGroup.scale.set(scale, scale, scale);

  const yaw = (rightEye.x - leftEye.x) * 3.2;
  maskGroup.rotation.y = -yaw;

  const eyeMidY = (leftEye.y + rightEye.y) / 2;
  const pitch = (eyeMidY - nose.y) * 38;
  maskGroup.rotation.x = pitch;

  const dx = rightEye.x - leftEye.x;
  const dy = rightEye.y - leftEye.y;
  maskGroup.rotation.z = -Math.atan2(dy, dx);
}

/* Unified animation loop: render + throttled detection */
let lastDetect = 0;
function animate(time = 0) {
  // Normalize time to seconds for sin
  const seconds = time * 0.001;

  if (currentMask) {
    currentMask.rotation.z += 0.003;
    maskMat.opacity = 0.7 + Math.sin(seconds * 0.8) * 0.15;
  }

  // Throttle detection to ~30Hz
  if (running && faceLandmarker && (time - lastDetect) > 33) {
    lastDetect = time;
    const results = faceLandmarker.detectForVideo(video, time);
    if (results?.faceLandmarks?.[0]) {
      updateHeadPose(results.faceLandmarks[0]);
      trackEl.textContent = 'TRACKING: LOCKED';
      trackEl.classList.add('locked');
    } else {
      trackEl.textContent = 'TRACKING: SEARCHING';
      trackEl.classList.remove('locked');
    }
  }

  renderer.render(scene, camera);
  // When not in XR, fall back to RAF to drive loop
  if (!renderer.xr.isPresenting) requestAnimationFrame(animate);
}

/* Start AR: autoplay and permission handling */
async function startAR() {
  if (running) return;
  log('DEPLOYING MEDICAL AR SYSTEM...');
  try {
    const vision = await FilesetResolver.forVisionTasks(
      'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm'
    );
    faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
      baseOptions: {
        modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
        delegate: 'GPU'
      },
      outputFaceBlendshapes: false,
      runningMode: 'VIDEO',
      numFaces: 1
    });

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    video.srcObject = stream;

    try {
      await video.play();
    } catch (err) {
      log('Autoplay blocked. Tap "START CAMERA & SYNC" again to begin.');
    }

    running = true;
    log('MEDICAL AR ACTIVE // FACE LOCK INIT');
    // Kick off loop
    if (!renderer.xr.isPresenting) requestAnimationFrame(animate);
  } catch (e) {
    log('ERROR: ' + (e && e.message ? e.message : String(e)));
    running = false;
  }
}

/* Enter XR with capability checks and domOverlay fallback */
async function enterXR() {
  if (!navigator.xr) return log('WebXR NOT AVAILABLE');
  try {
    const supported = await navigator.xr.isSessionSupported('immersive-ar');
    if (!supported) return log('IMMERSIVE AR NOT SUPPORTED ON THIS DEVICE');

    const init = {
      requiredFeatures: ['local-floor'],
      optionalFeatures: ['dom-overlay'],
      domOverlay: { root: document.documentElement }
    };

    // Some browsers throw with domOverlay; provide safe fallback
    let session;
    try {
      session = await navigator.xr.requestSession('immersive-ar', init);
    } catch {
      const fallback = { requiredFeatures: ['local-floor'] };
      session = await navigator.xr.requestSession('immersive-ar', fallback);
    }

    await renderer.xr.setSession(session);
    renderer.setAnimationLoop(animate); // XR drives the loop
    vrEl.textContent = 'VR: IMMERSIVE-AR';
    vrEl.style.background = 'rgba(0,255,0,0.8)';
    log('IMMERSIVE AR MODE ACTIVE');

    session.addEventListener('end', () => {
      vrEl.textContent = 'VR: OFFLINE';
      vrEl.style.background = 'rgba(255,0,0,0.7)';
      log('XR SESSION TERMINATED');
      // Resume non-XR loop
      requestAnimationFrame(animate);
    });
  } catch (e) {
    log('XR FAILED: ' + (e && e.message ? e.message : String(e)));
  }
}

/* Simple JSON export of current mask/addon transform */
function exportJSON() {
  const payload = {
    mask: maskEl.textContent.replace('MASK: ', ''),
    addon: addonEl.textContent.replace('ADDON: ', ''),
    transform: {
      position: maskGroup.position.toArray(),
      rotation: [maskGroup.rotation.x, maskGroup.rotation.y, maskGroup.rotation.z],
      scale: maskGroup.scale.toArray()
    },
    timestamp: Date.now()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'edtv9_fit.json';
  a.click();
  URL.revokeObjectURL(url);
  log('EXPORTED 3D JSON');
}

/* Event listeners */
document.getElementById('start').onclick = startAR;
document.getElementById('enter-vr').onclick = enterXR;
document.getElementById('mask-select').onchange = e => createMask(e.target.value);
document.getElementById('addon-select').onchange = e => createAddon(e.target.value);
document.getElementById('export').onclick = exportJSON;

/* Init */
init3D();
createMask('surgical');
createAddon('none');
log('CHANNEL 9 READY â€“ START CAMERA TO FIT MASK');
requestAnimationFrame(animate);
</script>
</body>
</html>
