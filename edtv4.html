<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>edTV: CHANNEL 4</title>
<meta name="theme-color" content="#000000">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none}
    #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
    .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3;pointer-events:none}
    .crt{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;pointer-events:none;animation:s 8s linear infinite}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    .top-banner{position:absolute;top:0;left:50%;transform:translateX(-50%);width:auto;padding:5px 20px;background:rgba(255,0,255,0.9);border:2px solid #f0f;border-radius:0 0 10px 10px;display:flex;align-items:center;justify-content:center;z-index:12;animation:g 3s infinite}
    @keyframes g{0%,100%{transform:translateX(-50%)}5%{transform:translateX(calc(-50% - 2px))}10%{transform:translateX(calc(-50% + 2px))}15%{transform:translateX(calc(-50% - 1px))}20%{transform:translateX(calc(-50% + 1px))}25%{transform:translateX(-50%)}55%{transform:translateX(calc(-50% - 1px)) skewX(-2deg)}60%{transform:translateX(calc(-50% + 1px)) skewX(2deg)}}
    .top-banner-text{font-size:10px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
    .ctrl-btn{width:120px;height:52px;background:#000;border:3px solid #0ff;color:#0ff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transform:skew(-2deg);transition:all .1s;margin:10px}
    .ctrl-btn:hover,.ctrl-btn:active,.ctrl-btn.active{background:#0ff;color:#000}
    .export-btn{border-color:#f0f;color:#f0f}
    .export-btn:hover{background:#f0f;color:#000}
    .controls-container{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:11;flex-wrap:wrap;justify-content:center}
    #pip{position:fixed;top:20px;right:20px;width:240px;height:180px;border:4px solid #0ff;border-radius:8px;z-index:10;cursor:pointer;display:none}
    .pip-grid{position:fixed;top:20px;right:20px;width:240px;height:180px;background:linear-gradient(rgba(0,255,0,0.5)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.5)1px,transparent 1px);background-size:20px 20px;opacity:0.6;pointer-events:none;z-index:11}
    .status-panel{position:absolute;top:50px;right:10px;background:rgba(0,0,0,0.8);border:2px solid #0ff;padding:8px;font-size:8px;color:#0ff;z-index:11;line-height:1.4}
    #errorLog{position:absolute;top:40px;left:10px;background:rgba(0,0,0,0.9);border:3px double #f00;padding:8px;font-size:7px;color:#f00;max-height:240px;overflow:auto;z-index:11;width:280px;line-height:1.3;opacity:0.95;text-shadow:0 0 5px #f00}
    .error-line{color:#ff3333}
    .warn-line{color:#ff8800}
    @media (max-width:767px){.controls-container{bottom:100px;} #errorLog{top:80px;font-size:6px;width:260px}}
    .scanline{pointer-events:none;position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(transparent 50%, rgba(255,0,255,0.03) 50%);background-size:100% 4px;animation:scan 7s linear infinite;opacity:0.5}
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
</style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt"></div>
    <div class="scanline"></div>
    <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 4 // NEUROSYNC ACTIVE</div></div>
    <canvas id="visualizationCanvas"></canvas>
    
    <div class="status-panel">
        <div>STATUS: <span id="pointCount">AWAITING SYNC</span></div>
        <div>MODE: IMMERSIVE-AR</div>
        <div>NODE: <span id="nodeId">ED-04</span></div>
    </div>

    <div class="controls-container">
        <button id="syncArBtn" class="ctrl-btn" style="border-color:#0ff;color:#0ff;background:#000">
            SYNC AR
        </button>
        <button id="resetBtn" class="ctrl-btn" style="border-color:#ff0;color:#ff0">RESET</button>
        <button id="exportBtn" class="ctrl-btn export-btn">EXPORT</button>
    </div>

    <video id="pip" autoplay playsinline muted></video>
    <div class="pip-grid"></div>

    <!-- SCARY RED ERROR LOG (pre-filled for demo + real errors append) -->
    <div id="errorLog">
14:27:08 ERROR AR FAIL: NotAllowedError: Permission denied<br>
<span class="error-line">14:27:08 DETAILS User denied camera permission or page not HTTPS/localhost</span><br>
14:27:15 ERROR AR FAIL: NotSupportedError: hit-test unavailable<br>
<span class="error-line">14:27:15 DETAILS Required feature 'hit-test' not supported on this device</span><br>
14:27:42 ERROR Failed to load ARButton.js module<br>
<span class="warn-line">14:28:03 WARN CDN timeout - retrying mirror...</span><br>
14:28:05 ERROR SecurityError: The operation is insecure.<br>
<span class="error-line">14:28:05 DETAILS Must serve over HTTPS for immersive-ar</span><br>
14:28:19 WARN getUserMedia failed - no environment camera<br>
<span class="warn-line">14:28:19 WARN Falling back to front camera (selfie mode)</span><br>
14:28:25 INFO SYNC AR clicked - attempting session...<br>
<span class="error-line">14:28:26 ERROR WebXR unavailable in this browser</span><br>
    </div>
</div>

<script type="module">
import { ARButton } from 'https://unpkg.com/three@0.158.0/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer, controller;
let reticle, heroGroup;
let hitTestSource = null;
let hitTestSourceRequested = false;
let isARActive = false;

const $ = s => document.querySelector(s);
const video = $('#pip');
const errorLog = $('#errorLog');
const statusText = $('#pointCount');

function log(level, msg, details = '') {
    const time = new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
    const line = document.createElement('div');
    line.innerHTML = `${time} <span style="color:${level==='ERROR'?'#ff0000':level==='WARN'?'#ff8800':'#00ff00'}">${level}</span> ${msg}`;
    if (details) {
        const det = document.createElement('div');
        det.innerHTML = `<span style="color:#ff5555">${time} DETAILS ${details}</span>`;
        errorLog.appendChild(det);
    }
    errorLog.appendChild(line);
    errorLog.scrollTop = errorLog.scrollHeight;
}

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 20);
    renderer = new THREE.WebGLRenderer({canvas: $('#visualizationCanvas'), antialias: false, alpha: true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);
    renderer.xr.enabled = true;

    // Neuro wireframe hero
    heroGroup = new THREE.Group();
    const geometry = new THREE.IcosahedronGeometry(0.4, 1);
    const material = new THREE.MeshBasicMaterial({color: 0x00ffff, wireframe: true, wireframeLinewidth: 2});
    const hero = new THREE.Mesh(geometry, material);
    heroGroup.add(hero);
    heroGroup.scale.set(2,2,2);
    heroGroup.visible = false;
    scene.add(heroGroup);

    // Grid floor
    const grid = new THREE.GridHelper(10, 40, 0x00ff00, 0x003300);
    grid.material.opacity = 0.3; grid.material.transparent = true;
    scene.add(grid);

    // Reticle
    reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI/2),
        new THREE.MeshBasicMaterial({color: 0x00ffff})
    );
    reticle.visible = false;
    scene.add(reticle);

    // Light
    scene.add(new THREE.HemisphereLight(0x00ff00, 0x00ffff, 1));

    // Add AR button properly
    const arButton = ARButton.createButton(renderer, {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['dom-overlay', 'light-estimation'],
        domOverlay: {root: document.body}
    });
    arButton.style.bottom = '20px';
    arButton.style.left = '50%';
    arButton.style.transform = 'translateX(-50%)';
    arButton.style.zIndex = '100';
    document.body.appendChild(arButton);

    window.addEventListener('resize', onWindowResize);
}

function onWindowResize() {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
}

// SYNC AR BUTTON (now uses official ARButton + fallback)
$('#syncArBtn').onclick = () => {
    log('INFO', 'SYNC AR clicked - attempting AR session...');
    if (!navigator.xr) {
        log('ERROR', 'WebXR not supported on this device/browser');
        statusText.textContent = 'XR UNSUPPORTED';
        return;
    }
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        log('ERROR', 'SecurityError: Must use HTTPS for AR (except localhost)');
    }
};

// Reset
$('#resetBtn').onclick = () => {
    heroGroup.visible = false;
    reticle.visible = false;
    log('INFO', 'Scene reset by user');
};

// Export
$('#exportBtn').onclick = () => {
    const data = {
        version: "2.0",
        channel: "edTV: CHANNEL 4",
        timestamp: new Date().toISOString(),
        synced: isARActive,
        heroPosition: heroGroup.visible ? heroGroup.position.toArray() : null
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'edtv_channel4_sync.json'; a.click();
    log('INFO', 'Export triggered - neuro_hero_sync.json');
};

init();
</script>
</body>
</html>
