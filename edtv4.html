<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>edTV: CHANNEL 4</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="data:application/manifest+json,{
        \"name\": \"3D Data Capture\",
        \"short_name\": \"3D Capture\",
        \"description\": \"3D geometry data capture and export\",
        \"start_url\": \"./\",
        \"display\": \"fullscreen\",
        \"background_color\": \"#000000\",
        \"theme_color\": \"#000000\",
        \"icons\": [
            {
                \"src\": \"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMDAwMDAwIi8+CjxwYXRoIGQ9Ik05NiAxMjhMMTI4IDk2SDY0TDEyOCA2NEw5NiAzMkw2NCA2NEgxMjhMNjQgOTZIMTI4TDk2IDEyOFoiIGZpbGw9IiMwMGZmMDAiLz4KPC9zdmc+Cg==\",
                \"sizes\": \"192x192\",
                \"type\": \"image/svg+xml\"
            }
        ]
    }">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/WebGL.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/renderers/CSS3DRenderer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/effects/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/effects/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/effects/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
    <script src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
        body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
        #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
        .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3}
        .crt-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;z-index:5;pointer-events:none;animation:scanline 8s linear infinite}
        @keyframes scanline{0%{background-position:0 0}100%{background-position:0 100%}}
        #visualizationContainer{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2}
        #ideInterface{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10}
        .top-banner{position:absolute;top:0;left:0;width:100%;height:40px;background:rgba(255,0,255,0.9);border-bottom:2px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:12;overflow:hidden;animation:glitch 3s infinite}
        @keyframes glitch{0%,100%{transform:translateX(0)}5%{transform:translateX(-2px)}10%{transform:translateX(2px)}15%{transform:translateX(-1px)}20%{transform:translateX(1px)}25%{transform:translateX(0)}50%{transform:translateX(0)}55%{transform:translateX(-1px) skewX(-2deg)}60%{transform:translateX(1px) skewX(2deg)}65%{transform:translateX(-1px) skewX(-1deg)}70%{transform:translateX(1px) skewX(1deg)}75%{transform:translateX(0)}}
        .top-banner-text{font-size:12px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
        .ctrl-btn{width:120px;height:52px;background:#000;border:3px solid #0ff;color:#0ff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transform:skew(-2deg);transition:background 0.1s,color 0.1s;touch-action:none;margin:10px}
        .ctrl-btn:hover,.ctrl-btn:active{background:#0ff;color:#000}
        .ctrl-btn.active{background:#0ff;color:#000}
        .export-btn{border-color:#f0f;color:#f0f}
        .export-btn:hover,.export-btn:active{background:#f0f;color:#000}
        .export-btn.active{background:#f0f;color:#000}
        .controls-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:11;flex-wrap:wrap;justify-content:center}
        #pip{position:fixed;top:20px;right:20px;width:240px;border:4px solid #fff;border-radius:12px;cursor:pointer;z-index:10;transition:all 0.4s}
        #pip.fullscreen{top:0;left:0;width:100%;height:100%;border:none;border-radius:0}
        .mirror-popup{display:block;position:fixed;top:0;right:0;width:240px;height:180px;background:rgba(0,10,0,0.95);border:3px solid #0ff;padding:8px;z-index:100;box-shadow:6px 6px 0 #000,inset 2px 2px 0 #0ff;resize:both;overflow:hidden;font-size:8px;color:#0ff;border-radius:4px}
        .mirror-header{display:flex;justify-content:space-between;align-items:center;padding:4px 8px;background:rgba(0,255,255,0.2);border-bottom:2px solid #0ff;margin-bottom:8px;cursor:move;user-select:none}
        .mirror-title{font-size:10px;color:#0ff;text-shadow:1px 1px 0 #000}
        .mirror-close{width:24px;height:24px;background:#000;border:2px solid #f00;color:#f00;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;touch-action:none}
        .mirror-close:hover,.mirror-close:active{background:#f00;color:#000}
        .mirror-content{width:100%;height:calc(100% - 40px);position:relative}
        .webcam-mesh-container{width:100%;height:100%;background:#000;border:2px solid #0f0;position:relative;overflow:hidden}
        .webcam-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:20px 20px;z-index:1}
        .face-direction-arrow{position:absolute;top:50%;left:50%;width:40px;height:40px;transform-origin:center;z-index:3;transition:transform 0.1s ease}
        .face-direction-arrow::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:20px solid #f00}
        .face-direction-arrow::after{content:'';position:absolute;top:20px;left:50%;transform:translateX(-50%);width:4px;height:20px;background:#f00}
        .user-position-marker{position:absolute;width:12px;height:12px;background:#0ff;border-radius:50%;z-index:2;box-shadow:0 0 10px #0ff}
        #calibStatus{font-size:6px;color:#ff0;margin:4px 0;text-align:center}
        .radar-container{position:relative;width:100%;height:100px;display:none}
        #hudWarning{position:absolute;top:20%;left:50%;transform:translate(-50%,-50%);color:#f00;font-size:12px;text-shadow:1px 1px 0 #000;z-index:11;display:none}
        @media (max-width:767px){.mirror-popup{width:200px;height:150px}.controls-container{flex-direction:column;align-items:center;}.ctrl-btn{width:140px;height:56px;font-size:12px}}
        #webcamCanvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:2}
        #sceneClickArea{position:absolute;top:0;left:0;width:100%;height:calc(100% - 80px);z-index:3;cursor:pointer}
        .status-panel{position:absolute;top:50px;right:10px;background:rgba(0,0,0,0.8);border:2px solid #0ff;padding:8px;font-size:8px;color:#0ff;max-width:200px;z-index:11}
        #errorLog{position:absolute;top:40px;left:10px;background:rgba(0,0,0,0.8);border:2px solid #f00;padding:8px;font-size:8px;color:#f00;max-height:200px;overflow:auto;z-index:11;width:200px}
    </style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt-overlay"></div>
    <div class="top-banner">
        <div class="top-banner-text">edTV: CHANNEL 4</div>
    </div>
    <div id="visualizationContainer">
        <canvas id="visualizationCanvas"></canvas>
        <div id="sceneClickArea" title="Click to center view"></div>
    </div>
    <div class="status-panel">
        <div>OBJECTS: <span id="objectCount">0</span></div>
        <div>FACES: <span id="faceCount">0</span></div>
        <div>DATA POINTS: <span id="dataPointCount">0</span></div>
    </div>
    <div id="ideInterface">
        <div class="controls-container">
            <button id="mirrorBtn" class="ctrl-btn">CALIBRATE</button>
            <button id="exportBtn" class="ctrl-btn export-btn">EXPORT</button>
            <button id="resetBtn" class="ctrl-btn" style="border-color:#ff0;color:#ff0">RESET</button>
            <button id="arBtn" class="ctrl-btn" style="border-color:#0f0;color:#0f0">AR MODE</button>
        </div>
        <div id="hudWarning">NO DATA CAPTURED</div>
    </div>
    <div class="mirror-popup" id="mirrorPopup">
        <div class="mirror-header">
            <div class="mirror-title">3D DATA CAPTURE</div>
            <div class="mirror-close" aria-label="Close Mirror">X</div>
        </div>
        <div class="mirror-content">
            <div class="webcam-mesh-container" id="webcamMeshContainer">
                <canvas id="webcamCanvas"></canvas>
                <div class="webcam-grid"></div>
                <div class="face-direction-arrow" id="faceDirectionArrow"></div>
                <div class="user-position-marker" id="userPositionMarker" style="top:50%;left:50%;"></div>
            </div>
            <div id="calibStatus">CALIBRATING...</div>
        </div>
    </div>
    <div id="errorLog"></div>
</div>
<video id="pip" autoplay playsinline muted style="display:none"></video>
<script>
    let scene, cam, ren, clock, composer, thermalPass;
    let userObj, objects = [], lightPoints = [];
    let faceDirection = 0, userDetected = false;
    let stream, faceMesh, camera, objectDetector;
    let isFrontCam = true;
    const user = new THREE.Vector3(0, 0, 0);
    let animationId = null; let pipVideo; let face3DLines;
    let mirrorDragging = false;
    let mirrorOffset = { x: 0, y: 0 };
    let cameraDistance = 5;
    let mask, lightSource;
    let xrSession;
    const geometryDataSchema = { version: "1.0", timestamp: "", metadata: { app: "edTV_CHANNEL_4", captureType: "face_objects_3d_thermal", coordinateSystem: "right_handed" }, faceGeometry: { vertices: [], normals: [], faces: [], landmarks: [] }, environmentObjects: [], camera: { position: { x: 0, y: 0, z: 0 }, rotation: { x: 0, y: 0, z: 0 }, fov: 75 } };
    const $ = s => document.querySelector(s);
    function logError(msg) {
        const log = $('#errorLog');
        log.innerHTML += `${new Date().toISOString().slice(11,19)}: ${msg}<br>`;
        log.scrollTop = log.scrollHeight;
    }
    function init() {
        try {
            init3D();
            setupFaceDetection();
            setupObjectDetection();
            setupEventListeners();
            autoStartMirror();
            animate();
        } catch (e) { logError(e.message); }
    }
    function init3D() {
        scene = new THREE.Scene(); scene.background = new THREE.Color(0x000000);
        cam = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
        cam.position.set(0, 0, cameraDistance);
        const canvas = $('#visualizationCanvas');
        ren = new THREE.WebGLRenderer({canvas, antialias: false, powerPreference: "low-power"});
        ren.setSize(innerWidth, innerHeight); ren.setPixelRatio(1); ren.xr.enabled = true;
        clock = new THREE.Clock();
        scene.add(new THREE.AmbientLight(0x003300));
        lightSource = new THREE.PointLight(0xffffff, 1, 100); lightSource.position.set(0,0,0); scene.add(lightSource);
        const grid = new THREE.GridHelper(10, 10, 0x004400, 0x004400); scene.add(grid);
        userObj = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), new THREE.MeshBasicMaterial({color: 0x00ffff}));
        userObj.position.copy(user); scene.add(userObj);
        const arrow = new THREE.Mesh(new THREE.ConeGeometry(0.1, 0.3, 4), new THREE.MeshBasicMaterial({color: 0xff0000}));
        arrow.position.set(0,0.3,0); arrow.rotation.x = Math.PI/2; userObj.add(arrow);
        face3DLines = new THREE.LineSegments(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({color: 0x00ff00}));
        scene.add(face3DLines);
        const loader = new THREE.GLTFLoader();
        loader.load('https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf', gltf => {
            mask = gltf.scene; mask.scale.set(1.5,1.5,1.5); scene.add(mask);
        });
        composer = new THREE.EffectComposer(ren);
        composer.addPass(new THREE.RenderPass(scene, cam));
        thermalPass = new THREE.ShaderPass({
            uniforms: { tDiffuse: { value: null }, time: { value: 0 } },
            vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0); }`,
            fragmentShader: `uniform sampler2D tDiffuse; uniform float time; varying vec2 vUv;
                void main() {
                    vec4 c = texture2D(tDiffuse, vUv);
                    float l = dot(c.rgb, vec3(0.299,0.587,0.114));
                    vec3 thermal = mix(vec3(0.0,0.0,1.0), vec3(1.0,0.0,0.0), l);
                    float d = fract(sin(dot(vUv*100.0 + time, vec2(12.9898,78.233))) * 43758.5453);
                    gl_FragColor = vec4(thermal + (d-0.5)*0.1, c.a);
                }`
        });
        composer.addPass(thermalPass);
        cam.lookAt(user);
    }
    async function setupFaceDetection() {
        faceMesh = new FaceMesh({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true, minDetectionConfidence:0.7, minTrackingConfidence:0.7});
        await faceMesh.initialize();
        faceMesh.onResults(onFaceMeshResults);
    }
    async function setupObjectDetection() {
        try { objectDetector = await cocoSsd.load(); } catch(e) { logError('COCO-SSD: '+e.message); }
    }
    function onFaceMeshResults(results) {
        try {
            userDetected = !!(results.multiFaceLandmarks?.length);
            const ctx = $('#webcamCanvas').getContext('2d');
            ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
            if (results.image) ctx.drawImage(results.image,0,0,ctx.canvas.width,ctx.canvas.height);
            if (userDetected) {
                const lm = results.multiFaceLandmarks[0];
                drawConnectors(ctx, lm, FACEMESH_TESSELATION, {color:'#00ff00', lineWidth:1});
                const pos = [];
                FACEMESH_TESSELATION.forEach(c=> {
                    pos.push(lm[c[0]].x*4-2, -lm[c[0]].y*4+2, lm[c[0]].z*4,
                             lm[c[1]].x*4-2, -lm[c[1]].y*4+2, lm[c[1]].z*4);
                });
                face3DLines.geometry.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
                geometryDataSchema.faceGeometry.landmarks = lm.map(p=>({x:p.x,y:p.y,z:p.z}));
                geometryDataSchema.faceGeometry.vertices = lm.flatMap(p=>[p.x,p.y,p.z]);
                const nose = lm[1], left = lm[234], right = lm[454];
                const center = {x:(left.x+right.x)/2, y:(left.y+right.y)/2, z:(left.z+right.z)/2};
                if (mask) {
                    mask.position.set((center.x-0.5)*0.005, -(center.y-0.5)*0.005, -center.z*0.01);
                    mask.rotation.y = Math.atan2(right.y-left.y, right.x-left.x)*-2;
                }
                const le = lm[33], re = lm[263];
                faceDirection = Math.atan2(re.y-le.y, re.x-le.x)*180/Math.PI;
            }
            updateThermalMap(results.image);
            updateStatusPanel();
        } catch(e) { logError('Face: '+e.message); }
    }
    function updateThermalMap(video) {
        if (!video) return;
        lightPoints.forEach(p=>scene.remove(p)); lightPoints=[];
        const tc = document.createElement('canvas'); tc.width=16; tc.height=12;
        const ctx = tc.getContext('2d'); ctx.drawImage(video,0,0,16,12);
        const id = ctx.getImageData(0,0,16,12);
        let cnt=0;
        for (let y=0; y<12 && cnt<80; y++) for (let x=0; x<16 && cnt<80; x++) {
            const i=(y*16+x)*4;
            const lum = 0.299*id.data[i] + 0.587*id.data[i+1] + 0.114*id.data[i+2];
            if (lum>60) {
                const pos = new THREE.Vector3((x/16-0.5)*10, (0.5-y/12)*7.5, (lum/255*2-1));
                const pt = new THREE.Points(
                    new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute([pos.x,pos.y,pos.z],3)),
                    new THREE.PointsMaterial({size:0.15, color:new THREE.Color().setHSL(lum/255,1,0.5)})
                );
                scene.add(pt); lightPoints.push(pt); cnt++;
            }
        }
    }
    function onObjectDetectionResults(res) {
        if (!res.detections) return;
        res.detections.slice(0,5).forEach(d=> {
            if (d.score>0.5 && objects.length<50) {
                const a=Math.random()*Math.PI*2, dist=Math.random()*5+2;
                const obj = new THREE.Mesh(new THREE.SphereGeometry(0.5,4,4), new THREE.MeshBasicMaterial({color:0x000000, wireframe:true}));
                obj.position.set(Math.sin(a)*dist, Math.random()*2, Math.cos(a)*dist);
                obj.userData = {type:'void', class:d.class};
                scene.add(obj); objects.push(obj);
                geometryDataSchema.environmentObjects.push({class:d.class, type:'void', position:{x:obj.position.x,y:obj.position.y,z:obj.position.z}});
            }
        });
    }
    function setupEventListeners() {
        $('#mirrorBtn').onclick = () => { $('#mirrorPopup').style.display === 'block' ? closeMirror() : (openMirror(), startWebcam()); };
        $('#exportBtn').onclick = exportGeometryData;
        $('#resetBtn').onclick = resetScene;
        $('#arBtn').onclick = startAR;
        $('.mirror-close').onclick = closeMirror;
        $('#sceneClickArea').onclick = () => { cam.position.set(0,0,cameraDistance); cam.lookAt(user); };
        $('#pip').ondblclick = () => $('#pip').classList.toggle('fullscreen');
        const header = $('.mirror-header'), popup = $('#mirrorPopup');
        header.onmousedown = header.ontouchstart = e => {
            e.preventDefault(); mirrorDragging=true;
            const r=popup.getBoundingClientRect();
            mirrorOffset.x = (e.clientX||e.touches[0].clientX) - r.left;
            mirrorOffset.y = (e.clientY||e.touches[0].clientY) - r.top;
            document.onmousemove = document.ontouchmove = drag;
            document.onmouseup = document.ontouchend = () => { mirrorDragging=false; document.onmousemove=document.ontouchmove=document.onmouseup=document.ontouchend=null; };
        };
        function drag(e) { if(!mirrorDragging) return;
            const x=e.clientX||e.touches[0].clientX, y=e.clientY||e.touches[0].clientY;
            popup.style.left=(x-mirrorOffset.x)+'px'; popup.style.top=(y-mirrorOffset.y)+'px'; popup.style.transform='none';
        }
        window.onresize = () => {
            cam.aspect = innerWidth/innerHeight; cam.updateProjectionMatrix();
            ren.setSize(innerWidth, innerHeight); composer.setSize(innerWidth, innerHeight);
        };
    }
    async function startAR() {
        if (!navigator.xr) return logError('No WebXR');
        try {
            xrSession = await navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: {root: document.body}
            });
            ren.xr.setSession(xrSession);
            $('#arBtn').classList.add('active');
        } catch(e) { logError('AR: '+e.message); }
    }
    async function startWebcam() {
        if (stream) return;
        const status = $('#calibStatus'); status.textContent = 'INITIALIZING CAMERA...';
        const mobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
        isFrontCam = mobile;
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: isFrontCam?'user':'environment', width:{ideal:640}, height:{ideal:480} }
            });
            const video = document.createElement('video'); video.autoplay=video.playsInline=true; video.srcObject=stream;
            camera = new Camera(video, {
                onFrame: async () => {
                    await faceMesh.send({image: video});
                    if (objectDetector) {
                        const det = await objectDetector.detect(video);
                        onObjectDetectionResults({detections:det});
                    }
                },
                width: 320, height: 240
            });
            camera.start();
            pipVideo = $('#pip'); pipVideo.srcObject = stream; pipVideo.style.display='block'; pipVideo.play();
            $('#webcamCanvas').width=240; $('#webcamCanvas').height=180;
            status.textContent = 'READY FOR 3D CAPTURE';
        } catch(e) {
            status.textContent = 'CAMERA DENIED';
            logError('Webcam: '+e.message);
        }
    }
    function animate() {
        animationId = requestAnimationFrame(animate);
        const dt = clock.getDelta();
        thermalPass.uniforms.time.value += dt;
        if (userObj.children[0]) userObj.children[0].rotation.y = -faceDirection * Math.PI/180;
        objects.forEach((o,i)=>{ o.rotation.y += dt*0.2; o.position.y += Math.sin(Date.now()*0.001+i)*0.005; });
        cam.lookAt(user);
        composer.render();
    }
    function openMirror() { $('#mirrorPopup').style.display='block'; }
    function closeMirror() { $('#mirrorPopup').style.display='none'; }
    function exportGeometryData() {
        geometryDataSchema.timestamp = new Date().toISOString();
        const blob = new Blob([JSON.stringify(geometryDataSchema)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='geometry_data.json'; a.click();
    }
    function resetScene() {
        objects.forEach(o=>scene.remove(o)); objects=[];
        lightPoints.forEach(p=>scene.remove(p)); lightPoints=[];
        geometryDataSchema.environmentObjects=[]; geometryDataSchema.faceGeometry={vertices:[],normals:[],faces:[],landmarks:[]};
        updateStatusPanel();
    }
    function updateStatusPanel() {
        $('#objectCount').textContent = objects.length;
        $('#faceCount').textContent = userDetected?1:0;
        $('#dataPointCount').textContent = (geometryDataSchema.faceGeometry.vertices.length/3) + objects.length;
    }
    function autoStartMirror() { openMirror(); startWebcam(); }
    window.onload = init;
</script>
</body>
</html>
