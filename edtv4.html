<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>edTV: CHANNEL 4 // VR MASK</title>
<meta name="theme-color" content="#000000">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none;-webkit-tap-highlight-color:transparent}
    canvas{display:block;width:100%;height:100%}
    .matrix-grid{position:absolute;inset:0;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3;pointer-events:none}
    .crt{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;pointer-events:none;animation:stripes 8s linear infinite}
    .scanline{position:absolute;inset:0;background:linear-gradient(transparent 50%,rgba(255,0,255,0.03));background-size:100% 4px;animation:scan 6s linear infinite;pointer-events:none;opacity:0.6}
    @keyframes stripes{0%{background-position:0 0}100%{background-position:0 100%}}
    @keyframes scan{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
    .top-banner{position:absolute;top:0;left:0;width:100%;height:48px;background:rgba(255,0,255,0.92);border-bottom:4px solid #f0f;display:flex;align-items:center;justify-content:center;z-index:100;animation:glitch 3s infinite}
    @keyframes glitch{0%,100%{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-3px,-3px)}20%,40%,60%,80%{transform:translate(6px,3px)}}
    .top-banner-text{font-size:11px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
    #pip{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;height:400px;border:6px solid #0ff;border-radius:16px;z-index:14;object-fit:cover;background:#000;box-shadow:0 0 50px #0ff, inset 0 0 60px rgba(0,255,255,0.25);}
    #mask-canvas{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;height:400px;z-index:15;pointer-events:none;}
    .dog-detected .top-banner{animation:glitch 0.08s infinite !important;background:#f0f !important}
    .dog-detected #pip{border-color:#f0f;box-shadow:0 0 90px #f0f,0 0 140px #f0f;animation:pulse 1.3s infinite}
    @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.08)}}
    .controls-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);display:flex;gap:16px;z-index:100;flex-wrap:wrap;justify-content:center;}
    .ctrl-btn{height:68px;background:#000;border:4px solid #0ff;color:#0ff;font-size:13px;padding:0 18px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:6px 6px 0 #000;transform:skew(-4deg);transition:all .15s;}
    .ctrl-btn:active{background:#0ff;color:#000}
    #switchCam{border-color:#0f0;color:#0f0}
    #switchCam:active{background:#0f0;color:#000}
    #errorLog{position:absolute;bottom:100px;left:10px;background:rgba(0,0,0,0.96);border:3px double #f00;padding:10px;font-size:7px;color:#f00;z-index:15;max-height:240px;overflow:auto;width:calc(100% - 20px);opacity:0.94;}
    .cam-status{position:absolute;top:56px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);padding:4px 14px;border:2px solid #0ff;color:#0ff;font-size:9px;z-index:16;opacity:0;transition:opacity .4s;}
    .cam-status.show{opacity:1}
</style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt"></div>
    <div class="scanline"></div>
    <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 4 // VR MASK</div></div>
    <video id="pip" autoplay playsinline muted></video>
    <canvas id="mask-canvas"></canvas>
    <div class="cam-status" id="camStatus">CAMERA: FRONT</div>
    <div class="controls-container">
        <button id="startSync" class="ctrl-btn">SYNC</button>
        <button id="switchCam" class="ctrl-btn">SWITCH</button>
        <button id="resetBtn" class="ctrl-btn" style="border-color:#ff0;color:#ff0">RESET</button>
    </div>
    <div id="errorLog">
        <div>INFO edTV: CHANNEL 4 // VR MASK READY</div>
    </div>
</div>

<script type="module">
    const video = document.getElementById('pip');
    const canvas = document.getElementById('mask-canvas');
    const ctx = canvas.getContext('2d');
    const logEl = document.getElementById('errorLog');
    const camStatus = document.getElementById('camStatus');
    let currentStream = null;
    let isFrontCamera = true;
    let scene, camera3d, renderer, dogMask, particles;
    let faceMesh, mpCamera;

    function log(msg, color = '#00ff00') {
        const time = new Date().toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
        const line = document.createElement('div');
        line.style.color = color;
        line.innerHTML = `${time} <span style="color:#0ff">DOGSYNC</span> ${msg}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function startCamera(facingMode = "user") {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode, width: {ideal:1280}, height: {ideal:720} }
            });
            video.srcObject = currentStream;
            video.play();
            canvas.width = 400; canvas.height = 400;
            isFrontCamera = (facingMode === "user");
            camStatus.textContent = `CAMERA: ${isFrontCamera ? "FRONT" : "REAR"}`;
            camStatus.classList.add('show');
            setTimeout(() => camStatus.classList.remove('show'), 2000);
            log(`Camera → ${isFrontCamera ? "FRONT" : "REAR"}`, '#00ff00');
        } catch (e) {
            log('CAMERA DENIED // BARK LOUDER', '#ff0000');
        }
    }

    function initThree() {
        scene = new THREE.Scene();
        camera3d = new THREE.PerspectiveCamera(60, 1, 0.1, 10);
        renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
        renderer.setSize(400, 400);
        renderer.setPixelRatio(window.devicePixelRatio);

        const geo = new THREE.IcosahedronGeometry(0.22, 2);
        const mat = new THREE.MeshBasicMaterial({color: 0x00ffff, wireframe: true, transparent: true, opacity: 0.9});
        dogMask = new THREE.Mesh(geo, mat);
        dogMask.scale.set(2.6, 2.2, 2.4);
        scene.add(dogMask);

        const pGeo = new THREE.BufferGeometry();
        const pos = new Float32Array(600 * 3);
        for (let i = 0; i < pos.length; i++) pos[i] = (Math.random() - 0.5) * 4;
        pGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
        const pMat = new THREE.PointsMaterial({color: 0x00ffff, size: 0.03, transparent: true});
        particles = new THREE.Points(pGeo, pMat);
        scene.add(particles);

        log('VR DOG MASK ONLINE', '#00ffff');
    }

    function onResults(results) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
            document.body.classList.add('dog-detected');
            const landmarks = results.multiFaceLandmarks[0];
            const pose = getHeadPose(landmarks);

            dogMask.rotation.set(pose.pitch, pose.yaw, pose.roll);

            const nose = landmarks[1];
            const chin = landmarks[152];
            const faceHeight = Math.abs(nose.y - chin.y);
            const scale = 2.4 + (faceHeight * 8);
            dogMask.scale.set(scale * 1.1, scale * 0.95, scale * 1.05);

            dogMask.material.color.setHSL((Date.now() * 0.001) % 1, 1, 0.5);
            dogMask.material.opacity = 0.7 + Math.random() * 0.3);
            dogMask.rotation.y += 0.04;
            particles.rotation.y += 0.02;
            particles.rotation.x = Math.sin(Date.now() * 0.002) * 0.3;
        } else {
            document.body.classList.remove('dog-detected');
            dogMask.rotation.y += 0.006;
        }
        renderer.render(scene, camera3d);
    }

    // Fixed 2D-only head pose (no .z)
    function getHeadPose(landmarks) {
        const nose = landmarks[1];
        const leftEye = landmarks[33];
        const rightEye = landmarks[263];
        const leftEar = landmarks[234];
        const rightEar = landmarks[454];

        const yaw = (rightEye.x - leftEye.x);
        const pitch = (nose.y - ((leftEye.y + rightEye.y)/2));
        const roll = Math.atan2(rightEar.y - leftEar.y, rightEar.x - leftEar.x);

        return { yaw: yaw * 8, pitch: pitch * -10, roll: roll };
    }

    // Fully fixed startDogSync – no initialize(), proper modern MediaPipe
    async function startDogSync() {
        log('INITIATING VR DOGSYNC...');
        await startCamera();
        initThree();

        faceMesh = new FaceMesh({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
        }});

        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });
        faceMesh.onResults(onResults);

        mpCamera = new Camera(video, {
            onFrame: async () => {
                await faceMesh.send({image: video});
            },
            width: 640,
            height: 480
        });
        await mpCamera.start();

        log('VR DOGSYNC ACTIVE // WEAR THE MASK', '#00ffff');
    }

    document.getElementById('startSync').onclick = startDogSync;

    document.getElementById('switchCam').onclick = async () => {
        if (!currentStream) return log('Start SYNC first', '#ff8800');
        const mode = isFrontCamera ? "environment" : "user";
        await startCamera(mode);
        if (mpCamera) {
            mpCamera.stop();
            setTimeout(() => mpCamera.start(), 600);
        }
    };

    document.getElementById('resetBtn').onclick = () => location.reload();

    log('Tap SYNC → wear the mask');
</script>
</body>
</html>
