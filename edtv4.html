<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>edTV: CHANNEL 4</title>
<meta name="theme-color" content="#000000">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
    body{background:#000;color:#0f0;overflow:hidden;height:100vh;user-select:none}
    #appContainer{position:relative;width:100%;height:100vh;overflow:hidden}
    .matrix-grid{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,255,0,0.1)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.1)1px,transparent 1px);background-size:16px 16px;opacity:0.3}
    .crt{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,20,0,0.1)50%);background-size:100% 4px;pointer-events:none;animation:s 8s linear infinite}
    @keyframes s{0%{background-position:0 0}100%{background-position:0 100%}}
    .top-banner{position:absolute;top:0;left:50%;transform:translateX(-50%);width:auto;padding:5px 20px;background:rgba(255,0,255,0.9);border:2px solid #f0f;border-radius:0 0 10px 10px;display:flex;align-items:center;justify-content:center;z-index:12;animation:g 3s infinite}
    @keyframes g{0%,100%{transform:translateX(-50%)}5%{transform:translateX(calc(-50% - 2px))}10%{transform:translateX(calc(-50% + 2px))}15%{transform:translateX(calc(-50% - 1px))}20%{transform:translateX(calc(-50% + 1px))}25%{transform:translateX(-50%)}55%{transform:translateX(calc(-50% - 1px)) skewX(-2deg)}60%{transform:translateX(calc(-50% + 1px)) skewX(2deg)}}
    .top-banner-text{font-size:10px;color:#000;text-shadow:1px 1px 0 #fff;letter-spacing:1px}
    .ctrl-btn{width:120px;height:52px;background:#000;border:3px solid #0ff;color:#0ff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:3px 3px 0 #000;transform:skew(-2deg);transition:background .1s,color .1s;margin:10px}
    .ctrl-btn:hover,.ctrl-btn:active,.ctrl-btn.active{background:#0ff;color:#000}
    .export-btn{border-color:#f0f;color:#f0f}
    .export-btn:hover{background:#f0f;color:#000}
    .controls-container{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:11;flex-wrap:wrap;justify-content:center}
    #pip{position:fixed;top:20px;right:20px;width:240px;height:180px;border:4px solid #0ff;border-radius:8px;z-index:10;cursor:pointer;display:none}
    .pip-grid{position:fixed;top:20px;right:20px;width:240px;height:180px;background:linear-gradient(rgba(0,255,0,0.5)1px,transparent 1px),linear-gradient(90deg,rgba(0,255,0,0.5)1px,transparent 1px);background-size:20px 20px;opacity:0.6;pointer-events:none;z-index:11}
    .status-panel{position:absolute;top:50px;right:10px;background:rgba(0,0,0,0.8);border:2px solid #0ff;padding:8px;font-size:8px;color:#0ff;z-index:11}
    #errorLog{position:absolute;top:40px;left:10px;background:rgba(0,0,0,0.8);border:2px solid #f00;padding:8px;font-size:8px;color:#f00;max-height:200px;overflow:auto;z-index:11;width:200px}
    @media (max-width:767px){.controls-container{bottom:100px;}}
</style>
</head>
<body>
<div id="appContainer">
    <div class="matrix-grid"></div>
    <div class="crt"></div>
    <div class="top-banner"><div class="top-banner-text">edTV: CHANNEL 4</div></div>
    <canvas id="visualizationCanvas"></canvas>
    <div class="status-panel">
        <div>STATUS: <span id="pointCount">READY</span></div>
    </div>
    <div class="controls-container">
        <button id="syncArBtn" class="ctrl-btn" style="border-color:#0ff;color:#0ff;background:#000">
            SYNC AR
        </button>
        <button id="resetBtn" class="ctrl-btn" style="border-color:#ff0;color:#ff0">RESET</button>
        <button id="exportBtn" class="ctrl-btn export-btn">EXPORT</button>
    </div>
    <video id="pip" autoplay playsinline muted></video>
    <div class="pip-grid"></div>
    <div id="errorLog"></div>
</div>

<script type="module">
import { ARButton } from 'https://unpkg.com/three@0.158.0/examples/jsm/webxr/ARButton.js';

let scene, camera, renderer, controller;
let reticle, heroGroup;
let hitTestSource = null;
let hitTestSourceRequested = false;
let isARActive = false;

const $ = s => document.querySelector(s);
const video = $('#pip');

function log(msg) {
    $('#errorLog').innerHTML += `${new Date().toISOString().slice(11,19)}: ${msg}<br>`;
    $('#errorLog').scrollTop = $('#errorLog').scrollHeight;
}

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 20);
   
    renderer = new THREE.WebGLRenderer({canvas: $('#visualizationCanvas'), antialias: false, alpha: true});
    renderer.setPixelRatio(1);
    renderer.setSize(innerWidth, innerHeight);
    renderer.xr.enabled = true;

    // Neuro wireframe hero (low-poly icosahedron head)
    heroGroup = new THREE.Group();
    const geometry = new THREE.IcosahedronGeometry(0.4, 1);
    const material = new THREE.MeshBasicMaterial({color: 0x00ffff, wireframe: true});
    const hero = new THREE.Mesh(geometry, material);
    heroGroup.add(hero);
    heroGroup.scale.set(2,2,2);
    heroGroup.visible = false;
    scene.add(heroGroup);

    // Grid floor
    const grid = new THREE.GridHelper(10, 40, 0x00ff00, 0x00ff00);
    grid.material.opacity = 0.3; grid.material.transparent = true;
    scene.add(grid);

    // Reticle for placement
    reticle = new THREE.Mesh(
        new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI/2),
        new THREE.MeshBasicMaterial({color: 0x00ffff, opacity: 0.8, transparent: true})
    );
    reticle.visible = false;
    scene.add(reticle);

    // Lights
    const ambient = new THREE.HemisphereLight(0x00ff00, 0x00ffff, 0.8);
    scene.add(ambient);

    window.addEventListener('resize', onWindowResize);
}

function onWindowResize() {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
}

// SYNC AR BUTTON
$('#syncArBtn').onclick = async () => {
    if (isARActive) return;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
        video.srcObject = stream;
        video.style.display = 'block';
        video.play();

        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['hit-test'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: {root: document.body}
        });

        renderer.xr.setSession(session);
        isARActive = true;
        $('#syncArBtn').classList.add('active');
        $('#syncArBtn').textContent = 'AR ACTIVE';
        $('#pointCount').textContent = 'SYNCED';

        controller = renderer.xr.getController(0);
        controller.addEventListener('select', onSelect);
        scene.add(controller);

        session.addEventListener('end', () => {
            isARActive = false;
            heroGroup.visible = false;
            reticle.visible = false;
            $('#syncArBtn').classList.remove('active');
            $('#syncArBtn').textContent = 'SYNC AR';
            $('#pointCount').textContent = 'READY';
        });

        animate();
    } catch(e) {
        log('AR FAIL: ' + e);
        $('#pointCount').textContent = 'ERROR';
    }
};

function onSelect() {
    if (reticle.visible) {
        heroGroup.position.setFromMatrixPosition(reticle.matrix);
        heroGroup.visible = true;
    }
}

function animate() {
    renderer.setAnimationLoop((timestamp, frame) => {
        if (!frame) return;

        const referenceSpace = renderer.xr.getReferenceSpace();
        const session = renderer.xr.getSession();

        if (!hitTestSourceRequested) {
            session.requestReferenceSpace('viewer').then(refSpace => {
                session.requestHitTestSource({space: refSpace}).then(source => {
                    hitTestSource = source;
                });
            });
            hitTestSourceRequested = true;
        }

        if (hitTestSource && frame) {
            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length) {
                const hit = hitTestResults[0];
                const pose = hit.getPose(referenceSpace);
                reticle.visible = true;
                reticle.matrix.fromArray(pose.transform.matrix);
            } else {
                reticle.visible = false;
            }
        }

        if (heroGroup.visible) {
            heroGroup.rotation.y += 0.01;
            heroGroup.scale.setScalar(2 + Math.sin(timestamp * 0.002) * 0.2);
        }

        renderer.render(scene, camera);
    });
}

$('#resetBtn').onclick = () => {
    heroGroup.visible = false;
    reticle.visible = false;
};

$('#exportBtn').onclick = () => {
    const data = {
        version: "2.0",
        timestamp: new Date().toISOString(),
        heroPosition: heroGroup.visible ? heroGroup.position.toArray() : null
    };
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}));
    a.download = 'neuro_hero_sync.json';
    a.click();
};

init();
</script>
</body>
</html>
