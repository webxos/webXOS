<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e1e2e">
    <title>webXOS Gaming Server IDE</title>
    <link rel="manifest" href="/gateway/manifest.json">
    <link rel="icon" href="/gateway/icon.png">
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1e1e2e; color: #cdd6f4; display: flex; height: 100vh; }
        #container { display: flex; flex: 1; gap: 10px; padding: 10px; }
        #editor { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        #code-editor { flex: 1; border-radius: 8px; overflow: hidden; }
        #controls { display: flex; gap: 10px; }
        button { padding: 8px 16px; background: #89b4fa; color: #1e1e2e; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #b4befe; }
        #output { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        #game-output, #terminal { flex: 1; background: #181825; border: none; border-radius: 8px; padding: 10px; color: #cdd6f4; resize: none; font-family: 'Consolas', monospace; }
        #terminal { background: #11111b; }
        @media (max-width: 768px) { #container { flex-direction: column; } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.4.12/src-min-noconflict/ace.js"></script>
</head>
<body>
    <div id="container">
        <div id="editor">
            <div id="code-editor"></div>
            <div id="controls">
                <button onclick="runCode()">Run</button>
                <button onclick="saveCode()">Save</button>
            </div>
        </div>
        <div id="output">
            <textarea id="game-output" readonly placeholder="Game Output"></textarea>
            <textarea id="terminal" readonly placeholder="Terminal"></textarea>
        </div>
    </div>

    <script>
        const editor = ace.edit("code-editor", {
            theme: "ace/theme/monokai",
            mode: "ace/mode/javascript",
            value: `// webXOS Game Server Code\nconsole.log("Hello, webXOS!");\n`
        });
        editor.setStyle({ height: "calc(100vh - 70px)", width: "100%" });

        const terminal = document.getElementById("terminal");
        const gameOutput = document.getElementById("game-output");

        // Local URLs for testing; update for cloud deployment
        const NODE_API = 'http://localhost:3000';
        const FASTAPI_API = 'http://localhost:8000';

        async function makeRequest(url, method, body) {
            terminal.value += `Sending ${method} to ${url}...\n`;
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : undefined
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                return await response.json();
            } catch (error) {
                terminal.value += `Error: ${error.message}\n`;
                throw error;
            }
        }

        async function runCode() {
            const code = editor.getValue();
            terminal.value = "Running...\n";
            try {
                const nodeResult = await makeRequest(`${NODE_API}/run`, 'POST', { code });
                terminal.value += `Node.js: ${nodeResult.output}\n`;
                const fastApiResult = await makeRequest(`${FASTAPI_API}/game`, 'POST', { code });
                gameOutput.value = fastApiResult.gameState;
            } catch (error) {}
        }

        async function saveCode() {
            const code = editor.getValue();
            try {
                const result = await makeRequest(`${NODE_API}/save`, 'POST', { code });
                terminal.value += `Saved: ${result.message}\n`;
            } catch (error) {}
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/gateway/sw.js')
                    .then(reg => terminal.value += 'Service Worker registered\n')
                    .catch(err => terminal.value += `Service Worker error: ${err}\n`);
            });
        }
    </script>
</body>
</html>
