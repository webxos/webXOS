<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e1e2e">
    <title>webXOS Multiplayer Game IDE</title>
    <link rel="manifest" href="/main/gateway/manifest.json">
    <link rel="icon" href="/main/gateway/icon.png">
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1e1e2e; color: #cdd6f4; height: 100vh; display: flex; overflow: hidden; }
        #container { display: flex; flex: 1; gap: 10px; padding: 10px; z-index: 1; }
        #editor { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        #config-form { display: flex; flex-direction: column; gap: 10px; background: #181825; padding: 10px; border-radius: 8px; }
        #config-form input { padding: 8px; border: none; border-radius: 4px; }
        #access-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
        button { padding: 8px 16px; background: #89b4fa; color: #1e1e2e; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #b4befe; }
        #output { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        #game-canvas { flex: 1; border-radius: 8px; background: #181825; }
        #game-status { flex: 0 0 100px; background: #181825; border-radius: 8px; padding: 10px; }
        #wizard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #wizard-content { background: #2e2e3e; padding: 20px; border-radius: 8px; color: #cdd6f4; max-width: 500px; text-align: center; }
        #wizard-content button { margin-top: 10px; }
        @media (max-width: 768px) { #container { flex-direction: column; } }
    </style>
</head>
<body>
    <div id="wizard">
        <div id="wizard-content">
            <h2>webXOS Game Setup</h2>
            <p id="wizard-step">Checking backend connectivity...</p>
            <button onclick="nextWizardStep()">Next</button>
        </div>
    </div>
    <div id="container">
        <div id="editor">
            <div id="access-buttons">
                <button onclick="window.location.href='https://webxos.netlify.app/main/gateway/server.html'">Open IDE</button>
                <button onclick="checkBackendStatus()">Check Backend</button>
                <button onclick="window.open('https://vercel.com/your-project', '_blank')">Node.js Status</button>
                <button onclick="window.open('https://render.com/your-project', '_blank')">FastAPI Status</button>
            </div>
            <div id="config-form">
                <input id="game-name" type="text" placeholder="Game Name" required>
                <input id="game-port" type="number" placeholder="Port (e.g., 3001)" min="3001" max="65535" required>
                <input id="max-players" type="number" placeholder="Max Players (e.g., 4)" min="1" max="100" required>
                <button onclick="createGame()">Create Game</button>
                <button onclick="connectGame()">Connect to Game</button>
            </div>
        </div>
        <div id="output">
            <canvas id="game-canvas" width="600" height="400"></canvas>
            <div id="game-status">Status: Not connected</div>
        </div>
    </div>

    <script>
        const gameNameInput = document.getElementById("game-name");
        const gamePortInput = document.getElementById("game-port");
        const maxPlayersInput = document.getElementById("max-players");
        const gameStatus = document.getElementById("game-status");
        const canvas = document.getElementById("game-canvas");
        const ctx = canvas.getContext("2d");
        const wizard = document.getElementById("wizard");
        const wizardStep = document.getElementById("wizard-step");

        // Replace with your deployed backend URLs
        const NODE_API = 'https://your-node-backend.vercel.app';
        const FASTAPI_API = 'https://your-fastapi-backend.onrender.com';

        let ws = null;
        let players = {};

        // Sanitize input to prevent injection
        function sanitizeInput(value) {
            return value.replace(/[<>{}]/g, '').substring(0, 50);
        }

        // Simple multiplayer game rendering
        function renderGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (const id in players) {
                const player = players[id];
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, 20, 20);
            }
            requestAnimationFrame(renderGame);
        }

        async function makeRequest(url, method, body) {
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: body ? JSON.stringify(body) : undefined
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                gameStatus.textContent = `Error: ${error.message}`;
                throw error;
            }
        }

        async function createGame() {
            const gameName = sanitizeInput(gameNameInput.value);
            const port = parseInt(gamePortInput.value);
            const maxPlayers = parseInt(maxPlayersInput.value);
            if (!gameName || !port || !maxPlayers) {
                gameStatus.textContent = "Status: Invalid input";
                return;
            }
            try {
                const result = await makeRequest(`${NODE_API}/create`, 'POST', { gameName, port, maxPlayers });
                gameStatus.textContent = `Status: Game ${gameName} created on port ${port}`;
                connectWebSocket(port);
            } catch (error) {}
        }

        async function connectGame() {
            const gameName = sanitizeInput(gameNameInput.value);
            const port = parseInt(gamePortInput.value);
            if (!gameName || !port) {
                gameStatus.textContent = "Status: Invalid input";
                return;
            }
            try {
                const result = await makeRequest(`${FASTAPI_API}/join`, 'POST', { gameName });
                gameStatus.textContent = `Status: Connected to ${gameName}`;
                connectWebSocket(port);
            } catch (error) {}
        }

        function connectWebSocket(port) {
            ws = new WebSocket(`ws://your-node-backend.vercel.app:${port}`);
            ws.onopen = () => {
                gameStatus.textContent = `Status: WebSocket connected on port ${port}`;
                ws.send(JSON.stringify({ id: 'player1', x: 50, y: 50, color: 'red' }));
            };
            ws.onmessage = (event) => {
                players = JSON.parse(event.data);
            };
            ws.onclose = () => {
                gameStatus.textContent = "Status: WebSocket disconnected";
            };
            renderGame();
        }

        async function checkBackendStatus() {
            gameStatus.textContent = "Status: Checking backends...";
            try {
                await makeRequest(`${NODE_API}/health`, 'GET');
                gameStatus.textContent += " Node.js: Online";
            } catch (error) {
                gameStatus.textContent += " Node.js: Offline";
            }
            try {
                await makeRequest(`${FASTAPI_API}/health`, 'GET');
                gameStatus.textContent += " FastAPI: Online";
            } catch (error) {
                gameStatus.textContent += " FastAPI: Offline";
            }
        }

        // Install wizard
        let wizardState = 0;
        async function nextWizardStep() {
            if (wizardState === 0) {
                wizardStep.textContent = "Checking backend connectivity...";
                await checkBackendStatus();
                wizardStep.textContent = "Enter game details in the form and click Create or Connect.";
                wizardState++;
            } else if (wizardState === 1) {
                wizardStep.textContent = "Install as PWA for offline access?";
                if ('BeforeInstallPromptEvent' in window) {
                    window.addEventListener('beforeinstallprompt', e => {
                        e.prompt();
                    });
                }
                wizardState++;
            } else {
                wizard.style.display = 'none';
            }
        }

        window.onload = () => {
            wizard.style.display = 'flex';
            nextWizardStep();
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/main/gateway/sw.js', { scope: '/main/gateway/' })
                    .then(reg => gameStatus.textContent += ' Service Worker registered')
                    .catch(err => gameStatus.textContent += ` Service Worker error: ${err}`);
            });
        }
    </script>
</body>
</html>
