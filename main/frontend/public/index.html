<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vial MCP</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <script src="/auth-handler.js" type="module"></script>
  <script src="/ui-updater.js" type="module"></script>
  <script src="/config.js" type="module"></script>
</head>
<body>
  <div class="container">
    <h1>Vial MCP Controller</h1>
    <div class="status">
      <span>Status: <span id="status">Initializing</span></span>
      <span id="offline-indicator"></span>
    </div>
    <div class="mode">Mode: Initializing</div>
    <div class="wallet">
      <p>User ID: <span id="user-id"></span></p>
      <p>Balance: <span id="balance"></span> $WEBXOS</p>
      <p>Reputation: <span id="reputation"></span></p>
      <p>Wallet Address: <span id="wallet-address"></span></p>
    </div>
    <div class="vials">
      <p>Vial 1: <span id="vial1-status">Stopped</span> (Balance: <span id="vial1-balance">0</span>)</p>
      <p>Vial 2: <span id="vial2-status">Stopped</span> (Balance: <span id="vial2-balance">0</span>)</p>
      <p>Vial 3: <span id="vial3-status">Stopped</span> (Balance: <span id="vial3-balance">0</span>)</p>
      <p>Vial 4: <span id="vial4-status">Stopped</span> (Balance: <span id="vial4-balance">0</span>)</p>
    </div>
    <div class="credentials">
      <input type="text" id="api-key" readonly placeholder="API Key">
      <input type="text" id="api-secret" readonly placeholder="API Secret">
    </div>
    <div class="button-container">
      <button id="auth-button">Authenticate</button>
      <button id="oauth-button">Login with Google</button>
      <button id="void-button" disabled>Void</button>
      <button id="troubleshoot-button" disabled>Troubleshoot</button>
      <button id="quantum-button" disabled>Quantum Link</button>
      <button id="export-button" disabled>Export</button>
      <input type="file" id="file-input" style="display: none;">
    </div>
    <div class="terminal">
      <input type="text" id="command-input" placeholder="Enter command...">
    </div>
  </div>
  <script type="module">
    import { AuthHandler } from '/auth-handler.js';
    import { UIUpdater } from '/ui-updater.js';
    import { config } from '/config.js';

    class MCPClient {
      async request(endpoint: string, method: string = 'POST', body?: any) {
        const token = localStorage.getItem('access_token');
        const headers: any = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const response = await fetch(`http://localhost:8080${endpoint}`, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined
        });
        if (!response.ok) throw new Error(`Request failed: ${response.statusText}`);
        return response.json();
      }
    }

    class Gateway {
      elements: any;
      isAuthenticated: boolean;
      wallet: any;
      vials: any[];

      constructor() {
        this.elements = {
          status: document.getElementById('status')!,
          offlineIndicator: document.getElementById('offline-indicator')!,
          mode: document.querySelector('.mode')!,
          balance: document.getElementById('balance')!,
          reputation: document.getElementById('reputation')!,
          userId: document.getElementById('user-id')!,
          walletAddress: document.getElementById('wallet-address')!,
          vials: document.querySelector('.vials')!,
          vialStatuses: Array.from(document.querySelectorAll('.vials span[id$="-status"]')),
          vialBalances: Array.from(document.querySelectorAll('.vials span[id$="-balance"]')),
          credentials: document.querySelector('.credentials')!,
          apiKey: document.getElementById('api-key')!,
          apiSecret: document.getElementById('api-secret')!,
          authButton: document.getElementById('auth-button')!,
          oauthButton: document.getElementById('oauth-button')!,
          voidButton: document.getElementById('void-button')!,
          troubleshootButton: document.getElementById('troubleshoot-button')!,
          quantumButton: document.getElementById('quantum-button')!,
          exportButton: document.getElementById('export-button')!,
          fileInput: document.getElementById('file-input')!,
          terminal: document.querySelector('.terminal')!,
          commandInput: document.getElementById('command-input')!
        };
        this.isAuthenticated = !!localStorage.getItem('access_token');
        this.wallet = {};
        this.vials = [];
        this.setupEventListeners();
      }

      setupEventListeners() {
        const client = new MCPClient();
        const authHandler = new AuthHandler(client, this);
        const uiUpdater = new UIUpdater(this);

        this.elements.oauthButton.addEventListener('click', async () => {
          const authWindow = window.open('/oauth/google', '_blank');
          window.addEventListener('message', async (event) => {
            if (event.data.oauth_token) {
              await authHandler.login(event.data.oauth_token, 'google');
              authWindow?.close();
            }
          });
        });

        this.elements.commandInput.addEventListener('keypress', async (e: KeyboardEvent) => {
          if (e.key === 'Enter') {
            const command = this.elements.commandInput.value;
            uiUpdater.addTerminalMessage(`Executing: ${command}`, 'command');
            this.elements.commandInput.value = '';
          }
        });
      }

      updateButtonStates() {
        this.elements.authButton.disabled = this.isAuthenticated;
        this.elements.oauthButton.disabled = this.isAuthenticated;
        this.elements.voidButton.disabled = !this.isAuthenticated;
        this.elements.troubleshootButton.disabled = !this.isAuthenticated;
        this.elements.quantumButton.disabled = !this.isAuthenticated;
        this.elements.exportButton.disabled = !this.isAuthenticated;
      }
    }

    const gateway = new Gateway();
  </script>
</body>
</html>
