<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neon MCP Controller</title>
  <style>
    body {
      font-family: 'Courier New', Courier, monospace;
      background-color: #1a1a1a;
      color: #0f0;
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      width: 100%;
      background-color: #222;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    }
    h1 {
      text-align: center;
      font-size: 20px;
      margin: 10px 0;
    }
    .status {
      background-color: #333;
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .status p {
      margin: 5px 0;
      font-size: 14px;
    }
    .vials {
      background-color: #333;
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: none;
    }
    .vials.active {
      display: block;
    }
    .credentials {
      background-color: #333;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: none;
    }
    .credentials.active {
      display: block;
    }
    .credentials input {
      width: calc(100% - 16px);
      padding: 6px;
      margin: 5px 0;
      background-color: #444;
      border: none;
      color: #0f0;
      border-radius: 3px;
      font-size: 14px;
    }
    .terminal {
      background-color: #000;
      padding: 8px;
      border-radius: 5px;
      margin-bottom: 10px;
      height: 150px;
      overflow-y: auto;
      font-size: 12px;
    }
    .terminal .error {
      color: #f00;
    }
    .terminal .command {
      color: #0f0;
    }
    .terminal input {
      background: none;
      border: none;
      color: #0f0;
      width: 100%;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
    }
    .button-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      background-color: #0f0;
      color: #000;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 3px;
      font-weight: bold;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0c0;
    }
    button.disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    button.disabled:hover {
      background-color: #666;
    }
    .footer {
      margin-top: 10px;
      text-align: center;
      font-size: 10px;
      color: #888;
    }
    @media (max-width: 600px) {
      .container { padding: 10px; }
      h1 { font-size: 18px; }
      button { padding: 6px 12px; font-size: 12px; }
      .terminal { height: 100px; font-size: 10px; }
      .terminal input { font-size: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Neon MCP Controller</h1>
    <div class="status">
      <p>Neon MCP Controller initialized. Use /help for API commands.</p>
      <p>$WEBXOS Balance: <span id="balance">0.0000</span> | Reputation: <span id="reputation">0</span></p>
    </div>
    <div class="vials" id="vials">
      <p>Vial 1: <span id="vial1-status">Stopped</span> | Balance: <span id="vial1-balance">0.0000</span></p>
      <p>Vial 2: <span id="vial2-status">Stopped</span> | Balance: <span id="vial2-balance">0.0000</span></p>
      <p>Vial 3: <span id="vial3-status">Stopped</span> | Balance: <span id="vial3-balance">0.0000</span></p>
      <p>Vial 4: <span id="vial4-status">Stopped</span> | Balance: <span id="vial4-balance">0.0000</span></p>
    </div>
    <div class="credentials" id="credentials">
      <p>API Access Credentials</p>
      <input type="text" id="api-key" placeholder="API Key: N/A" readonly>
      <input type="text" id="api-secret" placeholder="API Secret: N/A" readonly>
      <button id="generate-credentials">Generate New Credentials</button>
      <button id="close-credentials">Close</button>
    </div>
    <div class="terminal" id="terminal">
      <p id="terminal-message" class="command">Initializing...</p>
      <input type="text" id="command-input" placeholder="Enter command...">
    </div>
    <div class="button-container">
      <button id="auth-btn">Authenticate</button>
      <button id="void-btn" class="disabled" disabled>Void</button>
      <button id="troubleshoot-btn" class="disabled" disabled>Troubleshoot</button>
      <button id="quantum-link-btn" class="disabled" disabled>Quantum Link</button>
      <button id="export-btn" class="disabled" disabled>Export</button>
      <button id="import-btn" class="disabled" disabled>Import</button>
      <button id="api-access-btn" class="disabled" disabled>API Access</button>
    </div>
    <div class="footer">
      <p>Neon MCP Controller | Offline Mode | 2025 | v3.0.0</p>
      <p>WARNING: $WEBXOS token is in development under MIT license.</p>
    </div>
    <input type="file" id="file-input" accept=".md" style="display: none;">
  </div>
  <script type="module">
    const agentTemplates = [
      `import torch\nclass VialAgent1:\n    def __init__(self):\n        self.model = torch.nn.Linear(10, 1)\n    def forward(self, x):\n        return torch.sigmoid(self.model(x))`,
      `import torch\nclass VialAgent2:\n    def __init__(self):\n        self.model = torch.nn.Linear(20, 2)\n    def forward(self, x):\n        return torch.relu(self.model(x))`,
      `import torch\nclass VialAgent3:\n    def __init__(self):\n        self.model = torch.nn.Linear(15, 3)\n    def forward(self, x):\n        return torch.tanh(self.model(x))`,
      `import torch\nclass VialAgent4:\n    def __init__(self):\n        self.model = torch.nn.Linear(25, 4)\n    def forward(self, x):\n        return torch.softmax(self.model(x), dim=1)`
    ];

    class MCPClient {
      constructor() {
        const isNetlify = window.location.hostname.includes('netlify');
        this.baseUrl = isNetlify ? '/api/v1' : 'http://localhost:8000/api/v1';
        this.token = localStorage.getItem('access_token') || null;
        this.offline = !navigator.onLine;
        this.retryAttempts = 3;
        this.retryDelay = 2000;
      }
      async request(endpoint, method = 'GET', body = null) {
        try {
          if (this.offline) return this.mockResponse(endpoint);
          const response = await this.fetchWithRetry(`${this.baseUrl}${endpoint}`, {
            method,
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              ...(this.token ? { 'Authorization': `Bearer ${this.token}` } : {})
            },
            body: body ? JSON.stringify(body) : null
          });
          return response;
        } catch (error) {
          this.log(`Error: ${error.message} at ${endpoint}`);
          throw error;
        }
      }
      async fetchWithRetry(url, options, attempts = this.retryAttempts) {
        for (let i = 0; i < attempts; i++) {
          try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
          } catch (error) {
            if (i < attempts - 1) {
              this.log(`Retry ${i + 1} for ${url}: ${error.message}`);
              await new Promise(resolve => setTimeout(resolve, this.retryDelay));
              continue;
            }
            throw error;
          }
        }
      }
      mockResponse(endpoint) {
        const mocks = {
          '/health': {
            status: 'healthy',
            balance: 38940.0000,
            reputation: 1200983581,
            user_id: 'a1d57580-d88b-4c90-a0f8-6f2c8511b1e4',
            address: 'e8aa2491-f9a4-4541-ab68-fe7a32fb8f1d',
            vial_agent: 'vial1'
          },
          '/oauth/token': { access_token: 'mock_token', token_type: 'bearer' },
          '/credentials': { api_key: 'WEBXOS-MOCKKEY', api_secret: 'MOCKSECRET1234567890' }
        };
        return mocks[endpoint] || { error: `No mock for ${endpoint}` };
      }
      log(message) {
        const terminal = document.getElementById('terminal');
        const messageEl = document.createElement('p');
        messageEl.className = message.includes('Error') ? 'error' : 'command';
        messageEl.textContent = `[${new Date().toISOString()}] ${message}`;
        terminal.appendChild(messageEl);
        terminal.scrollTop = terminal.scrollHeight;
      }
    }

    class Gateway {
      constructor() {
        this.client = new MCPClient();
        this.isAuthenticated = !!this.client.token;
        this.vials = Array(4).fill().map((_, i) => ({
          id: `vial${i+1}`,
          status: 'Stopped',
          balance: 0,
          code: agentTemplates[i],
          wallet: { address: null, balance: 0 }
        }));
        this.wallet = { balance: 0, address: null, user_id: null };
        this.reputation = 0;
        this.apiCredentials = { key: null, secret: null };
        this.elements = {
          balance: document.getElementById('balance'),
          reputation: document.getElementById('reputation'),
          vials: document.getElementById('vials'),
          vialStatuses: Array(4).fill().map((_, i) => document.getElementById(`vial${i+1}-status`)),
          vialBalances: Array(4).fill().map((_, i) => document.getElementById(`vial${i+1}-balance`)),
          apiKey: document.getElementById('api-key'),
          apiSecret: document.getElementById('api-secret'),
          credentials: document.getElementById('credentials'),
          terminal: document.getElementById('terminal'),
          commandInput: document.getElementById('command-input'),
          authBtn: document.getElementById('auth-btn'),
          voidBtn: document.getElementById('void-btn'),
          troubleshootBtn: document.getElementById('troubleshoot-btn'),
          quantumLinkBtn: document.getElementById('quantum-link-btn'),
          exportBtn: document.getElementById('export-btn'),
          importBtn: document.getElementById('import-btn'),
          apiAccessBtn: document.getElementById('api-access-btn'),
          generateCredentials: document.getElementById('generate-credentials'),
          closeCredentials: document.getElementById('close-credentials'),
          fileInput: document.getElementById('file-input')
        };
        this.setupEventListeners();
        this.updateButtonStates();
        this.checkStatus();
        setInterval(() => this.checkStatus(), 30000);
      }
      setupEventListeners() {
        this.elements.authBtn.addEventListener('click', () => this.authenticate());
        this.elements.voidBtn.addEventListener('click', () => this.void());
        this.elements.troubleshootBtn.addEventListener('click', () => this.troubleshoot());
        this.elements.quantumLinkBtn.addEventListener('click', () => this.quantumLink());
        this.elements.exportBtn.addEventListener('click', () => this.exportVials());
        this.elements.importBtn.addEventListener('click', () => this.elements.fileInput.click());
        this.elements.apiAccessBtn.addEventListener('click', () => this.showApiCredentials());
        this.elements.generateCredentials.addEventListener('click', () => this.generateCredentials());
        this.elements.closeCredentials.addEventListener('click', () => this.elements.credentials.classList.remove('active'));
        this.elements.commandInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.sendCommand(e.target.value);
            this.elements.commandInput.value = '';
          }
        });
        this.elements.fileInput.addEventListener('change', () => this.importFile());
      }
      updateButtonStates() {
        const buttons = [this.elements.voidBtn, this.elements.troubleshootBtn, this.elements.quantumLinkBtn, this.elements.exportBtn, this.elements.importBtn, this.elements.apiAccessBtn];
        buttons.forEach(btn => {
          btn.disabled = !this.isAuthenticated;
          btn.classList.toggle('disabled', !this.isAuthenticated);
        });
      }
      async checkStatus() {
        try {
          const data = await this.client.request('/health');
          this.wallet = { balance: data.balance, address: data.address, user_id: data.user_id };
          this.reputation = data.reputation;
          this.vials.forEach((vial, i) => {
            vial.status = 'Running';
            vial.balance = data.balance / 4;
            vial.wallet = { address: data.address, balance: vial.balance };
          });
          this.updateUI();
          this.elements.vials.classList.add('active');
          this.client.log('Status updated');
        } catch (error) {
          this.client.log(`Status check failed: ${error.message}`);
        }
      }
      updateUI() {
        this.elements.balance.textContent = this.wallet.balance.toFixed(4);
        this.elements.reputation.textContent = this.reputation;
        this.vials.forEach((vial, i) => {
          this.elements.vialStatuses[i].textContent = vial.status;
          this.elements.vialBalances[i].textContent = vial.balance.toFixed(4);
        });
      }
      async authenticate() {
        try {
          const data = await this.client.request('/oauth/token', 'POST', {
            grant_type: 'client_credentials',
            client_id: 'WEBXOS-MOCKKEY',
            client_secret: 'MOCKSECRET1234567890'
          });
          this.client.token = data.access_token;
          localStorage.setItem('access_token', data.access_token);
          this.isAuthenticated = true;
          this.updateButtonStates();
          this.client.log('Authentication successful');
          this.checkStatus();
        } catch (error) {
          this.client.log(`Authentication failed: ${error.message}`);
        }
      }
      async void() {
        try {
          await this.client.request('/void', 'POST');
          this.vials.forEach(vial => {
            vial.status = 'Stopped';
            vial.balance = 0;
            vial.wallet = { address: null, balance: 0 };
          });
          this.wallet = { balance: 0, address: null, user_id: null };
          this.reputation = 0;
          this.apiCredentials = { key: null, secret: null };
          this.isAuthenticated = false;
          localStorage.removeItem('access_token');
          this.updateButtonStates();
          this.updateUI();
          this.elements.vials.classList.remove('active');
          this.elements.credentials.classList.remove('active');
          this.client.log('System reset');
        } catch (error) {
          this.client.log(`Void failed: ${error.message}`);
        }
      }
      async troubleshoot() {
        try {
          const data = await this.client.request('/troubleshoot');
          this.client.log(`Troubleshoot: ${data.status}, Vials: ${data.vials_count}`);
        } catch (error) {
          this.client.log(`Troubleshoot failed: ${error.message}`);
        }
      }
      async quantumLink() {
        try {
          await this.client.request('/quantum_link', 'POST');
          this.vials.forEach(vial => {
            vial.status = 'Training';
            vial.balance += 10; // PoW reward
          });
          this.wallet.balance += 40;
          this.reputation += 100;
          this.updateUI();
          this.client.log('Quantum link activated');
          setTimeout(() => {
            this.vials.forEach(vial => vial.status = 'Running');
            this.updateUI();
          }, 1000);
        } catch (error) {
          this.client.log(`Quantum link failed: ${error.message}`);
        }
      }
      async exportVials() {
        const data = `# Neon MCP Export\n\n## Wallet\n- Balance: ${this.wallet.balance.toFixed(4)} $WEBXOS\n- Address: ${this.wallet.address || 'none'}\n- User ID: ${this.wallet.user_id || 'none'}\n\n## Vials\n${this.vials.map(vial => `# Vial ${vial.id}\n- Status: ${vial.status}\n- Balance: ${vial.balance.toFixed(4)} $WEBXOS\n- Wallet Address: ${vial.wallet.address || 'none'}\n\n\`\`\`python\n${vial.code}\n\`\`\`\n`).join('---\n')}`;
        const blob = new Blob([data], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vial_export_${new Date().toISOString().replace(/[:.]/g, '-')}.md`;
        a.click();
        URL.revokeObjectURL(url);
        this.client.log('Vials exported');
      }
      async importFile() {
        const file = this.elements.fileInput.files[0];
        if (!file || !file.name.match(/\.md$/)) {
          this.client.log('Invalid file: Only .md files allowed');
          return;
        }
        try {
          const text = await file.text();
          const lines = text.split('\n');
          let currentVial = null;
          this.vials = [];
          for (let line of lines) {
            if (line.match(/^- Balance: ([\d.]+) \$WEBXOS/)) {
              this.wallet.balance = parseFloat(line.match(/^- Balance: ([\d.]+) \$/)[1]) || 0;
            } else if (line.match(/^- Address: ([\w-]+)/)) {
              this.wallet.address = line.match(/^- Address: ([\w-]+)/)[1];
            } else if (line.match(/^- User ID: ([\w-]+)/)) {
              this.wallet.user_id = line.match(/^- User ID: ([\w-]+)/)[1];
            } else if (line.match(/^# Vial (vial\d)/)) {
              if (currentVial) this.vials.push(currentVial);
              currentVial = {
                id: line.match(/^# Vial (vial\d)/)[1],
                status: 'Stopped',
                balance: 0,
                code: agentTemplates[this.vials.length],
                wallet: { address: null, balance: 0 }
              };
            } else if (line.match(/^- Status: (\w+)/)) {
              currentVial.status = line.match(/^- Status: (\w+)/)[1];
            } else if (line.match(/^- Balance: ([\d.]+) \$WEBXOS/)) {
              currentVial.balance = parseFloat(line.match(/^- Balance: ([\d.]+) \$/)[1]) || 0;
              currentVial.wallet.balance = currentVial.balance;
            } else if (line.match(/^- Wallet Address: ([\w-]+)/)) {
              currentVial.wallet.address = line.match(/^- Wallet Address: ([\w-]+)/)[1];
            }
          }
          if (currentVial) this.vials.push(currentVial);
          this.updateUI();
          this.elements.vials.classList.add('active');
          this.client.log('Vials imported');
        } catch (error) {
          this.client.log(`Import failed: ${error.message}`);
        }
      }
      async showApiCredentials() {
        try {
          const data = await this.client.request('/credentials');
          this.apiCredentials = { key: data.api_key, secret: data.api_secret };
          this.elements.apiKey.value = this.apiCredentials.key;
          this.elements.apiSecret.value = this.apiCredentials.secret;
          this.elements.credentials.classList.add('active');
          this.client.log('API credentials displayed');
        } catch (error) {
          this.client.log(`API credentials failed: ${error.message}`);
        }
      }
      async generateCredentials() {
        try {
          const data = await this.client.request('/credentials');
          this.apiCredentials = { key: data.api_key, secret: data.api_secret };
          this.elements.apiKey.value = this.apiCredentials.key;
          this.elements.apiSecret.value = this.apiCredentials.secret;
          this.client.log('New API credentials generated');
        } catch (error) {
          this.client.log(`Credentials generation failed: ${error.message}`);
        }
      }
      async sendCommand(command) {
        command = command.trim();
        if (command === '/help') {
          this.client.log('Commands: /auth, /void, /troubleshoot, /quantum_link, /export, /import, /api_access');
        } else if (command === '/auth') {
          this.authenticate();
        } else if (command === '/void') {
          this.void();
        } else if (command === '/troubleshoot') {
          this.troubleshoot();
        } else if (command === '/quantum_link') {
          this.quantumLink();
        } else if (command === '/export') {
          this.exportVials();
        } else if (command === '/import') {
          this.elements.fileInput.click();
        } else if (command === '/api_access') {
          this.showApiCredentials();
        } else {
          this.client.log(`Unknown command: ${command}`);
        }
      }
    }

    new Gateway();
  </script>
</body>
</html>
